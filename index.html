<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <title>è±†çŒ« - æ‹¼è±†ä¸çŒ«å’ªç”¨å“ç®¡ç†</title>
<link rel="stylesheet" href="css/style.css">
<link rel="icon" href="assets/icon/icon.png" type="image/png">
    <script>
        // Pre-check default page to avoid flashing
        try {
            var defaultBeads = localStorage.getItem('default_page_beads');
            if (defaultBeads === 'true') {
                document.write('<style id="init-style">#page-home { display: none !important; } #page-beads { display: block !important; }</style>');
            }
        } catch(e) {}
    </script>

</head>
<body>

    <div id="ptr-indicator">
        <span id="ptr-icon">â¬‡ï¸</span>
        <div id="ptr-spinner"></div>
        <span id="ptr-text">ä¸‹æ‹‰åˆ·æ–°...</span>
    </div>


<div id="page-home" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:var(--bg);">
    <h1 style="color:#333; margin-bottom:40px; font-size:24px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">è±†çŒ«-æ‹¼è±†å’ŒçŒ«å’ªç”¨å“ç®¡ç†å·¥å…·</h1>
    <div style="display:flex; flex-direction:column; gap:20px; width:80%; max-width:300px;">
        <button onclick="navTo('beads')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#4a90e2; box-shadow:0 10px 20px rgba(74, 144, 226, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">ğŸ¨</span> æ‹¼è±†åº“å­˜ç®¡ç†
        </button>
        <button onclick="navTo('fabric')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#eb2f96; box-shadow:0 10px 20px rgba(235, 47, 150, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">âœ‚ï¸</span> çƒ˜ç„™å¸ƒè£å‰ª
        </button>
        <button onclick="navTo('cat')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#fa8c16; box-shadow:0 10px 20px rgba(250, 140, 22, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">ğŸ±</span> çŒ«å’ªç”¨å“ç»Ÿè®¡
        </button>
        <div style="margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <input type="checkbox" id="defaultBeadsToggle" onchange="toggleDefaultPage()" style="transform: scale(1.2); cursor: pointer;">
            <label for="defaultBeadsToggle" style="color: #666; font-size: 14px; cursor: pointer;">ä¸‹æ¬¡é»˜è®¤è¿›å…¥æ‹¼è±†åº“å­˜</label>
        </div>

    </div>
    <div onclick="showDevInfo()" style="margin-top: 40px; color: #666; font-size: 12px; cursor: pointer; text-decoration: underline;">å¼€å‘è€…ä¿¡æ¯</div>
</div>

<div id="page-beads" style="display:none; padding-bottom: 80px;">
    <div class="container">
        <h2 class="page-title">åº“å­˜</h2>
        <div class="header-sticky">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px; margin-top: 6px;">
            <input type="text" id="search" placeholder="è¾“å…¥è‰²å·æœç´¢..." oninput="render()" style="flex:1; margin-bottom:0;">
            <button id="btn-toggle-filter" onclick="toggleFilterVisibility()" style="
                border: 1px solid #ddd;
                background: #fff;
                color: #666;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 42px; /* Match input height roughly */
            ">
                ğŸ¨
            </button>

        </div>
        
        <div id="series-filter-container" class="series-filter-container" style="display:none;">
            <div class="series-chip" onclick="toggleSeries('A')">A</div>
            <div class="series-chip" onclick="toggleSeries('B')">B</div>
            <div class="series-chip" onclick="toggleSeries('C')">C</div>
            <div class="series-chip" onclick="toggleSeries('D')">D</div>
            <div class="series-chip" onclick="toggleSeries('E')">E</div>
            <div class="series-chip" onclick="toggleSeries('F')">F</div>
            <div class="series-chip" onclick="toggleSeries('G')">G</div>
            <div class="series-chip" onclick="toggleSeries('H')">H</div>
            <div class="series-chip" onclick="toggleSeries('M')">M</div>
            <div class="series-chip" onclick="toggleSeries('P')">P</div>
            <div class="series-chip" onclick="toggleSeries('Q')">Q</div>
            <div class="series-chip" onclick="toggleSeries('R')">R</div>
            <div class="series-chip" onclick="toggleSeries('T')">T</div>
            <div class="series-chip" onclick="toggleSeries('Y')">Y</div>
            <div class="series-chip" onclick="toggleSeries('ZG')">ZG</div>
        </div>
        

    

    <style>
        .sort-btn {
            flex: 1;
            border: 1px solid #f0f0f0;
            background: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            white-space: nowrap;
        }
        .sort-btn.active {
            background: #e6f7ff;
            color: #1890ff;
            border-color: #91d5ff;
            font-weight: bold;
        }
        .header-sticky {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
        }
        .stats-dropdown {
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
            padding: 0 24px 0 10px;
            border-radius: 8px;
            font-size: 13px;
            height: 32px;
            outline: none;
            appearance: none;
            cursor: pointer;
            font-weight: 500;
            min-width: 90px;
            text-align: center;
            text-align-last: center;
        }
    </style>

    <!-- Summary & Sort Bar -->
    <div id="bead-summary-bar" class="header-sticky" style="padding: 0 5px 10px 5px; display: none;">
        <!-- Sort Controls & Filter -->
        <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 2px; align-items: center;">
             <!-- Filter Dropdown -->
             <div style="position: relative; min-width: 90px; text-align: center;">
                 <select id="seriesFilter" onchange="render()" style="width: 100%; font-size: 13px; font-weight: 700; color: #333; border: 1px solid #eee; border-radius: 6px; background: #fff; outline: none; padding: 6px 20px 6px 12px; appearance: none; text-align: center; cursor: pointer; text-align-last: center; height: 32px;">
                        <option value="221">Mard 221</option>
                        <option value="all">å…¨ç³»åˆ—</option>
                 </select>
                 <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #ccc; pointer-events: none;">â–¼</div>
             </div>

            <button id="btn-sort-id" onclick="setBeadSort('id')" class="sort-btn active" data-sort="id">
                è‰²å· <span class="sort-arrow">â†“</span>
            </button>
            <button id="btn-sort-stock" onclick="setBeadSort('stock')" class="sort-btn" data-sort="stock">
                åº“å­˜ <span class="sort-arrow"></span>
            </button>
            <button id="btn-sort-used" onclick="setBeadSort('used')" class="sort-btn" data-sort="used">
                å·²ç”¨ <span class="sort-arrow"></span>
            </button>
            <button id="btn-low-stock" onclick="toggleLowStockFilter()" class="sort-btn" data-filter="low">
                ä½åº“å­˜
            </button>
        </div>
    </div>
    </div>

    <div id="grid" class="grid-container"></div>
    <div style="text-align:center; padding:10px; color:#999; font-size:10px;">
        å¼€å‘è€…: å°çº¢ä¹¦ç”¨æˆ·ÄÅÄ“ï¼ŒID 11535779483ï¼Œä½¿ç”¨AIå·¥å…·å¼€å‘
    </div>
</div>




</div> <!-- End page-beads -->

    

<div id="footer-dock" class="bottom-dock">
        <div class="dock-item active" onclick="navToDock('inventory')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
            </span>
            <span class="dock-label">åº“å­˜</span>
        </div>
        <div class="dock-item" onclick="navToDock('scan')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM5 19h4v2H5c-1.1 0-2-.9-2-2v-4h2v4z"/><rect x="7" y="9" width="10" height="6" rx="1"/></svg>
            </span>
            <span class="dock-label">æ‰«æ</span>
        </div>
        <div class="dock-item" onclick="navToDock('plan')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/><path d="M12 17h-2v-2h2v2zm0-4h-2V9h2v4zm0-6h-2V3h2v4z"/></svg>
            </span>
            <span class="dock-label">è®¡åˆ’</span>
        </div>
        <div class="dock-item" onclick="navToDock('stats')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M4 19h4v-7H4v7zm6 0h4V5h-4v14zm6 0h4v-10h-4v10z"/></svg>
            </span>
            <span class="dock-label">ç»Ÿè®¡</span>
        </div>
        <div class="dock-item" onclick="navToDock('more')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </span>
            <span class="dock-label">æ›´å¤š</span>
        </div>
    </div>

    
<div id="page-more" style="display:none; padding-bottom: 80px; background: #f7f8fa; min-height: 100vh;">
        <div class="container" style="padding: 20px;">
            <h2 class="page-title" style="margin-bottom: 20px;">æ›´å¤š</h2>
            
            <div style="background: white; border-radius: 16px; padding: 0 20px; margin-bottom: 20px;">
                 <!-- Threshold -->
                <div onclick="openThresholdModal()" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #fff2e8; color: #fa541c; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ğŸ“</div>
                    <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">é˜ˆå€¼ç®¡ç†</div>
                         <div style="font-size: 12px; color: #999;">è®¾ç½®ä½åº“å­˜é¢„è­¦é˜ˆå€¼</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>

                 <!-- Cost Settings -->
                 <div onclick="openCostModal()" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #f6ffed; color: #52c41a; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ğŸ’°</div>
                    <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">æˆæœ¬è®¾ç½®</div>
                         <div style="font-size: 12px; color: #999;">è®¾ç½®è±†å­å•ä»·ï¼Œè‡ªåŠ¨è®¡ç®—æˆæœ¬</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>
                 
                 <!-- Ignored List -->
                 <div onclick="openIgnoredModal(true)" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #fff0f6; color: #eb2f96; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ğŸš«</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">å¿½ç•¥æ¸…å•</div>
                         <div style="font-size: 12px; color: #999;">ç®¡ç†è‰²å·å¿½ç•¥æ¸…å•</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>

                 <!-- Data Import/Export -->
                 <div onclick="openDataModal('backup')" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #f9f0ff; color: #722ed1; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">âš™ï¸</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">æ•°æ®å¯¼å…¥å¯¼å‡º</div>
                         <div style="font-size: 12px; color: #999;">å¤‡ä»½ä¸æ¢å¤æ•°æ®</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>

                 <!-- Storage Monitor & Cleanup -->
                 <div onclick="openStorageModal()" style="display: flex; align-items: center; padding: 20px 0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #fffbe6; color: #faad14; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ğŸ—‚ï¸</div>
                     <div style="flex: 1;">
                          <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">å­˜å‚¨å ç”¨ä¸æ¸…ç†</div>
                          <div style="font-size: 12px; color: #999;">æŸ¥çœ‹å ç”¨å¹¶æ¸…ç†è®¡åˆ’ç¼©ç•¥å›¾</div>
                      </div>
                      <div style="color: #ccc;">â€º</div>
                 </div>

                 <!-- AI Usage -->
                 <div onclick="openAIUsageModal()" style="display: flex; align-items: center; padding: 20px 0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #f0f5ff; color: #2f54eb; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ğŸ¤–</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">AI ä½¿ç”¨ç»Ÿè®¡</div>
                         <div style="font-size: 12px; color: #999;">æŸ¥çœ‹ä¸ç®¡ç† AI æ¨¡å‹é¢åº¦</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>
            </div>
        </div>
    </div>



<div id="page-stats" style="display:none; padding-bottom: 80px;">
    <!-- Sticky Header -->
    <div class="header-sticky" style="background: #f8f9fa; z-index: 101; border-bottom: 1px solid #eee; padding: 0;">
        <div style="max-width: 600px; margin: 0 auto; padding: 15px 15px 10px 15px;">
            <div style="display:flex; align-items:center; justify-content: space-between;">
                <h2 class="page-title" style="margin: 0; text-align: left;">ç»Ÿè®¡</h2>
                <div style="display:flex; align-items:center; gap: 10px;">
                    <button id="btn-toggle-stats-filter" onclick="toggleStatsFilterVisibility()" style="
                        border: 1px solid #ddd;
                        background: #fff;
                        color: #666;
                        padding: 6px 10px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        display: none; 
                        align-items: center;
                        justify-content: center;
                        height: 32px;
                    ">ğŸ¨</button>
                    
                    <div style="position: relative;">
                        <select id="statsSeriesFilter" class="stats-dropdown" onchange="syncAndRenderStats()">
                            <option value="221">Mard 221</option>
                            <option value="all">å…¨ç³»åˆ—</option>
                        </select>
                        <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #ccc; pointer-events: none;">â–¼</div>
                    </div>
                </div>
            </div>
            <!-- Stats Series Filter -->
            <div id="statsSeriesFilterContainer" style="display:none; flex-wrap:wrap; gap:8px; margin-top: 10px; padding-bottom: 5px;">
                <!-- Buttons injected here -->
            </div>
        </div>
    </div>

    <div class="container" style="padding: 15px;">
        <div id="stats-usage-view">
            <div class="stats-summary-card stats-card-horizontal">
                <div class="metric-item" style="flex:1;">
                    <div id="stats-total-stock" class="metric-val" style="font-size:20px;">0g</div>
                    <div class="metric-label">æ€»åº“å­˜</div>
                </div>
                
                <div class="donut-chart-wrapper">
                    <div id="stats-donut" class="donut-chart">
                        <div class="donut-label">
                            <span id="stats-donut-percent" class="donut-percent">0%</span>
                            <span class="donut-text">å·²æ¶ˆè€—</span>
                            <span id="stats-donut-value" style="font-size: 11px; color: #666; font-weight: bold; margin-top: 2px;">0g</span>
                        </div>
                    </div>
                </div>

                <div class="metric-item" style="flex:1;">
                    <div id="stats-plan-rate" class="metric-val" style="color: #52c41a; font-size:20px;">0%</div>
                    <div class="metric-label">è®¡åˆ’å®Œæˆ</div>
                </div>
            </div>

            <div class="stats-summary-card stats-card-horizontal" style="margin-top: 10px;">
                <div class="metric-item" onclick="enableStatsLowStock()" style="cursor: pointer; flex:1;">
                    <div id="stats-low-count" class="metric-val" style="color: #ff4d4f; font-size:20px;">0</div>
                    <div class="metric-label">ç¼ºè´§</div>
                </div>
                <div class="metric-item" style="flex:1;">
                    <div id="stats-zero-count" class="metric-val" style="color: #cf1322; font-size:20px;">0</div>
                    <div class="metric-label">æ–­è´§ (0g)</div>
                </div>
                <div class="metric-item" style="flex:1;">
                    <div id="stats-pending-bags" class="metric-val" style="color: #1890ff; font-size:20px;">0</div>
                    <div class="metric-label">åœ¨é€” (åŒ…)</div>
                </div>
            </div>

            <div class="stats-filter-row">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="switch-label">ä»…æ˜¾ç¤ºä½åº“å­˜</span>
                    <span onclick="copyLowStock()" style="cursor: pointer; color: #4a90e2; font-size: 16px; display: flex; align-items: center; padding: 4px;" title="å¤åˆ¶ç¼ºè´§æ¸…å•">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="stats-low-filter" onchange="renderStats()">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="stats-rank-list" class="stats-rank-list">
                <!-- Rank items will be injected here -->
            </div>
        </div>
        
        <div id="stats-records-view" style="display:none; text-align:center; padding: 40px; color: #999;">
            ğŸš§ æ–½å·¥ä¸­...
        </div>
    </div>
</div>


<div id="page-plan" style="display:none; padding-bottom: 80px;">
    <div class="container" style="padding: 20px;">
        <div style="position: sticky; top: 0; z-index: 99; background: #fff; margin: -20px -20px 15px -20px; padding: 20px 20px 10px 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
            <h2 class="page-title" style="margin-top: 0; margin-bottom: 15px;">
                æ‹¼è±†è®¡åˆ’
                <span onclick="togglePlanOverviewContainer()" style="cursor: pointer; color: #4a90e2; font-size: 18px; margin-left: 8px; vertical-align: middle; display: inline-flex; align-items: center;" title="æ˜¾ç¤ºè®¡åˆ’æ¦‚è§ˆ">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                </span>
            </h2>
            
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                <div style="position: relative; flex: 1;">
                    <input type="text" id="planSearch" placeholder="æœç´¢è®¡åˆ’åç§°ã€æ ‡ç­¾ã€è‰²å·..." oninput="renderPlans()" style="width: 100%; border: 1px solid #ddd; padding: 10px 40px 10px 10px; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s; background: #f9f9f9; box-sizing: border-box;">
                    <div onclick="document.getElementById('planSearch').focus()" style="position: absolute; right: 0; top: 0; bottom: 0; width: 40px; display: flex; align-items: center; justify-content: center; color: #999; cursor: pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                </div>
            </div>

            <div style="display: flex; background: #f0f2f5; padding: 4px; border-radius: 8px;">
                <div id="filter-active" onclick="setPlanFilter('active')" style="flex: 1; text-align: center; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; background: white; color: #4a90e2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;">è®¡åˆ’ä¸­</div>
                <div id="filter-completed" onclick="setPlanFilter('completed')" style="flex: 1; text-align: center; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; color: #999; transition: all 0.2s;">å·²å®Œæˆ</div>
            </div>
        </div>

        <div id="plan-overview-container" class="stats-summary-card" style="display:none; margin: 10px 20px 20px 20px; padding: 20px; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="margin: 0 0 15px 0; font-size: 15px; color: #333; font-weight: 600; display:flex; align-items:center;">
                <span style="margin-right:6px;">ğŸ“…</span> è®¡åˆ’æ¦‚è§ˆ
            </h4>
            
            <div class="stats-metrics" style="border-top: 1px solid #f0f0f0; padding-top: 15px; display: flex; justify-content: space-around;">
                <div id="metric-total" class="metric-item" onclick="togglePlanChartFilter('total')" style="cursor: pointer; padding: 5px; border-radius: 8px; transition: all 0.2s;">
                    <div id="stats-plan-total" class="metric-val" style="font-size: 20px;">0</div>
                    <div class="metric-label" style="color: #666; font-size: 12px;">æ€»è®¡åˆ’</div>
                </div>
                <div id="metric-completed" class="metric-item" onclick="togglePlanChartFilter('completed')" style="cursor: pointer; padding: 5px; border-radius: 8px; transition: all 0.2s;">
                    <div id="stats-plan-completed" class="metric-val" style="color: #52c41a; font-size: 20px;">0</div>
                    <div class="metric-label" style="color: #666; font-size: 12px;">å·²å®Œæˆ</div>
                </div>
                <div id="metric-pending" class="metric-item" onclick="togglePlanChartFilter('pending')" style="cursor: pointer; padding: 5px; border-radius: 8px; transition: all 0.2s;">
                    <div id="stats-plan-pending" class="metric-val" style="color: #faad14; font-size: 20px;">0</div>
                    <div class="metric-label" style="color: #666; font-size: 12px;">è®¡åˆ’ä¸­</div>
                </div>
                <div id="metric-time" class="metric-item" onclick="togglePlanChartFilter('time')" style="cursor: pointer; padding: 5px; border-radius: 8px; transition: all 0.2s;">
                    <div id="stats-plan-time" class="metric-val" style="color: #722ed1; font-size: 20px;">0</div>
                    <div class="metric-label" style="color: #666; font-size: 12px;">è€—æ—¶(h)</div>
                </div>
            </div>

            <div id="stats-plan-chart" style="margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 15px;"></div>
        </div>

        <div id="planList" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Plan Items will be rendered here -->
            <div style="text-align: center; color: #999; padding: 40px;">
                æš‚æ— è®¡åˆ’<br>è¯·å‰å¾€æ‰«æé¡µé¢åˆ›å»º
            </div>
        </div>
    </div>
</div>


<div id="page-plan-detail" style="display:none; padding-bottom: 80px; background: #f7f8fa; min-height: 100vh;">
    <div class="container" style="padding: 0;">
        <!-- 1. é¡¶éƒ¨å¯¼èˆª (Sticky) -->
        <div style="background: white; padding: 12px 16px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;">
            <button onclick="closePlanDetail()" class="btn-back">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <h2 class="page-title-sm" style="flex:1;">è®¡åˆ’è¯¦æƒ…</h2>
        </div>

        <div style="padding: 20px;">
            <!-- 2. æ ¸å¿ƒä¿¡æ¯å¡ç‰‡ (Name, Tags, Status) -->
            <div style="background: white; border-radius: 20px; padding: 24px 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px; text-align: center; border: 1px solid rgba(0,0,0,0.02);">
                <!-- Name -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;">
                    <h1 id="planDetailName" style="margin: 0; font-size: 20px; font-weight: 800; color: #111827; line-height: 1.3;">Plan Name</h1>
                    <div onclick="renameCurrentPlan()" style="color: #9ca3af; cursor: pointer; padding: 4px; border-radius: 50%; display: flex; align-items: center; transition: all 0.2s;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </div>
                </div>
                
                <!-- Tags -->
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px; align-items: center;">
                    <div id="planDetailTags" style="display:contents;">
                        <!-- Tags will be injected here -->
                    </div>
                    <span onclick="openTagManageModal()" style="font-size: 11px; color: #6b7280; cursor: pointer; background: #f3f4f6; padding: 4px 10px; border-radius: 12px; border: 1px dashed #d1d5db; font-weight: 500; transition: all 0.2s;">+ æ ‡ç­¾</span>
                </div>

                <!-- Status Badge Area -->
                <div id="planDetailStatusContainer">
                    <!-- Dynamic Status Content -->
                </div>
            </div>

            <!-- 3. æ•°æ®ç»Ÿè®¡ (Colors, Beads, Cost) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                 <div class="bead-card" style="padding: 15px 10px; align-items: center; gap: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);">
                     <div id="planDetailColorCount" style="font-size: 22px; font-weight: 800; color: #722ed1;">0</div>
                     <div style="font-size: 11px; color: #9ca3af; font-weight: 500;">é¢œè‰²æ•°</div>
                 </div>
                 <div class="bead-card" style="padding: 15px 10px; align-items: center; gap: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);">
                     <div id="planDetailBeadCount" style="font-size: 22px; font-weight: 800; color: #fa8c16;">0</div>
                     <div style="font-size: 11px; color: #9ca3af; font-weight: 500;">æ€»ç²’æ•°</div>
                 </div>
                 <div class="bead-card" style="padding: 15px 10px; align-items: center; gap: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);">
                     <div id="planDetailCost" style="font-size: 22px; font-weight: 800; color: #ff4d4f;">Â¥0</div>
                     <div style="font-size: 11px; color: #9ca3af; font-weight: 500;">é¢„è®¡æˆæœ¬</div>
                 </div>
            </div>

            <!-- 4. ä¸»è¦æ“ä½œåŒº (ä»…è®¡åˆ’ä¸­æ˜¾ç¤º) -->
            <div id="planActiveActions" style="display: flex; gap: 12px; margin-bottom: 25px;">
                 <button class="m-btn m-btn-primary" onclick="checkPlanStock()" style="flex: 1; background: #e6f7ff; color: #0099ff; border: none; box-shadow: none; display: flex; align-items: center; justify-content: center; gap: 6px;">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                     åº“å­˜ç¡®è®¤
                 </button>
                 <button class="m-btn m-btn-primary" onclick="executePlanDeduction()" style="flex: 1; background: #52c41a; border: none; box-shadow: 0 4px 15px rgba(82, 196, 26, 0.25); display: flex; align-items: center; justify-content: center; gap: 6px;">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M8 5v14l11-7z"/></svg>
                     æ‰§è¡Œæ‰£å‡
                 </button>
            </div>

            <!-- 5. å›¾ç‰‡é¢„è§ˆ -->
            <div id="planDetailImageContainer" style="margin-bottom: 25px; display: none;">
                 <div onclick="openPlanImageViewer()" style="position: relative; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); cursor: pointer; height: 200px; background: #fff;">
                     <img id="planDetailImage" src="" style="width: 100%; height: 100%; object-fit: contain; display: block; background: #f9fafb;">
                 </div>
            </div>

            <!-- 6. åˆ—è¡¨åŒºåŸŸ -->
            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center;">
                     <h4 style="margin: 0; font-size: 15px; color: #374151; font-weight: 700;">é¢œè‰²ç”¨é‡</h4>
                     <div onclick="togglePlanDetailSort()" style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: #4b5563; cursor: pointer; background: white; padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.03);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
                        <span id="planDetailSortText">æŒ‰ç”¨é‡</span>
                     </div>
                </div>
                <div id="planDetailList" style="display: flex; flex-direction: column; gap: 10px;">
                     <!-- Items -->
                </div>
            </div>
        </div>
    </div>
</div>


<div id="page-scan" style="display:none; padding-bottom: 80px;">
    <div class="container" style="padding: 20px;">
        <h2 class="page-title" style="margin-bottom: 20px;">å›¾çº¸æ‰«æåˆ†æ</h2>
        
        <div id="scan-uploader" class="scan-uploader" style="border: 2px dashed #4a90e2; border-radius: 12px; padding: 10px; text-align: center; background: #f0f5ff; margin-bottom: 20px; transition: all 0.2s; overflow: hidden;">
            <div id="scanPreview" onclick="document.getElementById('scanInput').click()" style="padding: 20px; cursor: pointer; color: #4a90e2;">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“·</div>
                <div style="font-weight: bold; font-size: 16px;">ç‚¹å‡»ä¸Šä¼ å›¾çº¸è‰²å·åŒºåŸŸ</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">æ”¯æŒæ‰‹æœºæ‹ç…§æˆ–ä»ç›¸å†Œé€‰æ‹©</div>
            </div>
            
            <div id="cropContainer" style="display:none; height: 400px; background: #333; position: relative;">
                <img id="scanPreviewImg" style="max-width: 100%; max-height: 100%; display: block;">
            </div>
            
            <div id="scanProcessPreviews" style="display:none; padding: 10px;">
                <div style="font-size: 12px; color: #999; margin-bottom: 10px;">æ‰«æåˆ†æä¸­...</div>
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                     <div style="flex: 1; text-align: center; max-width: 45%;">
                         <div style="font-size: 10px; color: #ccc; margin-bottom: 5px;">åŸå›¾</div>
                         <img id="scanProcessOriginal" style="max-width: 100%; max-height: 150px; border-radius: 4px; border: 1px solid #eee; display:inline-block;">
                     </div>
                     <div style="color: #ccc; font-size: 20px;">âœ</div>
                     <div style="flex: 1; text-align: center; max-width: 45%;">
                         <div style="font-size: 10px; color: #ccc; margin-bottom: 5px;">è¯†åˆ«åŒºåŸŸ</div>
                         <img id="scanProcessCropped" style="max-width: 100%; max-height: 150px; border-radius: 4px; border: 1px solid #eee; display:inline-block;">
                     </div>
                </div>
            </div>

            <input type="file" id="scanInput" accept="image/*" style="display:none" onchange="handleScanImage(this)">
        </div>

        <div id="cropControls" style="display:none; gap: 10px; margin-bottom: 20px;">
             <button class="m-btn m-btn-ghost" onclick="resetScan()" style="flex: 1;">é‡æ–°ä¸Šä¼ </button>
             <button class="m-btn m-btn-primary" onclick="openCropEditor()" style="flex: 2;">
             <svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor">
            <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
            </svg>
            å¼€å§‹è£åˆ‡
        </button>
        </div>

        <div id="scanLoading" style="display:none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p id="scanStatusText" style="margin-top: 15px; color: #666; font-size: 14px;">æ­£åœ¨è¯†åˆ«è‰²å·æ•°æ®...</p>
            <p style="font-size: 12px; color: #999; margin-bottom: 15px;">(åˆæ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)</p>
            <button class="m-btn m-btn-ghost" onclick="cancelScan()" style="width: auto; padding: 8px 20px; font-size: 13px; border: 1px solid #ddd;">å–æ¶ˆæ‰«æ</button>
        </div>

        <div id="scanResult" style="display:none; padding-top: 10px;">
            <!-- 1. Original Full Image (Collapsed/Small Preview) -->
            <div style="margin-bottom: 15px;">
                 <div style="font-size: 13px; color: #999; margin-bottom: 5px;">åŸå§‹å›¾çº¸</div>
                 <div style="background: #f0f0f0; border-radius: 8px; overflow: hidden; max-height: 100px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc;">
                      <img id="scanResultFullImage" style="max-width: 100%; max-height: 100px; display: block; opacity: 0.8;" onclick="this.style.maxHeight = this.style.maxHeight === '100px' ? 'none' : '100px'; this.parentElement.style.maxHeight = this.parentElement.style.maxHeight === '100px' ? 'none' : '100px';">
                 </div>
                 <div style="text-align: center; font-size: 10px; color: #ccc; margin-top: 2px;">(ç‚¹å‡»å±•å¼€/æ”¶èµ·)</div>
            </div>

            <!-- 2. Cropped Image Preview -->
            <div style="margin-bottom: 5px; font-size: 13px; color: #999;">è¯†åˆ«åŒºåŸŸ</div>
            <div style="background: #333; border-radius: 12px; overflow: hidden; margin-bottom: 15px; text-align: center; max-height: 200px; display: flex; align-items: center; justify-content: center;">
                 <img id="scanResultImage" style="max-width: 100%; max-height: 200px; display: block;">
            </div>

            <!-- 3. Action Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <button class="m-btn m-btn-ghost" onclick="reCropImage()" style="flex: 1; border: 1px solid #eee; color: #666; font-size: 13px; border-radius: 20px;">
                 <svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor">
                <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
                </svg>
                è°ƒæ•´è£åˆ‡
                </button>
                <button class="m-btn m-btn-ghost" onclick="resetScan()" style="flex: 1; border: 1px solid #eee; color: #666; font-size: 13px; border-radius: 20px;">
                    ğŸ”„ é‡æ–°é€‰æ‹©
                </button>
            </div>

            <!-- 4. Result Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 2px; white-space: nowrap;">
                <div style="display:flex; align-items:center; gap:5px; flex-shrink: 1; overflow: hidden;">
                    <h4 style="margin: 0; font-size: 12px; font-weight: bold; color: #333;">è¯†åˆ«ç»“æœ</h4>
                    <span id="scanTotalCount" style="font-size: 12px; color: #999;">...</span>
                </div>
                <div style="display: flex; gap: 4px; flex-shrink: 0;">
                     <button onclick="toggleScanMissingPriority()" id="btn-scan-missing" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">ç¼ºè´§</button>
                     <button onclick="toggleScanSort('code')" id="btn-sort-code" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">è‰²å·</button>
                     <button onclick="toggleScanSort('qty')" id="btn-sort-qty" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">ç”¨é‡</button>
                </div>
            </div>
            
            <!-- 5. Status / Loading Bar -->
            <div id="scanInlineStatus" style="display:none; background: #e6f7ff; border: 1px solid #91d5ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #0050b3; display: flex; align-items: center; gap: 8px;">
                 <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                 <span id="scanInlineStatusText">æ­£åœ¨è¯†åˆ«ä¸­...</span>
            </div>

            <!-- 6. List Container -->
            <div id="scanList" style="display: flex; flex-direction: column; gap: 12px; min-height: 100px;"></div>
            
            <!-- 7. Plan Actions -->
            <div id="planActions" style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #eee;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">å›¾çº¸å‘½å (å¯é€‰)</label>
                    <input type="text" id="planNameInput" placeholder="è¾“å…¥å›¾çº¸åç§°ï¼Œå¦‚: åº“æ´›ç±³" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="m-btn m-btn-primary" onclick="createPlan()" style="flex: 1; background: #722ed1; border-color: #722ed1;">
                        ğŸ“… åˆ›å»ºè®¡åˆ’
                    </button>
                    <button class="m-btn m-btn-primary" onclick="deductInventory()" style="flex: 1; background: #ff4d4f; border-color: #ff4d4f;">
                        ğŸ“‰ æ‰£å‡åº“å­˜
                    </button>
                </div>
            </div>

            <!-- 8. Bottom Tip -->
             <div style="margin-top: 30px; padding: 15px; text-align: center; color: #ccc; font-size: 12px; border-top: 1px solid #f0f0f0;">
                è¯†åˆ«ç»“æœä»…ä¾›å‚è€ƒ Â· è¯·æ ¸å¯¹å®ç‰©
            </div>
        </div>
    </div>
</div>
<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>


    <!-- å¼¹çª—éƒ¨åˆ† -->

<div class="overlay" id="mask" onclick="closeAllModals()"></div>
<div class="overlay" id="mask2" onclick="closeAllModals()" style="z-index: 1090; display: none;"></div>

<div id="consumeModal" class="modal" style="width: 85%; max-width: 340px; padding: 20px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">æ¶ˆè€—å½•å…¥ (ç²’æ•°)</h3>
    <div id="modalList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #f0f0f0; border-radius: 12px; padding: 5px;"></div>
    <div class="modal-btn-group" style="gap: 10px;">
        <button class="m-btn m-btn-primary" onclick="submitConsume()" style="padding: 10px; font-size: 14px; border-radius: 10px;">ç¡®è®¤æ‰£é™¤</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 10px; font-size: 14px; border-radius: 10px;">å–æ¶ˆ</button>
    </div>
</div>

<div id="thresholdModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 style="font-size: 18px; color: #333; margin-bottom: 10px; text-align: center;">è®¾ç½®é¢„è­¦é˜ˆå€¼</h3>
    <div style="font-size: 13px; color: #999; margin-bottom: 25px; text-align: center;">å½“åº“å­˜é‡é‡ä½äºæ­¤å€¼æ—¶ï¼Œ<br>è‰²å·å°†æ ‡è®°ä¸ºçº¢è‰²é¢„è­¦çŠ¶æ€ã€‚</div>
    
    <div class="big-input-group" style="margin-bottom: 25px;">
        <input type="number" id="thresholdInput" placeholder="0.00" step="0.01" 
               style="font-size: 32px; padding: 15px; border-radius: 12px; background: #f7f8fa; border: 2px solid transparent; width: 100%; box-sizing: border-box; text-align: center; color: #333; font-weight: bold; transition: all 0.2s;">
    </div>
    
    <div class="modal-btn-group" style="gap: 12px; display: flex; flex-direction: row;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1; white-space: nowrap;">å–æ¶ˆ</button>
        <button class="m-btn m-btn-primary" onclick="saveThreshold()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2); white-space: nowrap;">ä¿å­˜è®¾ç½®</button>
    </div>
</div>

<div id="editWeightModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 id="editWeightModalTitle" style="font-size: 18px; color: #333; margin-bottom: 25px;">ä¿®æ”¹åº“å­˜é‡é‡</h3>
    
    <div class="big-input-group" style="margin-bottom: 25px;">
        <input type="number" id="editWeightInput" placeholder="0.00" step="0.01" 
               style="font-size: 32px; padding: 15px; border-radius: 12px; background: #f7f8fa; border: 2px solid transparent; width: 100%; box-sizing: border-box; text-align: center; color: #333; font-weight: bold; transition: all 0.2s;">
        <span class="input-suffix" style="right: 30px; font-size: 16px; color: #999;">g</span>
    </div>
    
    <div class="modal-btn-group" style="gap: 12px;">
        <button class="m-btn m-btn-primary" onclick="submitEditWeight()" style="padding: 12px; font-size: 16px; border-radius: 12px; background: linear-gradient(135deg, #4a90e2, #357abd); box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);">ç¡®è®¤ä¿®æ”¹</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 12px; font-size: 15px; border-radius: 12px; color: #666;">å–æ¶ˆ</button>
    </div>
</div>

<div id="restockModal" class="modal">
    <h3>æ–°å¢è¡¥è´§</h3>
    <div class="modal-desc" id="restockTitle"></div>
    <div class="big-input-group">
        <input type="number" id="restockInput" placeholder="0" step="0.01">
        <span class="input-suffix">g</span>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitRestock()">ç¡®è®¤è¡¥è´§</button>
        <button class="m-btn m-btn-ghost" onclick="showModal('editWeightModal')">è¿”å›</button>
    </div>
</div>

<!-- Plan Detail Edit Quantity Modal -->
<div id="planDetailQtyModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 style="font-size: 18px; color: #333; margin-bottom: 25px; text-align: center;">ä¿®æ”¹è®¡åˆ’ç”¨é‡</h3>
    <div style="text-align: center; margin-bottom: 15px; font-weight: bold; color: #4a90e2; font-size: 16px;" id="planDetailQtyCode"></div>
    <div class="input-group" style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:25px;">
        <button onclick="adjustPlanItemQty(-10)" style="width:40px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; color:#666;">-10</button>
        <button onclick="adjustPlanItemQty(-1)" style="width:40px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; color:#666;">-1</button>
        <input type="number" id="planDetailQtyInput" style="width: 80px; height: 40px; text-align: center; border: 2px solid #ddd; border-radius: 12px; font-size: 18px; font-weight: bold; color: #333; outline: none; -moz-appearance: textfield;">
        <button onclick="adjustPlanItemQty(1)" style="width:40px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; color:#666;">+1</button>
        <button onclick="adjustPlanItemQty(10)" style="width:40px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; color:#666;">+10</button>
    </div>
    <div class="modal-btn-group" style="gap: 12px; display: flex;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="flex:1; border-radius:12px;">å–æ¶ˆ</button>
        <button class="m-btn m-btn-primary" onclick="submitPlanItemQty()" style="flex:1; border-radius:12px;">ç¡®è®¤ä¿®æ”¹</button>
    </div>
</div>

<!-- Plan Detail Select Color Modal -->
<div id="planDetailColorModal" class="modal" style="width: 90%; max-width: 400px; height: 80vh; max-height: 600px; display: none; flex-direction: column; padding: 0; overflow: hidden;">
    <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
        <h3 style="font-size: 16px; margin: 0; font-weight: bold;">æ›´æ¢è‰²å·</h3>
        <button onclick="closeAllModals()" style="background: none; border: none; font-size: 24px; color: #999; padding: 0 10px; cursor: pointer;">Ã—</button>
    </div>
    <div style="padding: 10px; border-bottom: 1px solid #f5f5f5; background: #fff;">
        <input type="text" id="planDetailColorSearch" placeholder="æœç´¢è‰²å·..." style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #f9f9f9;" oninput="filterPlanDetailColorList()">
    </div>
    <div id="planDetailColorList" style="flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; -webkit-overflow-scrolling: touch;">
        <!-- List Items -->
    </div>
</div>



<div id="historyModal" class="modal" style="width:95%; max-width:600px;">
    <h3 id="historyTitle" style="font-size:16px; font-weight:bold; margin-bottom:12px;">åº“å­˜æ˜ç»†</h3>
    
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; background:#f5f7fa; padding:10px; border-radius:10px;">
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">å½“å‰ä½™é‡</div>
            <div id="hist-stock" style="font-size:16px; font-weight:bold; color:#4a90e2;">0g</div>
        </div>
        <div style="text-align:center; border-left:1px solid #e0e0e0; border-right:1px solid #e0e0e0; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">æ€»æ¶ˆè€—</div>
            <div id="hist-used" style="font-size:16px; font-weight:bold; color:#ff4d4f;">0g</div>
        </div>
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">æ€»è¡¥å……</div>
            <div id="hist-added" style="font-size:16px; font-weight:bold; color:#52c41a;">0g</div>
        </div>
    </div>

    <div style="max-height:240px; overflow:auto; border:1px solid #eee; border-radius:10px;">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead style="background:#fafafa; position:sticky; top:0;">
                <tr>
                    <th style="padding:6px 2px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">æ—¶é—´</th>
                    <th style="padding:6px 2px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">å›¾çº¸åç§°</th>
                    <th style="padding:6px 2px; text-align:center; color:#999; font-weight:normal; border-bottom:1px solid #eee;">æ“ä½œ</th>
                    <th style="padding:6px 2px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">é‡é‡/ç²’æ•°</th>
                </tr>
            </thead>
            <tbody id="historyList"></tbody>
        </table>
    </div>
    <div style="text-align:center; color:#ccc; font-size:10px; margin-top:5px;">
        æ³¨ï¼šæ€»è®¡æ•°æ®åŒ…å«å·²å½’æ¡£çš„å†å²è®°å½•ï¼Œå¯èƒ½å¤§äºä¸Šæ–¹åˆ—è¡¨æ˜¾ç¤ºçš„æœ€è¿‘20æ¡è®°å½•ä¹‹å’Œã€‚
    </div>

    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding:8px; font-size:13px;">å…³é—­</button>
    </div>
</div>

<div id="stockCheckSheet" class="modal" style="width: 100%; max-width: 100%; bottom: 0; top: auto; border-radius: 20px 20px 0 0; padding: 0; margin: 0; left: 0; transform: none; max-height: 80vh; display: none; flex-direction: column; animation: slideUpModal 0.3s ease-out; z-index: 99999;">
    <div style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">åº“å­˜ç¡®è®¤</h3>
            <button onclick="closeAllModals()" style="background: none; border: none; font-size: 24px; color: #999;">&times;</button>
        </div>
        <div id="stockCheckSummary" style="background: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; padding: 10px; border-radius: 8px; font-size: 13px;">
            ğŸ‰ åº“å­˜å……è¶³ï¼Œå¯ä»¥å¼€å§‹åˆ¶ä½œï¼
        </div>
        
        <!-- Sort Actions -->
        <div style="display: flex; gap: 8px; margin-top: 10px;">
             <button onclick="toggleStockCheckMissingPriority()" id="btn-check-missing" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">ç¼ºè´§</button>
             <button onclick="toggleStockCheckSort('code')" id="btn-check-code" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">è‰²å·</button>
             <button onclick="toggleStockCheckSort('qty')" id="btn-check-qty" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">ç”¨é‡</button>
        </div>
    </div>
    
    <div id="stockCheckList" style="overflow-y: auto; padding: 10px 20px; flex: 1;">
        <!-- Check Items -->
    </div>

    <div style="padding: 15px 20px; border-top: 1px solid #f0f0f0;">
        <button class="m-btn m-btn-primary" onclick="closeAllModals()" style="width: 100%; padding: 12px; font-size: 16px;">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<div id="dataModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">æ•°æ®å¤‡ä»½</h3>
    <div class="data-tabs" style="display:flex; border-bottom:1px solid #eee; margin-bottom:15px;">
        <div id="tabBackup" class="data-tab active" onclick="switchDataTab('backup')" style="flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:bold; color:#4a90e2; border-bottom:2px solid #4a90e2;">å¤‡ä»½å¯¼å‡º</div>
        <div id="tabRestore" class="data-tab" onclick="switchDataTab('restore')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; border-bottom:2px solid transparent;">æ¢å¤å¯¼å…¥</div>
    </div>
    
    <div id="viewBackup">
        <div style="padding: 20px 0; text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 13px; line-height: 1.6;">
                <p>å°†å½“å‰æ‰€æœ‰åº“å­˜åŠè®°å½•å¯¼å‡ºä¸ºæ–‡ä»¶ã€‚</p>
                <p style="margin-top:8px; font-weight:bold; color:#333;">ğŸ“‚ å¯¼å‡ºä½ç½®è¯´æ˜</p>
                <p style="font-size:12px; color:#888;">
                    ç”µè„‘ç«¯ï¼šä¸‹è½½åˆ°æµè§ˆå™¨çš„é»˜è®¤ä¸‹è½½ç›®å½•<br>
                    æ‰‹æœºç«¯ï¼šä¿å­˜åˆ°Android/data/plus.H5F9023D <span style="color:#4a90e2; font-weight:bold;">Download</span> æ–‡ä»¶å¤¹
                </p>
            </div>
        </div>
    </div>

    <div id="viewRestore" style="display:none;">
        <div style="padding: 20px 0; text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 13px; line-height: 1.6;">
                <p>é€‰æ‹©å¤‡ä»½æ–‡ä»¶ä»¥æ¢å¤æ•°æ®ã€‚</p>
                <p style="font-size:12px; color:#888; margin-top:5px;">
                    æ”¯æŒä» æ‰‹æœºæ–‡ä»¶ç®¡ç† / WPS ç­‰é€”å¾„é€‰æ‹©<br>
                    (è¯·é€‰æ‹© .txt æ ¼å¼çš„å¤‡ä»½æ–‡ä»¶)
                </p>
            </div>
            <input type="file" id="restoreFile" style="display:none" accept=".txt,text/plain" onchange="loadBackupFile(this)">
            <textarea id="restoreInput" style="display:none;"></textarea>
            <input type="number" id="threshold" style="display:none;" value="0">
        </div>
    </div>
    
    <div class="modal-btn-group" style="margin-top:10px; display:flex; flex-direction:row; flex-wrap:nowrap; gap:10px;">
        <button class="m-btn m-btn-ghost" style="flex:1; width:auto; padding: 12px; font-size: 15px; white-space:nowrap;" onclick="closeAllModals()">å…³é—­</button>
        <button id="btnBackupAction" class="m-btn m-btn-primary" style="flex:1; width:auto; padding: 12px; font-size: 15px; background: #52c41a; border-color: #52c41a; display: flex; align-items: center; justify-content: center; gap: 8px; white-space:nowrap;" onclick="downloadBackupFile()">
            <span>ğŸ“¤</span> å¯¼å‡ºå¤‡ä»½ (TXT)
        </button>
        <button id="btnRestoreAction" class="m-btn m-btn-primary" style="display:none; flex:1; width:auto; padding: 12px; font-size: 15px; background: #1890ff; border-color: #1890ff; align-items: center; justify-content: center; gap: 8px; white-space:nowrap;" onclick="document.getElementById('restoreFile').click()">
            <span>ğŸ“‚</span> é€‰æ‹©å¤‡ä»½æ–‡ä»¶ (TXT)
        </button>
    </div>
</div>

<div id="batchInputModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">åˆå§‹æ•°æ®æ‰¹é‡å½•å…¥</h3>
    <div class="modal-desc" style="margin-bottom:8px; text-align:left;">æ ¼å¼ï¼šè‰²å·+é‡é‡ (å¦‚ A1 50)</div>
    <textarea id="batchInputText" style="width:100%; height:150px; padding:10px; border:1px solid #eee; border-radius:10px; resize:none; font-family:monospace; font-size:13px; box-sizing:border-box; background:#fafafa; outline:none; color:#333;" placeholder="æ”¯æŒå¤šç§æ ¼å¼ï¼Œä¾‹å¦‚ï¼š&#10;A1 50&#10;B2: 20.5&#10;C3=100"></textarea>
    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="submitBatchInput()">å¼€å§‹è¯†åˆ«å¹¶å¯¼å…¥</button>
        <button class="m-btn m-btn-ghost" style="padding:8px; font-size:13px;" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<div id="lowStockModal" class="modal" style="width:85%; max-width:340px; padding:20px; border-radius:24px;">
    <h3 style="font-size:18px; font-weight:bold; margin-bottom:20px; text-align:center; color:#333;">è¡¥è´§æ¸…å•</h3>
    <div id="lowStockHeader" style="margin-bottom:15px; background:#fffbe6; padding:10px; border-radius:8px; border:1px solid #ffe58f; display:flex; align-items:center; gap:8px;">
        <span style="font-size:16px;">âš ï¸</span>
        <div class="modal-desc" style="font-size:12px; color:#d48806; margin:0; text-align:left;">
            <div>ä»¥ä¸‹è‰²å·åº“å­˜ä½äºè®¾å®šé˜ˆå€¼ï¼Œå»ºè®®åŠæ—¶è¡¥è´§ã€‚</div>
            <div style="margin-top:4px; opacity:0.8; font-size:11px; color:inherit;">(å·²æ ¹æ®é¦–é¡µâ€œè‰²å·â€ä¸‹æ‹‰æ¡†ç­›é€‰æ˜¾ç¤ºèŒƒå›´)</div>
        </div>
    </div>
    
    <div id="lowStockList" style="max-height:260px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:12px; margin-bottom:20px; padding:5px;"></div>
    
    <!-- éšè—çš„æ–‡æœ¬åŸŸç”¨äºå¤åˆ¶åŠŸèƒ½ -->
    <textarea id="lowStockText" style="position:absolute; left:-9999px;"></textarea>

    <div class="modal-btn-group" style="gap:10px;">
        <button class="m-btn m-btn-primary" style="padding:12px; font-size:15px; border-radius:12px;" onclick="copyLowStockText()">ä¸€é”®å¤åˆ¶æ¸…å•</button>
        <button class="m-btn m-btn-ghost" style="padding:12px; font-size:15px; border-radius:12px;" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<!-- Crop Edit Modal (Figure 1) -->
<div id="cropEditModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; max-width: none; max-height: none; margin: 0; padding: 0; border-radius: 0; background: black; display: none; flex-direction: column; z-index: 2000; transform: none; box-shadow: none;">
    <!-- Top Bar -->
    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:rgba(0,0,0,0.5); color:white; position:absolute; top:0; left:0; right:0; z-index:10;">
        <button onclick="closeCropEditor()" style="background:none; border:none; color:white; font-size:16px;">å–æ¶ˆ</button>
        <span style="font-size:18px; font-weight:bold;">è£åˆ‡å›¾ç‰‡</span>
        <button onclick="showCropPreview()" style="background:#4a90e2; border:none; color:white; font-size:14px; padding:6px 12px; border-radius:4px;">é¢„è§ˆ</button>
    </div>
    
    <!-- Main Crop Area -->
    <div style="flex:1; position:relative; overflow:hidden; background:black; display:flex; align-items:center; justify-content:center;">
        <img id="cropEditImage" style="max-width:100%; max-height:100%; display:block;">
    </div>
</div>

<!-- Crop Preview Modal (Figure 2) -->
<div id="cropPreviewModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; max-width: none; max-height: none; margin: 0; padding: 0; border-radius: 0; background: black; display: none; flex-direction: column; justify-content: space-between; z-index: 2100; transform: none; box-shadow: none;">
    <!-- Main Preview Area -->
    <div style="flex:1; width: 100%; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;">
        <img id="cropPreviewImage" style="max-width:100%; max-height:100%; object-fit: contain; transform-origin: center center;">
        
        <!-- Zoom Controls Overlay (Inside Preview Area to float over image) -->
        <div style="position:absolute; bottom:20px; left:0; width:100%; display:flex; justify-content:center; gap:20px; pointer-events:none; z-index: 10;">
             <button onclick="zoomPreview(0.2)" style="pointer-events:auto; background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.5); border-radius:50%; width:40px; height:40px; font-size:20px; display:flex; align-items:center; justify-content:center;">+</button>
             <button onclick="zoomPreview(-0.2)" style="pointer-events:auto; background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.5); border-radius:50%; width:40px; height:40px; font-size:20px; display:flex; align-items:center; justify-content:center;">-</button>
        </div>
    </div>

    <!-- Bottom Action Bar -->
    <div style="padding:20px; background:rgba(0,0,0,0.8); display:flex; gap:15px; flex-shrink:0; z-index: 20;">
        <button class="m-btn m-btn-ghost" onclick="closeCropPreview()" style="flex:1; color:white; border-color:rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap;">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
            </svg>
            é‡æ–°è£åˆ‡
        </button>
        <button class="m-btn m-btn-primary" onclick="confirmScanFromPreview()" style="flex:1; background:#6c5ce7; border-color:#6c5ce7; white-space: nowrap;">ç¡®è®¤å¹¶è¯†åˆ«</button>
    </div>
</div>

<!-- Scan Add Item Modal -->
<div id="scanAddModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">æ·»åŠ è‰²å·</h3>
    <div style="margin-bottom: 20px;">
        <label style="display:block; font-size:14px; color:#666; margin-bottom:6px;">è‰²å·</label>
        <input type="text" id="scanAddCodeInput" placeholder="ä¾‹å¦‚A1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; text-transform: uppercase;">
    </div>
    <div style="margin-bottom: 25px;">
        <label style="display:block; font-size:14px; color:#666; margin-bottom:6px;">æ•°é‡ (ç²’)</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="m-btn m-btn-ghost" style="width: 40px; padding: 8px 0;" onclick="adjustAddScanQty(-10)">-10</button>
            <input type="number" id="scanAddQtyInput" value="0" style="flex: 1; text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; font-weight: bold;">
            <button class="m-btn m-btn-ghost" style="width: 40px; padding: 8px 0;" onclick="adjustAddScanQty(10)">+10</button>
        </div>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitAddScanItem()">æ·»åŠ </button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<!-- Scan Delete Confirm Modal -->
<div id="scanDeleteConfirmModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; color: #ff4d4f;">åˆ é™¤è‰²å·</h3>
    <div style="text-align: center; margin-bottom: 25px; color: #666; font-size: 15px;">
        ç¡®å®šè¦ä»æ‰«æç»“æœä¸­åˆ é™¤ <span id="scanDeleteCode" style="font-weight: bold; color: #333;"></span> å—ï¼Ÿ
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" style="background: #ff4d4f; border-color: #ff4d4f;" onclick="confirmDeleteScanItem()">åˆ é™¤</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<!-- Scan Qty Modify Modal -->
<div id="scanQtyModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">ä¿®æ”¹æ•°é‡</h3>
    <div style="margin-bottom: 25px;">
        <div style="font-size: 14px; color: #666; margin-bottom: 12px; text-align: center;">è‰²å·: <span id="scanQtyCode" style="font-weight: bold; color: #333; font-size: 16px;"></span></div>
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(-10)">-10</button>
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(-1)">-1</button>
            <input type="number" id="scanQtyInput" style="width: 70px; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; font-weight: bold;">
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(1)">+1</button>
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(10)">+10</button>
        </div>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitScanQty()">ç¡®å®š</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirmModal" class="modal" style="width: 85%; max-width: 320px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(0,0,0,0.1);">
    <h3 id="customConfirmTitle" style="font-size: 18px; font-weight: bold; margin-bottom: 12px; text-align: center; color: #333;">æç¤º</h3>
    <div id="customConfirmMessage" style="font-size: 15px; color: #666; margin-bottom: 24px; text-align: center; line-height: 1.5;"></div>
    <div class="modal-btn-group" style="gap: 12px;">
        <button id="customConfirmCancelBtn" class="m-btn m-btn-ghost" onclick="closeAllModals()" style="flex: 1; border-radius: 8px;">å–æ¶ˆ</button>
        <button id="customConfirmOkBtn" class="m-btn m-btn-primary" style="flex: 1; border-radius: 8px; background: #ff4d4f; border-color: #ff4d4f;">ç¡®å®š</button>
    </div>
</div>

<!-- Scan Color Select Modal -->
<div id="scanColorModal" class="modal" style="width: 90%; max-width: 400px; height: 80vh; max-height: 600px; display: none; flex-direction: column; padding: 0; overflow: hidden;">
    <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
        <h3 style="font-size: 16px; margin: 0; font-weight: bold;">æ›´æ¢è‰²å·</h3>
        <button onclick="closeAllModals()" style="background: none; border: none; font-size: 24px; color: #999; padding: 0 10px; cursor: pointer;">Ã—</button>
    </div>
    <div style="padding: 10px; border-bottom: 1px solid #f5f5f5; background: #fff;">
        <input type="text" id="scanColorSearch" placeholder="æœç´¢è‰²å·..." style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #f9f9f9;" oninput="filterScanColorList()">
    </div>
    <div id="scanColorList" style="flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9;">
        <!-- List Items Generated via JS -->
    </div>
</div>

<div id="welcomeModal" class="modal">
    <h3>ğŸ“¢ æ¬¢è¿ä½¿ç”¨ MARD è±†åº“</h3>
    <div style="text-align:left; color:#555; line-height:1.6; font-size:14px; padding:0 10px;">
        <p style="margin-bottom:12px;"><b>1. æ•°æ®å®‰å…¨æé†’ï¼š</b><br>
        æœ¬å·¥å…·æ•°æ®<span style="color:#ff4d4f; font-weight:bold;">ä»…å­˜å‚¨åœ¨å½“å‰æµè§ˆå™¨çš„æœ¬åœ°ç¼“å­˜ä¸­</span>ã€‚æ¸…ç†æµè§ˆå™¨ç¼“å­˜å°†å¯¼è‡´æ•°æ®æ°¸ä¹…ä¸¢å¤±ï¼<br>
        è¯·åŠ¡å¿…å®šæœŸå¤‡ä»½æ•°æ®ï¼ˆæ“ä½œå…¥å£ï¼šé¡µé¢ä¸Šæ–¹â€œæ•°æ®å¤‡ä»½â€ï¼‰ï¼Œä½œè€…ä¸æ‰¿æ‹…æ•°æ®ä¸¢å¤±çš„ä»»ä½•åæœã€‚</p>
        
        <p style="margin-bottom:12px;"><b>2. è®¾å¤‡åŒæ­¥ï¼š</b><br>
        æœ¬å·¥å…·ä¸ºç¦»çº¿ç½‘é¡µåº”ç”¨ï¼Œ<span style="color:#ff4d4f; font-weight:bold;">ä¸æ”¯æŒå¤šè®¾å¤‡å®æ—¶åŒæ­¥</span>ã€‚å¦‚éœ€åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨ï¼Œè¯·ä½¿ç”¨å¤‡ä»½/æ¢å¤åŠŸèƒ½æ‰‹åŠ¨è¿ç§»æ•°æ®ã€‚</p>
        
        <p style="margin-bottom:12px;"><b>3. åŠŸèƒ½è¯´æ˜ï¼š</b><br>
        è¯¦ç»†æ“ä½œæŒ‡å—è¯·ç‚¹å‡»é¡µé¢ä¸Šæ–¹çš„â€œğŸ“– ä½¿ç”¨è¯´æ˜â€æŸ¥çœ‹ã€‚</p>
    </div>
    <div class="modal-btn-group" style="margin-top:20px;">
        <button class="m-btn m-btn-primary" onclick="closeWelcomeModal()">æˆ‘å·²çŸ¥æ™“</button>
    </div>
</div>

<div id="ignoredModal" class="modal" style="width:90%; max-width:360px; height:80vh; flex-direction:column; overflow:hidden;">
    <h3 style="margin-bottom:5px;">è‰²å·é˜ˆå€¼æé†’ç®¡ç†</h3>
    <div class="modal-desc" style="margin-bottom:10px;">è®¾ç½®æ˜¯å¦å¼€å¯ä½åº“å­˜é¢„è­¦</div>
    
    <!-- Tabs -->
    <div class="ai-tabs" style="display:flex; border-bottom:1px solid #eee; margin-bottom:10px; flex-shrink:0;">
        <div id="tab-ignored-disabled" class="ai-tab active" onclick="switchIgnoredTab('disabled')" style="flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:bold; color:#e24a4a; border-bottom:2px solid #e24a4a;">å…³é—­æ¸…å•</div>
        <div id="tab-ignored-enabled" class="ai-tab" onclick="switchIgnoredTab('enabled')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; border-bottom:2px solid transparent;">å¼€å¯æ¸…å•</div>
    </div>

    <!-- Filter Control -->
    <div style="flex-shrink:0; margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0 5px;">
            <span id="ignoredListCount" style="font-size:12px; color:#999;"></span>
            <button id="btn-toggle-ignored-filter" onclick="toggleIgnoredFilterVisibility()" style="border:1px solid #ddd; background:#fff; color:#666; padding:4px 8px; border-radius:6px; font-size:12px; cursor:pointer; display:none; align-items:center; gap:4px;">
                ğŸ¨ è‰²ç³»ç­›é€‰
            </button>
        </div>
        <div id="ignoredSeriesFilter" style="display:none; flex-wrap:wrap; gap:6px; max-height:100px; overflow-y:auto; padding:8px; background:#f9f9f9; border-radius:8px; margin-top:8px;"></div>
    </div>
    
    <!-- List -->
    <div id="ignoredList" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:10px; padding:5px; background:#fff;"></div>
    
    <!-- Footer / Batch Actions -->
    <div style="flex-shrink:0; margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <div style="display:flex; align-items:center; gap:5px;">
                 <input type="checkbox" id="ignoredSelectAll" onchange="toggleAllIgnoredBatchSelection()" style="width:18px; height:18px;">
                 <label for="ignoredSelectAll" style="font-size:14px; color:#666;">å…¨é€‰</label>
             </div>
             <div style="display:flex; gap:10px;">
                 <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding:6px 12px; white-space:nowrap;">å–æ¶ˆ</button>
                 <button id="btn-ignored-batch-action" class="m-btn m-btn-primary" onclick="executeIgnoredBatchAction()" style="padding:6px 12px; white-space:nowrap;" disabled>æ‰¹é‡å¼€å¯</button>
             </div>
        </div>
    </div>
</div>

<div id="devInfoModal" class="modal" style="width:70%; max-width:260px; padding:15px;">
    <h3 style="font-size:16px;">å¼€å‘è€…ä¿¡æ¯</h3>
    <div style="text-align:center; padding:10px; color:#555; font-size:13px; line-height:1.6;">
        <p><b>å¼€å‘è€…:</b> å°çº¢ä¹¦ç”¨æˆ·ÄÅÄ“</p>
        <p><b>ID:</b> 11535779483</p>
        <p>ä½¿ç”¨ AI å·¥å…·å¼€å‘</p>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<div id="aiUsageModal" class="modal" style="width:90%; max-width:400px; max-height: 85vh; overflow-y: auto;">
    <div class="modal-header" style="text-align:center; margin-bottom:15px;">
        <h3 style="margin:0;">AIæ¨¡å‹é…ç½®</h3>
        <div id="aiUsageDate" style="font-size: 12px; color: #999; margin-top:4px;"></div>
    </div>

    <div class="ai-tabs" style="display:flex; border-bottom:1px solid #eee; margin-bottom:15px;">
        <div id="tab-btn-quota" class="ai-tab active" onclick="switchAITab('quota')" style="flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:bold; color:#4a90e2; border-bottom:2px solid #4a90e2;">é¢åº¦ç®¡ç†</div>
        <div id="tab-btn-keys" class="ai-tab" onclick="switchAITab('keys')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; border-bottom:2px solid transparent;">API Keys</div>
        <div id="tab-btn-models" class="ai-tab" onclick="switchAITab('models')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; border-bottom:2px solid transparent;">æ¨¡å‹åˆ—è¡¨</div>
    </div>

    <!-- Quota Tab -->
    <div id="tab-content-quota" style="display:block;">
        <div class="modal-desc" style="margin-bottom: 15px; text-align: center; color:#666; font-size:13px;">
            æ¯æ—¥é¢åº¦ = 20 Ã— Keyæ•°é‡ (å½“å‰: <span id="totalDailyLimit" style="font-weight:bold;">0</span>)
        </div>
        <div id="quotaList" style="display:flex; flex-direction:column; gap:12px; background: #f5f7fa; border-radius: 12px; padding: 15px;">
            <!-- Quota Items injected via JS -->
        </div>
    </div>

    <!-- Keys Tab -->
    <div id="tab-content-keys" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 4px;">
            <span style="font-weight: bold; color: #333; font-size: 14px;">æˆ‘çš„API Keys</span>
            <button onclick="toggleAddKeyForm()" style="border: none; background: none; color: #4a90e2; font-size: 24px; font-weight: bold; cursor: pointer; padding: 0 8px; line-height: 1;">+</button>
        </div>

        <!-- Add Key Form (Hidden) -->
        <div id="addKeyForm" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed #4a90e2;">
            <div style="font-size: 13px; font-weight: bold; color: #555; margin-bottom: 8px;">æ·»åŠ æ–°Key</div>
            <input type="text" id="newKeyName" placeholder="åç§° (ä¾‹å¦‚: å…¬å¸Key)" style="width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 13px;">
            <input type="text" id="newKeyVal" placeholder="sk-..." style="width: 100%; margin-bottom: 15px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 13px;">
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="toggleAddKeyForm()" style="padding: 6px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; font-size: 13px; color: #666;">å–æ¶ˆ</button>
                <button onclick="saveNewKey()" style="padding: 6px 16px; background: #4a90e2; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: bold;">ä¿å­˜</button>
            </div>
        </div>

        <!-- Key List Container -->
        <div id="aiKeyList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
            <!-- Keys injected via JS -->
        </div>
    </div>

    <!-- Models Tab -->
    <div id="tab-content-models" style="display:none;">
        <div style="margin-bottom: 10px; color: #666; font-size: 13px; text-align: center;">
            è‡ªå®šä¹‰æ¨¡å‹è°ƒç”¨é¡ºåº (ä»ä¸Šåˆ°ä¸‹ä¼˜å…ˆè°ƒç”¨)
        </div>
        <div id="modelListContainer" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
            <!-- Models injected via JS -->
        </div>
        <button onclick="addModelFromUI()" style="width:100%; padding:10px; border:1px dashed #4a90e2; background:#f0f7ff; color:#4a90e2; border-radius:8px; font-weight:bold; cursor:pointer;">+ æ·»åŠ æ¨¡å‹</button>
    </div>

    <div class="modal-btn-group" style="margin-top:20px; display: flex; gap: 10px; flex-direction: row;">
        <button class="m-btn m-btn-ghost" onclick="resetAllAIUsage()" style="color: #ff4d4f; border-color: #ff4d4f; flex: 1; width: auto; white-space: nowrap;">é‡ç½®æ‰€æœ‰é¢åº¦</button>
        <button class="m-btn m-btn-primary" onclick="closeAllModals()" style="flex: 1; width: auto; white-space: nowrap;">å®Œæˆ</button>
    </div>
</div>

<!-- Rename Plan Modal -->
<div id="renamePlanModal" class="modal" style="width: 85%; max-width: 320px; border-radius: 16px; padding: 24px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">é‡å‘½å</h3>
    <div style="margin-bottom: 25px;">
        <input type="text" id="renamePlanInput" placeholder="è¯·è¾“å…¥æ–°çš„è®¡åˆ’åç§°" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; text-align: center;" onkeypress="if(event.key === 'Enter') submitRenamePlan()">
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitRenamePlan()">ç¡®å®š</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<div id="revertConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">æ’¤é”€ç¡®è®¤</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦æ’¤é”€â€œå·²å®Œæˆâ€çŠ¶æ€å—ï¼Ÿ<br>è¿™å°†è‡ªåŠ¨å›æ»šåº“å­˜æ‰£å‡æ“ä½œã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmRevertPlan()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤æ’¤é”€</button>
    </div>
</div>

<div id="deleteConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">åˆ é™¤ç¡®è®¤</h3>
    <div id="deleteConfirmMsg" style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¡åˆ’å—ï¼Ÿ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmDeletePlan()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤åˆ é™¤</button>
    </div>
</div>

    <div id="deductModal" class="modal" onclick="if(event.target===this) closeAllModals()">
        <h3 style="margin-bottom: 24px;">ç¡®è®¤æ‰£é™¤åº“å­˜</h3>
        
        <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 24px;">
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">è®¡åˆ’åç§°</div>
            <div id="deductPlanName" style="font-weight: 600; color: #1f2937; font-size: 16px;"></div>
        </div>

        <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="font-size: 14px; font-weight: 600; color: #374151;">è€—æ—¶è®°å½•</label>
                <span style="font-size: 12px; color: #9ca3af;">(é€‰å¡«)</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="number" id="deductTimeHours" min="0" placeholder="0" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        style="width: 100%; padding: 12px; padding-right: 30px; background: #f3f4f6; border: 1px solid transparent; border-radius: 12px; font-size: 15px; outline: none; box-sizing: border-box; transition: all 0.2s; text-align: center;"
                        onfocus="this.style.background='white'; this.style.borderColor='var(--primary)';"
                        onblur="this.style.background='#f3f4f6'; this.style.borderColor='transparent';"
                    >
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 12px; pointer-events: none;">å°æ—¶</span>
                </div>
                <div style="flex: 1; position: relative;">
                    <input type="number" id="deductTimeMinutes" min="0" max="59" placeholder="0" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        style="width: 100%; padding: 12px; padding-right: 30px; background: #f3f4f6; border: 1px solid transparent; border-radius: 12px; font-size: 15px; outline: none; box-sizing: border-box; transition: all 0.2s; text-align: center;"
                        onfocus="this.style.background='white'; this.style.borderColor='var(--primary)';"
                        onblur="this.style.background='#f3f4f6'; this.style.borderColor='transparent';"
                    >
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 12px; pointer-events: none;">åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="flex: 1;">å–æ¶ˆ</button>
            <button class="m-btn m-btn-primary" onclick="confirmDeduct()" style="flex: 1;">ç¡®è®¤æ‰£é™¤</button>
        </div>
    </div>

    <div id="importConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">æ¢å¤ç¡®è®¤</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        è­¦å‘Šï¼šæ¢å¤æ“ä½œå°†é‡ç½®å½“å‰æ‰€æœ‰åº“å­˜æ•°æ®ï¼Œç„¶åå¯¼å…¥æ–°æ•°æ®ã€‚<br>ç¡®è®¤ç»§ç»­å—ï¼Ÿ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmImport()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤æ¢å¤</button>
    </div>
</div>

<div id="moveOutConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">ç§»å‡ºç¡®è®¤</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦å°†æ­¤è®¡åˆ’ç§»å‡ºå½“å‰æ–‡ä»¶å¤¹å—ï¼Ÿ<br>ç§»å‡ºåå®ƒå°†å˜å›ç‹¬ç«‹è®¡åˆ’ã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmMoveOutPlan()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤ç§»å‡º</button>
    </div>
</div>

<div id="createCollectionModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">åˆ›å»ºåˆé›†</h3>
    <div style="margin-bottom: 20px;">
        <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">è¯·è¾“å…¥åˆé›†åç§°ï¼š</label>
        <input type="text" id="collectionNameInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„åˆé›†">
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmCreateCollection()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">åˆ›å»º</button>
    </div>
</div>

<div id="resetQuotaConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">é‡ç½®ç¡®è®¤</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¨¡å‹çš„ä»Šæ—¥å·²ç”¨é¢åº¦å—ï¼Ÿ<br>é‡ç½®åå°†é‡æ–°è®¡ç®—ä½¿ç”¨é‡ã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeResetConfirmModal()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="executeResetAllAIUsage()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤é‡ç½®</button>
    </div>
</div>

<div id="deleteKeyConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">åˆ é™¤ Key</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦åˆ é™¤è¿™ä¸ª API Key å—ï¼Ÿ<br>åˆ é™¤åä¸å¯æ¢å¤ã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmDeleteKey()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">åˆ é™¤</button>
    </div>
</div>

<div id="resetUsageConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">é‡ç½®é¢åº¦</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šé‡ç½®å½“å‰ Key çš„ä»Šæ—¥é¢åº¦å—ï¼Ÿ<br>è¿™åªä¼šæ¸…é™¤æœ¬åœ°è®°å½•çš„å·²ç”¨é‡ã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmResetUsage()" style="flex: 1; padding: 10px; border: none; background: #4a90e2; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">é‡ç½®</button>
    </div>
</div>

<div id="modelEditModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 id="modelEditTitle" style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">æ·»åŠ æ¨¡å‹</h3>
    <div style="margin-bottom: 20px;">
        <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">æ¨¡å‹åç§°ï¼š</label>
        <input type="text" id="modelNameInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;" placeholder="ä¾‹å¦‚: gemini-1.5-pro" onkeypress="if(event.key === 'Enter') submitModelEdit()">
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeModelEditModal()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="submitModelEdit()" style="flex: 1; padding: 10px; border: none; background: #4a90e2; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®å®š</button>
    </div>
</div>

<div id="modelDeleteModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">åˆ é™¤ç¡®è®¤</h3>
    <p id="modelDeleteMsg" style="text-align: center; color: #666; font-size: 14px; margin-bottom: 24px; line-height: 1.5;"></p>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeModelDeleteModal()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button id="btnConfirmDeleteModel" onclick="confirmDeleteModel()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">åˆ é™¤</button>
    </div>
</div>




<!-- Fabric Tool Page -->

<div id="page-fabric" style="display:none; min-height:100vh; background:#f5f7fa; padding-bottom: 40px;">
    <!-- Fabric Tool Header -->
    <div style="background:rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding:16px 20px; display:flex; align-items:center; box-shadow:0 4px 20px rgba(0,0,0,0.03); position:sticky; top:0; z-index:100; border-bottom: 1px solid rgba(0,0,0,0.05);">
        <button onclick="navTo('home')" class="btn-back" style="background: transparent; border: none; padding: 8px; border-radius: 50%; color: #333; cursor: pointer; transition: background 0.2s;">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <h2 class="page-title-sm" style="flex:1; margin: 0 0 0 10px; font-size: 18px; font-weight: 700; color: #1f2937; letter-spacing: -0.02em;">è£å‰ªç»„åˆè®¡ç®—</h2>
    </div>

    <div class="fabric-container">
        <!-- Sidebar (Input Panel) -->
        <div class="fabric-sidebar">
            <!-- 1. Canvas Size -->
            <div class="input-section">
                <div class="section-header">
                    <span class="section-icon">ğŸ“</span>
                    <h3 class="section-title">åŸå¸ƒå°ºå¯¸</h3>
                </div>
                <div class="input-row">
                    <div class="modern-input-group">
                        <label>é•¿åº¦ (cm)</label>
                        <input type="number" id="canvasW" value="100" onchange="saveFabricState()" placeholder="0">
                    </div>
                    <div class="modern-input-group">
                        <label>å®½åº¦ (cm)</label>
                        <input type="number" id="canvasH" value="100" onchange="saveFabricState()" placeholder="0">
                    </div>
                </div>
            </div>

            <!-- 2. Specs -->
            <div class="input-section">
                <div class="section-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="section-icon">âœ‚ï¸</span>
                        <h3 class="section-title">æˆå“è§„æ ¼</h3>
                    </div>
                    <button onclick="addSpec()" class="btn-icon-add">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="3" fill="none"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        æ·»åŠ 
                    </button>
                </div>
                
                <div class="specs-hint">
                    å¸¸ç”¨ï¼š52é’‰æ¿(14x14), 78é’‰æ¿(21x21), 104é’‰æ¿(28x28)
                </div>
                
                <!-- Spec Table Header -->
                <div style="display: flex; padding: 0 10px 6px 10px; margin-top: 10px; font-size: 12px; color: #9ca3af; font-weight: 500; align-items: center;">
                    <div style="width: 20px; margin-right: 10px;">#</div>
                    <div style="flex: 1; text-align: center;">é•¿ (cm)</div>
                    <div style="width: 15px;"></div>
                    <div style="flex: 1; text-align: center;">å®½ (cm)</div>
                    <div style="width: 50px; margin-left: 8px; text-align: center;">è‡³å°‘</div>
                    <div style="width: 20px;"></div>
                </div>

                <div id="specList" class="spec-list-container">
                    <!-- Specs injected here -->
                </div>
            </div>

            <!-- 3. Preferences -->
            <div class="input-section">
                <div class="section-header">
                    <span class="section-icon">âš™ï¸</span>
                    <h3 class="section-title">è®¡ç®—åå¥½</h3>
                </div>
                <div class="modern-select-wrapper">
                    <select id="sortPref" onchange="saveFabricState()">
                        <!-- Options injected -->
                    </select>
                    <div class="select-arrow">â–¼</div>
                </div>
            </div>

            <!-- Action -->
            <button onclick="calculateLayout()" class="btn-calculate">
                <span class="btn-icon">ğŸš€</span>
                å¼€å§‹è®¡ç®—æœ€ä¼˜æ–¹æ¡ˆ
            </button>
            
            <button onclick="exportAllSolutionsToPDF()" class="btn-export-pdf" style="margin-top: 12px; width: 100%; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 14px; font-weight: 600; color: #4b5563; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;">
                <span class="btn-icon">ğŸ“„</span>
                å¯¼å‡ºæ‰€æœ‰æ–¹æ¡ˆ (PDF)
            </button>

            <div id="calcStatus" class="calc-status-text"></div>
        </div>

        <!-- Main Content (Results) -->
        <div class="fabric-main">
            <div id="solutionList" class="solution-grid">
                <!-- Empty State -->
                <div class="empty-state-card">
                    <div class="empty-icon">ğŸ“</div>
                    <h3>å‡†å¤‡å°±ç»ª</h3>
                    <p class="desktop-hint">è¯·åœ¨å·¦ä¾§é…ç½®å‚æ•°å¹¶ç‚¹å‡»è®¡ç®—</p>
                    <p class="mobile-hint">è¯·åœ¨ä¸Šæ–¹é…ç½®å‚æ•°å¹¶ç‚¹å‡»è®¡ç®—</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modern Layout Variables */
    :root {
        --fabric-primary: #4a90e2;
        --fabric-bg: #f5f7fa;
        --fabric-card-bg: #ffffff;
        --fabric-border: #e5e7eb;
        --fabric-text: #1f2937;
        --fabric-text-light: #6b7280;
    }

    /* Container Layout */
    .fabric-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
        align-items: start;
    }

    /* Sidebar Styling */
    .fabric-sidebar {
        background: var(--fabric-card-bg);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
        position: sticky;
        top: 80px; /* Sticky sidebar */
        border: 1px solid rgba(255,255,255,0.5);
    }

    .input-section {
        margin-bottom: 24px;
        border-bottom: 1px dashed var(--fabric-border);
        padding-bottom: 20px;
    }
    .input-section:last-of-type {
        border-bottom: none;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--fabric-text);
        margin: 0;
    }
    
    .section-icon {
        font-size: 16px;
        margin-right: 8px;
        opacity: 0.8;
    }

    /* Input Groups */
    .input-row {
        display: flex;
        gap: 12px;
    }

    .modern-input-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .modern-input-group label {
        font-size: 12px;
        font-weight: 600;
        color: var(--fabric-text-light);
        margin-left: 2px;
    }

    .modern-input-group input {
        width: 100%;
        padding: 10px 12px;
        background: #f9fafb;
        border: 1px solid var(--fabric-border);
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        color: var(--fabric-text);
        transition: all 0.2s;
        box-sizing: border-box;
    }

    .modern-input-group input:focus {
        background: #fff;
        border-color: var(--fabric-primary);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
        outline: none;
    }

    /* Spec List */
    .specs-hint {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 12px;
        line-height: 1.4;
        background: #f3f4f6;
        padding: 8px 12px;
        border-radius: 8px;
    }

    .spec-list-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .spec-item {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid var(--fabric-border);
        padding: 10px;
        border-radius: 10px;
        transition: all 0.2s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }
    
    .spec-item:hover {
        border-color: #d1d5db;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }

    .spec-color {
        width: 12px;
        height: 12px;
        border-radius: 4px;
        margin-right: 10px;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
    }

    .btn-icon-add {
        background: #eff6ff;
        color: var(--fabric-primary);
        border: none;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
    }
    .btn-icon-add:hover {
        background: #dbeafe;
    }

    .btn-del {
        background: transparent;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        opacity: 0.6;
        transition: all 0.2s;
        margin-left: auto;
    }
    .btn-del:hover {
        opacity: 1;
        background: #fef2f2;
    }

    /* Select */
    .modern-select-wrapper {
        position: relative;
    }
    .modern-select-wrapper select {
        width: 100%;
        padding: 12px;
        appearance: none;
        background: #fff;
        border: 1px solid var(--fabric-border);
        border-radius: 10px;
        font-size: 14px;
        color: var(--fabric-text);
        cursor: pointer;
        box-sizing: border-box;
    }
    .select-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        color: var(--fabric-text-light);
        pointer-events: none;
    }

    /* Calculate Button */
    .btn-calculate {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #4f46e5, #7c3aed); /* Modern Indigo-Purple gradient */
        color: white;
        border: none;
        border-radius: 14px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        transition: transform 0.1s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-sizing: border-box;
    }
    .btn-calculate:active {
        transform: scale(0.98);
        box-shadow: 0 2px 6px rgba(79, 70, 229, 0.2);
    }
    .calc-status-text {
        margin-top: 12px;
        font-size: 12px;
        color: var(--fabric-text-light);
        text-align: center;
        min-height: 18px;
    }

    /* Main Area */
    .solution-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 20px;
    }

    .empty-state-card {
        grid-column: 1 / -1;
        background: white;
        border-radius: 20px;
        padding: 60px;
        text-align: center;
        color: var(--fabric-text-light);
        border: 2px dashed #e5e7eb;
    }
    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
        filter: grayscale(1);
    }

    /* Solution Card Styling */
    .solution-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0,0,0,0.03);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .solution-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
    }

    .sol-header {
        padding: 14px 18px;
        background: #fcfcfd;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .sol-title {
        font-weight: 700;
        font-size: 15px;
        color: #374151;
    }
    .sol-badge {
        background: #ecfdf5;
        color: #059669;
        border: 1px solid #d1fae5;
        padding: 2px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .sol-body {
        padding: 20px;
    }
    
    .sol-canvas-wrapper {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #eee;
    }

    /* Responsive */
    .mobile-hint { display: none; }
    .desktop-hint { display: block; }

    @media (max-width: 900px) {
        .fabric-container {
            grid-template-columns: 1fr; /* Stack on tablet/mobile */
            padding: 16px;
            gap: 16px;
        }
        .fabric-sidebar {
            position: static; /* Unstick on mobile */
            width: 100%;
            box-sizing: border-box;
        }
        .solution-grid {
            grid-template-columns: 1fr; /* Single column results on mobile */
        }
        .mobile-hint { display: block; }
        .desktop-hint { display: none; }
    }
</style>


<!-- Zoom Modal -->
<div id="zoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:95%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeZoom()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="margin-bottom:10px; font-weight:bold; font-size:18px; color:#333;" id="zoomTitle">æ–¹æ¡ˆè¯¦æƒ…</div>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:10px;">
            <canvas id="zoomCanvas"></canvas>
        </div>
        <button id="zoomDownloadBtn" onclick="downloadSolution(currentZoomIdx)" style="margin-top:10px; padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">ä¿å­˜å›¾ç‰‡</button>
        <div id="zoomStats" style="margin-top:10px; width:100%; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:4px; box-sizing: border-box; background: #fafafa;"></div>
        <div style="margin-top:15px; display:flex; justify-content:center;">
             <button onclick="closeZoom()" style="padding:8px 20px; background:#f0f0f0; border:1px solid #ddd; border-radius:6px; cursor:pointer;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- Download Modal (Mobile) -->
<div id="downloadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:90%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeDownloadModal()" style="position:absolute; top:5px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:5px;">
            <img id="downloadImg" style="max-width:100%; height:auto;" />
        </div>
        <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
             <button id="downloadBtnMobile" style="padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;">ä¿å­˜å›¾ç‰‡</button>
             <button onclick="closeDownloadModal()" style="padding:8px 20px; background:#1890ff; color:white; border:none; border-radius:6px; cursor:pointer;">å…³é—­</button>
        </div>
    </div>
</div>

<div id="planSelectionBar" class="selection-bar" style="display: none;">
    <div style="font-weight: bold; color: #333;">å·²é€‰æ‹© <span id="selectedCount">0</span> ä¸ªè®¡åˆ’</div>
    <div style="display: flex; gap: 10px;">
        <button class="m-btn m-btn-ghost" onclick="exitPlanSelectionMode()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; white-space: nowrap;">å–æ¶ˆ</button>
        <button class="m-btn m-btn-primary" onclick="mergeSelectedPlans()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; background: #722ed1; border-color: #722ed1; white-space: nowrap;">åˆå¹¶è®¡åˆ’</button>
    </div>
</div>

<!-- Floating Add Button -->
<div id="floatingHomeBtn" class="floating-home-btn" onclick="navTo('home')">
    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
</div>

<div id="floatingBatchAddBtn" class="floating-add-btn" onclick="openBatchOperation()">
    <span style="font-size: 14px; font-weight: bold;">+/-</span>
</div>

<!-- Batch Operation Modal -->
<div id="batchAddModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:300; flex-direction:column;">
    <!-- Header -->
    <div style="padding:15px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0;">
        <button onclick="closeBatchAdd()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">å–æ¶ˆ</button>
        
        <!-- Mode Switch -->
        <div style="display:flex; background:#f0f0f0; border-radius:20px; padding:2px;">
            <div id="batchModeAdd" onclick="setBatchMode('add')" style="padding:5px 15px; border-radius:18px; font-size:14px; cursor:pointer; background:white; color:#4a90e2; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition:all 0.2s;">å…¥åº“</div>
            <div id="batchModeDeduct" onclick="setBatchMode('deduct')" style="padding:5px 15px; border-radius:18px; font-size:14px; cursor:pointer; color:#666; transition:all 0.2s;">å‡ºåº“</div>
        </div>
        
        <button onclick="toggleBatchSelectAll()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">å…¨é€‰</button>
    </div>
    
    <!-- Subtitle -->
    <div id="batchSubtitle" style="padding:10px 15px; background:#f9f9f9; color:#999; font-size:12px;">
        å¢åŠ åº“å­˜ï¼Œ1å•ä½ = 1000ç²’ = 10g
    </div>
    
    <!-- Series Tabs -->
    <div id="batchAddSeriesTabs" style="display:flex; overflow-x:auto; padding:10px 15px; gap:10px; border-bottom:1px solid #f0f0f0; -webkit-overflow-scrolling: touch;">
        <!-- Tabs injected by JS -->
    </div>
    
    <!-- List -->
    <div id="batchAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <!-- Items injected by JS -->
    </div>
    
    <!-- Footer -->
    <div style="padding:15px; border-top:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; background:white;">
        <div>
            <div style="font-size:12px; color:#999;">å·²é€‰æ‹© <span id="batchAddCount" style="color:#333; font-weight:bold;">0</span> è‰²</div>
            <div style="font-size:16px; font-weight:bold; color:#4a90e2;" id="batchTotalDisplay">å…± +<span id="batchAddTotal">0</span> ç²’</div>
        </div>
        <button onclick="confirmBatchAdd()" id="batchConfirmBtn" class="m-btn m-btn-primary" style="width:auto; padding:10px 25px; border-radius:20px; box-shadow:0 4px 10px rgba(74, 144, 226, 0.3);">ç¡®è®¤æ·»åŠ </button>
    </div>
</div>

<style>
.floating-add-btn {
    position: fixed; bottom: 100px; right: 20px;
    width: 36px; height: 36px;
    background: #4a90e2;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    display: none; align-items: center; justify-content: center;
    color: white; font-size: 24px; cursor: pointer;
    z-index: 180; transition: transform 0.2s;
}
.floating-add-btn:active { transform: scale(0.90); }
.floating-add-btn span { position: relative; top: -1px; }

.floating-home-btn {
    position: fixed; bottom: 100px; right: 70px;
    width: 36px; height: 36px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none; align-items: center; justify-content: center;
    color: #4a90e2; font-size: 20px; cursor: pointer;
    z-index: 180; transition: transform 0.2s; border: 1px solid #eee;
}
.floating-home-btn:active { transform: scale(0.90); }


.batch-tab {
    padding: 6px 16px; border-radius: 20px; background: #f0f0f0; color: #666; font-size: 14px; flex-shrink: 0; cursor: pointer; transition: all 0.2s;
}
.batch-tab.active {
    background: #4a90e2; color: white; box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3);
}

.batch-item {
    display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; margin-bottom: 10px; border: 1px solid #f0f0f0; transition: all 0.2s;
}
.batch-item.selected {
    border-color: #91d5ff; background: #e6f7ff;
}

.batch-check {
    width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; margin-right: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.batch-item.selected .batch-check {
    background: #4a90e2; border-color: #4a90e2; color: white;
}
.batch-check::after {
    content: "âœ“"; font-size: 14px; display: none;
}
.batch-item.selected .batch-check::after {
    display: block;
}

.batch-stepper {
    display: flex; align-items: center; background: white; border-radius: 8px; border: 1px solid #eee; overflow: hidden;
}
.batch-step-btn {
    width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; color: #666; cursor: pointer;
}
.batch-step-btn.add {
    background: #4a90e2; color: white;
}
.batch-input {
    width: 44px; text-align: center; border: none; font-size: 14px; color: #333; outline: none; background: transparent;
}
</style>

<script>
let batchAddSelection = {}; // { id: qty }
let batchCurrentSeries = 'A';
let batchMode = 'add'; // 'add' | 'deduct'

function openBatchOperation() {
    batchAddSelection = {};
    document.getElementById('batchAddModal').style.display = 'flex';
    
    // Default to Add mode
    setBatchMode('add');
    
    // Find all series
    const series = new Set();
    data.forEach(d => {
        const match = d.id.match(/^[A-Z]+/);
        if(match) series.add(match[0]);
    });
    const sortedSeries = Array.from(series).sort();
    if(sortedSeries.length > 0) batchCurrentSeries = sortedSeries[0];
    
    renderBatchAddTabs(sortedSeries);
    renderBatchAddList();
    updateBatchSummary();
}

function setBatchMode(mode) {
    batchMode = mode;
    batchAddSelection = {}; 
    
    const btnAdd = document.getElementById('batchModeAdd');
    const btnDeduct = document.getElementById('batchModeDeduct');
    const confirmBtn = document.getElementById('batchConfirmBtn');
    
    if(mode === 'add') {
        btnAdd.style.background = 'white';
        btnAdd.style.color = '#4a90e2';
        btnAdd.style.fontWeight = 'bold';
        btnAdd.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        btnDeduct.style.background = 'transparent';
        btnDeduct.style.color = '#666';
        btnDeduct.style.fontWeight = 'normal';
        btnDeduct.style.boxShadow = 'none';
        
        confirmBtn.innerText = 'ç¡®è®¤å…¥åº“';
        confirmBtn.style.background = '#4a90e2';
    } else {
        btnDeduct.style.background = 'white';
        btnDeduct.style.color = '#e24a4a';
        btnDeduct.style.fontWeight = 'bold';
        btnDeduct.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        btnAdd.style.background = 'transparent';
        btnAdd.style.color = '#666';
        btnAdd.style.fontWeight = 'normal';
        btnAdd.style.boxShadow = 'none';
        
        confirmBtn.innerText = 'ç¡®è®¤å‡ºåº“';
        confirmBtn.style.background = '#e24a4a';
    }
    
    renderBatchAddList();
    updateBatchSummary();
}

function closeBatchAdd() {
    document.getElementById('batchAddModal').style.display = 'none';
}

function renderBatchAddTabs(allSeries) {
    const container = document.getElementById('batchAddSeriesTabs');
    container.innerHTML = '';
    allSeries.forEach(s => {
        const div = document.createElement('div');
        div.className = `batch-tab ${s === batchCurrentSeries ? 'active' : ''}`;
        div.innerText = s;
        div.onclick = () => {
            batchCurrentSeries = s;
            renderBatchAddTabs(allSeries);
            renderBatchAddList();
        };
        container.appendChild(div);
    });
}

function renderBatchAddList() {
    const container = document.getElementById('batchAddList');
    container.innerHTML = '';
    
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    
    items.forEach(item => {
        const isSelected = batchAddSelection[item.id] !== undefined;
        let qty = batchAddSelection[item.id];
        if (qty === undefined) {
             qty = (batchMode === 'add') ? 1 : ''; 
        }
        
        const div = document.createElement('div');
        div.className = `batch-item ${isSelected ? 'selected' : ''}`;
        div.onclick = (e) => {
            if(e.target.closest('.batch-stepper') || e.target.tagName === 'INPUT') return;
            toggleBatchItem(item.id);
        };
        
        let controlsHtml = '';
        if (isSelected) {
            if (batchMode === 'add') {
                controlsHtml = `
                <div class="batch-stepper">
                    <div class="batch-step-btn" onclick="updateBatchQty('${item.id}', -1)">-</div>
                    <input type="number" class="batch-input" value="${qty}" step="0.1" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                    <div class="batch-step-btn add" onclick="updateBatchQty('${item.id}', 1)">+</div>
                </div>
                <div style="font-size: 10px; color: #999; margin-left: 5px;">x1000</div>
                `;
            } else {
                 controlsHtml = `
                <div class="batch-stepper" style="border-color:#e24a4a; height: 30px; display: flex; align-items: center;">
                    <div style="padding-left: 8px; color: #e24a4a; font-weight: bold;">-</div>
                    <input type="number" class="batch-input" style="width:60px; text-align:center; height: 100%;" value="${qty}" placeholder="" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                </div>
                <div style="font-size: 10px; color: #999; margin-left: 5px;">ç²’</div>
                `;
            }
        }
        
        div.innerHTML = `
            <div class="batch-check"></div>
            <div style="width: 36px; height: 36px; background: ${item.hex}; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); margin-right: 15px;"></div>
            <div style="flex: 1; font-weight: bold; font-size: 16px;">${item.id}</div>
            ${controlsHtml}
        `;
        container.appendChild(div);
    });
}

function toggleBatchItem(id) {
    if (batchAddSelection[id] !== undefined) {
        delete batchAddSelection[id];
    } else {
        batchAddSelection[id] = (batchMode === 'add') ? 1 : '';
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQty(id, delta) {
    if (batchAddSelection[id] === undefined) return;
    
    if (batchMode === 'add') {
        let newQty = parseFloat(batchAddSelection[id]) + delta;
        newQty = parseFloat(newQty.toFixed(1));
        if (newQty <= 0) {
            delete batchAddSelection[id];
        } else {
            batchAddSelection[id] = newQty;
        }
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQtyInput(id, val) {
    if (batchMode === 'add') {
        let newQty = parseFloat(val);
        if (isNaN(newQty) || newQty <= 0) {
            delete batchAddSelection[id];
        } else {
            batchAddSelection[id] = parseFloat(newQty.toFixed(1));
        }
    } else {
        if (val === '') {
             batchAddSelection[id] = '';
        } else {
            let newQty = parseInt(val);
            if (isNaN(newQty) || newQty <= 0) {
                // Keep selection but maybe invalid? 
                // If user enters -5, we should probably reject or set to something valid.
                // For now, if invalid, delete selection? Or just don't update?
                // Deleting selection might be annoying if accidental.
                // Let's just set to valid or ignore.
                // If <= 0, delete.
                if (newQty <= 0) delete batchAddSelection[id];
                else batchAddSelection[id] = newQty;
            } else {
                batchAddSelection[id] = newQty;
            }
        }
    }
    updateBatchSummary();
}

function toggleBatchSelectAll() {
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    const allSelected = items.every(item => batchAddSelection[item.id] !== undefined);
    
    if (allSelected) {
        items.forEach(item => delete batchAddSelection[item.id]);
    } else {
        items.forEach(item => {
            if(batchAddSelection[item.id] === undefined) {
                 batchAddSelection[item.id] = (batchMode === 'add') ? 1 : '';
            }
        });
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchSummary() {
    const count = Object.keys(batchAddSelection).length;
    let total = 0;
    
    Object.values(batchAddSelection).forEach(q => {
        if(q === '' || q === undefined) return;
        if(batchMode === 'add') {
            total += q * 1000;
        } else {
            total += q;
        }
    });
    
    document.getElementById('batchAddCount').innerText = count;
    const totalDisplay = document.getElementById('batchTotalDisplay');
    const totalSpan = document.getElementById('batchAddTotal');
    
    if(batchMode === 'add') {
        totalDisplay.innerHTML = `å…± +<span id="batchAddTotal">0</span> ç²’`;
        document.getElementById('batchAddTotal').innerText = (total >= 1000) ? (total/1000).toFixed(1) + 'K' : total;
    } else {
        totalDisplay.innerHTML = `å…± -<span id="batchAddTotal">0</span> ç²’`;
        document.getElementById('batchAddTotal').innerText = total;
    }
}

function confirmBatchAdd() {
    const count = Object.keys(batchAddSelection).length;
    if (count === 0) return;
    
    const now = new Date();
    const dateStr = formatTime(now);
    
    if (batchMode === 'add') {
        Object.entries(batchAddSelection).forEach(([id, qty]) => {
            const item = data.find(d => d.id === id);
            if(item) {
                const weightToAdd = qty * 10; 
                item.w = parseFloat((item.w + weightToAdd).toFixed(2));
                item.totalAdded = parseFloat(((item.totalAdded || 0) + weightToAdd).toFixed(2));
                
                if(!item.logs) item.logs = [];
                item.logs.push({ d: dateStr, type: 'add', val: weightToAdd, note: 'æ‰¹é‡å…¥åº“' });
                if(item.logs.length > 20) item.logs.shift();
            }
        });
        showToast("å…¥åº“æˆåŠŸï¼");
    } else {
        // Deduct mode
        let warnings = [];
        let validDeductions = [];
        
        for (const [id, qty] of Object.entries(batchAddSelection)) {
            if (!qty) continue;
            const item = data.find(d => d.id === id);
            if (!item) continue;
            
            const currentBeads = Math.round(item.w * 100); 
            const deductBeads = qty;
            
            if (deductBeads > currentBeads) {
                warnings.push(`${id} (åº“å­˜: ${currentBeads}, æ‰£é™¤: ${deductBeads})`);
            }
            
            const weightToDeduct = parseFloat((deductBeads * 0.01).toFixed(2));
            validDeductions.push({ item, weightToDeduct, beads: deductBeads });
        }
        
        if (warnings.length > 0) {
            const msg = "ä»¥ä¸‹è‰²å·æ‰£é™¤æ•°é‡è¶…è¿‡å½“å‰åº“å­˜ï¼š\n" + warnings.join("\n") + "\n\næ˜¯å¦ç»§ç»­æ‰£é™¤ï¼Ÿ";
            if (!confirm(msg)) return;
        }
        
        validDeductions.forEach(({ item, weightToDeduct, beads }) => {
            item.w = parseFloat((item.w - weightToDeduct).toFixed(2));
            item.used = parseFloat(((item.used || 0) + weightToDeduct).toFixed(2));
             
            if(!item.logs) item.logs = [];
            item.logs.push({ d: dateStr, type: 'use', val: weightToDeduct, c: beads, note: 'æ‰¹é‡å‡ºåº“' });
            if(item.logs.length > 20) item.logs.shift();
        });
        showToast("å‡ºåº“æˆåŠŸï¼");
    }
    
    save();
    render();
    closeBatchAdd();
}
    // --- Pull to Refresh Logic ---
    let ptrStartY = 0;
    let ptrCurrentY = 0;
    let ptrDistance = 0;
    let isPtrActive = false;
    let isPtrLoading = false;
    const PTR_THRESHOLD = 80;
    
    // Main scrollable element is body/window
    window.addEventListener('touchstart', (e) => {
        // Only enable on specific pages
        const activePage = ['page-beads', 'page-stats', 'page-plan', 'page-fabric'].find(id => document.getElementById(id).style.display !== 'none');
        if (!activePage) return;
        
        if (window.scrollY === 0 && !isPtrLoading) {
            ptrStartY = e.touches[0].clientY;
            isPtrActive = true;
        }
    }, {passive: true});
    
    window.addEventListener('touchmove', (e) => {
        if (!isPtrActive || isPtrLoading) return;
        
        ptrCurrentY = e.touches[0].clientY;
        const diff = ptrCurrentY - ptrStartY;
        
        // Only track pull down
        if (diff > 0 && window.scrollY === 0) {
            // Resistance effect
            ptrDistance = Math.pow(diff, 0.8);
            
            // Limit max pull
            if (ptrDistance > 150) ptrDistance = 150;
            
            updatePtrVisuals(ptrDistance);
        } else {
            isPtrActive = false;
            resetPtr();
        }
    }, {passive: true});
    
    window.addEventListener('touchend', () => {
        if (!isPtrActive || isPtrLoading) return;
        
        if (ptrDistance > PTR_THRESHOLD) {
            startPtrLoading();
        } else {
            resetPtr();
        }
        isPtrActive = false;
    });
    
    function updatePtrVisuals(dist) {
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const text = document.getElementById('ptr-text');
        
        indicator.style.transform = `translateY(${dist}px)`;
        
        if (dist > PTR_THRESHOLD) {
            text.textContent = "é‡Šæ”¾åˆ·æ–°";
            icon.style.transform = "rotate(180deg)";
        } else {
            text.textContent = "ä¸‹æ‹‰åˆ·æ–°";
            icon.style.transform = "rotate(0deg)";
        }
    }
    
    function startPtrLoading() {
        isPtrLoading = true;
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const spinner = document.getElementById('ptr-spinner');
        const text = document.getElementById('ptr-text');
        
        indicator.style.transform = `translateY(50px)`;
        icon.style.display = 'none';
        spinner.style.display = 'block';
        text.textContent = "åŠ è½½ä¸­...";
        
        // Simulate refresh delay
        setTimeout(() => {
            window.location.reload();
        }, 800);
    }
    
    function resetPtr() {
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const spinner = document.getElementById('ptr-spinner');
        
        indicator.style.transform = `translateY(0)`;
        icon.style.display = 'inline';
        icon.style.transform = "rotate(0deg)";
        spinner.style.display = 'none';
        ptrDistance = 0;
    }

    // --- Plan Image Viewer Logic ---
    let imgScale = 1;
    let imgTranslateX = 0;
    let imgTranslateY = 0;
    let imgStartX = 0;
    let imgStartY = 0;
    let imgIsDragging = false;
    let imgInitialPinchDist = 0;
    let imgInitialScale = 1;

    function openPlanImageViewer() {
        const detailImg = document.getElementById('planDetailImage');
        const fullImg = document.getElementById('planFullImage');
        if (!detailImg.src) return;
        
        fullImg.src = detailImg.src;
        document.getElementById('planImageViewer').style.display = 'block';
        resetPlanImageZoom();
        
        // Disable page scroll
        document.body.style.overflow = 'hidden';
    }

    function closePlanImageViewer() {
        document.getElementById('planImageViewer').style.display = 'none';
        document.body.style.overflow = '';
    }

    function resetPlanImageZoom() {
        imgScale = 1;
        imgTranslateX = 0;
        imgTranslateY = 0;
        updateImageTransform();
    }

    function updateImageTransform() {
        const img = document.getElementById('planFullImage');
        img.style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${imgScale})`;
    }

    // Touch Event Handlers
    const viewer = document.getElementById('planImageViewer');
    
    viewer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            // Pinch
            imgIsDragging = false;
            imgInitialPinchDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            imgInitialScale = imgScale;
        } else if (e.touches.length === 1) {
            // Pan
            imgIsDragging = true;
            imgStartX = e.touches[0].clientX - imgTranslateX;
            imgStartY = e.touches[0].clientY - imgTranslateY;
        }
    });

    viewer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const currentDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            const ratio = currentDist / imgInitialPinchDist;
            let newScale = imgInitialScale * ratio;
            newScale = Math.min(Math.max(0.5, newScale), 5); // Limit 0.5x to 5x
            imgScale = newScale;
            updateImageTransform();
        } else if (e.touches.length === 1 && imgIsDragging) {
            e.preventDefault();
            imgTranslateX = e.touches[0].clientX - imgStartX;
            imgTranslateY = e.touches[0].clientY - imgStartY;
            updateImageTransform();
        }
    });

    viewer.addEventListener('touchend', () => {
        imgIsDragging = false;
    });

    // Mouse Events for Desktop Testing
    let isMouseDownViewer = false;
    viewer.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'IMG' || e.target.id === 'planImageWrapper') {
             isMouseDownViewer = true;
             imgStartX = e.clientX - imgTranslateX;
             imgStartY = e.clientY - imgTranslateY;
        }
    });

    viewer.addEventListener('mousemove', (e) => {
        if (!isMouseDownViewer) return;
        e.preventDefault();
        imgTranslateX = e.clientX - imgStartX;
        imgTranslateY = e.clientY - imgStartY;
        updateImageTransform();
    });

    viewer.addEventListener('mouseup', () => {
        isMouseDownViewer = false;
    });

    viewer.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = -Math.sign(e.deltaY) * 0.1;
        let newScale = imgScale + delta;
        newScale = Math.min(Math.max(0.5, newScale), 5);
        imgScale = newScale;
        updateImageTransform();
    }, {passive: false});

    function togglePlanOverviewContainer() {
        const el = document.getElementById('plan-overview-container');
        if (el) {
            if (el.style.display === 'none') {
                el.style.display = 'block';
                updatePlanOverviewStats();
            } else {
                el.style.display = 'none';
            }
        }
    }

    function updatePlanOverviewStats() {
        let plans = [];
        try {
            plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        } catch (e) {
            console.error('Error loading plans for stats:', e);
        }
        
        const getRealCount = (list) => {
            let count = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    count += getRealCount(p.subPlans);
                } else {
                    count++;
                }
            });
            return count;
        };

        const getRealTime = (list) => {
            let t = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    t += getRealTime(p.subPlans);
                } else {
                    if(p.status === 'completed') {
                        t += parseTimeSpentToHours(p.timeSpent);
                    }
                }
            });
            return t;
        };

        const activeList = plans.filter(p => (p.status || 'active') === 'active');
        const completedList = plans.filter(p => (p.status || 'active') === 'completed');

        const planPending = getRealCount(activeList);
        const planCompleted = getRealCount(completedList);
        const planTotal = planPending + planCompleted;
        const planTime = getRealTime(plans);

        const elPlanTotal = document.getElementById('stats-plan-total');
        if(elPlanTotal) elPlanTotal.textContent = planTotal;
        
        const elPlanCompleted = document.getElementById('stats-plan-completed');
        if(elPlanCompleted) elPlanCompleted.textContent = planCompleted;
        
        const elPlanPending = document.getElementById('stats-plan-pending');
        if(elPlanPending) elPlanPending.textContent = planPending;

        const elPlanTime = document.getElementById('stats-plan-time');
        if(elPlanTime) elPlanTime.textContent = planTime.toFixed(1);

        // Update UI state based on planChartConfig
        const setMetricActive = (id, active, color) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (active) {
                el.style.border = `2px solid ${color}`;
                el.style.background = '#f9f9f9';
            } else {
                el.style.border = '2px solid transparent';
                el.style.background = 'transparent';
            }
        };

        setMetricActive('metric-total', planChartConfig.total, '#4a90e2');
        setMetricActive('metric-completed', planChartConfig.completed, '#52c41a');
        setMetricActive('metric-pending', planChartConfig.pending, '#faad14');
        setMetricActive('metric-time', planChartConfig.time, '#722ed1');

        renderPlanChart(plans);
    }

</script>
    <!-- Image Viewer Modal -->
    <div id="planImageViewer" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; overflow: hidden; touch-action: none;">
         <div style="position: absolute; top: 20px; right: 20px; z-index: 2010; display: flex; gap: 15px;">
             <div onclick="closePlanImageViewer()" style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; backdrop-filter: blur(4px);">
                 <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
             </div>
         </div>
         
         <div id="planImageWrapper" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
             <img id="planFullImage" src="" style="max-width: 100%; max-height: 100%; transition: transform 0.1s linear; transform-origin: center center;">
         </div>
         

    </div>

<!-- Moved editTimeModal to body root to ensure proper z-index and positioning -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<div id="editTimeModal" class="modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 85%; max-width: 320px; padding: 0; border-radius: 20px; z-index: 10001; overflow: hidden; background: #fff;">
    <div style="background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%); padding: 24px 20px 10px 20px; text-align: center;">
        <div style="font-size: 32px; margin-bottom: 8px;">â³</div>
        <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 600;">è®°å½•åˆ¶ä½œè€—æ—¶</h3>
        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">è®°å½•ä¸‹ä½ çš„å¿ƒè¡€ä¸æ—¶é—´</p>
    </div>
    
    <div style="padding: 20px;">
        <input type="hidden" id="editTimePlanId">
        
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 24px;">
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                <div style="position: relative; width: 100%;">
                    <input type="number" id="editTimeHours" min="0" placeholder="0" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        style="width: 100%; padding: 12px; padding-right: 30px; background: #f9fafb; border: 2px solid #f0f0f0; border-radius: 12px; font-size: 20px; outline: none; box-sizing: border-box; transition: all 0.2s; text-align: center; font-weight: bold; color: #333;"
                        onfocus="this.style.background='white'; this.style.borderColor='var(--primary)';"
                        onblur="this.style.background='#f9fafb'; this.style.borderColor='#f0f0f0';"
                    >
                    <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 12px; pointer-events: none;">å°æ—¶</span>
                </div>
            </div>
            <div style="font-weight: bold; color: #ccc;">:</div>
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                <div style="position: relative; width: 100%;">
                    <input type="number" id="editTimeMinutes" min="0" max="59" placeholder="0" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        style="width: 100%; padding: 12px; padding-right: 30px; background: #f9fafb; border: 2px solid #f0f0f0; border-radius: 12px; font-size: 20px; outline: none; box-sizing: border-box; transition: all 0.2s; text-align: center; font-weight: bold; color: #333;"
                        onfocus="this.style.background='white'; this.style.borderColor='var(--primary)';"
                        onblur="this.style.background='#f9fafb'; this.style.borderColor='#f0f0f0';"
                    >
                    <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 12px; pointer-events: none;">åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button onclick="closeAllModals()" style="flex: 1; padding: 12px; border: 1px solid #eee; background: white; color: #666; border-radius: 12px; font-size: 15px; font-weight: 500;">å–æ¶ˆ</button>
            <button onclick="savePlanTime()" style="flex: 1; padding: 12px; border: none; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; border-radius: 12px; font-size: 15px; font-weight: bold; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- Tag Management Modal -->
<div id="tagManageModal" class="modal" style="width: 85%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">ç®¡ç†æ ‡ç­¾</h3>
    
    <div class="tag-input-container">
        <div id="currentTagsList" style="display:flex; flex-wrap:wrap; gap:5px; width:100%;"></div>
        <input type="text" id="newTagInput" placeholder="è¾“å…¥æ ‡ç­¾æŒ‰å›è½¦æ·»åŠ " style="flex:1; min-width:80px; border:none; outline:none; font-size:13px; background:transparent; padding:4px 0;" onkeypress="if(event.key === 'Enter') addNewTag()">
    </div>

    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="finishTagEditing()">å®Œæˆ</button>
    </div>
</div>

<!-- Find Color Modal -->
<div id="findColorModal" class="modal" style="width: 90%; max-width: 360px; height: 80vh; max-height: 600px; display: none; flex-direction: column; padding: 0; overflow: hidden; border-radius: 20px;">
    <div style="padding: 20px; background: white; border-bottom: 1px solid #f0f0f0;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: bold; color: #333;">ğŸ” åå‘è‰²å·æŸ¥æ‰¾</h3>
            <button onclick="closeAllModals()" style="background:none; border:none; color:#999; font-size:24px; padding:0; line-height:1;">&times;</button>
        </div>
        
        <div style="display:flex; gap: 15px; align-items: center;">
            <div style="position: relative; width: 60px; height: 60px; border-radius: 12px; overflow: hidden; border: 2px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <input type="color" id="findColorInput" value="#ff0000" onchange="performColorSearch()" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; padding: 0; margin: 0; border: none; cursor: pointer;">
            </div>
            <div style="flex: 1;">
                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">ç‚¹å‡»å·¦ä¾§è‰²å—é€‰æ‹©é¢œè‰²</div>
                <div id="findColorHex" style="font-family: monospace; font-weight: bold; color: #333; font-size: 16px;">#FF0000</div>
            </div>
        </div>
    </div>

    <div style="padding: 10px 20px; background: #f9f9f9; font-size: 12px; color: #999; border-bottom: 1px solid #eee;">
        ä¸ºæ‚¨æ‰¾åˆ°æœ€æ¥è¿‘çš„ 10 ä¸ªåº“å­˜è‰²å·ï¼š
    </div>

    <div id="findColorList" style="flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9;">
        <!-- Results -->
    </div>
</div>


<!-- Page: Cat Inventory -->
<div id="page-cat" style="display:none; padding-bottom: 80px; background: #f7f8fa; min-height: 100vh;">
    <div class="container" style="padding: 0;">
        <!-- Header -->
        <div style="background: white; padding: 12px 16px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;">
            <button onclick="navTo('home')" class="btn-back">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <h2 class="page-title-sm" style="flex:1; margin-left: 8px;">çŒ«å’ªç”¨å“ç»Ÿè®¡</h2>
        </div>

        <!-- Tabs (hidden, replaced by floating buttons) -->
        <div style="display:none; background: white; padding: 0 16px; border-bottom: 1px solid #f0f0f0;">
            <div id="cat-btn-inventory" class="cat-tab-btn active" onclick="switchCatTab('inventory')" style="flex:1; text-align:center; padding: 12px; font-size:14px; font-weight:500; color:#666; cursor:pointer; border-bottom: 2px solid transparent;">
                å½“å‰åº“å­˜
            </div>
            <div id="cat-btn-logs" class="cat-tab-btn" onclick="switchCatTab('logs')" style="flex:1; text-align:center; padding: 12px; font-size:14px; font-weight:500; color:#666; cursor:pointer; border-bottom: 2px solid transparent;">
                å‡ºå…¥åº“è®°å½•
            </div>
        </div>

        <!-- Content: Inventory -->
        <div id="cat-tab-inventory" class="cat-tab-content" style="padding: 16px;">
            <!-- Filter Bar -->
            <div id="catFilterBar" style="display:flex; gap:10px; margin-bottom:8px; align-items:center; position: sticky; top: 0; z-index: 9999; background:#fff; padding:8px 0;">
                <input type="text" id="catSearch" placeholder="æœç´¢åç§°æˆ–ç±»åˆ«..." oninput="renderCatInventory()" style="flex:1; border:1px solid #ddd; padding:8px 12px; border-radius:8px; outline:none; position: relative; z-index: 1001;">
                <button id="catCategoryToggleBtn" onclick="toggleCatCategoryPanel()" style="padding:8px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border:1px solid #ddd; border-radius:8px; background:white; cursor:pointer; position: relative; z-index: 1002;" aria-label="ç­›é€‰ç±»åˆ«">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#4a90e2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="3 4 21 4 14 12 14 19 10 21 10 12 3 4"></polygon>
                    </svg>
                </button>
            </div>
            <div id="catCategoryPanel" style="display:none; margin-bottom:16px; padding:8px; background:#f7f8fa; border:1px solid #eee; border-radius:12px; position: relative; z-index: 999;">
                <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
                    <span style="font-size:12px; color:#666;">æ’åº:</span>
                    <button id="catSortExpiryBtn" onclick="setCatSort('expiry_asc')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#e6f7ff; color:#1890ff;">æŒ‰è¿‡æœŸæ—¶é—´</button>
                    <button id="catSortDateBtn" onclick="setCatSort('date_desc')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">æŒ‰è´­å…¥æ—¶é—´</button>
                </div>
                <div style="margin:6px 0 4px; font-size:12px; color:#666;">ç±»åˆ«:</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                    <button onclick="toggleCatCategory('all')" data-cat="all" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">å…¨éƒ¨</button>
                    <button onclick="toggleCatCategory('ä¸»ç²®')" data-cat="ä¸»ç²®" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">ä¸»ç²®</button>
                    <button onclick="toggleCatCategory('ç½å¤´')" data-cat="ç½å¤´" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">ç½å¤´</button>
                    <button onclick="toggleCatCategory('å†»å¹²')" data-cat="å†»å¹²" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">å†»å¹²</button>
                    <button onclick="toggleCatCategory('ä¿å¥å“')" data-cat="ä¿å¥å“" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">ä¿å¥å“</button>
                    <button onclick="toggleCatCategory('è¯å“')" data-cat="è¯å“" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">è¯å“</button>
                    <button onclick="toggleCatCategory('çŒ«ç ‚')" data-cat="çŒ«ç ‚" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">çŒ«ç ‚</button>
                    <button onclick="toggleCatCategory('ç©å…·')" data-cat="ç©å…·" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">ç©å…·</button>
                    <button onclick="toggleCatCategory('å…¶ä»–')" data-cat="å…¶ä»–" class="cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:white; cursor:pointer;">å…¶ä»–</button>
                </div>
            </div>

            <div id="catSummaryBar" style="display:none; margin-bottom:10px; background:#f0f5ff; border:1px solid #d6e4ff; border-radius:12px; padding:8px 12px; color:#1d39c4; font-size:13px;">
                <span id="catSummaryCount"></span>
                <span style="margin-left:10px;" id="catSummaryQty"></span>
                <span style="margin-left:10px;" id="catSummaryNear"></span>
            </div>
            <div id="catCategoryStats" style="display:none; margin-bottom:12px; background:#ffffff; border:1px solid #f0f0f0; border-radius:12px; padding:10px 12px; color:#333; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                <!-- Filled by JS -->
            </div>

            <!-- List -->
            <div id="catInventoryList">
                <!-- Items will be rendered here -->
            </div>
        </div>

        <!-- Content: Logs -->
        <div id="cat-tab-logs" class="cat-tab-content" style="display:none;">
            <div style="display:flex; justify-content:flex-start; padding:12px 16px 8px 16px;">
                <button onclick="toggleCatLogsFilterPanel()" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#fff; color:#666; display:flex; align-items:center; gap:6px;">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#4a90e2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="3 4 21 4 14 12 14 19 10 21 10 12 3 4"></polygon>
                    </svg>
                    <span style="font-size:12px;">ç­›é€‰</span>
                </button>
            </div>
            <div id="catLogsFilterPanel" style="display:none;">
                <div style="display:flex; gap:8px; align-items:center; padding:0 16px 8px 16px;">
                    <button id="catLogFilterAll" onclick="setCatLogFilter('all')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#e6f7ff; color:#1890ff;">å…¨éƒ¨</button>
                    <button id="catLogFilterOutbound" onclick="setCatLogFilter('outbound')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">å‡ºåº“</button>
                    <button id="catLogFilterInbound" onclick="setCatLogFilter('inbound')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">å…¥åº“</button>
                </div>
                <div style="display:flex; gap:8px; align-items:center; padding:0 16px 8px 16px;">
                    <button id="catLogDateAll" onclick="setCatLogDateRange('all')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#e6f7ff; color:#1890ff;">å…¨éƒ¨</button>
                    <button id="catLogDateToday" onclick="setCatLogDateRange('today')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">ä»Šå¤©</button>
                    <button id="catLogDate7" onclick="setCatLogDateRange('last7')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">è¿‘7å¤©</button>
                    <button id="catLogDateMonth" onclick="setCatLogDateRange('month')" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">æœ¬æœˆ</button>
                </div>
                <div style="padding:0 16px 8px 16px;">
                    <div style="margin:6px 0 4px; font-size:12px; color:#666;">ç±»åˆ«:</div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <button onclick="toggleLogCategory('all')" data-log-cat="all" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#e6f7ff; color:#1890ff;">å…¨éƒ¨</button>
                        <button onclick="toggleLogCategory('ä¸»ç²®')" data-log-cat="ä¸»ç²®" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">ä¸»ç²®</button>
                    <button onclick="toggleLogCategory('ç½å¤´')" data-log-cat="ç½å¤´" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">ç½å¤´</button>
                        <button onclick="toggleLogCategory('å†»å¹²')" data-log-cat="å†»å¹²" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">å†»å¹²</button>
                        <button onclick="toggleLogCategory('ä¿å¥å“')" data-log-cat="ä¿å¥å“" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">ä¿å¥å“</button>
                        <button onclick="toggleLogCategory('è¯å“')" data-log-cat="è¯å“" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">è¯å“</button>
                        <button onclick="toggleLogCategory('çŒ«ç ‚')" data-log-cat="çŒ«ç ‚" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">çŒ«ç ‚</button>
                        <button onclick="toggleLogCategory('ç©å…·')" data-log-cat="ç©å…·" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">ç©å…·</button>
                        <button onclick="toggleLogCategory('å…¶ä»–')" data-log-cat="å…¶ä»–" class="log-cat-chip" style="padding:6px 10px; border-radius:16px; border:1px solid #ddd; background:#f5f5f5; color:#666;">å…¶ä»–</button>
                    </div>
                </div>
            </div>
            <div id="catLogList">
                <!-- Logs will be rendered here -->
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Item (uses common modal system) -->
<div id="catAddModal" class="modal" style="width: 95%; max-width: 360px; padding: 20px; border-radius: 20px;">
    <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 12px; text-align: center; color: #111;">å…¥åº“ç™»è®°</h3>
    
    <div style="display:flex; flex-direction:column; gap:14px;">
        <div class="cat-form-row cols-3" style="grid-template-columns: 0.8fr 1.6fr 1fr;">
            <div class="cat-form-item">
                <label class="cat-form-label">å“ç‰Œ</label>
                <input type="text" id="catAddBrand" class="cat-input">
            </div>
            <div class="cat-form-item">
                <label class="cat-form-label">åç§°</label>
                <input type="text" id="catAddName" class="cat-input">
            </div>
            <div class="cat-form-item">
                <label class="cat-form-label">åˆ†ç±»</label>
                <select id="catAddCategory" class="cat-input">
                    <option value="ä¸»ç²®">ä¸»ç²®</option>
                    <option value="ç½å¤´">ç½å¤´</option>
                    <option value="å†»å¹²">å†»å¹²</option>
                    <option value="ä¿å¥å“">ä¿å¥å“</option>
                    <option value="è¯å“">è¯å“</option>
                    <option value="çŒ«ç ‚">çŒ«ç ‚</option>
                    <option value="ç©å…·">ç©å…·</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
        </div>

        <div class="cat-form-row cols-3" style="grid-template-columns: 0.9fr 0.8fr 0.8fr;">
            <div class="cat-form-item">
                <label class="cat-form-label">è§„æ ¼æ•°å€¼</label>
                <input type="number" id="catAddSpecValue" class="cat-input" placeholder="ä¾‹å¦‚ 500">
            </div>
            <div class="cat-form-item">
                <label class="cat-form-label">è§„æ ¼</label>
                <select id="catAddSpecUnit" class="cat-input">
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="">æ— </option>
                </select>
            </div>
            <div class="cat-form-item">
                <label class="cat-form-label">å•ä½</label>
                <select id="catAddPackageUnit" class="cat-input">
                    <option value="ä¸ª">ä¸ª</option>
                    <option value="åŒ…">åŒ…</option>
                    <option value="ç›’">ç›’</option>
                    <option value="ç½">ç½</option>
                </select>
            </div>
        </div>

        <div class="cat-form-row cols-2">
            <div class="cat-form-item">
                <label class="cat-form-label">è´­ä¹°æ•°é‡</label>
                <input type="number" id="catAddQuantity" class="cat-input" value="1" min="1">
            </div>
            <div class="cat-form-item">
                <label class="cat-form-label">è´­ä¹°å•ä»· (å…ƒ)</label>
                <input type="number" id="catAddValue" class="cat-input" placeholder="0.00">
            </div>
        </div>

        <div class="cat-form-row cols-2">
            <div class="cat-form-item">
                <label class="cat-form-label">ç”Ÿäº§æ—¥æœŸ</label>
                <div class="date-input" onclick="document.getElementById('catAddProdDate').focus(); if(document.getElementById('catAddProdDate').showPicker) document.getElementById('catAddProdDate').showPicker();" style="position:relative; border:1px solid #e5e7eb; border-radius:12px; padding:8px 34px 8px 10px;">
                    <input type="date" id="catAddProdDate" class="cat-input" style="position:absolute; left:10px; right:34px; top:0; bottom:0; width:calc(100% - 44px); height:100%; border:none; background:transparent; -webkit-appearance:none; appearance:none; padding:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa4b2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
            </div>
            <div class="cat-form-item">
                <label class="cat-form-label">ä¿è´¨æœŸè‡³</label>
                <div class="date-input" onclick="document.getElementById('catAddExpiryDate').focus(); if(document.getElementById('catAddExpiryDate').showPicker) document.getElementById('catAddExpiryDate').showPicker();" style="position:relative; border:1px solid #e5e7eb; border-radius:12px; padding:8px 34px 8px 10px;">
                    <input type="date" id="catAddExpiryDate" class="cat-input" style="position:absolute; left:10px; right:34px; top:0; bottom:0; width:calc(100% - 44px); height:100%; border:none; background:transparent; -webkit-appearance:none; appearance:none; padding:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa4b2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
            </div>
        </div>

        <div class="modal-btn-group" style="gap: 12px; display: flex; flex-direction: row;">
            <button class="m-btn m-btn-ghost" onclick="closeCatAddModal()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1;">å–æ¶ˆ</button>
            <button class="m-btn m-btn-primary" onclick="submitCatAdd()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1; box-shadow: 0 8px 18px rgba(74,144,226,0.25);">ç¡®è®¤å…¥åº“</button>
        </div>
    </div>
</div>

<!-- Modal: Cat Item Detail -->
<div id="catDetailModal" class="modal" style="width: 95%; max-width: 360px; padding: 20px; border-radius: 20px;">
    <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 12px; text-align: center; color: #111;">ä¿®æ”¹åº“å­˜</h3>
    <div id="catDetailTitle" style="text-align:center; color:#4b5563; font-size:13px; margin-bottom:8px;"></div>

    <div class="cat-form-row cols-3" style="grid-template-columns: 0.8fr 1.6fr 1fr;">
        <div class="cat-form-item">
            <label class="cat-form-label">å“ç‰Œ</label>
            <input type="text" id="catDetailBrand" class="cat-input">
        </div>
        <div class="cat-form-item">
            <label class="cat-form-label">åç§°</label>
            <input type="text" id="catDetailName" class="cat-input">
        </div>
        <div class="cat-form-item">
            <label class="cat-form-label">åˆ†ç±»</label>
            <select id="catDetailCategory" class="cat-input">
                <option value="ä¸»ç²®">ä¸»ç²®</option>
                <option value="ç½å¤´">ç½å¤´</option>
                <option value="å†»å¹²">å†»å¹²</option>
                <option value="ä¿å¥å“">ä¿å¥å“</option>
                <option value="è¯å“">è¯å“</option>
                <option value="çŒ«ç ‚">çŒ«ç ‚</option>
                <option value="ç©å…·">ç©å…·</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
        </div>
    </div>

    <div class="cat-form-row cols-3" style="grid-template-columns: 0.9fr 0.8fr 0.8fr;">
        <div class="cat-form-item">
            <label class="cat-form-label">è§„æ ¼æ•°å€¼</label>
            <input type="number" id="catDetailSpecValue" class="cat-input" placeholder="ä¾‹å¦‚ 500">
        </div>
        <div class="cat-form-item">
            <label class="cat-form-label">è§„æ ¼</label>
            <select id="catDetailSpecUnit" class="cat-input">
                <option value="kg">kg</option>
                <option value="g">g</option>
                <option value="">æ— </option>
            </select>
        </div>
        <div class="cat-form-item">
            <label class="cat-form-label">å•ä½</label>
            <select id="catDetailPackageUnit" class="cat-input">
                <option value="ä¸ª">ä¸ª</option>
                <option value="åŒ…">åŒ…</option>
                <option value="ç›’">ç›’</option>
                <option value="ç½">ç½</option>
            </select>
        </div>
    </div>

    <div class="cat-form-row cols-2">
        <div class="cat-form-item">
            <label class="cat-form-label">è´­ä¹°æ•°é‡</label>
            <input type="number" id="catDetailQty" class="cat-input" min="1">
        </div>
        <div class="cat-form-item">
            <label class="cat-form-label">è´­ä¹°å•ä»· (å…ƒ)</label>
            <input type="number" id="catDetailValue" class="cat-input">
        </div>
    </div>

    <div class="cat-form-row cols-2">
        <div class="cat-form-item">
            <label class="cat-form-label">ç”Ÿäº§æ—¥æœŸ</label>
                <div class="date-input" onclick="document.getElementById('catDetailProdDate').focus(); if(document.getElementById('catDetailProdDate').showPicker) document.getElementById('catDetailProdDate').showPicker();" style="position:relative; border:1px solid #e5e7eb; border-radius:12px; padding:8px 34px 8px 10px;">
                    <input type="date" id="catDetailProdDate" class="cat-input" style="position:absolute; left:10px; right:34px; top:0; bottom:0; width:calc(100% - 44px); height:100%; border:none; background:transparent; -webkit-appearance:none; appearance:none; padding:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa4b2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
        </div>
        <div class="cat-form-item">
            <label class="cat-form-label">ä¿è´¨æœŸè‡³</label>
                <div class="date-input" onclick="document.getElementById('catDetailExpiry').focus(); if(document.getElementById('catDetailExpiry').showPicker) document.getElementById('catDetailExpiry').showPicker();" style="position:relative; border:1px solid #e5e7eb; border-radius:12px; padding:8px 34px 8px 10px;">
                    <input type="date" id="catDetailExpiry" class="cat-input" style="position:absolute; left:10px; right:34px; top:0; bottom:0; width:calc(100% - 44px); height:100%; border:none; background:transparent; -webkit-appearance:none; appearance:none; padding:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9aa4b2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
        </div>
    </div>

    <div class="modal-btn-group" style="gap: 12px; display: flex; flex-direction: row; margin-top:14px;">
        <button class="m-btn m-btn-ghost" onclick="closeCatDetailModal()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1;">å–æ¶ˆ</button>
        <button class="m-btn m-btn-primary" onclick="saveCatDetail()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1;">ä¿å­˜</button>
    </div>
</div>

<!-- Modal: Confirm Delete -->
<div id="catConfirmModal" class="modal" style="width: 95%; max-width: 340px; padding: 18px; border-radius: 16px;">
    <h3 id="catConfirmTitle" style="font-size: 16px; font-weight: 800; margin-bottom: 8px; text-align: center; color: #111;">ç¡®è®¤æ“ä½œ</h3>
    <div id="catConfirmMsg" style="font-size: 14px; color: #4b5563; text-align:center; margin-bottom: 12px;"></div>
    <div class="modal-btn-group" style="gap: 10px; display: flex; flex-direction: row;">
        <button id="catConfirmCancel" class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 10px; font-size: 14px; border-radius: 10px; flex: 1;">å–æ¶ˆ</button>
        <button id="catConfirmOk" class="m-btn m-btn-primary" onclick="runCatConfirmOk()" style="padding: 10px; font-size: 14px; border-radius: 10px; flex: 1;">ç¡®è®¤</button>
    </div>
</div>

<!-- Floating Switch Bar -->
<div id="catFloatingBar" style="
    position: fixed; left: 50%; transform: translateX(-50%);
    width: min(600px, calc(100% - 32px));
    bottom: 24px; z-index: 9999; display:none;
    background: rgba(255,255,255,0.9); border: 1px solid #eee; 
    border-radius: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    padding: 8px 12px; display:flex; align-items:center; gap:10px; justify-content: space-between;">
    <div id="cat-float-inventory-item" onclick="switchCatTab('inventory')" style="display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px 12px; min-width:96px; border-radius:16px; cursor:pointer; background:#e6f7ff; color:#1890ff; border:1px solid #91d5ff;">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#1890ff" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        <span style="font-size:11px;">å½“å‰åº“å­˜</span>
    </div>
    <div id="cat-float-logs-item" onclick="switchCatTab('logs')" style="display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px 12px; min-width:96px; border-radius:16px; cursor:pointer; background:#f5f5f5; color:#666; border:1px solid #ddd;">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#666" stroke-width="2"><path d="M4 4h16v4H4z"/><path d="M4 10h16v4H4z"/><path d="M4 16h16v4H4z"/></svg>
        <span style="font-size:11px;">å‡ºå…¥åº“è®°å½•</span>
    </div>
    <button onclick="openCatAddModal()" style="display:flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:18px; background:#4a90e2; color:#fff; border:none; box-shadow:0 6px 16px rgba(74,144,226,0.25);">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#fff" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
</div>

<style>
    .cat-tab-btn.active {
        color: #4a90e2 !important;
        border-bottom-color: #4a90e2 !important;
    }
    #catAddModal {
        background: #fff;
        box-shadow: 0 12px 32px rgba(0,0,0,0.12);
        border-radius: 20px;
    }
    .cat-form-row { display: grid; gap: 12px; }
    .cat-form-row.cols-3 { grid-template-columns: 1fr 1.4fr 1fr; }
    .cat-form-row.cols-2 { grid-template-columns: 1fr 1fr; }
    .cat-form-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
    }
    .cat-form-label {
        font-size: 12px;
        color: #4b5563;
    }
    .cat-input {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px 12px;
        background: #f9fafb;
        font-size: 14px;
        color: #111827;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .cat-input:focus {
        border-color: #93c5fd;
        box-shadow: 0 0 0 3px rgba(147,197,253,0.35);
        background: #ffffff;
    }
    .cat-input[type="date"] {
        -webkit-appearance: none;
        appearance: none;
        background-color: #fff;
        padding: 10px 40px 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>');
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px 18px;
    }
    .cat-input[type="date"]::-webkit-calendar-picker-indicator {
        opacity: 0;
        cursor: pointer;
    }
    .date-input {
        position: relative;
        display: flex;
        align-items: center;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0 36px 0 12px;
        background: #f9fafb;
        height: 42px;
    }
    .date-input:focus-within {
        border-color: #93c5fd;
        box-shadow: 0 0 0 3px rgba(147,197,253,0.35);
        background: #ffffff;
    }
    .date-input .cat-input:disabled {
        background: transparent;
    }
    .cat-input:disabled {
        background: #f3f4f6;
        color: #9ca3af;
        border-color: #e5e7eb;
        cursor: not-allowed;
        opacity: 0.9;
    }
    @media (max-width: 480px) {
        .cat-form-row.cols-3 { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 360px) {
        .cat-form-row.cols-3, .cat-form-row.cols-2 { grid-template-columns: 1fr; }
    }
    .cat-floating-btn.active {
        background:#4a90e2 !important;
        color:#fff !important;
        border:none !important;
        box-shadow:0 6px 16px rgba(74,144,226,0.25);
    }
</style>

<script src="js/ai.js"></script>
<script src="js/ui.js"></script>
<script src="js/data.js"></script>
<script src="js/main.js"></script>
<script src="js/stats.js"></script>
<script src="js/fabric.js"></script>
<script src="js/scan.js"></script>
<script src="js/plans.js"></script>
<script src="js/cat.js"></script>
<script src="js/tool_color.js"></script>
<script src="js/tool_shopping.js"></script>
<script src="js/tool_tags.js"></script>
</body>
</html>
