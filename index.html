<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MARD 豆库 Pro</title>
    <style>
        :root {
            --primary: #1c1c1e; --accent: #007aff; --danger: #ff3b30;
            --bg: #f2f2f7; --card: #ffffff; --radius: 14px;
        }

        body {
            font-family: -apple-system, "SF Pro Text", sans-serif;
            background-color: var(--bg); margin: 0; padding-bottom: 50px; color: var(--primary);
        }

        /* 顶部导航 */
        .header {
            position: sticky; top: 0; background: rgba(255,255,255,0.8);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px; border-bottom: 0.5px solid #d1d1d6;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .header h1 { margin: 0; font-size: 20px; font-weight: 700; }
        .header p { margin: 2px 0 0; font-size: 12px; color: #8e8e93; }

        /* 列表布局：一号一行 */
        .list-container { padding: 12px; }
        .bead-row {
            background: var(--card); border-radius: var(--radius);
            margin-bottom: 8px; padding: 12px 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .bead-row.low-stock { border-left: 4px solid var(--danger); }
        
        .bead-id { font-family: ui-monospace, monospace; font-weight: 700; font-size: 18px; width: 60px; }
        
        .bead-info { flex: 1; margin: 0 15px; }
        .progress-bg { width: 100%; height: 6px; background: #efeff4; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
        .progress-fill.low { background: var(--danger); }

        .weight-display { 
            text-align: right; min-width: 70px;
            padding: 6px 10px; background: #f8f8fa; border-radius: 8px;
            font-weight: 600; font-size: 15px; cursor: pointer;
        }
        .weight-display.low { color: var(--danger); background: #fff1f0; }

        /* 底部抽屉弹窗样式 (优化重点) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 1000; align-items: flex-end;
        }
        .drawer {
            background: white; width: 100%; border-radius: 20px 20px 0 0;
            padding: 25px 20px 40px; transform: translateY(100%);
            transition: transform 0.3s ease-out; box-sizing: border-box;
        }
        .modal-overlay.show { display: flex; }
        .modal-overlay.show .drawer { transform: translateY(0); }

        .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .drawer-header h2 { margin: 0; font-size: 22px; }
        
        .edit-input-group {
            display: flex; align-items: center; background: #f2f2f7;
            border-radius: 15px; padding: 15px; margin-bottom: 25px;
        }
        .edit-input-group input {
            flex: 1; background: none; border: none; font-size: 32px;
            font-weight: 700; text-align: center; outline: none; color: var(--accent);
        }
        .edit-input-group span { font-weight: 600; color: #8e8e93; font-size: 18px; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button {
            padding: 16px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: #e5e5ea; color: #1d1d1f; }

        /* 设置按钮样式 */
        .btn-icon { background: #e5e5ea; padding: 8px 12px; font-size: 13px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-title">
        <h1>MARD 豆库 Pro</h1>
        <p id="infoText">数据加载中...</p>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="btn-icon" onclick="openModal('importModal')">导入</button>
        <button class="btn-icon" onclick="openConfig()">备份</button>
    </div>
</div>

<div class="list-container" id="mainList"></div>

<div id="editModal" class="modal-overlay" onclick="closeEdit(event)">
    <div class="drawer" onclick="event.stopPropagation()">
        <div class="drawer-header">
            <h2 id="editTitle">修改 A1</h2>
            <div id="editColor" style="width:24px; height:24px; border-radius:50%; border:1px solid #eee;"></div>
        </div>
        <div class="edit-input-group">
            <input type="number" id="editValue" step="0.1" autofocus>
            <span>GRAMS</span>
        </div>
        <div class="btn-grid">
            <button class="btn-cancel" onclick="closeEdit()">取消</button>
            <button class="btn-save" onclick="saveEdit()">确认修改</button>
        </div>
    </div>
</div>

<script>
    const INITIAL_DATA = {"A1":36.1,"A2":26.8,"A3":18.7,"A4":57.6,"A5":23.6,"A6":15.8,"A7":9.9,"A8":18.9,"A9":15.8,"A10":20.1,"A11":25.9,"A12":18.7,"A13":20.6,"A14":27.1,"A15":19.9,"A16":25.1,"A17":61,"A18":17,"A19":16.4,"A20":12.6,"A21":16,"A22":22.6,"A23":17.9,"A24":16.9,"A25":17,"A26":17.6,"B1":12,"B2":8.2,"B3":16,"B4":10.5,"B5":36,"B6":12.4,"B7":16.4,"B8":16.8,"B9":8.9,"B10":15,"B11":16.7,"B12":21.3,"B13":12,"B14":26.2,"B15":13,"B16":7.4,"B17":7,"B18":15.5,"B19":15.8,"B20":9.5,"B21":10.8,"B22":18.8,"B23":9.6,"B24":10.7,"B25":9.5,"B26":9,"B27":16.9,"B28":10.2,"B29":9.9,"B30":9.6,"B31":9.4,"B32":18.4,"C1":10,"C2":9.3,"C3":18,"C4":15.8,"C5":12.8,"C6":40,"C7":21.9,"C8":11,"C9":10.4,"C10":12.7,"C11":15.2,"C12":17.5,"C13":9.2,"C14":16.5,"C15":10,"C16":10.5,"C17":18.7,"C18":9.8,"C19":8.6,"C20":20.8,"C21":18.6,"C22":8.1,"C23":8.8,"C24":9.7,"C25":8.3,"C26":7.3,"C27":10.4,"C28":8.8,"C29":10,"D1":8.6,"D2":16.1,"D3":15.5,"D4":10.3,"D5":8.9,"D6":17.8,"D7":15.4,"D8":13.6,"D9":14.2,"D10":16.7,"D11":8,"D12":12.9,"D13":15.7,"D14":15.8,"D15":14.8,"D16":13.7,"D17":8.8,"D18":14.8,"D19":15.4,"D20":15.2,"D21":16.1,"D22":10.7,"D23":17.7,"D24":9.6,"D25":10.8,"D26":10.3,"E1":29.2,"E2":26.6,"E3":29,"E4":25,"E5":24.4,"E6":19.8,"E7":25.9,"E8":17.4,"E9":17.4,"E10":18.7,"E11":0,"E12":36.6,"E13":25.4,"E14":21.1,"E15":22.5,"E16":77,"E17":26.2,"E18":26.8,"E19":19.4,"E20":19.8,"E21":19.5,"E22":20.2,"E23":17.1,"E24":20,"F1":20.2,"F2":11,"F3":16.1,"F4":21.7,"F5":65.5,"F6":22.6,"F7":31.6,"F8":9.2,"F9":26.4,"F10":15.6,"F11":18.1,"F12":29.5,"F13":50.7,"F14":18.1,"F15":12.9,"F16":17.2,"F17":25.9,"F18":16.1,"F19":18.5,"F20":17.4,"F21":17.8,"F22":24.9,"F23":19.4,"F24":28.3,"F25":25.5,"G1":25.7,"G2":21.5,"G3":15.9,"G4":21.2,"G5":22.4,"G6":18.8,"G7":11.2,"G8":31.1,"G9":22,"G10":20.3,"G11":15.1,"G12":40.3,"G13":18,"G14":21.6,"G15":24.9,"G16":25.9,"G17":15.2,"G18":21.6,"G19":34.7,"G20":15.6,"G21":16.6,"H1":0,"H2":0,"H3":38.2,"H4":25.8,"H5":27.7,"H6":28,"H7":0,"H8":20.1,"H9":10.2,"H10":8.2,"H11":16,"H12":17.7,"H13":17.8,"H14":8.1,"H15":18.2,"H16":12.5,"H17":28.3,"H18":11.9,"H19":9.2,"H20":9,"H21":36.7,"H22":17.5,"H23":10.7,"M1":15.8,"M2":10,"M3":10.9,"M4":18.3,"M5":10.4,"M6":10.9,"M7":15.5,"M8":15.1,"M9":17.7,"M10":30.1,"M11":9.2,"M12":15.7,"M13":27.8,"M14":25.2,"M15":19};

    let inventory = JSON.parse(localStorage.getItem('mard_pro_data')) || INITIAL_DATA;
    let threshold = parseFloat(localStorage.getItem('mard_pro_ts')) || 5;
    let currentEditId = null;

    function render() {
        const list = document.getElementById('mainList');
        list.innerHTML = '';
        const keys = Object.keys(inventory).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
        
        keys.forEach(id => {
            const val = inventory[id];
            const isLow = val <= threshold;
            const progress = Math.min(100, (val / 50) * 100); // 假设50g为满条

            const row = document.createElement('div');
            row.className = `bead-row ${isLow ? 'low-stock' : ''}`;
            row.innerHTML = `
                <div class="bead-id">${id}</div>
                <div class="bead-info">
                    <div class="progress-bg">
                        <div class="progress-fill ${isLow ? 'low' : ''}" style="width: ${progress}%"></div>
                    </div>
                </div>
                <div class="weight-display ${isLow ? 'low' : ''}" onclick="openEdit('${id}')">
                    ${val}<small>g</small>
                </div>
            `;
            list.appendChild(row);
        });
        document.getElementById('infoText').innerText = `预警: ${threshold}g | 色号总数: ${keys.length}`;
    }

    // 弹窗逻辑优化
    function openEdit(id) {
        currentEditId = id;
        document.getElementById('editTitle').innerText = `修改库存: ${id}`;
        document.getElementById('editValue').value = inventory[id];
        const modal = document.getElementById('editModal');
        modal.classList.add('show');
        setTimeout(() => document.getElementById('editValue').focus(), 100);
    }

    function closeEdit(e) {
        document.getElementById('editModal').classList.remove('show');
    }

    function saveEdit() {
        const newVal = parseFloat(document.getElementById('editValue').value) || 0;
        inventory[currentEditId] = newVal;
        localStorage.setItem('mard_pro_data', JSON.stringify(inventory));
        render();
        closeEdit();
    }

    // 初始化
    render();
</script>
</body>
</html>
