<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <title>MARD Ë±ÜÂ∫ì -ÊãºË±ÜÂ∫ìÂ≠òÁÆ°ÁêÜÂ∑•ÂÖ∑</title>
    <style>
        :root { --primary: #4a90e2; --warn: #ff4d4f; --bg: #f5f7fa; --success: #52c41a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; font-size: 14px; color: #333; overscroll-behavior-y: contain; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; padding-bottom: 90px; }
        


        /* Pull to Refresh Indicator */
    #ptr-indicator {
        position: fixed;
        top: -50px;
        left: 0;
        width: 100%;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888;
        font-size: 14px;
        z-index: 10000;
        transition: transform 0.2s;
        pointer-events: none;
    }
    #ptr-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #888;
        border-top-color: transparent;
        border-radius: 50%;
        margin-right: 10px;
        display: none;
        animation: ptr-spin 0.8s linear infinite;
    }
    #ptr-icon {
        font-size: 20px;
        margin-right: 8px;
        transition: transform 0.3s;
    }
    @keyframes ptr-spin {
        to { transform: rotate(360deg); }
    }
    /* Â§¥ÈÉ®ÊéßÂà∂Âå∫ */
        .header-sticky { position: sticky; top: 0; background: white; z-index: 100; border-bottom: 2px solid #eee; padding: 12px 15px; }
        .stats { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; 
            background: #f8f9fa; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box;
            /* justify-items: center; text-align: center;  <-- Remove this to allow individual alignment */
        }
        .stats > div { display: flex; flex-direction: column; align-items: flex-start; width: 100%; }
        /* ËÆ©Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàËâ≤Âè∑ÔºâÂ∑¶ÂØπÈΩêÔºåÂéªÈô§‰∫ÜÂ∑¶Èó¥Ë∑ù */
        .stats > div:first-child { padding-left: 0; box-sizing: border-box; }
        /* ËÆ©ÊúÄÂêé‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàËÆæÁΩÆÔºâ‰πüÂ∑¶ÂØπÈΩêÔºå‰øùÁïôÂè≥Èó¥Ë∑ù */
        .stats > div:last-child { padding-right: 8px; box-sizing: border-box; }
        .stat-item b { display: block; font-size: 16px; color: var(--primary); }

        /* ÈÖçÁΩÆ‰∏éÊéíÂ∫èÂå∫ */
        .config-zone { font-size: 12px; background: #fffbe6; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .config-zone input { width: 40px; padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        .btn-sort { background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-sort.active { background: var(--primary); color: white; }

        .btn-text { font-size: 12px; color: var(--primary); cursor: pointer; background:none; border:none; padding:0; text-decoration: underline; }

        /* ÊêúÁ¥¢Ê°Ü */
        #search { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; margin-bottom: 5px; height: 42px; }
        
        /* ÂàóË°®Ê∏≤Êüì */
        .bead-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        .bead-row.selected { background: #e6f7ff; }
        .col-select { width: 25px; }
        .col-color { width: 40px; }
        .swatch { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; }
        .col-id { width: 60px; font-weight: bold; font-family: monospace; font-size: 15px; }
        .col-weight { flex: 1; }
        .weight-badge { padding: 4px 8px; border-radius: 6px; background: #eee; font-weight: bold; font-family: monospace; cursor: pointer; }
        .weight-badge.low { background: var(--warn); color: white; }
        .col-action { width: 60px; text-align: right; }
        .btn-plus { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; padding: 5px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; }
        .btn-detail { background: #fff; border: 1px solid #d9d9d9; color: #666; padding: 5px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; margin-left: 5px; transition: all 0.2s; }
        .btn-detail:hover { color: var(--primary); border-color: var(--primary); }

        .info-tag { font-size: 10px; color: #999; display: block; margin-top: 3px; }
        .total-use { color: #8c8c8c; font-weight: bold; }

        /* Â∫ïÈÉ®Êìç‰ΩúÊ†è - ÊÇ¨ÊµÆÂç°ÁâáÂºèËÆæËÆ° */
        .footer-bar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: calc(100% - 32px); max-width: 568px; 
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            color: #333; padding: 16px; 
            display: flex; flex-direction: column; gap: 16px; 
            box-sizing: border-box; z-index: 200; 
            border-radius: 32px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .footer-top { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 4px; }
        .footer-info { font-size: 16px; display: flex; align-items: center; gap: 12px; font-weight: 600; color: #1f2937; }
        
        .footer-btn-cancel {
            background: #f3f4f6; border: none; color: #6b7280;
            padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: background 0.2s; font-weight: 500;
        }
        .footer-btn-cancel:hover { background: #e5e7eb; color: #374151; }

        .footer-actions { display: flex; gap: 12px; width: 100%; }

        .footer-btn-tool {
            flex: 1;
            background: #f9fafb; border: 1px solid #e5e7eb;
            color: #374151; padding: 12px; border-radius: 16px;
            font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s; font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .footer-btn-tool:active { transform: scale(0.98); background: #eff6ff; border-color: #bfdbfe; color: #2563eb; }

        .btn-go { 
            background: linear-gradient(135deg, #52c41a, #389e0d); color: white; border: none; 
            padding: 8px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(82, 196, 26, 0.3); transition: transform 0.1s; font-size: 14px;
        }
        .btn-go:active { transform: scale(0.96); }

        /* ÂºπÁ™óÊ†∑ÂºèÂçáÁ∫ß */
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index:1000; transition: opacity 0.3s; }
        .modal { 
            display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
            background:white; padding:24px; border-radius:24px; 
            width: 85%; max-width: 360px; max-height: 80vh; overflow-y: auto; 
            z-index:1010; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop {
            0% { transform: translate(-50%, -40%) scale(0.95); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .close-btn { font-size:24px; color:#999; cursor:pointer; line-height:1; }
        .modal-footer { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
        .btn { padding:10px 20px; border-radius:8px; border:none; cursor:pointer; font-size:14px; font-weight:600; }
        .btn-secondary { background:#f0f0f0; color:#333; }
        .btn-primary { background:var(--primary); color:white; }

        /* ‰øÆÂ§çË£ÅÂâ™ÂíåÈ¢ÑËßàÁ™óÂè£ÁöÑÂä®ÁîªÈóÆÈ¢òÔºöÊîπ‰∏∫Ê∑°ÂÖ•ÊïàÊûúÔºåÈÅøÂÖç‰ªéÂ∑¶‰∏äËßíÂºπÂá∫ÁöÑÁ™ÅÂÖÄÊÑü */
        #cropEditModal, #cropPreviewModal {
            animation: fullScreenFadeIn 0.25s ease-out !important;
        }
        @keyframes fullScreenFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal h3 { margin: 0 0 8px 0; text-align: center; font-size: 18px; color: #1f2937; }
        .modal-desc { text-align: center; color: #6b7280; font-size: 13px; margin-bottom: 24px; }
        
        .input-group { position: relative; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; }
        .input-group input {
            width: 100%; padding: 16px; 
            border: 2px solid transparent; 
            background: #f3f4f6;
            border-radius: 16px; 
            font-size: 28px; text-align: center; font-weight: 700; color: #111827; 
            outline: none; transition: all 0.2s;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }
        .input-group input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1); }
        .input-suffix { position: absolute; right: 20px; color: #9ca3af; font-weight: 600; font-size: 16px; pointer-events: none; }

        .modal-btn-group { display: flex; flex-direction: column; gap: 12px; }
        .m-btn { 
            width: 100%; padding: 14px; border: none; border-radius: 14px; 
            font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.1s;
        }
        .m-btn:active { transform: scale(0.98); }
        .m-btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(74, 144, 226, 0.3); }
        .m-btn-ghost { background: #f3f4f6; color: #4b5563; }
        
        .modal-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f3f4f6; }
        .modal-row:last-child { border-bottom: none; }
        .modal-input { width: 70px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; background: #f9fafb; font-weight: 600; }
        

        /* ËÆ°ÂàíÈÄâÊã©Ê®°ÂºèÊ†∑Âºè */
        .plan-checkbox {
            position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px;
            border: 2px solid #ddd; border-radius: 50%;
            background: white;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }
        .plan-checkbox.checked {
            background: var(--primary); border-color: var(--primary);
        }
        .plan-checkbox.checked::after {
            content: '‚úì'; color: white; font-size: 14px; font-weight: bold;
        }

        .selection-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: calc(100% - 32px); max-width: 568px;
            background: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 200;
            animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }
        @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* ÁßªÂä®Á´ØÈÄÇÈÖç‰ºòÂåñ */
        @media (max-width: 480px) {
            .container { padding-bottom: 80px; }
            .bead-row { padding: 8px 5px; }
            
            .col-select { width: 18px; }
            .col-color { width: 26px; padding-left: 6px; box-sizing: content-box; }
            .swatch { width: 20px; height: 20px; }
            .col-id { width: 38px; font-size: 12px; }
            .col-action { width: 42px; }
            
            .weight-badge { font-size: 12px; padding: 2px 6px; }
            .btn-plus { padding: 4px 4px; font-size: 10px; }
            /* ÊÅ¢Â§çÂ∑¶ÂØπÈΩêÁº©ÊîæÔºåÂπ∂Áªô‰∏Ä‰∏™Âõ∫ÂÆöÁöÑÂ∑¶ËæπË∑ùÔºåÈ¢ÑÁïôÂá∫Â§ßÊ¶Ç1000gÊï∞Â≠óÁöÑÁ©∫Èó¥ */
            .btn-detail { padding: 0 4px; height: 18px; line-height: 16px; font-size: 12px; border-radius: 4px; margin-left: 2px; transform: scale(0.85); transform-origin: left center; white-space: nowrap; }
            
            /* Âú®Â∞èÂ±èÂπï‰∏äÂáèÂ∞èÈó¥Ë∑ù */
            .weight-primary-row { gap: 6px !important; }
            .weight-detail-row { gap: 4px !important; }
            .grain-info { display: none !important; } /* ÊûÅÂ∞èÂ±èÂπïÈöêËóèÁ≤íÊï∞‰º∞ÁÆóÔºåÊàñÁº©Â∞è */
            
            /* Â§¥ÈÉ®ÁßªÂä®Á´ØÈÄÇÈÖç */
            .header-sticky { padding: 8px 10px; }
            /* Ë∞ÉÊï¥ÂàóÂÆΩÊØî‰æãÔºåÁªôÁ¨¨‰∏ÄÂàóÔºàËâ≤Âè∑ÔºâÊõ¥Â§öÁ©∫Èó¥ */
            .stats { padding: 8px; gap: 5px !important; margin-right: 5px; grid-template-columns: 1.3fr 0.9fr 0.9fr !important; }
            .top-bar { margin-bottom: 5px; flex-wrap: wrap; row-gap: 8px; }
            .btn-text { font-size: 11px; }
            /* Ë∞ÉÊï¥‰∏ãÊãâÊ°ÜÂú®ÁßªÂä®Á´ØÁöÑÂ§ßÂ∞è */
            #seriesFilter { font-size: 13px !important; max-width: 100% !important; }
            
            /* ÂØºËà™Ê†èÁßªÂä®Á´ØÈÄÇÈÖç */
            .nav-bar { overflow: visible !important; padding: 6px 4px !important; justify-content: flex-end !important; gap: 10px !important; }
            .nav-btn { padding: 4px 8px !important; font-size: 12px !important; white-space: nowrap; flex-shrink: 0; }
        }
        
        /* ÂØºËà™Ê†èÊ†∑Âºè */
        .nav-bar { 
            display: flex; justify-content: flex-end; gap: 10px; align-items: center; 
            padding: 6px 10px; 
            margin-top: 5px;
            margin-bottom: 8px;
            background: #f8f9fa; 
            border-radius: 8px; 
        }

        /* Á≥ªÂàóÁ≠õÈÄâÊ†∑Âºè */
        .series-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
            padding: 0 2px;
        }
        .series-chip {
            padding: 4px 10px;
            border-radius: 12px;
            background: #f5f5f5;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
            font-weight: 500;
            transition: all 0.2s;
        }
        .series-chip:active {
            transform: scale(0.95);
        }
        .series-chip.selected {
            background: #e6f7ff;
            color: #1890ff;
            border-color: #91d5ff;
            font-weight: bold;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 140px;
            z-index: 1000;
            border: 1px solid #eee;
        }
        .dropdown-item {
            padding: 10px 16px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .dropdown-item:hover {
            background: #f5f7fa;
            color: var(--primary);
        }

        .nav-btn {
            display: flex; align-items: center; gap: 4px;
            background: transparent; border: 1px solid transparent; 
            cursor: pointer; padding: 4px 8px; border-radius: 15px;
            font-size: 12px; color: #666; transition: all 0.2s;
            white-space: nowrap; /* Á°Æ‰øùÊñáÂ≠ó‰∏çÊç¢Ë°å */
        }
        .nav-btn:hover { background: #f0f7ff; border-color: #d6e4ff; color: #4a90e2; }

        /* Áªü‰∏ÄËøîÂõûÊåâÈíÆÊ†∑Âºè */
        .btn-back {
            border: none;
            background: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: #555;
            flex-shrink: 0;
            padding: 0;
        }
        .btn-back:hover {
            background: #f8f9fa;
            transform: translateX(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            color: #333;
        }
        .btn-back:active {
            transform: scale(0.95);
        }

        /* ‰∏≠Á≠âÂ±èÂπïÊòæÁ§∫Á≤íÊï∞ */
        @media (min-width: 360px) and (max-width: 480px) {
            .grain-info { display: inline !important; font-size: 9px !important; }
        }

        /* Â∫ïÈÉ®ÂØºËà™Ê†è Bottom Dock */
        .bottom-dock {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
            z-index: 190;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            flex: 1;
            color: #999;
            transition: all 0.2s;
        }
        
        .dock-item.active {
            color: var(--primary);
        }
        
        .dock-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.2s;
            margin-bottom: 2px;
        }
        .dock-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }
        .dock-item:active .dock-icon {
            transform: scale(0.9);
        }
        .dock-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* Â∫ïÈÉ®ËèúÂçï Bottom Sheet */
        .bottom-sheet {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .bottom-sheet.show {
            display: block;
            opacity: 1;
        }
        .sheet-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            box-sizing: border-box;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-sheet.show .sheet-content {
            transform: translateY(0);
        }
        .sheet-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; font-weight: bold; font-size: 16px; color: #333;
        }
        .close-sheet {
            font-size: 24px; color: #999; cursor: pointer; padding: 5px;
        }
        .sheet-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
        }
        .sheet-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .sheet-icon-box {
            width: 48px; height: 48px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            transition: transform 0.1s;
        }
        .sheet-item:active .sheet-icon-box {
            transform: scale(0.95);
        }
        .sheet-item span { font-size: 12px; color: #666; }

        /* Card Layout */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
            gap: 12px;
            padding: 10px;
        }

        .bead-card {
            background: white;
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            transition: all 0.2s;
            overflow: hidden;
        }

        .bead-card.selected {
            border-color: var(--primary);
            background: #f0f7ff;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-swatch {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .card-check {
            width: 20px; height: 20px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: none; /* Default hidden */
            align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        
        /* Show check in selection mode or when selected - DISABLED per user request */
        .grid-container.selection-mode .card-check,
        .bead-card.selected .card-check {
            display: none;
        }
        
        .bead-card.selected .card-check {
            background: var(--primary);
            border-color: var(--primary);
        }
        .bead-card.selected .card-check::after {
            content: '‚úì'; color: white; font-size: 12px; font-weight: bold;
        }

        .card-id {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            font-family: monospace;
            letter-spacing: 0.5px;
        }

        /* New Color Block Style */
        .card-color-block {
            width: 100%;
            height: 50px;
            border-radius: 4px;
            margin: 3px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .card-body {
            /* Legacy support or cleanup */
            display: none; 
        }

        .card-weight {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            line-height: 1.2;
        }

        .card-unit {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 500;
        }
        
        .weight-badge.low { color: #ff4d4f; }

        .card-grain {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
        }

        .card-stats {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 10px;
            color: #9ca3af;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-card-action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .btn-add {
            background: #e6f7ff;
            color: #0099ff;
        }
        .btn-add:active { background: #bae7ff; transform: scale(0.95); }

        .btn-info {
            background: #f3f4f6;
            color: #6b7280;
        }
        .btn-info:active { background: #e5e7eb; transform: scale(0.95); }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                padding: 10px 6px;
            }
            
            .bead-card {
                padding: 6px;
                border-radius: 8px;
            }
            
            .card-weight { font-size: 15px; margin-bottom: 0; }
            .card-swatch { width: 20px; height: 20px; border-radius: 6px; }
            .card-id { font-size: 12px; }
            .card-body { padding: 4px 0; }
            .btn-card-action { width: 22px; height: 22px; font-size: 12px; border-radius: 6px; }
            .card-grain { font-size: 9px; margin-top: 1px; }
            
            /* Compact Footer */
            .card-footer {
                flex-direction: column;
                gap: 4px;
                padding-top: 4px;
            }
            
            .card-stats {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                font-size: 9px;
                background: #f5f5f5;
                padding: 2px 4px;
                border-radius: 4px;
                box-sizing: border-box;
            }
            
            .card-actions {
                width: 100%;
                justify-content: space-between;
                gap: 4px;
            }
            
            .card-actions button {
                flex: 1;
                height: 24px;
            }
        }

        /* Stats Page New Styles */
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .stats-title {
            font-size: 20px;
            font-weight: 800;
            color: #1a1a1a;
            margin: 20px 0 20px 0;
        }
        .stats-dropdown {
            background: #f0f2f5;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            color: #666;
            outline: none;
            font-weight: 500;
        }

        .stats-tabs {
            display: flex;
            background: #e9ecef;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        .stats-tab {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-size: 14px;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .stats-tab.active {
            background: white;
            color: #333;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stats-summary-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.03);
        }

        /* Plan Time Filter Styles */
        .plan-filter-ui {
            margin-bottom: 20px;
        }
        .plan-segmented-control {
            display: flex;
            background: #bae7ff; /* Light Blue as user requested */
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .plan-segment-btn {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-size: 14px;
            color: #fff; /* White text on green */
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            user-select: none;
        }
        .plan-segment-btn.active {
            background: white;
            color: #333;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .plan-date-navigator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            height: 30px;
            background: #bae7ff;
            border-radius: 20px;
            width: fit-content;
            margin: 0 auto;
            padding: 0 15px;
        }
        .plan-nav-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }
        .stats-summary-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .stats-card-horizontal {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
        .donut-chart-wrapper {
            width: 90px;
            height: 90px;
            position: relative;
            margin: 0;
            flex-shrink: 0;
        }
        .donut-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 0%, #f0f0f0 0% 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 0;
        }
        .donut-chart::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 74px;
            height: 74px;
            background: white;
            border-radius: 50%;
            z-index: 5;
        }
        .donut-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-align: center;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .donut-percent {
            font-size: 20px;
            font-weight: 800;
            color: #333;
            line-height: 1.1;
        }
        .donut-text {
            font-size: 10px;
            color: #999;
        }

        .stats-metrics {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        .metric-item {
            text-align: center;
        }
        .metric-val {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .metric-label {
            font-size: 12px;
            color: #999;
        }

        .stats-filter-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .switch-label {
            font-size: 15px;
            font-weight: 500;
            color: #333;
        }
        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e0e0e0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input:checked + .slider { background-color: #4a90e2; }
        input:checked + .slider:before { transform: translateX(20px); }

        .stats-rank-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 20px;
        }
        .rank-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 12px 15px;
            border-radius: 12px;
        }
        .rank-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .rank-badge.top-1 { background: #ffc107; }
        .rank-badge.top-2 { background: #9e9e9e; }
        .rank-badge.top-3 { background: #cd7f32; }

        .rank-swatch {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            margin-right: 12px;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .rank-content {
            flex: 1;
        }
        .rank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .rank-id {
            font-weight: bold;
            font-size: 15px;
            color: #333;
        }
        .rank-details {
            font-size: 11px;
            color: #999;
        }
        .rank-details span.used { color: #999; }
        .rank-details span.rem { color: #52c41a; margin-left: 4px; }
        .rank-details span.rem.zero { color: #ff4d4f; }

        .rank-progress-bg {
            height: 4px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        .rank-progress-fill {
            height: 100%;
            background: #fa8c16;
            border-radius: 2px;
        }
/* Plan Chart Styles */
        #stats-plan-chart {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
            overflow-x: auto;
            display: flex;
            flex-direction: column;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px; /* Moved to bottom */
            font-size: 11px;
            color: #666;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.5;
            filter: grayscale(100%);
        }
        .legend-item.active {
            border-color: #1890ff; /* Blue border */
            background: rgba(24, 144, 255, 0.05);
            opacity: 1;
            filter: none;
        }
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }
        .chart-container {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            height: 140px;
            padding-bottom: 5px;
            min-width: 100%;
            padding-right: 10px;
            box-sizing: border-box;
        }
        .chart-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 65px;
        }
        .chart-bars-group {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
            height: 120px;
            width: 100%;
            position: relative;
        }
        .chart-bar {
            width: 8px;
            border-radius: 2px 2px 0 0;
            transition: height 0.3s;
            min-height: 2px;
            position: relative;
        }
        /* Tooltip-ish on hover (optional) */
        .chart-bar:hover::after,
        .chart-bar.active::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 20;
            pointer-events: none; /* Prevent tooltip from capturing clicks */
            margin-top: 4px;
        }
        .chart-label {
            margin-top: 8px;
            font-size: 10px;
            color: #999;
            text-align: center;
            white-space: nowrap;
        }

    </style>
    <script>
        // Pre-check default page to avoid flashing
        try {
            var defaultBeads = localStorage.getItem('default_page_beads');
            if (defaultBeads === 'true') {
                document.write('<style id="init-style">#page-home { display: none !important; } #page-beads { display: block !important; }</style>');
            }
        } catch(e) {}
    </script>

</head>
<body>

    <div id="ptr-indicator">
        <span id="ptr-icon">‚¨áÔ∏è</span>
        <div id="ptr-spinner"></div>
        <span id="ptr-text">‰∏ãÊãâÂà∑Êñ∞...</span>
    </div>

<div id="page-home" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:var(--bg);">
    <h1 style="color:#333; margin-bottom:40px; font-size:24px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">MardÊãºË±ÜÂ∑•ÂÖ∑ÁÆ±</h1>
    <div style="display:flex; flex-direction:column; gap:20px; width:80%; max-width:300px;">
        <button onclick="navTo('beads')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#4a90e2; box-shadow:0 10px 20px rgba(74, 144, 226, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">üé®</span> ÊãºË±ÜÂ∫ìÂ≠òÁÆ°ÁêÜ
        </button>
        <button onclick="navTo('fabric')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#eb2f96; box-shadow:0 10px 20px rgba(235, 47, 150, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">‚úÇÔ∏è</span> ÁÉòÁÑôÂ∏ÉË£ÅÂâ™
        </button>
        <div style="margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <input type="checkbox" id="defaultBeadsToggle" onchange="toggleDefaultPage()" style="transform: scale(1.2); cursor: pointer;">
            <label for="defaultBeadsToggle" style="color: #666; font-size: 14px; cursor: pointer;">‰∏ãÊ¨°ÈªòËÆ§ËøõÂÖ•ÊãºË±ÜÂ∫ìÂ≠ò</label>
        </div>

    </div>
    <div onclick="showDevInfo()" style="margin-top: 40px; color: #666; font-size: 12px; cursor: pointer; text-decoration: underline;">ÂºÄÂèëËÄÖ‰ø°ÊÅØ</div>
</div>

<div id="page-beads" style="display:none; padding-bottom: 80px;">
    <div class="container">
        <h3 style="font-size: 20px; font-weight: bold; margin: 0 0 20px 0; padding-top: 40px; text-align: center; color: #333;">Â∫ìÂ≠ò</h3>
        <div class="header-sticky">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px; margin-top: 6px;">
            <input type="text" id="search" placeholder="ËæìÂÖ•Ëâ≤Âè∑ÊêúÁ¥¢..." oninput="render()" style="flex:1; margin-bottom:0;">
            <button id="btn-toggle-filter" onclick="toggleFilterVisibility()" style="
                border: 1px solid #ddd;
                background: #fff;
                color: #666;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 42px; /* Match input height roughly */
            ">
                üé®
            </button>

        </div>
        
        <div id="series-filter-container" class="series-filter-container" style="display:none;">
            <div class="series-chip" onclick="toggleSeries('A')">A</div>
            <div class="series-chip" onclick="toggleSeries('B')">B</div>
            <div class="series-chip" onclick="toggleSeries('C')">C</div>
            <div class="series-chip" onclick="toggleSeries('D')">D</div>
            <div class="series-chip" onclick="toggleSeries('E')">E</div>
            <div class="series-chip" onclick="toggleSeries('F')">F</div>
            <div class="series-chip" onclick="toggleSeries('G')">G</div>
            <div class="series-chip" onclick="toggleSeries('H')">H</div>
            <div class="series-chip" onclick="toggleSeries('M')">M</div>
            <div class="series-chip" onclick="toggleSeries('P')">P</div>
            <div class="series-chip" onclick="toggleSeries('Q')">Q</div>
            <div class="series-chip" onclick="toggleSeries('R')">R</div>
            <div class="series-chip" onclick="toggleSeries('T')">T</div>
            <div class="series-chip" onclick="toggleSeries('Y')">Y</div>
            <div class="series-chip" onclick="toggleSeries('ZG')">ZG</div>
        </div>
        

    

    <style>
        .sort-btn {
            flex: 1;
            border: 1px solid #f0f0f0;
            background: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            white-space: nowrap;
        }
        .sort-btn.active {
            background: #e6f7ff;
            color: #1890ff;
            border-color: #91d5ff;
            font-weight: bold;
        }
        .header-sticky {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
        }
        .stats-dropdown {
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
            padding: 0 24px 0 10px;
            border-radius: 8px;
            font-size: 13px;
            height: 32px;
            outline: none;
            appearance: none;
            cursor: pointer;
            font-weight: 500;
            min-width: 90px;
            text-align: center;
            text-align-last: center;
        }
    </style>

    <!-- Summary & Sort Bar -->
    <div id="bead-summary-bar" class="header-sticky" style="padding: 0 5px 10px 5px; display: none;">
        <!-- Sort Controls & Filter -->
        <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 2px; align-items: center;">
             <!-- Filter Dropdown -->
             <div style="position: relative; min-width: 90px; text-align: center;">
                 <select id="seriesFilter" onchange="render()" style="width: 100%; font-size: 13px; font-weight: 700; color: #333; border: 1px solid #eee; border-radius: 6px; background: #fff; outline: none; padding: 6px 20px 6px 12px; appearance: none; text-align: center; cursor: pointer; text-align-last: center; height: 32px;">
                        <option value="221">Mard 221</option>
                        <option value="all">ÂÖ®Á≥ªÂàó</option>
                 </select>
                 <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #ccc; pointer-events: none;">‚ñº</div>
             </div>

            <button id="btn-sort-id" onclick="setBeadSort('id')" class="sort-btn active" data-sort="id">
                Ëâ≤Âè∑ <span class="sort-arrow">‚Üì</span>
            </button>
            <button id="btn-sort-stock" onclick="setBeadSort('stock')" class="sort-btn" data-sort="stock">
                Â∫ìÂ≠ò <span class="sort-arrow"></span>
            </button>
            <button id="btn-sort-used" onclick="setBeadSort('used')" class="sort-btn" data-sort="used">
                Â∑≤Áî® <span class="sort-arrow"></span>
            </button>
        </div>
    </div>
    </div>

    <div id="grid" class="grid-container"></div>
    <div style="text-align:center; padding:10px; color:#999; font-size:10px;">
        ÂºÄÂèëËÄÖ: Â∞èÁ∫¢‰π¶Áî®Êà∑ƒÅ≈çƒìÔºåID 11535779483Ôºå‰ΩøÁî®AIÂ∑•ÂÖ∑ÂºÄÂèë
    </div>
</div>




</div> <!-- End page-beads -->

    <div id="footer-dock" class="bottom-dock">
        <div class="dock-item active" onclick="navToDock('inventory')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
            </span>
            <span class="dock-label">Â∫ìÂ≠ò</span>
        </div>
        <div class="dock-item" onclick="navToDock('scan')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM5 19h4v2H5c-1.1 0-2-.9-2-2v-4h2v4z"/><rect x="7" y="9" width="10" height="6" rx="1"/></svg>
            </span>
            <span class="dock-label">Êâ´Êèè</span>
        </div>
        <div class="dock-item" onclick="navToDock('plan')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/><path d="M12 17h-2v-2h2v2zm0-4h-2V9h2v4zm0-6h-2V3h2v4z"/></svg>
            </span>
            <span class="dock-label">ËÆ°Âàí</span>
        </div>
        <div class="dock-item" onclick="navToDock('stats')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M4 19h4v-7H4v7zm6 0h4V5h-4v14zm6 0h4v-10h-4v10z"/></svg>
            </span>
            <span class="dock-label">ÁªüËÆ°</span>
        </div>
        <div class="dock-item" onclick="navToDock('more')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </span>
            <span class="dock-label">Êõ¥Â§ö</span>
        </div>
    </div>

    <div id="page-more" style="display:none; padding-bottom: 80px; background: #f7f8fa; min-height: 100vh;">
        <div class="container" style="padding: 20px;">
            <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #333;">Êõ¥Â§ö</h3>
            
            <div style="background: white; border-radius: 16px; padding: 0 20px; margin-bottom: 20px;">
                 <!-- Threshold -->
                <div onclick="openThresholdModal()" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #fff2e8; color: #fa541c; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">üìè</div>
                    <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">ÈòàÂÄºÁÆ°ÁêÜ</div>
                         <div style="font-size: 12px; color: #999;">ËÆæÁΩÆ‰ΩéÂ∫ìÂ≠òÈ¢ÑË≠¶ÈòàÂÄº</div>
                     </div>
                     <div style="color: #ccc;">‚Ä∫</div>
                 </div>

                 <!-- Cost Settings -->
                 <div onclick="openCostModal()" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #f6ffed; color: #52c41a; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">üí∞</div>
                    <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">ÊàêÊú¨ËÆæÁΩÆ</div>
                         <div style="font-size: 12px; color: #999;">ËÆæÁΩÆË±ÜÂ≠êÂçï‰ª∑ÔºåËá™Âä®ËÆ°ÁÆóÊàêÊú¨</div>
                     </div>
                     <div style="color: #ccc;">‚Ä∫</div>
                 </div>
                 
                 <!-- Ignored List -->
                 <div onclick="openIgnoredModal(true)" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #fff0f6; color: #eb2f96; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">üö´</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">ÂøΩÁï•Ê∏ÖÂçï</div>
                         <div style="font-size: 12px; color: #999;">ÁÆ°ÁêÜËâ≤Âè∑ÂøΩÁï•Ê∏ÖÂçï</div>
                     </div>
                     <div style="color: #ccc;">‚Ä∫</div>
                 </div>

                 <!-- Data Import/Export -->
                 <div onclick="openDataModal('backup')" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #f9f0ff; color: #722ed1; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">‚öôÔ∏è</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">Êï∞ÊçÆÂØºÂÖ•ÂØºÂá∫</div>
                         <div style="font-size: 12px; color: #999;">Â§á‰ªΩ‰∏éÊÅ¢Â§çÊï∞ÊçÆ</div>
                     </div>
                     <div style="color: #ccc;">‚Ä∫</div>
                 </div>

                 <!-- AI Usage -->
                 <div onclick="openAIUsageModal()" style="display: flex; align-items: center; padding: 20px 0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #f0f5ff; color: #2f54eb; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ü§ñ</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">AI ‰ΩøÁî®ÁªüËÆ°</div>
                         <div style="font-size: 12px; color: #999;">Êü•Áúã‰∏éÁÆ°ÁêÜ AI Ê®°ÂûãÈ¢ùÂ∫¶</div>
                     </div>
                     <div style="color: #ccc;">‚Ä∫</div>
                 </div>
            </div>
        </div>
    </div>



<div id="page-stats" style="display:none; padding-bottom: 80px;">
    <!-- Sticky Header -->
    <div class="header-sticky" style="background: #f8f9fa; z-index: 101; border-bottom: 1px solid #eee; padding: 0;">
        <div style="max-width: 600px; margin: 0 auto; padding: 15px 15px 10px 15px;">
            <div style="display:flex; align-items:center; justify-content: space-between;">
                <h2 class="stats-title" style="margin: 0;">ÁªüËÆ°</h2>
                <div style="display:flex; align-items:center; gap: 10px;">
                    <button id="btn-toggle-stats-filter" onclick="toggleStatsFilterVisibility()" style="
                        border: 1px solid #ddd;
                        background: #fff;
                        color: #666;
                        padding: 6px 10px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        display: none; 
                        align-items: center;
                        justify-content: center;
                        height: 32px;
                    ">üé®</button>
                    
                    <div style="position: relative;">
                        <select id="statsSeriesFilter" class="stats-dropdown" onchange="syncAndRenderStats()">
                            <option value="221">Mard 221</option>
                            <option value="all">ÂÖ®Á≥ªÂàó</option>
                        </select>
                        <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #ccc; pointer-events: none;">‚ñº</div>
                    </div>
                </div>
            </div>
            <!-- Stats Series Filter -->
            <div id="statsSeriesFilterContainer" style="display:none; flex-wrap:wrap; gap:8px; margin-top: 10px; padding-bottom: 5px;">
                <!-- Buttons injected here -->
            </div>
        </div>
    </div>

    <div class="container" style="padding: 15px;">
        <div id="stats-usage-view">
            <div class="stats-summary-card stats-card-horizontal">
                <div class="metric-item" style="flex:1;">
                    <div id="stats-total-stock" class="metric-val" style="font-size:20px;">0g</div>
                    <div class="metric-label">ÊÄªÂ∫ìÂ≠ò</div>
                </div>
                
                <div class="donut-chart-wrapper">
                    <div id="stats-donut" class="donut-chart">
                        <div class="donut-label">
                            <span id="stats-donut-percent" class="donut-percent">0%</span>
                            <span class="donut-text">Â∑≤Ê∂àËÄó</span>
                            <span id="stats-donut-value" style="font-size: 11px; color: #666; font-weight: bold; margin-top: 2px;">0g</span>
                        </div>
                    </div>
                </div>

                <div class="metric-item" onclick="enableStatsLowStock()" style="cursor: pointer; flex:1;">
                    <div id="stats-low-count" class="metric-val" style="color: #ff4d4f; font-size:20px;">0</div>
                    <div class="metric-label">Áº∫Ë¥ß</div>
                </div>
            </div>

            <div class="stats-filter-row">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="switch-label">‰ªÖÊòæÁ§∫‰ΩéÂ∫ìÂ≠ò</span>
                    <span onclick="copyLowStock()" style="cursor: pointer; color: #4a90e2; font-size: 16px; display: flex; align-items: center; padding: 4px;" title="Â§çÂà∂Áº∫Ë¥ßÊ∏ÖÂçï">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="stats-low-filter" onchange="renderStats()">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="stats-rank-list" class="stats-rank-list">
                <!-- Rank items will be injected here -->
            </div>
        </div>
        
        <div id="stats-records-view" style="display:none; text-align:center; padding: 40px; color: #999;">
            üöß ÊñΩÂ∑•‰∏≠...
        </div>
    </div>
</div>

<div id="page-plan" style="display:none; padding-bottom: 80px;">
    <div class="container" style="padding: 20px;">
        <div style="position: sticky; top: 0; z-index: 99; background: #fff; margin: -20px -20px 15px -20px; padding: 20px 20px 10px 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
            <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; text-align: center; color: #333; margin-top: 0;">
                ÊãºË±ÜËÆ°Âàí
                <span onclick="togglePlanOverviewContainer()" style="cursor: pointer; color: #4a90e2; font-size: 18px; margin-left: 8px; vertical-align: middle; display: inline-flex; align-items: center;" title="ÊòæÁ§∫ËÆ°ÂàíÊ¶ÇËßà">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                </span>
            </h3>
            
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                <div style="position: relative; flex: 1;">
                    <input type="text" id="planSearch" placeholder="ËæìÂÖ•ËÆ°ÂàíÂêçÁß∞ÊêúÁ¥¢..." oninput="renderPlans()" style="width: 100%; border: 1px solid #ddd; padding: 10px 40px 10px 10px; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s; background: #f9f9f9; box-sizing: border-box;">
                    <div onclick="document.getElementById('planSearch').focus()" style="position: absolute; right: 0; top: 0; bottom: 0; width: 40px; display: flex; align-items: center; justify-content: center; color: #999; cursor: pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                </div>
            </div>

            <div style="display: flex; background: #f0f2f5; padding: 4px; border-radius: 8px;">
                <div id="filter-active" onclick="setPlanFilter('active')" style="flex: 1; text-align: center; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; background: white; color: #4a90e2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;">ËÆ°Âàí‰∏≠</div>
                <div id="filter-completed" onclick="setPlanFilter('completed')" style="flex: 1; text-align: center; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; color: #999; transition: all 0.2s;">Â∑≤ÂÆåÊàê</div>
            </div>
        </div>

        <div id="plan-overview-container" class="stats-summary-card" style="display:none; margin: 10px 20px 20px 20px; padding: 20px; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="margin: 0 0 15px 0; font-size: 15px; color: #333; font-weight: 600; display:flex; align-items:center;">
                <span style="margin-right:6px;">üìÖ</span> ËÆ°ÂàíÊ¶ÇËßà
            </h4>
            
            <div class="stats-metrics" style="border-top: 1px solid #f0f0f0; padding-top: 15px; display: flex; justify-content: space-around;">
                <div id="metric-total" class="metric-item" onclick="togglePlanChartFilter('total')" style="cursor: pointer; padding: 5px; border-radius: 8px; transition: all 0.2s;">
                    <div id="stats-plan-total" class="metric-val" style="font-size: 20px;">0</div>
                    <div class="metric-label" style="color: #666; font-size: 12px;">ÊÄªËÆ°Âàí</div>
                </div>
                <div id="metric-completed" class="metric-item" onclick="togglePlanChartFilter('completed')" style="cursor: pointer; padding: 5px; border-radius: 8px; transition: all 0.2s;">
                    <div id="stats-plan-completed" class="metric-val" style="color: #52c41a; font-size: 20px;">0</div>
                    <div class="metric-label" style="color: #666; font-size: 12px;">Â∑≤ÂÆåÊàê</div>
                </div>
                <div id="metric-pending" class="metric-item" onclick="togglePlanChartFilter('pending')" style="cursor: pointer; padding: 5px; border-radius: 8px; transition: all 0.2s;">
                    <div id="stats-plan-pending" class="metric-val" style="color: #faad14; font-size: 20px;">0</div>
                    <div class="metric-label" style="color: #666; font-size: 12px;">ËÆ°Âàí‰∏≠</div>
                </div>
                <div id="metric-time" class="metric-item" onclick="togglePlanChartFilter('time')" style="cursor: pointer; padding: 5px; border-radius: 8px; transition: all 0.2s;">
                    <div id="stats-plan-time" class="metric-val" style="color: #722ed1; font-size: 20px;">0</div>
                    <div class="metric-label" style="color: #666; font-size: 12px;">ËÄóÊó∂(h)</div>
                </div>
            </div>

            <div id="stats-plan-chart" style="margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 15px;"></div>
        </div>

        <div id="planList" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Plan Items will be rendered here -->
            <div style="text-align: center; color: #999; padding: 40px;">
                ÊöÇÊó†ËÆ°Âàí<br>ËØ∑ÂâçÂæÄÊâ´ÊèèÈ°µÈù¢ÂàõÂª∫
            </div>
        </div>
    </div>
</div>

<div id="page-plan-detail" style="display:none; padding-bottom: 80px; background: #f7f8fa; min-height: 100vh;">
    <!-- Detail Header -->
    <div style="background: white; padding: 20px 20px 10px 20px; border-bottom: 1px solid #f0f0f0; position: sticky; top: 0; z-index: 10;">
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
             <button onclick="closePlanDetail()" style="background:none; border:none; font-size: 20px; color: #333; padding: 0 10px 0 0;">‚Üê</button>
             <div style="flex: 1; text-align: center; padding-right: 30px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span id="planDetailTitle" style="font-size: 18px; font-weight: bold;">ËÆ°ÂàíËØ¶ÊÉÖ</span>
                <span onclick="renameCurrentPlan()" style="cursor: pointer; font-size: 14px; opacity: 0.6;">‚úèÔ∏è</span>
             </div>
        </div>
        
        <!-- Status Banner -->
        <div id="planDetailStatus" style="background: #fffbe6; color: #fa8c16; padding: 15px; border-radius: 8px; font-size: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; text-align: center;">
             <span></span> ËÆ°Âàí‰∏≠ - Â∞öÊú™Êâ£ÂáèÂ∫ìÂ≠ò
        </div>

        <!-- Key Stats -->
        <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
             <div style="text-align: center;">
                 <div id="planDetailColorCount" style="font-size: 24px; font-weight: bold; color: #722ed1;">0</div>
                 <div style="font-size: 13px; color: #999;">È¢úËâ≤Êï∞</div>
             </div>
             <div style="text-align: center;">
                 <div id="planDetailBeadCount" style="font-size: 24px; font-weight: bold; color: #fa8c16;">0</div>
                 <div style="font-size: 13px; color: #999;">ÊÄªÁ≤íÊï∞</div>
             </div>
        </div>
    </div>



    <!-- Action Buttons -->
    <div id="planDetailActions" style="padding: 15px 20px; background: white; margin-bottom: 10px; display: flex; gap: 10px;">
         <button class="m-btn m-btn-primary" onclick="checkPlanStock()" style="flex: 1; background: #1890ff; border-color: #1890ff; display: flex; align-items: center; justify-content: center; gap: 5px;">
             üîç Â∫ìÂ≠òÁ°ÆËÆ§
         </button>
         <button class="m-btn m-btn-primary" onclick="executePlanDeduction()" style="flex: 1; background: #52c41a; border-color: #52c41a; display: flex; align-items: center; justify-content: center; gap: 5px;">
             ‚ñ∂ ÊâßË°åÊâ£Âáè
         </button>
    </div>

    <!-- Image Preview (Restored) -->
    <div id="planDetailImageContainer" style="padding: 0 20px; margin-bottom: 15px; display: none;">
         <div onclick="openPlanImageViewer()" style="position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; height: 180px;">
             <img id="planDetailImage" src="" style="width: 100%; height: 100%; object-fit: cover; display: block; background: #f0f0f0;">

         </div>
    </div>

    <!-- Color List Header -->
    <div style="padding: 0 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
             <h4 style="margin: 0; font-size: 14px; color: #666;">È¢úËâ≤Áî®Èáè</h4>
             <span id="planDetailSortBtn" onclick="togglePlanDetailSort()" style="font-size: 12px; color: #1890ff; cursor: pointer; background: #e6f7ff; padding: 2px 8px; border-radius: 4px;">ÊåâÁî®Èáè ‚Üì</span>
        </div>
        <div id="planDetailList" style="display: flex; flex-direction: column; gap: 10px;">
             <!-- Items -->
        </div>
    </div>
</div>

<div id="page-scan" style="display:none; padding-bottom: 80px;">
    <div class="container" style="padding: 20px;">
        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">ÂõæÁ∫∏Êâ´ÊèèÂàÜÊûê</h3>
        
        <div id="scan-uploader" class="scan-uploader" style="border: 2px dashed #4a90e2; border-radius: 12px; padding: 10px; text-align: center; background: #f0f5ff; margin-bottom: 20px; transition: all 0.2s; overflow: hidden;">
            <div id="scanPreview" onclick="document.getElementById('scanInput').click()" style="padding: 20px; cursor: pointer; color: #4a90e2;">
                <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
                <div style="font-weight: bold; font-size: 16px;">ÁÇπÂáª‰∏ä‰º†ÂõæÁ∫∏Ëâ≤Âè∑Âå∫Âüü</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">ÊîØÊåÅÊâãÊú∫ÊãçÁÖßÊàñ‰ªéÁõ∏ÂÜåÈÄâÊã©</div>
            </div>
            
            <div id="cropContainer" style="display:none; height: 400px; background: #333; position: relative;">
                <img id="scanPreviewImg" style="max-width: 100%; max-height: 100%; display: block;">
            </div>
            
            <div id="scanProcessPreviews" style="display:none; padding: 10px;">
                <div style="font-size: 12px; color: #999; margin-bottom: 10px;">Êâ´ÊèèÂàÜÊûê‰∏≠...</div>
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                     <div style="flex: 1; text-align: center; max-width: 45%;">
                         <div style="font-size: 10px; color: #ccc; margin-bottom: 5px;">ÂéüÂõæ</div>
                         <img id="scanProcessOriginal" style="max-width: 100%; max-height: 150px; border-radius: 4px; border: 1px solid #eee; display:inline-block;">
                     </div>
                     <div style="color: #ccc; font-size: 20px;">‚ûú</div>
                     <div style="flex: 1; text-align: center; max-width: 45%;">
                         <div style="font-size: 10px; color: #ccc; margin-bottom: 5px;">ËØÜÂà´Âå∫Âüü</div>
                         <img id="scanProcessCropped" style="max-width: 100%; max-height: 150px; border-radius: 4px; border: 1px solid #eee; display:inline-block;">
                     </div>
                </div>
            </div>

            <input type="file" id="scanInput" accept="image/*" style="display:none" onchange="handleScanImage(this)">
        </div>

        <div id="cropControls" style="display:none; gap: 10px; margin-bottom: 20px;">
             <button class="m-btn m-btn-ghost" onclick="resetScan()" style="flex: 1;">ÈáçÊñ∞‰∏ä‰º†</button>
             <button class="m-btn m-btn-primary" onclick="openCropEditor()" style="flex: 2;">
             <svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor">
            <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
            </svg>
            ÂºÄÂßãË£ÅÂàá
        </button>
        </div>

        <div id="scanLoading" style="display:none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p id="scanStatusText" style="margin-top: 15px; color: #666; font-size: 14px;">Ê≠£Âú®ËØÜÂà´Ëâ≤Âè∑Êï∞ÊçÆ...</p>
            <p style="font-size: 12px; color: #999; margin-bottom: 15px;">(ÂàùÊ¨°Âä†ËΩΩÂèØËÉΩÈúÄË¶ÅÂá†ÁßíÈíü)</p>
            <button class="m-btn m-btn-ghost" onclick="cancelScan()" style="width: auto; padding: 8px 20px; font-size: 13px; border: 1px solid #ddd;">ÂèñÊ∂àÊâ´Êèè</button>
        </div>

        <div id="scanResult" style="display:none; padding-top: 10px;">
            <!-- 1. Original Full Image (Collapsed/Small Preview) -->
            <div style="margin-bottom: 15px;">
                 <div style="font-size: 13px; color: #999; margin-bottom: 5px;">ÂéüÂßãÂõæÁ∫∏</div>
                 <div style="background: #f0f0f0; border-radius: 8px; overflow: hidden; max-height: 100px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc;">
                      <img id="scanResultFullImage" style="max-width: 100%; max-height: 100px; display: block; opacity: 0.8;" onclick="this.style.maxHeight = this.style.maxHeight === '100px' ? 'none' : '100px'; this.parentElement.style.maxHeight = this.parentElement.style.maxHeight === '100px' ? 'none' : '100px';">
                 </div>
                 <div style="text-align: center; font-size: 10px; color: #ccc; margin-top: 2px;">(ÁÇπÂáªÂ±ïÂºÄ/Êî∂Ëµ∑)</div>
            </div>

            <!-- 2. Cropped Image Preview -->
            <div style="margin-bottom: 5px; font-size: 13px; color: #999;">ËØÜÂà´Âå∫Âüü</div>
            <div style="background: #333; border-radius: 12px; overflow: hidden; margin-bottom: 15px; text-align: center; max-height: 200px; display: flex; align-items: center; justify-content: center;">
                 <img id="scanResultImage" style="max-width: 100%; max-height: 200px; display: block;">
            </div>

            <!-- 3. Action Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <button class="m-btn m-btn-ghost" onclick="reCropImage()" style="flex: 1; border: 1px solid #eee; color: #666; font-size: 13px; border-radius: 20px;">
                 <svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor">
                <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
                </svg>
                Ë∞ÉÊï¥Ë£ÅÂàá
                </button>
                <button class="m-btn m-btn-ghost" onclick="resetScan()" style="flex: 1; border: 1px solid #eee; color: #666; font-size: 13px; border-radius: 20px;">
                    üîÑ ÈáçÊñ∞ÈÄâÊã©
                </button>
            </div>

            <!-- 4. Result Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 2px; white-space: nowrap;">
                <div style="display:flex; align-items:center; gap:5px; flex-shrink: 1; overflow: hidden;">
                    <h4 style="margin: 0; font-size: 12px; font-weight: bold; color: #333;">ËØÜÂà´ÁªìÊûú</h4>
                    <span id="scanTotalCount" style="font-size: 12px; color: #999;">...</span>
                </div>
                <div style="display: flex; gap: 4px; flex-shrink: 0;">
                     <button onclick="toggleScanMissingPriority()" id="btn-scan-missing" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">Áº∫Ë¥ß</button>
                     <button onclick="toggleScanSort('code')" id="btn-sort-code" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">Ëâ≤Âè∑</button>
                     <button onclick="toggleScanSort('qty')" id="btn-sort-qty" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">Áî®Èáè</button>
                </div>
            </div>
            
            <!-- 5. Status / Loading Bar -->
            <div id="scanInlineStatus" style="display:none; background: #e6f7ff; border: 1px solid #91d5ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #0050b3; display: flex; align-items: center; gap: 8px;">
                 <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                 <span id="scanInlineStatusText">Ê≠£Âú®ËØÜÂà´‰∏≠...</span>
            </div>

            <!-- 6. List Container -->
            <div id="scanList" style="display: flex; flex-direction: column; gap: 12px; min-height: 100px;"></div>
            
            <!-- 7. Plan Actions -->
            <div id="planActions" style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #eee;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">ÂõæÁ∫∏ÂëΩÂêç (ÂèØÈÄâ)</label>
                    <input type="text" id="planNameInput" placeholder="ËæìÂÖ•ÂõæÁ∫∏ÂêçÁß∞ÔºåÂ¶Ç: Â∫ìÊ¥õÁ±≥" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="m-btn m-btn-primary" onclick="createPlan()" style="flex: 1; background: #722ed1; border-color: #722ed1;">
                        üìÖ ÂàõÂª∫ËÆ°Âàí
                    </button>
                    <button class="m-btn m-btn-primary" onclick="deductInventory()" style="flex: 1; background: #ff4d4f; border-color: #ff4d4f;">
                        üìâ Êâ£ÂáèÂ∫ìÂ≠ò
                    </button>
                </div>
            </div>

            <!-- 8. Bottom Tip -->
             <div style="margin-top: 30px; padding: 15px; text-align: center; color: #ccc; font-size: 12px; border-top: 1px solid #f0f0f0;">
                ËØÜÂà´ÁªìÊûú‰ªÖ‰æõÂèÇËÄÉ ¬∑ ËØ∑Ê†∏ÂØπÂÆûÁâ©
            </div>
        </div>
    </div>
</div>
<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>


    <!-- ÂºπÁ™óÈÉ®ÂàÜ -->

<div class="overlay" id="mask" onclick="closeAllModals()"></div>
<div class="overlay" id="mask2" onclick="closeAllModals()" style="z-index: 1015; display: none;"></div>
<div id="consumeModal" class="modal" style="width: 85%; max-width: 340px; padding: 20px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">Ê∂àËÄóÂΩïÂÖ• (Á≤íÊï∞)</h3>
    <div id="modalList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #f0f0f0; border-radius: 12px; padding: 5px;"></div>
    <div class="modal-btn-group" style="gap: 10px;">
        <button class="m-btn m-btn-primary" onclick="submitConsume()" style="padding: 10px; font-size: 14px; border-radius: 10px;">Á°ÆËÆ§Êâ£Èô§</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 10px; font-size: 14px; border-radius: 10px;">ÂèñÊ∂à</button>
    </div>
</div>

<div id="thresholdModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 style="font-size: 18px; color: #333; margin-bottom: 10px; text-align: center;">ËÆæÁΩÆÈ¢ÑË≠¶ÈòàÂÄº</h3>
    <div style="font-size: 13px; color: #999; margin-bottom: 25px; text-align: center;">ÂΩìÂ∫ìÂ≠òÈáçÈáè‰Ωé‰∫éÊ≠§ÂÄºÊó∂Ôºå<br>Ëâ≤Âè∑Â∞ÜÊ†áËÆ∞‰∏∫Á∫¢Ëâ≤È¢ÑË≠¶Áä∂ÊÄÅ„ÄÇ</div>
    
    <div class="input-group" style="margin-bottom: 25px;">
        <input type="number" id="thresholdInput" placeholder="0.00" step="0.01" 
               style="font-size: 32px; padding: 15px; border-radius: 12px; background: #f7f8fa; border: 2px solid transparent; width: 100%; box-sizing: border-box; text-align: center; color: #333; font-weight: bold; transition: all 0.2s;">
    </div>
    
    <div class="modal-btn-group" style="gap: 12px; display: flex; flex-direction: row;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1; white-space: nowrap;">ÂèñÊ∂à</button>
        <button class="m-btn m-btn-primary" onclick="saveThreshold()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2); white-space: nowrap;">‰øùÂ≠òËÆæÁΩÆ</button>
    </div>
</div>

<div id="editWeightModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 id="editWeightModalTitle" style="font-size: 18px; color: #333; margin-bottom: 25px;">‰øÆÊîπÂ∫ìÂ≠òÈáçÈáè</h3>
    
    <div class="input-group" style="margin-bottom: 25px;">
        <input type="number" id="editWeightInput" placeholder="0.00" step="0.01" 
               style="font-size: 32px; padding: 15px; border-radius: 12px; background: #f7f8fa; border: 2px solid transparent; width: 100%; box-sizing: border-box; text-align: center; color: #333; font-weight: bold; transition: all 0.2s;">
        <span class="input-suffix" style="right: 30px; font-size: 16px; color: #999;">g</span>
    </div>
    
    <div class="modal-btn-group" style="gap: 12px;">
        <button class="m-btn m-btn-primary" onclick="submitEditWeight()" style="padding: 12px; font-size: 16px; border-radius: 12px; background: linear-gradient(135deg, #4a90e2, #357abd); box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);">Á°ÆËÆ§‰øÆÊîπ</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 12px; font-size: 15px; border-radius: 12px; color: #666;">ÂèñÊ∂à</button>
    </div>
</div>

<div id="restockModal" class="modal">
    <h3>Êñ∞Â¢ûË°•Ë¥ß</h3>
    <div class="modal-desc" id="restockTitle"></div>
    <div class="input-group">
        <input type="number" id="restockInput" placeholder="0" step="0.01">
        <span class="input-suffix">g</span>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitRestock()">Á°ÆËÆ§Ë°•Ë¥ß</button>
        <button class="m-btn m-btn-ghost" onclick="showModal('editWeightModal')">ËøîÂõû</button>
    </div>
</div>

<!-- Plan Detail Edit Quantity Modal -->
<div id="planDetailQtyModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 style="font-size: 18px; color: #333; margin-bottom: 25px; text-align: center;">‰øÆÊîπËÆ°ÂàíÁî®Èáè</h3>
    <div style="text-align: center; margin-bottom: 15px; font-weight: bold; color: #4a90e2; font-size: 16px;" id="planDetailQtyCode"></div>
    <div class="input-group" style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:25px;">
        <button onclick="adjustPlanItemQty(-10)" style="width:40px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; color:#666;">-10</button>
        <button onclick="adjustPlanItemQty(-1)" style="width:40px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; color:#666;">-1</button>
        <input type="number" id="planDetailQtyInput" style="width: 80px; height: 40px; text-align: center; border: 2px solid #ddd; border-radius: 12px; font-size: 18px; font-weight: bold; color: #333; outline: none; -moz-appearance: textfield;">
        <button onclick="adjustPlanItemQty(1)" style="width:40px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; color:#666;">+1</button>
        <button onclick="adjustPlanItemQty(10)" style="width:40px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; color:#666;">+10</button>
    </div>
    <div class="modal-btn-group" style="gap: 12px; display: flex;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="flex:1; border-radius:12px;">ÂèñÊ∂à</button>
        <button class="m-btn m-btn-primary" onclick="submitPlanItemQty()" style="flex:1; border-radius:12px;">Á°ÆËÆ§‰øÆÊîπ</button>
    </div>
</div>

<!-- Plan Detail Select Color Modal -->
<div id="planDetailColorModal" class="modal" style="width: 90%; max-width: 400px; height: 80vh; max-height: 600px; display: none; flex-direction: column; padding: 0; overflow: hidden;">
    <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
        <h3 style="font-size: 16px; margin: 0; font-weight: bold;">Êõ¥Êç¢Ëâ≤Âè∑</h3>
        <button onclick="closeAllModals()" style="background: none; border: none; font-size: 24px; color: #999; padding: 0 10px; cursor: pointer;">√ó</button>
    </div>
    <div style="padding: 10px; border-bottom: 1px solid #f5f5f5; background: #fff;">
        <input type="text" id="planDetailColorSearch" placeholder="ÊêúÁ¥¢Ëâ≤Âè∑..." style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #f9f9f9;" oninput="filterPlanDetailColorList()">
    </div>
    <div id="planDetailColorList" style="flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; -webkit-overflow-scrolling: touch;">
        <!-- List Items -->
    </div>
</div>



<div id="historyModal" class="modal" style="width:95%; max-width:600px;">
    <h3 id="historyTitle" style="font-size:16px; font-weight:bold; margin-bottom:12px;">Â∫ìÂ≠òÊòéÁªÜ</h3>
    
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; background:#f5f7fa; padding:10px; border-radius:10px;">
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">ÂΩìÂâç‰ΩôÈáè</div>
            <div id="hist-stock" style="font-size:16px; font-weight:bold; color:#4a90e2;">0g</div>
        </div>
        <div style="text-align:center; border-left:1px solid #e0e0e0; border-right:1px solid #e0e0e0; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">ÊÄªÊ∂àËÄó</div>
            <div id="hist-used" style="font-size:16px; font-weight:bold; color:#ff4d4f;">0g</div>
        </div>
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">ÊÄªË°•ÂÖÖ</div>
            <div id="hist-added" style="font-size:16px; font-weight:bold; color:#52c41a;">0g</div>
        </div>
    </div>

    <div style="max-height:240px; overflow:auto; border:1px solid #eee; border-radius:10px;">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead style="background:#fafafa; position:sticky; top:0;">
                <tr>
                    <th style="padding:6px 2px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">Êó∂Èó¥</th>
                    <th style="padding:6px 2px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">ÂõæÁ∫∏ÂêçÁß∞</th>
                    <th style="padding:6px 2px; text-align:center; color:#999; font-weight:normal; border-bottom:1px solid #eee;">Êìç‰Ωú</th>
                    <th style="padding:6px 2px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">ÈáçÈáè/Á≤íÊï∞</th>
                </tr>
            </thead>
            <tbody id="historyList"></tbody>
        </table>
    </div>
    <div style="text-align:center; color:#ccc; font-size:10px; margin-top:5px;">
        Ê≥®ÔºöÊÄªËÆ°Êï∞ÊçÆÂåÖÂê´Â∑≤ÂΩíÊ°£ÁöÑÂéÜÂè≤ËÆ∞ÂΩïÔºåÂèØËÉΩÂ§ß‰∫é‰∏äÊñπÂàóË°®ÊòæÁ§∫ÁöÑÊúÄËøë20Êù°ËÆ∞ÂΩï‰πãÂíå„ÄÇ
    </div>

    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding:8px; font-size:13px;">ÂÖ≥Èó≠</button>
    </div>
</div>

<div id="stockCheckSheet" class="modal" style="width: 100%; max-width: 100%; bottom: 0; top: auto; border-radius: 20px 20px 0 0; padding: 0; margin: 0; left: 0; transform: none; max-height: 80vh; display: none; flex-direction: column; animation: slideUpModal 0.3s ease-out; z-index: 99999;">
    <div style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">Â∫ìÂ≠òÁ°ÆËÆ§</h3>
            <button onclick="closeAllModals()" style="background: none; border: none; font-size: 24px; color: #999;">&times;</button>
        </div>
        <div id="stockCheckSummary" style="background: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; padding: 10px; border-radius: 8px; font-size: 13px;">
            üéâ Â∫ìÂ≠òÂÖÖË∂≥ÔºåÂèØ‰ª•ÂºÄÂßãÂà∂‰ΩúÔºÅ
        </div>
        
        <!-- Sort Actions -->
        <div style="display: flex; gap: 8px; margin-top: 10px;">
             <button onclick="toggleStockCheckMissingPriority()" id="btn-check-missing" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">Áº∫Ë¥ß</button>
             <button onclick="toggleStockCheckSort('code')" id="btn-check-code" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">Ëâ≤Âè∑</button>
             <button onclick="toggleStockCheckSort('qty')" id="btn-check-qty" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">Áî®Èáè</button>
        </div>
    </div>
    
    <div id="stockCheckList" style="overflow-y: auto; padding: 10px 20px; flex: 1;">
        <!-- Check Items -->
    </div>

    <div style="padding: 15px 20px; border-top: 1px solid #f0f0f0;">
        <button class="m-btn m-btn-primary" onclick="closeAllModals()" style="width: 100%; padding: 12px; font-size: 16px;">ÊàëÁü•ÈÅì‰∫Ü</button>
    </div>
</div>

<div id="dataModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">Êï∞ÊçÆÂ§á‰ªΩ</h3>
    <div class="data-tabs" style="display:flex; border-bottom:1px solid #eee; margin-bottom:15px;">
        <div id="tabBackup" class="data-tab active" onclick="switchDataTab('backup')" style="flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:bold; color:#4a90e2; border-bottom:2px solid #4a90e2;">Â§á‰ªΩÂØºÂá∫</div>
        <div id="tabRestore" class="data-tab" onclick="switchDataTab('restore')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; border-bottom:2px solid transparent;">ÊÅ¢Â§çÂØºÂÖ•</div>
    </div>
    
    <div id="viewBackup">
        <div style="padding: 20px 0; text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 13px; line-height: 1.6;">
                <p>Â∞ÜÂΩìÂâçÊâÄÊúâÂ∫ìÂ≠òÂèäËÆ∞ÂΩïÂØºÂá∫‰∏∫Êñá‰ª∂„ÄÇ</p>
                <p style="margin-top:8px; font-weight:bold; color:#333;">üìÇ ÂØºÂá∫‰ΩçÁΩÆËØ¥Êòé</p>
                <p style="font-size:12px; color:#888;">
                    ÁîµËÑëÁ´ØÔºö‰∏ãËΩΩÂà∞ÊµèËßàÂô®ÁöÑÈªòËÆ§‰∏ãËΩΩÁõÆÂΩï<br>
                    ÊâãÊú∫Á´ØÔºö‰øùÂ≠òÂà∞ÂÖ¨ÂÖ± <span style="color:#4a90e2; font-weight:bold;">Download</span> Êñá‰ª∂Â§π
                </p>
            </div>
        </div>
    </div>

    <div id="viewRestore" style="display:none;">
        <div style="padding: 20px 0; text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 13px; line-height: 1.6;">
                <p>ÈÄâÊã©Â§á‰ªΩÊñá‰ª∂‰ª•ÊÅ¢Â§çÊï∞ÊçÆ„ÄÇ</p>
                <p style="font-size:12px; color:#888; margin-top:5px;">
                    ÊîØÊåÅ‰ªé ÊâãÊú∫Êñá‰ª∂ÁÆ°ÁêÜ / ÂæÆ‰ø° / WPS Á≠âÈÄîÂæÑÈÄâÊã©<br>
                    (ËØ∑ÈÄâÊã© .txt Ê†ºÂºèÁöÑÂ§á‰ªΩÊñá‰ª∂)
                </p>
            </div>
            <input type="file" id="restoreFile" style="display:none" accept=".txt,text/plain" onchange="loadBackupFile(this)">
            <textarea id="restoreInput" style="display:none;"></textarea>
            <input type="number" id="threshold" style="display:none;" value="0">
        </div>
    </div>
    
    <div class="modal-btn-group" style="margin-top:10px; display:flex; flex-direction:row; flex-wrap:nowrap; gap:10px;">
        <button class="m-btn m-btn-ghost" style="flex:1; width:auto; padding: 12px; font-size: 15px; white-space:nowrap;" onclick="closeAllModals()">ÂÖ≥Èó≠</button>
        <button id="btnBackupAction" class="m-btn m-btn-primary" style="flex:1; width:auto; padding: 12px; font-size: 15px; background: #52c41a; border-color: #52c41a; display: flex; align-items: center; justify-content: center; gap: 8px; white-space:nowrap;" onclick="downloadBackupFile()">
            <span>üì§</span> ÂØºÂá∫Â§á‰ªΩ (TXT)
        </button>
        <button id="btnRestoreAction" class="m-btn m-btn-primary" style="display:none; flex:1; width:auto; padding: 12px; font-size: 15px; background: #1890ff; border-color: #1890ff; align-items: center; justify-content: center; gap: 8px; white-space:nowrap;" onclick="document.getElementById('restoreFile').click()">
            <span>üìÇ</span> ÈÄâÊã©Â§á‰ªΩÊñá‰ª∂ (TXT)
        </button>
    </div>
</div>

<div id="batchInputModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">ÂàùÂßãÊï∞ÊçÆÊâπÈáèÂΩïÂÖ•</h3>
    <div class="modal-desc" style="margin-bottom:8px; text-align:left;">Ê†ºÂºèÔºöËâ≤Âè∑+ÈáçÈáè (Â¶Ç A1 50)</div>
    <textarea id="batchInputText" style="width:100%; height:150px; padding:10px; border:1px solid #eee; border-radius:10px; resize:none; font-family:monospace; font-size:13px; box-sizing:border-box; background:#fafafa; outline:none; color:#333;" placeholder="ÊîØÊåÅÂ§öÁßçÊ†ºÂºèÔºå‰æãÂ¶ÇÔºö&#10;A1 50&#10;B2: 20.5&#10;C3=100"></textarea>
    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="submitBatchInput()">ÂºÄÂßãËØÜÂà´Âπ∂ÂØºÂÖ•</button>
        <button class="m-btn m-btn-ghost" style="padding:8px; font-size:13px;" onclick="closeAllModals()">ÂèñÊ∂à</button>
    </div>
</div>

<div id="lowStockModal" class="modal" style="width:85%; max-width:340px; padding:20px; border-radius:24px;">
    <h3 style="font-size:18px; font-weight:bold; margin-bottom:20px; text-align:center; color:#333;">Ë°•Ë¥ßÊ∏ÖÂçï</h3>
    <div id="lowStockHeader" style="margin-bottom:15px; background:#fffbe6; padding:10px; border-radius:8px; border:1px solid #ffe58f; display:flex; align-items:center; gap:8px;">
        <span style="font-size:16px;">‚ö†Ô∏è</span>
        <div class="modal-desc" style="font-size:12px; color:#d48806; margin:0; text-align:left;">
            <div>‰ª•‰∏ãËâ≤Âè∑Â∫ìÂ≠ò‰Ωé‰∫éËÆæÂÆöÈòàÂÄºÔºåÂª∫ËÆÆÂèäÊó∂Ë°•Ë¥ß„ÄÇ</div>
            <div style="margin-top:4px; opacity:0.8; font-size:11px; color:inherit;">(Â∑≤Ê†πÊçÆÈ¶ñÈ°µ‚ÄúËâ≤Âè∑‚Äù‰∏ãÊãâÊ°ÜÁ≠õÈÄâÊòæÁ§∫ËåÉÂõ¥)</div>
        </div>
    </div>
    
    <div id="lowStockList" style="max-height:260px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:12px; margin-bottom:20px; padding:5px;"></div>
    
    <!-- ÈöêËóèÁöÑÊñáÊú¨ÂüüÁî®‰∫éÂ§çÂà∂ÂäüËÉΩ -->
    <textarea id="lowStockText" style="position:absolute; left:-9999px;"></textarea>

    <div class="modal-btn-group" style="gap:10px;">
        <button class="m-btn m-btn-primary" style="padding:12px; font-size:15px; border-radius:12px;" onclick="copyLowStockText()">‰∏ÄÈîÆÂ§çÂà∂Ê∏ÖÂçï</button>
        <button class="m-btn m-btn-ghost" style="padding:12px; font-size:15px; border-radius:12px;" onclick="closeAllModals()">ÂÖ≥Èó≠</button>
    </div>
</div>

<!-- Crop Edit Modal (Figure 1) -->
<div id="cropEditModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; max-width: none; max-height: none; margin: 0; padding: 0; border-radius: 0; background: black; display: none; flex-direction: column; z-index: 2000; transform: none; box-shadow: none;">
    <!-- Top Bar -->
    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:rgba(0,0,0,0.5); color:white; position:absolute; top:0; left:0; right:0; z-index:10;">
        <button onclick="closeCropEditor()" style="background:none; border:none; color:white; font-size:16px;">ÂèñÊ∂à</button>
        <span style="font-size:18px; font-weight:bold;">Ë£ÅÂàáÂõæÁâá</span>
        <button onclick="showCropPreview()" style="background:#4a90e2; border:none; color:white; font-size:14px; padding:6px 12px; border-radius:4px;">È¢ÑËßà</button>
    </div>
    
    <!-- Main Crop Area -->
    <div style="flex:1; position:relative; overflow:hidden; background:black; display:flex; align-items:center; justify-content:center;">
        <img id="cropEditImage" style="max-width:100%; max-height:100%; display:block;">
    </div>
</div>

<!-- Crop Preview Modal (Figure 2) -->
<div id="cropPreviewModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; max-width: none; max-height: none; margin: 0; padding: 0; border-radius: 0; background: black; display: none; flex-direction: column; justify-content: space-between; z-index: 2100; transform: none; box-shadow: none;">
    <!-- Main Preview Area -->
    <div style="flex:1; width: 100%; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;">
        <img id="cropPreviewImage" style="max-width:100%; max-height:100%; object-fit: contain; transform-origin: center center;">
        
        <!-- Zoom Controls Overlay (Inside Preview Area to float over image) -->
        <div style="position:absolute; bottom:20px; left:0; width:100%; display:flex; justify-content:center; gap:20px; pointer-events:none; z-index: 10;">
             <button onclick="zoomPreview(0.2)" style="pointer-events:auto; background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.5); border-radius:50%; width:40px; height:40px; font-size:20px; display:flex; align-items:center; justify-content:center;">+</button>
             <button onclick="zoomPreview(-0.2)" style="pointer-events:auto; background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.5); border-radius:50%; width:40px; height:40px; font-size:20px; display:flex; align-items:center; justify-content:center;">-</button>
        </div>
    </div>

    <!-- Bottom Action Bar -->
    <div style="padding:20px; background:rgba(0,0,0,0.8); display:flex; gap:15px; flex-shrink:0; z-index: 20;">
        <button class="m-btn m-btn-ghost" onclick="closeCropPreview()" style="flex:1; color:white; border-color:rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap;">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
            </svg>
            ÈáçÊñ∞Ë£ÅÂàá
        </button>
        <button class="m-btn m-btn-primary" onclick="confirmScanFromPreview()" style="flex:1; background:#6c5ce7; border-color:#6c5ce7; white-space: nowrap;">Á°ÆËÆ§Âπ∂ËØÜÂà´</button>
    </div>
</div>

<!-- Scan Add Item Modal -->
<div id="scanAddModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">Ê∑ªÂä†Ëâ≤Âè∑</h3>
    <div style="margin-bottom: 20px;">
        <label style="display:block; font-size:14px; color:#666; margin-bottom:6px;">Ëâ≤Âè∑</label>
        <input type="text" id="scanAddCodeInput" placeholder="‰æãÂ¶ÇA1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; text-transform: uppercase;">
    </div>
    <div style="margin-bottom: 25px;">
        <label style="display:block; font-size:14px; color:#666; margin-bottom:6px;">Êï∞Èáè (Á≤í)</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="m-btn m-btn-ghost" style="width: 40px; padding: 8px 0;" onclick="adjustAddScanQty(-10)">-10</button>
            <input type="number" id="scanAddQtyInput" value="0" style="flex: 1; text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; font-weight: bold;">
            <button class="m-btn m-btn-ghost" style="width: 40px; padding: 8px 0;" onclick="adjustAddScanQty(10)">+10</button>
        </div>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitAddScanItem()">Ê∑ªÂä†</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">ÂèñÊ∂à</button>
    </div>
</div>

<!-- Scan Delete Confirm Modal -->
<div id="scanDeleteConfirmModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; color: #ff4d4f;">Âà†Èô§Ëâ≤Âè∑</h3>
    <div style="text-align: center; margin-bottom: 25px; color: #666; font-size: 15px;">
        Á°ÆÂÆöË¶Å‰ªéÊâ´ÊèèÁªìÊûú‰∏≠Âà†Èô§ <span id="scanDeleteCode" style="font-weight: bold; color: #333;"></span> ÂêóÔºü
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" style="background: #ff4d4f; border-color: #ff4d4f;" onclick="confirmDeleteScanItem()">Âà†Èô§</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">ÂèñÊ∂à</button>
    </div>
</div>

<!-- Scan Qty Modify Modal -->
<div id="scanQtyModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">‰øÆÊîπÊï∞Èáè</h3>
    <div style="margin-bottom: 25px;">
        <div style="font-size: 14px; color: #666; margin-bottom: 12px; text-align: center;">Ëâ≤Âè∑: <span id="scanQtyCode" style="font-weight: bold; color: #333; font-size: 16px;"></span></div>
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(-10)">-10</button>
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(-1)">-1</button>
            <input type="number" id="scanQtyInput" style="width: 70px; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; font-weight: bold;">
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(1)">+1</button>
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(10)">+10</button>
        </div>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitScanQty()">Á°ÆÂÆö</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">ÂèñÊ∂à</button>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirmModal" class="modal" style="width: 85%; max-width: 320px; border-radius: 12px; padding: 20px;">
    <h3 id="customConfirmTitle" style="font-size: 18px; font-weight: bold; margin-bottom: 12px; text-align: center; color: #333;">ÊèêÁ§∫</h3>
    <div id="customConfirmMessage" style="font-size: 15px; color: #666; margin-bottom: 24px; text-align: center; line-height: 1.5;"></div>
    <div class="modal-btn-group" style="gap: 12px;">
        <button id="customConfirmCancelBtn" class="m-btn m-btn-ghost" onclick="closeAllModals()" style="flex: 1; border-radius: 8px;">ÂèñÊ∂à</button>
        <button id="customConfirmOkBtn" class="m-btn m-btn-primary" style="flex: 1; border-radius: 8px; background: #ff4d4f; border-color: #ff4d4f;">Á°ÆÂÆö</button>
    </div>
</div>

<!-- Scan Color Select Modal -->
<div id="scanColorModal" class="modal" style="width: 90%; max-width: 400px; height: 80vh; max-height: 600px; display: none; flex-direction: column; padding: 0; overflow: hidden;">
    <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
        <h3 style="font-size: 16px; margin: 0; font-weight: bold;">Êõ¥Êç¢Ëâ≤Âè∑</h3>
        <button onclick="closeAllModals()" style="background: none; border: none; font-size: 24px; color: #999; padding: 0 10px; cursor: pointer;">√ó</button>
    </div>
    <div style="padding: 10px; border-bottom: 1px solid #f5f5f5; background: #fff;">
        <input type="text" id="scanColorSearch" placeholder="ÊêúÁ¥¢Ëâ≤Âè∑..." style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #f9f9f9;" oninput="filterScanColorList()">
    </div>
    <div id="scanColorList" style="flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9;">
        <!-- List Items Generated via JS -->
    </div>
</div>

<div id="welcomeModal" class="modal">
    <h3>üì¢ Ê¨¢Ëøé‰ΩøÁî® MARD Ë±ÜÂ∫ì</h3>
    <div style="text-align:left; color:#555; line-height:1.6; font-size:14px; padding:0 10px;">
        <p style="margin-bottom:12px;"><b>1. Êï∞ÊçÆÂÆâÂÖ®ÊèêÈÜíÔºö</b><br>
        Êú¨Â∑•ÂÖ∑Êï∞ÊçÆ<span style="color:#ff4d4f; font-weight:bold;">‰ªÖÂ≠òÂÇ®Âú®ÂΩìÂâçÊµèËßàÂô®ÁöÑÊú¨Âú∞ÁºìÂ≠ò‰∏≠</span>„ÄÇÊ∏ÖÁêÜÊµèËßàÂô®ÁºìÂ≠òÂ∞ÜÂØºËá¥Êï∞ÊçÆÊ∞∏‰πÖ‰∏¢Â§±ÔºÅ<br>
        ËØ∑Âä°ÂøÖÂÆöÊúüÂ§á‰ªΩÊï∞ÊçÆÔºàÊìç‰ΩúÂÖ•Âè£ÔºöÈ°µÈù¢‰∏äÊñπ‚ÄúÊï∞ÊçÆÂ§á‰ªΩ‚ÄùÔºâÔºå‰ΩúËÄÖ‰∏çÊâøÊãÖÊï∞ÊçÆ‰∏¢Â§±ÁöÑ‰ªª‰ΩïÂêéÊûú„ÄÇ</p>
        
        <p style="margin-bottom:12px;"><b>2. ËÆæÂ§áÂêåÊ≠•Ôºö</b><br>
        Êú¨Â∑•ÂÖ∑‰∏∫Á¶ªÁ∫øÁΩëÈ°µÂ∫îÁî®Ôºå<span style="color:#ff4d4f; font-weight:bold;">‰∏çÊîØÊåÅÂ§öËÆæÂ§áÂÆûÊó∂ÂêåÊ≠•</span>„ÄÇÂ¶ÇÈúÄÂú®ÂÖ∂‰ªñËÆæÂ§á‰ΩøÁî®ÔºåËØ∑‰ΩøÁî®Â§á‰ªΩ/ÊÅ¢Â§çÂäüËÉΩÊâãÂä®ËøÅÁßªÊï∞ÊçÆ„ÄÇ</p>
        
        <p style="margin-bottom:12px;"><b>3. ÂäüËÉΩËØ¥ÊòéÔºö</b><br>
        ËØ¶ÁªÜÊìç‰ΩúÊåáÂçóËØ∑ÁÇπÂáªÈ°µÈù¢‰∏äÊñπÁöÑ‚Äúüìñ ‰ΩøÁî®ËØ¥Êòé‚ÄùÊü•Áúã„ÄÇ</p>
    </div>
    <div class="modal-btn-group" style="margin-top:20px;">
        <button class="m-btn m-btn-primary" onclick="closeWelcomeModal()">ÊàëÂ∑≤Áü•Êôì</button>
    </div>
</div>

<div id="ignoredModal" class="modal" style="width:90%; max-width:360px; height:80vh; flex-direction:column; overflow:hidden;">
    <h3 style="margin-bottom:5px;">Ëâ≤Âè∑ÈòàÂÄºÊèêÈÜíÁÆ°ÁêÜ</h3>
    <div class="modal-desc" style="margin-bottom:10px;">ËÆæÁΩÆÊòØÂê¶ÂºÄÂêØ‰ΩéÂ∫ìÂ≠òÈ¢ÑË≠¶</div>
    
    <!-- Tabs -->
    <div class="ai-tabs" style="display:flex; border-bottom:1px solid #eee; margin-bottom:10px; flex-shrink:0;">
        <div id="tab-ignored-disabled" class="ai-tab active" onclick="switchIgnoredTab('disabled')" style="flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:bold; color:#e24a4a; border-bottom:2px solid #e24a4a;">ÂÖ≥Èó≠Ê∏ÖÂçï</div>
        <div id="tab-ignored-enabled" class="ai-tab" onclick="switchIgnoredTab('enabled')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; border-bottom:2px solid transparent;">ÂºÄÂêØÊ∏ÖÂçï</div>
    </div>

    <!-- Filter Control -->
    <div style="flex-shrink:0; margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0 5px;">
            <span id="ignoredListCount" style="font-size:12px; color:#999;"></span>
            <button id="btn-toggle-ignored-filter" onclick="toggleIgnoredFilterVisibility()" style="border:1px solid #ddd; background:#fff; color:#666; padding:4px 8px; border-radius:6px; font-size:12px; cursor:pointer; display:none; align-items:center; gap:4px;">
                üé® Ëâ≤Á≥ªÁ≠õÈÄâ
            </button>
        </div>
        <div id="ignoredSeriesFilter" style="display:none; flex-wrap:wrap; gap:6px; max-height:100px; overflow-y:auto; padding:8px; background:#f9f9f9; border-radius:8px; margin-top:8px;"></div>
    </div>
    
    <!-- List -->
    <div id="ignoredList" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:10px; padding:5px; background:#fff;"></div>
    
    <!-- Footer / Batch Actions -->
    <div style="flex-shrink:0; margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <div style="display:flex; align-items:center; gap:5px;">
                 <input type="checkbox" id="ignoredSelectAll" onchange="toggleAllIgnoredBatchSelection()" style="width:18px; height:18px;">
                 <label for="ignoredSelectAll" style="font-size:14px; color:#666;">ÂÖ®ÈÄâ</label>
             </div>
             <div style="display:flex; gap:10px;">
                 <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding:6px 12px; white-space:nowrap;">ÂèñÊ∂à</button>
                 <button id="btn-ignored-batch-action" class="m-btn m-btn-primary" onclick="executeIgnoredBatchAction()" style="padding:6px 12px; white-space:nowrap;" disabled>ÊâπÈáèÂºÄÂêØ</button>
             </div>
        </div>
    </div>
</div>

<div id="devInfoModal" class="modal" style="width:70%; max-width:260px; padding:15px;">
    <h3 style="font-size:16px;">ÂºÄÂèëËÄÖ‰ø°ÊÅØ</h3>
    <div style="text-align:center; padding:10px; color:#555; font-size:13px; line-height:1.6;">
        <p><b>ÂºÄÂèëËÄÖ:</b> Â∞èÁ∫¢‰π¶Áî®Êà∑ƒÅ≈çƒì</p>
        <p><b>ID:</b> 11535779483</p>
        <p>‰ΩøÁî® AI Â∑•ÂÖ∑ÂºÄÂèë</p>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="closeAllModals()">ÂÖ≥Èó≠</button>
    </div>
</div>

<div id="aiUsageModal" class="modal" style="width:90%; max-width:400px; max-height: 85vh; overflow-y: auto;">
    <div class="modal-header" style="text-align:center; margin-bottom:15px;">
        <h3 style="margin:0;">AIÊ®°ÂûãÈÖçÁΩÆ</h3>
        <div id="aiUsageDate" style="font-size: 12px; color: #999; margin-top:4px;"></div>
    </div>

    <div class="ai-tabs" style="display:flex; border-bottom:1px solid #eee; margin-bottom:15px;">
        <div id="tab-btn-quota" class="ai-tab active" onclick="switchAITab('quota')" style="flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:bold; color:#4a90e2; border-bottom:2px solid #4a90e2;">È¢ùÂ∫¶ÁÆ°ÁêÜ</div>
        <div id="tab-btn-keys" class="ai-tab" onclick="switchAITab('keys')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; border-bottom:2px solid transparent;">API Keys</div>
        <div id="tab-btn-models" class="ai-tab" onclick="switchAITab('models')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; border-bottom:2px solid transparent;">Ê®°ÂûãÂàóË°®</div>
    </div>

    <!-- Quota Tab -->
    <div id="tab-content-quota" style="display:block;">
        <div class="modal-desc" style="margin-bottom: 15px; text-align: center; color:#666; font-size:13px;">
            ÊØèÊó•È¢ùÂ∫¶ = 20 √ó KeyÊï∞Èáè (ÂΩìÂâç: <span id="totalDailyLimit" style="font-weight:bold;">0</span>)
        </div>
        <div id="quotaList" style="display:flex; flex-direction:column; gap:12px; background: #f5f7fa; border-radius: 12px; padding: 15px;">
            <!-- Quota Items injected via JS -->
        </div>
    </div>

    <!-- Keys Tab -->
    <div id="tab-content-keys" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 4px;">
            <span style="font-weight: bold; color: #333; font-size: 14px;">ÊàëÁöÑAPI Keys</span>
            <button onclick="toggleAddKeyForm()" style="border: none; background: none; color: #4a90e2; font-size: 24px; font-weight: bold; cursor: pointer; padding: 0 8px; line-height: 1;">+</button>
        </div>

        <!-- Add Key Form (Hidden) -->
        <div id="addKeyForm" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed #4a90e2;">
            <div style="font-size: 13px; font-weight: bold; color: #555; margin-bottom: 8px;">Ê∑ªÂä†Êñ∞Key</div>
            <input type="text" id="newKeyName" placeholder="ÂêçÁß∞ (‰æãÂ¶Ç: ÂÖ¨Âè∏Key)" style="width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 13px;">
            <input type="text" id="newKeyVal" placeholder="sk-..." style="width: 100%; margin-bottom: 15px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 13px;">
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="toggleAddKeyForm()" style="padding: 6px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; font-size: 13px; color: #666;">ÂèñÊ∂à</button>
                <button onclick="saveNewKey()" style="padding: 6px 16px; background: #4a90e2; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: bold;">‰øùÂ≠ò</button>
            </div>
        </div>

        <!-- Key List Container -->
        <div id="aiKeyList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
            <!-- Keys injected via JS -->
        </div>
    </div>

    <!-- Models Tab -->
    <div id="tab-content-models" style="display:none;">
        <div style="margin-bottom: 10px; color: #666; font-size: 13px; text-align: center;">
            Ëá™ÂÆö‰πâÊ®°ÂûãË∞ÉÁî®È°∫Â∫è (‰ªé‰∏äÂà∞‰∏ã‰ºòÂÖàË∞ÉÁî®)
        </div>
        <div id="modelListContainer" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
            <!-- Models injected via JS -->
        </div>
        <button onclick="addModelFromUI()" style="width:100%; padding:10px; border:1px dashed #4a90e2; background:#f0f7ff; color:#4a90e2; border-radius:8px; font-weight:bold; cursor:pointer;">+ Ê∑ªÂä†Ê®°Âûã</button>
    </div>

    <div class="modal-btn-group" style="margin-top:20px; display: flex; gap: 10px; flex-direction: row;">
        <button class="m-btn m-btn-ghost" onclick="resetAllAIUsage()" style="color: #ff4d4f; border-color: #ff4d4f; flex: 1; width: auto; white-space: nowrap;">ÈáçÁΩÆÊâÄÊúâÈ¢ùÂ∫¶</button>
        <button class="m-btn m-btn-primary" onclick="closeAllModals()" style="flex: 1; width: auto; white-space: nowrap;">ÂÆåÊàê</button>
    </div>
</div>

<!-- Rename Plan Modal -->
<div id="renamePlanModal" class="modal" style="width: 85%; max-width: 320px; border-radius: 16px; padding: 24px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">ÈáçÂëΩÂêç</h3>
    <div style="margin-bottom: 25px;">
        <input type="text" id="renamePlanInput" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÁöÑËÆ°ÂàíÂêçÁß∞" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; text-align: center;" onkeypress="if(event.key === 'Enter') submitRenamePlan()">
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitRenamePlan()">Á°ÆÂÆö</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">ÂèñÊ∂à</button>
    </div>
</div>

<div id="revertConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">Êí§ÈîÄÁ°ÆËÆ§</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        Á°ÆÂÆöË¶ÅÊí§ÈîÄ‚ÄúÂ∑≤ÂÆåÊàê‚ÄùÁä∂ÊÄÅÂêóÔºü<br>ËøôÂ∞ÜËá™Âä®ÂõûÊªöÂ∫ìÂ≠òÊâ£ÂáèÊìç‰Ωú„ÄÇ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="confirmRevertPlan()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">Á°ÆËÆ§Êí§ÈîÄ</button>
    </div>
</div>

<div id="deleteConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">Âà†Èô§Á°ÆËÆ§</h3>
    <div id="deleteConfirmMsg" style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÆ°ÂàíÂêóÔºü
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="confirmDeletePlan()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">Á°ÆËÆ§Âà†Èô§</button>
    </div>
</div>

    <div id="deductModal" class="modal" onclick="if(event.target===this) closeAllModals()">
        <h3 style="margin-bottom: 24px;">Á°ÆËÆ§Êâ£Èô§Â∫ìÂ≠ò</h3>
        
        <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 24px;">
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">ËÆ°ÂàíÂêçÁß∞</div>
            <div id="deductPlanName" style="font-weight: 600; color: #1f2937; font-size: 16px;"></div>
        </div>

        <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="font-size: 14px; font-weight: 600; color: #374151;">ËÄóÊó∂ËÆ∞ÂΩï</label>
                <span style="font-size: 12px; color: #9ca3af;">(ÈÄâÂ°´)</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="number" id="deductTimeHours" min="0" placeholder="0" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        style="width: 100%; padding: 12px; padding-right: 30px; background: #f3f4f6; border: 1px solid transparent; border-radius: 12px; font-size: 15px; outline: none; box-sizing: border-box; transition: all 0.2s; text-align: center;"
                        onfocus="this.style.background='white'; this.style.borderColor='var(--primary)';"
                        onblur="this.style.background='#f3f4f6'; this.style.borderColor='transparent';"
                    >
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 12px; pointer-events: none;">Â∞èÊó∂</span>
                </div>
                <div style="flex: 1; position: relative;">
                    <input type="number" id="deductTimeMinutes" min="0" max="59" placeholder="0" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        style="width: 100%; padding: 12px; padding-right: 30px; background: #f3f4f6; border: 1px solid transparent; border-radius: 12px; font-size: 15px; outline: none; box-sizing: border-box; transition: all 0.2s; text-align: center;"
                        onfocus="this.style.background='white'; this.style.borderColor='var(--primary)';"
                        onblur="this.style.background='#f3f4f6'; this.style.borderColor='transparent';"
                    >
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 12px; pointer-events: none;">ÂàÜÈíü</span>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="flex: 1;">ÂèñÊ∂à</button>
            <button class="m-btn m-btn-primary" onclick="confirmDeduct()" style="flex: 1;">Á°ÆËÆ§Êâ£Èô§</button>
        </div>
    </div>

    <div id="importConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">ÊÅ¢Â§çÁ°ÆËÆ§</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        Ë≠¶ÂëäÔºöÊÅ¢Â§çÊìç‰ΩúÂ∞ÜÈáçÁΩÆÂΩìÂâçÊâÄÊúâÂ∫ìÂ≠òÊï∞ÊçÆÔºåÁÑ∂ÂêéÂØºÂÖ•Êñ∞Êï∞ÊçÆ„ÄÇ<br>Á°ÆËÆ§ÁªßÁª≠ÂêóÔºü
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="confirmImport()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">Á°ÆËÆ§ÊÅ¢Â§ç</button>
    </div>
</div>

<div id="moveOutConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">ÁßªÂá∫Á°ÆËÆ§</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        Á°ÆÂÆöË¶ÅÂ∞ÜÊ≠§ËÆ°ÂàíÁßªÂá∫ÂΩìÂâçÊñá‰ª∂Â§πÂêóÔºü<br>ÁßªÂá∫ÂêéÂÆÉÂ∞ÜÂèòÂõûÁã¨Á´ãËÆ°Âàí„ÄÇ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="confirmMoveOutPlan()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">Á°ÆËÆ§ÁßªÂá∫</button>
    </div>
</div>

<div id="createCollectionModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">ÂàõÂª∫ÂêàÈõÜ</h3>
    <div style="margin-bottom: 20px;">
        <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">ËØ∑ËæìÂÖ•ÂêàÈõÜÂêçÁß∞Ôºö</label>
        <input type="text" id="collectionNameInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;" placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÂêàÈõÜ">
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="confirmCreateCollection()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ÂàõÂª∫</button>
    </div>
</div>

<div id="resetQuotaConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">ÈáçÁΩÆÁ°ÆËÆ§</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÊ®°ÂûãÁöÑ‰ªäÊó•Â∑≤Áî®È¢ùÂ∫¶ÂêóÔºü<br>ÈáçÁΩÆÂêéÂ∞ÜÈáçÊñ∞ËÆ°ÁÆó‰ΩøÁî®Èáè„ÄÇ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeResetConfirmModal()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="executeResetAllAIUsage()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">Á°ÆËÆ§ÈáçÁΩÆ</button>
    </div>
</div>

<div id="deleteKeyConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">Âà†Èô§ Key</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ API Key ÂêóÔºü<br>Âà†Èô§Âêé‰∏çÂèØÊÅ¢Â§ç„ÄÇ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="confirmDeleteKey()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">Âà†Èô§</button>
    </div>
</div>

<div id="resetUsageConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">ÈáçÁΩÆÈ¢ùÂ∫¶</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        Á°ÆÂÆöÈáçÁΩÆÂΩìÂâç Key ÁöÑ‰ªäÊó•È¢ùÂ∫¶ÂêóÔºü<br>ËøôÂè™‰ºöÊ∏ÖÈô§Êú¨Âú∞ËÆ∞ÂΩïÁöÑÂ∑≤Áî®Èáè„ÄÇ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="confirmResetUsage()" style="flex: 1; padding: 10px; border: none; background: #4a90e2; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ÈáçÁΩÆ</button>
    </div>
</div>

<div id="modelEditModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 id="modelEditTitle" style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">Ê∑ªÂä†Ê®°Âûã</h3>
    <div style="margin-bottom: 20px;">
        <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">Ê®°ÂûãÂêçÁß∞Ôºö</label>
        <input type="text" id="modelNameInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;" placeholder="‰æãÂ¶Ç: gemini-1.5-pro" onkeypress="if(event.key === 'Enter') submitModelEdit()">
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeModelEditModal()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button onclick="submitModelEdit()" style="flex: 1; padding: 10px; border: none; background: #4a90e2; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">Á°ÆÂÆö</button>
    </div>
</div>

<div id="modelDeleteModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">Âà†Èô§Á°ÆËÆ§</h3>
    <p id="modelDeleteMsg" style="text-align: center; color: #666; font-size: 14px; margin-bottom: 24px; line-height: 1.5;"></p>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeModelDeleteModal()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">ÂèñÊ∂à</button>
        <button id="btnConfirmDeleteModel" onclick="confirmDeleteModel()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">Âà†Èô§</button>
    </div>
</div>




<!-- Fabric Tool Page -->
<div id="page-fabric" style="display:none; min-height:100vh; background:#f0f2f5;">
    <!-- Fabric Tool Header -->
    <div style="background:white; padding:12px 16px; display:flex; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.05); position:sticky; top:0; z-index:100;">
        <button onclick="navTo('home')" class="btn-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <h2 style="margin:0; font-size:16px; flex:1;">ÁÉòÁÑôÂ∏ÉË£ÅÂâ™ÁªÑÂêàÂ∑•ÂÖ∑</h2>
    </div>

    <div class="fabric-container">
        <!-- Sidebar -->
        <div class="fabric-sidebar">
            <h3 style="margin-top:0; font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">1. ÂéüÂ∏ÉÂ∞∫ÂØ∏ (cm)</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div class="input-group-sm">
                    <label>Èïø</label>
                    <input type="number" id="canvasW" value="100" onchange="saveFabricState()">
                </div>
                <div class="input-group-sm">
                    <label>ÂÆΩ</label>
                    <input type="number" id="canvasH" value="100" onchange="saveFabricState()">
                </div>
            </div>

            <h3 style="font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                2. ÊàêÂìÅËßÑÊ†º (ÊúÄÂ§ö5Áßç)
                <button onclick="addSpec()" style="font-size:12px; background:#e6f7ff; color:#1890ff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">+ Ê∑ªÂä†</button>
            </h3>
            <div style="font-size:12px; color:#999; margin-bottom:10px; line-height:1.4;">
                ËßÑÊ†ºÂèÇËÄÉÔºö‰∏ÄÂùó52ÈíâÊùøËßÑÊ†º‰∏∫14*14cm, ‰∏ÄÂùó78ÈíâÊùøËßÑÊ†º‰∏∫21*21cm, ‰∏ÄÂùó104ÈíâÊùøËßÑÊ†º‰∏∫28*28cm
            </div>
            <div id="specList" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                <!-- Specs will be injected here -->
            </div>

            <h3 style="font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">3. ÊéíÂ∫èÂÅèÂ•Ω</h3>
            <select id="sortPref" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-bottom:20px; box-sizing:border-box;" onchange="saveFabricState()">
                <!-- Options will be dynamic -->
            </select>

            <button onclick="calculateLayout()" style="width:100%; padding:12px; background:linear-gradient(135deg, #eb2f96, #c41d7f); color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer; box-shadow:0 4px 10px rgba(235, 47, 150, 0.3); box-sizing:border-box;">
                ÂºÄÂßãËÆ°ÁÆóÔºà‰ªÖÂ±ïÁ§∫Âà©Áî®Áéá‚â• 90%ÁöÑÊñπÊ°à)
            </button>
            <div id="calcStatus" style="margin-top:10px; font-size:12px; color:#666; text-align:center;"></div>
        </div>

        <!-- Main Content -->
        <div class="fabric-main">
            <div id="solutionList" style="display:flex; flex-direction:column; gap:20px;">
                <div style="text-align:center; padding:40px; color:#999;">
                    <div style="font-size:40px; margin-bottom:10px;">‚úÇÔ∏è</div>
                    <div class="desktop-hint">ÁÇπÂáªÂ∑¶‰æß‚ÄúÂºÄÂßãËÆ°ÁÆó‚ÄùÁîüÊàêÊñπÊ°à</div>
                    <div class="mobile-hint">ÁÇπÂáª‰∏äÊñπ‚ÄúÂºÄÂßãËÆ°ÁÆó‚ÄùÁîüÊàêÊñπÊ°à</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .input-group-sm { flex:1; display:flex; flex-direction:column; gap:4px; min-width:0; }
    .input-group-sm label { font-size:12px; color:#666; }
    .input-group-sm input { padding:6px; border:1px solid #ddd; border-radius:4px; width:100%; box-sizing:border-box; }
    
    .fabric-sidebar, .fabric-main { min-width: 300px; box-sizing: border-box; }
    @media (max-width: 600px) {
        .fabric-sidebar, .fabric-main { min-width: 100% !important; border-radius: 0 !important; box-shadow: none !important; padding: 16px !important; }
        .fabric-container { padding: 0 !important; gap: 10px !important; }
        .fabric-main { padding: 16px !important; background: transparent; }
    }
    
    .spec-item { display:flex; gap:8px; align-items:center; background:#f9fafb; padding:8px; border-radius:6px; }
    .spec-color { width:16px; height:16px; border-radius:4px; }
    .btn-del { border:none; background:none; color:#ff4d4f; cursor:pointer; font-size:16px; padding:0 4px; }

    .solution-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .sol-header { padding:12px 16px; background:#fafafa; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
    .sol-badge { background:#f6ffed; color:#52c41a; border:1px solid #b7eb8f; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold; white-space: nowrap; }
    .sol-body { padding:16px; display:flex; flex-wrap:wrap; gap:20px; align-items:flex-start; }
    .sol-canvas-wrapper { border:1px solid #eee; display:inline-block; position:relative; }
    .sol-info { flex:1; min-width:150px; }
    .sol-stat-row { display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px; color:#555; border-bottom:1px dotted #eee; padding-bottom:2px; }

    /* ÂìçÂ∫îÂºèÊèêÁ§∫ÊñáÂ≠ó */
    .mobile-hint { display: none; }
    .desktop-hint { display: block; }

    /* Fabric Tool Layout */
    .fabric-container { max-width:1200px; margin:0 auto; padding:16px; display:flex; flex-wrap:wrap; gap:20px; }
    .fabric-sidebar { flex:1; min-width: 280px; background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); height:fit-content; }
    .fabric-main { flex:2; min-width: 280px; }

    @media (max-width: 768px) {
        .mobile-hint { display: block; }
        .desktop-hint { display: none; }
    }

    @media (max-width: 600px) {
        .fabric-container { padding: 6px; gap: 12px; }
        .fabric-sidebar { padding: 16px; }
    }
</style>


<!-- Zoom Modal -->
<div id="zoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:95%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeZoom()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="margin-bottom:10px; font-weight:bold; font-size:18px; color:#333;" id="zoomTitle">ÊñπÊ°àËØ¶ÊÉÖ</div>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:10px;">
            <canvas id="zoomCanvas"></canvas>
        </div>
        <button id="zoomDownloadBtn" onclick="downloadSolution(currentZoomIdx)" style="margin-top:10px; padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">‰øùÂ≠òÂõæÁâá</button>
        <div id="zoomStats" style="margin-top:10px; width:100%; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:4px; box-sizing: border-box; background: #fafafa;"></div>
        <div style="margin-top:15px; display:flex; justify-content:center;">
             <button onclick="closeZoom()" style="padding:8px 20px; background:#f0f0f0; border:1px solid #ddd; border-radius:6px; cursor:pointer;">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- Download Modal (Mobile) -->
<div id="downloadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:90%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeDownloadModal()" style="position:absolute; top:5px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:5px;">
            <img id="downloadImg" style="max-width:100%; height:auto;" />
        </div>
        <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
             <button id="downloadBtnMobile" style="padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;">‰øùÂ≠òÂõæÁâá</button>
             <button onclick="closeDownloadModal()" style="padding:8px 20px; background:#1890ff; color:white; border:none; border-radius:6px; cursor:pointer;">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<div id="planSelectionBar" class="selection-bar" style="display: none;">
    <div style="font-weight: bold; color: #333;">Â∑≤ÈÄâÊã© <span id="selectedCount">0</span> ‰∏™ËÆ°Âàí</div>
    <div style="display: flex; gap: 10px;">
        <button class="m-btn m-btn-ghost" onclick="exitPlanSelectionMode()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; white-space: nowrap;">ÂèñÊ∂à</button>
        <button class="m-btn m-btn-primary" onclick="mergeSelectedPlans()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; background: #722ed1; border-color: #722ed1; white-space: nowrap;">ÂêàÂπ∂ËÆ°Âàí</button>
    </div>
</div>

<script>
    const ModelUsageManager = {
        baseLimitPerKey: 20,
        storageKey: 'ai_usage_data',
        defaultKey: "",
        
        defaultModels: [
            'gemini-3-flash-preview',
            'gemini-2.5-flash',
            'gemini-2.5-flash-lite'
        ],
        
        getData() {
            let data = null;
            try {
                data = JSON.parse(localStorage.getItem(this.storageKey));
            } catch (e) {
                data = null;
            }

            // Migration logic
            if (!data || !data.keys) {
                console.log('ModelUsageManager: Initializing or migrating to multi-key structure...');
                const oldApiKey = (data && data.apiKey) ? data.apiKey : this.defaultKey;
                const oldUsage = (data && data.usage) ? data.usage : {};
                const newId = Date.now().toString(); 
                
                return {
                    date: (data && data.date) ? data.date : new Date().toDateString(),
                    activeKeyId: newId,
                    keys: [{
                        id: newId,
                        name: 'ÈªòËÆ§Key',
                        apiKey: oldApiKey,
                        usage: oldUsage
                    }],
                    modelOrder: [...this.defaultModels]
                };
            }
            
            // Ensure modelOrder exists
            if (!data.modelOrder) {
                data.modelOrder = [...this.defaultModels];
                this.saveData(data);
            }
            
            return data;
        },

        saveData(data) {
            localStorage.setItem(this.storageKey, JSON.stringify(data));
        },

        getPTDateTime() {
            // Returns YYYY-MM-DD HH:mm in Pacific Time
            return new Date().toLocaleDateString('en-CA', {
                timeZone: 'America/Los_Angeles',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(',', '');
        },

        getPTDate() {
            // Returns YYYY-MM-DD in Pacific Time (America/Los_Angeles)
            // Works correctly for DST (PDT/PST)
            return new Date().toLocaleDateString('en-CA', {
                timeZone: 'America/Los_Angeles'
            }); // en-CA gives YYYY-MM-DD format
        },

        checkReset() {
            const data = this.getData();
            const today = this.getPTDate();
            if (data.date !== today) {
                console.log(`ModelUsageManager: New day detected (${today}). Resetting all usage.`);
                data.date = today;
                if (data.keys) {
                    data.keys.forEach(k => k.usage = {});
                }
                this.saveData(data);
            }
        },

        // --- Key Management ---
        getKeys() {
            return this.getData().keys;
        },
        
        getActiveKeyId() {
            return this.getData().activeKeyId;
        },
        
        getActiveKey() {
            const data = this.getData();
            return data.keys.find(k => k.id === data.activeKeyId) || data.keys[0];
        },
        
        setActiveKey(id) {
            const data = this.getData();
            if (data.keys.some(k => k.id === id)) {
                data.activeKeyId = id;
                this.saveData(data);
            }
        },
        
        addKey(name, apiKey) {
            const data = this.getData();
            const newId = Date.now().toString();
            data.keys.push({
                id: newId,
                name: name || 'Êñ∞ Key',
                apiKey: apiKey || '',
                usage: {}
            });
            if (data.keys.length === 1) {
                data.activeKeyId = newId;
            }
            this.saveData(data);
            return newId;
        },
        
        updateKey(id, updates) {
            const data = this.getData();
            const key = data.keys.find(k => k.id === id);
            if (key) {
                if (updates.name !== undefined) key.name = updates.name;
                if (updates.apiKey !== undefined) key.apiKey = updates.apiKey;
                this.saveData(data);
            }
        },
        
        deleteKey(id) {
            const data = this.getData();
            const idx = data.keys.findIndex(k => k.id === id);
            if (idx > -1) {
                data.keys.splice(idx, 1);
                
                if (data.activeKeyId === id) {
                    if (data.keys.length > 0) {
                        data.activeKeyId = data.keys[0].id;
                    } else {
                        const newId = Date.now().toString();
                        data.keys.push({ id: newId, name: 'ÈªòËÆ§Key', apiKey: '', usage: {} });
                        data.activeKeyId = newId;
                    }
                }
                this.saveData(data);
            }
        },

        setKeyUsage(keyId, model, usage) {
            const data = this.getData();
            const key = data.keys.find(k => k.id === keyId);
            if (key) {
                let val = parseInt(usage);
                if (isNaN(val) || val < 0) val = 0;
                // Allow setting usage > baseLimitPerKey, but it will effectively be "used up"
                key.usage[model] = val;
                this.saveData(data);
            }
        },

        moveKey(id, direction) {
            const data = this.getData();
            const index = data.keys.findIndex(k => k.id === id);
            if (index === -1) return;

            if (direction === 'up' && index > 0) {
                // Swap with index - 1
                [data.keys[index], data.keys[index - 1]] = [data.keys[index - 1], data.keys[index]];
                this.saveData(data);
            } else if (direction === 'down' && index < data.keys.length - 1) {
                // Swap with index + 1
                [data.keys[index], data.keys[index + 1]] = [data.keys[index + 1], data.keys[index]];
                this.saveData(data);
            }
        },

        moveModel(modelName, direction) {
            const data = this.getData();
            if (!data.modelOrder) data.modelOrder = [...this.defaultModels];
            
            const index = data.modelOrder.indexOf(modelName);
            if (index === -1) return;

            if (direction === 'up' && index > 0) {
                [data.modelOrder[index], data.modelOrder[index - 1]] = [data.modelOrder[index - 1], data.modelOrder[index]];
                this.saveData(data);
            } else if (direction === 'down' && index < data.modelOrder.length - 1) {
                [data.modelOrder[index], data.modelOrder[index + 1]] = [data.modelOrder[index + 1], data.modelOrder[index]];
                this.saveData(data);
            }
        },

        renameModel(oldName, newName) {
            const data = this.getData();
            if (!data.modelOrder) data.modelOrder = [...this.defaultModels];
            
            const index = data.modelOrder.indexOf(oldName);
            if (index > -1 && newName && newName.trim() !== '') {
                data.modelOrder[index] = newName.trim();
                // Also migrate usage data if needed, but for now just rename the list item
                // Ideally we should rename keys in usage objects too, but that's complex. 
                // Since this is just a preference list, it's fine. 
                // However, if the user renames a model that has quota, the quota will be "lost" or reset for the new name.
                // Let's try to migrate usage too.
                if (data.keys) {
                    data.keys.forEach(k => {
                        if (k.usage && k.usage[oldName] !== undefined) {
                            k.usage[newName] = k.usage[oldName];
                            delete k.usage[oldName];
                        }
                    });
                }
                this.saveData(data);
            }
        },

        deleteModel(modelName) {
            const data = this.getData();
            if (!data.modelOrder) data.modelOrder = [...this.defaultModels];
            
            const index = data.modelOrder.indexOf(modelName);
            if (index > -1) {
                data.modelOrder.splice(index, 1);
                
                // Clean up usage data for this model from all keys
                if (data.keys) {
                    data.keys.forEach(k => {
                        if (k.usage && k.usage[modelName] !== undefined) {
                            delete k.usage[modelName];
                        }
                    });
                }
                
                this.saveData(data);
            }
        },

        // --- Global Usage Logic ---
        getModelList() {
            const data = this.getData();
            return data.modelOrder && data.modelOrder.length > 0 ? data.modelOrder : this.defaultModels;
        },

        setModelList(list) {
            const data = this.getData();
            data.modelOrder = list;
            this.saveData(data);
        },

        addModels(newModels) {
            const data = this.getData();
            let current = new Set(data.modelOrder || this.defaultModels);
            let added = false;
            
            newModels.forEach(m => {
                if (!current.has(m)) {
                    current.add(m);
                    added = true;
                }
            });

            if (added) {
                data.modelOrder = Array.from(current);
                this.saveData(data);
            }
            return data.modelOrder;
        },

        getGlobalLimit() {
            const keys = this.getKeys();
            return keys.length * this.baseLimitPerKey;
        },

        getGlobalUsage(model) {
            this.checkReset();
            const keys = this.getKeys();
            return keys.reduce((sum, k) => sum + (k.usage[model] || 0), 0);
        },

        setGlobalRemaining(model, remaining) {
            const data = this.getData();
            const globalLimit = data.keys.length * this.baseLimitPerKey;
            let targetUsed = globalLimit - parseInt(remaining);
            if (isNaN(targetUsed) || targetUsed < 0) targetUsed = 0;
            if (targetUsed > globalLimit) targetUsed = globalLimit;

            // Distribute usage across keys
            data.keys.forEach(k => k.usage[model] = 0);
            
            let remainingToDistribute = targetUsed;
            for (let k of data.keys) {
                if (remainingToDistribute <= 0) break;
                let fill = Math.min(remainingToDistribute, this.baseLimitPerKey);
                k.usage[model] = fill;
                remainingToDistribute -= fill;
            }
            this.saveData(data);
        },

        resetAll() {
             const data = this.getData();
             data.keys.forEach(k => k.usage = {});
             this.saveData(data);
        },

        // --- Key Management & Usage ---
        // Returns { apiKey: string, keyId: string } or null
        getUsableKeyObj(model) {
            this.checkReset();
            const data = this.getData();
            // If model specified, find first key with quota
            if (model) {
                const validKey = data.keys.find(k => (k.usage[model] || 0) < this.baseLimitPerKey);
                if (validKey) return { apiKey: validKey.apiKey, keyId: validKey.id };
            }
            // Fallback: Return active key or first key
            const key = data.keys.find(k => k.id === data.activeKeyId) || data.keys[0];
            return key ? { apiKey: key.apiKey, keyId: key.id } : null;
        },

        getApiKey(model) {
             const keyObj = this.getUsableKeyObj(model);
             return keyObj ? keyObj.apiKey : '';
        },

        canUse(model) {
            this.checkReset();
            const data = this.getData();
            // Check if ANY key has quota for this model
            return data.keys.some(k => (k.usage[model] || 0) < this.baseLimitPerKey);
        },

        increment(model, keyId) {
            this.checkReset();
            const data = this.getData();
            let key;
            
            if (keyId) {
                // Precise increment based on used key
                key = data.keys.find(k => k.id === keyId);
            }
            
            // Fallback logic if no keyId provided or key not found (legacy safety)
            if (!key) {
                key = data.keys.find(k => (k.usage[model] || 0) < this.baseLimitPerKey);
            }
            
            if (key) {
                key.usage[model] = (key.usage[model] || 0) + 1;
                this.saveData(data);
            } else {
                // Should not happen if canUse was checked, but fallback to active
                const active = data.keys.find(k => k.id === data.activeKeyId);
                if (active) {
                    active.usage[model] = (active.usage[model] || 0) + 1;
                    this.saveData(data);
                }
            }
        },
        
        getUsage(model) {
            // Legacy/Fallback helper
            return this.getGlobalUsage(model);
        },

        async logAvailableModels() {
            const apiKey = this.getApiKey();
            if (!apiKey) return;
            console.log("Checking available models...");
            try {
                // Try to list models to see exact names
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();
                if (data.models) {
                    console.log("=== Available Gemini Models (API) ===");
                    const simplified = data.models.map(m => ({
                        id: m.name.replace('models/', ''),
                        displayName: m.displayName,
                        methods: m.supportedGenerationMethods
                    }));
                    console.table(simplified);
                }
            } catch (e) {
                console.warn("Failed to list models:", e);
            }
        }
    };

    // Initialize immediately
    ModelUsageManager.checkReset();
    localStorage.removeItem('ai_model_usage_v1');

    function openAIUsageModal() {
        ModelUsageManager.checkReset();
        
        const ptDateTime = ModelUsageManager.getPTDateTime();
        document.getElementById('aiUsageDate').innerText = `${ptDateTime.replace(/-/g, '/')} (Pacific Time)`;

        switchAITab('quota');
        showModal('aiUsageModal');
        
        // Diagnostic: Log available models to help debug naming issues
        ModelUsageManager.logAvailableModels();
    }

    function switchAITab(tabName) {
        // Update Tabs UI
        ['quota', 'keys', 'models'].forEach(t => {
            const btn = document.getElementById(`tab-btn-${t}`);
            const content = document.getElementById(`tab-content-${t}`);
            
            if (btn && content) {
                if (t === tabName) {
                    btn.className = 'ai-tab active';
                    btn.style.color = '#4a90e2';
                    btn.style.borderBottomColor = '#4a90e2';
                    content.style.display = 'block';
                } else {
                    btn.className = 'ai-tab';
                    btn.style.color = '#666';
                    btn.style.borderBottomColor = 'transparent';
                    content.style.display = 'none';
                }
            }
        });

        if (tabName === 'quota') {
            renderQuotaTab();
        } else if (tabName === 'keys') {
            renderAIKeyList();
        } else if (tabName === 'models') {
            renderModelCollectionTab();
        }
    }

    function renderQuotaTab() {
        const globalLimit = ModelUsageManager.getGlobalLimit();
        const limitEl = document.getElementById('totalDailyLimit');
        if(limitEl) limitEl.innerText = globalLimit;

        const list = document.getElementById('quotaList');
        if(!list) return;
        list.innerHTML = '';

        const models = ModelUsageManager.getModelList();
        
        models.forEach(model => {
            const used = ModelUsageManager.getGlobalUsage(model);
            const remaining = globalLimit - used;
            
            const rowWrapper = document.createElement('div');
            rowWrapper.style.borderBottom = '1px dashed #eee';
            if (models.indexOf(model) === models.length - 1) rowWrapper.style.borderBottom = 'none';

            const row = document.createElement('div');
            row.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px 0;';
            
            row.innerHTML = `
                <div style="flex:1; padding-right: 4px; min-width: 0;">
                    <span style="font-weight: bold; color: #333; font-size:13px; word-break: break-word; line-height: 1.2;">${model}</span>
                </div>
                
                <button onclick="toggleUsageDetails('${model}')" style="background:none; border:none; cursor:pointer; color:#4a90e2; padding:4px; display:flex; align-items:center; justify-content: center; flex-shrink:0; margin-right: 4px;" title="Êü•ÁúãËØ¶ÊÉÖ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </button>

                <div style="display: flex; align-items: center; gap: 3px; flex-shrink: 0;">
                    <span style="font-size:11px; color:#666; white-space:nowrap;">Ââ©‰Ωô:</span>
                    <input type="number" value="${remaining}" 
                           onchange="updateGlobalRemaining('${model}', this.value)"
                           style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px; font-weight:bold; color:#4a90e2; font-size:13px;">
                    <span style="color: #999; font-size: 11px; white-space:nowrap;">/ ${globalLimit}</span>
                </div>
            `;
            
            const detailsDiv = document.createElement('div');
            detailsDiv.id = `details-${model}`;
            detailsDiv.style.display = 'none';
            detailsDiv.style.backgroundColor = '#f0f7ff';
            detailsDiv.style.padding = '8px';
            detailsDiv.style.borderRadius = '6px';
            detailsDiv.style.marginBottom = '8px';
            detailsDiv.style.fontSize = '12px';
            detailsDiv.style.color = '#555';

            rowWrapper.appendChild(row);
            rowWrapper.appendChild(detailsDiv);
            list.appendChild(rowWrapper);
        });
    }

    function toggleUsageDetails(model) {
        const el = document.getElementById(`details-${model}`);
        if (!el) return;
        
        if (el.style.display === 'none') {
            // Render details
            const keys = ModelUsageManager.getKeys();
            let html = '<div style="font-weight:bold; margin-bottom:4px; color:#4a90e2;">ÂêÑ Key ‰ΩøÁî®ËØ¶ÊÉÖ:</div>';
            
            if (keys.length === 0) {
                html += '<div>ÊöÇÊó† Key</div>';
            } else {
                keys.forEach(k => {
                    const u = (k.usage && k.usage[model]) ? k.usage[model] : 0;
                    html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:2px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                        <span>${k.name}</span>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span style="font-size:12px; color:#666;">Â∑≤Áî®:</span>
                            <input type="number" value="${u}" 
                                   onchange="updateKeyUsage('${k.id}', '${model}', this.value)"
                                   style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px; font-size:12px; color:#333;">
                        </div>
                    </div>`;
                });
            }
            
            el.innerHTML = html;
            el.style.display = 'block';
        } else {
            el.style.display = 'none';
        }
    }

    function updateKeyUsage(keyId, model, val) {
        ModelUsageManager.setKeyUsage(keyId, model, val);
        renderQuotaTab(); // Re-render to update global remaining
        // Re-open details
        const el = document.getElementById(`details-${model}`);
        if(el) el.style.display = 'none'; // toggleUsageDetails will open it
        toggleUsageDetails(model);
    }

    function updateGlobalRemaining(model, val) {
        ModelUsageManager.setGlobalRemaining(model, val);
        renderQuotaTab();
    }
    
    function resetAllAIUsage() {
        showModal('resetQuotaConfirmModal');
    }

    function closeResetConfirmModal() {
        document.getElementById('resetQuotaConfirmModal').style.display = 'none';
    }

    function executeResetAllAIUsage() {
        ModelUsageManager.resetAll();
        renderQuotaTab();
        showToast('Â∑≤ÈáçÁΩÆÊâÄÊúâÈ¢ùÂ∫¶');
        closeResetConfirmModal();
    }

    const ICON_EYE = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
    const ICON_EYE_OFF = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;

    function renderAIKeyList() {
        const listEl = document.getElementById('aiKeyList');
        if (!listEl) return;
        listEl.innerHTML = '';
        
        let keys = ModelUsageManager.getKeys();
        
        keys.forEach((k, index) => {
            const div = document.createElement('div');
            div.className = 'ai-key-item';
            div.style.cssText = `
                display: flex; flex-direction: column; gap: 8px; 
                padding: 12px; border-radius: 10px; border: 1px solid #e0e0e0;
                background: #fff; margin-bottom: 10px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            `;
            
            const isFirst = index === 0;
            const isLast = index === keys.length - 1;

            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 24px; height: 24px; display:flex; align-items:center; justify-content:center; background:#f0f2f5; border-radius:50%; color:#666; font-size:12px; font-weight:bold;">${index + 1}</div>
                    <input type="text" value="${k.name}" placeholder="KeyÂêçÁß∞" 
                           onchange="updateKeyName('${k.id}', this.value)"
                           style="flex: 1; border: none; background: transparent; font-weight: bold; color: #333; font-size: 15px; outline: none; border-bottom: 1px dashed transparent;"
                           onfocus="this.style.borderBottomColor='#4a90e2'" onblur="this.style.borderBottomColor='transparent'">
                    
                    <div style="display:flex; gap:2px;">
                        <button onclick="moveKey('${k.id}', 'up')" ${isFirst ? 'disabled' : ''} style="color: ${isFirst ? '#ccc' : '#666'}; background: none; border: none; cursor: ${isFirst ? 'default' : 'pointer'}; padding: 4px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
                        </button>
                        <button onclick="moveKey('${k.id}', 'down')" ${isLast ? 'disabled' : ''} style="color: ${isLast ? '#ccc' : '#666'}; background: none; border: none; cursor: ${isLast ? 'default' : 'pointer'}; padding: 4px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                        </button>
                    </div>

                    <button onclick="deleteKey('${k.id}')" style="color: #ff4d4f; background: none; border: none; font-size: 18px; cursor: pointer; padding: 0 5px; margin-left:5px;">&times;</button>
                </div>
                
                <div style="display: flex; align-items: center; gap: 8px; background: #f9f9f9; padding: 6px 10px; border-radius: 6px; border: 1px solid #eee;">
                    <span style="font-size: 12px; color: #999; font-weight: bold;">Key</span>
                    <input type="password" value="${k.apiKey}" placeholder="AIza..." 
                           onchange="updateKeyVal('${k.id}', this.value)"
                           style="flex: 1; border: none; font-size: 12px; font-family: monospace; color: #555; outline: none; background: transparent;">
                    <button onclick="toggleKeyVis(this)" style="background:none; border:none; cursor:pointer; font-size:14px; padding:0; display:flex; align-items:center; color: #bbb;">${ICON_EYE}</button>
                </div>
            `;
            
            listEl.appendChild(div);
        });
    }

    function moveKey(id, direction) {
        ModelUsageManager.moveKey(id, direction);
        renderAIKeyList();
    }

    function toggleKeyVis(btn) {
        const input = btn.previousElementSibling;
        if (input && input.tagName === 'INPUT') {
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = ICON_EYE_OFF;
                btn.style.color = '#4a90e2';
            } else {
                input.type = 'password';
                btn.innerHTML = ICON_EYE;
                btn.style.color = '#bbb';
            }
        }
    }

    function toggleAddKeyForm() {
        const form = document.getElementById('addKeyForm');
        if (form.style.display === 'none') {
            form.style.display = 'block';
            document.getElementById('newKeyName').focus();
        } else {
            form.style.display = 'none';
        }
    }

    function saveNewKey() {
        const nameInput = document.getElementById('newKeyName');
        const valInput = document.getElementById('newKeyVal');
        const name = nameInput.value.trim();
        const key = valInput.value.trim();
        
        if (!key) {
            alert('ËØ∑ËæìÂÖ• API Key');
            return;
        }
        
        ModelUsageManager.addKey(name || 'Êñ∞ Key', key);
        
        // Reset and hide form
        nameInput.value = '';
        valInput.value = '';
        toggleAddKeyForm();
        
        // Refresh list
        renderAIKeyList();
    }

    function selectKey(id) {
        ModelUsageManager.setActiveKey(id);
        renderAIKeyList(); // Re-render to update styling
    }

    function updateKeyName(id, val) {
        ModelUsageManager.updateKey(id, { name: val });
    }

    function updateKeyVal(id, val) {
        ModelUsageManager.updateKey(id, { apiKey: val });
    }

    let pendingDeleteKeyId = null;

    function deleteKey(id) {
        pendingDeleteKeyId = id;
        showModal('deleteKeyConfirmModal');
    }

    function confirmDeleteKey() {
        if (pendingDeleteKeyId) {
            ModelUsageManager.deleteKey(pendingDeleteKeyId);
            renderAIKeyList();
            pendingDeleteKeyId = null;
        }
        // Only close the confirmation modal, keep the main modal open
        const modal = document.getElementById('deleteKeyConfirmModal');
        if (modal) modal.style.display = 'none';
    }

    // --- Model Collection Management ---
    function renderModelCollectionTab() {
        const listEl = document.getElementById('modelListContainer');
        if (!listEl) return;
        listEl.innerHTML = '';
        
        const models = ModelUsageManager.getModelList();
        
        models.forEach((model, index) => {
            const div = document.createElement('div');
            div.className = 'model-item';
            div.style.cssText = `
                display: flex; align-items: center; gap: 8px; 
                padding: 12px; border-radius: 10px; border: 1px solid #e0e0e0;
                background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            `;
            
            const isFirst = index === 0;
            const isLast = index === models.length - 1;

            div.innerHTML = `
                <div style="width: 24px; height: 24px; display:flex; align-items:center; justify-content:center; background:#f0f2f5; border-radius:50%; color:#666; font-size:12px; font-weight:bold; flex-shrink: 0;">${index + 1}</div>
                
                <div style="flex:1; margin-left: 8px; word-break: break-word; font-weight:bold; color:#333; font-size:13px; line-height: 1.2;">
                    ${model}
                </div>
                
                <div style="display:flex; align-items:center; gap:4px; margin-left:8px;">
                     <button onclick="renameModelFromUI('${model}')" style="background:none; border:none; cursor:pointer; color:#4a90e2; padding:6px; display:flex; align-items:center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    
                    <button onclick="moveModelUI('${model}', 'up')" ${isFirst ? 'disabled' : ''} style="color: ${isFirst ? '#ccc' : '#666'}; background: none; border: none; cursor: ${isFirst ? 'default' : 'pointer'}; padding: 6px; display:flex; align-items:center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
                    </button>
                    
                    <button onclick="moveModelUI('${model}', 'down')" ${isLast ? 'disabled' : ''} style="color: ${isLast ? '#ccc' : '#666'}; background: none; border: none; cursor: ${isLast ? 'default' : 'pointer'}; padding: 6px; display:flex; align-items:center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                    </button>

                    <button onclick="deleteModelFromUI('${model}')" style="color: #ff4d4f; background: none; border: none; font-size: 18px; cursor: pointer; padding: 6px; display:flex; align-items:center; margin-left: 4px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            `;
            
            listEl.appendChild(div);
        });
    }

    function moveModelUI(model, direction) {
        ModelUsageManager.moveModel(model, direction);
        renderModelCollectionTab();
    }

    function addModelFromUI() {
        currentModelEditMode = 'add';
        document.getElementById('modelEditTitle').innerText = 'Ê∑ªÂä†Ê®°Âûã';
        document.getElementById('modelNameInput').value = '';
        showModal('modelEditModal');
        setTimeout(() => document.getElementById('modelNameInput').focus(), 50);
    }

    function renameModelFromUI(oldName) {
        currentModelEditMode = 'rename';
        currentModelOldName = oldName;
        document.getElementById('modelEditTitle').innerText = 'ÈáçÂëΩÂêçÊ®°Âûã';
        document.getElementById('modelNameInput').value = oldName;
        showModal('modelEditModal');
        setTimeout(() => document.getElementById('modelNameInput').focus(), 50);
    }

    function closeModelEditModal() {
        document.getElementById('modelEditModal').style.display = 'none';
        const mask2 = document.getElementById('mask2');
        // If mask2 is visible, hide it (nested case)
        if (mask2 && mask2.style.display === 'block') {
            mask2.style.display = 'none';
        } else {
            // Otherwise, we might be the only modal, check if any others are open
            // If no other modals are open, hide the main mask
            const openModals = Array.from(document.querySelectorAll('.modal')).filter(el => el.style.display === 'block');
            if (openModals.length === 0) {
                document.getElementById('mask').style.display = 'none';
            }
        }
    }

    function submitModelEdit() {
        const nameInput = document.getElementById('modelNameInput');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞');
            return;
        }

        if (currentModelEditMode === 'add') {
            // Check if exists
            const existing = ModelUsageManager.getModelList();
            if (existing.includes(name)) {
                alert('ËØ•Ê®°ÂûãÂ∑≤Â≠òÂú®');
                return;
            }
            ModelUsageManager.addModels([name]);
            
            // Show success feedback
            showToast(`Ê®°Âûã "${name}" Ê∑ªÂä†ÊàêÂäü`);
            
            // Close modal after success
            renderModelCollectionTab();
            renderQuotaTab();
            closeModelEditModal();
            
        } else if (currentModelEditMode === 'rename') {
            if (name !== currentModelOldName) {
                const existing = ModelUsageManager.getModelList();
                if (existing.includes(name)) {
                    alert('ËØ•Ê®°ÂûãÂêçÂ∑≤Â≠òÂú®');
                    return;
                }
                ModelUsageManager.renameModel(currentModelOldName, name);
            }
            renderModelCollectionTab();
            renderQuotaTab();
            closeModelEditModal();
        }
    }

    function deleteModelFromUI(modelName) {
        // currentModelToDelete = modelName; // Deprecated global var usage
        const btn = document.getElementById('btnConfirmDeleteModel');
        if(btn) btn.setAttribute('data-model', modelName);
        
        document.getElementById('modelDeleteMsg').innerText = `Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Âûã "${modelName}" ÂêóÔºü\nÂà†Èô§ÂêéÂ∞Ü‰∏çÂÜçË∞ÉÁî®ËØ•Ê®°Âûã„ÄÇ`;
        showModal('modelDeleteModal');
    }

    function closeModelDeleteModal() {
        document.getElementById('modelDeleteModal').style.display = 'none';
        const mask2 = document.getElementById('mask2');
        if (mask2) mask2.style.display = 'none';
    }

    function confirmDeleteModel() {
        const btn = document.getElementById('btnConfirmDeleteModel');
        const modelName = btn ? btn.getAttribute('data-model') : null;
        
        if (modelName) {
            try {
                ModelUsageManager.deleteModel(modelName);
                renderModelCollectionTab();
                renderQuotaTab();
                closeModelDeleteModal();
                showToast(`Ê®°Âûã "${modelName}" Â∑≤Âà†Èô§`);
            } catch (e) {
                console.error("Delete failed", e);
                alert("Âà†Èô§Â§±Ë¥•: " + e.message);
            }
        }
    }

    function updatePullToRefresh(page) {
        // ÊâãÊú∫Á´ØÔºöÊâ´ÊèèÈ°µÈù¢Á¶ÅÁî®‰∏ãÊãâÂà∑Êñ∞ (prevent pull-to-refresh)
        if (page === 'scan') {
            document.body.style.overscrollBehaviorY = 'contain';
        } else {
            document.body.style.overscrollBehaviorY = 'auto';
        }
    }

    function navTo(page) {
        // Save state for refresh
        localStorage.setItem('mard_last_nav', JSON.stringify({ method: 'navTo', arg: page }));
        
        // Update Pull-to-Refresh behavior
        updatePullToRefresh(page);

        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-beads').style.display = 'none';
        document.getElementById('page-fabric').style.display = 'none';
        document.getElementById('page-stats').style.display = 'none';
        document.getElementById('page-scan').style.display = 'none';

        
        // Hide dock by default, show only for main pages
        document.getElementById('footer-dock').style.display = 'none';
        
        // Handle FAB visibility
        const fab = document.getElementById('floatingBatchAddBtn');
        if(fab) fab.style.display = (page === 'beads') ? 'flex' : 'none';

        const homeBtn = document.getElementById('floatingHomeBtn');
        if(homeBtn) homeBtn.style.display = (page === 'beads') ? 'flex' : 'none';

        if (page === 'home') {
            document.getElementById('page-home').style.display = 'flex';
        } else if (page === 'beads') {
            document.getElementById('page-beads').style.display = 'block';
            document.getElementById('footer-dock').style.display = 'flex'; // Show dock
            checkWelcome();
        } else if (page === 'scan') {
            document.getElementById('page-scan').style.display = 'block';
            document.getElementById('footer-dock').style.display = 'flex';

        } else if (page === 'fabric') {
            document.getElementById('page-fabric').style.display = 'block';
            // Dock remains hidden for fabric page
            
            // Restore Fabric State
            const savedSpecs = localStorage.getItem('fabric_specs');
            if (savedSpecs) {
                specs = JSON.parse(savedSpecs);
                // Force update colors to match current theme (Fixes issue where Spec 3 might be purple)
                if (typeof specColors !== 'undefined') {
                    specs.forEach((s, i) => {
                        if (i < specColors.length) {
                            s.color = specColors[i];
                        }
                    });
                }
            }
            
            // If no specs (first time or cleared), add default
            if(specs.length === 0) {
                addSpec(); 
            } else {
                renderSpecs();
            }

            const savedW = localStorage.getItem('fabric_w');
            const savedH = localStorage.getItem('fabric_h');
            if (savedW) document.getElementById('canvasW').value = savedW;
            if (savedH) document.getElementById('canvasH').value = savedH;
            
            // Restore sort pref after specs are rendered (options need specs)
            setTimeout(() => {
                const savedSort = localStorage.getItem('fabric_sort');
                if (savedSort) {
                     const sortEl = document.getElementById('sortPref');
                     if(sortEl) sortEl.value = savedSort;
                }
                
                // Auto-calculate if data exists (User request: show last operation info)
                if (savedW && savedH && specs.length > 0) {
                    // Check if inputs are valid numbers
                    if (parseFloat(savedW) > 0 && parseFloat(savedH) > 0) {
                        // Check if all specs have valid dimensions
                        const allSpecsValid = specs.every(s => s.w > 0 && s.h > 0);
                        if (allSpecsValid) {
                             // Small delay to ensure UI is ready
                             calculateLayout();
                        }
                    }
                }
            }, 50);
        }
    }

    function showToast(msg, duration = 2000) {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.8); color:white; padding:12px 24px; border-radius:8px; font-size:14px; z-index:9999; text-align:center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: fadeIn 0.2s;';
        toast.innerText = msg;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, duration);
    }

    function openThresholdModal() {
        document.getElementById('thresholdInput').value = threshold;
        showModal('thresholdModal');
        setTimeout(() => document.getElementById('thresholdInput').focus(), 50);
    }

    function saveThreshold() {
        const input = document.getElementById('thresholdInput');
        const val = parseFloat(input.value);
        
        if (!isNaN(val) && val >= 0) {
            threshold = val;
            localStorage.setItem('bead_threshold', threshold);
            render();
            closeAllModals();
            
            showToast(`ÈòàÂÄºÂ∑≤Êõ¥Êñ∞‰∏∫ ${threshold}g`);
        } else {
            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠ó");
        }
    }





    const MARD_DB = [
        {id:'A1',hex:'#faf5cd'},{id:'A2',hex:'#fcfed6'},{id:'A3',hex:'#fcff92'},{id:'A4',hex:'#f7ec5c'},{id:'A5',hex:'#f0d83a'},{id:'A6',hex:'#fda951'},{id:'A7',hex:'#fa8c4f'},{id:'A8',hex:'#fbda4d'},{id:'A9',hex:'#f79d5f'},{id:'A10',hex:'#f47e38'},{id:'A11',hex:'#fedb99'},{id:'A12',hex:'#fda276'},{id:'A13',hex:'#fec667'},{id:'A14',hex:'#f75842'},{id:'A15',hex:'#fbf65e'},{id:'A16',hex:'#feff97'},{id:'A17',hex:'#fde173'},{id:'A18',hex:'#fcbf80'},{id:'A19',hex:'#fd7e77'},{id:'A20',hex:'#f9d66e'},{id:'A21',hex:'#fae393'},{id:'A22',hex:'#edf878'},{id:'A23',hex:'#e4c8ba'},{id:'A24',hex:'#f3f6a9'},{id:'A25',hex:'#ffd785'},{id:'A26',hex:'#ffc734'},
        {id:'B1',hex:'#dff13b'},{id:'B2',hex:'#64f343'},{id:'B3',hex:'#a1f586'},{id:'B4',hex:'#5fdf34'},{id:'B5',hex:'#39e158'},{id:'B6',hex:'#64e0a4'},{id:'B7',hex:'#3eae7c'},{id:'B8',hex:'#1d9b54'},{id:'B9',hex:'#2a5037'},{id:'B10',hex:'#9ad1ba'},{id:'B11',hex:'#627032'},{id:'B12',hex:'#1a6e3d'},{id:'B13',hex:'#c8e87d'},{id:'B14',hex:'#abe84f'},{id:'B15',hex:'#305335'},{id:'B16',hex:'#c0ed9c'},{id:'B17',hex:'#9eb33e'},{id:'B18',hex:'#e6ed4f'},{id:'B19',hex:'#26b78e'},{id:'B20',hex:'#cbeccf'},{id:'B21',hex:'#18616a'},{id:'B22',hex:'#0a4241'},{id:'B23',hex:'#343b1a'},{id:'B24',hex:'#e8faa6'},{id:'B25',hex:'#4e846d'},{id:'B26',hex:'#907c35'},{id:'B27',hex:'#d0e0af'},{id:'B28',hex:'#9ee5bb'},{id:'B29',hex:'#c6df5f'},{id:'B30',hex:'#e3fbb1'},{id:'B31',hex:'#b4e691'},{id:'B32',hex:'#92ad60'},
        {id:'C1',hex:'#f0fee4'},{id:'C2',hex:'#abf8fe'},{id:'C3',hex:'#a2e0f7'},{id:'C4',hex:'#44cdfb'},{id:'C5',hex:'#06aadf'},{id:'C6',hex:'#54a7e9'},{id:'C7',hex:'#3977ca'},{id:'C8',hex:'#0f52bd'},{id:'C9',hex:'#3349c3'},{id:'C10',hex:'#3cbce3'},{id:'C11',hex:'#2aded3'},{id:'C12',hex:'#1e334e'},{id:'C13',hex:'#cde7fe'},{id:'C14',hex:'#d5fcf7'},{id:'C15',hex:'#21c5c4'},{id:'C16',hex:'#1858a2'},{id:'C17',hex:'#02d1f3'},{id:'C18',hex:'#213244'},{id:'C19',hex:'#18869d'},{id:'C20',hex:'#1a70a9'},{id:'C21',hex:'#bcddfc'},{id:'C22',hex:'#6bb1bb'},{id:'C23',hex:'#c8e2fd'},{id:'C24',hex:'#7ec5f9'},{id:'C25',hex:'#a9e8e0'},{id:'C26',hex:'#42adcf'},{id:'C27',hex:'#d0def9'},{id:'C28',hex:'#bdcee8'},{id:'C29',hex:'#364a89'},
        {id:'D1',hex:'#acb7ef'},{id:'D2',hex:'#868dd3'},{id:'D3',hex:'#3554af'},{id:'D4',hex:'#162d7b'},{id:'D5',hex:'#b34ec6'},{id:'D6',hex:'#b37bdc'},{id:'D7',hex:'#8758a9'},{id:'D8',hex:'#e3d2fe'},{id:'D9',hex:'#d5b9f4'},{id:'D10',hex:'#301a49'},{id:'D11',hex:'#beb9e2'},{id:'D12',hex:'#dc99ce'},{id:'D13',hex:'#b5038d'},{id:'D14',hex:'#862993'},{id:'D15',hex:'#2f1f8c'},{id:'D16',hex:'#e2e4f0'},{id:'D17',hex:'#c7d3f9'},{id:'D18',hex:'#9a64b8'},{id:'D19',hex:'#d8c2d9'},{id:'D20',hex:'#9a35ad'},{id:'D21',hex:'#940595'},{id:'D22',hex:'#333a95'},{id:'D23',hex:'#eadbf8'},{id:'D24',hex:'#768ae1'},{id:'D25',hex:'#4950c2'},{id:'D26',hex:'#d6c6eb'},
        {id:'E1',hex:'#f6d4cb'},{id:'E2',hex:'#fcc1dd'},{id:'E3',hex:'#f6bde8'},{id:'E4',hex:'#e8649e'},{id:'E5',hex:'#f0569f'},{id:'E6',hex:'#eb4172'},{id:'E7',hex:'#c53674'},{id:'E8',hex:'#fddbe9'},{id:'E9',hex:'#e376c7'},{id:'E10',hex:'#d13b95'},{id:'E11',hex:'#f7dad4'},{id:'E12',hex:'#f693bf'},{id:'E13',hex:'#b5026a'},{id:'E14',hex:'#fad4bf'},{id:'E15',hex:'#f5c9ca'},{id:'E16',hex:'#fbf4ec'},{id:'E17',hex:'#f7e3ec'},{id:'E18',hex:'#f9c8db'},{id:'E19',hex:'#f6bbd1'},{id:'E20',hex:'#d7c6ce'},{id:'E21',hex:'#c09da4'},{id:'E22',hex:'#b38c9f'},{id:'E23',hex:'#937d8a'},{id:'E24',hex:'#debee5'},
        {id:'F1',hex:'#fe9381'},{id:'F2',hex:'#f63d4b'},{id:'F3',hex:'#ee4e3e'},{id:'F4',hex:'#fb2a40'},{id:'F5',hex:'#e10328'},{id:'F6',hex:'#913635'},{id:'F7',hex:'#911932'},{id:'F8',hex:'#bb0126'},{id:'F9',hex:'#e0677a'},{id:'F10',hex:'#874628'},{id:'F11',hex:'#592323'},{id:'F12',hex:'#f3536b'},{id:'F13',hex:'#f45c45'},{id:'F14',hex:'#fcadb2'},{id:'F15',hex:'#d50527'},{id:'F16',hex:'#f8c0a9'},{id:'F17',hex:'#e89b7d'},{id:'F18',hex:'#d07f4a'},{id:'F19',hex:'#be454a'},{id:'F20',hex:'#c69495'},{id:'F21',hex:'#f2b8c6'},{id:'F22',hex:'#f7c3d0'},{id:'F23',hex:'#ed806c'},{id:'F24',hex:'#e09daf'},{id:'F25',hex:'#e84854'},
        {id:'G1',hex:'#ffe4d3'},{id:'G2',hex:'#fcc6ac'},{id:'G3',hex:'#f1c4a5'},{id:'G4',hex:'#dcb387'},{id:'G5',hex:'#e7b34e'},{id:'G6',hex:'#e3a014'},{id:'G7',hex:'#985c3a'},{id:'G8',hex:'#713d2f'},{id:'G9',hex:'#e4b685'},{id:'G10',hex:'#da8c42'},{id:'G11',hex:'#dac898'},{id:'G12',hex:'#fec993'},{id:'G13',hex:'#b2714b'},{id:'G14',hex:'#8b684c'},{id:'G15',hex:'#f6f8e3'},{id:'G16',hex:'#f2d8c1'},{id:'G17',hex:'#77544e'},{id:'G18',hex:'#ffe3d5'},{id:'G19',hex:'#dd7d41'},{id:'G20',hex:'#a5452f'},{id:'G21',hex:'#b38561'},
        {id:'H1',hex:'#ffffff'},{id:'H2',hex:'#fbfbfb'},{id:'H3',hex:'#b4b4b4'},{id:'H4',hex:'#878787'},{id:'H5',hex:'#464646'},{id:'H6',hex:'#2c2c2c'},{id:'H7',hex:'#010101'},{id:'H8',hex:'#e7d6dc'},{id:'H9',hex:'#efedee'},{id:'H10',hex:'#ebebeb'},{id:'H11',hex:'#cdcdcd'},{id:'H12',hex:'#fdf6ee'},{id:'H13',hex:'#f4efd1'},{id:'H14',hex:'#ced7d4'},{id:'H15',hex:'#9aa6a6'},{id:'H16',hex:'#1b1213'},{id:'H17',hex:'#f0eeef'},{id:'H18',hex:'#fcfff6'},{id:'H19',hex:'#f2eee5'},{id:'H20',hex:'#96a09f'},{id:'H21',hex:'#f8fbe6'},{id:'H22',hex:'#cacad2'},{id:'H23',hex:'#9b9c94'},
        {id:'M1',hex:'#bbc6b6'},{id:'M2',hex:'#909994'},{id:'M3',hex:'#697e81'},{id:'M4',hex:'#e0d4bc'},{id:'M5',hex:'#d1ccaf'},{id:'M6',hex:'#b0aa86'},{id:'M7',hex:'#b0a796'},{id:'M8',hex:'#ae8082'},{id:'M9',hex:'#a68862'},{id:'M10',hex:'#c4b3bb'},{id:'M11',hex:'#9d7693'},{id:'M12',hex:'#644b51'},{id:'M13',hex:'#c79266'},{id:'M14',hex:'#c27563'},{id:'M15',hex:'#747d7a'},
        // PÁ≥ªÂàó (Áè†ÂÖâ)
        {id:'P1',hex:'#F9F9F9'},{id:'P2',hex:'#ABABAB'},{id:'P3',hex:'#B6DBAF'},{id:'P4',hex:'#FEA2A3'},{id:'P5',hex:'#EB903F'},{id:'P6',hex:'#63CEA2'},{id:'P7',hex:'#E79273'},{id:'P8',hex:'#ECDB59'},{id:'P9',hex:'#DBD9DA'},{id:'P10',hex:'#DBC7EA'},{id:'P11',hex:'#F1E9D4'},{id:'P12',hex:'#E9EDEE'},{id:'P13',hex:'#ADCBF1'},{id:'P14',hex:'#337BAD'},{id:'P15',hex:'#668575'},{id:'P16',hex:'#FDC24E'},{id:'P17',hex:'#FDA42E'},{id:'P18',hex:'#FEBDA7'},{id:'P19',hex:'#FFDEE9'},{id:'P20',hex:'#FCBFD1'},{id:'P21',hex:'#E8BEC2'},{id:'P22',hex:'#DFAAA4'},{id:'P23',hex:'#A3656A'},
        // QÁ≥ªÂàó (Ê∏©Âèò)
        {id:'Q1',hex:'#F2A5E8'},{id:'Q2',hex:'#E9EC91'},{id:'Q3',hex:'#FFFF00'},{id:'Q4',hex:'#FFEBFA'},{id:'Q5',hex:'#76CEDE'},
        // RÁ≥ªÂàó (ÈÄèÊòéÊûúÂÜªÊ∞¥Êô∂)
        {id:'R1',hex:'#D40E1F'},{id:'R2',hex:'#F13484'},{id:'R3',hex:'#FB852B'},{id:'R4',hex:'#F8ED33'},{id:'R5',hex:'#32C958'},{id:'R6',hex:'#1EBA93'},{id:'R7',hex:'#1D779C'},{id:'R8',hex:'#1960C8'},{id:'R9',hex:'#945AB1'},{id:'R10',hex:'#F8DA54'},{id:'R11',hex:'#FCECF7'},{id:'R12',hex:'#D8D4D3'},{id:'R13',hex:'#56534E'},{id:'R14',hex:'#A3E7DC'},{id:'R15',hex:'#78CEE7'},{id:'R16',hex:'#3FCDCE'},{id:'R17',hex:'#4E8379'},{id:'R18',hex:'#7DCA9C'},{id:'R19',hex:'#C8E664'},{id:'R20',hex:'#E3CCBA'},{id:'R21',hex:'#A17140'},{id:'R22',hex:'#6B372C'},{id:'R23',hex:'#F6BB6F'},{id:'R24',hex:'#F3C6C0'},{id:'R25',hex:'#C76A62'},{id:'R26',hex:'#D093BC'},{id:'R27',hex:'#E58EAE'},{id:'R28',hex:'#9F85CF'},
        // TÁ≥ªÂàó (ÈÄèÊòé)
        {id:'T1',hex:'#FCFDFF'},
        // YÁ≥ªÂàó (Â§úÂÖâ)
        {id:'Y1',hex:'#FF6FB7'},{id:'Y2',hex:'#FDB583'},{id:'Y3',hex:'#D8FCA4'},{id:'Y4',hex:'#91DAFB'},{id:'Y5',hex:'#E987EA'},{id:'Y6',hex:'#F7D4B8'},{id:'Y7',hex:'#F1FA7D'},{id:'Y8',hex:'#5EE88C'},{id:'Y9',hex:'#F8F5FE'},
        // ZGÁ≥ªÂàó (ÂÖâÂèò)
        {id:'ZG1',hex:'#DAABB3'},{id:'ZG2',hex:'#D6AA87'},{id:'ZG3',hex:'#C1BD8D'},{id:'ZG4',hex:'#96B69F'},{id:'ZG5',hex:'#849DC6'},{id:'ZG6',hex:'#94BFE2'},{id:'ZG7',hex:'#E2A9D2'},{id:'ZG8',hex:'#AB91C0'}
    ];

    let data = JSON.parse(localStorage.getItem('bead_v_sort')) || MARD_DB.map(i => ({...i, w: 0, totalUsed: 0, logs: [], monitor: true}));
    
    // ÂêåÊ≠•Êñ∞Ëâ≤Âè∑ÔºöÊ£ÄÊü• MARD_DB ‰∏≠ÊòØÂê¶ÊúâÊñ∞Ëâ≤Âè∑Êú™Âú® data ‰∏≠
    MARD_DB.forEach(dbItem => {
        let existing = data.find(d => d.id === dbItem.id);
        if (!existing) {
            data.push({...dbItem, w: 0, totalUsed: 0, logs: [], monitor: true});
        } else {
            // ‰øÆÂ§çÔºöÂº∫Âà∂Êõ¥Êñ∞Ëâ≤ÂÄºÔºåËß£ÂÜ≥ÊóßÊï∞ÊçÆÈ¢úËâ≤ÈîôËØØÈóÆÈ¢ò
            if(dbItem.hex) existing.hex = dbItem.hex;
            // Á°Æ‰øùÊóßÊï∞ÊçÆ‰πüÊúâ monitor Â≠óÊÆµ
            if(existing.monitor === undefined) existing.monitor = true;
        }
    });

    let threshold = parseFloat(localStorage.getItem('bead_threshold')) || 5;
    // document.getElementById('threshold').value = threshold; 
    let sel = new Set();
    let selectedSeries = new Set(); // New series filter
    let currentEditId = null;
    let currentModelEditMode = 'add'; // 'add' or 'rename'
    let currentModelOldName = '';
    let currentModelToDelete = null;
    let currentRevertPlanId = null;
    let currentDeletePlanId = null;
    let currentMoveOutPlanId = null;
    let pendingMergePlans = null; // Store plans to be merged while waiting for name input
    let beadSortField = 'id';
    let beadSortOrder = 'asc';

    function setBeadSort(field) {
        if (beadSortField === field) {
            beadSortOrder = beadSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            beadSortField = field;
            // Default sort direction: numbers desc, text asc
            if (field === 'stock' || field === 'used') {
                beadSortOrder = 'desc';
            } else {
                beadSortOrder = 'asc';
            }
        }
        render();
    }

    function formatTime(now) {
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const h = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        return `${y}/${m}/${d} ${h}:${min}:${s}`;
    }



    function createRow(item) {
        const isMonitored = item.monitor !== false;
        const isLow = isMonitored && (item.w < threshold);
        const grainCount = Math.round(item.w * 100);
        
        // ËÆ°ÁÆóÊÄªË°•Ë¥ß
        let totalAdded = 0;
        if (item.totalAdded !== undefined) {
             totalAdded = item.totalAdded;
        } else {
            // ÂÖºÂÆπÈÄªËæëÔºö‰ªé logs ËÆ°ÁÆóÂπ∂ÂàùÂßãÂåñ
            if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type === 'add') totalAdded += (log.val || 0);
                 });
            }
            totalAdded = parseFloat(totalAdded.toFixed(2));
            // ÂàùÂßãÂåñÂ≠óÊÆµ‰ª•‰æøÂêéÁª≠Á¥ØÂä†
            item.totalAdded = totalAdded; 
        }
        
        // ËÆ°ÁÆóÊÄªÊ∂àËÄó
        let totalUsed = 0;
        if (item.totalUsed !== undefined) {
             totalUsed = item.totalUsed;
        } else {
             // ÂÖºÂÆπÈÄªËæëÔºö‰ªé logs ËÆ°ÁÆóÂπ∂ÂàùÂßãÂåñ
             if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type !== 'add') {
                         const count = log.c || log.val || 0;
                         const g = parseFloat((count / 100).toFixed(2));
                         totalUsed += g;
                     }
                 });
             }
             totalUsed = parseFloat(totalUsed.toFixed(2));
             item.totalUsed = totalUsed; 
        }
        
        const monitorIcon = !isMonitored ? '<span style="font-size:12px; margin-left:2px; opacity:0.5;">üîï</span>' : '';
        const lowStyle = isLow ? 'color:#ff4d4f;' : 'color:#8c8c8c;';

        const row = document.createElement('div');
        row.className = `bead-card ${sel.has(item.id) ? 'selected' : ''}`;
        


        row.onclick = () => {
            if (sel.size > 0) {
                toggleSelect(item.id);
            }
        };
        
        row.innerHTML = `
            <div class="card-header">
                <div class="card-check"></div>
            </div>
            
            <div class="card-color-block" style="background:${item.hex};" onclick="if(sel.size===0) { event.stopPropagation(); manualEdit('${item.id}'); }"></div>

            <div class="card-info-section" style="padding: 0 2px;">
                 <!-- Color Code Line & Detail Icon -->
                 <div class="card-id-line" style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 4px;">
                     <span style="font-weight: bold; font-size: 14px; color: #333;">${item.id} ${monitorIcon}</span>
                     <button onclick="event.stopPropagation(); openHistory('${item.id}')" style="background:none; border:none; padding:2px; color:#888; cursor:pointer; display:flex; align-items:center; line-height: 0;">
                        <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <circle cx="10" cy="14" r="3"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                     </button>
                 </div>

                 <!-- Weight & Grain -->
                 <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; white-space: nowrap;">
                     <div class="card-weight" style="${lowStyle}; font-size: 14px; font-weight: bold;">${item.w}<span class="card-unit" style="font-size:10px;">g</span></div>
                     <div class="card-grain" style="font-size: 10px; color: #999; margin-left: 4px;">‚âà${grainCount}Á≤í</div>
                 </div>
            </div>
        `;
        return row;
    }

    function toggleSeries(s) {
        if (selectedSeries.has(s)) {
            selectedSeries.delete(s);
        } else {
            selectedSeries.add(s);
        }
        
        // Update UI
        const container = document.getElementById('series-filter-container');
        Array.from(container.children).forEach(chip => {
            if (selectedSeries.has(chip.innerText)) {
                chip.classList.add('selected');
            } else {
                chip.classList.remove('selected');
            }
        });
        
        render();
    }

    function toggleFilterVisibility() {
        const seriesContainer = document.getElementById('series-filter-container');
        const summaryBar = document.getElementById('bead-summary-bar');
        const btn = document.getElementById('btn-toggle-filter');
        
        // Toggle based on current state (assuming both sync, or base on summaryBar)
        if (summaryBar.style.display === 'none') {
            seriesContainer.style.display = 'flex';
            summaryBar.style.display = 'block';
            btn.style.background = '#e6f7ff';
            btn.style.borderColor = '#91d5ff';
        } else {
            seriesContainer.style.display = 'none';
            summaryBar.style.display = 'none';
            btn.style.background = '#fff';
            btn.style.borderColor = '#ddd';
        }
    }

    function render() {
        const q = document.getElementById('search').value.toUpperCase();
        
        // Ëé∑ÂèñÂΩìÂâçÁ≥ªÂàóÁ≠õÈÄâÁä∂ÊÄÅ
        let seriesMode = document.getElementById('seriesFilter').value;
        // ‰øùÂ≠òÂà∞ localStorage
        localStorage.setItem('bead_series_filter', seriesMode);

        // Update series chips visibility
        const extraSeries = ['P', 'Q', 'R', 'T', 'Y', 'ZG'];
        const container = document.getElementById('series-filter-container');
        if (container) {
            Array.from(container.children).forEach(chip => {
                const s = chip.innerText;
                if (extraSeries.includes(s)) {
                    // Hide special series if mode is 221
                    if (seriesMode === '221') {
                        chip.style.display = 'none';
                        // If hidden chip was selected, deselect it
                        if (selectedSeries.has(s)) {
                            selectedSeries.delete(s);
                            chip.classList.remove('selected');
                        }
                    } else {
                        chip.style.display = ''; // Restore visibility
                    }
                }
            });
        }

        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        // Update Selection Mode Class
        if (sel.size > 0) {
            if(grid.parentElement) grid.parentElement.classList.add('selection-mode');
        } else {
            if(grid.parentElement) grid.parentElement.classList.remove('selection-mode');
        }
        
        // 1. Filter by Series
        let displayData = data.filter(item => {
            const match = item.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';

            // New: Checkbox filter‰ºòÂÖà
            if (selectedSeries.size > 0) {
                return selectedSeries.has(series);
            }

            if (seriesMode === 'all') return true;
            // Mard 221 Ê®°Âºè‰∏ãÊéíÈô§ P, Q, R, T, Y, ZG Á≥ªÂàó
            return !extraSeries.includes(series);
        });

        // 2. Pre-calculate Stats & Contextual Summary
        let sumStock = 0;
        let sumUsed = 0;
        let sumLow = 0;

        displayData.forEach(item => {
            // Ensure totalUsed is calculated (logic from createRow)
            if (item.totalUsed === undefined) {
                 let tu = 0;
                 if(item.logs) {
                     item.logs.forEach(log => {
                         if(log.type !== 'add') {
                             const count = log.c || log.val || 0;
                             const g = parseFloat((count / 100).toFixed(2));
                             tu += g;
                         }
                     });
                 }
                 item.totalUsed = parseFloat(tu.toFixed(2));
            }

            sumStock += item.w;
            sumUsed += (item.totalUsed || 0);

            // Low Stock Check (monitor enabled and below threshold)
            if (item.monitor !== false && item.w < threshold) {
                sumLow++;
            }
        });

        // Update Summary Bar
        const elSumTotal = document.getElementById('sum-total-stock');
        const elSumUsed = document.getElementById('sum-total-used');
        const elSumLow = document.getElementById('sum-low-count');
        if(elSumTotal) elSumTotal.innerText = sumStock.toFixed(0);
        if(elSumUsed) elSumUsed.innerText = sumUsed.toFixed(0);
        if(elSumLow) elSumLow.innerText = sumLow;

        // 3. Calculate Badge Low Count (Dropdown only, ignore Chips for consistency with badge behavior)
        let badgeLowCount = 0;
        data.forEach(d => {
             if (d.monitor === false || d.w >= threshold) return;
             if (seriesMode === 'all') {
                 badgeLowCount++;
                 return;
             }
             const match = d.id.match(/^[A-Z]+/);
             const series = match ? match[0] : '';
             if (!extraSeries.includes(series)) {
                 badgeLowCount++;
             }
        });
        const elCountLow = document.getElementById('count-low');
        if(elCountLow) elCountLow.innerText = badgeLowCount;

        // 4. Update Sort Buttons UI
        const sortMap = {
            'id': 'btn-sort-id',
            'stock': 'btn-sort-stock',
            'used': 'btn-sort-used'
        };
        
        Object.keys(sortMap).forEach(key => {
            const btn = document.getElementById(sortMap[key]);
            if(btn) {
                if (key === beadSortField) {
                     btn.classList.add('active');
                     const arrow = btn.querySelector('.sort-arrow');
                     if(arrow) arrow.innerText = beadSortOrder === 'asc' ? '‚Üë' : '‚Üì';
                } else {
                     btn.classList.remove('active');
                     const arrow = btn.querySelector('.sort-arrow');
                     if(arrow) arrow.innerText = '';
                }
            }
        });

        // 5. Sort Data
        displayData.sort((a, b) => {
            let valA, valB;
            
            if (beadSortField === 'stock') {
                valA = a.w; valB = b.w;
                return beadSortOrder === 'asc' ? valA - valB : valB - valA;
            } else if (beadSortField === 'used') {
                valA = a.totalUsed || 0; valB = b.totalUsed || 0;
                return beadSortOrder === 'asc' ? valA - valB : valB - valA;
            } else {
                // ID
                valA = a.id; valB = b.id;
                const cmp = valA.localeCompare(valB, undefined, {numeric: true, sensitivity: 'base'});
                return beadSortOrder === 'asc' ? cmp : -cmp;
            }
        });

        // 6. Render Grid (Apply Search Filter)
        displayData.forEach(item => {
            if (item.id.includes(q)) {
                grid.appendChild(createRow(item));
            }
        });
        
        save();
    }



    function toggleSelect(id) {
        sel.has(id) ? sel.delete(id) : sel.add(id);
        updateFooter();
        render();
    }
    
    function cancelSelection() {
        sel.clear();
        updateFooter();
        render();
    }

    function batchSetMonitor(enable) {
        if (sel.size === 0) return;
        sel.forEach(id => {
            const item = data.find(d => d.id === id);
            if(item) item.monitor = enable;
        });
        save();
        cancelSelection();
        showToast(enable ? "Â∑≤ÂºÄÂêØÈÄâ‰∏≠Ëâ≤Âè∑ÁöÑÈòàÂÄºÊèêÈÜí" : "Â∑≤ÂÖ≥Èó≠ÈÄâ‰∏≠Ëâ≤Âè∑ÁöÑÈòàÂÄºÊèêÈÜí");
    }
    
    function updateFooter() {
        document.getElementById('footer').style.display = sel.size > 0 ? 'flex' : 'none';
        document.getElementById('selNum').innerText = sel.size;
    }

    function quickAdd(id) {
        const item = data.find(d => d.id === id);
        const addVal = 10;
        item.w = parseFloat((item.w + addVal).toFixed(2));
        // Áª¥Êä§ÊÄªË°•Ë¥ßÈáè
        item.totalAdded = parseFloat(((item.totalAdded || 0) + addVal).toFixed(2));
        
        // ËÆ∞ÂΩïË°•Ë¥ßÊó•Âøó
        const now = new Date();
        const dateStr = formatTime(now);
        if(!item.logs) item.logs = [];
        item.logs.push({ d: dateStr, type: 'add', val: addVal });
        if(item.logs.length > 20) item.logs.shift(); // Â¢ûÂä†Êó•Âøó‰øùÁïôÊù°Êï∞
        
        save(); // Â¢ûÂä†‰øùÂ≠ò
        render();
        showToast("Â∫ìÂ≠òÂ∑≤Â¢ûÂä†");
    }

    function manualEdit(id) {
        currentEditId = id;
        const item = data.find(d => d.id === id);
        document.getElementById('editWeightModalTitle').innerText = `‰øÆÊîπÂ∫ìÂ≠òÈáçÈáè ${id}`;
        const input = document.getElementById('editWeightInput');
        input.value = item.w;
        showModal('editWeightModal');
        setTimeout(() => input.focus(), 50);
        
        // ÁªëÂÆöÂõûËΩ¶‰∫ã‰ª∂
        input.onkeydown = function(e) {
            if(e.key === 'Enter') submitEditWeight();
        }
    }

    function openRestockModal() {
        if(!currentEditId) return;
        document.getElementById('restockTitle').innerText = `Ê≠£Âú®‰∏∫Ëâ≤Âè∑ [${currentEditId}] Ë°•Ë¥ß`;
        document.getElementById('restockInput').value = '';
        showModal('restockModal');
        setTimeout(() => document.getElementById('restockInput').focus(), 50);
        
        document.getElementById('restockInput').onkeydown = function(e) {
            if(e.key === 'Enter') submitRestock();
        }
    }

    function submitRestock() {
        const val = parseFloat(document.getElementById('restockInput').value);
        if(!currentEditId || isNaN(val) || val <= 0) {
            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË°•Ë¥ßÈáçÈáè");
            return;
        }
        
        const item = data.find(d => d.id === currentEditId);
        item.w = parseFloat((item.w + val).toFixed(2));
        // Áª¥Êä§ÊÄªË°•Ë¥ßÈáè
        item.totalAdded = parseFloat(((item.totalAdded || 0) + val).toFixed(2));
        
        // ËÆ∞ÂΩïÊó•Âøó
        const now = new Date();
        const dateStr = formatTime(now);
        if(!item.logs) item.logs = [];
        item.logs.push({ d: dateStr, type: 'add', val: val });
        if(item.logs.length > 20) item.logs.shift();
        
        save();
        render();
        closeAllModals();
        showToast(`Â∑≤ÊàêÂäüË°•Ë¥ß ${val}g`);
    }

    function openHistory(id) {
        const item = data.find(d => d.id === id);
        if(!item) return; // ÂÆπÈîôÂ§ÑÁêÜ

        // 1. ËÆæÁΩÆÊ†áÈ¢òÂíåÊ¶ÇËßàÊï∞ÊçÆ
        document.getElementById('historyTitle').innerHTML = `Ëâ≤Âè∑ ${id} ÊòéÁªÜ`;
        document.getElementById('hist-stock').innerText = (item.w || 0) + 'g';
        document.getElementById('hist-used').innerText = (item.totalUsed || 0) + 'g';
        
        // ËÆ°ÁÆóÊÄªË°•ÂÖÖÔºö‰ºòÂÖà‰ΩøÁî®ÊåÅ‰πÖÂåñÂ≠óÊÆµ
        let totalAdded = 0;
        if (item.totalAdded !== undefined) {
            totalAdded = item.totalAdded;
        } else {
            if(item.logs) {
                item.logs.forEach(log => {
                    if(log.type === 'add') {
                        totalAdded += (log.val || 0);
                    }
                });
            }
        }
        document.getElementById('hist-added').innerText = parseFloat(totalAdded.toFixed(2)) + 'g';

        // ËÆ°ÁÆóÊÄªÊ∂àËÄó
        let totalUsed = 0;
        if (item.totalUsed !== undefined) {
             totalUsed = item.totalUsed;
        } else {
             if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type !== 'add') {
                         const count = log.c || log.val || 0;
                         const g = parseFloat((count / 100).toFixed(2));
                         totalUsed += g;
                     }
                 });
             }
        }
        document.getElementById('hist-used').innerText = parseFloat(totalUsed.toFixed(2)) + 'g';

        // 2. Ê∏≤ÊüìËÆ∞ÂΩïË°®Ê†º
        const tbody = document.getElementById('historyList');
        tbody.innerHTML = '';
        
        if (item.logs && item.logs.length > 0) {
            // ÁªôÊó•ÂøóÂä†‰∏äÂéüÂßãÁ¥¢ÂºïÔºåÊñπ‰æøÂà†Èô§
            const logsWithIdx = item.logs.map((log, idx) => ({...log, idx}));
            
            // ÂÄíÂ∫èÊòæÁ§∫
            logsWithIdx.reverse().forEach(log => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f0f0f0';
                
                // --- Êó∂Èó¥Âàó ---
                const tdTime = document.createElement('td');
                tdTime.style.padding = '6px 2px';
                tdTime.style.color = '#666';
                tdTime.style.fontSize = '11px';
                tdTime.style.whiteSpace = 'nowrap';
                
                let timeStr = log.d;
                if (!timeStr && log.date) {
                    try {
                        const dateObj = new Date(log.date);
                        timeStr = formatTime(dateObj);
                    } catch(e) {
                        timeStr = log.date;
                    }
                }
                
                if (timeStr && timeStr.indexOf(' ') > -1) {
                    const parts = timeStr.split(' ');
                    const datePart = parts[0];
                    const timePart = parts.slice(1).join(' ');
                    tdTime.innerHTML = `<div style="line-height:1.2">${datePart}<br><span style="font-size:10px; color:#999;">${timePart}</span></div>`;
                } else {
                    tdTime.innerText = timeStr || '-';
                }
                tr.appendChild(tdTime);

                // --- ÂõæÁ∫∏ÂêçÁß∞Âàó ---
                const tdDrawing = document.createElement('td');
                tdDrawing.style.padding = '6px 2px';
                tdDrawing.style.textAlign = 'left';
                tdDrawing.style.color = '#666';
                tdDrawing.style.fontSize = '12px';
                tdDrawing.style.whiteSpace = 'nowrap';
                tdDrawing.innerText = log.drawingName || '';
                tr.appendChild(tdDrawing);
                
                // --- Êìç‰ΩúÁ±ªÂûãÂàó ---
                const tdType = document.createElement('td');
                tdType.style.padding = '6px 2px';
                tdType.style.textAlign = 'center';
                tdType.style.whiteSpace = 'nowrap';
                
                let typeText = '';
                let typeColor = '#333';
                
                if (log.type === 'add') {
                    typeText = 'Ë°•Ë¥ß';
                    typeColor = '#52c41a'; // ÁªøËâ≤
                } else {
                    typeText = 'Ê∂àËÄó';
                    typeColor = '#ff4d4f'; // Á∫¢Ëâ≤
                }
                
                tdType.innerHTML = `<span style="background:${typeColor}15; color:${typeColor}; padding:2px 6px; border-radius:4px; font-size:11px;">${typeText}</span>`;
                tr.appendChild(tdType);
                
                // --- ÈáçÈáè/Á≤íÊï∞ÂèäÂà†Èô§Âàó ---
                const tdVal = document.createElement('td');
                tdVal.style.padding = '6px 2px';
                tdVal.style.textAlign = 'left';
                tdVal.style.whiteSpace = 'nowrap';
                
                let valHtml = '';
                if (log.type === 'add') {
                    valHtml = `<div style="line-height:1.2"><span style="color:#333;">+${log.val}g</span></div>`;
                } else {
                    const count = log.c || log.val || 0;
                    const weight = (count / 100).toFixed(2);
                    // Á¨¨‰∏ÄË°åÊòæÁ§∫ÈáçÈáèÔºåÁ¨¨‰∫åË°åÊòæÁ§∫Á≤íÊï∞
                    valHtml = `<div style="line-height:1.2"><span style="color:#333;">-${weight}g</span><br><span style="font-size:10px; color:#999;">(‚âà${count}Á≤í)</span></div>`;
                }
                
                // Âà†Èô§ÊåâÈíÆ
                const delBtn = `<button onclick="deleteLog('${id}', ${log.idx})" style="margin-left:8px; border:none; background:none; color:#999; cursor:pointer; font-size:16px; padding:0;">√ó</button>`;
                
                tdVal.innerHTML = `<div style="display:flex; align-items:center; justify-content:flex-start;"><div style="white-space:nowrap;">${valHtml}</div>${delBtn}</div>`;
                tr.appendChild(tdVal);
                
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="padding:20px; text-align:center; color:#999;">ÊöÇÊó†ËÆ∞ÂΩï</td>';
            tbody.appendChild(tr);
        }
        
        showModal('historyModal');
    }

    function deleteLog(id, logIdx) {
        // One-click delete (no confirm)
        
        const item = data.find(d => d.id === id);
        if(!item || !item.logs || !item.logs[logIdx]) return;
        
        const log = item.logs[logIdx];
        
        if (log.type === 'add') {
            // ÂõûÊªöË°•Ë¥ßÔºöÂáèÂ∞ëÂ∫ìÂ≠ò
            item.w = Math.max(0, parseFloat((item.w - log.val).toFixed(2)));
            // ÂõûÊªöÊÄªË°•Ë¥ß
            item.totalAdded = Math.max(0, parseFloat(((item.totalAdded || 0) - log.val).toFixed(2)));
        } else {
            // ÂõûÊªöÊ∂àËÄóÔºöÂ¢ûÂä†Â∫ìÂ≠òÔºåÂáèÂ∞ëÁ¥ØËÆ°Ê∂àËÄó
            const count = log.c || log.val || 0;
            const g = parseFloat((count / 100).toFixed(2));
            item.w = parseFloat((item.w + g).toFixed(2));
            item.totalUsed = Math.max(0, parseFloat((item.totalUsed - g).toFixed(2)));
        }
        
        // Âà†Èô§ËÆ∞ÂΩï
        item.logs.splice(logIdx, 1);
        
        save();
        render();
        // Ëá™Âä®ÂÖ≥Èó≠ÂºπÁ™ó
        closeAllModals();
        showToast("Âà†Èô§ÊàêÂäüÔºåÂ∫ìÂ≠òÂ∑≤ÂõûÊªö");
    }

    function submitEditWeight() {
        if(!currentEditId) return;
        const input = document.getElementById('editWeightInput');
        const val = parseFloat(input.value);
        
        // ‰øùÊåÅÂéüÊúâÈÄªËæëÔºöËæìÂÖ•Êó†ÊïàÊï∞Â≠óÂàôËßÜ‰∏∫0
        const finalVal = (!isNaN(val) && val >= 0) ? val : 0;
        
        const item = data.find(d => d.id === currentEditId);
        if(item) {
            const oldVal = item.w;
            const diff = finalVal - oldVal;
            
            // Êõ¥Êñ∞Â∫ìÂ≠ò
            item.w = parseFloat(finalVal.toFixed(2));
            
            // Ëá™Âä®ËÆ∞ÂΩïÊó•Âøó (ÂøΩÁï•ÊûÅÂ∞èÂ∑ÆÂºÇ)
            if (Math.abs(diff) > 0.001) {
                const now = new Date();
                const dateStr = formatTime(now);
                if(!item.logs) item.logs = [];
                
                if (diff > 0) {
                    const addedVal = parseFloat(diff.toFixed(2));
                    // Â¢ûÂä†Â∫ìÂ≠ò -> ËßÜ‰∏∫Ë°•Ë¥ß
                    item.logs.push({ d: dateStr, type: 'add', val: addedVal, isManual: true });
                    // Áª¥Êä§ÊÄªË°•Ë¥ßÈáè
                    item.totalAdded = parseFloat(((item.totalAdded || 0) + addedVal).toFixed(2));
                } else {
                    // ÂáèÂ∞ëÂ∫ìÂ≠ò -> ËßÜ‰∏∫Ê∂àËÄó
                    const loss = -diff;
                    // Êõ¥Êñ∞Á¥ØËÆ°Ê∂àËÄó
                    item.totalUsed = parseFloat(((item.totalUsed || 0) + loss).toFixed(2));
                    // ËÆ∞ÂΩï‰∏∫Ê∂àËÄó (ÊäòÁÆó‰∏∫Á≤íÊï∞ÔºåÂÅáËÆæ 1g = 100 Á≤í)
                    item.logs.push({ d: dateStr, c: Math.round(loss * 100), isManual: true });
                }
                
                if(item.logs.length > 20) item.logs.shift();
            }
            
            render();
        }
        
        closeAllModals();
        currentEditId = null;
        input.onkeydown = null;
        showToast("Â∫ìÂ≠ò‰øÆÊîπÊàêÂäü");
    }

    function openConsumeModal() {
        const listDiv = document.getElementById('modalList');
        listDiv.innerHTML = '';
        
        if (sel.size === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px;">Êú™ÈÄâÊã©‰ªª‰ΩïËâ≤Âè∑</div>';
            showModal('consumeModal');
            return;
        }

        sel.forEach(id => {
            const item = data.find(d => d.id === id);
            const currentStockGrains = Math.round(item.w * 100); // ÂΩìÂâçÂ∫ìÂ≠òÁ≤íÊï∞
            
            const row = document.createElement('div');
            row.className = 'modal-row';
            // ‰ΩøÁî®Ëá™ÂÆö‰πâÊ†∑ÂºèË¶ÜÁõñÈªòËÆ§ modal-row
            row.style.cssText = 'display:flex; flex-direction:column; padding: 12px; border-bottom: 1px solid #f0f0f0; background:white; align-items: stretch;';
            
            row.innerHTML = `
                <div style="display:flex; align-items:center; justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap: 12px;">
                        <div class="swatch" style="width:28px; height:28px; background:${item.hex}; border-radius:50%; border:1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>
                        <div style="display:flex; flex-direction:column;">
                            <b style="font-size:16px; color:#333;">${id}</b>
                            <span style="font-size:11px; color:#999;">Â∫ìÂ≠ò: ${currentStockGrains}Á≤í</span>
                        </div>
                    </div>
                    <div style="position:relative;">
                        <input type="number" class="consume-input" data-id="${id}" data-stock="${currentStockGrains}" placeholder="0" oninput="checkConsumeLimit(this)" 
                               style="width: 70px; padding: 8px 5px; border: 1px solid #e0e0e0; border-radius: 8px; text-align: center; font-size: 16px; font-weight:bold; color:#333; outline:none; background:#f9fafb; transition: all 0.2s;">
                    </div>
                </div>
                <div class="limit-warn" id="warn-${id}" style="width:100%; color:#ff4d4f; font-size:11px; margin-top:8px; display:none; text-align:right; background:#fff1f0; padding:4px 8px; border-radius:4px;">
                     ‚ö†Ô∏è Ê∂àËÄóÈáèË∂ÖËøáÂ∫ìÂ≠ò (${currentStockGrains})
                </div>
            `;
            listDiv.appendChild(row);
        });
        
        // ÂéªÈô§ÊúÄÂêé‰∏ÄË°åËæπÊ°Ü
        if(listDiv.lastChild) listDiv.lastChild.style.borderBottom = 'none';
        
        showModal('consumeModal');
        
        // Ëá™Âä®ËÅöÁÑ¶Á¨¨‰∏Ä‰∏™ËæìÂÖ•Ê°Ü
        setTimeout(() => {
            const firstInput = listDiv.querySelector('input');
            if(firstInput) firstInput.focus();
        }, 100);
    }

    function checkConsumeLimit(input) {
        const val = parseFloat(input.value) || 0;
        const stock = parseFloat(input.getAttribute('data-stock'));
        const id = input.getAttribute('data-id');
        const warnEl = document.getElementById(`warn-${id}`);
        
        if (val > stock) {
            warnEl.style.display = 'block';
        } else {
            warnEl.style.display = 'none';
        }
    }

    function submitConsume() {
        const inputs = document.querySelectorAll('.consume-input');
        const now = new Date();
        const dateStr = formatTime(now);
        
        inputs.forEach(input => {
            const id = input.getAttribute('data-id');
            const count = parseFloat(input.value) || 0;
            if(count > 0) {
                const item = data.find(d => d.id === id);
                const g = count / 100;
                item.w = Math.max(0, parseFloat((item.w - g).toFixed(2)));
                item.totalUsed = parseFloat(((item.totalUsed || 0) + g).toFixed(2));
                if(!item.logs) item.logs = [];
                item.logs.push({ d: dateStr, c: count });
                if(item.logs.length > 10) item.logs.shift();
            }
        });
        closeAllModals();
        sel.clear();
        document.getElementById('footer').style.display = 'none';
        save();
        render();
        showToast("Â∫ìÂ≠òÊâ£Èô§ÊàêÂäü");
    }

    // --- Generic Confirmation Modal ---
    function showConfirmModal(title, message, onConfirm) {
        document.getElementById('customConfirmTitle').innerText = title;
        document.getElementById('customConfirmMessage').innerText = message;
        
        const modal = document.getElementById('customConfirmModal');
        // Ensure it is on top of other modals
        modal.style.zIndex = '1050'; 
        
        const okBtn = document.getElementById('customConfirmOkBtn');
        const cancelBtn = document.getElementById('customConfirmCancelBtn');

        // Reset onclick to avoid multiple bindings
        okBtn.onclick = () => {
            if (onConfirm) onConfirm();
            closeAllModals();
        };
        
        // Handle Cancel: Close only this modal if others are open
        cancelBtn.onclick = () => {
            modal.style.display = 'none';
            // Check if any other modal is visible
            const others = Array.from(document.querySelectorAll('.modal')).some(m => m.style.display !== 'none' && m.id !== 'customConfirmModal');
            if (!others) {
                document.getElementById('mask').style.display = 'none';
            }
        };
        
        showModal('customConfirmModal');
    }

    function showModal(id) {
        // Check if any other modal is already open
        const openModals = Array.from(document.querySelectorAll('.modal')).filter(el => el.style.display === 'block' && el.id !== id);
        
        if (openModals.length > 0) {
            // Nested modal
            const mask2 = document.getElementById('mask2');
            if (mask2) {
                mask2.style.display = 'block';
                // Enforce blur style
                mask2.style.backdropFilter = 'blur(8px)';
                mask2.style.webkitBackdropFilter = 'blur(8px)';
            }
            document.getElementById(id).style.zIndex = '1020';
        } else {
            // First modal
            const mask = document.getElementById('mask');
            mask.style.display = 'block';
            // Enforce blur style
            mask.style.backdropFilter = 'blur(8px)';
            mask.style.webkitBackdropFilter = 'blur(8px)';
            document.getElementById(id).style.zIndex = '1010';
        }
        document.getElementById(id).style.display = 'block';
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(el => {
            el.style.display = 'none';
            // Reset z-index
            el.style.zIndex = ''; 
        });
        document.getElementById('mask').style.display = 'none';
        const mask2 = document.getElementById('mask2');
        if (mask2) mask2.style.display = 'none';
    }

    // ÂÖºÂÆπÊóßÂáΩÊï∞Ë∞ÉÁî®ÔºåÈò≤Ê≠¢ÈÅóÊºè
    function closeModal() { closeAllModals(); }

    function save() { localStorage.setItem('bead_v_sort', JSON.stringify(data)); }

    // --- Êï∞ÊçÆÁÆ°ÁêÜÂäüËÉΩ ---
    function openDataModal(tab) {
        showModal('dataModal');
        switchDataTab(tab);
        // Clean up previous inputs
        if(tab !== 'backup') {
            document.getElementById('restoreInput').value = '';
        }
    }

    function switchDataTab(tab) {
        // Reset styles
        ['tabBackup', 'tabRestore'].forEach(id => {
            const el = document.getElementById(id);
            el.style.fontWeight = 'normal';
            el.style.color = '#666';
            el.style.borderBottom = '2px solid transparent';
            el.classList.remove('active');
        });

        // Set active style
        const activeId = tab === 'backup' ? 'tabBackup' : 'tabRestore';
        const activeEl = document.getElementById(activeId);
        activeEl.style.fontWeight = 'bold';
        activeEl.style.color = '#4a90e2';
        activeEl.style.borderBottom = '2px solid #4a90e2';
        activeEl.classList.add('active');

        document.getElementById('viewBackup').style.display = tab==='backup' ? 'block' : 'none';
        document.getElementById('viewRestore').style.display = tab==='restore' ? 'block' : 'none';

        // Toggle footer buttons
        document.getElementById('btnBackupAction').style.display = tab==='backup' ? 'flex' : 'none';
        document.getElementById('btnRestoreAction').style.display = tab==='restore' ? 'flex' : 'none';
    }

    function execRestore() {
        let content = document.getElementById('restoreInput').value;
        if (!content) return;
        
        showModal('importConfirmModal');
    }

    function confirmImport() {
        let content = document.getElementById('restoreInput').value;
        if (!content) return;

        // ÁßªÈô§ÂèØËÉΩÁöÑ BOM
        if (content.charCodeAt(0) === 0xFEFF) {
            content = content.slice(1);
        }
        content = content.trim();

        let jsonStr = content;

        // Ê£ÄÊµãÊòØÂê¶‰∏∫ CSV ÂçïÂÖÉÊ†ºÂ∞ÅË£ÖÊ†ºÂºè (‰ª•ÂºïÂè∑ÂºÄÂ§¥ÂíåÁªìÂ∞æ)
        if (content.startsWith('"') && content.endsWith('"')) {
            // ÁßªÈô§È¶ñÂ∞æÂºïÂè∑
            let inner = content.substring(1, content.length - 1);
            // ËøòÂéüËΩ¨‰πâÁöÑÂºïÂè∑ ("" -> ")
            jsonStr = inner.replace(/""/g, '"');
        }

        try {
            const backupData = JSON.parse(jsonStr);
            let restoreItems = [];
            let newThreshold = null;
            let newPlans = null;
            let newAiData = null;

            // ÂÖºÂÆπÁõ¥Êé•ÁöÑÊï∞ÁªÑÊ†ºÂºè (ÊóßÁâà JSON) ÊàñÊñ∞ÁöÑÂØπË±°Ê†ºÂºè
            if (Array.isArray(backupData)) {
                restoreItems = backupData;
            } else if (backupData.items && Array.isArray(backupData.items)) {
                restoreItems = backupData.items;
                if (backupData.threshold !== undefined) newThreshold = backupData.threshold;
                if (backupData.plans) newPlans = backupData.plans;
                if (backupData.aiData) newAiData = backupData.aiData;
            } else if (backupData.data && Array.isArray(backupData.data)) {
                 // ÂÖºÂÆπ‰πãÂâçÂ∞ùËØïËøáÁöÑ JSON ÁªìÊûÑ { data: [...] }
                 restoreItems = backupData.data;
                 if (backupData.config && backupData.config.threshold) newThreshold = backupData.config.threshold;
            } else {
                throw new Error("Êó†ÊïàÁöÑÊï∞ÊçÆÊ†ºÂºè");
            }

            // ÊûÑÂª∫Âø´ÈÄüÊü•ÊâæË°®
            const backupMap = new Map(restoreItems.map(i => [i.id, i]));
            let restoreCount = 0;

            // Êõ¥Êñ∞Áé∞ÊúâÊï∞ÊçÆ
            data.forEach(item => {
                if (backupMap.has(item.id)) {
                    const backupItem = backupMap.get(item.id);
                    item.w = backupItem.w !== undefined ? backupItem.w : 0;
                    item.monitor = backupItem.monitor !== undefined ? backupItem.monitor : true;
                    item.logs = backupItem.logs || [];
                    item.totalAdded = backupItem.totalAdded || 0;
                    item.totalUsed = backupItem.totalUsed || 0;
                    restoreCount++;
                } else {
                    // Â¶ÇÊûúÂ§á‰ªΩ‰∏≠Ê≤°ÊúâËØ•Ëâ≤Âè∑ÔºåÈáçÁΩÆ‰∏∫ÂàùÂßãÁä∂ÊÄÅ
                    item.w = 0;
                    item.monitor = true;
                    item.logs = [];
                    item.totalAdded = 0;
                    item.totalUsed = 0;
                }
            });

            // ÊÅ¢Â§çÈòàÂÄºÈÖçÁΩÆ
            if (newThreshold !== null) {
                threshold = parseFloat(newThreshold);
                localStorage.setItem('bead_threshold', threshold);
                const thresholdInput = document.getElementById('threshold');
                if(thresholdInput) thresholdInput.value = threshold;
            }

            // ÊÅ¢Â§çËÆ°ÂàíÊï∞ÊçÆ
            if (newPlans) {
                localStorage.setItem('bead_plans', JSON.stringify(newPlans));
            }

            // ÊÅ¢Â§çAIÈÖçÁΩÆ
            if (newAiData) {
                localStorage.setItem('ai_usage_data', JSON.stringify(newAiData));
            }

            save();
            render();
            if (typeof renderPlans === 'function') renderPlans();
            closeAllModals();
            
            let msg = `Êï∞ÊçÆÂØºÂÖ•ÊàêÂäü (ÊÅ¢Â§ç ${restoreCount} ‰∏™Ëâ≤Âè∑`;
            if(newPlans) msg += `Ôºå${newPlans.length} ‰∏™ËÆ°Âàí`;
            msg += ')';
            showToast(msg);

        } catch (e) {
            console.error(e);
            alert("Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºè„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: " + e.message);
        }
    }

    async function downloadBackupFile() {
        // ÊûÑÂª∫ÂÆåÊï¥ÁöÑÂ§á‰ªΩÂØπË±°
        const backupObj = {
            version: "2.1",
            timestamp: new Date().toISOString(),
            threshold: threshold,
            items: data,
            plans: JSON.parse(localStorage.getItem('bead_plans') || '[]'),
            // Use ModelUsageManager.getData() and perform cleanup to ensure we don't export ghost data
            aiData: (() => {
                const d = ModelUsageManager.getData();
                if (d && d.modelOrder && d.keys) {
                    const activeModels = new Set(d.modelOrder);
                    d.keys.forEach(k => {
                        if (k.usage) {
                            Object.keys(k.usage).forEach(m => {
                                if (!activeModels.has(m)) delete k.usage[m];
                            });
                        }
                    });
                }
                return d;
            })()
        };

        const jsonStr = JSON.stringify(backupObj, null, 2);
        const fileName = `Mard_Inventory_Backup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.txt`;
        
        // Â∞ùËØï‰ΩøÁî® HTML5+ API ‰øùÂ≠òÂà∞ÊåáÂÆöÁßÅÊúâÁõÆÂΩï (Android/data/...)
        if (window.plus && window.plus.io) {
            const specificPath = "file:///storage/emulated/0/Android/data/plus.H5F9023DE/downloads/";
            
            // Helper to write file
            const writeToFile = (entry) => {
                entry.getFile(fileName, {create: true, exclusive: false}, function(fileEntry) {
                    fileEntry.createWriter(function(writer) {
                        writer.onwrite = function() {
                            showToast(`Â§á‰ªΩÂ∑≤ÂØºÂá∫ÔºÅ`);
                            alert(`Â§á‰ªΩÊàêÂäüÔºÅ\n\nÊñá‰ª∂Ë∑ØÂæÑ:\n${specificPath}${fileName}\n\nËØ∑‰ΩøÁî®Êñá‰ª∂ÁÆ°ÁêÜÂô®Êü•Áúã„ÄÇ`);
                        };
                        writer.onerror = function(e) {
                             console.error("ÂÜôÂÖ•Â§±Ë¥•", e);
                             alert("ÂÜôÂÖ•Êñá‰ª∂Â§±Ë¥•: " + e.message + "\nÂ∞ùËØï‰ΩøÁî®ÊôÆÈÄö‰∏ãËΩΩ...");
                             triggerWebDownload();
                        };
                        writer.write(jsonStr);
                    }, function(e){
                        console.error("ÂàõÂª∫ÂÜôÂÖ•Âô®Â§±Ë¥•", e);
                        triggerWebDownload();
                    });
                }, function(e){
                    console.error("ÂàõÂª∫Êñá‰ª∂Â§±Ë¥•", e);
                    triggerWebDownload();
                });
            };

            // Try resolving the specific path directly
            plus.io.resolveLocalFileSystemURL(specificPath, function(entry) {
                writeToFile(entry);
            }, function(e) {
                console.log("Êó†Ê≥ïÁõ¥Êé•ËÆøÈóÆÊåáÂÆöÁõÆÂΩïÔºåÂ∞ùËØïÂàõÂª∫Êàñ‰ΩøÁî®ÈªòËÆ§‰∏ãËΩΩÁõÆÂΩï", e);
                
                // Fallback: try standard downloads if specific path fails (though user insisted on specific path, 
                // if it doesn't exist we can't write to it easily without resolving root first. 
                // Let's try to just use triggerWebDownload as fallback if the specific path is invalid on this device)
                triggerWebDownload();
            });
            return;
        }
        
        triggerWebDownload();

        function triggerWebDownload() {
            try {
                // 1. Create Blob
                const blob = new Blob([jsonStr], {type: "text/plain;charset=utf-8"});
                
                // 2. Create URL
                const url = URL.createObjectURL(blob);
                
                // 3. Create Link
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                
                // 4. Trigger Click
                document.body.appendChild(a);
                a.click();
                
                // 5. Cleanup
                setTimeout(() => { 
                    document.body.removeChild(a); 
                    URL.revokeObjectURL(url); 
                }, 2000);
                
                // 6. User Feedback
                if (window.plus) {
                    showToast("Â∑≤ËØ∑Ê±ÇÁ≥ªÁªü‰∏ãËΩΩÔºåËØ∑Êü•ÁúãÈÄöÁü•Ê†è");
                } else {
                    showToast("Â∑≤ÂºÄÂßã‰∏ãËΩΩ");
                }
            } catch(e) {
                console.error("Web download failed:", e);
                alert("ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑Êà™Âõæ‰øùÂ≠ò‰ª•‰∏ãÊï∞ÊçÆ:\n" + e.message);
            }
        }
    }

    function loadBackupFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                // Store content in hidden textarea for execRestore logic
                document.getElementById('restoreInput').value = e.target.result;
                // Immediately ask to restore
                execRestore();
            };
            reader.readAsText(file);
        }
        input.value = '';
    }

    // --- ÊâπÈáèÂàùÂßãÂΩïÂÖ•ÂäüËÉΩ ---
    function openBatchInput() {
        document.getElementById('batchInputText').value = '';
        showModal('batchInputModal');
    }

    function submitBatchInput() {
        const text = document.getElementById('batchInputText').value;
        const regex = /([A-Z]+[0-9]+)[^0-9\.]*(\d+(\.\d+)?)/gi;
        let match;
        let count = 0;
        while ((match = regex.exec(text)) !== null) {
            const id = match[1].toUpperCase();
            const w = parseFloat(match[2]);
            const item = data.find(d => d.id === id);
            if(item) {
                item.w = w;
                count++;
            }
        }
        save();
        render();
        closeAllModals();
        showToast(`Â∑≤ÊâπÈáèÊõ¥Êñ∞ ${count} ‰∏™Ëâ≤Âè∑ÁöÑÂ∫ìÂ≠ò`);
    }

    function copyLowStockText() {
        const el = document.getElementById('lowStockText');
        el.select();
        navigator.clipboard.writeText(el.value).then(() => showToast("Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø"));
    }

    let selectedIgnoredSeries = new Set();

    let currentIgnoredTab = 'disabled';
    let batchIgnoredSelection = new Set();
    let isIgnoredFilterVisible = false;

    function openIgnoredModal(reset = false) {
        if (reset) {
             selectedIgnoredSeries.clear();
             currentIgnoredTab = 'disabled';
             isIgnoredFilterVisible = false;
        }
        batchIgnoredSelection.clear();
        renderIgnoredUI();
        showModal('ignoredModal');
        document.getElementById('ignoredModal').style.display = 'flex';
    }

    function switchIgnoredTab(tab) {
        if(currentIgnoredTab === tab) return;
        currentIgnoredTab = tab;
        selectedIgnoredSeries.clear();
        batchIgnoredSelection.clear();
        renderIgnoredUI();
    }

    function renderIgnoredUI() {
        const tabDisabled = document.getElementById('tab-ignored-disabled');
        const tabEnabled = document.getElementById('tab-ignored-enabled');
        if (currentIgnoredTab === 'disabled') {
            tabDisabled.className = 'ai-tab active';
            tabDisabled.style.color = '#e24a4a';
            tabDisabled.style.borderBottomColor = '#e24a4a';
            tabEnabled.className = 'ai-tab';
            tabEnabled.style.color = '#666';
            tabEnabled.style.borderBottomColor = 'transparent';
        } else {
            tabDisabled.className = 'ai-tab';
            tabDisabled.style.color = '#666';
            tabDisabled.style.borderBottomColor = 'transparent';
            tabEnabled.className = 'ai-tab active';
            tabEnabled.style.color = '#4a90e2';
            tabEnabled.style.borderBottomColor = '#4a90e2';
        }

        let list = data.filter(d => currentIgnoredTab === 'disabled' ? d.monitor === false : d.monitor !== false);

        renderIgnoredSeriesFilter(list);
        renderIgnoredList(list);

        const btnAction = document.getElementById('btn-ignored-batch-action');
        const count = batchIgnoredSelection.size;
        btnAction.disabled = count === 0;
        
        if (currentIgnoredTab === 'disabled') {
            btnAction.textContent = count > 0 ? `ÊâπÈáèÂºÄÂêØ (${count})` : 'ÊâπÈáèÂºÄÂêØ';
            btnAction.className = 'm-btn m-btn-primary';
            btnAction.style.borderColor = '';
            btnAction.style.color = '#fff';
        } else {
            btnAction.textContent = count > 0 ? `ÊâπÈáèÂÖ≥Èó≠ (${count})` : 'ÊâπÈáèÂÖ≥Èó≠';
            btnAction.className = 'm-btn m-btn-ghost'; 
            btnAction.style.borderColor = '#ff4d4f';
            btnAction.style.color = '#ff4d4f';
        }
    }

    function renderIgnoredSeriesFilter(fullList) {
        const container = document.getElementById('ignoredSeriesFilter');
        const toggleBtn = document.getElementById('btn-toggle-ignored-filter');
        
        const seriesSet = new Set();
        fullList.forEach(item => {
            const match = item.id.match(/^[A-Z]+/);
            if (match) seriesSet.add(match[0]);
        });
        const seriesList = Array.from(seriesSet).sort();

        if (seriesList.length <= 1) {
             toggleBtn.style.display = 'none';
             container.style.display = 'none';
             return;
        }

        toggleBtn.style.display = 'flex';
        container.style.display = isIgnoredFilterVisible ? 'flex' : 'none';
        
        if (isIgnoredFilterVisible) {
            toggleBtn.style.background = '#e6f7ff';
            toggleBtn.style.borderColor = '#91d5ff';
            toggleBtn.style.color = '#1890ff';
        } else {
            toggleBtn.style.background = '#fff';
            toggleBtn.style.borderColor = '#ddd';
            toggleBtn.style.color = '#666';
        }

        container.innerHTML = '';
        seriesList.forEach(s => {
            const isSelected = selectedIgnoredSeries.has(s);
            const btn = document.createElement('div');
            btn.textContent = s;
            btn.style.cssText = `
                padding: 4px 12px;
                border-radius: 15px;
                font-size: 13px;
                cursor: pointer;
                border: 1px solid ${isSelected ? '#4a90e2' : '#ddd'};
                background: ${isSelected ? '#4a90e2' : '#fff'};
                color: ${isSelected ? '#fff' : '#666'};
                transition: all 0.2s;
                user-select: none;
            `;
            btn.onclick = () => toggleIgnoredSeries(s);
            container.appendChild(btn);
        });
    }

    function toggleIgnoredFilterVisibility() {
        isIgnoredFilterVisible = !isIgnoredFilterVisible;
        renderIgnoredUI();
    }

    function toggleIgnoredSeries(s) {
        if (selectedIgnoredSeries.has(s)) {
            selectedIgnoredSeries.delete(s);
        } else {
            selectedIgnoredSeries.add(s);
        }
        renderIgnoredUI();
    }

    function renderIgnoredList(list) {
        if (selectedIgnoredSeries.size > 0) {
            list = list.filter(item => {
                const match = item.id.match(/^[A-Z]+/);
                return match && selectedIgnoredSeries.has(match[0]);
            });
        }

        const container = document.getElementById('ignoredList');
        const countSpan = document.getElementById('ignoredListCount');
        countSpan.textContent = `ÂÖ± ${list.length} ‰∏™`;
        
        container.innerHTML = '';
        
        const selectAllCb = document.getElementById('ignoredSelectAll');
        const allSelected = list.length > 0 && list.every(item => batchIgnoredSelection.has(item.id));
        selectAllCb.checked = allSelected;

        if(list.length === 0) {
            container.innerHTML = '<div style="padding:40px; text-align:center; color:#999; font-size:13px;">ÊöÇÊó†Êï∞ÊçÆ</div>';
        } else {
            list.forEach(item => {
                const isSelected = batchIgnoredSelection.has(item.id);
                const row = document.createElement('div');
                row.className = 'modal-row';
                row.style.cssText = `
                    display:flex; align-items:center; padding:10px; border-bottom:1px solid #f9f9f9; gap: 10px; cursor: pointer;
                    background: ${isSelected ? '#f0f7ff' : '#fff'};
                `;
                row.onclick = () => toggleIgnoredBatchItem(item.id);

                row.innerHTML = `
                    <div style="flex-shrink:0;">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} style="pointer-events:none;"> 
                    </div>
                    <div class="swatch" style="width:24px; height:24px; background:${item.hex}; border-radius:6px; border:1px solid #eee; flex-shrink: 0;"></div>
                    <span style="font-weight:bold; font-size:15px; flex:1;">${item.id}</span>
                `;
                container.appendChild(row);
            });
        }
    }

    function toggleIgnoredBatchItem(id) {
        if (batchIgnoredSelection.has(id)) {
            batchIgnoredSelection.delete(id);
        } else {
            batchIgnoredSelection.add(id);
        }
        renderIgnoredUI();
    }

    function toggleAllIgnoredBatchSelection() {
        const selectAllCb = document.getElementById('ignoredSelectAll');
        let list = data.filter(d => currentIgnoredTab === 'disabled' ? d.monitor === false : d.monitor !== false);
        if (selectedIgnoredSeries.size > 0) {
            list = list.filter(item => {
                const match = item.id.match(/^[A-Z]+/);
                return match && selectedIgnoredSeries.has(match[0]);
            });
        }

        if (selectAllCb.checked) {
            list.forEach(item => batchIgnoredSelection.add(item.id));
        } else {
            list.forEach(item => batchIgnoredSelection.delete(item.id));
        }
        renderIgnoredUI();
    }

    function executeIgnoredBatchAction() {
        if (batchIgnoredSelection.size === 0) return;
        
        const isEnableAction = currentIgnoredTab === 'disabled';
        const actionText = isEnableAction ? 'ÂºÄÂêØÊèêÈÜí' : 'ÂÖ≥Èó≠ÊèêÈÜí';

        showConfirmModal(
            'Êìç‰ΩúÁ°ÆËÆ§',
            `Á°ÆÂÆöË¶ÅÂØπÈÄâ‰∏≠ÁöÑ ${batchIgnoredSelection.size} ‰∏™Ëâ≤Âè∑${actionText}ÂêóÔºü`,
            () => {
                let count = 0;
                batchIgnoredSelection.forEach(id => {
                    const item = data.find(d => d.id === id);
                    if(item) {
                        item.monitor = isEnableAction;
                        count++;
                    }
                });

                save();
                render(); 
                showToast(`Â∑≤ÊâπÈáè${actionText} ${count} ‰∏™Ëâ≤Âè∑`);
            }
        );
    }

    function openLowStockModal() {
        // Ëé∑ÂèñÂΩìÂâçÁ≠õÈÄâÊ®°Âºè
        const seriesMode = document.getElementById('seriesFilter').value;
        
        // Á≠õÈÄâÈÄªËæë‰∏é render ‰øùÊåÅ‰∏ÄËá¥
        const lowList = data.filter(d => {
            // 1. ÁõëÊéßÂºÄÂêØ‰∏î‰Ωé‰∫éÈòàÂÄº
            if (d.monitor === false || d.w >= threshold) return false;
            
            // 2. Á≥ªÂàóÁ≠õÈÄâ
            if (seriesMode === 'all') return true;
            // Mard 221 Ê®°Âºè‰∏ãÊéíÈô§ P, Q, R, T, Y, ZG Á≥ªÂàó
            const match = d.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';
            const extraSeries = ['P', 'Q', 'R', 'T', 'Y', 'ZG'];
            return !extraSeries.includes(series);
        });

        const listDiv = document.getElementById('lowStockList');
        const headerDiv = document.getElementById('lowStockHeader');
        listDiv.innerHTML = '';

        if (lowList.length === 0) {
            headerDiv.style.display = 'none';
            listDiv.innerHTML = `
                <div style="padding:30px 10px; text-align:center; color:#999;">
                    <div style="font-size:24px; margin-bottom:10px;">üéâ</div>
                    <div style="font-size:13px;">ÂΩìÂâçÂ∫ìÂ≠òÂÖÖË∂≥</div>
                    <div style="font-size:11px; margin-top:5px;">ÊöÇÊó†‰Ωé‰∫éÈòàÂÄº (${threshold}g) ÁöÑËâ≤Âè∑</div>
                </div>
            `;
            // Ê∏ÖÁ©∫Â§çÂà∂ÂÜÖÂÆπ
            document.getElementById('lowStockText').value = '';
        } else {
            headerDiv.style.display = 'flex';
            lowList.forEach(item => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; align-items:center; padding:12px; border-bottom:1px solid #f0f0f0; background:white;';
                
                row.innerHTML = `
                    <div class="swatch" style="width:28px; height:28px; background:${item.hex}; border-radius:50%; border:1px solid #eee; margin-right:12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b style="font-size:16px; color:#333;">${item.id}</b>
                            <span style="font-size:14px; font-weight:bold; color:#ff4d4f;">${item.w}g</span>
                        </div>
                        <div style="font-size:11px; color:#999; margin-top:2px;">Â∫ìÂ≠ò‰∏çË∂≥ (ÈòàÂÄº ${threshold}g)</div>
                    </div>
                `;
                listDiv.appendChild(row);
            });
            
            // ÂéªÈô§ÊúÄÂêé‰∏ÄË°åËæπÊ°Ü
            if(listDiv.lastChild) listDiv.lastChild.style.borderBottom = 'none';

            // ÂáÜÂ§áÂ§çÂà∂ÁöÑÊñáÊú¨ÂÜÖÂÆπ
            const copyText = lowList.map(d => `${d.id}: ${d.w}g`).join('\n');
            document.getElementById('lowStockText').value = copyText;
        }

        showModal('lowStockModal');
    }



    let selectedStatsSeries = new Set();
    let isStatsFilterVisible = false;
    
    // Plan Stats Filter State Removed

    function toggleStatsFilterVisibility() {
        isStatsFilterVisible = !isStatsFilterVisible;
        renderStats();
    }

    function enableStatsLowStock() {
        const checkbox = document.getElementById('stats-low-filter');
        if(checkbox) {
            checkbox.checked = true;
            renderStats();
            showToast('Â∑≤ÂàáÊç¢Ëá≥‰ΩéÂ∫ìÂ≠òÊ®°Âºè');
        }
    }

    function copyLowStock() {
        // Reuse logic to get current filtered scope
        let seriesMode = document.getElementById('seriesFilter').value;
        const extraSeries = ['P', 'Q', 'R', 'T', 'Y', 'ZG'];
        
        // 1. Base Filter (Series Mode)
        let candidates = data.filter(item => {
            const match = item.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';
            if (seriesMode === 'all') return true;
            return !extraSeries.includes(series);
        });

        // 2. Stats Series Button Filter
        if (selectedStatsSeries.size > 0) {
            candidates = candidates.filter(item => {
                 const match = item.id.match(/^[A-Z]+/);
                 const series = match ? match[0] : '';
                 return selectedStatsSeries.has(series);
            });
        }

        // 3. Filter Low Stock
        const lowStockItems = candidates.filter(item => item.monitor !== false && (item.w || 0) < threshold);
        
        if (lowStockItems.length === 0) {
            showToast('ÂΩìÂâçÊ≤°ÊúâÁº∫Ë¥ßËâ≤Âè∑');
            return;
        }

        // 4. Sort
        lowStockItems.sort((a, b) => {
             const matchA = a.id.match(/^([A-Z]+)(\d+)$/);
             const matchB = b.id.match(/^([A-Z]+)(\d+)$/);
             if (matchA && matchB) {
                 if (matchA[1] !== matchB[1]) return matchA[1].localeCompare(matchB[1]);
                 return parseInt(matchA[2]) - parseInt(matchB[2]);
             }
             return a.id.localeCompare(b.id);
        });

        // 5. Generate Text (IDs only)
        const text = lowStockItems.map(item => item.id).join('\n');
        
        // 6. Copy
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`Â∑≤Â§çÂà∂ ${lowStockItems.length} ‰∏™Áº∫Ë¥ßËâ≤Âè∑`);
            }).catch(err => {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed'; // Prevent scrolling to bottom
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showToast('Â∑≤Â§çÂà∂Áº∫Ë¥ßËâ≤Âè∑');
        } catch (err) {
            showToast('Â§çÂà∂Â§±Ë¥•');
        }
        document.body.removeChild(textarea);
    }

    function toggleStatsSeries(series) {
        if (selectedStatsSeries.has(series)) {
            selectedStatsSeries.delete(series);
        } else {
            selectedStatsSeries.add(series);
        }
        renderStats();
    }

    function renderStats() {
        // 0. Â∫îÁî®Á≠õÈÄâÈÄªËæë (‰øùÊåÅ‰∏é inventory È°µÈù¢‰∏ÄËá¥)
        let seriesMode = document.getElementById('seriesFilter').value;
        // Sync stats dropdown to match
        const statsSelect = document.getElementById('statsSeriesFilter');
        if(statsSelect && statsSelect.value !== seriesMode) {
             statsSelect.value = seriesMode;
        }

        const extraSeries = ['P', 'Q', 'R', 'T', 'Y', 'ZG'];
        
        // Base Data: Filtered by Series Mode ONLY (for generating filter buttons)
        let baseStatsData = data.filter(item => {
            const match = item.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';
            if (seriesMode === 'all') return true;
            return !extraSeries.includes(series);
        });

        // 0.1 Render Stats Series Filter Buttons
        const filterContainer = document.getElementById('statsSeriesFilterContainer');
        const toggleBtn = document.getElementById('btn-toggle-stats-filter');

        if (filterContainer) {
            const seriesSet = new Set();
            baseStatsData.forEach(item => {
                const match = item.id.match(/^[A-Z]+/);
                if (match) seriesSet.add(match[0]);
            });
            const seriesList = Array.from(seriesSet).sort();

            if (seriesList.length <= 1) {
                filterContainer.style.display = 'none';
                if(toggleBtn) toggleBtn.style.display = 'none';
            } else {
                // Show toggle button logic
                if(toggleBtn) {
                    toggleBtn.style.display = 'flex';
                    if (isStatsFilterVisible) {
                        toggleBtn.style.background = '#e6f7ff';
                        toggleBtn.style.borderColor = '#91d5ff';
                    } else {
                        toggleBtn.style.background = '#fff';
                        toggleBtn.style.borderColor = '#ddd';
                    }
                }

                if (isStatsFilterVisible) {
                    filterContainer.style.display = 'flex';
                    filterContainer.innerHTML = '';
                    seriesList.forEach(s => {
                        const isSelected = selectedStatsSeries.has(s);
                        const btn = document.createElement('div');
                        btn.textContent = s;
                        btn.className = `series-chip ${isSelected ? 'selected' : ''}`;
                        btn.onclick = () => toggleStatsSeries(s);
                        filterContainer.appendChild(btn);
                    });
                } else {
                    filterContainer.style.display = 'none';
                }
            }
        }

        // 0.2 Apply Series Button Filter (for Totals and List)
        let statsData = baseStatsData;
        if (selectedStatsSeries.size > 0) {
            statsData = baseStatsData.filter(item => {
                 const match = item.id.match(/^[A-Z]+/);
                 const series = match ? match[0] : '';
                 return selectedStatsSeries.has(series);
            });
        }

        // 1. Âü∫Á°ÄÊï∞ÊçÆÁªüËÆ°
        const totalStock = statsData.reduce((sum, item) => sum + (item.w || 0), 0);
        const totalUsed = statsData.reduce((sum, item) => sum + (item.totalUsed || 0), 0);
        // Low stock: monitor is true (or undefined/default) AND stock < threshold
        const lowCount = statsData.filter(item => item.monitor !== false && (item.w || 0) < threshold).length;
        
        // Calculate Usage Rate: Total Used / Total Stock * 100%
        let usageRate = 0;
        if (totalStock > 0) {
            usageRate = Math.round((totalUsed / totalStock) * 100);
        } else if (totalUsed > 0) {
            usageRate = 100; // Stock is 0 but used > 0, treat as maxed
        }

        // 2. Êõ¥Êñ∞Ê¶ÇËßàÊï∞Â≠ó
        const elTotalStock = document.getElementById('stats-total-stock');
        if(elTotalStock) elTotalStock.textContent = `${totalStock.toFixed(1)}g`;
        
        const elTotalUsed = document.getElementById('stats-total-used');
        if(elTotalUsed) elTotalUsed.textContent = `${totalUsed.toFixed(1)}g`;
        
        const elLowCount = document.getElementById('stats-low-count');
        if(elLowCount) {
            elLowCount.textContent = lowCount;
            elLowCount.style.color = lowCount > 0 ? '#ff4d4f' : '#333';
        }

        // 3. Êõ¥Êñ∞ÁîúÁîúÂúàÂõæ (Â∑≤Ê∂àËÄó)
        const donut = document.getElementById('stats-donut');
        const donutPercent = document.getElementById('stats-donut-percent');
        const donutValue = document.getElementById('stats-donut-value');
        if(donut && donutPercent) {
            const visualRate = Math.min(usageRate, 100);
            // Use standard blue/green for usage
            donut.style.background = `conic-gradient(#52c41a 0% ${visualRate}%, #f0f0f0 ${visualRate}% 100%)`;
            donutPercent.textContent = `${usageRate}%`;
            
            if(donutValue) {
                donutValue.textContent = `${totalUsed.toFixed(1)}g`;
            }
        }

        // 3.1 Êõ¥Êñ∞ËÆ°ÂàíÁªüËÆ°
        updatePlanOverviewStats();

        // 4. Êõ¥Êñ∞ÊéíË°åÊ¶ú (Stats Rank List)
        const rankListEl = document.getElementById('stats-rank-list');
        if(!rankListEl) return;
        
        rankListEl.innerHTML = '';

        // Filter by "Low Stock Only" toggle
        const lowFilterEl = document.getElementById('stats-low-filter');
        const showLowOnly = lowFilterEl ? lowFilterEl.checked : false;
        
        let listData = [...statsData];
        if (showLowOnly) {
            listData = listData.filter(item => item.monitor !== false && (item.w || 0) < threshold);
        }

        // Sort by Total Used Descending (Default Rank)
        listData.sort((a, b) => (b.totalUsed || 0) - (a.totalUsed || 0));

        if (listData.length === 0) {
            rankListEl.innerHTML = '<div style="text-align:center; color:#999; padding:20px; font-size:13px;">ÊöÇÊó†Êï∞ÊçÆ</div>';
            return;
        }

        const fragment = document.createDocumentFragment();
        const maxUsed = listData.length > 0 ? (listData[0].totalUsed || 0) : 0;

        listData.forEach((item, index) => {
            const itemUsed = item.totalUsed || 0;
            const itemStock = item.w || 0;
            const isLow = item.monitor !== false && itemStock < threshold;
            
            // Progress bar width (relative to max in current list)
            const progressPercent = maxUsed > 0 ? (itemUsed / maxUsed) * 100 : 0;

            const el = document.createElement('div');
            el.className = 'rank-item';
            
            // Rank Badge
            let badgeClass = 'rank-badge';
            if (index === 0) badgeClass += ' top-1';
            else if (index === 1) badgeClass += ' top-2';
            else if (index === 2) badgeClass += ' top-3';
            
            // Color Swatch
            const colorStyle = item.hex ? `background-color: ${item.hex};` : 'background-color: #eee;';
            
            el.innerHTML = `
                <div class="${badgeClass}">${index + 1}</div>
                <div class="rank-swatch" style="${colorStyle}"></div>
                <div class="rank-content">
                    <div class="rank-header">
                        <span class="rank-id">${item.id}</span>
                        <div class="rank-details">
                            <span class="used">Áî® ${itemUsed.toFixed(1)}g</span>
                            <span class="rem ${isLow ? 'zero' : ''}">‰Ωô ${itemStock.toFixed(1)}g</span>
                        </div>
                    </div>
                    <div class="rank-progress-bg">
                        <div class="rank-progress-fill" style="width: ${progressPercent}%;"></div>
                    </div>
                </div>
            `;
            fragment.appendChild(el);
        });
        
        rankListEl.appendChild(fragment);
    }

    function toggleChartBar(el) {
        // Toggle active state on the clicked bar
        // Optional: Close others
        const isActive = el.classList.contains('active');
        document.querySelectorAll('.chart-bar.active').forEach(b => b.classList.remove('active'));
        if (!isActive) {
            el.classList.add('active');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                el.classList.remove('active');
            }, 3000);
        }
    }

    // Plan Chart Config Global
    let planChartConfig = {
        total: true,
        completed: true,
        pending: true,
        time: true
    };

    function togglePlanChartFilter(type) {
        if (planChartConfig.hasOwnProperty(type)) {
            planChartConfig[type] = !planChartConfig[type];
            updatePlanOverviewStats(); 
        }
    }

    function parseTimeSpentToHours(str) {
        if (!str) return 0;
        str = str.toString().toLowerCase().trim()
                 .replace(/Â∞èÊó∂/g, 'h')
                 .replace(/ÂàÜÈíü/g, 'm')
                 .replace(/ÂàÜ/g, 'm');
        
        let hours = 0;
        const hMatch = str.match(/([\d\.]+)\s*h/);
        if (hMatch) hours += parseFloat(hMatch[1]);
        
        const mMatch = str.match(/([\d\.]+)\s*m/);
        if (mMatch) hours += parseFloat(mMatch[1]) / 60;
        
        // If no unit found but looks like number, assume minutes
        if (!hMatch && !mMatch) {
             const val = parseFloat(str);
             if (!isNaN(val)) hours += val / 60;
        }
        return hours;
    }

    function togglePlanChartVisibility() {
        const chartEl = document.getElementById('stats-plan-chart');
        const btn = document.getElementById('btn-toggle-plan-chart');
        if (!chartEl || !btn) return;

        const isHidden = chartEl.style.display === 'none';
        
        if (isHidden) {
            chartEl.style.display = 'block';
            btn.style.transform = 'rotate(180deg)';
        } else {
            chartEl.style.display = 'none';
            btn.style.transform = 'rotate(0deg)';
        }
    }

    function renderPlanChart(plans) {
        const chartEl = document.getElementById('stats-plan-chart');
        if (!chartEl) return;
        
        // Ensure horizontal scrolling if content overflows
        chartEl.style.overflowX = 'auto';

        // 1. Group data by Month (YYYY-MM)
        const monthMap = new Map(); // "2025-01" -> { total: 0, completed: 0, pending: 0, time: 0 }
        
        // Sort plans by date
        plans.sort((a, b) => (a.created || 0) - (b.created || 0));

        if (plans.length === 0) {
            chartEl.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px; font-size:12px;">ÊöÇÊó†ËÆ°ÂàíÊï∞ÊçÆ</div>';
            return;
        }

        // Populate Map
        plans.forEach(p => {
            const d = new Date(p.created || Date.now());
            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            
            if (!monthMap.has(key)) {
                monthMap.set(key, { total: 0, completed: 0, pending: 0, time: 0 });
            }
            const entry = monthMap.get(key);
            entry.total++;
            if (p.status === 'completed') {
                entry.completed++;
                entry.time += parseTimeSpentToHours(p.timeSpent);
            }
            else entry.pending++; 
        });

        // Convert to Array and Sort
        const data = Array.from(monthMap.entries()).map(([key, val]) => ({
            key,
            ...val
        })).sort((a, b) => a.key.localeCompare(b.key));

        // Find Max Value for scaling
        let maxVal = 0;
        data.forEach(d => {
            let localMax = d.total;
            if (planChartConfig.time) localMax = Math.max(localMax, d.time);
            maxVal = Math.max(maxVal, localMax);
        });
        if (maxVal === 0) maxVal = 1;

        // 2. Build HTML
        let html = `<div class="chart-container">`;

        data.forEach(item => {
            const hTotal = (item.total / maxVal) * 100;
            const hComp = (item.completed / maxVal) * 100;
            const hPend = (item.pending / maxVal) * 100;
            const hTime = (item.time / maxVal) * 100;
            
            // Parse date for label (e.g. "2026-01" -> "2026Âπ¥1Êúà")
            const [y, m] = item.key.split('-');
            const label = `${y}Âπ¥${parseInt(m)}Êúà`; 

            // Conditional Bar Styles
            const styleTotal = planChartConfig.total ? `height:${hTotal}%; background:#4a90e2;` : `display:none;`;
            const styleComp = planChartConfig.completed ? `height:${hComp}%; background:#52c41a;` : `display:none;`;
            const stylePend = planChartConfig.pending ? `height:${hPend}%; background:#faad14;` : `display:none;`;
            const styleTime = planChartConfig.time ? `height:${hTime}%; background:#722ed1;` : `display:none;`;

            html += `
                <div class="chart-col">
                    <div class="chart-bars-group">
                        <div class="chart-bar" style="${styleTotal}" title="ÊÄªËÆ°: ${item.total}" onclick="toggleChartBar(this)"></div>
                        <div class="chart-bar" style="${styleComp}" title="ÂÆåÊàê: ${item.completed}" onclick="toggleChartBar(this)"></div>
                        <div class="chart-bar" style="${stylePend}" title="ËÆ°Âàí: ${item.pending}" onclick="toggleChartBar(this)"></div>
                        <div class="chart-bar" style="${styleTime}" title="ËÄóÊó∂: ${item.time.toFixed(1)}h" onclick="toggleChartBar(this)"></div>
                    </div>
                    <div class="chart-label">${label}</div>
                </div>
            `;
        });

        html += `</div>`;
        
        // Add Interactive Legend at Bottom (Removed)
        
        chartEl.innerHTML = html;
    }

    function syncAndRenderStats() {
        const val = document.getElementById('statsSeriesFilter').value;
        const mainSelect = document.getElementById('seriesFilter');
        if(mainSelect && mainSelect.value !== val) {
             mainSelect.value = val;
             // Update localStorage and trigger main render to keep sync
             localStorage.setItem('bead_series_filter', val);
             render(); 
        }
        renderStats();
    }

    // --- Ê∞¥Âç∞ÂäüËÉΩ --- Êñ∞Áî®Êà∑Ê¨¢ËøéÂºπÁ™ó ---
    function checkWelcome() {
        const hasVisited = localStorage.getItem('mard_visited');
        if (!hasVisited) {
            showModal('welcomeModal');
        }
    }

    function closeWelcomeModal() {
        localStorage.setItem('mard_visited', 'true');
        closeAllModals();
    }

    function showDevInfo() {
        showModal('devInfoModal');
    }

    // ÊÅ¢Â§ç‰∏äÊ¨°ÈÄâÊã©ÁöÑÁ≥ªÂàó
    const savedSeries = localStorage.getItem('bead_series_filter');
    if (savedSeries) {
        document.getElementById('seriesFilter').value = savedSeries;
    }

    // ÂêØÂä®Êó∂Ê£ÄÊü•
    window.addEventListener('DOMContentLoaded', () => {
        // Remove init style if exists
        const initStyle = document.getElementById('init-style');
        if(initStyle) initStyle.remove();

        // Check for saved nav state (Refresh Persistence)
        const lastNav = localStorage.getItem('mard_last_nav');
        let restored = false;
        
        if (lastNav) {
            try {
                const nav = JSON.parse(lastNav);
                // Simple validation to prevent loops if bad data
                if (nav && nav.method && nav.arg) {
                    if (nav.method === 'navTo') {
                        navTo(nav.arg);
                        restored = true;
                    } else if (nav.method === 'navToDock') {
                        navToDock(nav.arg);
                        restored = true;
                    }
                }
            } catch(e) {
                console.error("Failed to restore nav state:", e);
                localStorage.removeItem('mard_last_nav');
            }
        }

        if (!restored) {
            // Check default page preference
            const defaultBeads = localStorage.getItem('default_page_beads');
            if (defaultBeads === 'true') {
                document.getElementById('defaultBeadsToggle').checked = true;
                navTo('beads');
            } else {
                navTo('home');
            }
        }

        render();
    });

    // --- Fabric Tool Logic ---

    function toggleDefaultPage() {
        const isChecked = document.getElementById('defaultBeadsToggle').checked;
        if (isChecked) {
            localStorage.setItem('default_page_beads', 'true');
        } else {
            localStorage.removeItem('default_page_beads');
        }
    }
    let specs = [];
    const specColors = ['#f5dce0', '#dcedc8', '#fdf6c6', '#adc6ff', '#d3adf7']; // Pink, Green, Yellow, Blue, Purple

    function addSpec() {
        if (specs.length >= 5) {
            alert("ÊúÄÂ§öÊ∑ªÂä† 5 ÁßçËßÑÊ†º");
            return;
        }
        specs.push({ w: '', h: '', color: specColors[specs.length] });
        saveFabricState();
        renderSpecs();
    }

    function removeSpec(index) {
        specs.splice(index, 1);
        saveFabricState();
        renderSpecs();
    }

    function updateSpec(index, field, val) {
        // Only allow integers
        const intVal = parseInt(val);
        if (isNaN(intVal)) {
            specs[index][field] = '';
        } else {
            specs[index][field] = intVal;
        }
        saveFabricState();
        renderSpecs();
    }

    function renderSpecs() {
        const list = document.getElementById('specList');
        list.innerHTML = '';
        specs.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'spec-item';
            div.innerHTML = `
                <div class="spec-color" style="background:${s.color}"></div>
                <div style="font-size:12px; font-weight:bold; color:#666;">#${i+1}</div>
                <div style="position:relative; flex:1;">
                    <input type="number" value="${s.w}" placeholder="Èïø" onchange="updateSpec(${i}, 'w', this.value)" style="width:100%; padding:4px; padding-right:20px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box;">
                    <span style="position:absolute; right:4px; top:50%; transform:translateY(-50%); font-size:10px; color:#999; pointer-events:none;">cm</span>
                </div>
                <span style="font-size:12px; color:#999;">x</span>
                <div style="position:relative; flex:1;">
                    <input type="number" value="${s.h}" placeholder="ÂÆΩ" onchange="updateSpec(${i}, 'h', this.value)" style="width:100%; padding:4px; padding-right:20px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box;">
                    <span style="position:absolute; right:4px; top:50%; transform:translateY(-50%); font-size:10px; color:#999; pointer-events:none;">cm</span>
                </div>
                <button class="btn-del" onclick="removeSpec(${i})">√ó</button>
            `;
            list.appendChild(div);
        });
        updateSortOptions();
    }

    function updateSortOptions() {
        const select = document.getElementById('sortPref');
        if (!select) return;
        const currentVal = select.value;
        
        select.innerHTML = '';
        
        // Define options
        const opts = [
            {v:'all_specs', t:'‰ºòÂÖàÂåÖÂê´ÂÖ®ÈÉ®ËßÑÊ†ºÊñπÊ°à'},
            {v:'efficiency', t:'Âà©Áî®Áéá‰ªéÈ´òÂà∞‰Ωé'}
        ];
        
        // Add dynamic spec options
        specs.forEach((s, i) => {
            opts.push({v:`spec${i+1}`, t:`ËßÑÊ†º${i+1}Êï∞Èáè‰ºòÂÖà`});
        });
        
        opts.forEach(o => {
            const el = document.createElement('option');
            el.value = o.v;
            el.innerText = o.t;
            select.appendChild(el);
        });
        
        // Restore selection or default to all_specs
        const exists = opts.some(o => o.v === currentVal);
        if (exists) select.value = currentVal;
        else select.value = 'all_specs';
    }

    function saveFabricState() {
        const W = document.getElementById('canvasW').value;
        const H = document.getElementById('canvasH').value;
        const sort = document.getElementById('sortPref').value;
        
        localStorage.setItem('fabric_w', W);
        localStorage.setItem('fabric_h', H);
        localStorage.setItem('fabric_sort', sort);
        localStorage.setItem('fabric_specs', JSON.stringify(specs));
    }

    let currentRenderedSolutions = [];
    let currentFabricW = 0;
    let currentFabricH = 0;

    // --- Algorithm ---
    function calculateLayout() {
        saveFabricState(); // Save state on calculation trigger
        const W = parseFloat(document.getElementById('canvasW').value);
        const H = parseFloat(document.getElementById('canvasH').value);
        
        currentFabricW = W;
        currentFabricH = H;

        const sortPref = document.getElementById('sortPref').value;
        const statusEl = document.getElementById('calcStatus');
        const listEl = document.getElementById('solutionList');

        if (!W || !H || specs.length === 0) {
            alert("ËØ∑ÂÆåÂñÑÂ∞∫ÂØ∏‰ø°ÊÅØ");
            return;
        }
        
        statusEl.innerText = "ËÆ°ÁÆó‰∏≠...";
        listEl.innerHTML = ''; 

        // 1. Generate Combinations (Recursion)
        const targetArea = 0.9 * W * H;
        const totalArea = W * H;
        let solutions = [];
        
        // Determine target spec index for priority search
        let targetSpecIndex = -1;
        if (sortPref.startsWith('spec')) {
            targetSpecIndex = parseInt(sortPref.replace('spec', '')) - 1;
        }

        function search(index, currentCounts, currentArea) {
            if (currentArea > totalArea) return;
            
            if (index === specs.length) {
                if (currentArea >= targetArea) {
                    solutions.push({ counts: [...currentCounts], area: currentArea, utilization: currentArea / totalArea });
                }
                return;
            }

            const s = specs[index];
            const sArea = s.w * s.h;
            // Limit max count to avoid infinite loops if size is small
            const maxCnt = Math.min(200, Math.floor((totalArea - currentArea) / sArea));
            
            // Determine iteration order
            // Default: Descending (Max -> 0) to prefer filling space with current spec
            // If targetSpecIndex is set:
            //   - index < targetSpecIndex: Ascending (0 -> Max) to save space for target
            //   - index >= targetSpecIndex: Descending (Max -> 0) to fill space with target and others
            
            let start, end, step;
            let useDescending = true;
            
            if (targetSpecIndex !== -1 && index < targetSpecIndex) {
                useDescending = false;
            }
            
            if (useDescending) {
                start = maxCnt; end = 0; step = -1;
            } else {
                start = 0; end = maxCnt; step = 1;
            }

            for (let c = start; (step > 0 ? c <= end : c >= end); c += step) {
                currentCounts[index] = c;
                search(index + 1, currentCounts, currentArea + c * sArea);
                if (solutions.length > 10000) return; 
            }
        }
        
        search(0, new Array(specs.length).fill(0), 0);

        if (solutions.length === 0) {
            statusEl.innerText = "Êó†Êª°Ë∂≥ >=90% Âà©Áî®ÁéáÁöÑÊñπÊ°à";
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Êú™ÊâæÂà∞È´òÂà©Áî®ÁéáÊñπÊ°àÔºåÂª∫ËÆÆÊ∑ªÂä†Â°´ÂÖÖ‰ª∂</div>';
            return;
        }

        // 2. Validate Packing
        let validSolutions = [];
        solutions.sort((a, b) => b.utilization - a.utilization);
        const toCheck = solutions; 
        
        const packStrategies = [
            (a, b) => Math.max(b.w, b.h) - Math.max(a.w, a.h), // Max side desc (default)
            (a, b) => (b.w * b.h) - (a.w * a.h),             // Area desc
            (a, b) => Math.min(b.w, b.h) - Math.min(a.w, a.h), // Min side desc
            (a, b) => b.w - a.w                                // Width desc
        ];

        for (let sol of toCheck) {
            let items = [];
            sol.counts.forEach((cnt, i) => {
                for(let k=0; k<cnt; k++) items.push({ ...specs[i], id: i });
            });
            
            let bestResult = null;
            
            // Try different packing heuristics to find a fit
            // Combinations of Sort Strategy + Split Strategy (Horizontal/Vertical)
            for (let sortFn of packStrategies) {
                // Try Horizontal Split first (default)
                let result = packItems(W, H, items, sortFn, false);
                if (result) {
                    bestResult = result;
                    break; 
                }
                // Try Vertical Split
                result = packItems(W, H, items, sortFn, true);
                if (result) {
                    bestResult = result;
                    break;
                }
            }
            
            if (bestResult) {
                // Try to fill leftovers (Iterative greedy fill)
                // If we find any spec that fits in the leftovers, add it and re-pack
                let addedAny = false;
                let safetyLimit = 0;
                
                do {
                    addedAny = false;
                    safetyLimit++;
                    if (safetyLimit > 50) break; // Prevent infinite loop
                    
                    let bestExtra = null;
                    let maxExtraArea = 0;
                    
                    // Look for best fitting item across all leftovers
                    for (let l of bestResult.leftovers) {
                        for (let sIdx = 0; sIdx < specs.length; sIdx++) {
                            const s = specs[sIdx];
                            // Check fit (normal and rotated)
                            let fits = (s.w <= l.w && s.h <= l.h) || (s.h <= l.w && s.w <= l.h);
                            if (fits) {
                                const area = s.w * s.h;
                                if (area > maxExtraArea) {
                                    maxExtraArea = area;
                                    bestExtra = { s: s, id: sIdx };
                                }
                            }
                        }
                    }
                    
                    if (bestExtra) {
                        // Add extra item
                        items.push({ ...bestExtra.s, id: bestExtra.id });
                        sol.counts[bestExtra.id]++;
                        
                        // Re-pack with new item set
                        // We must find a valid packing for the new set
                        let improvedResult = null;
                        for (let sortFn of packStrategies) {
                             let res = packItems(W, H, items, sortFn, false); 
                             if (res) { improvedResult = res; break; }
                             res = packItems(W, H, items, sortFn, true); 
                             if (res) { improvedResult = res; break; }
                        }
                        
                        if (improvedResult) {
                            bestResult = improvedResult;
                            addedAny = true;
                            // Update solution stats
                            sol.area += bestExtra.s.w * bestExtra.s.h;
                            sol.utilization = sol.area / totalArea;
                        } else {
                            // Backtrack if failed (should be rare if space exists, but packing is heuristic)
                            items.pop();
                            sol.counts[bestExtra.id]--;
                            addedAny = false; 
                        }
                    }
                } while (addedAny);

                sol.placements = bestResult.placements;
                sol.leftovers = bestResult.leftovers;
                validSolutions.push(sol);
            }
        }

        // 3. Sort Results
        if (sortPref === 'all_specs') {
             validSolutions.sort((a, b) => {
                 const aHasAll = a.counts.every(c => c > 0);
                 const bHasAll = b.counts.every(c => c > 0);
                 if (aHasAll !== bHasAll) return bHasAll ? 1 : -1;
                 return b.utilization - a.utilization;
             });
        } else if (sortPref === 'variety') {
             // Priority: Number of different specs (variety) desc -> Utilization desc
             validSolutions.sort((a, b) => {
                 const varietyA = a.counts.filter(c => c > 0).length;
                 const varietyB = b.counts.filter(c => c > 0).length;
                 if (varietyA !== varietyB) {
                     return varietyB - varietyA; // More variety first
                 }
                 return b.utilization - a.utilization; // Then higher utilization
             });
        } else if (sortPref === 'efficiency') {
            validSolutions.sort((a, b) => b.utilization - a.utilization);
        } else if (sortPref.startsWith('spec')) {
            const specIdx = parseInt(sortPref.replace('spec', '')) - 1;
            validSolutions.sort((a, b) => {
                const countA = a.counts[specIdx] || 0;
                const countB = b.counts[specIdx] || 0;
                return countB - countA;
            });
        }
        
        // Deduplicate solutions based on physical dimensions (user request)
        // Check if generated solution spec dimensions have completely identical combinations
        const uniqueSolutions = [];
        const seenSignatures = new Set();
        
        validSolutions.forEach(sol => {
            // Build signature: sorted list of dimensions "WxH"
            let dims = [];
            sol.counts.forEach((cnt, i) => {
                for(let k=0; k<cnt; k++) {
                    dims.push(`${specs[i].w}x${specs[i].h}`);
                }
            });
            dims.sort();
            const sig = dims.join('|');
            
            if (!seenSignatures.has(sig)) {
                seenSignatures.add(sig);
                uniqueSolutions.push(sol);
            }
        });
        validSolutions = uniqueSolutions;

        // 4. Render All Valid Solutions
        const totalFound = validSolutions.length;
        if (validSolutions.length > 50) {
            validSolutions = validSolutions.slice(0, 50);
        }
        
        currentRenderedSolutions = validSolutions;
        statusEl.innerText = `ÊâæÂà∞ ${totalFound} ‰∏™ÊñπÊ°à (‰ªÖÊòæÁ§∫Ââç ${validSolutions.length} ‰∏™)`;
        
        validSolutions.forEach((sol, idx) => {
            renderSolution(sol, idx + 1, W, H);
        });
    }

    function openZoom(idx) {
        currentZoomIdx = idx;
        const sol = currentRenderedSolutions[idx];
        if (!sol) return;
        
        const modal = document.getElementById('zoomModal');
        const canvas = document.getElementById('zoomCanvas');
        const title = document.getElementById('zoomTitle');
        const statsContainer = document.getElementById('zoomStats');
        const W = parseFloat(document.getElementById('canvasW').value);
        const H = parseFloat(document.getElementById('canvasH').value);
        
        modal.style.display = 'flex';
        title.innerText = `ÊñπÊ°à #${idx + 1} (${(sol.utilization * 100).toFixed(1)}% Âà©Áî®Áéá)`;
        
        if (statsContainer) {
            statsContainer.innerHTML = generateStatsHtml(sol);
        }
        
        // Calculate max dimensions for the modal canvas
        // 90vw width, 70vh height max
        const maxW = window.innerWidth * 0.9;
        const maxH = window.innerHeight * 0.7;
        
        const scaleW = maxW / W;
        const scaleH = maxH / H;
        const scale = Math.min(scaleW, scaleH); // Scale to fit
        
        const cw = W * scale;
        const ch = H * scale;
        
        canvas.width = cw;
        canvas.height = ch;
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, cw, ch);
        ctx.scale(scale, scale);
        
        // Draw placements
        sol.placements.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1 / scale;
            ctx.strokeRect(p.x, p.y, p.w, p.h);
            
            // Always show text in zoom mode if reasonable size
            if (p.w * scale > 30 && p.h * scale > 15) {
                ctx.fillStyle = '#000';
                // Fix font size: use physical pixels (16px) divided by scale
                // Previous Math.max(12, ...) caused huge text when zoomed in
                const fontSize = (p.w <= 10 || p.h <= 10) ? 8 : 16;
                ctx.font = `${fontSize/scale}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
            }
        });
        
        // Draw leftovers
        if(sol.leftovers) {
            sol.leftovers.forEach(l => {
                if (l.w > 0.5 && l.h > 0.5) {
                     ctx.strokeStyle = '#888';
                     ctx.setLineDash([5/scale, 5/scale]);
                     ctx.lineWidth = 2 / scale;
                     ctx.strokeRect(l.x, l.y, l.w, l.h);
                     
                     // Show dimensions for leftovers in zoom
                     if (l.w * scale > 40 && l.h * scale > 20) {
                        ctx.fillStyle = '#666';
                        ctx.font = `${12/scale}px sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${l.w}x${l.h}`, l.x + l.w/2, l.y + l.h/2);
                     }
                     ctx.setLineDash([]);
                }
            });
        }
    }

    function closeZoom() {
        document.getElementById('zoomModal').style.display = 'none';
    }

    function closeDownloadModal() {
        const modal = document.getElementById('downloadModal');
        const img = document.getElementById('downloadImg');
        // Clear src to save memory
        if (img) img.src = '';
        modal.style.display = 'none';
    }

    async function downloadSolution(idx) {
        // UI Feedback: Immediate response
        const btn = document.getElementById('zoomDownloadBtn');
        const originalText = btn ? btn.innerText : "‰øùÂ≠òÂõæÁâá";
        if (btn) {
            btn.innerText = "ÁîüÊàê‰∏≠...";
            btn.disabled = true;
            btn.style.opacity = "0.7";
        }

        // Force UI update
        await new Promise(r => setTimeout(r, 50));

        try {
            const sol = currentRenderedSolutions[idx];
            if (!sol) throw new Error("ÊñπÊ°àÊï∞ÊçÆ‰∏¢Â§±");
            
            const W = currentFabricW;
            const H = currentFabricH;
            
            // 1. Prepare Text Data (Simplified for mobile reliability)
            const lines = [];
            lines.push({ text: `ÊñπÊ°à #${idx+1}`, type: 'title' });
            lines.push({ text: `${W}x${H}cm | Âà©Áî®Áéá:${(sol.utilization * 100).toFixed(1)}%`, type: 'subtitle' });
            
            // Stats (Limit items to prevent huge images)
            sol.counts.forEach((c, i) => {
                if(c > 0) lines.push({ text: `${specs[i].w}x${specs[i].h}: ${c}`, type: 'item', color: specs[i].color });
            });
            
            // Leftovers
            if (sol.leftovers && sol.leftovers.length > 0) {
                const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
                if (validLeftovers.length > 0) {
                     lines.push({ text: "Ââ©‰ΩôÂ∏ÉÊñô:", type: 'header' });
                     const wasteGroups = {};
                     validLeftovers.forEach(l => {
                          const key = `${l.w}x${l.h}`;
                          wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                     });
                     for (let [size, count] of Object.entries(wasteGroups)) {
                          lines.push({ text: `${size}cm: x${count}`, type: 'item-waste' });
                     }
                }
            }

            // 2. Setup Canvas Dimensions
            // NUCLEAR OPTION: Mobile Max Dimension Limit = 800px
            // This ensures it works on even the most restricted WebViews
            let PIXELS_PER_CM = 10; 
            const isMobile = window.innerWidth <= 768 || ('ontouchstart' in window);
            
            if (isMobile) {
                const maxDimension = Math.max(W, H);
                // Force max 800px to guarantee memory safety and Base64 length safety
                if (maxDimension * PIXELS_PER_CM > 800) {
                    PIXELS_PER_CM = 800 / maxDimension; 
                }
            }
            const scale = PIXELS_PER_CM;
            
            // Layout constants
            const PADDING = 20;
            const LINE_HEIGHT = 28;
            let textSectionHeight = PADDING * 2 + lines.length * LINE_HEIGHT;
            
            const canvas = document.createElement('canvas');
            canvas.width = Math.floor(W * scale);
            canvas.height = Math.floor(H * scale + textSectionHeight);
            const ctx = canvas.getContext('2d');
            
            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 3. Draw Layout
            ctx.save();
            ctx.scale(scale, scale);
            sol.placements.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 1 / scale;
                ctx.strokeRect(p.x, p.y, p.w, p.h);
                // Simple text
                if (p.w > 5 && p.h > 5) {
                    ctx.fillStyle = '#000';
                    ctx.font = `${12/scale}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
                }
            });
            
            // Draw leftovers
            if(sol.leftovers) {
                sol.leftovers.forEach(l => {
                    if (l.w > 0.5 && l.h > 0.5) {
                         ctx.strokeStyle = '#888';
                         ctx.setLineDash([5/scale, 5/scale]);
                         ctx.lineWidth = 2 / scale;
                         ctx.strokeRect(l.x, l.y, l.w, l.h);
                         // Dimensions
                         if (l.w > 3 && l.h > 3) {
                             ctx.fillStyle = '#666';
                             ctx.font = `${12/scale}px Arial`;
                             ctx.textAlign = 'center';
                             ctx.textBaseline = 'middle';
                             ctx.fillText(`${l.w}x${l.h}`, l.x + l.w/2, l.y + l.h/2);
                         }
                         ctx.setLineDash([]);
                    }
                });
            }
            ctx.restore();
            
            // 4. Draw Info Text
            let currentY = H * scale + PADDING;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            lines.forEach(line => {
                ctx.font = line.type === 'title' ? "bold 20px Arial" : "16px Arial";
                ctx.fillStyle = '#333';
                if (line.color) {
                    ctx.fillStyle = line.color;
                    ctx.fillRect(PADDING, currentY + 4, 12, 12);
                    ctx.fillStyle = '#333';
                    ctx.fillText(line.text, PADDING + 18, currentY);
                } else {
                    ctx.fillText(line.text, PADDING, currentY);
                }
                currentY += LINE_HEIGHT;
            });
            
            // --- ROBUST AUTO DOWNLOAD STRATEGY ---
            
            // 0. HTML5+ Environment (HBuilderX / 5+App / uni-app)
            // This is the BEST way for APKs built with HBuilderX
            if (window.plus && window.plus.gallery) {
                try {
                    var bitmap = new plus.nativeObj.Bitmap("test");
                    bitmap.loadBase64Data(canvas.toDataURL('image/jpeg', 0.9), function() {
                        const fileName = "_doc/solution_" + (new Date()).getTime() + ".jpg";
                        bitmap.save(fileName, {overwrite: true}, function(i) {
                            plus.gallery.save(i.target, function() {
                                showToast("Â∑≤ÊàêÂäü‰øùÂ≠òÂà∞ÊâãÊú∫Áõ∏ÂÜåÔºÅ");
                                bitmap.clear();
                            }, function(e) {
                                alert("‰øùÂ≠òÂà∞Áõ∏ÂÜåÂ§±Ë¥•: " + JSON.stringify(e));
                                bitmap.clear();
                            });
                        }, function(e) {
                            alert("‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•: " + JSON.stringify(e));
                            bitmap.clear();
                        });
                    }, function(e) {
                        alert("ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•: " + JSON.stringify(e));
                    });
                    return; // Stop execution, let the native API handle it
                } catch(e) {
                    console.error("Plus API failed", e);
                }
            }

            // --- DIRECT DOWNLOAD STRATEGY (User Requested) ---
            // Bypass Share API and force direct download to local storage
            
            await new Promise((resolve, reject) => {
                canvas.toBlob(function(blob) {
                    try {
                        if (!blob) {
                            reject(new Error("ÂõæÁâáÁîüÊàêÂ§±Ë¥•"));
                            return;
                        }
                        
                        // Force "Stream" type to ensure Android WebViews treat it as a download
                        // instead of opening it in the browser/viewer.
                        const streamBlob = new Blob([blob], { type: "application/octet-stream" });
                        const url = URL.createObjectURL(streamBlob);
                        
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        link.download = `solution_${idx+1}.jpg`;
                        
                        document.body.appendChild(link);
                        link.click();
                        
                        // Cleanup after a delay to ensure click registers
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }, 2000);
                        
                        resolve();
                    } catch (e) {
                        reject(e);
                    }
                }, 'image/jpeg', 0.8);
            });

            // Fallback for APKs that block blob downloads: Show image for long-press
            // Only runs if the above click() didn't trigger a page navigation/download catch
            if (isMobile) {
                 setTimeout(() => {
                      const fallbackDiv = document.createElement('div');
                      fallbackDiv.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; font-size:12px; z-index:9999; pointer-events:none; opacity:0; transition:opacity 0.5s;';
                      fallbackDiv.innerText = "Â¶ÇÊûúÊú™ÂºÄÂßã‰∏ãËΩΩÔºåËØ∑ÈïøÊåâÂõæÁâá‰øùÂ≠ò";
                      document.body.appendChild(fallbackDiv);
                      
                      // Check if we should show fallback
                      // Since we can't detect if download started, we show a non-intrusive toast
                      // AND we open the image in a way that allows long-press if the download failed silently
                      
                      // Re-enable image interaction for long press backup
                      const zoomImg = document.querySelector('#zoomModal img');
                      if(zoomImg) {
                          zoomImg.src = canvas.toDataURL('image/jpeg', 0.8); // Replace preview with full res for saving
                          requestAnimationFrame(() => {
                               fallbackDiv.style.opacity = '1';
                               setTimeout(() => fallbackDiv.remove(), 4000);
                          });
                      }
                 }, 1000);
            }

        } catch (e) {
            alert("Êìç‰ΩúÂ§±Ë¥•: " + e.message + "\nÂª∫ËÆÆÊà™Âõæ‰øùÂ≠ò");
        } finally {
            if (btn) {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        }
    }

    // Guillotine Packing Algorithm
    function packItems(binW, binH, items, sortFn, splitVertical) {
        // Sort items using provided strategy or default
        let rects = items.map(i => ({...i}));
        if (sortFn) {
            rects.sort(sortFn);
        } else {
            rects.sort((a, b) => Math.max(b.w, b.h) - Math.max(a.w, a.h)); 
        }

        let root = { x: 0, y: 0, w: binW, h: binH, used: false };
        let placements = [];
        
        for (let r of rects) {
            // Try to find best fit for normal and rotated orientation
            // Strategy: Best Short Side Fit (BSSF) - minimizes the shorter leftover side
            let fit = findBestFit(root, r.w, r.h);
            let fitR = findBestFit(root, r.h, r.w);
            
            let bestNode = null;
            let rotated = false;
            
            if (fit.node && fitR.node) {
                if (fit.score <= fitR.score) {
                    bestNode = fit.node;
                } else {
                    bestNode = fitR.node;
                    rotated = true;
                }
            } else if (fit.node) {
                bestNode = fit.node;
            } else if (fitR.node) {
                bestNode = fitR.node;
                rotated = true;
            }
            
            if (bestNode) {
                let w = rotated ? r.h : r.w;
                let h = rotated ? r.w : r.h;
                splitNode(bestNode, w, h, splitVertical);
                placements.push({ x: bestNode.x, y: bestNode.y, w, h, color: r.color, id: r.id });
            } else {
                return null; 
            }
        }
        
        let leftovers = [];
        collectLeftovers(root, leftovers);
        return { placements, leftovers };
    }

    function findBestFit(root, w, h) {
        let bestNode = null;
        let bestScore = Infinity; // Lower is better (min short side remainder)

        function traverse(node) {
            if (node.used) {
                traverse(node.right);
                traverse(node.down);
            } else if (w <= node.w && h <= node.h) {
                // BSSF: Best Short Side Fit
                let remW = node.w - w;
                let remH = node.h - h;
                let score = Math.min(remW, remH);
                
                if (score < bestScore) {
                    bestScore = score;
                    bestNode = node;
                }
            }
        }
        traverse(root);
        return { node: bestNode, score: bestScore };
    }

    function splitNode(node, w, h, splitVertical) {
        node.used = true;
        if (splitVertical) {
            // Vertical Split: Cut strip of width w
            node.down = { x: node.x, y: node.y + h, w: w, h: node.h - h, used: false };
            node.right = { x: node.x + w, y: node.y, w: node.w - w, h: node.h, used: false };
        } else {
            // Horizontal Split (Default): Cut strip of height h
            node.down = { x: node.x, y: node.y + h, w: node.w, h: node.h - h, used: false };
            node.right = { x: node.x + w, y: node.y, w: node.w - w, h: h, used: false };
        }
    }
    
    function collectLeftovers(node, list) {
        if (!node) return;
        if (!node.used) {
            if (node.w > 0 && node.h > 0) list.push({x: node.x, y: node.y, w: node.w, h: node.h});
        } else {
            collectLeftovers(node.right, list);
            collectLeftovers(node.down, list);
        }
    }

    function generateStatsHtml(sol) {
        let statsHtml = '';
        sol.counts.forEach((c, i) => {
            if(c > 0) {
                statsHtml += `
                    <div class="sol-stat-row">
                        <span style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:${specs[i].color}; border-radius:2px;"></div>
                            ${specs[i].w}x${specs[i].h}cm
                        </span>
                        <b>x${c}</b>
                    </div>
                `;
            }
        });

        // Generate leftovers stats
        let wasteHtml = '';
        if (sol.leftovers && sol.leftovers.length > 0) {
            // Filter significant leftovers
            const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
            if (validLeftovers.length > 0) {
                // Group by size
                const wasteGroups = {};
                validLeftovers.forEach(l => {
                    const key = `${l.w}x${l.h}`;
                    wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                });
                
                wasteHtml = `<div style="margin-top:10px; font-size:12px; color:#999; border-top:1px dashed #eee; padding-top:5px;">
                    <div style="margin-bottom:2px;">Ââ©‰ΩôÂ∏ÉÊñô:</div>`;
                
                for (let [size, count] of Object.entries(wasteGroups)) {
                    wasteHtml += `<div style="display:flex; justify-content:space-between;">
                        <span>${size}cm</span>
                        <span>x${count}</span>
                    </div>`;
                }
                wasteHtml += `</div>`;
            }
        }
        
        return `<div class="sol-info" style="margin-top:15px; width:100%; border-top:1px solid #eee; padding-top:10px;">
                    <div style="margin-bottom:10px; font-weight:bold; font-size:13px; color:#333;">Êï∞ÈáèÁªüËÆ°</div>
                    ${statsHtml}
                    ${wasteHtml}
                </div>`;
    }

    function renderSolution(sol, idx, W, H) {
        const listEl = document.getElementById('solutionList');
        const card = document.createElement('div');
        card.className = 'solution-card';
        
        let statsHtml = '';
        sol.counts.forEach((c, i) => {
            if(c > 0) {
                statsHtml += `
                    <div class="sol-stat-row">
                        <span style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:${specs[i].color}; border-radius:2px;"></div>
                            ${specs[i].w}x${specs[i].h}cm
                        </span>
                        <b>x${c}</b>
                    </div>
                `;
            }
        });

        // Generate leftovers stats
        let wasteHtml = '';
        if (sol.leftovers && sol.leftovers.length > 0) {
            // Filter significant leftovers
            const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
            if (validLeftovers.length > 0) {
                // Group by size
                const wasteGroups = {};
                validLeftovers.forEach(l => {
                    const key = `${l.w}x${l.h}`;
                    wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                });
                
                wasteHtml = `<div style="margin-top:10px; font-size:12px; color:#999; border-top:1px dashed #eee; padding-top:5px;">
                    <div style="margin-bottom:2px;">Ââ©‰ΩôÂ∏ÉÊñô:</div>`;
                
                for (let [size, count] of Object.entries(wasteGroups)) {
                    wasteHtml += `<div style="display:flex; justify-content:space-between;">
                        <span>${size}cm</span>
                        <span>x${count}</span>
                    </div>`;
                }
                wasteHtml += `</div>`;
            }
        }

        const scale = Math.min(200 / W, 200 / H); 
        const cw = W * scale;
        const ch = H * scale;
        const canvasId = `cvs-${Date.now()}-${idx}`;
        
        card.innerHTML = `
            <div class="sol-header">
                <span style="font-weight:bold; color:#333; white-space:nowrap;">ÊñπÊ°à #${idx}</span>
                <div style="display:flex; gap:5px; align-items:center;">
                    <span class="sol-badge">${(sol.utilization * 100).toFixed(1)}% Âà©Áî®Áéá</span>
                </div>
            </div>
            <div class="sol-body">
                <div class="sol-canvas-wrapper" onclick="openZoom(${idx-1})" style="cursor:pointer;">
                    <canvas id="${canvasId}" width="${cw}" height="${ch}"></canvas>
                </div>
                <div class="sol-info">
                    <div style="margin-bottom:10px; font-weight:bold; font-size:13px; color:#333;">Êï∞ÈáèÁªüËÆ°</div>
                    ${statsHtml}
                    ${wasteHtml}
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                         <div style="font-size:12px; color:#999;">ÊÄªÂ∞∫ÂØ∏: ${W}x${H} cm</div>
                    </div>
                </div>
            </div>
        `;
        listEl.appendChild(card);
        
        setTimeout(() => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            ctx.scale(scale, scale);
            
            sol.placements.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 1 / scale;
                ctx.strokeRect(p.x, p.y, p.w, p.h);
                
                if (p.w * scale > 20 && p.h * scale > 10) {
                    ctx.fillStyle = '#000';
                    ctx.font = `${10/scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
                }
            });
            
            if(sol.leftovers) {
                sol.leftovers.forEach(l => {
                    if (l.w > 0.5 && l.h > 0.5) {
                         ctx.strokeStyle = '#888';
                         ctx.setLineDash([3/scale, 3/scale]);
                         ctx.lineWidth = 1 / scale;
                         ctx.strokeRect(l.x, l.y, l.w, l.h);
                         
                         // Show text if space allows (threshold relaxed)
                         ctx.setLineDash([]);
                    }
                });
            }
        }, 0);
    }
    function toggleMainMenu() {
        const menu = document.getElementById('mainMenuDropdown');
        const isVisible = menu.style.display === 'block';
        menu.style.display = isVisible ? 'none' : 'block';
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        // Handle dropdown menu close (legacy, removing)
        const menu = document.getElementById('mainMenuDropdown');
        if (menu && menu.style.display === 'block') menu.style.display = 'none';

        // Handle bottom sheet close
        const sheet = document.getElementById('moreMenuSheet');
        if (sheet && sheet.classList.contains('show') && e.target === sheet) {
            toggleMoreMenu();
        }
    });

    function navToDock(tab) {
        // Save state for refresh
        localStorage.setItem('mard_last_nav', JSON.stringify({ method: 'navToDock', arg: tab }));

        // Update Pull-to-Refresh behavior
        updatePullToRefresh(tab);

        // Reset all active states
        document.querySelectorAll('.dock-item').forEach(el => el.classList.remove('active'));
        
        // Set active state
        let index = 0;
        if(tab === 'scan') index = 1;
        if(tab === 'plan') index = 2;
        if(tab === 'stats') index = 3;
        if(tab === 'more') index = 4; 
        
        const items = document.querySelectorAll('.dock-item');
        if (items[index]) {
            items[index].classList.add('active');
        }

        // Ensure dock is visible when navigating via dock
        document.getElementById('footer-dock').style.display = 'flex';

        // Hide all main pages first
        document.getElementById('page-beads').style.display = 'none';
        document.getElementById('page-stats').style.display = 'none';
        document.getElementById('page-fabric').style.display = 'none';
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-scan').style.display = 'none';
        const pagePlan = document.getElementById('page-plan');
        if (pagePlan) pagePlan.style.display = 'none';
        const pagePlanDetail = document.getElementById('page-plan-detail');
        if (pagePlanDetail) pagePlanDetail.style.display = 'none';
        const pageMore = document.getElementById('page-more');
        if (pageMore) pageMore.style.display = 'none';
        const pageHistory = document.getElementById('page-history');
        if (pageHistory) pageHistory.style.display = 'none';

        if (tab === 'inventory') {
            document.getElementById('page-beads').style.display = 'block';
            const fab = document.getElementById('floatingBatchAddBtn');
            if(fab) fab.style.display = 'flex';
            const homeBtn = document.getElementById('floatingHomeBtn');
            if(homeBtn) homeBtn.style.display = 'flex';
        } else if (tab === 'scan') {
             // Re-use navTo for scan to ensure correct initialization if needed, 
             // but here we just show the div as navTo handles dock hiding which we don't want
             document.getElementById('page-scan').style.display = 'block';
             const fab = document.getElementById('floatingBatchAddBtn');
             if(fab) fab.style.display = 'none';
             const homeBtn = document.getElementById('floatingHomeBtn');
             if(homeBtn) homeBtn.style.display = 'none';
        } else if (tab === 'plan') {
             if (pagePlan) {
                 pagePlan.style.display = 'block';
                 renderPlans();
             }
             const fab = document.getElementById('floatingBatchAddBtn');
             if(fab) fab.style.display = 'none';
             const homeBtn = document.getElementById('floatingHomeBtn');
             if(homeBtn) homeBtn.style.display = 'none';
        } else if (tab === 'stats') {
             document.getElementById('page-stats').style.display = 'block';
             renderStats();
             const fab = document.getElementById('floatingBatchAddBtn');
             if(fab) fab.style.display = 'none';
             const homeBtn = document.getElementById('floatingHomeBtn');
             if(homeBtn) homeBtn.style.display = 'none';
        } else if (tab === 'more') {
             if (pageMore) pageMore.style.display = 'block';
             const fab = document.getElementById('floatingBatchAddBtn');
             if(fab) fab.style.display = 'none';
             const homeBtn = document.getElementById('floatingHomeBtn');
             if(homeBtn) homeBtn.style.display = 'none';
        }
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // --- Êâ´ÊèèÂäüËÉΩ ---
    let cropper = null;
    let currentScanResults = new Map();
    let currentScanRawText = '';
    let currentScanSortType = 'code'; // 'code' | 'qty'
    let currentScanPrioritizeMissing = false;

    function toggleScanSort(type) {
        if (currentScanSortType === type) return;
        currentScanSortType = type;
        renderScanResults();
    }

    function toggleScanMissingPriority() {
        currentScanPrioritizeMissing = !currentScanPrioritizeMissing;
        renderScanResults();
    }

    function handleScanImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = document.getElementById('scanPreviewImg');
                img.src = e.target.result;
                
                // UI Switch to Crop Mode (Preview Only)
                document.getElementById('scanPreview').style.display = 'none';
                document.getElementById('cropContainer').style.display = 'block';
                document.getElementById('cropControls').style.display = 'flex';
                document.getElementById('scanResult').style.display = 'none';
                
                // DO NOT Initialize Cropper here. Just show the image.
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            };
            
            reader.readAsDataURL(file);
        }
    }

    let pendingScanBlob = null;
    let currentPreviewZoom = 1;

    // Triggered by "ÂºÄÂßãË£ÅÂàá"
    function openCropEditor() {
        const sourceImg = document.getElementById('scanPreviewImg');
        const editImg = document.getElementById('cropEditImage');
        
        if (!sourceImg.src) return;
        
        editImg.src = sourceImg.src;
        // Use flex to ensure full screen layout works
        document.getElementById('cropEditModal').style.display = 'flex';
        
        // Destroy previous instance if any
        if (cropper) {
            cropper.destroy();
        }
        
        // Initialize Cropper in Full Screen Modal
        cropper = new Cropper(editImg, {
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.95,
            background: true, 
            responsive: true,
            rotatable: true,
            scalable: true
        });
    }

    function closeCropEditor() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        document.getElementById('cropEditModal').style.display = 'none';
    }

    // Triggered by "È¢ÑËßà" in Edit Modal
    function showCropPreview() {
        if (!cropper) return;
        
        // 1. Get High Quality Crop
        const canvas = cropper.getCroppedCanvas({
            maxWidth: 4096,
            maxHeight: 4096,
            fillColor: '#fff'
        });
        
        // 2. Show Preview Modal
        const previewImg = document.getElementById('cropPreviewImage');
        previewImg.src = canvas.toDataURL();
        
        // Reset Zoom
        currentPreviewZoom = 1;
        previewImg.style.transform = `scale(${currentPreviewZoom})`;
        
        // Show Preview on top of Edit Modal
        document.getElementById('cropPreviewModal').style.display = 'flex';
        
        // Save blob for later confirmation
        canvas.toBlob((blob) => {
            pendingScanBlob = blob;
        }, 'image/png');
    }

    function closeCropPreview() {
        // Just hide Preview, revealing Edit Modal below
        document.getElementById('cropPreviewModal').style.display = 'none';
    }

    function zoomPreview(delta) {
        currentPreviewZoom += delta;
        if (currentPreviewZoom < 0.2) currentPreviewZoom = 0.2;
        if (currentPreviewZoom > 5) currentPreviewZoom = 5;
        document.getElementById('cropPreviewImage').style.transform = `scale(${currentPreviewZoom})`;
    }

    async function confirmScanFromPreview() {
        if (!pendingScanBlob) return;
        
        // Hide All Modals
        closeAllModals();
        
        // Clean up cropper
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        
        // Proceed with Scan
        await performScan(pendingScanBlob);
        
        // Clear pending
        pendingScanBlob = null;
    }

    function reCropImage() {
        // Just reset the zoom level for the next preview
        currentPreviewZoom = 1;
        const img = document.getElementById('cropPreviewImage');
        if(img) img.style.transform = `scale(${currentPreviewZoom})`;
        
        // Close preview modal if open
        closeAllModals();

        // The cropper on the main page is still active, so user can just adjust and click crop again.
    }

    function preprocessCanvas(sourceCanvas) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Scale up (2.5x) for clearer text
        const scale = 2.5;
        canvas.width = sourceCanvas.width * scale;
        canvas.height = sourceCanvas.height * scale;
        
        // Draw scaled image
        ctx.drawImage(sourceCanvas, 0, 0, canvas.width, canvas.height);
        
        // Grayscale & Binarization (Thresholding)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const threshold = 160; // Threshold value (0-255)
        
        for (let i = 0; i < data.length; i += 4) {
            // Luma (Grayscale)
            const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
            
            // Binarization: Black or White
            const val = avg < threshold ? 0 : 255;
            
            data[i] = val;     // R
            data[i + 1] = val; // G
            data[i + 2] = val; // B
            // Alpha (data[i+3]) remains unchanged
        }
        
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }

    async function performScan(file) {
        // UI Updates for Scan Start
        const blobUrl = URL.createObjectURL(file);
        document.getElementById('scanResultImage').src = blobUrl;
        
        // Set Original Full Image
        const originalImg = document.getElementById('scanPreviewImg');
        const fullImgEl = document.getElementById('scanResultFullImage');
        if (fullImgEl && originalImg) {
            fullImgEl.src = originalImg.src;
        }

        // Set Process Previews
        document.getElementById('scanProcessOriginal').src = originalImg.src;
        document.getElementById('scanProcessCropped').src = blobUrl;
        document.getElementById('cropContainer').style.display = 'none';
        document.getElementById('scanProcessPreviews').style.display = 'block';

        document.getElementById('scanLoading').style.display = 'flex';
        document.getElementById('cropControls').style.display = 'none'; // Lock controls
        document.getElementById('scanResult').style.display = 'none';
        // Hide crop container during loading to keep UI clean
        // document.getElementById('cropContainer').style.display = 'none'; // Already hidden above
        
        const statusEl = document.getElementById('scanStatusText');
        statusEl.innerText = "Ê≠£Âú®ËøûÊé• Gemini AI ËøõË°åÊô∫ËÉΩËØÜÂà´...";

        try {
            // 1. Convert Blob to Base64
            const base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const result = reader.result;
                    // Remove "data:image/png;base64," prefix
                    const base64 = result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });

            // 2. Dynamic Model Discovery & Prioritization
            // API Key will be retrieved per model to ensure load balancing
            statusEl.innerText = "Ê≠£Âú®Ëé∑ÂèñÂèØÁî®Ê®°ÂûãÂàóË°®...";
            
            let candidateModels = [];
            // const defaultModel = 'gemini-2.0-flash'; // Unused


            // --- Model Usage Tracking Logic (User Request) ---
            // Using Global ModelUsageManager defined in main script

            // Define strict priority list as requested
            let priorityList = [
                'gemini-3-flash-preview',
                'gemini-2.5-flash',
                'gemini-2.5-flash-lite'
            ];

            // Filter by usage limit
            candidateModels = [];
            for (const m of priorityList) {
                if (ModelUsageManager.canUse(m)) {
                    candidateModels.push(m);
                } else {
                    console.log(`Model ${m} reached daily limit (${ModelUsageManager.limit}). Skipping.`);
                }
            }
            
            if (candidateModels.length === 0) {
                 console.warn("All custom models exhausted. Using fallback (Lite).");
                 // Fallback to the most economical model if all limits are reached
                 candidateModels = ['gemini-2.5-flash-lite']; 
            }

            console.log("Candidate Models Sequence:", candidateModels);

            // 3. Loop through models (Failover Logic)
            let result = null;
            let lastError = null;
            let usedModel = '';
            
            const prompt = `
                Analyze this image of a bead inventory list.
                Identify all color codes (e.g., A1, B-2, 310, 823) and their corresponding quantities (numbers).
                The quantity is usually physically located below or next to the color code.
                Pay attention to the grid layout.
                
                Return a JSON object where keys are the color codes (string) and values are the quantities (integer).
                Example format: {"A1": 50, "B2": 30, "310": 100}
                
                IMPORTANT: Return ONLY the valid JSON string. Do not include markdown formatting like \`\`\`json.
            `;

            for (const modelName of candidateModels) {
                try {
                    statusEl.innerText = `Ê≠£Âú®Â∞ùËØï‰ΩøÁî® ${modelName} ...`;
                    // Visual feedback on retry
                    if (lastError) {
                        statusEl.innerText += ` (Ëá™Âä®ÂàáÊç¢‰∏≠)`;
                    }

                    console.log(`Attempting model: ${modelName}`);
                    
                    const keyObj = ModelUsageManager.getUsableKeyObj(modelName);
                    if (!keyObj || !keyObj.apiKey) throw new Error("No available API Key for this model (Quota exceeded)");
                    
                    const dynamicKey = keyObj.apiKey;
                    const usedKeyId = keyObj.keyId;

                    // Support multiple API versions for newer/preview models
                    const apiVersions = ['v1beta', 'v1alpha'];
                    let response = null;
                    let success = false;
                    let fetchError = null;

                    for (const version of apiVersions) {
                        try {
                            const url = `https://generativelanguage.googleapis.com/${version}/models/${modelName}:generateContent?key=${dynamicKey}`;
                            
                            const attemptResp = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [
                                            { text: prompt },
                                            { inline_data: { mime_type: "image/png", data: base64Data } }
                                        ]
                                    }]
                                })
                            });

                            if (attemptResp.status === 404 && version === 'v1beta') {
                                console.warn(`Model ${modelName} not found in v1beta, trying v1alpha...`);
                                continue; // Try next version
                            }

                            if (!attemptResp.ok) {
                                const errData = await attemptResp.json();
                                throw new Error(errData.error?.message || `API Status ${attemptResp.status}`);
                            }

                            response = attemptResp;
                            success = true;
                            break; // Success
                        } catch (verErr) {
                            fetchError = verErr;
                            // If it's a 404, we might retry loop. If other error (like 429), stop trying versions and fail model.
                            if (!verErr.message.includes('404') && !verErr.message.includes('Not Found')) {
                                break;
                            }
                        }
                    }

                    if (!success) {
                        throw fetchError || new Error("Model not found in any API version");
                    }

                    result = await response.json();
                    usedModel = modelName;
                    console.log(`Success with model: ${modelName} using KeyID: ${usedKeyId}`);
                    ModelUsageManager.increment(modelName, usedKeyId); // Track usage for specific key
                    break; // Success! Exit loop

                } catch (e) {
                    console.warn(`Model ${modelName} failed:`, e.message);
                    lastError = e;
                    
                    // Show specific error to user and pause briefly so they can see why it failed
                    const shortMsg = e.message.length > 60 ? e.message.slice(0, 60) + '...' : e.message;
                    let friendlyMsg = shortMsg;
                    if (e.message.includes('404')) friendlyMsg = "Ê®°Âûã‰∏çÂ≠òÂú® (404)";
                    if (e.message.includes('400')) friendlyMsg = "ËØ∑Ê±ÇÊó†Êïà (400)";
                    if (e.message.includes('429')) friendlyMsg = "È¢ùÂ∫¶ËÄóÂ∞Ω (429)";
                    if (e.message.includes('403') || e.message.includes('401')) friendlyMsg = "API Key Êó†Êïà";
                    
                    statusEl.innerHTML = `<span style="color:#ff4d4f">‚ùå ${modelName} Â§±Ë¥•: ${friendlyMsg}</span><br>üîÑ Ê≠£Âú®ÂàáÊç¢‰∏ã‰∏ÄÊ®°Âûã...`;
                    
                    // Wait 2 seconds before trying next model
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            if (!result) {
                throw lastError || new Error("ÊâÄÊúâÂèØÁî®Ê®°ÂûãÂùáÂ∞ùËØïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ Key ÈÖçÈ¢ù„ÄÇ");
            }
            
            // 4. Parse Response
            const candidate = result.candidates?.[0];
            if (!candidate) throw new Error("No response candidates from Gemini");

            if (!candidate.content || !candidate.content.parts || !candidate.content.parts[0]) {
                 console.error("Gemini Candidate Error:", candidate);
                 // Check if it's a safety block
                 if (candidate.finishReason === 'SAFETY') {
                     throw new Error("ÂõæÁâáÂÜÖÂÆπË¢´ AI ÂÆâÂÖ®Á≠ñÁï•Êã¶Êà™ÔºåÊó†Ê≥ïËØÜÂà´„ÄÇ");
                 }
                 throw new Error("Gemini ÂìçÂ∫îÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊ†ºÂºèÈîôËØØ");
            }

            const rawText = candidate.content.parts[0].text;
            console.log("Gemini Raw:", rawText);
            
            // Clean markdown if present (just in case)
            const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            
            let dataMap;
            try {
                dataMap = JSON.parse(jsonStr);
            } catch (e) {
                console.error("JSON Parse Error", e);
                throw new Error("Gemini ËøîÂõû‰∫ÜÊó†Ê≥ïËß£ÊûêÁöÑÊï∞ÊçÆÊ†ºÂºè");
            }
            
            // Convert to Map for existing render function
            const codeMap = new Map();
            Object.entries(dataMap).forEach(([key, value]) => {
                // Basic cleanup of keys (uppercase) and values (int)
                codeMap.set(key.toUpperCase(), parseInt(value));
            });

            // 5. Render Results
            document.getElementById('scanLoading').style.display = 'none';
            document.getElementById('scanResult').style.display = 'block';
            document.getElementById('scan-uploader').style.display = 'none'; // Hide uploader area
            
            // Store global state
            currentScanResults = codeMap;
            currentScanRawText = `[Used Model: ${usedModel}]\n` + rawText;

            renderScanResults();

        } catch (err) {
            console.error(err);
            alert('ËØÜÂà´Âá∫Èîô: ' + (err.message || "Êú™Áü•ÈîôËØØ"));
            document.getElementById('scanLoading').style.display = 'none';
            document.getElementById('cropControls').style.display = 'flex'; // Restore controls
            document.getElementById('cropContainer').style.display = 'block'; // Restore crop container
            document.getElementById('scanProcessPreviews').style.display = 'none'; // Hide process previews
        }
    }

    function cancelScan() {
        // Just reload for now as simple cancellation
        resetScan();
    }

    // Removed old analyzeScanResult as Gemini handles logic now

    function renderScanResults() {
        // Ensure status bar is hidden
        document.getElementById('scanInlineStatus').style.display = 'none';

        const listContainer = document.getElementById('scanList');
        listContainer.innerHTML = '';
        
        const codeMap = currentScanResults;
        const rawText = currentScanRawText;

        // Update sort buttons state
        const btnCode = document.getElementById('btn-sort-code');
        const btnQty = document.getElementById('btn-sort-qty');
        const btnMissing = document.getElementById('btn-scan-missing');
        
        if(btnCode && btnQty && btnMissing) {
            const activeStyle = "font-size: 12px; padding: 2px 8px; border: 1px solid #1890ff; background: #e6f7ff; color: #1890ff; border-radius: 4px; font-weight: bold;";
            const inactiveStyle = "font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; color: #666; border-radius: 4px;";
            
            btnCode.style.cssText = currentScanSortType === 'code' ? activeStyle : inactiveStyle;
            btnQty.style.cssText = currentScanSortType === 'qty' ? activeStyle : inactiveStyle;
            btnMissing.style.cssText = currentScanPrioritizeMissing ? activeStyle : inactiveStyle;
        }

        // Update header count
        const countEl = document.getElementById('scanTotalCount');
        if (countEl) {
            let totalQty = 0;
            codeMap.forEach(qty => totalQty += qty);
            countEl.innerHTML = `<span style="background:#e6f7ff; color:#1890ff; padding:2px 8px; border-radius:10px; font-weight:bold;">${codeMap.size} Ëâ≤ / ${totalQty} Á≤í</span>`;
        }

        // --- Debug Details Section ---
        const detailsId = 'scan-debug-details';
        let detailsBtn = document.getElementById('scan-debug-btn');
        let detailsEl = document.getElementById(detailsId);
        
        if (!detailsEl) {
             const btn = document.createElement('button');
             btn.id = 'scan-debug-btn';
             btn.className = 'm-btn m-btn-ghost';
             btn.style.marginTop = '10px';
             btn.style.fontSize = '12px';
             btn.innerText = 'üîç ÊòæÁ§∫/ÈöêËóè ËØÜÂà´ËØ¶ÊÉÖ (Debug)';
             btn.onclick = () => {
                 const el = document.getElementById(detailsId);
                 el.style.display = el.style.display === 'none' ? 'block' : 'none';
             };
             
             detailsEl = document.createElement('div');
             detailsEl.id = detailsId;
             detailsEl.style.display = 'none';
             detailsEl.style.marginTop = '10px';
             detailsEl.style.padding = '10px';
             detailsEl.style.background = '#f5f5f5';
             detailsEl.style.border = '1px solid #ddd';
             detailsEl.style.borderRadius = '8px';
             detailsEl.style.fontSize = '11px';
             detailsEl.style.fontFamily = 'monospace';
             detailsEl.style.whiteSpace = 'pre-wrap';
             detailsEl.style.wordBreak = 'break-all';
             
             document.getElementById('scanResult').appendChild(btn);
             document.getElementById('scanResult').appendChild(detailsEl);
        }
        
        // Update debug info
        if (detailsEl) {
            detailsEl.innerText = 
                `=== Raw Text ===\n${rawText}\n\n=== Parsed Pairs ===\n${JSON.stringify(Array.from(codeMap.entries()), null, 2)}`;
        }


        // --- Main List Rendering ---
        if (codeMap.size === 0) {
            listContainer.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #fa8c16; background: #fffbe6; border-radius: 8px; border: 1px solid #ffe58f;">
                    Êú™ËØÜÂà´Âà∞ÊúâÊïàÁöÑËâ≤Âè∑Êï∞ÊçÆ„ÄÇ<br>ËØ∑Â∞ùËØïË∞ÉÊï¥Ë£ÅÂàáÂå∫ÂüüÔºåÁ°Æ‰øùÂè™ÂåÖÂê´„ÄêËâ≤Âè∑ÂíåÊï∞Èáè„Äë„ÄÇ
                </div>
            `;
            // Add "Add Manually" button even if empty
             const addBtn = document.createElement('button');
             addBtn.className = 'm-btn m-btn-ghost';
             addBtn.style.marginTop = '10px';
             addBtn.innerHTML = '+ ÊâãÂä®Ê∑ªÂä†Ëâ≤Âè∑';
             addBtn.onclick = addScanItem;
             listContainer.appendChild(addBtn);
            return;
        }

        let totalMissing = 0;
        let missingCodes = 0;
        const BEAD_WEIGHT_PER_100 = 1; 

        // Convert map to array for sorting
        let sortedEntries = Array.from(codeMap.entries());
        
        // 1. Primary Sort (Code or Qty)
        if (currentScanSortType === 'qty') {
            sortedEntries.sort((a, b) => b[1] - a[1]);
        } else {
            sortedEntries.sort((a, b) => a[0].localeCompare(b[0], undefined, {numeric: true}));
        }

        // 2. Priority Sort (Missing First)
        if (currentScanPrioritizeMissing) {
            sortedEntries.sort((a, b) => {
                const getShortage = (code, qty) => {
                    const item = data.find(d => d.id === code);
                    const stock = item ? (item.w || 0) : 0;
                    const requiredWeight = qty / 100 * BEAD_WEIGHT_PER_100;
                    return stock < requiredWeight ? 1 : 0; // 1 = missing, 0 = ok
                };
                
                const missingA = getShortage(a[0], a[1]);
                const missingB = getShortage(b[0], b[1]);
                
                return missingB - missingA; // Missing first (descending order of isMissing)
            });
        }

        sortedEntries.forEach(([code, qty]) => {
            const item = data.find(d => d.id === code);
            const stock = item ? (item.w || 0) : 0;
            const hex = item ? item.hex : '#f0f0f0';
            
            const isUnknown = !item;
            
            const requiredWeight = qty / 100 * BEAD_WEIGHT_PER_100;
            const isMissing = !isUnknown && stock < requiredWeight;
            const shortage = isMissing ? (requiredWeight - stock) : 0;
            
            if (isMissing) {
                totalMissing += shortage;
                missingCodes++;
            }

            const row = document.createElement('div');
            row.style.cssText = 'display:flex; align-items:center; padding:12px; border-bottom:1px solid #f0f0f0; background:white; border-radius:8px; margin-bottom:8px;';
            
            // Unknown Color Logic
            if (isUnknown) {
                 row.style.borderLeft = '4px solid #fa8c16';
                 row.style.background = '#fff7e6';
            }

            row.innerHTML = `
                <div class="swatch" onclick="openScanColorModal('${code}')" style="width:30px; height:30px; background:${hex}; border-radius:50%; border:1px solid #ddd; margin-right:12px; flex-shrink:0; cursor:pointer; position:relative;">
                    <div style="position:absolute; right:-2px; bottom:-2px; background:white; border-radius:50%; width:12px; height:12px; display:flex; align-items:center; justify-content:center; border:1px solid #ddd;">
                        <span style="font-size:8px; color:#666;">‚ñº</span>
                    </div>
                </div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <b style="font-size:16px; color:#333;">
                            ${code} 
                            ${isUnknown ? '<span style="font-size:10px; background:#fa8c16; color:white; padding:2px 4px; border-radius:4px; margin-left:5px; vertical-align:middle;">Á≥ªÁªüÊó†Ê≠§Ëâ≤Âè∑</span>' : ''}
                        </b>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span onclick="openScanQtyModal('${code}')" style="font-size:14px; color:#1890ff; background:#e6f7ff; padding:2px 8px; border-radius:4px; cursor:pointer; border:1px dashed #91d5ff;">
                                ÈúÄ ${qty}Á≤í ‚úé
                            </span>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:13px;">
                        ${isUnknown 
                            ? `<span style="color:#fa8c16;">ËØ∑Á°ÆËÆ§Ëâ≤Âè∑ÊòØÂê¶Ê≠£Á°ÆÊàñÁÇπÂáªÂ∑¶‰æß‰øÆÊîπ</span>` 
                            : `<span style="color:#999;">Â∫ìÂ≠ò: ${stock}g</span>
                               ${isMissing 
                                   ? `<span style="color:#ff4d4f; font-weight:bold;">Áº∫ ${shortage.toFixed(1)}g</span>` 
                                   : '<span style="color:#52c41a; font-weight:bold;">ÂÖÖË∂≥</span>'}`
                        }
                    </div>
                </div>
                <div style="margin-left:10px;">
                    <button onclick="deleteScanItem('${code}')" style="background:none; border:none; color:#999; padding:5px; cursor:pointer; font-size:24px; line-height: 1;">√ó</button>
                </div>
            `;
            listContainer.appendChild(row);
        });
        
        // Summary Card
        const summaryCard = document.createElement('div');
        if (missingCodes > 0) {
            summaryCard.innerHTML = `‚ö†Ô∏è ÂÖ±Áº∫Ë¥ß <b>${missingCodes}</b> Áßç (ÈúÄË°• ${totalMissing.toFixed(1)}g)`;
            summaryCard.style.cssText = 'padding: 10px; background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 13px;';
        } else {
            summaryCard.innerHTML = `üéâ Â∫ìÂ≠òÂÖ®ÈÉ®ÂÖÖË∂≥ÔºÅ`;
            summaryCard.style.cssText = 'padding: 10px; background: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 13px;';
        }
        listContainer.insertBefore(summaryCard, listContainer.firstChild);

        // Add "Add" Button
        const addBtn = document.createElement('button');
        addBtn.className = 'm-btn m-btn-ghost';
        addBtn.style.marginTop = '10px';
        addBtn.style.width = '100%';
        addBtn.innerHTML = '+ Ê∑ªÂä†Ëâ≤Âè∑';
        addBtn.onclick = addScanItem;
        listContainer.appendChild(addBtn);
    }

    let currentScanEditCode = null;

    // --- Scan Qty Modify Modal Logic ---
    function openScanQtyModal(code) {
        currentScanEditCode = code;
        const currentQty = currentScanResults.get(code);
        
        document.getElementById('scanQtyCode').innerText = code;
        document.getElementById('scanQtyInput').value = currentQty;
        
        showModal('scanQtyModal');
    }

    function adjustScanQty(delta) {
        const input = document.getElementById('scanQtyInput');
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 0) val = 0;
        input.value = val;
    }

    function submitScanQty() {
        if (!currentScanEditCode) return;
        const input = document.getElementById('scanQtyInput');
        const val = parseInt(input.value);
        
        if (!isNaN(val) && val >= 0) {
            currentScanResults.set(currentScanEditCode, val);
            renderScanResults();
            closeAllModals();
            showToast(`Â∑≤Êõ¥Êñ∞Ëâ≤Âè∑ ${currentScanEditCode} Êï∞Èáè`);
        } else {
            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠óÔºÅ");
        }
    }

    // --- Scan Color Select Modal Logic ---
    function openScanColorModal(code) {
        currentScanEditCode = code;
        document.getElementById('scanColorSearch').value = '';
        renderScanColorList('');
        showModal('scanColorModal');
        // Auto focus search
        setTimeout(() => document.getElementById('scanColorSearch').focus(), 100);
    }

    function filterScanColorList() {
        const filter = document.getElementById('scanColorSearch').value;
        renderScanColorList(filter);
    }

    function renderScanColorList(filter) {
        const container = document.getElementById('scanColorList');
        container.innerHTML = '';
        
        const filterText = filter.toUpperCase();
        
        // Use 'data' global variable which contains all beads
        const filtered = data.filter(d => d.id.toUpperCase().includes(filterText));
        
        // Limit results for performance if empty filter
        const displayList = (filterText === '' ? filtered.slice(0, 50) : filtered);
        
        if (displayList.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Êó†ÂåπÈÖçËâ≤Âè∑</div>';
            return;
        }

        displayList.forEach(item => {
            const isCurrent = item.id === currentScanEditCode;
            const div = document.createElement('div');
            div.style.cssText = `display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; background:${isCurrent ? '#e6f7ff' : 'white'}; cursor:pointer; border-radius:8px; margin-bottom:5px;`;
            div.onclick = () => selectScanColor(item.id);
            
            div.innerHTML = `
                <div style="width:30px; height:30px; background:${item.hex}; border-radius:50%; border:1px solid #ddd; margin-right:15px;"></div>
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#333;">${item.id}</div>
                    <div style="font-size:12px; color:#999;">Â∫ìÂ≠ò: ${item.w || 0}g</div>
                </div>
                ${isCurrent ? '<span style="color:#1890ff; font-weight:bold;">ÂΩìÂâç</span>' : ''}
            `;
            container.appendChild(div);
        });
        
        if (filterText === '' && data.length > 50) {
            const more = document.createElement('div');
            more.style.cssText = 'text-align:center; padding:10px; color:#999; font-size:12px;';
            more.innerText = `ÊòæÁ§∫Ââç 50 ‰∏™ÁªìÊûú (ÂÖ± ${data.length} ‰∏™)ÔºåËØ∑ËæìÂÖ•ÊêúÁ¥¢ËØçÊü•Êâæ`;
            container.appendChild(more);
        }
    }

    function selectScanColor(newCode) {
        if (!currentScanEditCode || currentScanEditCode === newCode) {
            closeAllModals();
            return;
        }

        // Check if new code already exists in scan results
        const existingQty = currentScanResults.get(newCode);
        const currentQty = currentScanResults.get(currentScanEditCode);

        if (existingQty !== undefined) {
             // Merge qty? Or overwrite? User intent implies switching identity. 
             // Let's ask or just merge. Merging seems safer for "switching" if user made a mistake.
             // But usually switching means "I identified this wrong, it's actually X".
             // If X is already in the list, we should probably add the qty to X and remove the old entry.
             if(confirm(`ÂàóË°®ÈáåÂ∑≤ÁªèÂ≠òÂú®Ëâ≤Âè∑ ${newCode} (Êï∞Èáè: ${existingQty})„ÄÇ\nÊòØÂê¶ÂêàÂπ∂Êï∞ÈáèÔºü\n(Â¶ÇÊûú‰∏çÂêàÂπ∂ÔºåÂ∞ÜË¶ÜÁõñÂéüÊúâÊï∞Èáè)`)) {
                 currentScanResults.set(newCode, existingQty + currentQty);
             } else {
                 // Do nothing? or set to currentQty? 
                 // Let's assume merge is preferred, but if cancelled, maybe just replace value
                 currentScanResults.set(newCode, currentQty); 
             }
        } else {
            // New entry
            currentScanResults.set(newCode, currentQty);
        }
        
        // Remove old entry
        currentScanResults.delete(currentScanEditCode);
        
        renderScanResults();
        closeAllModals();
        showToast(`Â∑≤ÂàáÊç¢‰∏∫Ëâ≤Âè∑ ${newCode}`);
    }


    let currentScanDeleteCode = null;

    function deleteScanItem(code) {
        currentScanDeleteCode = code;
        document.getElementById('scanDeleteCode').innerText = code;
        showModal('scanDeleteConfirmModal');
    }

    function confirmDeleteScanItem() {
        if (currentScanDeleteCode) {
            currentScanResults.delete(currentScanDeleteCode);
            renderScanResults();
            closeAllModals();
            showToast(`Â∑≤Âà†Èô§Ëâ≤Âè∑ ${currentScanDeleteCode}`);
        }
    }

    function addScanItem() {
        document.getElementById('scanAddCodeInput').value = '';
        document.getElementById('scanAddQtyInput').value = '0';
        showModal('scanAddModal');
        setTimeout(() => document.getElementById('scanAddCodeInput').focus(), 100);
    }

    function adjustAddScanQty(delta) {
        const input = document.getElementById('scanAddQtyInput');
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 0) val = 0;
        input.value = val;
    }

    function submitAddScanItem() {
        const codeInput = document.getElementById('scanAddCodeInput');
        const qtyInput = document.getElementById('scanAddQtyInput');
        
        const code = codeInput.value.toUpperCase().trim();
        const qty = parseInt(qtyInput.value);

        if (!code) {
            showToast("ËØ∑ËæìÂÖ•Ëâ≤Âè∑ÔºÅ");
            return;
        }

        if (isNaN(qty) || qty < 0) {
            showToast("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞ÈáèÔºÅ");
            return;
        }

        if (currentScanResults.has(code)) {
            showToast(`Ëâ≤Âè∑ ${code} Â∑≤Â≠òÂú®ÔºÅËØ∑Áõ¥Êé•Âú®ÂàóË°®‰∏≠‰øÆÊîπÊï∞Èáè„ÄÇ`);
            return;
        }

        currentScanResults.set(code, qty);
        renderScanResults();
        closeAllModals();
        showToast(`Â∑≤Ê∑ªÂä†Ëâ≤Âè∑ ${code}`);
        
        // Scroll to bottom or new item? 
        // renderScanResults might sort, so we can't easily scroll to it without finding it.
    }

    function resetScan() {
        document.getElementById('scanInput').value = '';
        document.getElementById('scanPreviewImg').src = '';
        
        // Reset UI visibility
        document.getElementById('scan-uploader').style.display = 'block'; // Show uploader area
        document.getElementById('scanPreview').style.display = 'block';
        document.getElementById('cropContainer').style.display = 'none';
        document.getElementById('scanProcessPreviews').style.display = 'none';
        document.getElementById('cropControls').style.display = 'none';
        document.getElementById('scanResult').style.display = 'none';
        document.getElementById('scanLoading').style.display = 'none';
        
        // Clean up cropper
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
    }

    function toggleMoreMenu() {
        const sheet = document.getElementById('moreMenuSheet');
        if (sheet.classList.contains('show')) {
            sheet.classList.remove('show');
            setTimeout(() => { sheet.style.display = 'none'; }, 300);
        } else {
            sheet.style.display = 'block';
            // Trigger reflow
            sheet.offsetHeight; 
            sheet.classList.add('show');
        }
    }

    // --- ÊãºË±ÜËÆ°ÂàíÂäüËÉΩ ---

    function createPlan() {
        if (!currentScanResults || currentScanResults.size === 0) {
            alert('ÂΩìÂâçÊ≤°ÊúâËØÜÂà´ÁªìÊûúÔºåÊó†Ê≥ïÂàõÂª∫ËÆ°Âàí„ÄÇËØ∑ÂÖàÊâ´ÊèèÂõæÁ∫∏„ÄÇ');
            return;
        }

        const nameInput = document.getElementById('planNameInput');
        let planName = nameInput.value.trim();
        if (!planName) {
            const date = new Date();
            planName = `Êú™ÂëΩÂêçËÆ°Âàí ${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
        }

        // Capture Thumbnail
        let thumbnail = null;
        try {
            const originalImg = document.getElementById('scanPreviewImg');
            if (originalImg && originalImg.src && originalImg.naturalWidth > 0) {
                 // Create thumbnail from ORIGINAL image
                 const canvas = document.createElement('canvas');
                 const ctx = canvas.getContext('2d');
                 const maxDim = 1024; // Increased from 300 to 1024 for better quality
                 let w = originalImg.naturalWidth;
                 let h = originalImg.naturalHeight;
                 
                 if (w > h) {
                     if (w > maxDim) { h *= maxDim / w; w = maxDim; }
                 } else {
                     if (h > maxDim) { w *= maxDim / h; h = maxDim; }
                 }
                 
                 canvas.width = w;
                 canvas.height = h;
                 ctx.drawImage(originalImg, 0, 0, w, h);
                 thumbnail = canvas.toDataURL('image/jpeg', 0.8);
            } else if (typeof cropper !== 'undefined' && cropper) {
                // Fallback to cropper
                // Get full size cropped image instead of 150px
                thumbnail = cropper.getCroppedCanvas({
                    maxWidth: 1024,
                    maxHeight: 1024
                }).toDataURL('image/jpeg', 0.8);
            }
        } catch(e) {
            console.warn('Failed to create thumbnail', e);
        }

        const planItems = [];
        currentScanResults.forEach((qty, code) => {
            planItems.push({ code, qty });
        });

        // Get existing plans
        let plans = [];
        try {
            plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        } catch(e) {
            console.error('Error loading plans', e);
        }

        const newPlan = {
            id: 'plan_' + Date.now(),
            name: planName,
            createdAt: Date.now(),
            items: planItems,
            status: 'active', // active, completed
            thumbnail: thumbnail
        };

        plans.unshift(newPlan); // Add to top
        localStorage.setItem('bead_plans', JSON.stringify(plans));

        showToast(`ËÆ°Âàí "${planName}" ÂàõÂª∫ÊàêÂäüÔºÅ`);
        
        // Optional: clear input
        nameInput.value = '';
        resetScan(); // Auto clear scan page
        navToDock('plan');
        setPlanFilter('active');
    }

    function deductInventory() {
        if (!currentScanResults || currentScanResults.size === 0) {
            alert('ÂΩìÂâçÊ≤°ÊúâËØÜÂà´ÁªìÊûúÔºåÊó†Ê≥ïÊâ£ÂáèÂ∫ìÂ≠ò„ÄÇ');
            return;
        }

        // 1. Create Plan
        const date = new Date();
        // Check for user provided name
        const nameInput = document.getElementById('planNameInput');
        let userPlanName = nameInput && nameInput.value.trim() ? nameInput.value.trim() : '';
        
        const planName = userPlanName || `Êâ´ÊèèÊâ£Âáè ${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
        
        let planItems = [];
        currentScanResults.forEach((qty, code) => {
            planItems.push({ code, qty });
        });
        
        // Capture Thumbnail (reuse logic from createPlan, or simplify)
        let thumbnail = null;
        try {
            const originalImg = document.getElementById('scanPreviewImg');
            if (originalImg && originalImg.src && originalImg.naturalWidth > 0) {
                 const canvas = document.createElement('canvas');
                 const ctx = canvas.getContext('2d');
                 const maxDim = 3072; 
                 let w = originalImg.naturalWidth;
                 let h = originalImg.naturalHeight;
                 if (w > h) { if (w > maxDim) { h *= maxDim / w; w = maxDim; } } 
                 else { if (h > maxDim) { w *= maxDim / h; h = maxDim; } }
                 canvas.width = w; canvas.height = h;
                 ctx.drawImage(originalImg, 0, 0, w, h);
                 thumbnail = canvas.toDataURL('image/jpeg', 0.92);
            } else if (typeof cropper !== 'undefined' && cropper) {
                thumbnail = cropper.getCroppedCanvas({ maxWidth: 3072, maxHeight: 3072 }).toDataURL('image/jpeg', 0.92);
            }
        } catch(e) { console.error("Thumbnail error", e); }

        const newPlan = {
            id: 'plan_' + Date.now(),
            name: planName,
            createdAt: Date.now(),
            items: planItems,
            status: 'active', // Will be set to completed by deductPlanInventory
            thumbnail: thumbnail
        };

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        plans.unshift(newPlan);
        localStorage.setItem('bead_plans', JSON.stringify(plans));

        // 2. Execute Deduction (inline logic without confirm)
        
        const BEAD_WEIGHT_PER_100 = 1;
        let count = 0;
        
        newPlan.items.forEach(pItem => {
             const item = data.find(d => d.id === pItem.code);
             if(item) {
                 const weightToDeduct = parseFloat((pItem.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
                 item.w = parseFloat((item.w - weightToDeduct).toFixed(2));
                 
                 if (!item.logs) item.logs = [];
                 item.logs.push({
                    d: formatTime(new Date()),
                    type: 'use', 
                    val: weightToDeduct,
                    c: pItem.qty, 
                    desc: `ËÆ°ÂàíÊâ£Âáè: ${newPlan.name}`,
                    drawingName: newPlan.name,
                    planId: newPlan.id
                 });
                 item.totalUsed = parseFloat(((item.totalUsed || 0) + weightToDeduct).toFixed(2));
                 count++;
             }
        });
        
        if (count > 0) {
            save();
            render(); 
        }
        
        // Mark as completed
        newPlan.status = 'completed';
        newPlan.completedAt = Date.now();
        localStorage.setItem('bead_plans', JSON.stringify(plans)); // Save updated status
        
        showToast(`Â∑≤Ëá™Âä®ÂàõÂª∫ËÆ°ÂàíÂπ∂Êâ£Âáè ${count} ‰∏™Ëâ≤Âè∑Â∫ìÂ≠ò„ÄÇ`);
        resetScan(); // Auto clear scan page
        navToDock('plan');
        setPlanFilter('completed');
    }

    let currentPlanId = null;
    let isPlanSelectionMode = false;
    let selectedPlanIds = new Set();
    let expandedPlanIds = new Set();
    let expandedPlanColorIds = new Set();
    let longPressTimer = null;
    let currentPlanFilter = 'active';

    function setPlanFilter(status) {
        currentPlanFilter = status;
        
        const activeBtn = document.getElementById('filter-active');
        const completedBtn = document.getElementById('filter-completed');
        
        if(status === 'active') {
            activeBtn.style.background = 'white';
            activeBtn.style.color = '#4a90e2';
            activeBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
            completedBtn.style.background = 'transparent';
            completedBtn.style.color = '#999';
            completedBtn.style.boxShadow = 'none';
        } else {
            activeBtn.style.background = 'transparent';
            activeBtn.style.color = '#999';
            activeBtn.style.boxShadow = 'none';
            completedBtn.style.background = 'white';
            completedBtn.style.color = '#4a90e2';
            completedBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
        }
        
        renderPlans();
    }

    function renameCurrentPlan() {
        if (!currentPlanId) return;
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(currentPlanId, plans);
        if (!plan) return;

        openRenamePlanModal(plan.name);
    }

    function openRenamePlanModal(currentName) {
        const modal = document.getElementById('renamePlanModal');
        const input = document.getElementById('renamePlanInput');
        if (modal && input) {
            input.value = currentName;
            showModal('renamePlanModal');
            // Delay focus slightly to ensure modal is visible
            setTimeout(() => input.focus(), 100);
        }
    }

    function submitRenamePlan() {
        if (!currentPlanId) return;
        
        const input = document.getElementById('renamePlanInput');
        const newName = input.value.trim();
        
        if (newName) {
            let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
            const plan = findPlanById(currentPlanId, plans);
            
            if (plan) {
                plan.name = newName;
                localStorage.setItem('bead_plans', JSON.stringify(plans));
                
                // Update UI if we are viewing this plan
                const titleEl = document.getElementById('planDetailTitle');
                if (titleEl) titleEl.innerText = plan.name;
                
                renderPlans();
                showToast(`ËÆ°ÂàíÈáçÂëΩÂêç‰∏∫ "${newName}"`);
            }
        }
        closeAllModals();
    }

    function findPlanById(id, list) {
        if (!list) list = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        for (let p of list) {
            if (p.id == id) return p;
            if (p.subPlans) {
                const found = findPlanById(id, p.subPlans);
                if (found) return found;
            }
        }
        return null;
    }

    function aggregateActivePlanRequirements(plans) {
        const requirements = new Map();
        const BEAD_WEIGHT_PER_100 = 1; // 1g per 100 beads

        function processPlan(plan) {
            // If it's a folder, process its sub-plans
            if (plan.subPlans && plan.subPlans.length > 0) {
                // For collections, we check each sub-plan's status independently
                plan.subPlans.forEach(subPlan => {
                    // Only count ACTIVE sub-plans
                    if (subPlan.status === 'active') {
                        processPlan(subPlan);
                    }
                });
            } else if (plan.status === 'active' && plan.items) {
                // If it's a regular active plan, add its items
                plan.items.forEach(item => {
                    const current = requirements.get(item.code) || 0;
                    requirements.set(item.code, current + item.qty);
                });
            }
        }

        // Start processing top-level plans
        plans.forEach(plan => processPlan(plan));

        // Calculate shortages
        const shortages = [];
        requirements.forEach((qty, code) => {
            const bead = data.find(d => d.id === code);
            const currentStock = bead ? (bead.w || 0) : 0;
            // Check if monitoring is disabled (default is true/undefined, explicit false means disabled)
            const isMonitored = bead ? (bead.monitor !== false) : true;
            
            const neededWeight = (qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2);
            
            // Only report shortage if stock is insufficient AND monitoring is enabled
            if (currentStock < neededWeight && isMonitored) {
                shortages.push({
                    code,
                    neededQty: qty,
                    missingQty: Math.ceil((neededWeight - currentStock) * 100) / 100 
                });
                // Recalculate missing weight properly for display
                shortages[shortages.length - 1].missingQty = (neededWeight - currentStock).toFixed(2);
            }
        });

        return { requirements, shortages };
    }

    function renderPlans() {
        const container = document.getElementById('planList');
        if (!container) return;

        // Update Overview Stats if visible
        const overviewEl = document.getElementById('plan-overview-container');
        if (overviewEl && overviewEl.style.display !== 'none') {
            // Use debounce or just call it? calling it directly for now.
            // But we should avoid re-reading LS if possible. 
            // For now, simple implementation.
            updatePlanOverviewStats();
        }

        let plans = [];
        try {
            plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        } catch(e) {
            plans = [];
        }

        // Search
        const searchInput = document.getElementById('planSearch');
        const query = searchInput ? searchInput.value.trim().toLowerCase() : '';

        // Calculate counts
        // Helper to count real plans (leaves)
        const getRealCount = (list) => {
            let count = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    count += getRealCount(p.subPlans);
                } else {
                    count++;
                }
            });
            return count;
        };

        const activeList = plans.filter(p => (p.status || 'active') === 'active');
        const completedList = plans.filter(p => (p.status || 'active') === 'completed');

        const activeCount = getRealCount(activeList);
        const completedCount = getRealCount(completedList);
        
        // Update filter buttons text
        const activeBtn = document.getElementById('filter-active');
        const completedBtn = document.getElementById('filter-completed');
        if (activeBtn) activeBtn.innerText = `ËÆ°Âàí‰∏≠ (${activeCount})`;
        if (completedBtn) completedBtn.innerText = `Â∑≤ÂÆåÊàê (${completedCount})`;

        // Filter plans based on status (top level only)
        let filtered = plans.filter(p => (p.status || 'active') === currentPlanFilter);

        let isSearchMode = false;
        if (query) {
            isSearchMode = true;
            filtered = filterPlansByQuery(filtered, query);
        }

        if (filtered.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px;">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìã</div>
                    ${query ? 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËÆ°Âàí' : (currentPlanFilter === 'active' ? 'ÊöÇÊó†ËøõË°å‰∏≠ÁöÑËÆ°Âàí' : 'ÊöÇÊó†Â∑≤ÂÆåÊàêÁöÑËÆ°Âàí')}
                </div>
            `;
            return;
        }

        container.innerHTML = '';

        // Add Active Plan Summary (New Requirement)
        // Only show summary if NOT searching (to avoid confusion/clutter)
        if (currentPlanFilter === 'active' && !isSearchMode) {
             const summary = aggregateActivePlanRequirements(plans); // We pass all plans, function handles recursion and filtering
             if (summary && summary.requirements.size > 0) {
                 // Render Summary
                 const summaryCard = document.createElement('div');
                 summaryCard.style.cssText = 'background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid #bae7ff; box-shadow: 0 4px 12px rgba(24, 144, 255, 0.1);';
                 
                 let totalQty = 0;
                 summary.requirements.forEach(qty => totalQty += qty);
                 
                 let missingHtml = '';
                 if (summary.shortages.length > 0) {
                     summary.shortages.sort((a, b) => b.missingQty - a.missingQty);
                     const missingItems = summary.shortages.map(item => `
                         <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 6px; border: 1px solid #ffccc7; margin-bottom: 4px;">
                             <span style="font-weight: bold; color: #cf1322;">${item.code}</span>
                             <span style="font-size: 12px; color: #666;">Áº∫ ${item.missingQty}g</span>
                         </div>
                     `).join('');
                     
                     missingHtml = `
                         <div style="margin-top: 12px; padding-top: 10px; border-top: 1px dashed #ffa39e;">
                             <div style="font-size: 13px; font-weight: bold; color: #cf1322; margin-bottom: 8px; display: flex; align-items: center;">
                                <span style="margin-right: 4px;">‚ö†Ô∏è</span> Áº∫Ë¥ßÈ¢ÑË≠¶ (${summary.shortages.length} Ëâ≤)
                                <span onclick="copyMissingSummary()" style="cursor: pointer; color: #cf1322; font-size: 16px; display: flex; align-items: center; padding: 4px; margin-left: 8px;" title="Â§çÂà∂Áº∫Ë¥ßÊ∏ÖÂçï">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </span>
                            </div>
                             <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 6px;">
                                 ${missingItems}
                             </div>
                         </div>
                     `;
                 } else {
                     missingHtml = `
                         <div style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed #bae7ff; color: #52c41a; font-size: 13px; font-weight: bold;">
                             ‚úÖ Â∫ìÂ≠òÂÖÖË∂≥ÔºåÊó†Áº∫Ë¥ßËâ≤Âè∑
                         </div>
                     `;
                 }
                 
                 summaryCard.innerHTML = `
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                         <div style="font-weight: bold; font-size: 16px; color: #0050b3;">üìä ËÆ°ÂàíÊÄªËßà</div>
                         <div style="font-size: 12px; color: #69c0ff;">ÂÖ± ${summary.requirements.size} Ëâ≤ / ${totalQty} È¢ó</div>
                     </div>
                     ${missingHtml}
                 `;
                 container.appendChild(summaryCard);
             }
        }
        renderPlanList(filtered, container, isSearchMode);
    }

    function filterPlansByQuery(list, query) {
        let result = [];
        list.forEach(p => {
            const matchName = p.name && p.name.toLowerCase().includes(query);
            let matchChildren = false;
            let filteredSubPlans = [];
            
            if (p.subPlans && p.subPlans.length > 0) {
                filteredSubPlans = filterPlansByQuery(p.subPlans, query);
                if (filteredSubPlans.length > 0) {
                    matchChildren = true;
                }
            }
            
            if (matchChildren) {
                 const newPlan = {...p};
                 newPlan.subPlans = filteredSubPlans;
                 result.push(newPlan);
            } else if (matchName) {
                 const newPlan = {...p};
                 newPlan.subPlans = p.subPlans; // Keep original structure if parent matches
                 result.push(newPlan);
            }
        });
        return result;
    }

    function renderPlanList(list, container, forceExpand = false) {
        list.forEach(plan => {
            container.appendChild(createPlanCardElement(plan, false, forceExpand));
            
            // Render children if expanded
            if (plan.subPlans && plan.subPlans.length > 0 && (expandedPlanIds.has(plan.id) || forceExpand)) {
                const childContainer = document.createElement('div');
                childContainer.style.cssText = 'margin-left: 20px; padding-left: 10px; border-left: 2px solid #eee; margin-bottom: 15px;';
                
                renderPlanList(plan.subPlans, childContainer, forceExpand);
                container.appendChild(childContainer);
            }
        });
    }

    let currentSwipedPlanId = null;

    function createPlanCardElement(plan, isChild, forceExpand = false) {
        const items = plan.items || [];
        const date = new Date(plan.createdAt);
        const dateStr = `ÂàõÂª∫: ${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
        
        let completedDateStr = '';
        if (plan.status === 'completed' && plan.completedAt) {
            const cDate = new Date(plan.completedAt);
            completedDateStr = `ÂÆåÊàê: ${cDate.getFullYear()}/${cDate.getMonth()+1}/${cDate.getDate()}`;
        }
        
        const totalQty = items.reduce((sum, item) => sum + item.qty, 0);
        const totalCodes = items.length;
        const isFolder = plan.subPlans && plan.subPlans.length > 0;

        // Check parent for Move Out button
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const parent = findParent(plan.id, plans, null);
        const hasParent = !!parent;

        const card = document.createElement('div');
        card.className = 'plan-card';
        // Wrapper style: relative, overflow hidden for swipe
        card.style.cssText = 'background: transparent; margin-bottom: 12px; position: relative; overflow: hidden; height: auto; border-radius: 12px;';
        
        // --- Define Swipe Actions ---
        const actions = [];
        
        // 1. Withdraw (Only if completed)
        if (plan.status === 'completed') {
            actions.push({
                text: 'Êí§Âõû',
                bg: '#ff9800',
                click: (e) => { e.stopPropagation(); revertPlanToActive(plan.id); resetSwipe(); }
            });
        }
        
        // 2. Move Out (Only if has parent)
        if (hasParent) {
            actions.push({
                text: 'ÁßªÂá∫',
                bg: '#fa8c16',
                click: (e) => { e.stopPropagation(); movePlanOut(plan.id); resetSwipe(); }
            });
        }
        
        // 3. Copy (Only if NOT completed)
        if (plan.status !== 'completed') {
            actions.push({
                text: 'Â§çÂà∂',
                bg: '#1890ff',
                click: (e) => { e.stopPropagation(); duplicatePlan(plan.id); resetSwipe(); }
            });
        }
        
        // 4. Delete (Only if NOT completed)
        if (plan.status !== 'completed') {
            actions.push({
                text: 'Âà†Èô§',
                bg: '#ff4d4f',
                click: (e) => { e.stopPropagation(); deletePlan(plan.id); resetSwipe(); }
            });
        }

        const actionBtnWidth = 64;
        const totalActionWidth = actions.length * actionBtnWidth;

        // Actions HTML
        let actionsHtml = actions.map(action => `
            <div class="swipe-action-btn" style="
                width: ${actionBtnWidth}px; 
                height: 100%; 
                background: ${action.bg}; 
                color: white; 
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                font-size: 13px;
                font-weight: bold;
                cursor: pointer;
            ">
                ${action.text}
            </div>
        `).join('');
        
        // Add Actions Container
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'plan-card-actions';
        actionsContainer.style.cssText = 'position: absolute; top: 0; right: 0; bottom: 0; display: flex; z-index: 1; border-radius: 0 12px 12px 0; overflow: hidden;';
        actionsContainer.innerHTML = actionsHtml;
        
        // Bind Action Clicks
        const actionBtns = actionsContainer.querySelectorAll('.swipe-action-btn');
        actionBtns.forEach((btn, index) => {
            btn.onclick = actions[index].click;
        });
        card.appendChild(actionsContainer);

        // --- Card Inner Content (Visible Part) ---
        const innerEl = document.createElement('div');
        innerEl.className = 'plan-card-inner';
        innerEl.style.cssText = 'background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; z-index: 2; transition: transform 0.2s ease-out; border: 1px solid #f0f0f0; width: 100%; box-sizing: border-box; display: flex; align-items: stretch;';
        
        // --- Selection Mode Logic ---
        if (isPlanSelectionMode && selectedPlanIds.has(plan.id)) {
            innerEl.classList.add('selected');
            innerEl.style.background = '#f0f7ff';
            innerEl.style.borderColor = '#4a90e2';
            innerEl.style.boxShadow = '0 0 0 2px #4a90e2';
        }
        
        // Icon Logic
        let iconHtml = '';
        if (plan.thumbnail) {
             iconHtml = `<img src="${plan.thumbnail}" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else if (isFolder) {
             iconHtml = `<div style="font-size: 20px;">üìÇ</div>`;
        } else {
             iconHtml = `<div style="font-size: 20px;">üìÖ</div>`;
        }
        
        const iconContainerStyle = plan.thumbnail 
            ? "width: 40px; height: 40px; border-radius: 8px; overflow: hidden; border: 1px solid #eee; margin-right: 12px; flex-shrink: 0;"
            : "width: 40px; height: 40px; background: #f9f0ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;";

        const iconContainerHtml = `<div style="${iconContainerStyle}">${iconHtml}</div>`;

        // Color List Logic
        let itemsHtml = '';
        const sortedItems = [...items].sort((a, b) => b.qty - a.qty);
        const previewLimit = 7;
        const visibleItems = sortedItems.slice(0, previewLimit);
        const remainingCount = Math.max(0, sortedItems.length - previewLimit);

        visibleItems.forEach(item => {
            itemsHtml += `
                <div style="
                    background: #fff7e6; 
                    color: #d46b08;
                    border-radius: 4px; 
                    padding: 2px 6px;
                    font-size: 11px; 
                    font-weight: 500;
                    white-space: nowrap;
                ">
                    ${item.code}
                </div>
            `;
        });
        
        if (remainingCount > 0) {
            itemsHtml += `<div style="font-size: 11px; color: #999; padding: 2px 4px;">+${remainingCount}</div>`;
        }

        const checkboxHtml = ''; 

        // Action Button (Play/Complete)
        let actionBtnHtml = '';
        if (plan.status === 'active' && !isPlanSelectionMode) {
             actionBtnHtml = `
                <div class="action-play-btn" onclick="event.stopPropagation(); deductPlanInventory('${plan.id}')" style="
                    width: 28px; height: 28px; 
                    background: #52c41a; 
                    border-radius: 50%; 
                    display: flex; align-items: center; justify-content: center; 
                    color: white; 
                    cursor: pointer; 
                    box-shadow: 0 2px 6px rgba(82, 196, 26, 0.3);
                ">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </div>
             `;
        } else if (plan.status === 'completed' && !isPlanSelectionMode) {
             actionBtnHtml = `
                <div style="
                    width: 28px; height: 28px; 
                    background: #f6ffed; 
                    border-radius: 50%; 
                    display: flex; align-items: center; justify-content: center; 
                    color: #52c41a; 
                    border: 1px solid #b7eb8f;
                ">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </div>
             `;
        }

        // Folder Expand Logic
        let folderExpandHtml = '';
        if (isFolder) {
            const isExpanded = expandedPlanIds.has(plan.id) || forceExpand;
            folderExpandHtml = `
                <div class="expand-btn-wrapper" onclick="event.stopPropagation(); toggleFolder('${plan.id}')" style="
                    padding: 4px;
                    margin-right: 12px;
                    flex-shrink: 0;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 28px;
                    height: 28px;
                ">
                    <div style="
                        transform: rotate(${isExpanded ? '90deg' : '0deg'});
                        transition: transform 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 20px;
                        height: 20px;
                        color: #ccc;
                    ">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </div>
                </div>
            `;
        }
        
        let folderTagHtml = '';
        if (isFolder) {
            folderTagHtml = `
                <div style="
                    background: #e6f7ff; 
                    color: #1890ff; 
                    font-size: 11px; 
                    padding: 2px 6px; 
                    border-radius: 4px; 
                    margin-right: 10px;
                    display: inline-block;
                    font-weight: 500;
                ">
                    ${plan.subPlans.length}‰∏™
                </div>
            `;
        }

        const statsHtml = `
            <div style="display: flex; align-items: center; gap: 15px; font-size: 12px; color: #666;">
                ${folderTagHtml}
                <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="font-size: 14px; opacity: 0.7;">üé®</span> 
                    <span style="font-weight: 500;">${totalCodes} Ëâ≤</span>
                </div>
                ${!isFolder ? `
                <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="font-size: 14px; opacity: 0.7;">üî¢</span> 
                    <span style="font-weight: 500;">${totalQty.toLocaleString()} È¢ó</span>
                </div>` : ''}
            </div>
        `;

        const arrowHtml = `
            <div style="color: #ccc; margin-left: 4px;">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
        `;

        innerEl.innerHTML = `
            <div style="display: flex; align-items: stretch; width: 100%;">
                ${folderExpandHtml}
                ${checkboxHtml}
                
                <div style="flex: 1; overflow: hidden; padding-right: 8px;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        ${iconContainerHtml}
                        <div style="font-weight: bold; font-size: 16px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${plan.name}
                        </div>
                    </div>

                    <div style="margin-bottom: ${!isFolder && visibleItems.length > 0 ? '8px' : '0'};">
                        ${statsHtml}
                    </div>
                    
                    ${!isFolder && visibleItems.length > 0 ? `
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center; margin-top: 4px;">
                        ${itemsHtml}
                    </div>
                    ` : ''}
                </div>

                <div style="display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; padding-left: 10px;">
                    <div style="font-size: 11px; color: #999; white-space: nowrap; margin-bottom: 8px; text-align: right;">
                        <div>${dateStr}</div>
                        ${completedDateStr ? `<div style="margin-bottom: 2px;">${completedDateStr}</div>` : ''}
                        ${(plan.status === 'completed' && (plan.timeSpent || isFolder)) ? (() => {
                             // Correct logic for displaying time on CARD:
                             // If folder, calculate sum of subplans recursively
                             // If normal plan, use timeSpent directly
                             let displayTime = plan.timeSpent;
                             
                             if (isFolder && plan.subPlans && plan.subPlans.length > 0) {
                                let totalMin = 0;
                                const sumTime = (p) => {
                                    if (p.timeSpent) {
                                        let h = 0, m = 0;
                                        let hMatch = p.timeSpent.match(/(\d+)h/);
                                        let mMatch = p.timeSpent.match(/(\d+)m/);
                                        if (!hMatch) hMatch = p.timeSpent.match(/(\d+)Â∞èÊó∂/);
                                        if (!mMatch) mMatch = p.timeSpent.match(/(\d+)ÂàÜÈíü/);
                                        if (hMatch) h = parseInt(hMatch[1]);
                                        if (mMatch) m = parseInt(mMatch[1]);
                                        totalMin += h * 60 + m;
                                    }
                                    if (p.subPlans) p.subPlans.forEach(sumTime);
                                };
                                
                                // FIX: Don't sum the folder itself recursively if it's already included in the initial call
                                // sumTime(plan) calls p.subPlans.forEach(sumTime), which is correct.
                                // BUT, 'plan' itself might have 'timeSpent' (residue from before it was a folder, or set incorrectly).
                                // We should ignore the folder's OWN timeSpent if we are aggregating subplans, 
                                // OR we should treat the folder as just a container.
                                // The issue "8h vs 16h" suggests double counting or partial counting.
                                // If "ces" has timeSpent="8h" AND has subplans with 6h+2h=8h.
                                // sumTime(plan) -> adds plan.timeSpent(8h) -> recurses subplans(6h+2h) -> total 16h.
                                // FIX: Pass subPlans to sumTime, don't pass 'plan' itself to avoid counting the container's residue time.
                                
                                plan.subPlans.forEach(sumTime);
                                
                                if (totalMin > 0) {
                                    const h = Math.floor(totalMin / 60);
                                    const m = totalMin % 60;
                                    displayTime = '';
                                    if (h > 0) displayTime += `${h}h `;
                                    if (m > 0) displayTime += `${m}m`;
                                    displayTime = displayTime.trim();
                                } else {
                                    displayTime = null;
                                }
                             }
                             
                             return displayTime ? `<div style="margin-bottom: 2px; color: #8c8c8c;">‚åõ ${displayTime}</div>` : '';
                        })() : ''}
                    </div>

                    <div style="display: flex; align-items: center; gap: 8px;">
                         ${actionBtnHtml}
                         ${arrowHtml}
                    </div>
                </div>
            </div>
        `;
        
        card.appendChild(innerEl);

        // --- Swipe Logic ---
        let startX = 0;
        let startY = 0;
        let currentX = 0;
        let isSwiping = false;
        let isOpened = false;
        let isMouseDown = false; // Add mouse support
        
        const resetSwipe = () => {
             innerEl.style.transform = `translateX(0)`;
             isOpened = false;
             if (currentSwipedPlanId === plan.id) currentSwipedPlanId = null;
        };

        // Long Press Logic Helpers
        let longPressTimer;
        const startHandler = (e) => {
            if(isOpened) return;
            longPressTimer = setTimeout(() => {
                enterPlanSelectionMode(plan.id);
            }, 800);
        };
        const endHandler = (e) => {
            // For move events, only cancel if moved significantly
            if (e.type === 'touchmove' || e.type === 'mousemove') {
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                if (Math.abs(cx - startX) < 5 && Math.abs(cy - startY) < 5) {
                    return; // Ignore small jitter
                }
            }
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        };
        
        if (!isPlanSelectionMode) {
            // 1. Touch Events (Mobile)
            innerEl.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                currentX = startX;
                isSwiping = false;
                
                // Close other opened card
                if (currentSwipedPlanId && currentSwipedPlanId !== plan.id) {
                     // Global reset via ID check in other components if implemented, 
                     // or just rely on user tapping the other one to close.
                }
                
                startHandler(e); // Start Long Press
            }, {passive: true});

            innerEl.addEventListener('touchmove', (e) => {
                currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                let deltaX = currentX - startX;
                const deltaY = currentY - startY;

                // Lock horizontal scroll if vertical movement is dominant
                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    endHandler(e); // Cancel long press if scrolling vertically
                    return;
                }
                
                // If already opened, start from offset
                if (isOpened) {
                    deltaX -= totalActionWidth;
                }
                
                // Limit swipe range
                if (deltaX > 0) deltaX = 0; 
                if (deltaX < -totalActionWidth - 30) deltaX = -totalActionWidth - 30;
                
                if (Math.abs(deltaX) > 5) isSwiping = true;
                
                innerEl.style.transform = `translateX(${deltaX}px)`;
                
                endHandler(e); // Cancel long press if swiping
            }, {passive: true});

            innerEl.addEventListener('touchend', (e) => {
                const deltaX = currentX - startX;
                const threshold = totalActionWidth / 3;
                
                if (isOpened) {
                    if (deltaX > threshold) { // Swipe Right to close
                         resetSwipe();
                    } else {
                         innerEl.style.transform = `translateX(-${totalActionWidth}px)`;
                    }
                } else {
                    if (deltaX < -threshold) { // Swipe Left to open
                         innerEl.style.transform = `translateX(-${totalActionWidth}px)`;
                         isOpened = true;
                         currentSwipedPlanId = plan.id;
                    } else {
                         resetSwipe();
                    }
                }
                
                endHandler(e); // Clear long press
            });
            
            // 2. Mouse Events (Desktop)
            innerEl.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                startY = e.clientY;
                currentX = startX;
                isMouseDown = true;
                isSwiping = false;
                
                startHandler(e); // Start Long Press (Desktop support)
            });
            
            innerEl.addEventListener('mousemove', (e) => {
                if (!isMouseDown) return;
                
                currentX = e.clientX;
                const currentY = e.clientY;
                let deltaX = currentX - startX;
                const deltaY = currentY - startY;

                // Lock horizontal
                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    endHandler(e);
                    return;
                }
                
                e.preventDefault(); // Prevent text selection on drag
                
                if (isOpened) {
                    deltaX -= totalActionWidth;
                }
                
                if (deltaX > 0) deltaX = 0; 
                if (deltaX < -totalActionWidth - 30) deltaX = -totalActionWidth - 30;
                
                if (Math.abs(deltaX) > 5) isSwiping = true;
                
                innerEl.style.transform = `translateX(${deltaX}px)`;
                
                endHandler(e);
            });
            
            innerEl.addEventListener('mouseup', (e) => {
                if (!isMouseDown) return;
                isMouseDown = false;
                
                const deltaX = currentX - startX;
                const threshold = totalActionWidth / 3;
                
                if (isOpened) {
                    if (deltaX > threshold) { 
                         resetSwipe();
                    } else {
                         innerEl.style.transform = `translateX(-${totalActionWidth}px)`;
                    }
                } else {
                    if (deltaX < -threshold) { 
                         innerEl.style.transform = `translateX(-${totalActionWidth}px)`;
                         isOpened = true;
                         currentSwipedPlanId = plan.id;
                    } else {
                         resetSwipe();
                    }
                }
                
                endHandler(e);
            });
            
            innerEl.addEventListener('mouseleave', (e) => {
                if (isMouseDown) {
                    isMouseDown = false;
                    resetSwipe();
                    endHandler(e);
                }
            });

            // Click Logic
            innerEl.onclick = (e) => {
                if (isSwiping) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                if (isOpened) {
                    resetSwipe();
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                if (e.target.closest('.expand-btn')) return;
                if (e.target.closest('.action-play-btn')) return;
                
                viewPlanDetail(plan.id);
            };
        } else {
             innerEl.onclick = () => togglePlanSelection(plan.id);
        }

        return card;
    }

    function toggleFolder(id) {
        if (expandedPlanIds.has(id)) {
            expandedPlanIds.delete(id);
        } else {
            expandedPlanIds.add(id);
        }
        renderPlans();
    }

    function togglePlanColor(id) {
        if (expandedPlanColorIds.has(id)) {
            expandedPlanColorIds.delete(id);
        } else {
            expandedPlanColorIds.add(id);
        }
        renderPlans();
    }

    function findParent(id, list, parent) {
        if (!list) return null;
        for (let p of list) {
            if (p.id === id) return parent;
            if (p.subPlans && p.subPlans.length > 0) {
                const found = findParent(id, p.subPlans, p);
                if (found) return found;
            }
        }
        return null;
    }

    function movePlanOut(id) {
        if (!id) return;
        currentMoveOutPlanId = id;
        showModal('moveOutConfirmModal');
    }

    function confirmMoveOutPlan() {
        if (!currentMoveOutPlanId) return;
        const id = currentMoveOutPlanId;
        closeAllModals();

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const parent = findParent(id, plans, null);
        
        if (!parent) {
            alert('Êú™ÊâæÂà∞Áà∂Êñá‰ª∂Â§πÔºåÊó†Ê≥ïÁßªÂá∫„ÄÇ');
            return;
        }

        const idx = parent.subPlans.findIndex(p => p.id === id);
        if (idx === -1) return;
        
        const [planToMove] = parent.subPlans.splice(idx, 1);
        
        if (parent.subPlans.length === 0) {
            deletePlanRecursive(plans, parent.id);
        } else {
            recalculatePlanItems(parent);
        }
        
        plans.unshift(planToMove);
        localStorage.setItem('bead_plans', JSON.stringify(plans));
        
        showToast('ËÆ°ÂàíÂ∑≤ÁßªÂá∫Êñá‰ª∂Â§π');
        renderPlans();
        currentMoveOutPlanId = null;
    }

    let currentPlanDetailSort = 'qty';

    function togglePlanDetailSort() {
        currentPlanDetailSort = (currentPlanDetailSort === 'qty') ? 'code' : 'qty';
        renderPlanDetailList();
    }

    function renderPlanDetailList() {
        if (!currentPlanId) return;
        const plan = findPlanById(currentPlanId);
        if (!plan) return;

        // Update Sort Button Text
        const sortBtn = document.getElementById('planDetailSortBtn');
        if (sortBtn) {
            sortBtn.innerText = currentPlanDetailSort === 'qty' ? 'ÊåâÁî®Èáè ‚Üì' : 'ÊåâËâ≤Âè∑ ‚Üë';
        }

        const listContainer = document.getElementById('planDetailList');
        listContainer.innerHTML = '';

        let sortedItems = [...plan.items];
        if (currentPlanDetailSort === 'qty') {
            sortedItems.sort((a, b) => b.qty - a.qty);
        } else {
            // Natural sort for codes
            sortedItems.sort((a, b) => a.code.localeCompare(b.code, undefined, {numeric: true, sensitivity: 'base'}));
        }

        sortedItems.forEach(item => {
             const bead = data.find(d => d.id === item.code);
             const hex = bead ? bead.hex : '#eee';
             const isUnknown = !bead;
             
             const row = document.createElement('div');
             row.style.cssText = 'background: white; padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);';
             
             if (isUnknown) {
                 row.style.borderLeft = '4px solid #fa8c16';
                 row.style.background = '#fff7e6';
             }

             row.innerHTML = `
                <div onclick="editPlanItemColor('${item.code}')" style="width: 36px; height: 36px; background: ${hex}; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; position: relative;">
                     <div style="position:absolute; right:-2px; bottom:-2px; background:white; border-radius:50%; width:12px; height:12px; display:flex; align-items:center; justify-content:center; border:1px solid #ddd;">
                         <span style="font-size:8px; color:#666;">‚ñº</span>
                     </div>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; font-size: 16px; color: #333;">
                        ${item.code}
                        ${isUnknown ? '<span style="font-size:10px; background:#fa8c16; color:white; padding:2px 4px; border-radius:4px; margin-left:5px; vertical-align:middle;">Á≥ªÁªüÊó†Ê≠§Ëâ≤Âè∑</span>' : ''}
                    </div>
                    ${isUnknown ? '<div style="font-size: 12px; color: #fa8c16; margin-top: 4px;">ËØ∑Á°ÆËÆ§Ëâ≤Âè∑ÊòØÂê¶Ê≠£Á°Æ</div>' : ''}
                </div>
                <div style="text-align: right;" onclick="editPlanItemQty('${item.code}')">
                    <div style="font-weight: bold; font-size: 18px; color: #333; cursor: pointer; border-bottom: 1px dashed #ccc; display: inline-block;">${item.qty}</div>
                    <div style="font-size: 10px; color: #ccc;">Á≤í ‚úé</div>
                </div>
                <div onclick="deletePlanDetailItem('${item.code}')" style="margin-left: 10px; padding: 5px; color: #999; font-size: 20px; cursor: pointer;">√ó</div>
             `;
             listContainer.appendChild(row);
        });
    }

    function deletePlanDetailItem(code) {
        if (!currentPlanId) return;
        
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        // Use the global/helper findPlanById. 
        // Note: findPlanById definition must support (id, list). 
        // Based on existing code 'deletePlan(id)', it does.
        const plan = findPlanById(currentPlanId, plans);
        
        if (!plan) return;
        
        showConfirmModal(
            "Âà†Èô§Á°ÆËÆ§",
            `Á°ÆÂÆöË¶Å‰ªéËÆ°Âàí‰∏≠Âà†Èô§Ëâ≤Âè∑ ${code} ÂêóÔºü`,
            () => {
                const idx = plan.items.findIndex(i => i.code === code);
                if (idx !== -1) {
                    plan.items.splice(idx, 1);
                    
                    // If plan is part of a collection, we might need to update parent stats?
                    // The current implementation seems to calculate items on the fly for rendering,
                    // but for collections 'items' are usually aggregated?
                    // If this is a leaf plan, just saving is enough.
                    // If this is a collection, we shouldn't be editing items directly usually (items are computed).
                    // But if 'items' exists on it, we edit it.
                    
                    localStorage.setItem('bead_plans', JSON.stringify(plans));
                    
                    // Refresh View
                    renderPlanDetailList();
                    showToast('Â∑≤Âà†Èô§Ëâ≤Âè∑ ' + code);
                    
                    // Also update main list if visible
                    renderPlans();
                }
            }
        );
    }


    let currentPlanEditCode = null;

    // --- Plan Detail Edit Qty ---
    function editPlanItemQty(code) {
        if (!currentPlanId) return;
        const plan = findPlanById(currentPlanId);
        if (!plan) return;

        const item = plan.items.find(i => i.code === code);
        if (!item) return;

        currentPlanEditCode = code;
        document.getElementById('planDetailQtyCode').innerText = code;
        document.getElementById('planDetailQtyInput').value = item.qty;
        showModal('planDetailQtyModal');
    }

    function adjustPlanItemQty(delta) {
        const input = document.getElementById('planDetailQtyInput');
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 0) val = 0;
        input.value = val;
    }

    function submitPlanItemQty() {
        if (!currentPlanId || !currentPlanEditCode) return;
        
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(currentPlanId, plans);
        if (!plan) return;

        const item = plan.items.find(i => i.code === currentPlanEditCode);
        if (item) {
            const input = document.getElementById('planDetailQtyInput');
            const val = parseInt(input.value);
            if (!isNaN(val) && val >= 0) {
                item.qty = val;
                localStorage.setItem('bead_plans', JSON.stringify(plans));
                renderPlanDetailList();
                closeAllModals();
                showToast(`Â∑≤Êõ¥Êñ∞Ëâ≤Âè∑ ${currentPlanEditCode} Áî®Èáè`);
                
                // Update stats
                const totalQty = plan.items.reduce((sum, item) => sum + item.qty, 0);
                document.getElementById('planDetailBeadCount').innerText = totalQty.toLocaleString();
            } else {
                showToast("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Èáè");
            }
        }
    }

    // --- Plan Detail Edit Color ---
    function editPlanItemColor(code) {
        currentPlanEditCode = code;
        document.getElementById('planDetailColorSearch').value = '';
        renderPlanDetailColorList('');
        showModal('planDetailColorModal');
        setTimeout(() => document.getElementById('planDetailColorSearch').focus(), 100);
    }

    function filterPlanDetailColorList() {
        const filter = document.getElementById('planDetailColorSearch').value;
        renderPlanDetailColorList(filter);
    }

    function renderPlanDetailColorList(filter) {
        const container = document.getElementById('planDetailColorList');
        container.innerHTML = '';
        
        const filterText = filter.toUpperCase();
        const filtered = data.filter(d => d.id.toUpperCase().includes(filterText));
        const displayList = (filterText === '' ? filtered.slice(0, 50) : filtered);
        
        if (displayList.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Êó†ÂåπÈÖçËâ≤Âè∑</div>';
            return;
        }

        displayList.forEach(item => {
            const isCurrent = item.id === currentPlanEditCode;
            const div = document.createElement('div');
            div.style.cssText = `display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; background:${isCurrent ? '#e6f7ff' : 'white'}; cursor:pointer; border-radius:8px; margin-bottom:5px;`;
            div.onclick = () => selectPlanDetailColor(item.id);
            
            div.innerHTML = `
                <div style="width:30px; height:30px; background:${item.hex}; border-radius:50%; border:1px solid #ddd; margin-right:15px;"></div>
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#333;">${item.id}</div>
                    <div style="font-size:12px; color:#999;">Â∫ìÂ≠ò: ${item.w || 0}g</div>
                </div>
                ${isCurrent ? '<span style="color:#1890ff; font-weight:bold;">ÂΩìÂâç</span>' : ''}
            `;
            container.appendChild(div);
        });
        
        if (filterText === '' && data.length > 50) {
            const more = document.createElement('div');
            more.style.cssText = 'text-align:center; padding:10px; color:#999; font-size:12px;';
            more.innerText = `ÊòæÁ§∫Ââç 50 ‰∏™ÁªìÊûú (ÂÖ± ${data.length} ‰∏™)ÔºåËØ∑ËæìÂÖ•ÊêúÁ¥¢ËØçÊü•Êâæ`;
            container.appendChild(more);
        }
    }

    function selectPlanDetailColor(newCode) {
        if (!currentPlanId || !currentPlanEditCode) return;
        if (currentPlanEditCode === newCode) {
            closeAllModals();
            return;
        }

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(currentPlanId, plans);
        if (!plan) return;

        // Check if new code exists in plan
        const existingItem = plan.items.find(i => i.code === newCode);
        const currentItem = plan.items.find(i => i.code === currentPlanEditCode);
        
        if (!currentItem) return;

        if (existingItem) {
            // Merge
            if(confirm(`Ëâ≤Âè∑ ${newCode} Â∑≤Âú®ËÆ°Âàí‰∏≠ (Êï∞Èáè: ${existingItem.qty})„ÄÇÊòØÂê¶ÂêàÂπ∂Êï∞ÈáèÔºü`)) {
                existingItem.qty += currentItem.qty;
                // Remove old item
                const idx = plan.items.indexOf(currentItem);
                plan.items.splice(idx, 1);
            } else {
                return;
            }
        } else {
            // Update code
            currentItem.code = newCode;
        }

        localStorage.setItem('bead_plans', JSON.stringify(plans));
        renderPlanDetailList();
        closeAllModals();
        showToast(`Â∑≤‰øÆÊîπËâ≤Âè∑‰∏∫ ${newCode}`);
        
        // Update stats
        document.getElementById('planDetailColorCount').innerText = plan.items.length;
    }



    function viewPlanDetail(id) {
        const plan = findPlanById(id);
        if(!plan) return;

        currentPlanId = id;

        const titleEl = document.getElementById('planDetailTitle');
        titleEl.innerText = plan.name;
        
        // Setup Image Preview
        const imgContainer = document.getElementById('planDetailImageContainer');
        const imgEl = document.getElementById('planDetailImage');
        if (plan.thumbnail) {
            imgEl.src = plan.thumbnail;
            imgContainer.style.display = 'block';
        } else {
            imgContainer.style.display = 'none';
        }
        
        // Check for parent and show Move Out button
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const parentPlan = findParent(id, plans, null);
        
        // Update Status Banner
        const statusBanner = document.getElementById('planDetailStatus');
        const actionButtons = document.getElementById('planDetailActions');
        
        // Clear previous buttons
        const revertBtnId = 'btn-revert-active';
        const existingRevertBtn = document.getElementById(revertBtnId);
        if(existingRevertBtn) existingRevertBtn.remove();
        
        const duplicateBtnId = 'btn-duplicate-plan';
        const existingDupBtn = document.getElementById(duplicateBtnId);
        if(existingDupBtn) existingDupBtn.remove();

        if (plan.status === 'completed') {
            // Clear status banner first
            statusBanner.innerHTML = '';
            statusBanner.style.background = '#f6ffed';
            statusBanner.style.color = '#52c41a';

            // 1. Status Text
            const statusText = document.createElement('div');
            statusText.style.fontWeight = 'bold';
            statusText.style.fontSize = '16px';
            statusText.innerText = '‚úÖ Â∑≤ÂÆåÊàê - Â∫ìÂ≠òÂ∑≤Êâ£Âáè';
            statusBanner.appendChild(statusText);

            // 2. Completed Time
            if (plan.completedAt) {
                const timeDiv = document.createElement('div');
                timeDiv.style.fontSize = '13px';
                timeDiv.style.marginTop = '6px';
                timeDiv.style.opacity = '0.8';
                timeDiv.innerText = 'ÂÆåÊàê‰∫é: ' + formatTime(new Date(plan.completedAt));
                statusBanner.appendChild(timeDiv);
            }
            
            // 3. Edit Time Button (Created via DOM to ensure events work)
            const editBtn = document.createElement('button');
            // High z-index to ensure it's on top
            editBtn.style.cssText = "display:flex; align-items:center; gap:5px; margin-top:8px; padding:6px 10px; border:none; border-radius:6px; width:fit-content; cursor:pointer; user-select:none; position: relative; z-index: 2000; pointer-events: auto; font-family: inherit;";
            
            // Calculate aggregated time spent for display if not set directly
            // If plan has no timeSpent but has subPlans, sum them up
            let displayTime = plan.timeSpent;
            let isAggregated = false;
            
            // Determine if it is an aggregated plan (Collection)
            // It is aggregated if it has subPlans AND (it has no direct timeSpent OR we want to force aggregation for collections)
            // Requirement: "Completed collection plan time is sum of subplans, cannot be modified."
            // So if subPlans exist, we treat it as aggregated for time calculation purposes, ignoring any potential direct timeSpent residue.
            if (plan.subPlans && plan.subPlans.length > 0) {
                let totalMin = 0;
                const sumTime = (p) => {
                    if (p.timeSpent) {
                        let h = 0, m = 0;
                        let hMatch = p.timeSpent.match(/(\d+)h/);
                        let mMatch = p.timeSpent.match(/(\d+)m/);
                        if (!hMatch) hMatch = p.timeSpent.match(/(\d+)Â∞èÊó∂/);
                        if (!mMatch) mMatch = p.timeSpent.match(/(\d+)ÂàÜÈíü/);
                        if (hMatch) h = parseInt(hMatch[1]);
                        if (mMatch) m = parseInt(mMatch[1]);
                        totalMin += h * 60 + m;
                    }
                    if (p.subPlans) p.subPlans.forEach(sumTime);
                };
                sumTime(plan); // Keep original logic but modify sumTime internal if needed OR fix recursion
                // Current logic: sumTime(plan) adds plan.timeSpent THEN recurses subPlans.
                // For a collection, we ONLY want subPlans.
                // FIX:
                totalMin = 0; // Reset
                if (plan.subPlans) plan.subPlans.forEach(sumTime); // Only recurse children, ignore parent's own timeSpent field which might be stale or duplicate
                
                if (totalMin > 0) {
                    const h = Math.floor(totalMin / 60);
                    const m = totalMin % 60;
                    displayTime = '';
                    if (h > 0) displayTime += `${h}h `;
                    if (m > 0) displayTime += `${m}m`;
                    displayTime = displayTime.trim();
                } else {
                    displayTime = '0m'; // Aggregated but 0
                }
                isAggregated = true;
            }

            if (displayTime) {
                 editBtn.style.background = "rgba(82, 196, 26, 0.1)";
                 // If aggregated, show lock icon instead of pencil
                 const icon = isAggregated ? 'üîí' : '‚úèÔ∏è';
                 editBtn.innerHTML = `
                    <span style="font-size:14px;">‚åõ</span>
                    <span style="font-weight:500; color: #000;">${displayTime}</span>
                    <span style="font-size:12px; color:#52c41a; margin-left:4px; opacity: 0.8;">${icon}</span>`;
            } else {
                 if (isAggregated) {
                     // Aggregated but no time (0m)
                     editBtn.style.background = "rgba(82, 196, 26, 0.1)";
                     editBtn.innerHTML = `
                        <span style="font-size:14px;">‚åõ</span>
                        <span style="font-weight:500; color: #000;">0m</span>
                        <span style="font-size:12px; color:#52c41a; margin-left:4px; opacity: 0.8;">üîí</span>`;
                 } else {
                     editBtn.style.background = "rgba(24, 144, 255, 0.1)";
                     editBtn.innerHTML = `
                        <span style="font-size:14px;">‚åõ</span>
                        <span style="color:#1890ff; font-weight:500; font-size:13px;">Ê∑ªÂä†ËÄóÊó∂</span>
                        <span style="font-size:12px; color:#1890ff; margin-left:4px; opacity: 0.8;">‚úèÔ∏è</span>`;
                 }
            }

            // Robust Event Binding
            if (isAggregated) {
                // If aggregated, click shows explanation toast instead of edit modal
                editBtn.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    showToast('ËøôÊòØÂêàÈõÜËÆ°ÂàíÔºåËÄóÊó∂Áî±Â≠êËÆ°ÂàíËá™Âä®Á¥ØÂä†');
                };
                editBtn.ontouchstart = function(e) { e.stopPropagation(); }; // Prevent ghost clicks
            } else {
                // Normal editable plan
                editBtn.setAttribute('onclick', `event.stopPropagation(); console.log('Edit clicked for ${plan.id}'); if(window.showEditTimeModal) { window.showEditTimeModal('${plan.id}'); } else { alert('Function not found'); }`);
                
                // Add touchend for better mobile response (fast tap)
                editBtn.addEventListener('touchend', function(e) {
                    e.preventDefault(); 
                    e.stopPropagation();
                    if(window.showEditTimeModal) window.showEditTimeModal(plan.id);
                }, { passive: false });
            }

            statusBanner.appendChild(editBtn);

            if(actionButtons) actionButtons.style.display = 'none';
            

            
        } else {
            statusBanner.innerHTML = `<div style="font-weight:bold; font-size:16px;">ËÆ°Âàí‰∏≠ - Â∞öÊú™Êâ£ÂáèÂ∫ìÂ≠ò</div>`;
            statusBanner.style.background = '#fffbe6';
            statusBanner.style.color = '#fa8c16';
            if(actionButtons) actionButtons.style.display = 'flex';
        }
        
        const totalQty = plan.items.reduce((sum, item) => sum + item.qty, 0);
        document.getElementById('planDetailColorCount').innerText = plan.items.length;
        document.getElementById('planDetailBeadCount').innerText = totalQty.toLocaleString();
        
        // Calculate and display cost
        const storedCost = localStorage.getItem('bead_unit_cost');
        const unitCost = storedCost ? parseFloat(storedCost) : 0.1;
        const totalWeight = totalQty / 100; // 100 beads approx 1g (based on BEAD_WEIGHT_PER_100 logic usually 1g=100)
        // Actually code uses BEAD_WEIGHT_PER_100 = 1 (1g per 100 beads).
        // So total weight is totalQty / 100.
        const totalCost = totalWeight * unitCost;
        
        // Create or update cost element
        // FIX: Remove duplicates first to prevent multiple cost cards stacking up
        const existingCostContainers = document.querySelectorAll('[id^="planDetailCostContainer"]');
        existingCostContainers.forEach(el => el.remove());
        
        let costEl = document.getElementById('planDetailCost');
        // Always recreate or re-find after cleanup
        if (true) { // Logic simplified: cleanup and recreate is safer than "if (!costEl)" which failed
            // Insert after the counts row
            const countsRow = document.querySelector('.detail-stats'); 
            
            const statsContainer = document.getElementById('planDetailBeadCount').parentNode.parentNode;
            
            const costContainer = document.createElement('div');
            costContainer.id = 'planDetailCostContainer';
            costContainer.style.cssText = "background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between;";
            
            costContainer.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #fff7e6; color: #fa8c16; display: flex; align-items: center; justify-content: center; font-size: 16px;">üí∞</div>
                    <div>
                        <div style="font-size: 11px; color: #999;">È¢ÑËÆ°ÊàêÊú¨</div>
                        <div style="font-size: 15px; font-weight: bold; color: #333;">¬• <span id="planDetailCostValue">0.00</span></div>
                    </div>
                </div>
                <div style="font-size: 11px; color: #ccc;">(Âü∫‰∫é ${unitCost}ÂÖÉ/g)</div>
            `;
            
            statsContainer.parentNode.insertBefore(costContainer, statsContainer.nextSibling);
            costEl = document.getElementById('planDetailCostValue');
        }
        
        // Update value
        if(costEl) {
             costEl.innerText = totalCost.toFixed(2);
        }


        // Render List using the current sort mode (reset to default or keep?)
        // Let's reset to default 'qty' when opening a plan, or keep previous if we want.
        // User didn't specify, but resetting is safer for "default is by usage".
        currentPlanDetailSort = 'qty'; 
        renderPlanDetailList();

        document.getElementById('page-plan').style.display = 'none';
        document.getElementById('page-plan-detail').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function closePlanDetail() {
        document.getElementById('page-plan-detail').style.display = 'none';
        document.getElementById('page-plan').style.display = 'block';
        currentPlanId = null;
    }

    let stockCheckSortType = 'code';
    let stockCheckPrioritizeMissing = false;

    function toggleStockCheckSort(type) {
        if (stockCheckSortType === type) return;
        stockCheckSortType = type;
        renderStockCheckList();
    }

    function toggleStockCheckMissingPriority() {
        stockCheckPrioritizeMissing = !stockCheckPrioritizeMissing;
        renderStockCheckList();
    }

    function checkPlanStock() {
        if (!currentPlanId) return;
        const plan = findPlanById(currentPlanId);
        if(!plan) return;

        const sheet = document.getElementById('stockCheckSheet');
        const summary = document.getElementById('stockCheckSummary');
        
        // Calculate Summary First
        // Calculate Summary
        let missingCount = 0;
        let totalMissingWeight = 0;
        let totalMissingBeads = 0;
        const BEAD_WEIGHT_PER_100 = 1;

        plan.items.forEach(item => {
             const bead = data.find(d => d.id === item.code);
             const currentStock = bead ? (bead.w || 0) : 0;
             const neededWeight = parseFloat((item.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
             if (currentStock < neededWeight) {
                 missingCount++;
                 totalMissingWeight += (neededWeight - currentStock);
                 
                 // Estimate missing beads based on weight diff
                 // (needed - stock) * 100 / BEAD_WEIGHT_PER_100
                 const missingW = neededWeight - currentStock;
                 totalMissingBeads += Math.ceil(missingW * 100 / BEAD_WEIGHT_PER_100);
             }
        });

        // Updated Summary Style to match Reference Image
        if (missingCount > 0) {
            summary.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <div style="font-size: 16px; font-weight: bold; color: #333;">${plan.name || 'Â∫ìÂ≠òÁ°ÆËÆ§'}</div>
                    <div style="color: #ff4d4f; font-weight: bold; font-size: 14px;">‚ö†Ô∏è Áº∫Â∞ë ${missingCount} Ëâ≤</div>
                </div>
                <div style="color: #fa8c16; font-size: 13px;">‚äñ ÂÖ±Áº∫Â∞ë ${totalMissingBeads.toLocaleString()} È¢ó</div>
            `;
            summary.style.cssText = 'background: #fff; padding: 15px 5px 5px 5px; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px;';
        } else {
            summary.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 16px; font-weight: bold; color: #333;">${plan.name || 'Â∫ìÂ≠òÁ°ÆËÆ§'}</div>
                    <div style="color: #52c41a; font-weight: bold; font-size: 14px;">‚úî Â∫ìÂ≠òÂÖÖË∂≥</div>
                </div>
                <div style="color: #999; font-size: 13px; margin-top: 5px;">ÂèØ‰ª•ÂºÄÂßãÂà∂‰ΩúÂï¶ÔºÅ</div>
            `;
            summary.style.cssText = 'background: #fff; padding: 15px 5px 5px 5px; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px;';
        }

        renderStockCheckList();

        sheet.style.display = 'flex';
        document.getElementById('mask').style.display = 'block';
    }

    function renderStockCheckList() {
        if (!currentPlanId) return;
        const plan = findPlanById(currentPlanId);
        if(!plan) return;

        const list = document.getElementById('stockCheckList');
        list.innerHTML = '';
        const BEAD_WEIGHT_PER_100 = 1;

        // Update Button Styles
        const btnCode = document.getElementById('btn-check-code');
        const btnQty = document.getElementById('btn-check-qty');
        const btnMissing = document.getElementById('btn-check-missing');
        
        if(btnCode && btnQty && btnMissing) {
            const activeStyle = "font-size: 12px; padding: 2px 8px; border: 1px solid #1890ff; background: #e6f7ff; color: #1890ff; border-radius: 4px; font-weight: bold;";
            const inactiveStyle = "font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; color: #666; border-radius: 4px;";
            
            btnCode.style.cssText = stockCheckSortType === 'code' ? activeStyle : inactiveStyle;
            btnQty.style.cssText = stockCheckSortType === 'qty' ? activeStyle : inactiveStyle;
            btnMissing.style.cssText = stockCheckPrioritizeMissing ? activeStyle : inactiveStyle;
        }

        // Sorting
        let sortedItems = [...plan.items];
        
        // 1. Primary Sort
        if (stockCheckSortType === 'qty') {
            sortedItems.sort((a, b) => b.qty - a.qty);
        } else {
            sortedItems.sort((a, b) => a.code.localeCompare(b.code, undefined, {numeric: true}));
        }

        // 2. Priority Sort
        if (stockCheckPrioritizeMissing) {
            sortedItems.sort((a, b) => {
                 const getShortage = (item) => {
                     const bead = data.find(d => d.id === item.code);
                     const currentStock = bead ? (bead.w || 0) : 0;
                     const neededWeight = parseFloat((item.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
                     return currentStock < neededWeight ? 1 : 0;
                 };
                 return getShortage(b) - getShortage(a); // Missing first
            });
        }

        sortedItems.forEach(item => {
             const bead = data.find(d => d.id === item.code);
             const currentStock = bead ? (bead.w || 0) : 0;
             const neededWeight = parseFloat((item.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
             const isMissing = currentStock < neededWeight;
             
             const hex = bead ? bead.hex : '#eee';
             const row = document.createElement('div');
             row.style.cssText = 'display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 8px; border-radius: 8px;';
             
             // Calculate Bead Counts for Display
             // currentStock (g) -> beads?  (currentStock / BEAD_WEIGHT_PER_100 * 100)
             const currentBeads = Math.floor(currentStock / BEAD_WEIGHT_PER_100 * 100);
             const missingBeads = Math.ceil((neededWeight - currentStock) * 100 / BEAD_WEIGHT_PER_100);

             let rightContent = '';
             if (isMissing) {
                 rightContent = `
                    <div style="text-align: right;">
                        <div style="color: #ff4d4f; font-weight: bold; font-size: 16px;">-${missingBeads.toLocaleString()}</div>
                        <button onclick="showSubstituteModal('${item.code}', ${neededWeight}, ${missingBeads})" style="margin-top:4px; font-size:10px; padding:2px 6px; background:#fff1f0; border:1px solid #ffa39e; color:#cf1322; border-radius:4px; cursor:pointer;">üîçÊâæÊõøË°•</button>
                    </div>
                 `;
             } else {
                 // Optionally show remaining surplus or just a check? Reference image doesn't show "sufficient" rows clearly but implies checks.
                 // Let's show "Sufficient" or surplus count if we want, but image implies only negatives are highlighted.
                 // Let's show remaining count in green if positive? Or just nothing special.
                 // Reference image seems to list all, but highlights missing.
                 const surplusBeads = Math.floor((currentStock - neededWeight) * 100 / BEAD_WEIGHT_PER_100);
                 rightContent = `
                    <div style="text-align: right;">
                        <div style="color: #52c41a; font-weight: bold; font-size: 16px;">${surplusBeads > 0 ? surplusBeads : '‚úî'}</div>
                    </div>
                 `;
             }

             row.innerHTML = `
                 <!-- Left: Color Block & Code -->
                 <div style="display: flex; align-items: center; width: 35%;">
                     <div style="width: 36px; height: 36px; background: ${hex}; border-radius: 6px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.1);"></div>
                     <div style="font-weight: bold; color: #333; font-size: 15px;">${item.code}</div>
                 </div>
                 
                 <!-- Middle: Need / Have -->
                 <div style="flex: 1; text-align: right; padding-right: 20px;">
                     <div style="font-size: 12px; color: #666;">ÈúÄË¶Å <b>${item.qty.toLocaleString()}</b></div>
                     <div style="font-size: 11px; color: #999; margin-top: 2px;">Áé∞Êúâ ${currentBeads.toLocaleString()}</div>
                 </div>
                 
                 <!-- Right: Missing Qty -->
                 <div style="width: 80px; text-align: right;">
                     ${rightContent}
                 </div>
             `;
             list.appendChild(row);
        });
    }

    function executePlanDeduction() {
        if (!currentPlanId) return;
        deductPlanInventory(currentPlanId);
    }

    function rollbackPlanInventory(plan) {
        if (!plan) return;
        
        if (plan.status === 'completed') {
            let restoredCount = 0;
            
            // Find logs associated with this plan
            data.forEach(item => {
                if (item.logs) {
                    // Find logs with matching planId OR matching description (backward compatibility)
                    const logsToRemove = [];
                    item.logs.forEach((log, idx) => {
                        let isMatch = false;
                        if (log.planId && log.planId === plan.id) {
                            isMatch = true;
                        } else if (!log.planId && log.desc && log.desc === `ËÆ°ÂàíÊâ£Âáè: ${plan.name}`) {
                            isMatch = true;
                        }
                        
                        if (isMatch) {
                             logsToRemove.push({ log, idx });
                        }
                    });
                    
                    // Process rollback (reverse order of indices to avoid shifting issues)
                    logsToRemove.sort((a, b) => b.idx - a.idx).forEach(({log, idx}) => {
                        // Restore Stock
                        // "use" log means we subtracted weight, so add it back
                        const val = log.val || 0;
                        item.w = parseFloat((item.w + val).toFixed(2));
                        item.totalUsed = Math.max(0, parseFloat((item.totalUsed - val).toFixed(2)));
                        
                        // Remove log
                        item.logs.splice(idx, 1);
                        restoredCount++;
                    });
                }
            });
            
            if (restoredCount > 0) {
                save();
                render();
            }
        }

        // Recursively rollback sub-plans (for collections)
        if (plan.subPlans && plan.subPlans.length > 0) {
            plan.subPlans.forEach(sub => rollbackPlanInventory(sub));
        }
    }

    // --- Cost Settings Logic ---
    function openCostModal() {
        const storedCost = localStorage.getItem('bead_unit_cost');
        const cost = storedCost ? parseFloat(storedCost) : 0.1; // Default 0.1 per gram
        
        // We reuse the batchInputModal style or create a new small modal for settings
        // Since we want to keep it simple, let's create a specific modal for this
        const modalId = 'costSettingModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            modal.style.width = '85%';
            modal.style.maxWidth = '300px';
            modal.innerHTML = `
                <h3 style="font-size:18px; font-weight:bold; margin-bottom:15px; text-align:center;">ÊàêÊú¨ËÆæÁΩÆ</h3>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-size:14px; color:#666;">ÂçïÂÖãÊàêÊú¨ (ÂÖÉ/g)</label>
                    <input type="number" id="costInput" step="0.01" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
                    <p style="margin-top:5px; font-size:12px; color:#999;">‰æãÂ¶ÇÔºö‰∏ÄÂåÖ50gÂçñ5ÂÖÉÔºåÂàôÂçïÂÖãÊàêÊú¨‰∏∫0.1</p>
                </div>
                <div class="modal-btn-group">
                    <button class="m-btn m-btn-primary" onclick="saveCostSettings()">‰øùÂ≠ò</button>
                    <button class="m-btn m-btn-ghost" onclick="closeAllModals()">ÂèñÊ∂à</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        document.getElementById('costInput').value = cost;
        showModal(modalId);
    }

    function saveCostSettings() {
        const val = parseFloat(document.getElementById('costInput').value);
        if (isNaN(val) || val < 0) {
            alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù');
            return;
        }
        localStorage.setItem('bead_unit_cost', val);
        showToast('ÊàêÊú¨ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        closeAllModals();
        
        // Refresh detail page if open
        if (currentPlanId && document.getElementById('page-plan-detail').style.display === 'block') {
            viewPlanDetail(currentPlanId);
        }
    }

    // --- Color Substitution Logic ---
    function hexToRgb(hex) {
        // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
        var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(shorthandRegex, function(m, r, g, b) {
            return r + r + g + g + b + b;
        });
      
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    function getColorDistance(color1, color2) {
        // Euclidean distance in RGB space
        // Could be improved with Lab or weighted RGB, but this is sufficient for basic finding
        return Math.sqrt(
            Math.pow(color1.r - color2.r, 2) +
            Math.pow(color1.g - color2.g, 2) +
            Math.pow(color1.b - color2.b, 2)
        );
    }

    function findSubstituteBead(targetBeadId, requiredWeight) {
        const targetBead = data.find(d => d.id === targetBeadId);
        if (!targetBead || !targetBead.hex) return [];

        const targetRgb = hexToRgb(targetBead.hex);
        if (!targetRgb) return [];

        // Candidates: 
        // 1. Have hex
        // 2. Have enough stock (w >= requiredWeight)
        // 3. Not the target itself
        const candidates = data.filter(d => 
            d.id !== targetBeadId && 
            d.hex && 
            (d.w || 0) >= requiredWeight
        );

        const results = candidates.map(d => {
            const rgb = hexToRgb(d.hex);
            if (!rgb) return null;
            return {
                bead: d,
                dist: getColorDistance(targetRgb, rgb)
            };
        }).filter(r => r !== null);

        // Sort by distance (smaller is better)
        results.sort((a, b) => a.dist - b.dist);

        // Return top 3
        return results.slice(0, 3);
    }

    function showSubstituteModal(targetBeadId, requiredWeight, missingBeadsCount) {
        const substitutes = findSubstituteBead(targetBeadId, requiredWeight);
        
        const modalId = 'substituteModal';
        let modal = document.getElementById(modalId);
        
        // Always recreate content to ensure freshness
        if (modal) modal.remove();
        
        modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal';
        modal.style.width = '85%';
        modal.style.maxWidth = '320px';
        modal.style.zIndex = '100000'; // Higher than stock check
        
        const targetBead = data.find(d => d.id === targetBeadId);
        
        let html = `
            <h3 style="font-size:18px; font-weight:bold; margin-bottom:15px; text-align:center;">ÂØªÊâæÊõøË°•Ëâ≤</h3>
            <div style="text-align:center; margin-bottom:20px;">
                <div style="display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#fff1f0; border-radius:8px; border:1px solid #ffa39e;">
                    <div style="width:24px; height:24px; background:${targetBead.hex}; border-radius:4px; border:1px solid rgba(0,0,0,0.1);"></div>
                    <span style="font-weight:bold; color:#cf1322;">${targetBeadId}</span>
                    <span style="color:#666; font-size:12px;">Áº∫ ${missingBeadsCount} Á≤í</span>
                </div>
            </div>
        `;
        
        if (substitutes.length === 0) {
            html += `<div style="text-align:center; color:#999; padding:20px;">Ê≤°ÊúâÊâæÂà∞Â∫ìÂ≠òÂÖÖË∂≥ÁöÑËøë‰ººËâ≤</div>`;
        } else {
            html += `<div style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto;">`;
            substitutes.forEach(sub => {
                const d = sub.bead;
                // Calculate match percentage roughly: max dist is sqrt(255^2*3) ‚âà 441. 
                // 100 - (dist / 441 * 100)
                const match = Math.max(0, Math.round(100 - (sub.dist / 4.41)));
                
                html += `
                    <div style="display:flex; align-items:center; padding:10px; border:1px solid #eee; border-radius:8px;">
                        <div style="width:30px; height:30px; background:${d.hex}; border-radius:6px; border:1px solid rgba(0,0,0,0.1); margin-right:10px;"></div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:#333;">${d.id}</div>
                            <div style="font-size:12px; color:#666;">Â∫ìÂ≠ò: ${Math.floor(d.w * 100)} Á≤í</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:12px; color:#52c41a; font-weight:bold;">Áõ∏‰ººÂ∫¶ ${match}%</div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        }
        
        html += `
            <div class="modal-btn-group" style="margin-top:20px;">
                <button class="m-btn m-btn-primary" onclick="document.getElementById('${modalId}').style.display='none';">ÂÖ≥Èó≠</button>
            </div>
        `;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        // Show logic (manual because we need high z-index and it's a second modal)
        modal.style.display = 'block';
        // Ensure backdrop is handled if needed, but since we are over another modal, we might just overlay.
        // Or we can use showModal if we manage z-index carefully.
        // Let's manually set it to be safe on top of 99999
        modal.style.position = 'fixed';
        modal.style.top = '50%';
        modal.style.left = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
    }

    function revertPlanToActive(id) {
        currentRevertPlanId = id;
        showModal('revertConfirmModal');
    }

    function confirmRevertPlan() {
        if (!currentRevertPlanId) return;
        const id = currentRevertPlanId;
        closeAllModals();

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(id, plans);
        if (!plan) return;
        
        rollbackPlanInventory(plan);
        
        plan.status = 'active';
        delete plan.completedAt;
        
        // Check parent status (revert if needed)
        updateParentCollectionStatus(plans, plan.id);

        localStorage.setItem('bead_plans', JSON.stringify(plans));
        renderPlans();
        showToast('ËÆ°ÂàíÂ∑≤Êí§ÈîÄ‰∏∫‚ÄúËÆ°Âàí‰∏≠‚ÄùÔºåÂ∫ìÂ≠òÂ∑≤ÂõûÊªö„ÄÇ');
        currentRevertPlanId = null;
    }

    function duplicatePlan(id) {
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const original = findPlanById(id, plans);
        if (!original) return;
        
        // Find parent folder if exists
        const parent = findParent(id, plans, null);
        
        const newPlan = JSON.parse(JSON.stringify(original));
        newPlan.id = 'plan_' + Date.now();
        newPlan.name = original.name + ' (ÂâØÊú¨)';
        newPlan.createdAt = Date.now();
        newPlan.status = 'active';
        delete newPlan.completedAt;
        delete newPlan.timeSpent;
        // delete newPlan.subPlans; // Keep subPlans structure if it's a folder
        
        // If it's a folder (has subPlans), we need to update IDs of subPlans too
        if (newPlan.subPlans) {
             const updateIds = (list) => {
                 list.forEach(p => {
                     p.id = 'plan_' + Math.random().toString(36).substr(2, 9);
                     p.createdAt = Date.now();
                     p.status = 'active';
                     delete p.completedAt;
                     delete p.timeSpent;
                     if(p.subPlans) updateIds(p.subPlans);
                 });
             };
             updateIds(newPlan.subPlans);
        }

        if (parent) {
            // Insert into parent folder
            if (!parent.subPlans) parent.subPlans = [];
            parent.subPlans.unshift(newPlan);
            recalculatePlanItems(parent);
        } else {
            // Insert into root
            plans.unshift(newPlan);
        }
        
        localStorage.setItem('bead_plans', JSON.stringify(plans));
        
        showToast('ËÆ°ÂàíÂ∑≤Â§çÂà∂');
        renderPlans();
    }

    function hasCompletedStatusRecursive(plan) {
        if (!plan) return false;
        if (plan.status === 'completed') return true;
        if (plan.subPlans && plan.subPlans.length > 0) {
            return plan.subPlans.some(sub => hasCompletedStatusRecursive(sub));
        }
        return false;
    }

    function deletePlan(id) {
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(id, plans); 
        
        if (!plan) return;

        const hasCompleted = hasCompletedStatusRecursive(plan);
        const msg = 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÆ°ÂàíÂêóÔºü' + (hasCompleted ? '<br><span style="color:#ff4d4f; font-weight:bold;">Ê≥®ÊÑèÔºöÂåÖÂê´Â∑≤ÂÆåÊàêÁöÑËÆ°ÂàíÔºåÂà†Èô§Â∞ÜËá™Âä®ÂõûÊªöÂ∫ìÂ≠òÔºÅ</span>' : '');

        document.getElementById('deleteConfirmMsg').innerHTML = msg;
        currentDeletePlanId = id;
        showModal('deleteConfirmModal');
    }

    function confirmDeletePlan() {
        if (!currentDeletePlanId) return;
        const id = currentDeletePlanId;
        closeAllModals();

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(id, plans);
        
        if (!plan) return;

        const hasCompleted = hasCompletedStatusRecursive(plan);
        
        if (hasCompleted) {
             rollbackPlanInventory(plan);
        }

        const result = deletePlanRecursive(plans, id);

        if (result.deleted) {
            localStorage.setItem('bead_plans', JSON.stringify(plans));
            if (currentPlanId === id) closePlanDetail();
            renderPlans();
            showToast('ËÆ°ÂàíÂ∑≤Âà†Èô§');
        }
        currentDeletePlanId = null;
    }

    function deletePlanRecursive(list, id) {
        const idx = list.findIndex(p => p.id === id);
        if (idx !== -1) {
            list.splice(idx, 1);
            return { deleted: true, parentModified: false };
        }
        
        for (let p of list) {
            if (p.subPlans) {
                const res = deletePlanRecursive(p.subPlans, id);
                if (res.deleted) {
                    recalculatePlanItems(p);
                    return { deleted: true, parentModified: true };
                }
            }
        }
        return { deleted: false };
    }

    function recalculatePlanItems(plan) {
        const aggregatedItems = new Map();
        plan.subPlans.forEach(sub => {
            sub.items.forEach(item => {
                const currentQty = aggregatedItems.get(item.code) || 0;
                aggregatedItems.set(item.code, currentQty + item.qty);
            });
        });
        
        const newItems = [];
        aggregatedItems.forEach((qty, code) => {
            newItems.push({ code, qty });
        });
        plan.items = newItems;
    }

    function playSuccessSound() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            const now = ctx.currentTime;
            
            // "Tada" effect: C5 - E5 - G5 - C6
            const notes = [523.25, 659.25, 783.99, 1046.50];
            
            notes.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine'; // Sine for clean bell-like sound
                osc.frequency.setValueAtTime(freq, now + i * 0.1);
                
                gain.gain.setValueAtTime(0.1, now + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.4); // Decay
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start(now + i * 0.1);
                osc.stop(now + i * 0.1 + 0.4);
            });
            
            // Confetti sound (noise burst)
            const bufferSize = ctx.sampleRate * 0.5; // 0.5 sec
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            const noise = ctx.createBufferSource();
            noise.buffer = buffer;
            const noiseGain = ctx.createGain();
            noiseGain.gain.setValueAtTime(0.05, now + 0.3);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
            
            // Filter to make it sound like 'pop'
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 1000;
            
            noise.connect(filter);
            filter.connect(noiseGain);
            noiseGain.connect(ctx.destination);
            
            noise.start(now + 0.3);
            
        } catch(e) {
            console.error("Audio play failed", e);
        }
    }

    let currentDeductPlanId = null;

    function deductPlanInventory(id) {
        currentDeductPlanId = id;
        const plan = findPlanById(id, JSON.parse(localStorage.getItem('bead_plans') || '[]'));
        if(!plan) return;

        document.getElementById('deductPlanName').textContent = `ËÆ°Âàí: ${plan.name}`;
        // Reset inputs
        document.getElementById('deductTimeHours').value = '';
        document.getElementById('deductTimeMinutes').value = '';
        showModal('deductModal');
    }

    function confirmDeduct() {
        const id = currentDeductPlanId;
        if (!id) return;
        
        closeAllModals();

        // Load plans so we can update status and save
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(id, plans);
        if(!plan) return;

        // One-click deduction per user preference (no confirm) -> Now with custom modal confirmed


        const BEAD_WEIGHT_PER_100 = 1;
        let count = 0;
        
        // Get time spent from new inputs
        const hVal = document.getElementById('deductTimeHours').value.trim();
        const mVal = document.getElementById('deductTimeMinutes').value.trim();
        let timeSpent = '';

        if (hVal !== '' || mVal !== '') {
            const h = parseInt(hVal) || 0;
            const m = parseInt(mVal) || 0;
            
            if (h < 0 || m < 0) {
                alert('ËÄóÊó∂ËÆ∞ÂΩï‰∏çËÉΩ‰∏∫Ë¥üÊï∞');
                return;
            }
            if (h === 0 && m === 0) {
                 // User entered 0 and 0.
                 // Request: "ÂÖÅËÆ∏ÈÉΩÂ°´0" (Allow both to be 0)
                 // This means explicit 0h 0m is a valid record, likely meaning "negligible time" or just explicitly recorded as 0.
                 // If both are empty, we treat as no record.
                 // If at least one is "0" and the other is empty or "0", we treat as 0 time.
                 
                 if (hVal !== '' || mVal !== '') {
                      timeSpent = '0ÂàÜÈíü'; // Or "0Â∞èÊó∂0ÂàÜÈíü"
                 }
                 // If both empty, fall through (timeSpent stays '')
            } else {
                 // Format: XÂ∞èÊó∂YÂàÜÈíü or just XÂ∞èÊó∂ or YÂàÜÈíü
                 // To be consistent with parser: "Xh Ym" or "XÂ∞èÊó∂YÂàÜÈíü"
                 if (h > 0 && m > 0) timeSpent = `${h}Â∞èÊó∂${m}ÂàÜÈíü`;
                 else if (h > 0) timeSpent = `${h}Â∞èÊó∂`;
                 else if (m > 0) timeSpent = `${m}ÂàÜÈíü`;
            }
        }

        plan.items.forEach(pItem => {
             const item = data.find(d => d.id === pItem.code);
             if(item) {
                 const weightToDeduct = parseFloat((pItem.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
                 item.w = parseFloat((item.w - weightToDeduct).toFixed(2));
                 
                 if (!item.logs) item.logs = [];
                 item.logs.push({
                    d: formatTime(new Date()),
                    type: 'use', 
                    val: weightToDeduct,
                    c: pItem.qty, 
                    desc: `ËÆ°ÂàíÊâ£Âáè: ${plan.name}`,
                    drawingName: plan.name,
                    planId: plan.id,
                    timeSpent: timeSpent // Record time spent
                 });
                 item.totalUsed = parseFloat(((item.totalUsed || 0) + weightToDeduct).toFixed(2));
                 count++;
             }
        });
        
        let forceComplete = false;
        if (count === 0) {
            forceComplete = confirm('Êú™Âú®Â∫ìÂ≠ò‰∏≠ÊâæÂà∞ËÆ°ÂàíÂåÖÂê´ÁöÑËâ≤Âè∑ÔºåÊú™Êâ£Âáè‰ªª‰ΩïÂ∫ìÂ≠ò„ÄÇ\n\nÊòØÂê¶‰ªçË¶ÅÂ∞ÜÊ≠§ËÆ°ÂàíÊ†áËÆ∞‰∏∫‚ÄúÂ∑≤ÂÆåÊàê‚ÄùÔºü');
        }

        if(count > 0 || forceComplete) {
            if (count > 0) {
                save();
                render(); // Update inventory UI
            }
            
            // Mark as completed
            plan.status = 'completed';
            plan.completedAt = Date.now();
            if (timeSpent) {
                plan.timeSpent = timeSpent;
            } else {
                delete plan.timeSpent;
            }
            
            // Check if parent collection is now fully completed
            updateParentCollectionStatus(plans, plan.id);

            localStorage.setItem('bead_plans', JSON.stringify(plans));
            
            showToast(count > 0 ? 'Â∫ìÂ≠òÊâ£ÂáèÊàêÂäüÔºÅËÆ°ÂàíÂ∑≤Ê†áËÆ∞‰∏∫‚ÄúÂ∑≤ÂÆåÊàê‚Äù„ÄÇ' : 'ËÆ°ÂàíÂ∑≤Ê†áËÆ∞‰∏∫‚ÄúÂ∑≤ÂÆåÊàê‚Äù„ÄÇ');
            playSuccessSound(); // Play confetti sound
            renderPlans();
            
            // Refresh detail view if open
            if (currentPlanId === id) {
                viewPlanDetail(id);
            }
        }
    }

    function updateParentCollectionStatus(plans, childId) {
        // Find parent (Recursive search)
        function findParent(list, id) {
            for (let p of list) {
                if (p.subPlans) {
                    if (p.subPlans.some(sub => sub.id === id)) return p;
                    const found = findParent(p.subPlans, id);
                    if (found) return found;
                }
            }
            return null;
        }

        let parent = findParent(plans, childId);
        
        if (parent) {
            const allCompleted = parent.subPlans.every(sub => sub.status === 'completed');
            if (allCompleted) {
                // Only update if not already completed
                if (parent.status !== 'completed') {
                    parent.status = 'completed';
                    parent.completedAt = Date.now();
                }
            } else {
                // If we are reverting a child, we might need to revert parent
                if (parent.status === 'completed') {
                    parent.status = 'active';
                    delete parent.completedAt;
                }
            }
            
            // If parent itself has a parent, we might need to propagate up?
            // e.g. GrandParent -> Parent -> Child.
            // If Parent becomes completed, GrandParent might need to check.
            updateParentCollectionStatus(plans, parent.id);
        }
    }

    function enterPlanSelectionMode(initialId) {
        if (isPlanSelectionMode) return;
        isPlanSelectionMode = true;
        selectedPlanIds.clear();
        if (initialId) {
            selectedPlanIds.add(initialId);
        }
        
        const bar = document.getElementById('planSelectionBar');
        bar.style.display = 'flex';
        bar.style.animation = 'none';
        bar.offsetHeight; 
        bar.style.animation = 'slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
        
        updateSelectionUI();
        renderPlans();
        
        if (navigator.vibrate) navigator.vibrate(50);
    }

    function exitPlanSelectionMode() {
        isPlanSelectionMode = false;
        selectedPlanIds.clear();
        document.getElementById('planSelectionBar').style.display = 'none';
        renderPlans();
    }

    function showEditTimeModal(planId) {
        console.log('showEditTimeModal called with:', planId);
        try {
            const plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
            const plan = findPlanById(planId, plans);
            
            if (!plan) {
                console.error('Plan not found:', planId);
                alert('Êú™ÊâæÂà∞ËØ•ËÆ°ÂàíÔºåÊó†Ê≥ïÁºñËæëËÄóÊó∂ (ID: ' + planId + ')');
                return;
            }

            document.getElementById('editTimePlanId').value = planId;
            
            let h = '';
            let m = '';
            if (plan.timeSpent) {
                // Support both "2h 30m" and "2Â∞èÊó∂30ÂàÜÈíü" formats
                let hMatch = plan.timeSpent.match(/(\d+)h/);
                let mMatch = plan.timeSpent.match(/(\d+)m/);
                
                if (!hMatch) hMatch = plan.timeSpent.match(/(\d+)Â∞èÊó∂/);
                if (!mMatch) mMatch = plan.timeSpent.match(/(\d+)ÂàÜÈíü/);
                
                if (hMatch) h = hMatch[1];
                if (mMatch) m = mMatch[1];
            }
            
            const elHours = document.getElementById('editTimeHours');
            const elMinutes = document.getElementById('editTimeMinutes');

            if (elHours) elHours.value = h;
            if (elMinutes) elMinutes.value = m;
            
            // Force show mask and modal with explicit z-index handling
            const modal = document.getElementById('editTimeModal');
            const mask = document.getElementById('mask');
            
            // 1. Show Mask (High Z-Index)
            mask.style.display = 'block';
            mask.style.zIndex = '9999'; 
            
            // 2. Show Modal (Higher Z-Index)
            modal.style.display = 'block';
            modal.style.zIndex = '10001';
            
            // 3. Reset Animation to ensure it plays
             modal.style.animation = 'none';
             modal.offsetHeight; // trigger reflow
             modal.style.animation = 'modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
             
             // Ensure position is correct
             modal.style.position = 'fixed';
             modal.style.top = '50%';
             modal.style.left = '50%';
             modal.style.transform = 'translate(-50%, -50%)';
             
         } catch (e) {
             console.error('Error in showEditTimeModal:', e);
            alert('ÊâìÂºÄÁºñËæëÂºπÁ™óÂá∫Èîô: ' + e.message);
        }
    }
    window.showEditTimeModal = showEditTimeModal;

    function savePlanTime() {
        const planId = document.getElementById('editTimePlanId').value;
        const hVal = document.getElementById('editTimeHours').value.trim();
        const mVal = document.getElementById('editTimeMinutes').value.trim();
        
        const h = hVal ? parseInt(hVal, 10) : 0;
        const m = mVal ? parseInt(mVal, 10) : 0;
        
        let timeStr = '';
        if (h > 0) timeStr += `${h}h `;
        if (m > 0) timeStr += `${m}m`;
        timeStr = timeStr.trim();
        
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        
        const update = (list) => {
            for (let p of list) {
                if (p.id === planId) {
                    if (timeStr) {
                        p.timeSpent = timeStr;
                    } else {
                        delete p.timeSpent;
                    }
                    return true;
                }
                if (p.subPlans && p.subPlans.length > 0) {
                    if (update(p.subPlans)) return true;
                }
            }
            return false;
        };
        
        if (update(plans)) {
            localStorage.setItem('bead_plans', JSON.stringify(plans));
            closeAllModals();
            renderPlans();
            
            // If we are on the detail page for this plan, refresh it
            if (document.getElementById('page-plan-detail').style.display === 'block' && currentPlanId === planId) {
                 viewPlanDetail(planId);
            }
            
            showToast('ËÄóÊó∂Â∑≤Êõ¥Êñ∞');
            if (typeof updatePlanOverviewStats === 'function') updatePlanOverviewStats();
        }
    }

    function togglePlanSelection(id) {
        if (selectedPlanIds.has(id)) {
            selectedPlanIds.delete(id);
        } else {
            selectedPlanIds.add(id);
        }
        updateSelectionUI();
        renderPlans();
    }

    function updateSelectionUI() {
        document.getElementById('selectedCount').innerText = selectedPlanIds.size;
    }

    function mergeSelectedPlans() {
        if (selectedPlanIds.size < 2) {
            alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏§‰∏™È°πÔºàÂåÖÊã¨‰∏Ä‰∏™ÁõÆÊ†áÂêàÈõÜÔºâËøõË°åÊìç‰Ωú„ÄÇ');
            return;
        }

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        
        // Find all selected plans (recursive search)
        let selectedPlans = [];
        selectedPlanIds.forEach(id => {
            const p = findPlanById(id, plans);
            if(p) selectedPlans.push(p);
        });
        
        if (selectedPlans.length === 0) return;

        // Identify Folders
        const isFolder = (p) => Array.isArray(p.subPlans) && p.subPlans.length > 0;
        const folders = selectedPlans.filter(isFolder);
        const regularPlans = selectedPlans.filter(p => !isFolder(p));

        // Case: Multiple Folders -> Error
        if (folders.length > 1) {
            alert('Êó†Ê≥ïÂêàÂπ∂Â§ö‰∏™ÂêàÈõÜÔºå‰πüÊó†Ê≥ïÂ∞ÜÂêàÈõÜÊîæÂÖ•Âè¶‰∏Ä‰∏™ÂêàÈõÜ„ÄÇËØ∑Âè™ÈÄâÊã©‰∏Ä‰∏™ÁõÆÊ†áÂêàÈõÜ„ÄÇ');
            return;
        }

        // Case: 1 Folder + Regular Plans -> Move Plans into Folder
        if (folders.length === 1) {
            const targetFolder = folders[0];
            if (regularPlans.length === 0) {
                alert('ËØ∑ÈÄâÊã©Ë¶ÅÁßªÂÖ•ËØ•ÂêàÈõÜÁöÑËÆ°Âàí„ÄÇ');
                return;
            }

            // Move regularPlans into targetFolder
            regularPlans.forEach(p => {
                deletePlanRecursive(plans, p.id);
            });

            // Add to target folder
            // Note: targetFolder reference is still valid and connected to 'plans' tree
            // unless it was somehow deleted (which shouldn't happen as we didn't select it for deletion)
            if (!targetFolder.subPlans) targetFolder.subPlans = [];
            targetFolder.subPlans.unshift(...regularPlans); // Add to top

            // Update folder stats
            if (typeof recalculatePlanItems === 'function') {
                recalculatePlanItems(targetFolder);
            } else {
                // Fallback if function not found (re-implement basic aggregation)
                const aggregatedItems = new Map();
                const collectItems = (list) => {
                    list.forEach(p => {
                        if (p.subPlans && p.subPlans.length > 0) collectItems(p.subPlans);
                        else p.items.forEach(i => {
                            aggregatedItems.set(i.code, (aggregatedItems.get(i.code)||0) + i.qty);
                        });
                    });
                };
                collectItems(targetFolder.subPlans);
                targetFolder.items = Array.from(aggregatedItems.entries()).map(([code, qty]) => ({code, qty}));
            }

            localStorage.setItem('bead_plans', JSON.stringify(plans));
            showToast(`Â∑≤Â∞Ü ${regularPlans.length} ‰∏™ËÆ°ÂàíÁßªÂÖ•ÂêàÈõÜ‚Äú${targetFolder.name}‚Äù„ÄÇ`);
            exitPlanSelectionMode();
            return;
        }

        // Case: All Regular Plans -> Create New Collection
        // Filter out descendants (prevent double inclusion)
        const containsPlan = (container, targetId) => {
            if (!container.subPlans) return false;
            for (let sp of container.subPlans) {
                if (sp.id === targetId) return true;
                if (containsPlan(sp, targetId)) return true;
            }
            return false;
        };

        const topLevelSelected = selectedPlans.filter(p => {
            // Check if p is inside any other selected plan
            return !selectedPlans.some(other => other !== p && containsPlan(other, p.id));
        });

        if (topLevelSelected.length < 2) {
             alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏§‰∏™ËÆ°ÂàíËøõË°åÂêàÂπ∂„ÄÇ');
             return;
        }

        // Create New Plan
        const aggregatedItems = new Map();
        topLevelSelected.forEach(plan => {
            plan.items.forEach(item => {
                const currentQty = aggregatedItems.get(item.code) || 0;
                aggregatedItems.set(item.code, currentQty + item.qty);
            });
        });

        const newItems = [];
        aggregatedItems.forEach((qty, code) => {
            newItems.push({ code, qty });
        });

        const defaultName = `ÂêàÈõÜ: ${topLevelSelected[0].name} Á≠â${topLevelSelected.length}‰∏™ËÆ°Âàí`;
        pendingMergePlans = topLevelSelected;
        
        const nameInput = document.getElementById('collectionNameInput');
        nameInput.value = '';
        nameInput.placeholder = defaultName;
        showModal('createCollectionModal');
    }
    
    function confirmCreateCollection() {
        if (!pendingMergePlans) return;
        const topLevelSelected = pendingMergePlans;
        let newPlanName = document.getElementById('collectionNameInput').value;
        closeAllModals();

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        
        // Create New Plan
        const aggregatedItems = new Map();
        topLevelSelected.forEach(plan => {
            plan.items.forEach(item => {
                const currentQty = aggregatedItems.get(item.code) || 0;
                aggregatedItems.set(item.code, currentQty + item.qty);
            });
        });

        const newItems = [];
        aggregatedItems.forEach((qty, code) => {
            newItems.push({ code, qty });
        });

        const defaultName = `ÂêàÈõÜ: ${topLevelSelected[0].name} Á≠â${topLevelSelected.length}‰∏™ËÆ°Âàí`;
        newPlanName = newPlanName.trim() || defaultName;
        
        // Determine status based on selected plans
        const isAllCompleted = topLevelSelected.every(p => p.status === 'completed');

        const newPlan = {
            id: 'plan_group_' + Date.now(),
            name: newPlanName,
            createdAt: Date.now(),
            items: newItems,
            status: isAllCompleted ? 'completed' : 'active',
            completedAt: isAllCompleted ? Date.now() : undefined,
            subPlans: topLevelSelected,
            thumbnail: null
        };

        // Remove topLevelSelected from the tree
        topLevelSelected.forEach(p => {
             deletePlanRecursive(plans, p.id);
        });
        
        // Add new plan to root
        plans.unshift(newPlan);
        
        localStorage.setItem('bead_plans', JSON.stringify(plans));

        showToast('ÂêàÂπ∂ÊàêÂäüÔºÅÂ∑≤ÁîüÊàêÊñ∞ÁöÑÂêàÈõÜËÆ°Âàí„ÄÇ');
        exitPlanSelectionMode();
        pendingMergePlans = null;
    }
    

    // --- Copy Aggregated Shopping List ---
    function copyMissingSummary() {
        const plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const summary = aggregateActivePlanRequirements(plans);
        if (!summary || summary.shortages.length === 0) {
            showToast("ÂΩìÂâçÊ≤°ÊúâÁº∫Ë¥ßËâ≤Âè∑");
            return;
        }
        
        // Format: "Áº∫Ë¥ßÈ¢ÑË≠¶Ôºö\nC11 Áº∫9.66g\nC13 Áº∫4.52g"
        summary.shortages.sort((a, b) => b.missingQty - a.missingQty);
        
        // Calculate beads count: missingQty * 100 (since 1g=100beads approx in this system's logic or using BEAD_WEIGHT_PER_100=1)
        // Let's use standard unit "ÂåÖ" or "Á≤í" if preferred. 
        // User asked for "A1: ÈúÄË°•2ÂåÖ". Let's assume 1 bag = 500 or 1000? 
        // Or just output grams/count. Let's output grams and estimated count.
        
        const text = "„ÄêË°•Ë¥ßÊ∏ÖÂçï„Äë\n" + summary.shortages.map(item => {
            // item.missingQty is in 'g' (based on currentStock vs neededWeight logic)
            // 1 unit in system usually 10g (1000 beads)
            // Let's just output "Need X g"
            const bags = Math.ceil(item.missingQty / 50); // Assume 1 bag = 50g
            return `${item.code}: Áº∫${Math.ceil(item.missingQty)}g (Á∫¶${bags}ÂåÖ)`;
        }).join('\n');
        
        // Web Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
             navigator.clipboard.writeText(text).then(() => {
                showToast("Â∑≤Â§çÂà∂Ë°•Ë¥ßÊ∏ÖÂçï");
             }).catch(err => {
                fallbackCopyText(text);
             });
        } else {
             fallbackCopyText(text);
        }
    }

    function fallbackCopyText(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; 
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showToast("Â∑≤Â§çÂà∂Ë°•Ë¥ßÊ∏ÖÂçï");
        } catch (err) {
            console.error('Fallback copy failed', err);
            showToast("Â§çÂà∂Â§±Ë¥•");
        }
        document.body.removeChild(textArea);
    }


</script>
<!-- Floating Add Button -->
<div id="floatingHomeBtn" class="floating-home-btn" onclick="navTo('home')">
    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
</div>

<div id="floatingBatchAddBtn" class="floating-add-btn" onclick="openBatchOperation()">
    <span style="font-size: 14px; font-weight: bold;">+/-</span>
</div>

<!-- Batch Operation Modal -->
<div id="batchAddModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:300; flex-direction:column;">
    <!-- Header -->
    <div style="padding:15px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0;">
        <button onclick="closeBatchAdd()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">ÂèñÊ∂à</button>
        
        <!-- Mode Switch -->
        <div style="display:flex; background:#f0f0f0; border-radius:20px; padding:2px;">
            <div id="batchModeAdd" onclick="setBatchMode('add')" style="padding:5px 15px; border-radius:18px; font-size:14px; cursor:pointer; background:white; color:#4a90e2; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition:all 0.2s;">ÂÖ•Â∫ì</div>
            <div id="batchModeDeduct" onclick="setBatchMode('deduct')" style="padding:5px 15px; border-radius:18px; font-size:14px; cursor:pointer; color:#666; transition:all 0.2s;">Âá∫Â∫ì</div>
        </div>
        
        <button onclick="toggleBatchSelectAll()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">ÂÖ®ÈÄâ</button>
    </div>
    
    <!-- Subtitle -->
    <div id="batchSubtitle" style="padding:10px 15px; background:#f9f9f9; color:#999; font-size:12px;">
        Â¢ûÂä†Â∫ìÂ≠òÔºå1Âçï‰Ωç = 1000Á≤í = 10g
    </div>
    
    <!-- Series Tabs -->
    <div id="batchAddSeriesTabs" style="display:flex; overflow-x:auto; padding:10px 15px; gap:10px; border-bottom:1px solid #f0f0f0; -webkit-overflow-scrolling: touch;">
        <!-- Tabs injected by JS -->
    </div>
    
    <!-- List -->
    <div id="batchAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <!-- Items injected by JS -->
    </div>
    
    <!-- Footer -->
    <div style="padding:15px; border-top:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; background:white;">
        <div>
            <div style="font-size:12px; color:#999;">Â∑≤ÈÄâÊã© <span id="batchAddCount" style="color:#333; font-weight:bold;">0</span> Ëâ≤</div>
            <div style="font-size:16px; font-weight:bold; color:#4a90e2;" id="batchTotalDisplay">ÂÖ± +<span id="batchAddTotal">0</span> Á≤í</div>
        </div>
        <button onclick="confirmBatchAdd()" id="batchConfirmBtn" class="m-btn m-btn-primary" style="width:auto; padding:10px 25px; border-radius:20px; box-shadow:0 4px 10px rgba(74, 144, 226, 0.3);">Á°ÆËÆ§Ê∑ªÂä†</button>
    </div>
</div>

<style>
.floating-add-btn {
    position: fixed; bottom: 100px; right: 20px;
    width: 36px; height: 36px;
    background: #4a90e2;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    display: none; align-items: center; justify-content: center;
    color: white; font-size: 24px; cursor: pointer;
    z-index: 180; transition: transform 0.2s;
}
.floating-add-btn:active { transform: scale(0.90); }
.floating-add-btn span { position: relative; top: -1px; }

.floating-home-btn {
    position: fixed; bottom: 100px; right: 70px;
    width: 36px; height: 36px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none; align-items: center; justify-content: center;
    color: #4a90e2; font-size: 20px; cursor: pointer;
    z-index: 180; transition: transform 0.2s; border: 1px solid #eee;
}
.floating-home-btn:active { transform: scale(0.90); }


.batch-tab {
    padding: 6px 16px; border-radius: 20px; background: #f0f0f0; color: #666; font-size: 14px; flex-shrink: 0; cursor: pointer; transition: all 0.2s;
}
.batch-tab.active {
    background: #4a90e2; color: white; box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3);
}

.batch-item {
    display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; margin-bottom: 10px; border: 1px solid #f0f0f0; transition: all 0.2s;
}
.batch-item.selected {
    border-color: #91d5ff; background: #e6f7ff;
}

.batch-check {
    width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; margin-right: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.batch-item.selected .batch-check {
    background: #4a90e2; border-color: #4a90e2; color: white;
}
.batch-check::after {
    content: "‚úì"; font-size: 14px; display: none;
}
.batch-item.selected .batch-check::after {
    display: block;
}

.batch-stepper {
    display: flex; align-items: center; background: white; border-radius: 8px; border: 1px solid #eee; overflow: hidden;
}
.batch-step-btn {
    width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; color: #666; cursor: pointer;
}
.batch-step-btn.add {
    background: #4a90e2; color: white;
}
.batch-input {
    width: 44px; text-align: center; border: none; font-size: 14px; color: #333; outline: none; background: transparent;
}
</style>

<script>
let batchAddSelection = {}; // { id: qty }
let batchCurrentSeries = 'A';
let batchMode = 'add'; // 'add' | 'deduct'

function openBatchOperation() {
    batchAddSelection = {};
    document.getElementById('batchAddModal').style.display = 'flex';
    
    // Default to Add mode
    setBatchMode('add');
    
    // Find all series
    const series = new Set();
    data.forEach(d => {
        const match = d.id.match(/^[A-Z]+/);
        if(match) series.add(match[0]);
    });
    const sortedSeries = Array.from(series).sort();
    if(sortedSeries.length > 0) batchCurrentSeries = sortedSeries[0];
    
    renderBatchAddTabs(sortedSeries);
    renderBatchAddList();
    updateBatchSummary();
}

function setBatchMode(mode) {
    batchMode = mode;
    batchAddSelection = {}; 
    
    const btnAdd = document.getElementById('batchModeAdd');
    const btnDeduct = document.getElementById('batchModeDeduct');
    const confirmBtn = document.getElementById('batchConfirmBtn');
    
    if(mode === 'add') {
        btnAdd.style.background = 'white';
        btnAdd.style.color = '#4a90e2';
        btnAdd.style.fontWeight = 'bold';
        btnAdd.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        btnDeduct.style.background = 'transparent';
        btnDeduct.style.color = '#666';
        btnDeduct.style.fontWeight = 'normal';
        btnDeduct.style.boxShadow = 'none';
        
        confirmBtn.innerText = 'Á°ÆËÆ§ÂÖ•Â∫ì';
        confirmBtn.style.background = '#4a90e2';
    } else {
        btnDeduct.style.background = 'white';
        btnDeduct.style.color = '#e24a4a';
        btnDeduct.style.fontWeight = 'bold';
        btnDeduct.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        btnAdd.style.background = 'transparent';
        btnAdd.style.color = '#666';
        btnAdd.style.fontWeight = 'normal';
        btnAdd.style.boxShadow = 'none';
        
        confirmBtn.innerText = 'Á°ÆËÆ§Âá∫Â∫ì';
        confirmBtn.style.background = '#e24a4a';
    }
    
    renderBatchAddList();
    updateBatchSummary();
}

function closeBatchAdd() {
    document.getElementById('batchAddModal').style.display = 'none';
}

function renderBatchAddTabs(allSeries) {
    const container = document.getElementById('batchAddSeriesTabs');
    container.innerHTML = '';
    allSeries.forEach(s => {
        const div = document.createElement('div');
        div.className = `batch-tab ${s === batchCurrentSeries ? 'active' : ''}`;
        div.innerText = s;
        div.onclick = () => {
            batchCurrentSeries = s;
            renderBatchAddTabs(allSeries);
            renderBatchAddList();
        };
        container.appendChild(div);
    });
}

function renderBatchAddList() {
    const container = document.getElementById('batchAddList');
    container.innerHTML = '';
    
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    
    items.forEach(item => {
        const isSelected = batchAddSelection[item.id] !== undefined;
        let qty = batchAddSelection[item.id];
        if (qty === undefined) {
             qty = (batchMode === 'add') ? 1 : ''; 
        }
        
        const div = document.createElement('div');
        div.className = `batch-item ${isSelected ? 'selected' : ''}`;
        div.onclick = (e) => {
            if(e.target.closest('.batch-stepper') || e.target.tagName === 'INPUT') return;
            toggleBatchItem(item.id);
        };
        
        let controlsHtml = '';
        if (isSelected) {
            if (batchMode === 'add') {
                controlsHtml = `
                <div class="batch-stepper">
                    <div class="batch-step-btn" onclick="updateBatchQty('${item.id}', -1)">-</div>
                    <input type="number" class="batch-input" value="${qty}" step="0.1" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                    <div class="batch-step-btn add" onclick="updateBatchQty('${item.id}', 1)">+</div>
                </div>
                <div style="font-size: 10px; color: #999; margin-left: 5px;">x1000</div>
                `;
            } else {
                 controlsHtml = `
                <div class="batch-stepper" style="border-color:#e24a4a; height: 30px; display: flex; align-items: center;">
                    <div style="padding-left: 8px; color: #e24a4a; font-weight: bold;">-</div>
                    <input type="number" class="batch-input" style="width:60px; text-align:center; height: 100%;" value="${qty}" placeholder="" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                </div>
                <div style="font-size: 10px; color: #999; margin-left: 5px;">Á≤í</div>
                `;
            }
        }
        
        div.innerHTML = `
            <div class="batch-check"></div>
            <div style="width: 36px; height: 36px; background: ${item.hex}; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); margin-right: 15px;"></div>
            <div style="flex: 1; font-weight: bold; font-size: 16px;">${item.id}</div>
            ${controlsHtml}
        `;
        container.appendChild(div);
    });
}

function toggleBatchItem(id) {
    if (batchAddSelection[id] !== undefined) {
        delete batchAddSelection[id];
    } else {
        batchAddSelection[id] = (batchMode === 'add') ? 1 : '';
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQty(id, delta) {
    if (batchAddSelection[id] === undefined) return;
    
    if (batchMode === 'add') {
        let newQty = parseFloat(batchAddSelection[id]) + delta;
        newQty = parseFloat(newQty.toFixed(1));
        if (newQty <= 0) {
            delete batchAddSelection[id];
        } else {
            batchAddSelection[id] = newQty;
        }
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQtyInput(id, val) {
    if (batchMode === 'add') {
        let newQty = parseFloat(val);
        if (isNaN(newQty) || newQty <= 0) {
            delete batchAddSelection[id];
        } else {
            batchAddSelection[id] = parseFloat(newQty.toFixed(1));
        }
    } else {
        if (val === '') {
             batchAddSelection[id] = '';
        } else {
            let newQty = parseInt(val);
            if (isNaN(newQty) || newQty <= 0) {
                // Keep selection but maybe invalid? 
                // If user enters -5, we should probably reject or set to something valid.
                // For now, if invalid, delete selection? Or just don't update?
                // Deleting selection might be annoying if accidental.
                // Let's just set to valid or ignore.
                // If <= 0, delete.
                if (newQty <= 0) delete batchAddSelection[id];
                else batchAddSelection[id] = newQty;
            } else {
                batchAddSelection[id] = newQty;
            }
        }
    }
    updateBatchSummary();
}

function toggleBatchSelectAll() {
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    const allSelected = items.every(item => batchAddSelection[item.id] !== undefined);
    
    if (allSelected) {
        items.forEach(item => delete batchAddSelection[item.id]);
    } else {
        items.forEach(item => {
            if(batchAddSelection[item.id] === undefined) {
                 batchAddSelection[item.id] = (batchMode === 'add') ? 1 : '';
            }
        });
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchSummary() {
    const count = Object.keys(batchAddSelection).length;
    let total = 0;
    
    Object.values(batchAddSelection).forEach(q => {
        if(q === '' || q === undefined) return;
        if(batchMode === 'add') {
            total += q * 1000;
        } else {
            total += q;
        }
    });
    
    document.getElementById('batchAddCount').innerText = count;
    const totalDisplay = document.getElementById('batchTotalDisplay');
    const totalSpan = document.getElementById('batchAddTotal');
    
    if(batchMode === 'add') {
        totalDisplay.innerHTML = `ÂÖ± +<span id="batchAddTotal">0</span> Á≤í`;
        document.getElementById('batchAddTotal').innerText = (total >= 1000) ? (total/1000).toFixed(1) + 'K' : total;
    } else {
        totalDisplay.innerHTML = `ÂÖ± -<span id="batchAddTotal">0</span> Á≤í`;
        document.getElementById('batchAddTotal').innerText = total;
    }
}

function confirmBatchAdd() {
    const count = Object.keys(batchAddSelection).length;
    if (count === 0) return;
    
    const now = new Date();
    const dateStr = formatTime(now);
    
    if (batchMode === 'add') {
        Object.entries(batchAddSelection).forEach(([id, qty]) => {
            const item = data.find(d => d.id === id);
            if(item) {
                const weightToAdd = qty * 10; 
                item.w = parseFloat((item.w + weightToAdd).toFixed(2));
                item.totalAdded = parseFloat(((item.totalAdded || 0) + weightToAdd).toFixed(2));
                
                if(!item.logs) item.logs = [];
                item.logs.push({ d: dateStr, type: 'add', val: weightToAdd, note: 'ÊâπÈáèÂÖ•Â∫ì' });
                if(item.logs.length > 20) item.logs.shift();
            }
        });
        showToast("ÂÖ•Â∫ìÊàêÂäüÔºÅ");
    } else {
        // Deduct mode
        let warnings = [];
        let validDeductions = [];
        
        for (const [id, qty] of Object.entries(batchAddSelection)) {
            if (!qty) continue;
            const item = data.find(d => d.id === id);
            if (!item) continue;
            
            const currentBeads = Math.round(item.w * 100); 
            const deductBeads = qty;
            
            if (deductBeads > currentBeads) {
                warnings.push(`${id} (Â∫ìÂ≠ò: ${currentBeads}, Êâ£Èô§: ${deductBeads})`);
            }
            
            const weightToDeduct = parseFloat((deductBeads * 0.01).toFixed(2));
            validDeductions.push({ item, weightToDeduct, beads: deductBeads });
        }
        
        if (warnings.length > 0) {
            const msg = "‰ª•‰∏ãËâ≤Âè∑Êâ£Èô§Êï∞ÈáèË∂ÖËøáÂΩìÂâçÂ∫ìÂ≠òÔºö\n" + warnings.join("\n") + "\n\nÊòØÂê¶ÁªßÁª≠Êâ£Èô§Ôºü";
            if (!confirm(msg)) return;
        }
        
        validDeductions.forEach(({ item, weightToDeduct, beads }) => {
            item.w = parseFloat((item.w - weightToDeduct).toFixed(2));
            item.used = parseFloat(((item.used || 0) + weightToDeduct).toFixed(2));
             
            if(!item.logs) item.logs = [];
            item.logs.push({ d: dateStr, type: 'use', val: weightToDeduct, c: beads, note: 'ÊâπÈáèÂá∫Â∫ì' });
            if(item.logs.length > 20) item.logs.shift();
        });
        showToast("Âá∫Â∫ìÊàêÂäüÔºÅ");
    }
    
    save();
    render();
    closeBatchAdd();
}
    // --- Pull to Refresh Logic ---
    let ptrStartY = 0;
    let ptrCurrentY = 0;
    let ptrDistance = 0;
    let isPtrActive = false;
    let isPtrLoading = false;
    const PTR_THRESHOLD = 80;
    
    // Main scrollable element is body/window
    window.addEventListener('touchstart', (e) => {
        // Only enable on specific pages
        const activePage = ['page-beads', 'page-stats', 'page-plan', 'page-fabric'].find(id => document.getElementById(id).style.display !== 'none');
        if (!activePage) return;
        
        if (window.scrollY === 0 && !isPtrLoading) {
            ptrStartY = e.touches[0].clientY;
            isPtrActive = true;
        }
    }, {passive: true});
    
    window.addEventListener('touchmove', (e) => {
        if (!isPtrActive || isPtrLoading) return;
        
        ptrCurrentY = e.touches[0].clientY;
        const diff = ptrCurrentY - ptrStartY;
        
        // Only track pull down
        if (diff > 0 && window.scrollY === 0) {
            // Resistance effect
            ptrDistance = Math.pow(diff, 0.8);
            
            // Limit max pull
            if (ptrDistance > 150) ptrDistance = 150;
            
            updatePtrVisuals(ptrDistance);
        } else {
            isPtrActive = false;
            resetPtr();
        }
    }, {passive: true});
    
    window.addEventListener('touchend', () => {
        if (!isPtrActive || isPtrLoading) return;
        
        if (ptrDistance > PTR_THRESHOLD) {
            startPtrLoading();
        } else {
            resetPtr();
        }
        isPtrActive = false;
    });
    
    function updatePtrVisuals(dist) {
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const text = document.getElementById('ptr-text');
        
        indicator.style.transform = `translateY(${dist}px)`;
        
        if (dist > PTR_THRESHOLD) {
            text.textContent = "ÈáäÊîæÂà∑Êñ∞";
            icon.style.transform = "rotate(180deg)";
        } else {
            text.textContent = "‰∏ãÊãâÂà∑Êñ∞";
            icon.style.transform = "rotate(0deg)";
        }
    }
    
    function startPtrLoading() {
        isPtrLoading = true;
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const spinner = document.getElementById('ptr-spinner');
        const text = document.getElementById('ptr-text');
        
        indicator.style.transform = `translateY(50px)`;
        icon.style.display = 'none';
        spinner.style.display = 'block';
        text.textContent = "Âä†ËΩΩ‰∏≠...";
        
        // Simulate refresh delay
        setTimeout(() => {
            window.location.reload();
        }, 800);
    }
    
    function resetPtr() {
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const spinner = document.getElementById('ptr-spinner');
        
        indicator.style.transform = `translateY(0)`;
        icon.style.display = 'inline';
        icon.style.transform = "rotate(0deg)";
        spinner.style.display = 'none';
        ptrDistance = 0;
    }

    // --- Plan Image Viewer Logic ---
    let imgScale = 1;
    let imgTranslateX = 0;
    let imgTranslateY = 0;
    let imgStartX = 0;
    let imgStartY = 0;
    let imgIsDragging = false;
    let imgInitialPinchDist = 0;
    let imgInitialScale = 1;

    function openPlanImageViewer() {
        const detailImg = document.getElementById('planDetailImage');
        const fullImg = document.getElementById('planFullImage');
        if (!detailImg.src) return;
        
        fullImg.src = detailImg.src;
        document.getElementById('planImageViewer').style.display = 'block';
        resetPlanImageZoom();
        
        // Disable page scroll
        document.body.style.overflow = 'hidden';
    }

    function closePlanImageViewer() {
        document.getElementById('planImageViewer').style.display = 'none';
        document.body.style.overflow = '';
    }

    function resetPlanImageZoom() {
        imgScale = 1;
        imgTranslateX = 0;
        imgTranslateY = 0;
        updateImageTransform();
    }

    function updateImageTransform() {
        const img = document.getElementById('planFullImage');
        img.style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${imgScale})`;
    }

    // Touch Event Handlers
    const viewer = document.getElementById('planImageViewer');
    
    viewer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            // Pinch
            imgIsDragging = false;
            imgInitialPinchDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            imgInitialScale = imgScale;
        } else if (e.touches.length === 1) {
            // Pan
            imgIsDragging = true;
            imgStartX = e.touches[0].clientX - imgTranslateX;
            imgStartY = e.touches[0].clientY - imgTranslateY;
        }
    });

    viewer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const currentDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            const ratio = currentDist / imgInitialPinchDist;
            let newScale = imgInitialScale * ratio;
            newScale = Math.min(Math.max(0.5, newScale), 5); // Limit 0.5x to 5x
            imgScale = newScale;
            updateImageTransform();
        } else if (e.touches.length === 1 && imgIsDragging) {
            e.preventDefault();
            imgTranslateX = e.touches[0].clientX - imgStartX;
            imgTranslateY = e.touches[0].clientY - imgStartY;
            updateImageTransform();
        }
    });

    viewer.addEventListener('touchend', () => {
        imgIsDragging = false;
    });

    // Mouse Events for Desktop Testing
    let isMouseDownViewer = false;
    viewer.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'IMG' || e.target.id === 'planImageWrapper') {
             isMouseDownViewer = true;
             imgStartX = e.clientX - imgTranslateX;
             imgStartY = e.clientY - imgTranslateY;
        }
    });

    viewer.addEventListener('mousemove', (e) => {
        if (!isMouseDownViewer) return;
        e.preventDefault();
        imgTranslateX = e.clientX - imgStartX;
        imgTranslateY = e.clientY - imgStartY;
        updateImageTransform();
    });

    viewer.addEventListener('mouseup', () => {
        isMouseDownViewer = false;
    });

    viewer.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = -Math.sign(e.deltaY) * 0.1;
        let newScale = imgScale + delta;
        newScale = Math.min(Math.max(0.5, newScale), 5);
        imgScale = newScale;
        updateImageTransform();
    }, {passive: false});

    function togglePlanOverviewContainer() {
        const el = document.getElementById('plan-overview-container');
        if (el) {
            if (el.style.display === 'none') {
                el.style.display = 'block';
                updatePlanOverviewStats();
            } else {
                el.style.display = 'none';
            }
        }
    }

    function updatePlanOverviewStats() {
        let plans = [];
        try {
            plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        } catch (e) {
            console.error('Error loading plans for stats:', e);
        }
        
        const getRealCount = (list) => {
            let count = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    count += getRealCount(p.subPlans);
                } else {
                    count++;
                }
            });
            return count;
        };

        const getRealTime = (list) => {
            let t = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    t += getRealTime(p.subPlans);
                } else {
                    if(p.status === 'completed') {
                        t += parseTimeSpentToHours(p.timeSpent);
                    }
                }
            });
            return t;
        };

        const activeList = plans.filter(p => (p.status || 'active') === 'active');
        const completedList = plans.filter(p => (p.status || 'active') === 'completed');

        const planPending = getRealCount(activeList);
        const planCompleted = getRealCount(completedList);
        const planTotal = planPending + planCompleted;
        const planTime = getRealTime(plans);

        const elPlanTotal = document.getElementById('stats-plan-total');
        if(elPlanTotal) elPlanTotal.textContent = planTotal;
        
        const elPlanCompleted = document.getElementById('stats-plan-completed');
        if(elPlanCompleted) elPlanCompleted.textContent = planCompleted;
        
        const elPlanPending = document.getElementById('stats-plan-pending');
        if(elPlanPending) elPlanPending.textContent = planPending;

        const elPlanTime = document.getElementById('stats-plan-time');
        if(elPlanTime) elPlanTime.textContent = planTime.toFixed(1);

        // Update UI state based on planChartConfig
        const setMetricActive = (id, active, color) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (active) {
                el.style.border = `2px solid ${color}`;
                el.style.background = '#f9f9f9';
            } else {
                el.style.border = '2px solid transparent';
                el.style.background = 'transparent';
            }
        };

        setMetricActive('metric-total', planChartConfig.total, '#4a90e2');
        setMetricActive('metric-completed', planChartConfig.completed, '#52c41a');
        setMetricActive('metric-pending', planChartConfig.pending, '#faad14');
        setMetricActive('metric-time', planChartConfig.time, '#722ed1');

        renderPlanChart(plans);
    }

</script>
    <!-- Image Viewer Modal -->
    <div id="planImageViewer" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; overflow: hidden; touch-action: none;">
         <div style="position: absolute; top: 20px; right: 20px; z-index: 2010; display: flex; gap: 15px;">
             <div onclick="resetPlanImageZoom()" style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; backdrop-filter: blur(4px);">
                 <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/></svg>
             </div>
             <div onclick="closePlanImageViewer()" style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; backdrop-filter: blur(4px);">
                 <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
             </div>
         </div>
         
         <div id="planImageWrapper" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
             <img id="planFullImage" src="" style="max-width: 100%; max-height: 100%; transition: transform 0.1s linear; transform-origin: center center;">
         </div>
         

    </div>

<!-- Moved editTimeModal to body root to ensure proper z-index and positioning -->
<div id="editTimeModal" class="modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 85%; max-width: 320px; padding: 0; border-radius: 20px; z-index: 10001; overflow: hidden; background: #fff;">
    <div style="background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%); padding: 24px 20px 10px 20px; text-align: center;">
        <div style="font-size: 32px; margin-bottom: 8px;">‚è≥</div>
        <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 600;">ËÆ∞ÂΩïÂà∂‰ΩúËÄóÊó∂</h3>
        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">ËÆ∞ÂΩï‰∏ã‰Ω†ÁöÑÂøÉË°Ä‰∏éÊó∂Èó¥</p>
    </div>
    
    <div style="padding: 20px;">
        <input type="hidden" id="editTimePlanId">
        
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 24px;">
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                <div style="position: relative; width: 100%;">
                    <input type="number" id="editTimeHours" min="0" placeholder="0" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        style="width: 100%; padding: 12px; padding-right: 30px; background: #f9fafb; border: 2px solid #f0f0f0; border-radius: 12px; font-size: 20px; outline: none; box-sizing: border-box; transition: all 0.2s; text-align: center; font-weight: bold; color: #333;"
                        onfocus="this.style.background='white'; this.style.borderColor='var(--primary)';"
                        onblur="this.style.background='#f9fafb'; this.style.borderColor='#f0f0f0';"
                    >
                    <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 12px; pointer-events: none;">Â∞èÊó∂</span>
                </div>
            </div>
            <div style="font-weight: bold; color: #ccc;">:</div>
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                <div style="position: relative; width: 100%;">
                    <input type="number" id="editTimeMinutes" min="0" max="59" placeholder="0" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        style="width: 100%; padding: 12px; padding-right: 30px; background: #f9fafb; border: 2px solid #f0f0f0; border-radius: 12px; font-size: 20px; outline: none; box-sizing: border-box; transition: all 0.2s; text-align: center; font-weight: bold; color: #333;"
                        onfocus="this.style.background='white'; this.style.borderColor='var(--primary)';"
                        onblur="this.style.background='#f9fafb'; this.style.borderColor='#f0f0f0';"
                    >
                    <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 12px; pointer-events: none;">ÂàÜÈíü</span>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button onclick="closeAllModals()" style="flex: 1; padding: 12px; border: 1px solid #eee; background: white; color: #666; border-radius: 12px; font-size: 15px; font-weight: 500;">ÂèñÊ∂à</button>
            <button onclick="savePlanTime()" style="flex: 1; padding: 12px; border: none; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; border-radius: 12px; font-size: 15px; font-weight: bold; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);">‰øùÂ≠ò</button>
        </div>
    </div>
</div>
</body>
</html>