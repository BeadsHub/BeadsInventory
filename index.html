<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <title>MARD è±†åº“ -æ‹¼è±†åº“å­˜ç®¡ç†å·¥å…·</title>
    <style>
        :root { --primary: #4a90e2; --warn: #ff4d4f; --bg: #f0f2f5; --success: #52c41a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; font-size: 14px; color: #333; overscroll-behavior-y: contain; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; padding-bottom: 90px; }
        


        /* å¤´éƒ¨æ§åˆ¶åŒº */
        .header-sticky { position: sticky; top: 0; background: white; z-index: 100; border-bottom: 2px solid #eee; padding: 12px 15px; }
        .top-bar { display: flex; flex-direction: column; margin-bottom: 10px; }
        .stats { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; 
            background: #f8f9fa; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box;
            /* justify-items: center; text-align: center;  <-- Remove this to allow individual alignment */
        }
        .stats > div { display: flex; flex-direction: column; align-items: flex-start; width: 100%; }
        /* è®©ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆè‰²å·ï¼‰å·¦å¯¹é½ï¼Œå»é™¤äº†å·¦é—´è· */
        .stats > div:first-child { padding-left: 0; box-sizing: border-box; }
        /* è®©æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆè®¾ç½®ï¼‰ä¹Ÿå·¦å¯¹é½ï¼Œä¿ç•™å³é—´è· */
        .stats > div:last-child { padding-right: 8px; box-sizing: border-box; }
        .stat-item b { display: block; font-size: 16px; color: var(--primary); }

        /* é…ç½®ä¸æ’åºåŒº */
        .config-zone { font-size: 12px; background: #fffbe6; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .config-zone input { width: 40px; padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        .btn-sort { background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-sort.active { background: var(--primary); color: white; }

        .btn-text { font-size: 12px; color: var(--primary); cursor: pointer; background:none; border:none; padding:0; text-decoration: underline; }

        /* æœç´¢æ¡† */
        #search { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; margin-bottom: 5px; height: 42px; }
        
        /* åˆ—è¡¨æ¸²æŸ“ */
        .bead-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        .bead-row.selected { background: #e6f7ff; }
        .col-select { width: 25px; }
        .col-color { width: 40px; }
        .swatch { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; }
        .col-id { width: 60px; font-weight: bold; font-family: monospace; font-size: 15px; }
        .col-weight { flex: 1; }
        .weight-badge { padding: 4px 8px; border-radius: 6px; background: #eee; font-weight: bold; font-family: monospace; cursor: pointer; }
        .weight-badge.low { background: var(--warn); color: white; }
        .col-action { width: 60px; text-align: right; }
        .btn-plus { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; padding: 5px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; }
        .btn-detail { background: #fff; border: 1px solid #d9d9d9; color: #666; padding: 5px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; margin-left: 5px; transition: all 0.2s; }
        .btn-detail:hover { color: var(--primary); border-color: var(--primary); }

        .info-tag { font-size: 10px; color: #999; display: block; margin-top: 3px; }
        .total-use { color: #8c8c8c; font-weight: bold; }

        /* åº•éƒ¨æ“ä½œæ  - æ‚¬æµ®å¡ç‰‡å¼è®¾è®¡ */
        .footer-bar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: calc(100% - 32px); max-width: 568px; 
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            color: #333; padding: 16px; 
            display: flex; flex-direction: column; gap: 16px; 
            box-sizing: border-box; z-index: 200; 
            border-radius: 32px; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .footer-top { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 4px; }
        .footer-info { font-size: 16px; display: flex; align-items: center; gap: 12px; font-weight: 600; color: #1f2937; }
        
        .footer-btn-cancel {
            background: #f3f4f6; border: none; color: #6b7280;
            padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: background 0.2s; font-weight: 500;
        }
        .footer-btn-cancel:hover { background: #e5e7eb; color: #374151; }

        .footer-actions { display: flex; gap: 12px; width: 100%; }

        .footer-btn-tool {
            flex: 1;
            background: #f9fafb; border: 1px solid #e5e7eb;
            color: #374151; padding: 12px; border-radius: 16px;
            font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s; font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .footer-btn-tool:active { transform: scale(0.98); background: #eff6ff; border-color: #bfdbfe; color: #2563eb; }

        .btn-go { 
            background: linear-gradient(135deg, #52c41a, #389e0d); color: white; border: none; 
            padding: 8px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(82, 196, 26, 0.3); transition: transform 0.1s; font-size: 14px;
        }
        .btn-go:active { transform: scale(0.96); }

        /* å¼¹çª—æ ·å¼å‡çº§ */
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index:1000; transition: opacity 0.3s; }
        .modal { 
            display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
            background:white; padding:24px; border-radius:24px; 
            width: 85%; max-width: 360px; max-height: 70vh; overflow-y: auto; 
            z-index:1010; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop {
            0% { transform: translate(-50%, -40%) scale(0.95); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* ä¿®å¤è£å‰ªå’Œé¢„è§ˆçª—å£çš„åŠ¨ç”»é—®é¢˜ï¼šæ”¹ä¸ºæ·¡å…¥æ•ˆæœï¼Œé¿å…ä»å·¦ä¸Šè§’å¼¹å‡ºçš„çªå…€æ„Ÿ */
        #cropEditModal, #cropPreviewModal {
            animation: fullScreenFadeIn 0.25s ease-out !important;
        }
        @keyframes fullScreenFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal h3 { margin: 0 0 8px 0; text-align: center; font-size: 18px; color: #1f2937; }
        .modal-desc { text-align: center; color: #6b7280; font-size: 13px; margin-bottom: 24px; }
        
        .input-group { position: relative; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; }
        .input-group input {
            width: 100%; padding: 16px; 
            border: 2px solid transparent; 
            background: #f3f4f6;
            border-radius: 16px; 
            font-size: 28px; text-align: center; font-weight: 700; color: #111827; 
            outline: none; transition: all 0.2s;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }
        .input-group input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1); }
        .input-suffix { position: absolute; right: 20px; color: #9ca3af; font-weight: 600; font-size: 16px; pointer-events: none; }

        .modal-btn-group { display: flex; flex-direction: column; gap: 12px; }
        .m-btn { 
            width: 100%; padding: 14px; border: none; border-radius: 14px; 
            font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.1s;
        }
        .m-btn:active { transform: scale(0.98); }
        .m-btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(74, 144, 226, 0.3); }
        .m-btn-ghost { background: #f3f4f6; color: #4b5563; }
        
        .modal-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f3f4f6; }
        .modal-row:last-child { border-bottom: none; }
        .modal-input { width: 70px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; background: #f9fafb; font-weight: 600; }
        

        /* è®¡åˆ’é€‰æ‹©æ¨¡å¼æ ·å¼ */
        .plan-checkbox {
            position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px;
            border: 2px solid #ddd; border-radius: 50%;
            background: white;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }
        .plan-checkbox.checked {
            background: var(--primary); border-color: var(--primary);
        }
        .plan-checkbox.checked::after {
            content: 'âœ“'; color: white; font-size: 14px; font-weight: bold;
        }

        .selection-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: calc(100% - 32px); max-width: 568px;
            background: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 200;
            animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }
        @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ– */
        @media (max-width: 480px) {
            .container { padding-bottom: 80px; }
            .bead-row { padding: 8px 5px; }
            
            .col-select { width: 18px; }
            .col-color { width: 26px; padding-left: 6px; box-sizing: content-box; }
            .swatch { width: 20px; height: 20px; }
            .col-id { width: 38px; font-size: 12px; }
            .col-action { width: 42px; }
            
            .weight-badge { font-size: 12px; padding: 2px 6px; }
            .btn-plus { padding: 4px 4px; font-size: 10px; }
            /* æ¢å¤å·¦å¯¹é½ç¼©æ”¾ï¼Œå¹¶ç»™ä¸€ä¸ªå›ºå®šçš„å·¦è¾¹è·ï¼Œé¢„ç•™å‡ºå¤§æ¦‚1000gæ•°å­—çš„ç©ºé—´ */
            .btn-detail { padding: 0 4px; height: 18px; line-height: 16px; font-size: 12px; border-radius: 4px; margin-left: 2px; transform: scale(0.85); transform-origin: left center; white-space: nowrap; }
            
            /* åœ¨å°å±å¹•ä¸Šå‡å°é—´è· */
            .weight-primary-row { gap: 6px !important; }
            .weight-detail-row { gap: 4px !important; }
            .grain-info { display: none !important; } /* æå°å±å¹•éšè—ç²’æ•°ä¼°ç®—ï¼Œæˆ–ç¼©å° */
            
            /* å¤´éƒ¨ç§»åŠ¨ç«¯é€‚é… */
            .header-sticky { padding: 8px 10px; }
            /* è°ƒæ•´åˆ—å®½æ¯”ä¾‹ï¼Œç»™ç¬¬ä¸€åˆ—ï¼ˆè‰²å·ï¼‰æ›´å¤šç©ºé—´ */
            .stats { padding: 8px; gap: 5px !important; margin-right: 5px; grid-template-columns: 1.3fr 0.9fr 0.9fr !important; }
            .top-bar { margin-bottom: 5px; flex-wrap: wrap; row-gap: 8px; }
            .btn-text { font-size: 11px; }
            /* è°ƒæ•´ä¸‹æ‹‰æ¡†åœ¨ç§»åŠ¨ç«¯çš„å¤§å° */
            #seriesFilter { font-size: 13px !important; max-width: 100% !important; }
            
            /* å¯¼èˆªæ ç§»åŠ¨ç«¯é€‚é… */
            .nav-bar { overflow: visible !important; padding: 6px 4px !important; justify-content: flex-end !important; gap: 10px !important; }
            .nav-btn { padding: 4px 8px !important; font-size: 12px !important; white-space: nowrap; flex-shrink: 0; }
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .nav-bar { 
            display: flex; justify-content: flex-end; gap: 10px; align-items: center; 
            padding: 6px 10px; 
            margin-top: 5px;
            margin-bottom: 8px;
            background: #f8f9fa; 
            border-radius: 8px; 
        }

        /* ç³»åˆ—ç­›é€‰æ ·å¼ */
        .series-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
            padding: 0 2px;
        }
        .series-chip {
            padding: 4px 10px;
            border-radius: 12px;
            background: #f5f5f5;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
            font-weight: 500;
            transition: all 0.2s;
        }
        .series-chip:active {
            transform: scale(0.95);
        }
        .series-chip.selected {
            background: #e6f7ff;
            color: #1890ff;
            border-color: #91d5ff;
            font-weight: bold;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 140px;
            z-index: 1000;
            border: 1px solid #eee;
        }
        .dropdown-item {
            padding: 10px 16px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .dropdown-item:hover {
            background: #f5f7fa;
            color: var(--primary);
        }

        .nav-btn {
            display: flex; align-items: center; gap: 4px;
            background: transparent; border: 1px solid transparent; 
            cursor: pointer; padding: 4px 8px; border-radius: 15px;
            font-size: 12px; color: #666; transition: all 0.2s;
            white-space: nowrap; /* ç¡®ä¿æ–‡å­—ä¸æ¢è¡Œ */
        }
        .nav-btn:hover { background: #f0f7ff; border-color: #d6e4ff; color: #4a90e2; }

        /* ç»Ÿä¸€è¿”å›æŒ‰é’®æ ·å¼ */
        .btn-back {
            border: none;
            background: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: #555;
            flex-shrink: 0;
            padding: 0;
        }
        .btn-back:hover {
            background: #f8f9fa;
            transform: translateX(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            color: #333;
        }
        .btn-back:active {
            transform: scale(0.95);
        }

        /* ä¸­ç­‰å±å¹•æ˜¾ç¤ºç²’æ•° */
        @media (min-width: 360px) and (max-width: 480px) {
            .grain-info { display: inline !important; font-size: 9px !important; }
        }

        /* åº•éƒ¨å¯¼èˆªæ  Bottom Dock */
        .bottom-dock {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
            z-index: 190;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            flex: 1;
            color: #999;
            transition: all 0.2s;
        }
        
        .dock-item.active {
            color: var(--primary);
        }
        
        .dock-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.2s;
            margin-bottom: 2px;
        }
        .dock-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }
        .dock-item:active .dock-icon {
            transform: scale(0.9);
        }
        .dock-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* åº•éƒ¨èœå• Bottom Sheet */
        .bottom-sheet {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .bottom-sheet.show {
            display: block;
            opacity: 1;
        }
        .sheet-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            box-sizing: border-box;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-sheet.show .sheet-content {
            transform: translateY(0);
        }
        .sheet-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; font-weight: bold; font-size: 16px; color: #333;
        }
        .close-sheet {
            font-size: 24px; color: #999; cursor: pointer; padding: 5px;
        }
        .sheet-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
        }
        .sheet-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .sheet-icon-box {
            width: 48px; height: 48px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            transition: transform 0.1s;
        }
        .sheet-item:active .sheet-icon-box {
            transform: scale(0.95);
        }
        .sheet-item span { font-size: 12px; color: #666; }

        /* Card Layout */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
            gap: 12px;
            padding: 10px;
        }

        .bead-card {
            background: white;
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            transition: all 0.2s;
            overflow: hidden;
        }

        .bead-card.selected {
            border-color: var(--primary);
            background: #f0f7ff;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-swatch {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .card-check {
            width: 20px; height: 20px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: none; /* Default hidden */
            align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        
        /* Show check in selection mode or when selected - DISABLED per user request */
        .grid-container.selection-mode .card-check,
        .bead-card.selected .card-check {
            display: none;
        }
        
        .bead-card.selected .card-check {
            background: var(--primary);
            border-color: var(--primary);
        }
        .bead-card.selected .card-check::after {
            content: 'âœ“'; color: white; font-size: 12px; font-weight: bold;
        }

        .card-id {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            font-family: monospace;
            letter-spacing: 0.5px;
        }

        /* New Color Block Style */
        .card-color-block {
            width: 100%;
            height: 50px;
            border-radius: 4px;
            margin: 3px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .card-body {
            /* Legacy support or cleanup */
            display: none; 
        }

        .card-weight {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            line-height: 1.2;
        }

        .card-unit {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 500;
        }
        
        .weight-badge.low { color: #ff4d4f; }

        .card-grain {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
        }

        .card-stats {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 10px;
            color: #9ca3af;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-card-action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .btn-add {
            background: #e6f7ff;
            color: #0099ff;
        }
        .btn-add:active { background: #bae7ff; transform: scale(0.95); }

        .btn-info {
            background: #f3f4f6;
            color: #6b7280;
        }
        .btn-info:active { background: #e5e7eb; transform: scale(0.95); }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                padding: 10px 6px;
            }
            
            .bead-card {
                padding: 6px;
                border-radius: 8px;
            }
            
            .card-weight { font-size: 15px; margin-bottom: 0; }
            .card-swatch { width: 20px; height: 20px; border-radius: 6px; }
            .card-id { font-size: 12px; }
            .card-body { padding: 4px 0; }
            .btn-card-action { width: 22px; height: 22px; font-size: 12px; border-radius: 6px; }
            .card-grain { font-size: 9px; margin-top: 1px; }
            
            /* Compact Footer */
            .card-footer {
                flex-direction: column;
                gap: 4px;
                padding-top: 4px;
            }
            
            .card-stats {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                font-size: 9px;
                background: #f5f5f5;
                padding: 2px 4px;
                border-radius: 4px;
                box-sizing: border-box;
            }
            
            .card-actions {
                width: 100%;
                justify-content: space-between;
                gap: 4px;
            }
            
            .card-actions button {
                flex: 1;
                height: 24px;
            }
        }

        /* Stats Page New Styles */
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .stats-title {
            font-size: 20px;
            font-weight: 800;
            color: #1a1a1a;
            margin: 20px 0 20px 0;
        }
        .stats-dropdown {
            background: #f0f2f5;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            color: #666;
            outline: none;
            font-weight: 500;
        }

        .stats-tabs {
            display: flex;
            background: #e9ecef;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        .stats-tab {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            font-size: 14px;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .stats-tab.active {
            background: white;
            color: #333;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stats-summary-card {
            background: white;
            border-radius: 20px;
            padding: 25px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
        }
        .donut-chart-wrapper {
            width: 140px;
            height: 140px;
            position: relative;
            margin-bottom: 25px;
        }
        .donut-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 0%, #f0f0f0 0% 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .donut-chart::after {
            content: "";
            position: absolute;
            width: 116px;
            height: 116px;
            background: white;
            border-radius: 50%;
        }
        .donut-label {
            position: absolute;
            z-index: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
        }
        .donut-percent {
            font-size: 28px;
            font-weight: 800;
            color: #333;
            line-height: 1.2;
        }
        .donut-text {
            font-size: 12px;
            color: #999;
        }

        .stats-metrics {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        .metric-item {
            text-align: center;
        }
        .metric-val {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .metric-label {
            font-size: 12px;
            color: #999;
        }

        .stats-filter-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .switch-label {
            font-size: 15px;
            font-weight: 500;
            color: #333;
        }
        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e0e0e0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input:checked + .slider { background-color: #4a90e2; }
        input:checked + .slider:before { transform: translateX(20px); }

        .stats-rank-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 20px;
        }
        .rank-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 12px 15px;
            border-radius: 12px;
        }
        .rank-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .rank-badge.top-1 { background: #ffc107; }
        .rank-badge.top-2 { background: #9e9e9e; }
        .rank-badge.top-3 { background: #cd7f32; }

        .rank-swatch {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            margin-right: 12px;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .rank-content {
            flex: 1;
        }
        .rank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .rank-id {
            font-weight: bold;
            font-size: 15px;
            color: #333;
        }
        .rank-details {
            font-size: 11px;
            color: #999;
        }
        .rank-details span.used { color: #999; }
        .rank-details span.rem { color: #52c41a; margin-left: 4px; }
        .rank-details span.rem.zero { color: #ff4d4f; }

        .rank-progress-bg {
            height: 4px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        .rank-progress-fill {
            height: 100%;
            background: #fa8c16;
            border-radius: 2px;
        }
    </style>
    <script>
        // Pre-check default page to avoid flashing
        try {
            var defaultBeads = localStorage.getItem('default_page_beads');
            if (defaultBeads === 'true') {
                document.write('<style id="init-style">#page-home { display: none !important; } #page-beads { display: block !important; }</style>');
            }
        } catch(e) {}
    </script>

</head>
<body>

<div id="page-home" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
    <h1 style="color:#333; margin-bottom:40px; font-size:24px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Mardæ‹¼è±†å·¥å…·ç®±</h1>
    <div style="display:flex; flex-direction:column; gap:20px; width:80%; max-width:300px;">
        <button onclick="navTo('beads')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#4a90e2; box-shadow:0 10px 20px rgba(74, 144, 226, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">ğŸ¨</span> æ‹¼è±†åº“å­˜ç®¡ç†
        </button>
        <button onclick="navTo('fabric')" style="padding:20px; font-size:18px; border:none; border-radius:16px; background:white; color:#eb2f96; box-shadow:0 10px 20px rgba(235, 47, 150, 0.2); cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s;">
            <span style="font-size:24px;">âœ‚ï¸</span> çƒ˜ç„™å¸ƒè£å‰ª
        </button>
        <div style="margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <input type="checkbox" id="defaultBeadsToggle" onchange="toggleDefaultPage()" style="transform: scale(1.2); cursor: pointer;">
            <label for="defaultBeadsToggle" style="color: #666; font-size: 14px; cursor: pointer;">ä¸‹æ¬¡é»˜è®¤è¿›å…¥æ‹¼è±†åº“å­˜</label>
        </div>

    </div>
    <div onclick="showDevInfo()" style="margin-top: 40px; color: #666; font-size: 12px; cursor: pointer; text-decoration: underline;">å¼€å‘è€…ä¿¡æ¯</div>
</div>

<div id="page-beads" style="display:none; padding-bottom: 80px;">
    <div class="container">
        <h3 style="font-size: 20px; font-weight: bold; margin: 0 0 20px 0; padding-top: 40px; text-align: center; color: #333;">åº“å­˜</h3>
        <div class="header-sticky">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px; margin-top: 6px;">
            <input type="text" id="search" placeholder="è¾“å…¥è‰²å·æœç´¢..." oninput="render()" style="flex:1; margin-bottom:0;">
            <button id="btn-toggle-filter" onclick="toggleFilterVisibility()" style="
                border: 1px solid #ddd;
                background: #fff;
                color: #666;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 42px; /* Match input height roughly */
            ">
                ğŸ¨
            </button>

        </div>
        
        <div id="series-filter-container" class="series-filter-container" style="display:none;">
            <div class="series-chip" onclick="toggleSeries('A')">A</div>
            <div class="series-chip" onclick="toggleSeries('B')">B</div>
            <div class="series-chip" onclick="toggleSeries('C')">C</div>
            <div class="series-chip" onclick="toggleSeries('D')">D</div>
            <div class="series-chip" onclick="toggleSeries('E')">E</div>
            <div class="series-chip" onclick="toggleSeries('F')">F</div>
            <div class="series-chip" onclick="toggleSeries('G')">G</div>
            <div class="series-chip" onclick="toggleSeries('H')">H</div>
            <div class="series-chip" onclick="toggleSeries('M')">M</div>
            <div class="series-chip" onclick="toggleSeries('P')">P</div>
            <div class="series-chip" onclick="toggleSeries('Q')">Q</div>
            <div class="series-chip" onclick="toggleSeries('R')">R</div>
            <div class="series-chip" onclick="toggleSeries('T')">T</div>
            <div class="series-chip" onclick="toggleSeries('Y')">Y</div>
            <div class="series-chip" onclick="toggleSeries('ZG')">ZG</div>
        </div>
        

    </div>

    <style>
        .sort-btn {
            flex: 1;
            border: 1px solid #f0f0f0;
            background: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            white-space: nowrap;
        }
        .sort-btn.active {
            background: #e6f7ff;
            color: #1890ff;
            border-color: #91d5ff;
            font-weight: bold;
        }
    </style>

    <!-- Summary & Sort Bar -->
    <div id="bead-summary-bar" style="padding: 0 5px 10px 5px; display: none;">
        <!-- Sort Controls & Filter -->
        <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 2px; align-items: center;">
             <!-- Filter Dropdown -->
             <div style="position: relative; min-width: 90px; text-align: center;">
                 <select id="seriesFilter" onchange="render()" style="width: 100%; font-size: 13px; font-weight: 700; color: #333; border: 1px solid #eee; border-radius: 6px; background: #fff; outline: none; padding: 6px 20px 6px 12px; appearance: none; text-align: center; cursor: pointer; text-align-last: center; height: 32px;">
                        <option value="221">Mard 221</option>
                        <option value="all">å…¨ç³»åˆ—</option>
                 </select>
                 <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #ccc; pointer-events: none;">â–¼</div>
             </div>

            <button id="btn-sort-id" onclick="setBeadSort('id')" class="sort-btn active" data-sort="id">
                è‰²å· <span class="sort-arrow">â†“</span>
            </button>
            <button id="btn-sort-stock" onclick="setBeadSort('stock')" class="sort-btn" data-sort="stock">
                åº“å­˜ <span class="sort-arrow"></span>
            </button>
            <button id="btn-sort-used" onclick="setBeadSort('used')" class="sort-btn" data-sort="used">
                å·²ç”¨ <span class="sort-arrow"></span>
            </button>
        </div>
    </div>

    <div id="grid" class="grid-container"></div>
    <div style="text-align:center; padding:10px; color:#999; font-size:10px;">
        å¼€å‘è€…: å°çº¢ä¹¦ç”¨æˆ·ÄÅÄ“ï¼ŒID 11535779483ï¼Œä½¿ç”¨AIå·¥å…·å¼€å‘
    </div>
</div>



    <div id="footer" class="footer-bar" style="display:none;">
        <div class="footer-top">
            <div class="footer-info">
                <span>å·²é€‰ <b id="selNum" style="color:#ffd700; font-size:18px;">0</b> è‰²</span>
                <button onclick="cancelSelection()" class="footer-btn-cancel">å–æ¶ˆ</button>
            </div>
            <button class="btn-go" onclick="openConsumeModal()">å½•å…¥ç²’æ•°</button>
        </div>
        <div class="footer-actions">
             <button onclick="batchSetMonitor(true)" class="footer-btn-tool">
                <span>ğŸ””</span> å¼€å¯é˜ˆå€¼
             </button>
             <button onclick="batchSetMonitor(false)" class="footer-btn-tool">
                <span>ğŸ”•</span> å…³é—­é˜ˆå€¼
             </button>
        </div>
    </div>

</div> <!-- End page-beads -->

    <div id="footer-dock" class="bottom-dock">
        <div class="dock-item active" onclick="navToDock('inventory')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
            </span>
            <span class="dock-label">åº“å­˜</span>
        </div>
        <div class="dock-item" onclick="navToDock('scan')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM5 19h4v2H5c-1.1 0-2-.9-2-2v-4h2v4z"/><rect x="7" y="9" width="10" height="6" rx="1"/></svg>
            </span>
            <span class="dock-label">æ‰«æ</span>
        </div>
        <div class="dock-item" onclick="navToDock('plan')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/><path d="M12 17h-2v-2h2v2zm0-4h-2V9h2v4zm0-6h-2V3h2v4z"/></svg>
            </span>
            <span class="dock-label">è®¡åˆ’</span>
        </div>
        <div class="dock-item" onclick="navToDock('stats')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M4 19h4v-7H4v7zm6 0h4V5h-4v14zm6 0h4v-10h-4v10z"/></svg>
            </span>
            <span class="dock-label">ç»Ÿè®¡</span>
        </div>
        <div class="dock-item" onclick="navToDock('more')">
            <span class="dock-icon">
                <svg viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </span>
            <span class="dock-label">æ›´å¤š</span>
        </div>
    </div>

    <div id="page-more" style="display:none; padding-bottom: 80px; background: #f7f8fa; min-height: 100vh;">
        <div class="container" style="padding: 20px;">
            <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #333;">æ›´å¤š</h3>
            
            <div style="background: white; border-radius: 16px; padding: 0 20px; margin-bottom: 20px;">
                 <!-- Threshold -->
                <div onclick="openThresholdModal()" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #fff2e8; color: #fa541c; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ğŸ“</div>
                    <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">é˜ˆå€¼ç®¡ç†</div>
                         <div style="font-size: 12px; color: #999;">è®¾ç½®ä½åº“å­˜é¢„è­¦é˜ˆå€¼</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>
                 
                 <!-- Ignored List -->
                 <div onclick="openIgnoredModal()" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #fff0f6; color: #eb2f96; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ğŸš«</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">å¿½ç•¥æ¸…å•</div>
                         <div style="font-size: 12px; color: #999;">ç®¡ç†å·²å¿½ç•¥çš„è‰²å·</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>

                 <!-- Data Import/Export -->
                 <div onclick="openDataModal('backup')" style="display: flex; align-items: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #f9f0ff; color: #722ed1; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">âš™ï¸</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">æ•°æ®å¯¼å…¥å¯¼å‡º</div>
                         <div style="font-size: 12px; color: #999;">å¤‡ä»½ä¸æ¢å¤æ•°æ®</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>

                 <!-- AI Usage -->
                 <div onclick="openAIUsageModal()" style="display: flex; align-items: center; padding: 20px 0; cursor: pointer;">
                     <div style="width: 40px; height: 40px; border-radius: 50%; background: #f0f5ff; color: #2f54eb; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 20px;">ğŸ¤–</div>
                     <div style="flex: 1;">
                         <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">AI ä½¿ç”¨ç»Ÿè®¡</div>
                         <div style="font-size: 12px; color: #999;">æŸ¥çœ‹ä¸ç®¡ç† AI æ¨¡å‹é¢åº¦</div>
                     </div>
                     <div style="color: #ccc;">â€º</div>
                 </div>
            </div>
        </div>
    </div>



<div id="page-stats" style="display:none; padding-bottom: 80px;">
    <div class="container" style="padding: 15px;">
        <div class="stats-header">
            <h2 class="stats-title">ç»Ÿè®¡</h2>
            <select id="statsSeriesFilter" class="stats-dropdown" onchange="syncAndRenderStats()">
                <option value="221">Mard 221</option>
                <option value="all">Mard å…¨ç³»åˆ—</option>
            </select>
        </div>



        <div id="stats-usage-view">
            <div class="stats-summary-card">
                <div class="donut-chart-wrapper">
                    <div id="stats-donut" class="donut-chart">
                        <div class="donut-label">
                            <span id="stats-donut-percent" class="donut-percent">0%</span>
                            <span class="donut-text">æŒä»“ç‡</span>
                        </div>
                    </div>
                </div>
                <div class="stats-metrics">
                    <div class="metric-item">
                        <div id="stats-total-stock" class="metric-val">0g</div>
                        <div class="metric-label">æ€»åº“å­˜</div>
                    </div>
                    <div class="metric-item">
                        <div id="stats-total-used" class="metric-val">0g</div>
                        <div class="metric-label">æ€»æ¶ˆè€—</div>
                    </div>
                    <div class="metric-item">
                        <div id="stats-low-count" class="metric-val" style="color: #ff4d4f;">0</div>
                        <div class="metric-label">ç¼ºè´§</div>
                    </div>
                </div>
            </div>

            <div class="stats-filter-row">
                <span class="switch-label">ä»…æ˜¾ç¤ºä½åº“å­˜</span>
                <label class="switch">
                    <input type="checkbox" id="stats-low-filter" onchange="renderStats()">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="stats-rank-list" class="stats-rank-list">
                <!-- Rank items will be injected here -->
            </div>
        </div>
        
        <div id="stats-records-view" style="display:none; text-align:center; padding: 40px; color: #999;">
            ğŸš§ æ–½å·¥ä¸­...
        </div>
    </div>
</div>

<div id="page-plan" style="display:none; padding-bottom: 80px;">
    <div class="container" style="padding: 20px;">
        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">æ‹¼è±†è®¡åˆ’</h3>
        
        <div style="display: flex; background: #f0f2f5; padding: 4px; border-radius: 8px; margin-bottom: 15px;">
            <div id="filter-active" onclick="setPlanFilter('active')" style="flex: 1; text-align: center; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; background: white; color: #4a90e2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;">è®¡åˆ’ä¸­</div>
            <div id="filter-completed" onclick="setPlanFilter('completed')" style="flex: 1; text-align: center; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; color: #999; transition: all 0.2s;">å·²å®Œæˆ</div>
        </div>

        <div id="planList" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Plan Items will be rendered here -->
            <div style="text-align: center; color: #999; padding: 40px;">
                æš‚æ— è®¡åˆ’<br>è¯·å‰å¾€æ‰«æé¡µé¢åˆ›å»º
            </div>
        </div>
    </div>
</div>

<div id="page-plan-detail" style="display:none; padding-bottom: 80px; background: #f7f8fa; min-height: 100vh;">
    <!-- Detail Header -->
    <div style="background: white; padding: 20px 20px 10px 20px; border-bottom: 1px solid #f0f0f0; position: sticky; top: 0; z-index: 10;">
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
             <button onclick="closePlanDetail()" style="background:none; border:none; font-size: 20px; color: #333; padding: 0 10px 0 0;">â†</button>
             <div style="flex: 1; text-align: center; padding-right: 30px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span id="planDetailTitle" style="font-size: 18px; font-weight: bold;">è®¡åˆ’è¯¦æƒ…</span>
                <span onclick="renameCurrentPlan()" style="cursor: pointer; font-size: 14px; opacity: 0.6;">âœï¸</span>
             </div>
        </div>
        
        <!-- Status Banner -->
        <div id="planDetailStatus" style="background: #fffbe6; color: #fa8c16; padding: 15px; border-radius: 8px; font-size: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; text-align: center;">
             <span>ğŸ“…</span> è®¡åˆ’ä¸­ - å°šæœªæ‰£å‡åº“å­˜
        </div>

        <!-- Key Stats -->
        <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
             <div style="text-align: center;">
                 <div id="planDetailColorCount" style="font-size: 24px; font-weight: bold; color: #722ed1;">0</div>
                 <div style="font-size: 13px; color: #999;">é¢œè‰²æ•°</div>
             </div>
             <div style="text-align: center;">
                 <div id="planDetailBeadCount" style="font-size: 24px; font-weight: bold; color: #fa8c16;">0</div>
                 <div style="font-size: 13px; color: #999;">æ€»ç²’æ•°</div>
             </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div id="planDetailActions" style="padding: 15px 20px; background: white; margin-bottom: 10px; display: flex; gap: 10px;">
         <button class="m-btn m-btn-primary" onclick="checkPlanStock()" style="flex: 1; background: #1890ff; border-color: #1890ff; display: flex; align-items: center; justify-content: center; gap: 5px;">
             ğŸ” åº“å­˜ç¡®è®¤
         </button>
         <button class="m-btn m-btn-primary" onclick="executePlanDeduction()" style="flex: 1; background: #52c41a; border-color: #52c41a; display: flex; align-items: center; justify-content: center; gap: 5px;">
             â–¶ æ‰§è¡Œæ‰£å‡
         </button>
    </div>

    <!-- Color List Header -->
    <div style="padding: 0 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
             <h4 style="margin: 0; font-size: 14px; color: #666;">é¢œè‰²ç”¨é‡</h4>
             <span id="planDetailSortBtn" onclick="togglePlanDetailSort()" style="font-size: 12px; color: #1890ff; cursor: pointer; background: #e6f7ff; padding: 2px 8px; border-radius: 4px;">æŒ‰ç”¨é‡ â†“</span>
        </div>
        <div id="planDetailList" style="display: flex; flex-direction: column; gap: 10px;">
             <!-- Items -->
        </div>
    </div>
</div>

<div id="page-scan" style="display:none; padding-bottom: 80px;">
    <div class="container" style="padding: 20px;">
        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">å›¾çº¸æ‰«æåˆ†æ</h3>
        
        <div id="scan-uploader" class="scan-uploader" style="border: 2px dashed #4a90e2; border-radius: 12px; padding: 10px; text-align: center; background: #f0f5ff; margin-bottom: 20px; transition: all 0.2s; overflow: hidden;">
            <div id="scanPreview" onclick="document.getElementById('scanInput').click()" style="padding: 20px; cursor: pointer; color: #4a90e2;">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“·</div>
                <div style="font-weight: bold; font-size: 16px;">ç‚¹å‡»ä¸Šä¼ å›¾çº¸è‰²å·åŒºåŸŸ</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">æ”¯æŒæ‰‹æœºæ‹ç…§æˆ–ä»ç›¸å†Œé€‰æ‹©</div>
            </div>
            
            <div id="cropContainer" style="display:none; height: 400px; background: #333; position: relative;">
                <img id="scanPreviewImg" style="max-width: 100%; max-height: 100%; display: block;">
            </div>
            
            <div id="scanProcessPreviews" style="display:none; padding: 10px;">
                <div style="font-size: 12px; color: #999; margin-bottom: 10px;">æ‰«æåˆ†æä¸­...</div>
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                     <div style="flex: 1; text-align: center; max-width: 45%;">
                         <div style="font-size: 10px; color: #ccc; margin-bottom: 5px;">åŸå›¾</div>
                         <img id="scanProcessOriginal" style="max-width: 100%; max-height: 150px; border-radius: 4px; border: 1px solid #eee; display:inline-block;">
                     </div>
                     <div style="color: #ccc; font-size: 20px;">âœ</div>
                     <div style="flex: 1; text-align: center; max-width: 45%;">
                         <div style="font-size: 10px; color: #ccc; margin-bottom: 5px;">è¯†åˆ«åŒºåŸŸ</div>
                         <img id="scanProcessCropped" style="max-width: 100%; max-height: 150px; border-radius: 4px; border: 1px solid #eee; display:inline-block;">
                     </div>
                </div>
            </div>

            <input type="file" id="scanInput" accept="image/*" style="display:none" onchange="handleScanImage(this)">
        </div>

        <div id="cropControls" style="display:none; gap: 10px; margin-bottom: 20px;">
             <button class="m-btn m-btn-ghost" onclick="resetScan()" style="flex: 1;">é‡æ–°ä¸Šä¼ </button>
             <button class="m-btn m-btn-primary" onclick="openCropEditor()" style="flex: 2;">å¼€å§‹è£åˆ‡</button>
        </div>

        <div id="scanLoading" style="display:none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p id="scanStatusText" style="margin-top: 15px; color: #666; font-size: 14px;">æ­£åœ¨è¯†åˆ«è‰²å·æ•°æ®...</p>
            <p style="font-size: 12px; color: #999; margin-bottom: 15px;">(åˆæ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)</p>
            <button class="m-btn m-btn-ghost" onclick="cancelScan()" style="width: auto; padding: 8px 20px; font-size: 13px; border: 1px solid #ddd;">å–æ¶ˆæ‰«æ</button>
        </div>

        <div id="scanResult" style="display:none; padding-top: 10px;">
            <!-- 1. Original Full Image (Collapsed/Small Preview) -->
            <div style="margin-bottom: 15px;">
                 <div style="font-size: 13px; color: #999; margin-bottom: 5px;">åŸå§‹å›¾çº¸</div>
                 <div style="background: #f0f0f0; border-radius: 8px; overflow: hidden; max-height: 100px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc;">
                      <img id="scanResultFullImage" style="max-width: 100%; max-height: 100px; display: block; opacity: 0.8;" onclick="this.style.maxHeight = this.style.maxHeight === '100px' ? 'none' : '100px'; this.parentElement.style.maxHeight = this.parentElement.style.maxHeight === '100px' ? 'none' : '100px';">
                 </div>
                 <div style="text-align: center; font-size: 10px; color: #ccc; margin-top: 2px;">(ç‚¹å‡»å±•å¼€/æ”¶èµ·)</div>
            </div>

            <!-- 2. Cropped Image Preview -->
            <div style="margin-bottom: 5px; font-size: 13px; color: #999;">è¯†åˆ«åŒºåŸŸ</div>
            <div style="background: #333; border-radius: 12px; overflow: hidden; margin-bottom: 15px; text-align: center; max-height: 200px; display: flex; align-items: center; justify-content: center;">
                 <img id="scanResultImage" style="max-width: 100%; max-height: 200px; display: block;">
            </div>

            <!-- 3. Action Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <button class="m-btn m-btn-ghost" onclick="reCropImage()" style="flex: 1; border: 1px solid #eee; color: #666; font-size: 13px; border-radius: 20px;">
                    âœ‚ï¸ è°ƒæ•´è£åˆ‡
                </button>
                <button class="m-btn m-btn-ghost" onclick="resetScan()" style="flex: 1; border: 1px solid #eee; color: #666; font-size: 13px; border-radius: 20px;">
                    ğŸ”„ é‡æ–°é€‰æ‹©
                </button>
            </div>

            <!-- 4. Result Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 2px; white-space: nowrap;">
                <div style="display:flex; align-items:center; gap:5px; flex-shrink: 1; overflow: hidden;">
                    <h4 style="margin: 0; font-size: 12px; font-weight: bold; color: #333;">è¯†åˆ«ç»“æœ</h4>
                    <span id="scanTotalCount" style="font-size: 12px; color: #999;">...</span>
                </div>
                <div style="display: flex; gap: 4px; flex-shrink: 0;">
                     <button onclick="toggleScanMissingPriority()" id="btn-scan-missing" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">ç¼ºè´§</button>
                     <button onclick="toggleScanSort('code')" id="btn-sort-code" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">è‰²å·</button>
                     <button onclick="toggleScanSort('qty')" id="btn-sort-qty" style="font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">ç”¨é‡</button>
                </div>
            </div>
            
            <!-- 5. Status / Loading Bar -->
            <div id="scanInlineStatus" style="display:none; background: #e6f7ff; border: 1px solid #91d5ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #0050b3; display: flex; align-items: center; gap: 8px;">
                 <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                 <span id="scanInlineStatusText">æ­£åœ¨è¯†åˆ«ä¸­...</span>
            </div>

            <!-- 6. List Container -->
            <div id="scanList" style="display: flex; flex-direction: column; gap: 12px; min-height: 100px;"></div>
            
            <!-- 7. Plan Actions -->
            <div id="planActions" style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #eee;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">å›¾çº¸å‘½å (å¯é€‰)</label>
                    <input type="text" id="planNameInput" placeholder="è¾“å…¥å›¾çº¸åç§°ï¼Œå¦‚: åº“æ´›ç±³" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="m-btn m-btn-primary" onclick="createPlan()" style="flex: 1; background: #722ed1; border-color: #722ed1;">
                        ğŸ“… åˆ›å»ºè®¡åˆ’
                    </button>
                    <button class="m-btn m-btn-primary" onclick="deductInventory()" style="flex: 1; background: #ff4d4f; border-color: #ff4d4f;">
                        ğŸ“‰ æ‰£å‡åº“å­˜
                    </button>
                </div>
            </div>

            <!-- 8. Bottom Tip -->
             <div style="margin-top: 30px; padding: 15px; text-align: center; color: #ccc; font-size: 12px; border-top: 1px solid #f0f0f0;">
                è¯†åˆ«ç»“æœä»…ä¾›å‚è€ƒ Â· è¯·æ ¸å¯¹å®ç‰©
            </div>
        </div>
    </div>
</div>
<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>


    <!-- å¼¹çª—éƒ¨åˆ† -->

<div class="overlay" id="mask" onclick="closeAllModals()"></div>
<div id="consumeModal" class="modal" style="width: 85%; max-width: 340px; padding: 20px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #333;">æ¶ˆè€—å½•å…¥ (ç²’æ•°)</h3>
    <div id="modalList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #f0f0f0; border-radius: 12px; padding: 5px;"></div>
    <div class="modal-btn-group" style="gap: 10px;">
        <button class="m-btn m-btn-primary" onclick="submitConsume()" style="padding: 10px; font-size: 14px; border-radius: 10px;">ç¡®è®¤æ‰£é™¤</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 10px; font-size: 14px; border-radius: 10px;">å–æ¶ˆ</button>
    </div>
</div>

<div id="thresholdModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 style="font-size: 18px; color: #333; margin-bottom: 10px; text-align: center;">è®¾ç½®é¢„è­¦é˜ˆå€¼</h3>
    <div style="font-size: 13px; color: #999; margin-bottom: 25px; text-align: center;">å½“åº“å­˜é‡é‡ä½äºæ­¤å€¼æ—¶ï¼Œ<br>è‰²å·å°†æ ‡è®°ä¸ºçº¢è‰²é¢„è­¦çŠ¶æ€ã€‚</div>
    
    <div class="input-group" style="margin-bottom: 25px;">
        <input type="number" id="thresholdInput" placeholder="0.00" step="0.01" 
               style="font-size: 32px; padding: 15px; border-radius: 12px; background: #f7f8fa; border: 2px solid transparent; width: 100%; box-sizing: border-box; text-align: center; color: #333; font-weight: bold; transition: all 0.2s;">
    </div>
    
    <div class="modal-btn-group" style="gap: 12px;">
        <button class="m-btn m-btn-primary" onclick="saveThreshold()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);">ä¿å­˜è®¾ç½®</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 12px; font-size: 15px; border-radius: 12px; flex: 1;">å…³é—­</button>
    </div>
</div>

<div id="editWeightModal" class="modal" style="width: 80%; max-width: 300px; padding: 25px; border-radius: 20px;">
    <h3 id="editWeightModalTitle" style="font-size: 18px; color: #333; margin-bottom: 25px;">ä¿®æ”¹åº“å­˜é‡é‡</h3>
    
    <div class="input-group" style="margin-bottom: 25px;">
        <input type="number" id="editWeightInput" placeholder="0.00" step="0.01" 
               style="font-size: 32px; padding: 15px; border-radius: 12px; background: #f7f8fa; border: 2px solid transparent; width: 100%; box-sizing: border-box; text-align: center; color: #333; font-weight: bold; transition: all 0.2s;">
        <span class="input-suffix" style="right: 30px; font-size: 16px; color: #999;">g</span>
    </div>
    
    <div class="modal-btn-group" style="gap: 12px;">
        <button class="m-btn m-btn-primary" onclick="submitEditWeight()" style="padding: 12px; font-size: 16px; border-radius: 12px; background: linear-gradient(135deg, #4a90e2, #357abd); box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);">ç¡®è®¤ä¿®æ”¹</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding: 12px; font-size: 15px; border-radius: 12px; color: #666;">å–æ¶ˆ</button>
    </div>
</div>

<div id="restockModal" class="modal">
    <h3>æ–°å¢è¡¥è´§</h3>
    <div class="modal-desc" id="restockTitle"></div>
    <div class="input-group">
        <input type="number" id="restockInput" placeholder="0" step="0.01">
        <span class="input-suffix">g</span>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitRestock()">ç¡®è®¤è¡¥è´§</button>
        <button class="m-btn m-btn-ghost" onclick="showModal('editWeightModal')">è¿”å›</button>
    </div>
</div>

<div id="historyModal" class="modal" style="width:95%; max-width:600px;">
    <h3 id="historyTitle" style="font-size:16px; font-weight:bold; margin-bottom:12px;">åº“å­˜æ˜ç»†</h3>
    
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; background:#f5f7fa; padding:10px; border-radius:10px;">
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">å½“å‰ä½™é‡</div>
            <div id="hist-stock" style="font-size:16px; font-weight:bold; color:#4a90e2;">0g</div>
        </div>
        <div style="text-align:center; border-left:1px solid #e0e0e0; border-right:1px solid #e0e0e0; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">æ€»æ¶ˆè€—</div>
            <div id="hist-used" style="font-size:16px; font-weight:bold; color:#ff4d4f;">0g</div>
        </div>
        <div style="text-align:center; flex:1;">
            <div style="font-size:11px; color:#999; margin-bottom:3px;">æ€»è¡¥å……</div>
            <div id="hist-added" style="font-size:16px; font-weight:bold; color:#52c41a;">0g</div>
        </div>
    </div>

    <div style="max-height:240px; overflow:auto; border:1px solid #eee; border-radius:10px;">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead style="background:#fafafa; position:sticky; top:0;">
                <tr>
                    <th style="padding:6px 2px; text-align:left; color:#999; font-weight:normal; border-bottom:1px solid #eee;">æ—¶é—´</th>
                    <th style="padding:6px 2px; text-align:center; color:#999; font-weight:normal; border-bottom:1px solid #eee;">å›¾çº¸åç§°</th>
                    <th style="padding:6px 2px; text-align:center; color:#999; font-weight:normal; border-bottom:1px solid #eee;">æ“ä½œ</th>
                    <th style="padding:6px 2px; text-align:right; color:#999; font-weight:normal; border-bottom:1px solid #eee;">é‡é‡/ç²’æ•°</th>
                </tr>
            </thead>
            <tbody id="historyList"></tbody>
        </table>
    </div>
    <div style="text-align:center; color:#ccc; font-size:10px; margin-top:5px;">
        æ³¨ï¼šæ€»è®¡æ•°æ®åŒ…å«å·²å½’æ¡£çš„å†å²è®°å½•ï¼Œå¯èƒ½å¤§äºä¸Šæ–¹åˆ—è¡¨æ˜¾ç¤ºçš„æœ€è¿‘20æ¡è®°å½•ä¹‹å’Œã€‚
    </div>

    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()" style="padding:8px; font-size:13px;">å…³é—­</button>
    </div>
</div>

<div id="stockCheckSheet" class="modal" style="width: 100%; max-width: 100%; bottom: 0; top: auto; border-radius: 20px 20px 0 0; padding: 0; margin: 0; left: 0; transform: none; max-height: 80vh; display: none; flex-direction: column; animation: slideUpModal 0.3s ease-out;">
    <div style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">åº“å­˜ç¡®è®¤</h3>
            <button onclick="closeAllModals()" style="background: none; border: none; font-size: 24px; color: #999;">&times;</button>
        </div>
        <div id="stockCheckSummary" style="background: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; padding: 10px; border-radius: 8px; font-size: 13px;">
            ğŸ‰ åº“å­˜å……è¶³ï¼Œå¯ä»¥å¼€å§‹åˆ¶ä½œï¼
        </div>
        
        <!-- Sort Actions -->
        <div style="display: flex; gap: 8px; margin-top: 10px;">
             <button onclick="toggleStockCheckMissingPriority()" id="btn-check-missing" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">ä¼˜å…ˆç¼ºè´§</button>
             <button onclick="toggleStockCheckSort('code')" id="btn-check-code" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">è‰²å·æ’åº</button>
             <button onclick="toggleStockCheckSort('qty')" id="btn-check-qty" style="font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px;">ç”¨é‡æ’åº</button>
        </div>
    </div>
    
    <div id="stockCheckList" style="overflow-y: auto; padding: 10px 20px; flex: 1;">
        <!-- Check Items -->
    </div>

    <div style="padding: 15px 20px; border-top: 1px solid #f0f0f0;">
        <button class="m-btn m-btn-primary" onclick="closeAllModals()" style="width: 100%; padding: 12px; font-size: 16px;">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<div id="dataModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">æ•°æ®å¤‡ä»½</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px; background:#f5f7fa; padding:4px; border-radius:10px;">
        <button id="tabBackup" class="m-btn m-btn-ghost" style="flex:1; padding:8px; font-size:13px; border-radius:8px;" onclick="switchDataTab('backup')">å¤‡ä»½å¯¼å‡º</button>
        <button id="tabRestore" class="m-btn m-btn-ghost" style="flex:1; padding:8px; font-size:13px; border-radius:8px;" onclick="switchDataTab('restore')">æ¢å¤å¯¼å…¥</button>
    </div>
    
    <div id="viewBackup">
        <div style="padding: 20px 0; text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 13px; line-height: 1.5;">
                å°†å½“å‰æ‰€æœ‰è‰²å·åº“å­˜åŠæ“ä½œè®°å½•<br>å¯¼å‡ºä¸º TXT æ–‡æœ¬æ–‡ä»¶ã€‚
            </div>
            <button class="m-btn m-btn-primary" style="width: 100%; padding: 12px; font-size: 15px; background: #52c41a; border-color: #52c41a; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="downloadBackupFile()">
                <span>ğŸ“¤</span> å¯¼å‡ºå¤‡ä»½ (TXT)
            </button>
        </div>
    </div>

    <div id="viewRestore" style="display:none;">
        <div style="padding: 20px 0; text-align: center;">
            <div style="margin-bottom: 20px; color: #666; font-size: 13px; line-height: 1.5;">
                é€‰æ‹©ä¹‹å‰å¯¼å‡ºçš„TXTå¤‡ä»½æ–‡ä»¶<br>ä»¥æ¢å¤åº“å­˜æ•°æ®ã€‚
            </div>
            <input type="file" id="restoreFile" style="display:none" accept=".txt,.csv,.json,image/*" onchange="loadBackupFile(this)">
            <button class="m-btn m-btn-primary" style="width: 100%; padding: 12px; font-size: 15px; background: #1890ff; border-color: #1890ff; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="document.getElementById('restoreFile').click()">
                <span>ğŸ“‚</span> é€‰æ‹©å¤‡ä»½æ–‡ä»¶ (TXT)
            </button>
            <textarea id="restoreInput" style="display:none;"></textarea>
            <input type="number" id="threshold" style="display:none;" value="0">
        </div>
    </div>
    
    <div class="modal-btn-group" style="margin-top:10px;">
        <button class="m-btn m-btn-ghost" style="width: 100%; padding: 12px; font-size: 15px;" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<div id="batchInputModal" class="modal" style="width:85%; max-width:340px;">
    <h3 style="font-size:16px; font-weight:bold; margin-bottom:12px;">åˆå§‹æ•°æ®æ‰¹é‡å½•å…¥</h3>
    <div class="modal-desc" style="margin-bottom:8px; text-align:left;">æ ¼å¼ï¼šè‰²å·+é‡é‡ (å¦‚ A1 50)</div>
    <textarea id="batchInputText" style="width:100%; height:150px; padding:10px; border:1px solid #eee; border-radius:10px; resize:none; font-family:monospace; font-size:13px; box-sizing:border-box; background:#fafafa; outline:none; color:#333;" placeholder="æ”¯æŒå¤šç§æ ¼å¼ï¼Œä¾‹å¦‚ï¼š&#10;A1 50&#10;B2: 20.5&#10;C3=100"></textarea>
    <div class="modal-btn-group" style="margin-top:15px;">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="submitBatchInput()">å¼€å§‹è¯†åˆ«å¹¶å¯¼å…¥</button>
        <button class="m-btn m-btn-ghost" style="padding:8px; font-size:13px;" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<div id="lowStockModal" class="modal" style="width:85%; max-width:340px; padding:20px; border-radius:24px;">
    <h3 style="font-size:18px; font-weight:bold; margin-bottom:20px; text-align:center; color:#333;">è¡¥è´§æ¸…å•</h3>
    <div id="lowStockHeader" style="margin-bottom:15px; background:#fffbe6; padding:10px; border-radius:8px; border:1px solid #ffe58f; display:flex; align-items:center; gap:8px;">
        <span style="font-size:16px;">âš ï¸</span>
        <div class="modal-desc" style="font-size:12px; color:#d48806; margin:0; text-align:left;">
            <div>ä»¥ä¸‹è‰²å·åº“å­˜ä½äºè®¾å®šé˜ˆå€¼ï¼Œå»ºè®®åŠæ—¶è¡¥è´§ã€‚</div>
            <div style="margin-top:4px; opacity:0.8; font-size:11px; color:inherit;">(å·²æ ¹æ®é¦–é¡µâ€œè‰²å·â€ä¸‹æ‹‰æ¡†ç­›é€‰æ˜¾ç¤ºèŒƒå›´)</div>
        </div>
    </div>
    
    <div id="lowStockList" style="max-height:260px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:12px; margin-bottom:20px; padding:5px;"></div>
    
    <!-- éšè—çš„æ–‡æœ¬åŸŸç”¨äºå¤åˆ¶åŠŸèƒ½ -->
    <textarea id="lowStockText" style="position:absolute; left:-9999px;"></textarea>

    <div class="modal-btn-group" style="gap:10px;">
        <button class="m-btn m-btn-primary" style="padding:12px; font-size:15px; border-radius:12px;" onclick="copyLowStockText()">ä¸€é”®å¤åˆ¶æ¸…å•</button>
        <button class="m-btn m-btn-ghost" style="padding:12px; font-size:15px; border-radius:12px;" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<!-- Crop Edit Modal (Figure 1) -->
<div id="cropEditModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; max-width: none; max-height: none; margin: 0; padding: 0; border-radius: 0; background: black; display: none; flex-direction: column; z-index: 2000; transform: none; box-shadow: none;">
    <!-- Top Bar -->
    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:rgba(0,0,0,0.5); color:white; position:absolute; top:0; left:0; right:0; z-index:10;">
        <button onclick="closeCropEditor()" style="background:none; border:none; color:white; font-size:16px;">å–æ¶ˆ</button>
        <span style="font-size:18px; font-weight:bold;">è£åˆ‡å›¾ç‰‡</span>
        <button onclick="showCropPreview()" style="background:#4a90e2; border:none; color:white; font-size:14px; padding:6px 12px; border-radius:4px;">é¢„è§ˆ</button>
    </div>
    
    <!-- Main Crop Area -->
    <div style="flex:1; position:relative; overflow:hidden; background:black; display:flex; align-items:center; justify-content:center;">
        <img id="cropEditImage" style="max-width:100%; max-height:100%; display:block;">
    </div>
</div>

<!-- Crop Preview Modal (Figure 2) -->
<div id="cropPreviewModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; max-width: none; max-height: none; margin: 0; padding: 0; border-radius: 0; background: black; display: none; flex-direction: column; justify-content: space-between; z-index: 2100; transform: none; box-shadow: none;">
    <!-- Main Preview Area -->
    <div style="flex:1; width: 100%; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;">
        <img id="cropPreviewImage" style="max-width:100%; max-height:100%; object-fit: contain; transform-origin: center center;">
        
        <!-- Zoom Controls Overlay (Inside Preview Area to float over image) -->
        <div style="position:absolute; bottom:20px; left:0; width:100%; display:flex; justify-content:center; gap:20px; pointer-events:none; z-index: 10;">
             <button onclick="zoomPreview(0.2)" style="pointer-events:auto; background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.5); border-radius:50%; width:40px; height:40px; font-size:20px; display:flex; align-items:center; justify-content:center;">+</button>
             <button onclick="zoomPreview(-0.2)" style="pointer-events:auto; background:rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.5); border-radius:50%; width:40px; height:40px; font-size:20px; display:flex; align-items:center; justify-content:center;">-</button>
        </div>
    </div>

    <!-- Bottom Action Bar -->
    <div style="padding:20px; background:rgba(0,0,0,0.8); display:flex; gap:15px; flex-shrink:0; z-index: 20;">
        <button class="m-btn m-btn-ghost" onclick="closeCropPreview()" style="flex:1; color:white; border-color:rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; gap: 6px;">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
            </svg>
            é‡æ–°è£åˆ‡
        </button>
        <button class="m-btn m-btn-primary" onclick="confirmScanFromPreview()" style="flex:2; background:#6c5ce7; border-color:#6c5ce7;">ç¡®è®¤å¹¶è¯†åˆ«</button>
    </div>
</div>

<!-- Scan Add Item Modal -->
<div id="scanAddModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">æ·»åŠ è‰²å·</h3>
    <div style="margin-bottom: 20px;">
        <label style="display:block; font-size:14px; color:#666; margin-bottom:6px;">è‰²å·</label>
        <input type="text" id="scanAddCodeInput" placeholder="ä¾‹å¦‚A1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; text-transform: uppercase;">
    </div>
    <div style="margin-bottom: 25px;">
        <label style="display:block; font-size:14px; color:#666; margin-bottom:6px;">æ•°é‡ (ç²’)</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="m-btn m-btn-ghost" style="width: 40px; padding: 8px 0;" onclick="adjustAddScanQty(-10)">-10</button>
            <input type="number" id="scanAddQtyInput" value="0" style="flex: 1; text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; font-weight: bold;" onfocus="this.select()">
            <button class="m-btn m-btn-ghost" style="width: 40px; padding: 8px 0;" onclick="adjustAddScanQty(10)">+10</button>
        </div>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitAddScanItem()">æ·»åŠ </button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<!-- Scan Delete Confirm Modal -->
<div id="scanDeleteConfirmModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; color: #ff4d4f;">åˆ é™¤è‰²å·</h3>
    <div style="text-align: center; margin-bottom: 25px; color: #666; font-size: 15px;">
        ç¡®å®šè¦ä»æ‰«æç»“æœä¸­åˆ é™¤ <span id="scanDeleteCode" style="font-weight: bold; color: #333;"></span> å—ï¼Ÿ
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" style="background: #ff4d4f; border-color: #ff4d4f;" onclick="confirmDeleteScanItem()">åˆ é™¤</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<!-- Scan Qty Modify Modal -->
<div id="scanQtyModal" class="modal" style="width: 85%; max-width: 320px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">ä¿®æ”¹æ•°é‡</h3>
    <div style="margin-bottom: 25px;">
        <div style="font-size: 14px; color: #666; margin-bottom: 12px; text-align: center;">è‰²å·: <span id="scanQtyCode" style="font-weight: bold; color: #333; font-size: 16px;"></span></div>
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(-10)">-10</button>
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(-1)">-1</button>
            <input type="number" id="scanQtyInput" style="width: 70px; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 18px; font-weight: bold;" onfocus="this.select()">
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(1)">+1</button>
            <button class="m-btn m-btn-ghost" style="width: 36px; padding: 8px 0;" onclick="adjustScanQty(10)">+10</button>
        </div>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitScanQty()">ç¡®å®š</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirmModal" class="modal" style="width: 85%; max-width: 320px; border-radius: 12px; padding: 20px;">
    <h3 id="customConfirmTitle" style="font-size: 18px; font-weight: bold; margin-bottom: 12px; text-align: center; color: #333;">æç¤º</h3>
    <div id="customConfirmMessage" style="font-size: 15px; color: #666; margin-bottom: 24px; text-align: center; line-height: 1.5;"></div>
    <div class="modal-btn-group" style="gap: 12px;">
        <button id="customConfirmCancelBtn" class="m-btn m-btn-ghost" onclick="closeAllModals()" style="flex: 1; border-radius: 8px;">å–æ¶ˆ</button>
        <button id="customConfirmOkBtn" class="m-btn m-btn-primary" style="flex: 1; border-radius: 8px; background: #ff4d4f; border-color: #ff4d4f;">ç¡®å®š</button>
    </div>
</div>

<!-- Scan Color Select Modal -->
<div id="scanColorModal" class="modal" style="width: 90%; max-width: 400px; height: 80vh; max-height: 600px; display: none; flex-direction: column; padding: 0; overflow: hidden;">
    <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff;">
        <h3 style="font-size: 16px; margin: 0; font-weight: bold;">æ›´æ¢è‰²å·</h3>
        <button onclick="closeAllModals()" style="background: none; border: none; font-size: 24px; color: #999; padding: 0 10px; cursor: pointer;">Ã—</button>
    </div>
    <div style="padding: 10px; border-bottom: 1px solid #f5f5f5; background: #fff;">
        <input type="text" id="scanColorSearch" placeholder="æœç´¢è‰²å·..." style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #f9f9f9;" oninput="filterScanColorList()">
    </div>
    <div id="scanColorList" style="flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9;">
        <!-- List Items Generated via JS -->
    </div>
</div>

<div id="welcomeModal" class="modal">
    <h3>ğŸ“¢ æ¬¢è¿ä½¿ç”¨ MARD è±†åº“</h3>
    <div style="text-align:left; color:#555; line-height:1.6; font-size:14px; padding:0 10px;">
        <p style="margin-bottom:12px;"><b>1. æ•°æ®å®‰å…¨æé†’ï¼š</b><br>
        æœ¬å·¥å…·æ•°æ®<span style="color:#ff4d4f; font-weight:bold;">ä»…å­˜å‚¨åœ¨å½“å‰æµè§ˆå™¨çš„æœ¬åœ°ç¼“å­˜ä¸­</span>ã€‚æ¸…ç†æµè§ˆå™¨ç¼“å­˜å°†å¯¼è‡´æ•°æ®æ°¸ä¹…ä¸¢å¤±ï¼<br>
        è¯·åŠ¡å¿…å®šæœŸå¤‡ä»½æ•°æ®ï¼ˆæ“ä½œå…¥å£ï¼šé¡µé¢ä¸Šæ–¹â€œæ•°æ®å¤‡ä»½â€ï¼‰ï¼Œä½œè€…ä¸æ‰¿æ‹…æ•°æ®ä¸¢å¤±çš„ä»»ä½•åæœã€‚</p>
        
        <p style="margin-bottom:12px;"><b>2. è®¾å¤‡åŒæ­¥ï¼š</b><br>
        æœ¬å·¥å…·ä¸ºç¦»çº¿ç½‘é¡µåº”ç”¨ï¼Œ<span style="color:#ff4d4f; font-weight:bold;">ä¸æ”¯æŒå¤šè®¾å¤‡å®æ—¶åŒæ­¥</span>ã€‚å¦‚éœ€åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨ï¼Œè¯·ä½¿ç”¨å¤‡ä»½/æ¢å¤åŠŸèƒ½æ‰‹åŠ¨è¿ç§»æ•°æ®ã€‚</p>
        
        <p style="margin-bottom:12px;"><b>3. åŠŸèƒ½è¯´æ˜ï¼š</b><br>
        è¯¦ç»†æ“ä½œæŒ‡å—è¯·ç‚¹å‡»é¡µé¢ä¸Šæ–¹çš„â€œğŸ“– ä½¿ç”¨è¯´æ˜â€æŸ¥çœ‹ã€‚</p>
    </div>
    <div class="modal-btn-group" style="margin-top:20px;">
        <button class="m-btn m-btn-primary" onclick="closeWelcomeModal()">æˆ‘å·²çŸ¥æ™“</button>
    </div>
</div>

<div id="ignoredModal" class="modal" style="width:85%; max-width:340px;">
    <h3>å·²å¿½ç•¥æé†’çš„è‰²å·</h3>
    <div class="modal-desc">ä»¥ä¸‹è‰²å·ä¸å‚ä¸ä½åº“å­˜é¢„è­¦</div>
    <div id="ignoredList" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:10px; margin-bottom:15px; padding:5px;"></div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<div id="devInfoModal" class="modal" style="width:70%; max-width:260px; padding:15px;">
    <h3 style="font-size:16px;">å¼€å‘è€…ä¿¡æ¯</h3>
    <div style="text-align:center; padding:10px; color:#555; font-size:13px; line-height:1.6;">
        <p><b>å¼€å‘è€…:</b> å°çº¢ä¹¦ç”¨æˆ·ÄÅÄ“</p>
        <p><b>ID:</b> 11535779483</p>
        <p>ä½¿ç”¨ AI å·¥å…·å¼€å‘</p>
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" style="padding:10px; font-size:14px;" onclick="closeAllModals()">å…³é—­</button>
    </div>
</div>

<div id="aiUsageModal" class="modal" style="width:90%; max-width:400px; max-height: 85vh; overflow-y: auto;">
    <h3 style="text-align: center;">AIæ¨¡å‹é…ç½®</h3>
    <div class="modal-desc" style="margin-bottom: 10px; text-align: center;">ç®¡ç†API KeyåŠæŸ¥çœ‹ä½¿ç”¨é¢åº¦ (æ¯æ—¥20æ¬¡/Key/æ¨¡å‹)</div>
    <div id="aiUsageDate" style="font-size: 12px; color: #999; text-align: center; margin-bottom: 15px;"></div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 4px;">
        <span style="font-weight: bold; color: #333; font-size: 14px;">æˆ‘çš„API Keys</span>
        <button onclick="toggleAddKeyForm()" style="border: none; background: none; color: #4a90e2; font-size: 24px; font-weight: bold; cursor: pointer; padding: 0 8px; line-height: 1;">+</button>
    </div>

    <!-- Add Key Form (Hidden) -->
    <div id="addKeyForm" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed #4a90e2;">
        <div style="font-size: 13px; font-weight: bold; color: #555; margin-bottom: 8px;">æ·»åŠ æ–°Key</div>
        <input type="text" id="newKeyName" placeholder="åç§° (ä¾‹å¦‚: å…¬å¸Key)" style="width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 13px;">
        <input type="text" id="newKeyVal" placeholder="sk-..." style="width: 100%; margin-bottom: 15px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 13px;">
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="toggleAddKeyForm()" style="padding: 6px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; font-size: 13px; color: #666;">å–æ¶ˆ</button>
            <button onclick="saveNewKey()" style="padding: 6px 16px; background: #4a90e2; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: bold;">ä¿å­˜</button>
        </div>
    </div>

    <!-- Key List Container -->
    <div id="aiKeyList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
        <!-- Keys injected via JS -->
    </div>

    <div style="border-top: 1px solid #eee; margin-bottom: 15px;"></div>

    <h4 style="font-size: 14px; margin: 0 0 10px 0; color: #333;">å½“å‰ Key (<span id="activeKeyNameDisplay"></span>) ä½¿ç”¨æƒ…å†µ</h4>
    <div style="background: #f5f7fa; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <!-- Item 1 -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: bold; color: #333;">gemini-3-flash</span>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" id="use-g3" class="usage-input" style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 4px;" onchange="saveCurrentUsage()">
                <span style="color: #999; font-size: 12px;">/ 20</span>
            </div>
        </div>
        <!-- Item 2 -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: bold; color: #333;">gemini-2.5-flash</span>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" id="use-g25" class="usage-input" style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 4px;" onchange="saveCurrentUsage()">
                <span style="color: #999; font-size: 12px;">/ 20</span>
            </div>
        </div>
        <!-- Item 3 -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: bold; color: #333;">gemini-2.5-flash-lite</span>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" id="use-g25l" class="usage-input" style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 4px;" onchange="saveCurrentUsage()">
                <span style="color: #999; font-size: 12px;">/ 20</span>
            </div>
        </div>
    </div>
    
    <div class="modal-btn-group">
        <button class="m-btn m-btn-ghost" onclick="resetActiveAIUsage()" style="color: #ff4d4f; border-color: #ff4d4f;">é‡ç½®å½“å‰ Key é¢åº¦</button>
        <button class="m-btn m-btn-primary" onclick="closeAllModals()">å®Œæˆ</button>
    </div>
</div>

<!-- Rename Plan Modal -->
<div id="renamePlanModal" class="modal" style="width: 85%; max-width: 320px; border-radius: 16px; padding: 24px;">
    <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center;">é‡å‘½å</h3>
    <div style="margin-bottom: 25px;">
        <input type="text" id="renamePlanInput" placeholder="è¯·è¾“å…¥æ–°çš„è®¡åˆ’åç§°" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; text-align: center;" onfocus="this.select()" onkeypress="if(event.key === 'Enter') submitRenamePlan()">
    </div>
    <div class="modal-btn-group">
        <button class="m-btn m-btn-primary" onclick="submitRenamePlan()">ç¡®å®š</button>
        <button class="m-btn m-btn-ghost" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<div id="revertConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">æ’¤é”€ç¡®è®¤</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦æ’¤é”€â€œå·²å®Œæˆâ€çŠ¶æ€å—ï¼Ÿ<br>è¿™å°†è‡ªåŠ¨å›æ»šåº“å­˜æ‰£å‡æ“ä½œã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmRevertPlan()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤æ’¤é”€</button>
    </div>
</div>

<div id="deleteConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">åˆ é™¤ç¡®è®¤</h3>
    <div id="deleteConfirmMsg" style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¡åˆ’å—ï¼Ÿ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmDeletePlan()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤åˆ é™¤</button>
    </div>
</div>

<div id="importConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">æ¢å¤ç¡®è®¤</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        è­¦å‘Šï¼šæ¢å¤æ“ä½œå°†é‡ç½®å½“å‰æ‰€æœ‰åº“å­˜æ•°æ®ï¼Œç„¶åå¯¼å…¥æ–°æ•°æ®ã€‚<br>ç¡®è®¤ç»§ç»­å—ï¼Ÿ
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmImport()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤æ¢å¤</button>
    </div>
</div>

<div id="moveOutConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">ç§»å‡ºç¡®è®¤</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦å°†æ­¤è®¡åˆ’ç§»å‡ºå½“å‰æ–‡ä»¶å¤¹å—ï¼Ÿ<br>ç§»å‡ºåå®ƒå°†å˜å›ç‹¬ç«‹è®¡åˆ’ã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmMoveOutPlan()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">ç¡®è®¤ç§»å‡º</button>
    </div>
</div>

<div id="createCollectionModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">åˆ›å»ºåˆé›†</h3>
    <div style="margin-bottom: 20px;">
        <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">è¯·è¾“å…¥åˆé›†åç§°ï¼š</label>
        <input type="text" id="collectionNameInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„åˆé›†">
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmCreateCollection()" style="flex: 1; padding: 10px; border: none; background: #1890ff; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">åˆ›å»º</button>
    </div>
</div>

<div id="deleteKeyConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">åˆ é™¤ Key</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šè¦åˆ é™¤è¿™ä¸ª API Key å—ï¼Ÿ<br>åˆ é™¤åä¸å¯æ¢å¤ã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmDeleteKey()" style="flex: 1; padding: 10px; border: none; background: #ff4d4f; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">åˆ é™¤</button>
    </div>
</div>

<div id="resetUsageConfirmModal" class="modal" style="width: 80%; max-width: 320px; padding: 24px; border-radius: 16px;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; text-align: center;">é‡ç½®é¢åº¦</h3>
    <div style="text-align: center; color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 24px;">
        ç¡®å®šé‡ç½®å½“å‰ Key çš„ä»Šæ—¥é¢åº¦å—ï¼Ÿ<br>è¿™åªä¼šæ¸…é™¤æœ¬åœ°è®°å½•çš„å·²ç”¨é‡ã€‚
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="closeAllModals()" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px;">å–æ¶ˆ</button>
        <button onclick="confirmResetUsage()" style="flex: 1; padding: 10px; border: none; background: #4a90e2; color: white; border-radius: 8px; font-size: 14px; font-weight: bold;">é‡ç½®</button>
    </div>
</div>




<!-- Fabric Tool Page -->
<div id="page-fabric" style="display:none; min-height:100vh; background:#f0f2f5;">
    <!-- Fabric Tool Header -->
    <div style="background:white; padding:12px 16px; display:flex; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.05); position:sticky; top:0; z-index:100;">
        <button onclick="navTo('home')" class="btn-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <h2 style="margin:0; font-size:16px; flex:1;">çƒ˜ç„™å¸ƒè£å‰ªç»„åˆå·¥å…·</h2>
    </div>

    <div class="fabric-container">
        <!-- Sidebar -->
        <div class="fabric-sidebar">
            <h3 style="margin-top:0; font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">1. åŸå¸ƒå°ºå¯¸ (cm)</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div class="input-group-sm">
                    <label>é•¿</label>
                    <input type="number" id="canvasW" value="100" onchange="saveFabricState()">
                </div>
                <div class="input-group-sm">
                    <label>å®½</label>
                    <input type="number" id="canvasH" value="100" onchange="saveFabricState()">
                </div>
            </div>

            <h3 style="font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                2. æˆå“è§„æ ¼ (æœ€å¤š5ç§)
                <button onclick="addSpec()" style="font-size:12px; background:#e6f7ff; color:#1890ff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">+ æ·»åŠ </button>
            </h3>
            <div style="font-size:12px; color:#999; margin-bottom:10px; line-height:1.4;">
                è§„æ ¼å‚è€ƒï¼šä¸€å—52é’‰æ¿è§„æ ¼ä¸º14*14cm, ä¸€å—78é’‰æ¿è§„æ ¼ä¸º21*21cm, ä¸€å—104é’‰æ¿è§„æ ¼ä¸º28*28cm
            </div>
            <div id="specList" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                <!-- Specs will be injected here -->
            </div>

            <h3 style="font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">3. æ’åºåå¥½</h3>
            <select id="sortPref" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-bottom:20px; box-sizing:border-box;" onchange="saveFabricState()">
                <!-- Options will be dynamic -->
            </select>

            <button onclick="calculateLayout()" style="width:100%; padding:12px; background:linear-gradient(135deg, #eb2f96, #c41d7f); color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer; box-shadow:0 4px 10px rgba(235, 47, 150, 0.3); box-sizing:border-box;">
                å¼€å§‹è®¡ç®—ï¼ˆä»…å±•ç¤ºåˆ©ç”¨ç‡â‰¥ 90%çš„æ–¹æ¡ˆ)
            </button>
            <div id="calcStatus" style="margin-top:10px; font-size:12px; color:#666; text-align:center;"></div>
        </div>

        <!-- Main Content -->
        <div class="fabric-main">
            <div id="solutionList" style="display:flex; flex-direction:column; gap:20px;">
                <div style="text-align:center; padding:40px; color:#999;">
                    <div style="font-size:40px; margin-bottom:10px;">âœ‚ï¸</div>
                    <div class="desktop-hint">ç‚¹å‡»å·¦ä¾§â€œå¼€å§‹è®¡ç®—â€ç”Ÿæˆæ–¹æ¡ˆ</div>
                    <div class="mobile-hint">ç‚¹å‡»ä¸Šæ–¹â€œå¼€å§‹è®¡ç®—â€ç”Ÿæˆæ–¹æ¡ˆ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .input-group-sm { flex:1; display:flex; flex-direction:column; gap:4px; min-width:0; }
    .input-group-sm label { font-size:12px; color:#666; }
    .input-group-sm input { padding:6px; border:1px solid #ddd; border-radius:4px; width:100%; box-sizing:border-box; }
    
    .fabric-sidebar, .fabric-main { min-width: 300px; box-sizing: border-box; }
    @media (max-width: 600px) {
        .fabric-sidebar, .fabric-main { min-width: 100% !important; border-radius: 0 !important; box-shadow: none !important; padding: 16px !important; }
        .fabric-container { padding: 0 !important; gap: 10px !important; }
        .fabric-main { padding: 16px !important; background: transparent; }
    }
    
    .spec-item { display:flex; gap:8px; align-items:center; background:#f9fafb; padding:8px; border-radius:6px; }
    .spec-color { width:16px; height:16px; border-radius:4px; }
    .btn-del { border:none; background:none; color:#ff4d4f; cursor:pointer; font-size:16px; padding:0 4px; }

    .solution-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .sol-header { padding:12px 16px; background:#fafafa; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
    .sol-badge { background:#f6ffed; color:#52c41a; border:1px solid #b7eb8f; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold; white-space: nowrap; }
    .sol-body { padding:16px; display:flex; flex-wrap:wrap; gap:20px; align-items:flex-start; }
    .sol-canvas-wrapper { border:1px solid #eee; display:inline-block; position:relative; }
    .sol-info { flex:1; min-width:150px; }
    .sol-stat-row { display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px; color:#555; border-bottom:1px dotted #eee; padding-bottom:2px; }

    /* å“åº”å¼æç¤ºæ–‡å­— */
    .mobile-hint { display: none; }
    .desktop-hint { display: block; }

    /* Fabric Tool Layout */
    .fabric-container { max-width:1200px; margin:0 auto; padding:16px; display:flex; flex-wrap:wrap; gap:20px; }
    .fabric-sidebar { flex:1; min-width: 280px; background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); height:fit-content; }
    .fabric-main { flex:2; min-width: 280px; }

    @media (max-width: 768px) {
        .mobile-hint { display: block; }
        .desktop-hint { display: none; }
    }

    @media (max-width: 600px) {
        .fabric-container { padding: 6px; gap: 12px; }
        .fabric-sidebar { padding: 16px; }
    }
</style>


<!-- Zoom Modal -->
<div id="zoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:95%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeZoom()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="margin-bottom:10px; font-weight:bold; font-size:18px; color:#333;" id="zoomTitle">æ–¹æ¡ˆè¯¦æƒ…</div>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:10px;">
            <canvas id="zoomCanvas"></canvas>
        </div>
        <button id="zoomDownloadBtn" onclick="downloadSolution(currentZoomIdx)" style="margin-top:10px; padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">ä¿å­˜å›¾ç‰‡</button>
        <div id="zoomStats" style="margin-top:10px; width:100%; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:4px; box-sizing: border-box; background: #fafafa;"></div>
        <div style="margin-top:15px; display:flex; justify-content:center;">
             <button onclick="closeZoom()" style="padding:8px 20px; background:#f0f0f0; border:1px solid #ddd; border-radius:6px; cursor:pointer;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- Download Modal (Mobile) -->
<div id="downloadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:90%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeDownloadModal()" style="position:absolute; top:5px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:5px;">
            <img id="downloadImg" style="max-width:100%; height:auto;" />
        </div>
        <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
             <button id="downloadBtnMobile" style="padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;">ä¿å­˜å›¾ç‰‡</button>
             <button onclick="closeDownloadModal()" style="padding:8px 20px; background:#1890ff; color:white; border:none; border-radius:6px; cursor:pointer;">å…³é—­</button>
        </div>
    </div>
</div>

<div id="planSelectionBar" class="selection-bar" style="display: none;">
    <div style="font-weight: bold; color: #333;">å·²é€‰æ‹© <span id="selectedCount">0</span> ä¸ªè®¡åˆ’</div>
    <div style="display: flex; gap: 10px;">
        <button class="m-btn m-btn-ghost" onclick="exitPlanSelectionMode()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; white-space: nowrap;">å–æ¶ˆ</button>
        <button class="m-btn m-btn-primary" onclick="mergeSelectedPlans()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; background: #722ed1; border-color: #722ed1; white-space: nowrap;">åˆå¹¶è®¡åˆ’</button>
    </div>
</div>

<script>
    const ModelUsageManager = {
        limit: 20,
        storageKey: 'ai_usage_data',
        defaultKey: "",
        
        getData() {
            let data = null;
            try {
                data = JSON.parse(localStorage.getItem(this.storageKey));
            } catch (e) {
                data = null;
            }

            // Migration logic: If no data or old structure (no keys array)
            if (!data || !data.keys) {
                console.log('ModelUsageManager: Initializing or migrating to multi-key structure...');
                const oldApiKey = (data && data.apiKey) ? data.apiKey : this.defaultKey;
                const oldUsage = (data && data.usage) ? data.usage : {};
                const newId = Date.now().toString(); // use timestamp as ID
                
                return {
                    date: (data && data.date) ? data.date : new Date().toDateString(),
                    activeKeyId: newId,
                    keys: [{
                        id: newId,
                        name: 'é»˜è®¤Key',
                        apiKey: oldApiKey,
                        usage: oldUsage
                    }]
                };
            }
            
            return data;
        },

        saveData(data) {
            localStorage.setItem(this.storageKey, JSON.stringify(data));
        },

        checkReset() {
            const data = this.getData();
            const today = new Date().toDateString();
            if (data.date !== today) {
                console.log('ModelUsageManager: New day detected. Resetting all usage.');
                data.date = today;
                // Reset usage for ALL keys
                if (data.keys) {
                    data.keys.forEach(k => k.usage = {});
                }
                this.saveData(data);
            }
        },

        // --- Key Management ---
        getKeys() {
            return this.getData().keys;
        },
        
        getActiveKeyId() {
            return this.getData().activeKeyId;
        },
        
        getActiveKey() {
            const data = this.getData();
            return data.keys.find(k => k.id === data.activeKeyId) || data.keys[0];
        },
        
        setActiveKey(id) {
            const data = this.getData();
            if (data.keys.some(k => k.id === id)) {
                data.activeKeyId = id;
                this.saveData(data);
            }
        },
        
        addKey(name, apiKey) {
            const data = this.getData();
            const newId = Date.now().toString();
            data.keys.push({
                id: newId,
                name: name || 'æ–° Key',
                apiKey: apiKey || '',
                usage: {}
            });
            // If it's the only key (shouldn't happen due to migration, but safe check), make it active
            if (data.keys.length === 1) {
                data.activeKeyId = newId;
            }
            this.saveData(data);
            return newId;
        },
        
        updateKey(id, updates) {
            const data = this.getData();
            const key = data.keys.find(k => k.id === id);
            if (key) {
                if (updates.name !== undefined) key.name = updates.name;
                if (updates.apiKey !== undefined) key.apiKey = updates.apiKey;
                this.saveData(data);
            }
        },
        
        deleteKey(id) {
            const data = this.getData();
            const idx = data.keys.findIndex(k => k.id === id);
            if (idx > -1) {
                data.keys.splice(idx, 1);
                
                // If we deleted the active key, switch to another
                if (data.activeKeyId === id) {
                    if (data.keys.length > 0) {
                        data.activeKeyId = data.keys[0].id;
                    } else {
                        // No keys left, create default
                        const newId = Date.now().toString();
                        data.keys.push({ id: newId, name: 'é»˜è®¤Key', apiKey: '', usage: {} });
                        data.activeKeyId = newId;
                    }
                }
                this.saveData(data);
            }
        },

        // --- Usage Logic (Operates on Active Key) ---
        getApiKey() {
            const key = this.getActiveKey();
            return key ? key.apiKey : '';
        },

        canUse(model) {
            this.checkReset();
            const key = this.getActiveKey();
            if (!key) return false;
            return (key.usage[model] || 0) < this.limit;
        },

        increment(model) {
            this.checkReset();
            const data = this.getData();
            const key = data.keys.find(k => k.id === data.activeKeyId);
            if (key) {
                key.usage[model] = (key.usage[model] || 0) + 1;
                this.saveData(data);
            }
        },
        
        getUsage(model) {
            this.checkReset();
            const key = this.getActiveKey();
            return key ? (key.usage[model] || 0) : 0;
        },
        
        setUsage(model, count) {
            const data = this.getData();
            const key = data.keys.find(k => k.id === data.activeKeyId);
            if (key) {
                key.usage[model] = parseInt(count) || 0;
                this.saveData(data);
            }
        },
        
        resetActiveUsage() {
            const data = this.getData();
            const key = data.keys.find(k => k.id === data.activeKeyId);
            if (key) {
                key.usage = {};
                this.saveData(data);
            }
        },
        
        resetAll() {
             const data = this.getData();
             data.keys.forEach(k => k.usage = {});
             this.saveData(data);
        }
    };

    // Initialize immediately
    ModelUsageManager.checkReset();
    // Clean up old testing key if exists
    localStorage.removeItem('ai_model_usage_v1');

    function openAIUsageModal() {
        ModelUsageManager.checkReset(); // Ensure date is correct
        
        // Set Date
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        document.getElementById('aiUsageDate').innerText = `${y}/${m}/${d}`;

        renderAIKeyList();
        renderActiveKeyUsage();
        
        showModal('aiUsageModal');
    }

    const ICON_EYE = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
    const ICON_EYE_OFF = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;

    function renderAIKeyList() {
        const listEl = document.getElementById('aiKeyList');
        if (!listEl) return;
        listEl.innerHTML = '';
        
        let keys = ModelUsageManager.getKeys();
        const activeId = ModelUsageManager.getActiveKeyId();
        
        // Sort keys: Active one first, then others
        const sortedKeys = [...keys].sort((a, b) => {
            if (a.id === activeId) return -1;
            if (b.id === activeId) return 1;
            return 0;
        });
        
        sortedKeys.forEach(k => {
            const isActive = k.id === activeId;
            const div = document.createElement('div');
            
            if (isActive) {
                // Active Key: Expanded Card View
                div.className = 'ai-key-item active';
                div.style.cssText = `
                    display: flex; flex-direction: column; gap: 8px; 
                    padding: 12px; border-radius: 10px; border: 1px solid #4a90e2;
                    background: #f0f7ff; position: relative; transition: all 0.2s;
                    box-shadow: 0 2px 5px rgba(74, 144, 226, 0.1);
                `;
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 18px; height: 18px; border-radius: 50%; background: #4a90e2; border: 3px solid white; box-shadow: 0 0 0 1px #4a90e2;"></div>
                        <input type="text" value="${k.name}" placeholder="Keyåç§°" 
                               onchange="updateKeyName('${k.id}', this.value)"
                               style="flex: 1; border: none; background: transparent; font-weight: bold; color: #333; font-size: 15px; outline: none; border-bottom: 1px dashed transparent;"
                               onfocus="this.style.borderBottomColor='#4a90e2'" onblur="this.style.borderBottomColor='transparent'">
                        
                        <button onclick="deleteKey('${k.id}')" style="color: #ff4d4f; background: none; border: none; font-size: 18px; cursor: pointer; padding: 0 5px; opacity: 0.8;">&times;</button>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 6px 10px; border-radius: 6px; border: 1px solid #e0e0e0;">
                        <span style="font-size: 12px; color: #999; font-weight: bold;">Key</span>
                        <input type="password" value="${k.apiKey}" placeholder="AIza..." 
                               onchange="updateKeyVal('${k.id}', this.value)"
                               style="flex: 1; border: none; font-size: 12px; font-family: monospace; color: #555; outline: none; background: transparent;">
                        <button onclick="toggleKeyVis(this)" style="background:none; border:none; cursor:pointer; font-size:14px; padding:0; display:flex; align-items:center; color: #bbb;">${ICON_EYE}</button>
                    </div>
                `;
            } else {
                // Inactive Key: Collapsed / Compact View
                div.className = 'ai-key-item inactive';
                div.style.cssText = `
                    display: flex; align-items: center; gap: 10px; 
                    padding: 10px 12px; border-radius: 8px; border: 1px solid #eee;
                    background: #fff; cursor: pointer; transition: all 0.2s;
                `;
                div.onclick = (e) => {
                     // Prevent triggering if delete button clicked or editing name (if enabled later)
                     if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                     selectKey(k.id);
                };
                
                div.innerHTML = `
                    <div style="width: 18px; height: 18px; border-radius: 50%; border: 1px solid #ccc; background: white;"></div>
                    <span style="font-size: 14px; color: #666; flex: 1; font-weight: 500;">${k.name}</span>
                    <button onclick="deleteKey('${k.id}')" style="color: #ddd; background: none; border: none; font-size: 18px; cursor: pointer; padding: 0 5px;">&times;</button>
                `;
            }
            
            listEl.appendChild(div);
        });
    }

    function toggleKeyVis(btn) {
        const input = btn.previousElementSibling;
        if (input && input.tagName === 'INPUT') {
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = ICON_EYE_OFF;
                btn.style.color = '#4a90e2';
            } else {
                input.type = 'password';
                btn.innerHTML = ICON_EYE;
                btn.style.color = '#bbb';
            }
        }
    }

    function renderActiveKeyUsage() {
        const activeKey = ModelUsageManager.getActiveKey();
        if (!activeKey) return;
        
        const nameDisplay = document.getElementById('activeKeyNameDisplay');
        if (nameDisplay) nameDisplay.innerText = activeKey.name;
        
        document.getElementById('use-g3').value = ModelUsageManager.getUsage('gemini-3-flash');
        document.getElementById('use-g25').value = ModelUsageManager.getUsage('gemini-2.5-flash');
        document.getElementById('use-g25l').value = ModelUsageManager.getUsage('gemini-2.5-flash-lite');
    }

    function toggleAddKeyForm() {
        const form = document.getElementById('addKeyForm');
        if (form.style.display === 'none') {
            form.style.display = 'block';
            document.getElementById('newKeyName').focus();
        } else {
            form.style.display = 'none';
        }
    }

    function saveNewKey() {
        const nameInput = document.getElementById('newKeyName');
        const valInput = document.getElementById('newKeyVal');
        const name = nameInput.value.trim();
        const key = valInput.value.trim();
        
        if (!key) {
            alert('è¯·è¾“å…¥ API Key');
            return;
        }
        
        ModelUsageManager.addKey(name || 'æ–° Key', key);
        
        // Reset and hide form
        nameInput.value = '';
        valInput.value = '';
        toggleAddKeyForm();
        
        // Refresh list (new key becomes active automatically in addKey logic, so it will be at top)
        renderAIKeyList();
        renderActiveKeyUsage();
    }

    function selectKey(id) {
        ModelUsageManager.setActiveKey(id);
        renderAIKeyList(); // Re-render to update styling
        renderActiveKeyUsage();
    }

    function updateKeyName(id, val) {
        ModelUsageManager.updateKey(id, { name: val });
        if (ModelUsageManager.getActiveKeyId() === id) {
            const nameDisplay = document.getElementById('activeKeyNameDisplay');
            if (nameDisplay) nameDisplay.innerText = val;
        }
    }

    function updateKeyVal(id, val) {
        ModelUsageManager.updateKey(id, { apiKey: val });
    }

    let pendingDeleteKeyId = null;

    function deleteKey(id) {
        pendingDeleteKeyId = id;
        showModal('deleteKeyConfirmModal');
    }

    function confirmDeleteKey() {
        if (pendingDeleteKeyId) {
            ModelUsageManager.deleteKey(pendingDeleteKeyId);
            renderAIKeyList();
            renderActiveKeyUsage();
            pendingDeleteKeyId = null;
        }
        // Only close the confirmation modal, keep the main modal open
        const modal = document.getElementById('deleteKeyConfirmModal');
        if (modal) modal.style.display = 'none';
    }

    function saveCurrentUsage() {
        ModelUsageManager.setUsage('gemini-3-flash', document.getElementById('use-g3').value);
        ModelUsageManager.setUsage('gemini-2.5-flash', document.getElementById('use-g25').value);
        ModelUsageManager.setUsage('gemini-2.5-flash-lite', document.getElementById('use-g25l').value);
    }

    function resetActiveAIUsage() {
        showModal('resetUsageConfirmModal');
    }

    function confirmResetUsage() {
        ModelUsageManager.resetActiveUsage();
        renderActiveKeyUsage();
        showToast('å·²é‡ç½®');
        const modal = document.getElementById('resetUsageConfirmModal');
        if (modal) modal.style.display = 'none';
    }

    function updatePullToRefresh(page) {
        // æ‰‹æœºç«¯ï¼šæ‰«æé¡µé¢ç¦ç”¨ä¸‹æ‹‰åˆ·æ–° (prevent pull-to-refresh)
        if (page === 'scan') {
            document.body.style.overscrollBehaviorY = 'contain';
        } else {
            document.body.style.overscrollBehaviorY = 'auto';
        }
    }

    function navTo(page) {
        // Save state for refresh
        localStorage.setItem('mard_last_nav', JSON.stringify({ method: 'navTo', arg: page }));
        
        // Update Pull-to-Refresh behavior
        updatePullToRefresh(page);

        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-beads').style.display = 'none';
        document.getElementById('page-fabric').style.display = 'none';
        document.getElementById('page-stats').style.display = 'none';
        document.getElementById('page-scan').style.display = 'none';

        
        // Hide dock by default, show only for main pages
        document.getElementById('footer-dock').style.display = 'none';
        
        // Handle FAB visibility
        const fab = document.getElementById('floatingBatchAddBtn');
        if(fab) fab.style.display = (page === 'beads') ? 'flex' : 'none';

        const homeBtn = document.getElementById('floatingHomeBtn');
        if(homeBtn) homeBtn.style.display = (page === 'beads') ? 'flex' : 'none';

        if (page === 'home') {
            document.getElementById('page-home').style.display = 'flex';
        } else if (page === 'beads') {
            document.getElementById('page-beads').style.display = 'block';
            document.getElementById('footer-dock').style.display = 'flex'; // Show dock
            checkWelcome();
        } else if (page === 'scan') {
            document.getElementById('page-scan').style.display = 'block';
            document.getElementById('footer-dock').style.display = 'flex';

        } else if (page === 'fabric') {
            document.getElementById('page-fabric').style.display = 'block';
            // Dock remains hidden for fabric page
            
            // Restore Fabric State
            const savedSpecs = localStorage.getItem('fabric_specs');
            if (savedSpecs) {
                specs = JSON.parse(savedSpecs);
                // Force update colors to match current theme (Fixes issue where Spec 3 might be purple)
                if (typeof specColors !== 'undefined') {
                    specs.forEach((s, i) => {
                        if (i < specColors.length) {
                            s.color = specColors[i];
                        }
                    });
                }
            }
            
            // If no specs (first time or cleared), add default
            if(specs.length === 0) {
                addSpec(); 
            } else {
                renderSpecs();
            }

            const savedW = localStorage.getItem('fabric_w');
            const savedH = localStorage.getItem('fabric_h');
            if (savedW) document.getElementById('canvasW').value = savedW;
            if (savedH) document.getElementById('canvasH').value = savedH;
            
            // Restore sort pref after specs are rendered (options need specs)
            setTimeout(() => {
                const savedSort = localStorage.getItem('fabric_sort');
                if (savedSort) {
                     const sortEl = document.getElementById('sortPref');
                     if(sortEl) sortEl.value = savedSort;
                }
                
                // Auto-calculate if data exists (User request: show last operation info)
                if (savedW && savedH && specs.length > 0) {
                    // Check if inputs are valid numbers
                    if (parseFloat(savedW) > 0 && parseFloat(savedH) > 0) {
                        // Check if all specs have valid dimensions
                        const allSpecsValid = specs.every(s => s.w > 0 && s.h > 0);
                        if (allSpecsValid) {
                             // Small delay to ensure UI is ready
                             calculateLayout();
                        }
                    }
                }
            }, 50);
        }
    }

    function showToast(msg, duration = 2000) {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.8); color:white; padding:12px 24px; border-radius:8px; font-size:14px; z-index:9999; text-align:center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: fadeIn 0.2s;';
        toast.innerText = msg;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, duration);
    }

    function openThresholdModal() {
        document.getElementById('thresholdInput').value = threshold;
        showModal('thresholdModal');
        setTimeout(() => document.getElementById('thresholdInput').select(), 50);
    }

    function saveThreshold() {
        const input = document.getElementById('thresholdInput');
        const val = parseFloat(input.value);
        
        if (!isNaN(val) && val >= 0) {
            threshold = val;
            localStorage.setItem('bead_threshold', threshold);
            render();
            closeAllModals();
            
            showToast(`é˜ˆå€¼å·²æ›´æ–°ä¸º ${threshold}g`);
        } else {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
        }
    }





    const MARD_DB = [
        {id:'A1',hex:'#faf5cd'},{id:'A2',hex:'#fcfed6'},{id:'A3',hex:'#fcff92'},{id:'A4',hex:'#f7ec5c'},{id:'A5',hex:'#f0d83a'},{id:'A6',hex:'#fda951'},{id:'A7',hex:'#fa8c4f'},{id:'A8',hex:'#fbda4d'},{id:'A9',hex:'#f79d5f'},{id:'A10',hex:'#f47e38'},{id:'A11',hex:'#fedb99'},{id:'A12',hex:'#fda276'},{id:'A13',hex:'#fec667'},{id:'A14',hex:'#f75842'},{id:'A15',hex:'#fbf65e'},{id:'A16',hex:'#feff97'},{id:'A17',hex:'#fde173'},{id:'A18',hex:'#fcbf80'},{id:'A19',hex:'#fd7e77'},{id:'A20',hex:'#f9d66e'},{id:'A21',hex:'#fae393'},{id:'A22',hex:'#edf878'},{id:'A23',hex:'#e4c8ba'},{id:'A24',hex:'#f3f6a9'},{id:'A25',hex:'#ffd785'},{id:'A26',hex:'#ffc734'},
        {id:'B1',hex:'#dff13b'},{id:'B2',hex:'#64f343'},{id:'B3',hex:'#a1f586'},{id:'B4',hex:'#5fdf34'},{id:'B5',hex:'#39e158'},{id:'B6',hex:'#64e0a4'},{id:'B7',hex:'#3eae7c'},{id:'B8',hex:'#1d9b54'},{id:'B9',hex:'#2a5037'},{id:'B10',hex:'#9ad1ba'},{id:'B11',hex:'#627032'},{id:'B12',hex:'#1a6e3d'},{id:'B13',hex:'#c8e87d'},{id:'B14',hex:'#abe84f'},{id:'B15',hex:'#305335'},{id:'B16',hex:'#c0ed9c'},{id:'B17',hex:'#9eb33e'},{id:'B18',hex:'#e6ed4f'},{id:'B19',hex:'#26b78e'},{id:'B20',hex:'#cbeccf'},{id:'B21',hex:'#18616a'},{id:'B22',hex:'#0a4241'},{id:'B23',hex:'#343b1a'},{id:'B24',hex:'#e8faa6'},{id:'B25',hex:'#4e846d'},{id:'B26',hex:'#907c35'},{id:'B27',hex:'#d0e0af'},{id:'B28',hex:'#9ee5bb'},{id:'B29',hex:'#c6df5f'},{id:'B30',hex:'#e3fbb1'},{id:'B31',hex:'#b4e691'},{id:'B32',hex:'#92ad60'},
        {id:'C1',hex:'#f0fee4'},{id:'C2',hex:'#abf8fe'},{id:'C3',hex:'#a2e0f7'},{id:'C4',hex:'#44cdfb'},{id:'C5',hex:'#06aadf'},{id:'C6',hex:'#54a7e9'},{id:'C7',hex:'#3977ca'},{id:'C8',hex:'#0f52bd'},{id:'C9',hex:'#3349c3'},{id:'C10',hex:'#3cbce3'},{id:'C11',hex:'#2aded3'},{id:'C12',hex:'#1e334e'},{id:'C13',hex:'#cde7fe'},{id:'C14',hex:'#d5fcf7'},{id:'C15',hex:'#21c5c4'},{id:'C16',hex:'#1858a2'},{id:'C17',hex:'#02d1f3'},{id:'C18',hex:'#213244'},{id:'C19',hex:'#18869d'},{id:'C20',hex:'#1a70a9'},{id:'C21',hex:'#bcddfc'},{id:'C22',hex:'#6bb1bb'},{id:'C23',hex:'#c8e2fd'},{id:'C24',hex:'#7ec5f9'},{id:'C25',hex:'#a9e8e0'},{id:'C26',hex:'#42adcf'},{id:'C27',hex:'#d0def9'},{id:'C28',hex:'#bdcee8'},{id:'C29',hex:'#364a89'},
        {id:'D1',hex:'#acb7ef'},{id:'D2',hex:'#868dd3'},{id:'D3',hex:'#3554af'},{id:'D4',hex:'#162d7b'},{id:'D5',hex:'#b34ec6'},{id:'D6',hex:'#b37bdc'},{id:'D7',hex:'#8758a9'},{id:'D8',hex:'#e3d2fe'},{id:'D9',hex:'#d5b9f4'},{id:'D10',hex:'#301a49'},{id:'D11',hex:'#beb9e2'},{id:'D12',hex:'#dc99ce'},{id:'D13',hex:'#b5038d'},{id:'D14',hex:'#862993'},{id:'D15',hex:'#2f1f8c'},{id:'D16',hex:'#e2e4f0'},{id:'D17',hex:'#c7d3f9'},{id:'D18',hex:'#9a64b8'},{id:'D19',hex:'#d8c2d9'},{id:'D20',hex:'#9a35ad'},{id:'D21',hex:'#940595'},{id:'D22',hex:'#333a95'},{id:'D23',hex:'#eadbf8'},{id:'D24',hex:'#768ae1'},{id:'D25',hex:'#4950c2'},{id:'D26',hex:'#d6c6eb'},
        {id:'E1',hex:'#f6d4cb'},{id:'E2',hex:'#fcc1dd'},{id:'E3',hex:'#f6bde8'},{id:'E4',hex:'#e8649e'},{id:'E5',hex:'#f0569f'},{id:'E6',hex:'#eb4172'},{id:'E7',hex:'#c53674'},{id:'E8',hex:'#fddbe9'},{id:'E9',hex:'#e376c7'},{id:'E10',hex:'#d13b95'},{id:'E11',hex:'#f7dad4'},{id:'E12',hex:'#f693bf'},{id:'E13',hex:'#b5026a'},{id:'E14',hex:'#fad4bf'},{id:'E15',hex:'#f5c9ca'},{id:'E16',hex:'#fbf4ec'},{id:'E17',hex:'#f7e3ec'},{id:'E18',hex:'#f9c8db'},{id:'E19',hex:'#f6bbd1'},{id:'E20',hex:'#d7c6ce'},{id:'E21',hex:'#c09da4'},{id:'E22',hex:'#b38c9f'},{id:'E23',hex:'#937d8a'},{id:'E24',hex:'#debee5'},
        {id:'F1',hex:'#fe9381'},{id:'F2',hex:'#f63d4b'},{id:'F3',hex:'#ee4e3e'},{id:'F4',hex:'#fb2a40'},{id:'F5',hex:'#e10328'},{id:'F6',hex:'#913635'},{id:'F7',hex:'#911932'},{id:'F8',hex:'#bb0126'},{id:'F9',hex:'#e0677a'},{id:'F10',hex:'#874628'},{id:'F11',hex:'#592323'},{id:'F12',hex:'#f3536b'},{id:'F13',hex:'#f45c45'},{id:'F14',hex:'#fcadb2'},{id:'F15',hex:'#d50527'},{id:'F16',hex:'#f8c0a9'},{id:'F17',hex:'#e89b7d'},{id:'F18',hex:'#d07f4a'},{id:'F19',hex:'#be454a'},{id:'F20',hex:'#c69495'},{id:'F21',hex:'#f2b8c6'},{id:'F22',hex:'#f7c3d0'},{id:'F23',hex:'#ed806c'},{id:'F24',hex:'#e09daf'},{id:'F25',hex:'#e84854'},
        {id:'G1',hex:'#ffe4d3'},{id:'G2',hex:'#fcc6ac'},{id:'G3',hex:'#f1c4a5'},{id:'G4',hex:'#dcb387'},{id:'G5',hex:'#e7b34e'},{id:'G6',hex:'#e3a014'},{id:'G7',hex:'#985c3a'},{id:'G8',hex:'#713d2f'},{id:'G9',hex:'#e4b685'},{id:'G10',hex:'#da8c42'},{id:'G11',hex:'#dac898'},{id:'G12',hex:'#fec993'},{id:'G13',hex:'#b2714b'},{id:'G14',hex:'#8b684c'},{id:'G15',hex:'#f6f8e3'},{id:'G16',hex:'#f2d8c1'},{id:'G17',hex:'#77544e'},{id:'G18',hex:'#ffe3d5'},{id:'G19',hex:'#dd7d41'},{id:'G20',hex:'#a5452f'},{id:'G21',hex:'#b38561'},
        {id:'H1',hex:'#ffffff'},{id:'H2',hex:'#fbfbfb'},{id:'H3',hex:'#b4b4b4'},{id:'H4',hex:'#878787'},{id:'H5',hex:'#464646'},{id:'H6',hex:'#2c2c2c'},{id:'H7',hex:'#010101'},{id:'H8',hex:'#e7d6dc'},{id:'H9',hex:'#efedee'},{id:'H10',hex:'#ebebeb'},{id:'H11',hex:'#cdcdcd'},{id:'H12',hex:'#fdf6ee'},{id:'H13',hex:'#f4efd1'},{id:'H14',hex:'#ced7d4'},{id:'H15',hex:'#9aa6a6'},{id:'H16',hex:'#1b1213'},{id:'H17',hex:'#f0eeef'},{id:'H18',hex:'#fcfff6'},{id:'H19',hex:'#f2eee5'},{id:'H20',hex:'#96a09f'},{id:'H21',hex:'#f8fbe6'},{id:'H22',hex:'#cacad2'},{id:'H23',hex:'#9b9c94'},
        {id:'M1',hex:'#bbc6b6'},{id:'M2',hex:'#909994'},{id:'M3',hex:'#697e81'},{id:'M4',hex:'#e0d4bc'},{id:'M5',hex:'#d1ccaf'},{id:'M6',hex:'#b0aa86'},{id:'M7',hex:'#b0a796'},{id:'M8',hex:'#ae8082'},{id:'M9',hex:'#a68862'},{id:'M10',hex:'#c4b3bb'},{id:'M11',hex:'#9d7693'},{id:'M12',hex:'#644b51'},{id:'M13',hex:'#c79266'},{id:'M14',hex:'#c27563'},{id:'M15',hex:'#747d7a'},
        // Pç³»åˆ— (ç å…‰)
        {id:'P1',hex:'#F9F9F9'},{id:'P2',hex:'#ABABAB'},{id:'P3',hex:'#B6DBAF'},{id:'P4',hex:'#FEA2A3'},{id:'P5',hex:'#EB903F'},{id:'P6',hex:'#63CEA2'},{id:'P7',hex:'#E79273'},{id:'P8',hex:'#ECDB59'},{id:'P9',hex:'#DBD9DA'},{id:'P10',hex:'#DBC7EA'},{id:'P11',hex:'#F1E9D4'},{id:'P12',hex:'#E9EDEE'},{id:'P13',hex:'#ADCBF1'},{id:'P14',hex:'#337BAD'},{id:'P15',hex:'#668575'},{id:'P16',hex:'#FDC24E'},{id:'P17',hex:'#FDA42E'},{id:'P18',hex:'#FEBDA7'},{id:'P19',hex:'#FFDEE9'},{id:'P20',hex:'#FCBFD1'},{id:'P21',hex:'#E8BEC2'},{id:'P22',hex:'#DFAAA4'},{id:'P23',hex:'#A3656A'},
        // Qç³»åˆ— (æ¸©å˜)
        {id:'Q1',hex:'#F2A5E8'},{id:'Q2',hex:'#E9EC91'},{id:'Q3',hex:'#FFFF00'},{id:'Q4',hex:'#FFEBFA'},{id:'Q5',hex:'#76CEDE'},
        // Rç³»åˆ— (é€æ˜æœå†»æ°´æ™¶)
        {id:'R1',hex:'#D40E1F'},{id:'R2',hex:'#F13484'},{id:'R3',hex:'#FB852B'},{id:'R4',hex:'#F8ED33'},{id:'R5',hex:'#32C958'},{id:'R6',hex:'#1EBA93'},{id:'R7',hex:'#1D779C'},{id:'R8',hex:'#1960C8'},{id:'R9',hex:'#945AB1'},{id:'R10',hex:'#F8DA54'},{id:'R11',hex:'#FCECF7'},{id:'R12',hex:'#D8D4D3'},{id:'R13',hex:'#56534E'},{id:'R14',hex:'#A3E7DC'},{id:'R15',hex:'#78CEE7'},{id:'R16',hex:'#3FCDCE'},{id:'R17',hex:'#4E8379'},{id:'R18',hex:'#7DCA9C'},{id:'R19',hex:'#C8E664'},{id:'R20',hex:'#E3CCBA'},{id:'R21',hex:'#A17140'},{id:'R22',hex:'#6B372C'},{id:'R23',hex:'#F6BB6F'},{id:'R24',hex:'#F3C6C0'},{id:'R25',hex:'#C76A62'},{id:'R26',hex:'#D093BC'},{id:'R27',hex:'#E58EAE'},{id:'R28',hex:'#9F85CF'},
        // Tç³»åˆ— (é€æ˜)
        {id:'T1',hex:'#FCFDFF'},
        // Yç³»åˆ— (å¤œå…‰)
        {id:'Y1',hex:'#FF6FB7'},{id:'Y2',hex:'#FDB583'},{id:'Y3',hex:'#D8FCA4'},{id:'Y4',hex:'#91DAFB'},{id:'Y5',hex:'#E987EA'},{id:'Y6',hex:'#F7D4B8'},{id:'Y7',hex:'#F1FA7D'},{id:'Y8',hex:'#5EE88C'},{id:'Y9',hex:'#F8F5FE'},
        // ZGç³»åˆ— (å…‰å˜)
        {id:'ZG1',hex:'#DAABB3'},{id:'ZG2',hex:'#D6AA87'},{id:'ZG3',hex:'#C1BD8D'},{id:'ZG4',hex:'#96B69F'},{id:'ZG5',hex:'#849DC6'},{id:'ZG6',hex:'#94BFE2'},{id:'ZG7',hex:'#E2A9D2'},{id:'ZG8',hex:'#AB91C0'}
    ];

    let data = JSON.parse(localStorage.getItem('bead_v_sort')) || MARD_DB.map(i => ({...i, w: 0, totalUsed: 0, logs: [], monitor: true}));
    
    // åŒæ­¥æ–°è‰²å·ï¼šæ£€æŸ¥ MARD_DB ä¸­æ˜¯å¦æœ‰æ–°è‰²å·æœªåœ¨ data ä¸­
    MARD_DB.forEach(dbItem => {
        let existing = data.find(d => d.id === dbItem.id);
        if (!existing) {
            data.push({...dbItem, w: 0, totalUsed: 0, logs: [], monitor: true});
        } else {
            // ä¿®å¤ï¼šå¼ºåˆ¶æ›´æ–°è‰²å€¼ï¼Œè§£å†³æ—§æ•°æ®é¢œè‰²é”™è¯¯é—®é¢˜
            if(dbItem.hex) existing.hex = dbItem.hex;
            // ç¡®ä¿æ—§æ•°æ®ä¹Ÿæœ‰ monitor å­—æ®µ
            if(existing.monitor === undefined) existing.monitor = true;
        }
    });

    let threshold = parseFloat(localStorage.getItem('bead_threshold')) || 5;
    // document.getElementById('threshold').value = threshold; 
    let sel = new Set();
    let selectedSeries = new Set(); // New series filter
    let currentEditId = null;
    let currentRevertPlanId = null;
    let currentDeletePlanId = null;
    let currentMoveOutPlanId = null;
    let pendingMergePlans = null; // Store plans to be merged while waiting for name input
    let beadSortField = 'id';
    let beadSortOrder = 'asc';

    function setBeadSort(field) {
        if (beadSortField === field) {
            beadSortOrder = beadSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            beadSortField = field;
            // Default sort direction: numbers desc, text asc
            if (field === 'stock' || field === 'used') {
                beadSortOrder = 'desc';
            } else {
                beadSortOrder = 'asc';
            }
        }
        render();
    }

    function formatTime(now) {
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const h = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        return `${y}/${m}/${d} ${h}:${min}:${s}`;
    }



    function createRow(item) {
        const isMonitored = item.monitor !== false;
        const isLow = isMonitored && (item.w < threshold);
        const grainCount = Math.round(item.w * 100);
        
        // è®¡ç®—æ€»è¡¥è´§
        let totalAdded = 0;
        if (item.totalAdded !== undefined) {
             totalAdded = item.totalAdded;
        } else {
            // å…¼å®¹é€»è¾‘ï¼šä» logs è®¡ç®—å¹¶åˆå§‹åŒ–
            if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type === 'add') totalAdded += (log.val || 0);
                 });
            }
            totalAdded = parseFloat(totalAdded.toFixed(2));
            // åˆå§‹åŒ–å­—æ®µä»¥ä¾¿åç»­ç´¯åŠ 
            item.totalAdded = totalAdded; 
        }
        
        // è®¡ç®—æ€»æ¶ˆè€—
        let totalUsed = 0;
        if (item.totalUsed !== undefined) {
             totalUsed = item.totalUsed;
        } else {
             // å…¼å®¹é€»è¾‘ï¼šä» logs è®¡ç®—å¹¶åˆå§‹åŒ–
             if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type !== 'add') {
                         const count = log.c || log.val || 0;
                         const g = parseFloat((count / 100).toFixed(2));
                         totalUsed += g;
                     }
                 });
             }
             totalUsed = parseFloat(totalUsed.toFixed(2));
             item.totalUsed = totalUsed; 
        }
        
        const monitorIcon = !isMonitored ? '<span style="font-size:12px; margin-left:2px; opacity:0.5;">ğŸ”•</span>' : '';
        const lowStyle = isLow ? 'color:#ff4d4f;' : 'color:#8c8c8c;';

        const row = document.createElement('div');
        row.className = `bead-card ${sel.has(item.id) ? 'selected' : ''}`;
        
        // Long Press / Selection Logic
        let pressTimer;
        const startPress = () => { 
            pressTimer = setTimeout(() => { 
                if (sel.size === 0) { // Only trigger if not already in selection mode (optional, but good UX)
                     toggleSelect(item.id); 
                     if (navigator.vibrate) navigator.vibrate(50);
                }
            }, 600); 
        };
        const cancelPress = () => { clearTimeout(pressTimer); };
        
        row.addEventListener('touchstart', startPress);
        row.addEventListener('touchend', cancelPress);
        row.addEventListener('touchmove', cancelPress);
        row.addEventListener('mousedown', startPress);
        row.addEventListener('mouseup', cancelPress);
        row.addEventListener('mouseleave', cancelPress);

        row.onclick = () => {
            if (sel.size > 0) {
                toggleSelect(item.id);
            }
        };
        
        row.innerHTML = `
            <div class="card-header">
                <div class="card-check"></div>
            </div>
            
            <div class="card-color-block" style="background:${item.hex};" onclick="if(sel.size===0) { event.stopPropagation(); manualEdit('${item.id}'); }"></div>

            <div class="card-info-section" style="padding: 0 2px;">
                 <!-- Color Code Line & Detail Icon -->
                 <div class="card-id-line" style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 4px;">
                     <span style="font-weight: bold; font-size: 14px; color: #333;">${item.id} ${monitorIcon}</span>
                     <button onclick="event.stopPropagation(); openHistory('${item.id}')" style="background:none; border:none; padding:2px; color:#888; cursor:pointer; display:flex; align-items:center; line-height: 0;">
                        <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <circle cx="10" cy="14" r="3"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                     </button>
                 </div>

                 <!-- Weight & Grain -->
                 <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; white-space: nowrap;">
                     <div class="card-weight" style="${lowStyle}; font-size: 14px; font-weight: bold;">${item.w}<span class="card-unit" style="font-size:10px;">g</span></div>
                     <div class="card-grain" style="font-size: 10px; color: #999; margin-left: 4px;">â‰ˆ${grainCount}ç²’</div>
                 </div>
            </div>
        `;
        return row;
    }

    function toggleSeries(s) {
        if (selectedSeries.has(s)) {
            selectedSeries.delete(s);
        } else {
            selectedSeries.add(s);
        }
        
        // Update UI
        const container = document.getElementById('series-filter-container');
        Array.from(container.children).forEach(chip => {
            if (selectedSeries.has(chip.innerText)) {
                chip.classList.add('selected');
            } else {
                chip.classList.remove('selected');
            }
        });
        
        render();
    }

    function toggleFilterVisibility() {
        const seriesContainer = document.getElementById('series-filter-container');
        const summaryBar = document.getElementById('bead-summary-bar');
        const btn = document.getElementById('btn-toggle-filter');
        
        // Toggle based on current state (assuming both sync, or base on summaryBar)
        if (summaryBar.style.display === 'none') {
            seriesContainer.style.display = 'flex';
            summaryBar.style.display = 'block';
            btn.style.background = '#e6f7ff';
            btn.style.borderColor = '#91d5ff';
        } else {
            seriesContainer.style.display = 'none';
            summaryBar.style.display = 'none';
            btn.style.background = '#fff';
            btn.style.borderColor = '#ddd';
        }
    }

    function render() {
        const q = document.getElementById('search').value.toUpperCase();
        
        // è·å–å½“å‰ç³»åˆ—ç­›é€‰çŠ¶æ€
        let seriesMode = document.getElementById('seriesFilter').value;
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('bead_series_filter', seriesMode);

        // Update series chips visibility
        const extraSeries = ['P', 'Q', 'R', 'T', 'Y', 'ZG'];
        const container = document.getElementById('series-filter-container');
        if (container) {
            Array.from(container.children).forEach(chip => {
                const s = chip.innerText;
                if (extraSeries.includes(s)) {
                    // Hide special series if mode is 221
                    if (seriesMode === '221') {
                        chip.style.display = 'none';
                        // If hidden chip was selected, deselect it
                        if (selectedSeries.has(s)) {
                            selectedSeries.delete(s);
                            chip.classList.remove('selected');
                        }
                    } else {
                        chip.style.display = ''; // Restore visibility
                    }
                }
            });
        }

        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        // Update Selection Mode Class
        if (sel.size > 0) {
            if(grid.parentElement) grid.parentElement.classList.add('selection-mode');
        } else {
            if(grid.parentElement) grid.parentElement.classList.remove('selection-mode');
        }
        
        // 1. Filter by Series
        let displayData = data.filter(item => {
            const match = item.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';

            // New: Checkbox filterä¼˜å…ˆ
            if (selectedSeries.size > 0) {
                return selectedSeries.has(series);
            }

            if (seriesMode === 'all') return true;
            // Mard 221 æ¨¡å¼ä¸‹æ’é™¤ P, Q, R, T, Y, ZG ç³»åˆ—
            return !extraSeries.includes(series);
        });

        // 2. Pre-calculate Stats & Contextual Summary
        let sumStock = 0;
        let sumUsed = 0;
        let sumLow = 0;

        displayData.forEach(item => {
            // Ensure totalUsed is calculated (logic from createRow)
            if (item.totalUsed === undefined) {
                 let tu = 0;
                 if(item.logs) {
                     item.logs.forEach(log => {
                         if(log.type !== 'add') {
                             const count = log.c || log.val || 0;
                             const g = parseFloat((count / 100).toFixed(2));
                             tu += g;
                         }
                     });
                 }
                 item.totalUsed = parseFloat(tu.toFixed(2));
            }

            sumStock += item.w;
            sumUsed += (item.totalUsed || 0);

            // Low Stock Check (monitor enabled and below threshold)
            if (item.monitor !== false && item.w < threshold) {
                sumLow++;
            }
        });

        // Update Summary Bar
        const elSumTotal = document.getElementById('sum-total-stock');
        const elSumUsed = document.getElementById('sum-total-used');
        const elSumLow = document.getElementById('sum-low-count');
        if(elSumTotal) elSumTotal.innerText = sumStock.toFixed(0);
        if(elSumUsed) elSumUsed.innerText = sumUsed.toFixed(0);
        if(elSumLow) elSumLow.innerText = sumLow;

        // 3. Calculate Badge Low Count (Dropdown only, ignore Chips for consistency with badge behavior)
        let badgeLowCount = 0;
        data.forEach(d => {
             if (d.monitor === false || d.w >= threshold) return;
             if (seriesMode === 'all') {
                 badgeLowCount++;
                 return;
             }
             const match = d.id.match(/^[A-Z]+/);
             const series = match ? match[0] : '';
             if (!extraSeries.includes(series)) {
                 badgeLowCount++;
             }
        });
        const elCountLow = document.getElementById('count-low');
        if(elCountLow) elCountLow.innerText = badgeLowCount;

        // 4. Update Sort Buttons UI
        const sortMap = {
            'id': 'btn-sort-id',
            'stock': 'btn-sort-stock',
            'used': 'btn-sort-used'
        };
        
        Object.keys(sortMap).forEach(key => {
            const btn = document.getElementById(sortMap[key]);
            if(btn) {
                if (key === beadSortField) {
                     btn.classList.add('active');
                     const arrow = btn.querySelector('.sort-arrow');
                     if(arrow) arrow.innerText = beadSortOrder === 'asc' ? 'â†‘' : 'â†“';
                } else {
                     btn.classList.remove('active');
                     const arrow = btn.querySelector('.sort-arrow');
                     if(arrow) arrow.innerText = '';
                }
            }
        });

        // 5. Sort Data
        displayData.sort((a, b) => {
            let valA, valB;
            
            if (beadSortField === 'stock') {
                valA = a.w; valB = b.w;
                return beadSortOrder === 'asc' ? valA - valB : valB - valA;
            } else if (beadSortField === 'used') {
                valA = a.totalUsed || 0; valB = b.totalUsed || 0;
                return beadSortOrder === 'asc' ? valA - valB : valB - valA;
            } else {
                // ID
                valA = a.id; valB = b.id;
                const cmp = valA.localeCompare(valB, undefined, {numeric: true, sensitivity: 'base'});
                return beadSortOrder === 'asc' ? cmp : -cmp;
            }
        });

        // 6. Render Grid (Apply Search Filter)
        displayData.forEach(item => {
            if (item.id.includes(q)) {
                grid.appendChild(createRow(item));
            }
        });
        
        save();
    }



    function toggleSelect(id) {
        sel.has(id) ? sel.delete(id) : sel.add(id);
        updateFooter();
        render();
    }
    
    function cancelSelection() {
        sel.clear();
        updateFooter();
        render();
    }

    function batchSetMonitor(enable) {
        if (sel.size === 0) return;
        sel.forEach(id => {
            const item = data.find(d => d.id === id);
            if(item) item.monitor = enable;
        });
        save();
        cancelSelection();
        showToast(enable ? "å·²å¼€å¯é€‰ä¸­è‰²å·çš„é˜ˆå€¼æé†’" : "å·²å…³é—­é€‰ä¸­è‰²å·çš„é˜ˆå€¼æé†’");
    }
    
    function updateFooter() {
        document.getElementById('footer').style.display = sel.size > 0 ? 'flex' : 'none';
        document.getElementById('selNum').innerText = sel.size;
    }

    function quickAdd(id) {
        const item = data.find(d => d.id === id);
        const addVal = 10;
        item.w = parseFloat((item.w + addVal).toFixed(2));
        // ç»´æŠ¤æ€»è¡¥è´§é‡
        item.totalAdded = parseFloat(((item.totalAdded || 0) + addVal).toFixed(2));
        
        // è®°å½•è¡¥è´§æ—¥å¿—
        const now = new Date();
        const dateStr = formatTime(now);
        if(!item.logs) item.logs = [];
        item.logs.push({ d: dateStr, type: 'add', val: addVal });
        if(item.logs.length > 20) item.logs.shift(); // å¢åŠ æ—¥å¿—ä¿ç•™æ¡æ•°
        
        save(); // å¢åŠ ä¿å­˜
        render();
        showToast("åº“å­˜å·²å¢åŠ ");
    }

    function manualEdit(id) {
        currentEditId = id;
        const item = data.find(d => d.id === id);
        document.getElementById('editWeightModalTitle').innerText = `ä¿®æ”¹åº“å­˜é‡é‡ ${id}`;
        const input = document.getElementById('editWeightInput');
        input.value = item.w;
        showModal('editWeightModal');
        setTimeout(() => input.select(), 50);
        
        // ç»‘å®šå›è½¦äº‹ä»¶
        input.onkeydown = function(e) {
            if(e.key === 'Enter') submitEditWeight();
        }
    }

    function openRestockModal() {
        if(!currentEditId) return;
        document.getElementById('restockTitle').innerText = `æ­£åœ¨ä¸ºè‰²å· [${currentEditId}] è¡¥è´§`;
        document.getElementById('restockInput').value = '';
        showModal('restockModal');
        setTimeout(() => document.getElementById('restockInput').focus(), 50);
        
        document.getElementById('restockInput').onkeydown = function(e) {
            if(e.key === 'Enter') submitRestock();
        }
    }

    function submitRestock() {
        const val = parseFloat(document.getElementById('restockInput').value);
        if(!currentEditId || isNaN(val) || val <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è¡¥è´§é‡é‡");
            return;
        }
        
        const item = data.find(d => d.id === currentEditId);
        item.w = parseFloat((item.w + val).toFixed(2));
        // ç»´æŠ¤æ€»è¡¥è´§é‡
        item.totalAdded = parseFloat(((item.totalAdded || 0) + val).toFixed(2));
        
        // è®°å½•æ—¥å¿—
        const now = new Date();
        const dateStr = formatTime(now);
        if(!item.logs) item.logs = [];
        item.logs.push({ d: dateStr, type: 'add', val: val });
        if(item.logs.length > 20) item.logs.shift();
        
        save();
        render();
        closeAllModals();
        showToast(`å·²æˆåŠŸè¡¥è´§ ${val}g`);
    }

    function openHistory(id) {
        const item = data.find(d => d.id === id);
        if(!item) return; // å®¹é”™å¤„ç†

        // 1. è®¾ç½®æ ‡é¢˜å’Œæ¦‚è§ˆæ•°æ®
        document.getElementById('historyTitle').innerHTML = `è‰²å· ${id} æ˜ç»†`;
        document.getElementById('hist-stock').innerText = (item.w || 0) + 'g';
        document.getElementById('hist-used').innerText = (item.totalUsed || 0) + 'g';
        
        // è®¡ç®—æ€»è¡¥å……ï¼šä¼˜å…ˆä½¿ç”¨æŒä¹…åŒ–å­—æ®µ
        let totalAdded = 0;
        if (item.totalAdded !== undefined) {
            totalAdded = item.totalAdded;
        } else {
            if(item.logs) {
                item.logs.forEach(log => {
                    if(log.type === 'add') {
                        totalAdded += (log.val || 0);
                    }
                });
            }
        }
        document.getElementById('hist-added').innerText = parseFloat(totalAdded.toFixed(2)) + 'g';

        // è®¡ç®—æ€»æ¶ˆè€—
        let totalUsed = 0;
        if (item.totalUsed !== undefined) {
             totalUsed = item.totalUsed;
        } else {
             if(item.logs) {
                 item.logs.forEach(log => {
                     if(log.type !== 'add') {
                         const count = log.c || log.val || 0;
                         const g = parseFloat((count / 100).toFixed(2));
                         totalUsed += g;
                     }
                 });
             }
        }
        document.getElementById('hist-used').innerText = parseFloat(totalUsed.toFixed(2)) + 'g';

        // 2. æ¸²æŸ“è®°å½•è¡¨æ ¼
        const tbody = document.getElementById('historyList');
        tbody.innerHTML = '';
        
        if (item.logs && item.logs.length > 0) {
            // ç»™æ—¥å¿—åŠ ä¸ŠåŸå§‹ç´¢å¼•ï¼Œæ–¹ä¾¿åˆ é™¤
            const logsWithIdx = item.logs.map((log, idx) => ({...log, idx}));
            
            // å€’åºæ˜¾ç¤º
            logsWithIdx.reverse().forEach(log => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f0f0f0';
                
                // --- æ—¶é—´åˆ— ---
                const tdTime = document.createElement('td');
                tdTime.style.padding = '6px 2px';
                tdTime.style.color = '#666';
                tdTime.style.fontSize = '11px';
                tdTime.style.whiteSpace = 'nowrap';
                
                let timeStr = log.d;
                if (!timeStr && log.date) {
                    try {
                        const dateObj = new Date(log.date);
                        timeStr = formatTime(dateObj);
                    } catch(e) {
                        timeStr = log.date;
                    }
                }
                
                if (timeStr && timeStr.indexOf(' ') > -1) {
                    const parts = timeStr.split(' ');
                    const datePart = parts[0];
                    const timePart = parts.slice(1).join(' ');
                    tdTime.innerHTML = `<div style="line-height:1.2">${datePart}<br><span style="font-size:10px; color:#999;">${timePart}</span></div>`;
                } else {
                    tdTime.innerText = timeStr || '-';
                }
                tr.appendChild(tdTime);

                // --- å›¾çº¸åç§°åˆ— ---
                const tdDrawing = document.createElement('td');
                tdDrawing.style.padding = '6px 2px';
                tdDrawing.style.textAlign = 'center';
                tdDrawing.style.color = '#666';
                tdDrawing.style.fontSize = '12px';
                tdDrawing.style.whiteSpace = 'nowrap';
                tdDrawing.innerText = log.drawingName || '';
                tr.appendChild(tdDrawing);
                
                // --- æ“ä½œç±»å‹åˆ— ---
                const tdType = document.createElement('td');
                tdType.style.padding = '6px 2px';
                tdType.style.textAlign = 'center';
                tdType.style.whiteSpace = 'nowrap';
                
                let typeText = '';
                let typeColor = '#333';
                
                if (log.type === 'add') {
                    typeText = 'è¡¥è´§';
                    typeColor = '#52c41a'; // ç»¿è‰²
                } else {
                    typeText = 'æ¶ˆè€—';
                    typeColor = '#ff4d4f'; // çº¢è‰²
                }
                
                tdType.innerHTML = `<span style="background:${typeColor}15; color:${typeColor}; padding:2px 6px; border-radius:4px; font-size:11px;">${typeText}</span>`;
                tr.appendChild(tdType);
                
                // --- é‡é‡/ç²’æ•°åŠåˆ é™¤åˆ— ---
                const tdVal = document.createElement('td');
                tdVal.style.padding = '6px 2px';
                tdVal.style.textAlign = 'right';
                tdVal.style.whiteSpace = 'nowrap';
                
                let valHtml = '';
                if (log.type === 'add') {
                    valHtml = `<div style="line-height:1.2"><span style="color:#333;">+${log.val}g</span></div>`;
                } else {
                    const count = log.c || log.val || 0;
                    const weight = (count / 100).toFixed(2);
                    // ç¬¬ä¸€è¡Œæ˜¾ç¤ºé‡é‡ï¼Œç¬¬äºŒè¡Œæ˜¾ç¤ºç²’æ•°
                    valHtml = `<div style="line-height:1.2"><span style="color:#333;">-${weight}g</span><br><span style="font-size:10px; color:#999;">(â‰ˆ${count}ç²’)</span></div>`;
                }
                
                // åˆ é™¤æŒ‰é’®
                const delBtn = `<button onclick="deleteLog('${id}', ${log.idx})" style="margin-left:8px; border:none; background:none; color:#999; cursor:pointer; font-size:16px; padding:0;">Ã—</button>`;
                
                tdVal.innerHTML = `<div style="display:flex; align-items:center; justify-content:flex-end;"><div style="white-space:nowrap;">${valHtml}</div>${delBtn}</div>`;
                tr.appendChild(tdVal);
                
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="padding:20px; text-align:center; color:#999;">æš‚æ— è®°å½•</td>';
            tbody.appendChild(tr);
        }
        
        showModal('historyModal');
    }

    function deleteLog(id, logIdx) {
        // One-click delete (no confirm)
        
        const item = data.find(d => d.id === id);
        if(!item || !item.logs || !item.logs[logIdx]) return;
        
        const log = item.logs[logIdx];
        
        if (log.type === 'add') {
            // å›æ»šè¡¥è´§ï¼šå‡å°‘åº“å­˜
            item.w = Math.max(0, parseFloat((item.w - log.val).toFixed(2)));
            // å›æ»šæ€»è¡¥è´§
            item.totalAdded = Math.max(0, parseFloat(((item.totalAdded || 0) - log.val).toFixed(2)));
        } else {
            // å›æ»šæ¶ˆè€—ï¼šå¢åŠ åº“å­˜ï¼Œå‡å°‘ç´¯è®¡æ¶ˆè€—
            const count = log.c || log.val || 0;
            const g = parseFloat((count / 100).toFixed(2));
            item.w = parseFloat((item.w + g).toFixed(2));
            item.totalUsed = Math.max(0, parseFloat((item.totalUsed - g).toFixed(2)));
        }
        
        // åˆ é™¤è®°å½•
        item.logs.splice(logIdx, 1);
        
        save();
        render();
        // è‡ªåŠ¨å…³é—­å¼¹çª—
        closeAllModals();
        showToast("åˆ é™¤æˆåŠŸï¼Œåº“å­˜å·²å›æ»š");
    }

    function submitEditWeight() {
        if(!currentEditId) return;
        const input = document.getElementById('editWeightInput');
        const val = parseFloat(input.value);
        
        // ä¿æŒåŸæœ‰é€»è¾‘ï¼šè¾“å…¥æ— æ•ˆæ•°å­—åˆ™è§†ä¸º0
        const finalVal = (!isNaN(val) && val >= 0) ? val : 0;
        
        const item = data.find(d => d.id === currentEditId);
        if(item) {
            const oldVal = item.w;
            const diff = finalVal - oldVal;
            
            // æ›´æ–°åº“å­˜
            item.w = parseFloat(finalVal.toFixed(2));
            
            // è‡ªåŠ¨è®°å½•æ—¥å¿— (å¿½ç•¥æå°å·®å¼‚)
            if (Math.abs(diff) > 0.001) {
                const now = new Date();
                const dateStr = formatTime(now);
                if(!item.logs) item.logs = [];
                
                if (diff > 0) {
                    const addedVal = parseFloat(diff.toFixed(2));
                    // å¢åŠ åº“å­˜ -> è§†ä¸ºè¡¥è´§
                    item.logs.push({ d: dateStr, type: 'add', val: addedVal, isManual: true });
                    // ç»´æŠ¤æ€»è¡¥è´§é‡
                    item.totalAdded = parseFloat(((item.totalAdded || 0) + addedVal).toFixed(2));
                } else {
                    // å‡å°‘åº“å­˜ -> è§†ä¸ºæ¶ˆè€—
                    const loss = -diff;
                    // æ›´æ–°ç´¯è®¡æ¶ˆè€—
                    item.totalUsed = parseFloat(((item.totalUsed || 0) + loss).toFixed(2));
                    // è®°å½•ä¸ºæ¶ˆè€— (æŠ˜ç®—ä¸ºç²’æ•°ï¼Œå‡è®¾ 1g = 100 ç²’)
                    item.logs.push({ d: dateStr, c: Math.round(loss * 100), isManual: true });
                }
                
                if(item.logs.length > 20) item.logs.shift();
            }
            
            render();
        }
        
        closeAllModals();
        currentEditId = null;
        input.onkeydown = null;
        showToast("åº“å­˜ä¿®æ”¹æˆåŠŸ");
    }

    function openConsumeModal() {
        const listDiv = document.getElementById('modalList');
        listDiv.innerHTML = '';
        
        if (sel.size === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px;">æœªé€‰æ‹©ä»»ä½•è‰²å·</div>';
            showModal('consumeModal');
            return;
        }

        sel.forEach(id => {
            const item = data.find(d => d.id === id);
            const currentStockGrains = Math.round(item.w * 100); // å½“å‰åº“å­˜ç²’æ•°
            
            const row = document.createElement('div');
            row.className = 'modal-row';
            // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼è¦†ç›–é»˜è®¤ modal-row
            row.style.cssText = 'display:flex; flex-direction:column; padding: 12px; border-bottom: 1px solid #f0f0f0; background:white; align-items: stretch;';
            
            row.innerHTML = `
                <div style="display:flex; align-items:center; justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap: 12px;">
                        <div class="swatch" style="width:28px; height:28px; background:${item.hex}; border-radius:50%; border:1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>
                        <div style="display:flex; flex-direction:column;">
                            <b style="font-size:16px; color:#333;">${id}</b>
                            <span style="font-size:11px; color:#999;">åº“å­˜: ${currentStockGrains}ç²’</span>
                        </div>
                    </div>
                    <div style="position:relative;">
                        <input type="number" class="consume-input" data-id="${id}" data-stock="${currentStockGrains}" placeholder="0" oninput="checkConsumeLimit(this)" 
                               style="width: 70px; padding: 8px 5px; border: 1px solid #e0e0e0; border-radius: 8px; text-align: center; font-size: 16px; font-weight:bold; color:#333; outline:none; background:#f9fafb; transition: all 0.2s;">
                    </div>
                </div>
                <div class="limit-warn" id="warn-${id}" style="width:100%; color:#ff4d4f; font-size:11px; margin-top:8px; display:none; text-align:right; background:#fff1f0; padding:4px 8px; border-radius:4px;">
                     âš ï¸ æ¶ˆè€—é‡è¶…è¿‡åº“å­˜ (${currentStockGrains})
                </div>
            `;
            listDiv.appendChild(row);
        });
        
        // å»é™¤æœ€åä¸€è¡Œè¾¹æ¡†
        if(listDiv.lastChild) listDiv.lastChild.style.borderBottom = 'none';
        
        showModal('consumeModal');
        
        // è‡ªåŠ¨èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
        setTimeout(() => {
            const firstInput = listDiv.querySelector('input');
            if(firstInput) firstInput.focus();
        }, 100);
    }

    function checkConsumeLimit(input) {
        const val = parseFloat(input.value) || 0;
        const stock = parseFloat(input.getAttribute('data-stock'));
        const id = input.getAttribute('data-id');
        const warnEl = document.getElementById(`warn-${id}`);
        
        if (val > stock) {
            warnEl.style.display = 'block';
        } else {
            warnEl.style.display = 'none';
        }
    }

    function submitConsume() {
        const inputs = document.querySelectorAll('.consume-input');
        const now = new Date();
        const dateStr = formatTime(now);
        
        inputs.forEach(input => {
            const id = input.getAttribute('data-id');
            const count = parseFloat(input.value) || 0;
            if(count > 0) {
                const item = data.find(d => d.id === id);
                const g = count / 100;
                item.w = Math.max(0, parseFloat((item.w - g).toFixed(2)));
                item.totalUsed = parseFloat(((item.totalUsed || 0) + g).toFixed(2));
                if(!item.logs) item.logs = [];
                item.logs.push({ d: dateStr, c: count });
                if(item.logs.length > 10) item.logs.shift();
            }
        });
        closeAllModals();
        sel.clear();
        document.getElementById('footer').style.display = 'none';
        save();
        render();
        showToast("åº“å­˜æ‰£é™¤æˆåŠŸ");
    }

    // --- Generic Confirmation Modal ---
    function showConfirmModal(title, message, onConfirm) {
        document.getElementById('customConfirmTitle').innerText = title;
        document.getElementById('customConfirmMessage').innerText = message;
        
        const okBtn = document.getElementById('customConfirmOkBtn');
        // Reset onclick to avoid multiple bindings
        okBtn.onclick = () => {
            if (onConfirm) onConfirm();
            closeAllModals();
        };
        
        showModal('customConfirmModal');
    }

    function showModal(id) {
        document.getElementById('mask').style.display = 'block';
        document.getElementById(id).style.display = 'block';
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(el => el.style.display = 'none');
        document.getElementById('mask').style.display = 'none';
    }

    // å…¼å®¹æ—§å‡½æ•°è°ƒç”¨ï¼Œé˜²æ­¢é—æ¼
    function closeModal() { closeAllModals(); }

    function save() { localStorage.setItem('bead_v_sort', JSON.stringify(data)); }

    // --- æ•°æ®ç®¡ç†åŠŸèƒ½ ---
    function openDataModal(tab) {
        showModal('dataModal');
        switchDataTab(tab);
        // Clean up previous inputs
        if(tab !== 'backup') {
            document.getElementById('restoreInput').value = '';
        }
    }

    function switchDataTab(tab) {
        document.getElementById('tabBackup').className = tab==='backup' ? 'm-btn m-btn-primary' : 'm-btn m-btn-ghost';
        document.getElementById('tabRestore').className = tab==='restore' ? 'm-btn m-btn-primary' : 'm-btn m-btn-ghost';
        document.getElementById('viewBackup').style.display = tab==='backup' ? 'block' : 'none';
        document.getElementById('viewRestore').style.display = tab==='restore' ? 'block' : 'none';
    }

    function execRestore() {
        let content = document.getElementById('restoreInput').value;
        if (!content) return;
        
        showModal('importConfirmModal');
    }

    function confirmImport() {
        let content = document.getElementById('restoreInput').value;
        if (!content) return;

        // ç§»é™¤å¯èƒ½çš„ BOM
        if (content.charCodeAt(0) === 0xFEFF) {
            content = content.slice(1);
        }
        content = content.trim();

        let jsonStr = content;

        // æ£€æµ‹æ˜¯å¦ä¸º CSV å•å…ƒæ ¼å°è£…æ ¼å¼ (ä»¥å¼•å·å¼€å¤´å’Œç»“å°¾)
        if (content.startsWith('"') && content.endsWith('"')) {
            // ç§»é™¤é¦–å°¾å¼•å·
            let inner = content.substring(1, content.length - 1);
            // è¿˜åŸè½¬ä¹‰çš„å¼•å· ("" -> ")
            jsonStr = inner.replace(/""/g, '"');
        }

        try {
            const backupData = JSON.parse(jsonStr);
            let restoreItems = [];
            let newThreshold = null;
            let newPlans = null;
            let newAiData = null;

            // å…¼å®¹ç›´æ¥çš„æ•°ç»„æ ¼å¼ (æ—§ç‰ˆ JSON) æˆ–æ–°çš„å¯¹è±¡æ ¼å¼
            if (Array.isArray(backupData)) {
                restoreItems = backupData;
            } else if (backupData.items && Array.isArray(backupData.items)) {
                restoreItems = backupData.items;
                if (backupData.threshold !== undefined) newThreshold = backupData.threshold;
                if (backupData.plans) newPlans = backupData.plans;
                if (backupData.aiData) newAiData = backupData.aiData;
            } else if (backupData.data && Array.isArray(backupData.data)) {
                 // å…¼å®¹ä¹‹å‰å°è¯•è¿‡çš„ JSON ç»“æ„ { data: [...] }
                 restoreItems = backupData.data;
                 if (backupData.config && backupData.config.threshold) newThreshold = backupData.config.threshold;
            } else {
                throw new Error("æ— æ•ˆçš„æ•°æ®æ ¼å¼");
            }

            // æ„å»ºå¿«é€ŸæŸ¥æ‰¾è¡¨
            const backupMap = new Map(restoreItems.map(i => [i.id, i]));
            let restoreCount = 0;

            // æ›´æ–°ç°æœ‰æ•°æ®
            data.forEach(item => {
                if (backupMap.has(item.id)) {
                    const backupItem = backupMap.get(item.id);
                    item.w = backupItem.w !== undefined ? backupItem.w : 0;
                    item.monitor = backupItem.monitor !== undefined ? backupItem.monitor : true;
                    item.logs = backupItem.logs || [];
                    item.totalAdded = backupItem.totalAdded || 0;
                    item.totalUsed = backupItem.totalUsed || 0;
                    restoreCount++;
                } else {
                    // å¦‚æœå¤‡ä»½ä¸­æ²¡æœ‰è¯¥è‰²å·ï¼Œé‡ç½®ä¸ºåˆå§‹çŠ¶æ€
                    item.w = 0;
                    item.monitor = true;
                    item.logs = [];
                    item.totalAdded = 0;
                    item.totalUsed = 0;
                }
            });

            // æ¢å¤é˜ˆå€¼é…ç½®
            if (newThreshold !== null) {
                threshold = parseFloat(newThreshold);
                localStorage.setItem('bead_threshold', threshold);
                const thresholdInput = document.getElementById('threshold');
                if(thresholdInput) thresholdInput.value = threshold;
            }

            // æ¢å¤è®¡åˆ’æ•°æ®
            if (newPlans) {
                localStorage.setItem('bead_plans', JSON.stringify(newPlans));
            }

            // æ¢å¤AIé…ç½®
            if (newAiData) {
                localStorage.setItem('ai_usage_data', JSON.stringify(newAiData));
            }

            save();
            render();
            if (typeof renderPlans === 'function') renderPlans();
            closeAllModals();
            
            let msg = `æ•°æ®å¯¼å…¥æˆåŠŸ (æ¢å¤ ${restoreCount} ä¸ªè‰²å·`;
            if(newPlans) msg += `ï¼Œ${newPlans.length} ä¸ªè®¡åˆ’`;
            msg += ')';
            showToast(msg);

        } catch (e) {
            console.error(e);
            alert("æ•°æ®è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message);
        }
    }

    async function downloadBackupFile() {
        // æ„å»ºå®Œæ•´çš„å¤‡ä»½å¯¹è±¡
        const backupObj = {
            version: "2.1",
            timestamp: new Date().toISOString(),
            threshold: threshold,
            items: data,
            plans: JSON.parse(localStorage.getItem('bead_plans') || '[]'),
            // Use ModelUsageManager.getData() to ensure we export the full structure (keys, names, usage)
            // even if it was just migrated in memory and not yet saved to disk.
            aiData: ModelUsageManager.getData()
        };

        const jsonStr = JSON.stringify(backupObj, null, 2);
        const fileName = `Mard_Inventory_Backup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.txt`;
        
        
        // Strategy 1: HTML5+ (App) - File System Download (Direct to Downloads)
        if (window.plus && window.plus.io) {
             plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS, function(fs) {
                fs.root.getFile(fileName, {create: true, exclusive: false}, function(fileEntry) {
                    fileEntry.createWriter(function(writer) {
                        writer.onwrite = function() {
                            // Show full path to user
                            const fullPath = fileEntry.fullPath; // e.g., /storage/emulated/0/Android/data/... or /Downloads/...
                            // Usually PUBLIC_DOWNLOADS maps to /storage/emulated/0/Download/ on standard Android
                            // But fileEntry.fullPath might be internal path. 
                            // fileEntry.toURL() gives file://...
                            
                            // Let's try to give a user-friendly path hint
                            showToast(`å¤‡ä»½å·²å¯¼å‡ºï¼\nè·¯å¾„: æ‰‹æœºå­˜å‚¨/Download/${fileName}`);
                            alert(`å¤‡ä»½æˆåŠŸï¼\n\næ–‡ä»¶å·²ä¿å­˜è‡³æ‰‹æœºã€ä¸‹è½½/Downloadã€‘æ–‡ä»¶å¤¹ã€‚\n\næ–‡ä»¶å: ${fileName}`);
                        };
                        writer.onerror = function(e) {
                             alert("ä¿å­˜å¤±è´¥: " + e.message);
                        };
                        writer.write(jsonStr);
                    }, function(e){ alert("åˆ›å»ºå†™å…¥å™¨å¤±è´¥: " + e.message); });
                }, function(e){ alert("åˆ›å»ºæ–‡ä»¶å¤±è´¥: " + e.message); });
            }, function(e) {
                 // Fallback to Private Doc if Downloads not accessible
                 plus.io.requestFileSystem(plus.io.PRIVATE_DOC, function(fs) {
                    fs.root.getFile(fileName, {create: true}, function(fileEntry) {
                         fileEntry.createWriter(function(writer) {
                             writer.onwrite = function() {
                                 const path = fileEntry.fullPath;
                                 showToast(`å·²ä¿å­˜è‡³åº”ç”¨ç§æœ‰ç›®å½•`);
                                 alert(`å¤‡ä»½å·²ä¿å­˜ï¼\n\nè·¯å¾„: ${path}\n\n(æ³¨æ„: ç§æœ‰ç›®å½•æ–‡ä»¶å¸è½½åº”ç”¨åä¼šè¢«åˆ é™¤)`);
                             };
                             writer.write(jsonStr);
                         });
                    });
                 }, function(e2) { alert("æ— æ³•è®¿é—®å­˜å‚¨: " + e2.message); });
            });
            return;
        }

        // Strategy 2: Web Standard
        try {
            const blob = new Blob([jsonStr], {type: "text/plain;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 1000);
        } catch(e) {
            alert("å¯¼å‡ºå¤±è´¥: " + e.message);
        }
    }

    function loadBackupFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                // Store content in hidden textarea for execRestore logic
                document.getElementById('restoreInput').value = e.target.result;
                // Immediately ask to restore
                execRestore();
            };
            reader.readAsText(file);
        }
        input.value = '';
    }

    // --- æ‰¹é‡åˆå§‹å½•å…¥åŠŸèƒ½ ---
    function openBatchInput() {
        document.getElementById('batchInputText').value = '';
        showModal('batchInputModal');
    }

    function submitBatchInput() {
        const text = document.getElementById('batchInputText').value;
        const regex = /([A-Z]+[0-9]+)[^0-9\.]*(\d+(\.\d+)?)/gi;
        let match;
        let count = 0;
        while ((match = regex.exec(text)) !== null) {
            const id = match[1].toUpperCase();
            const w = parseFloat(match[2]);
            const item = data.find(d => d.id === id);
            if(item) {
                item.w = w;
                count++;
            }
        }
        save();
        render();
        closeAllModals();
        showToast(`å·²æ‰¹é‡æ›´æ–° ${count} ä¸ªè‰²å·çš„åº“å­˜`);
    }

    function copyLowStockText() {
        const el = document.getElementById('lowStockText');
        el.select();
        navigator.clipboard.writeText(el.value).then(() => showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
    }

    function openIgnoredModal() {
        const list = data.filter(d => d.monitor === false);
        const container = document.getElementById('ignoredList');
        container.innerHTML = '';
        
        if(list.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px;">å½“å‰æ²¡æœ‰å¿½ç•¥ä»»ä½•è‰²å·</div>';
        } else {
            list.forEach(item => {
                const row = document.createElement('div');
                row.className = 'modal-row';
                row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #f0f0f0; gap: 10px;';
                row.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; flex: 1; overflow: hidden;">
                        <div class="swatch" style="width:24px; height:24px; background:${item.hex}; border-radius:50%; border:1px solid #eee; flex-shrink: 0;"></div>
                        <span style="font-weight:bold; font-family:monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.id}</span>
                    </div>
                    <button onclick="restoreMonitor('${item.id}')" style="background:#fff; border:1px solid #ccc; color:#333; padding:6px 12px; border-radius:4px; font-size:13px; cursor:pointer; flex-shrink:0;">æ¢å¤æé†’</button>
                `;
                container.appendChild(row);
            });
        }
        showModal('ignoredModal');
    }

    function restoreMonitor(id) {
        const item = data.find(d => d.id === id);
        if(item) {
            item.monitor = true;
            save();
            render();
            openIgnoredModal(); // åˆ·æ–°åˆ—è¡¨
        }
    }

    function openLowStockModal() {
        // è·å–å½“å‰ç­›é€‰æ¨¡å¼
        const seriesMode = document.getElementById('seriesFilter').value;
        
        // ç­›é€‰é€»è¾‘ä¸ render ä¿æŒä¸€è‡´
        const lowList = data.filter(d => {
            // 1. ç›‘æ§å¼€å¯ä¸”ä½äºé˜ˆå€¼
            if (d.monitor === false || d.w >= threshold) return false;
            
            // 2. ç³»åˆ—ç­›é€‰
            if (seriesMode === 'all') return true;
            // Mard 221 æ¨¡å¼ä¸‹æ’é™¤ P, Q, R, T, Y, ZG ç³»åˆ—
            const match = d.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';
            const extraSeries = ['P', 'Q', 'R', 'T', 'Y', 'ZG'];
            return !extraSeries.includes(series);
        });

        const listDiv = document.getElementById('lowStockList');
        const headerDiv = document.getElementById('lowStockHeader');
        listDiv.innerHTML = '';

        if (lowList.length === 0) {
            headerDiv.style.display = 'none';
            listDiv.innerHTML = `
                <div style="padding:30px 10px; text-align:center; color:#999;">
                    <div style="font-size:24px; margin-bottom:10px;">ğŸ‰</div>
                    <div style="font-size:13px;">å½“å‰åº“å­˜å……è¶³</div>
                    <div style="font-size:11px; margin-top:5px;">æš‚æ— ä½äºé˜ˆå€¼ (${threshold}g) çš„è‰²å·</div>
                </div>
            `;
            // æ¸…ç©ºå¤åˆ¶å†…å®¹
            document.getElementById('lowStockText').value = '';
        } else {
            headerDiv.style.display = 'flex';
            lowList.forEach(item => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; align-items:center; padding:12px; border-bottom:1px solid #f0f0f0; background:white;';
                
                row.innerHTML = `
                    <div class="swatch" style="width:28px; height:28px; background:${item.hex}; border-radius:50%; border:1px solid #eee; margin-right:12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b style="font-size:16px; color:#333;">${item.id}</b>
                            <span style="font-size:14px; font-weight:bold; color:#ff4d4f;">${item.w}g</span>
                        </div>
                        <div style="font-size:11px; color:#999; margin-top:2px;">åº“å­˜ä¸è¶³ (é˜ˆå€¼ ${threshold}g)</div>
                    </div>
                `;
                listDiv.appendChild(row);
            });
            
            // å»é™¤æœ€åä¸€è¡Œè¾¹æ¡†
            if(listDiv.lastChild) listDiv.lastChild.style.borderBottom = 'none';

            // å‡†å¤‡å¤åˆ¶çš„æ–‡æœ¬å†…å®¹
            const copyText = lowList.map(d => `${d.id}: ${d.w}g`).join('\n');
            document.getElementById('lowStockText').value = copyText;
        }

        showModal('lowStockModal');
    }



    function renderStats() {
        // 0. åº”ç”¨ç­›é€‰é€»è¾‘ (ä¿æŒä¸ inventory é¡µé¢ä¸€è‡´)
        let seriesMode = document.getElementById('seriesFilter').value;
        // Sync stats dropdown to match
        const statsSelect = document.getElementById('statsSeriesFilter');
        if(statsSelect && statsSelect.value !== seriesMode) {
             statsSelect.value = seriesMode;
        }

        const extraSeries = ['P', 'Q', 'R', 'T', 'Y', 'ZG'];
        
        let statsData = data.filter(item => {
            const match = item.id.match(/^[A-Z]+/);
            const series = match ? match[0] : '';

            // Checkbox filter ä¼˜å…ˆ
            if (typeof selectedSeries !== 'undefined' && selectedSeries.size > 0) {
                return selectedSeries.has(series);
            }

            if (seriesMode === 'all') return true;
            // Mard 221 æ¨¡å¼ä¸‹æ’é™¤ P, Q, R, T, Y, ZG ç³»åˆ—
            return !extraSeries.includes(series);
        });

        // 1. åŸºç¡€æ•°æ®ç»Ÿè®¡
        const totalStock = statsData.reduce((sum, item) => sum + (item.w || 0), 0);
        const totalUsed = statsData.reduce((sum, item) => sum + (item.totalUsed || 0), 0);
        // Low stock: monitor is true (or undefined/default) AND stock < threshold
        const lowCount = statsData.filter(item => item.monitor !== false && (item.w || 0) < threshold).length;
        
        // Calculate Holding Rate (Items with stock > 0 / Total Items in view)
        const totalItems = statsData.length;
        const activeItems = statsData.filter(item => (item.w || 0) > 0).length;
        const holdingRate = totalItems > 0 ? Math.round((activeItems / totalItems) * 100) : 0;

        // 2. æ›´æ–°æ¦‚è§ˆæ•°å­—
        const elTotalStock = document.getElementById('stats-total-stock');
        if(elTotalStock) elTotalStock.textContent = `${totalStock.toFixed(1)}g`;
        
        const elTotalUsed = document.getElementById('stats-total-used');
        if(elTotalUsed) elTotalUsed.textContent = `${totalUsed.toFixed(1)}g`;
        
        const elLowCount = document.getElementById('stats-low-count');
        if(elLowCount) {
            elLowCount.textContent = lowCount;
            elLowCount.style.color = lowCount > 0 ? '#ff4d4f' : '#333';
        }

        // 3. æ›´æ–°ç”œç”œåœˆå›¾
        const donut = document.getElementById('stats-donut');
        const donutPercent = document.getElementById('stats-donut-percent');
        if(donut && donutPercent) {
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#4a90e2';
            donut.style.background = `conic-gradient(${primaryColor} 0% ${holdingRate}%, #f0f0f0 ${holdingRate}% 100%)`;
            donutPercent.textContent = `${holdingRate}%`;
        }

        // 4. æ›´æ–°æ’è¡Œæ¦œ (Stats Rank List)
        const rankListEl = document.getElementById('stats-rank-list');
        if(!rankListEl) return;
        
        rankListEl.innerHTML = '';

        // Filter by "Low Stock Only" toggle
        const lowFilterEl = document.getElementById('stats-low-filter');
        const showLowOnly = lowFilterEl ? lowFilterEl.checked : false;
        
        let listData = [...statsData];
        if (showLowOnly) {
            listData = listData.filter(item => item.monitor !== false && (item.w || 0) < threshold);
        }

        // Sort by Total Used Descending (Default Rank)
        listData.sort((a, b) => (b.totalUsed || 0) - (a.totalUsed || 0));

        if (listData.length === 0) {
            rankListEl.innerHTML = '<div style="text-align:center; color:#999; padding:20px; font-size:13px;">æš‚æ— æ•°æ®</div>';
            return;
        }

        const fragment = document.createDocumentFragment();
        const maxUsed = listData.length > 0 ? (listData[0].totalUsed || 0) : 0;

        listData.forEach((item, index) => {
            const itemUsed = item.totalUsed || 0;
            const itemStock = item.w || 0;
            const isLow = item.monitor !== false && itemStock < threshold;
            
            // Progress bar width (relative to max in current list)
            const progressPercent = maxUsed > 0 ? (itemUsed / maxUsed) * 100 : 0;

            const el = document.createElement('div');
            el.className = 'rank-item';
            
            // Rank Badge
            let badgeClass = 'rank-badge';
            if (index === 0) badgeClass += ' top-1';
            else if (index === 1) badgeClass += ' top-2';
            else if (index === 2) badgeClass += ' top-3';
            
            // Color Swatch
            const colorStyle = item.hex ? `background-color: ${item.hex};` : 'background-color: #eee;';
            
            el.innerHTML = `
                <div class="${badgeClass}">${index + 1}</div>
                <div class="rank-swatch" style="${colorStyle}"></div>
                <div class="rank-content">
                    <div class="rank-header">
                        <span class="rank-id">${item.id}</span>
                        <div class="rank-details">
                            <span class="used">ç”¨ ${itemUsed.toFixed(1)}g</span>
                            <span class="rem ${isLow ? 'zero' : ''}">ä½™ ${itemStock.toFixed(1)}g</span>
                        </div>
                    </div>
                    <div class="rank-progress-bg">
                        <div class="rank-progress-fill" style="width: ${progressPercent}%;"></div>
                    </div>
                </div>
            `;
            fragment.appendChild(el);
        });
        
        rankListEl.appendChild(fragment);
    }

    function syncAndRenderStats() {
        const val = document.getElementById('statsSeriesFilter').value;
        const mainSelect = document.getElementById('seriesFilter');
        if(mainSelect && mainSelect.value !== val) {
             mainSelect.value = val;
             // Update localStorage and trigger main render to keep sync
             localStorage.setItem('bead_series_filter', val);
             render(); 
        }
        renderStats();
    }

    // --- æ°´å°åŠŸèƒ½ --- æ–°ç”¨æˆ·æ¬¢è¿å¼¹çª— ---
    function checkWelcome() {
        const hasVisited = localStorage.getItem('mard_visited');
        if (!hasVisited) {
            showModal('welcomeModal');
        }
    }

    function closeWelcomeModal() {
        localStorage.setItem('mard_visited', 'true');
        closeAllModals();
    }

    function showDevInfo() {
        showModal('devInfoModal');
    }

    // æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„ç³»åˆ—
    const savedSeries = localStorage.getItem('bead_series_filter');
    if (savedSeries) {
        document.getElementById('seriesFilter').value = savedSeries;
    }

    // å¯åŠ¨æ—¶æ£€æŸ¥
    window.addEventListener('DOMContentLoaded', () => {
        // Remove init style if exists
        const initStyle = document.getElementById('init-style');
        if(initStyle) initStyle.remove();

        // Check for saved nav state (Refresh Persistence)
        const lastNav = localStorage.getItem('mard_last_nav');
        let restored = false;
        
        if (lastNav) {
            try {
                const nav = JSON.parse(lastNav);
                // Simple validation to prevent loops if bad data
                if (nav && nav.method && nav.arg) {
                    if (nav.method === 'navTo') {
                        navTo(nav.arg);
                        restored = true;
                    } else if (nav.method === 'navToDock') {
                        navToDock(nav.arg);
                        restored = true;
                    }
                }
            } catch(e) {
                console.error("Failed to restore nav state:", e);
                localStorage.removeItem('mard_last_nav');
            }
        }

        if (!restored) {
            // Check default page preference
            const defaultBeads = localStorage.getItem('default_page_beads');
            if (defaultBeads === 'true') {
                document.getElementById('defaultBeadsToggle').checked = true;
                navTo('beads');
            } else {
                navTo('home');
            }
        }

        render();
    });

    // --- Fabric Tool Logic ---

    function toggleDefaultPage() {
        const isChecked = document.getElementById('defaultBeadsToggle').checked;
        if (isChecked) {
            localStorage.setItem('default_page_beads', 'true');
        } else {
            localStorage.removeItem('default_page_beads');
        }
    }
    let specs = [];
    const specColors = ['#f5dce0', '#dcedc8', '#fdf6c6', '#adc6ff', '#d3adf7']; // Pink, Green, Yellow, Blue, Purple

    function addSpec() {
        if (specs.length >= 5) {
            alert("æœ€å¤šæ·»åŠ  5 ç§è§„æ ¼");
            return;
        }
        specs.push({ w: '', h: '', color: specColors[specs.length] });
        saveFabricState();
        renderSpecs();
    }

    function removeSpec(index) {
        specs.splice(index, 1);
        saveFabricState();
        renderSpecs();
    }

    function updateSpec(index, field, val) {
        // Only allow integers
        const intVal = parseInt(val);
        if (isNaN(intVal)) {
            specs[index][field] = '';
        } else {
            specs[index][field] = intVal;
        }
        saveFabricState();
        renderSpecs();
    }

    function renderSpecs() {
        const list = document.getElementById('specList');
        list.innerHTML = '';
        specs.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'spec-item';
            div.innerHTML = `
                <div class="spec-color" style="background:${s.color}"></div>
                <div style="font-size:12px; font-weight:bold; color:#666;">#${i+1}</div>
                <div style="position:relative; flex:1;">
                    <input type="number" value="${s.w}" placeholder="é•¿" onchange="updateSpec(${i}, 'w', this.value)" style="width:100%; padding:4px; padding-right:20px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box;">
                    <span style="position:absolute; right:4px; top:50%; transform:translateY(-50%); font-size:10px; color:#999; pointer-events:none;">cm</span>
                </div>
                <span style="font-size:12px; color:#999;">x</span>
                <div style="position:relative; flex:1;">
                    <input type="number" value="${s.h}" placeholder="å®½" onchange="updateSpec(${i}, 'h', this.value)" style="width:100%; padding:4px; padding-right:20px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box;">
                    <span style="position:absolute; right:4px; top:50%; transform:translateY(-50%); font-size:10px; color:#999; pointer-events:none;">cm</span>
                </div>
                <button class="btn-del" onclick="removeSpec(${i})">Ã—</button>
            `;
            list.appendChild(div);
        });
        updateSortOptions();
    }

    function updateSortOptions() {
        const select = document.getElementById('sortPref');
        if (!select) return;
        const currentVal = select.value;
        
        select.innerHTML = '';
        
        // Define options
        const opts = [
            {v:'all_specs', t:'ä¼˜å…ˆåŒ…å«å…¨éƒ¨è§„æ ¼æ–¹æ¡ˆ'},
            {v:'efficiency', t:'åˆ©ç”¨ç‡ä»é«˜åˆ°ä½'}
        ];
        
        // Add dynamic spec options
        specs.forEach((s, i) => {
            opts.push({v:`spec${i+1}`, t:`è§„æ ¼${i+1}æ•°é‡ä¼˜å…ˆ`});
        });
        
        opts.forEach(o => {
            const el = document.createElement('option');
            el.value = o.v;
            el.innerText = o.t;
            select.appendChild(el);
        });
        
        // Restore selection or default to all_specs
        const exists = opts.some(o => o.v === currentVal);
        if (exists) select.value = currentVal;
        else select.value = 'all_specs';
    }

    function saveFabricState() {
        const W = document.getElementById('canvasW').value;
        const H = document.getElementById('canvasH').value;
        const sort = document.getElementById('sortPref').value;
        
        localStorage.setItem('fabric_w', W);
        localStorage.setItem('fabric_h', H);
        localStorage.setItem('fabric_sort', sort);
        localStorage.setItem('fabric_specs', JSON.stringify(specs));
    }

    let currentRenderedSolutions = [];
    let currentFabricW = 0;
    let currentFabricH = 0;

    // --- Algorithm ---
    function calculateLayout() {
        saveFabricState(); // Save state on calculation trigger
        const W = parseFloat(document.getElementById('canvasW').value);
        const H = parseFloat(document.getElementById('canvasH').value);
        
        currentFabricW = W;
        currentFabricH = H;

        const sortPref = document.getElementById('sortPref').value;
        const statusEl = document.getElementById('calcStatus');
        const listEl = document.getElementById('solutionList');

        if (!W || !H || specs.length === 0) {
            alert("è¯·å®Œå–„å°ºå¯¸ä¿¡æ¯");
            return;
        }
        
        statusEl.innerText = "è®¡ç®—ä¸­...";
        listEl.innerHTML = ''; 

        // 1. Generate Combinations (Recursion)
        const targetArea = 0.9 * W * H;
        const totalArea = W * H;
        let solutions = [];
        
        // Determine target spec index for priority search
        let targetSpecIndex = -1;
        if (sortPref.startsWith('spec')) {
            targetSpecIndex = parseInt(sortPref.replace('spec', '')) - 1;
        }

        function search(index, currentCounts, currentArea) {
            if (currentArea > totalArea) return;
            
            if (index === specs.length) {
                if (currentArea >= targetArea) {
                    solutions.push({ counts: [...currentCounts], area: currentArea, utilization: currentArea / totalArea });
                }
                return;
            }

            const s = specs[index];
            const sArea = s.w * s.h;
            // Limit max count to avoid infinite loops if size is small
            const maxCnt = Math.min(200, Math.floor((totalArea - currentArea) / sArea));
            
            // Determine iteration order
            // Default: Descending (Max -> 0) to prefer filling space with current spec
            // If targetSpecIndex is set:
            //   - index < targetSpecIndex: Ascending (0 -> Max) to save space for target
            //   - index >= targetSpecIndex: Descending (Max -> 0) to fill space with target and others
            
            let start, end, step;
            let useDescending = true;
            
            if (targetSpecIndex !== -1 && index < targetSpecIndex) {
                useDescending = false;
            }
            
            if (useDescending) {
                start = maxCnt; end = 0; step = -1;
            } else {
                start = 0; end = maxCnt; step = 1;
            }

            for (let c = start; (step > 0 ? c <= end : c >= end); c += step) {
                currentCounts[index] = c;
                search(index + 1, currentCounts, currentArea + c * sArea);
                if (solutions.length > 10000) return; 
            }
        }
        
        search(0, new Array(specs.length).fill(0), 0);

        if (solutions.length === 0) {
            statusEl.innerText = "æ— æ»¡è¶³ >=90% åˆ©ç”¨ç‡çš„æ–¹æ¡ˆ";
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æœªæ‰¾åˆ°é«˜åˆ©ç”¨ç‡æ–¹æ¡ˆï¼Œå»ºè®®æ·»åŠ å¡«å……ä»¶</div>';
            return;
        }

        // 2. Validate Packing
        let validSolutions = [];
        solutions.sort((a, b) => b.utilization - a.utilization);
        const toCheck = solutions; 
        
        const packStrategies = [
            (a, b) => Math.max(b.w, b.h) - Math.max(a.w, a.h), // Max side desc (default)
            (a, b) => (b.w * b.h) - (a.w * a.h),             // Area desc
            (a, b) => Math.min(b.w, b.h) - Math.min(a.w, a.h), // Min side desc
            (a, b) => b.w - a.w                                // Width desc
        ];

        for (let sol of toCheck) {
            let items = [];
            sol.counts.forEach((cnt, i) => {
                for(let k=0; k<cnt; k++) items.push({ ...specs[i], id: i });
            });
            
            let bestResult = null;
            
            // Try different packing heuristics to find a fit
            // Combinations of Sort Strategy + Split Strategy (Horizontal/Vertical)
            for (let sortFn of packStrategies) {
                // Try Horizontal Split first (default)
                let result = packItems(W, H, items, sortFn, false);
                if (result) {
                    bestResult = result;
                    break; 
                }
                // Try Vertical Split
                result = packItems(W, H, items, sortFn, true);
                if (result) {
                    bestResult = result;
                    break;
                }
            }
            
            if (bestResult) {
                // Try to fill leftovers (Iterative greedy fill)
                // If we find any spec that fits in the leftovers, add it and re-pack
                let addedAny = false;
                let safetyLimit = 0;
                
                do {
                    addedAny = false;
                    safetyLimit++;
                    if (safetyLimit > 50) break; // Prevent infinite loop
                    
                    let bestExtra = null;
                    let maxExtraArea = 0;
                    
                    // Look for best fitting item across all leftovers
                    for (let l of bestResult.leftovers) {
                        for (let sIdx = 0; sIdx < specs.length; sIdx++) {
                            const s = specs[sIdx];
                            // Check fit (normal and rotated)
                            let fits = (s.w <= l.w && s.h <= l.h) || (s.h <= l.w && s.w <= l.h);
                            if (fits) {
                                const area = s.w * s.h;
                                if (area > maxExtraArea) {
                                    maxExtraArea = area;
                                    bestExtra = { s: s, id: sIdx };
                                }
                            }
                        }
                    }
                    
                    if (bestExtra) {
                        // Add extra item
                        items.push({ ...bestExtra.s, id: bestExtra.id });
                        sol.counts[bestExtra.id]++;
                        
                        // Re-pack with new item set
                        // We must find a valid packing for the new set
                        let improvedResult = null;
                        for (let sortFn of packStrategies) {
                             let res = packItems(W, H, items, sortFn, false); 
                             if (res) { improvedResult = res; break; }
                             res = packItems(W, H, items, sortFn, true); 
                             if (res) { improvedResult = res; break; }
                        }
                        
                        if (improvedResult) {
                            bestResult = improvedResult;
                            addedAny = true;
                            // Update solution stats
                            sol.area += bestExtra.s.w * bestExtra.s.h;
                            sol.utilization = sol.area / totalArea;
                        } else {
                            // Backtrack if failed (should be rare if space exists, but packing is heuristic)
                            items.pop();
                            sol.counts[bestExtra.id]--;
                            addedAny = false; 
                        }
                    }
                } while (addedAny);

                sol.placements = bestResult.placements;
                sol.leftovers = bestResult.leftovers;
                validSolutions.push(sol);
            }
        }

        // 3. Sort Results
        if (sortPref === 'all_specs') {
             validSolutions.sort((a, b) => {
                 const aHasAll = a.counts.every(c => c > 0);
                 const bHasAll = b.counts.every(c => c > 0);
                 if (aHasAll !== bHasAll) return bHasAll ? 1 : -1;
                 return b.utilization - a.utilization;
             });
        } else if (sortPref === 'variety') {
             // Priority: Number of different specs (variety) desc -> Utilization desc
             validSolutions.sort((a, b) => {
                 const varietyA = a.counts.filter(c => c > 0).length;
                 const varietyB = b.counts.filter(c => c > 0).length;
                 if (varietyA !== varietyB) {
                     return varietyB - varietyA; // More variety first
                 }
                 return b.utilization - a.utilization; // Then higher utilization
             });
        } else if (sortPref === 'efficiency') {
            validSolutions.sort((a, b) => b.utilization - a.utilization);
        } else if (sortPref.startsWith('spec')) {
            const specIdx = parseInt(sortPref.replace('spec', '')) - 1;
            validSolutions.sort((a, b) => {
                const countA = a.counts[specIdx] || 0;
                const countB = b.counts[specIdx] || 0;
                return countB - countA;
            });
        }
        
        // Deduplicate solutions based on physical dimensions (user request)
        // Check if generated solution spec dimensions have completely identical combinations
        const uniqueSolutions = [];
        const seenSignatures = new Set();
        
        validSolutions.forEach(sol => {
            // Build signature: sorted list of dimensions "WxH"
            let dims = [];
            sol.counts.forEach((cnt, i) => {
                for(let k=0; k<cnt; k++) {
                    dims.push(`${specs[i].w}x${specs[i].h}`);
                }
            });
            dims.sort();
            const sig = dims.join('|');
            
            if (!seenSignatures.has(sig)) {
                seenSignatures.add(sig);
                uniqueSolutions.push(sol);
            }
        });
        validSolutions = uniqueSolutions;

        // 4. Render All Valid Solutions
        const totalFound = validSolutions.length;
        if (validSolutions.length > 50) {
            validSolutions = validSolutions.slice(0, 50);
        }
        
        currentRenderedSolutions = validSolutions;
        statusEl.innerText = `æ‰¾åˆ° ${totalFound} ä¸ªæ–¹æ¡ˆ (ä»…æ˜¾ç¤ºå‰ ${validSolutions.length} ä¸ª)`;
        
        validSolutions.forEach((sol, idx) => {
            renderSolution(sol, idx + 1, W, H);
        });
    }

    function openZoom(idx) {
        currentZoomIdx = idx;
        const sol = currentRenderedSolutions[idx];
        if (!sol) return;
        
        const modal = document.getElementById('zoomModal');
        const canvas = document.getElementById('zoomCanvas');
        const title = document.getElementById('zoomTitle');
        const statsContainer = document.getElementById('zoomStats');
        const W = parseFloat(document.getElementById('canvasW').value);
        const H = parseFloat(document.getElementById('canvasH').value);
        
        modal.style.display = 'flex';
        title.innerText = `æ–¹æ¡ˆ #${idx + 1} (${(sol.utilization * 100).toFixed(1)}% åˆ©ç”¨ç‡)`;
        
        if (statsContainer) {
            statsContainer.innerHTML = generateStatsHtml(sol);
        }
        
        // Calculate max dimensions for the modal canvas
        // 90vw width, 70vh height max
        const maxW = window.innerWidth * 0.9;
        const maxH = window.innerHeight * 0.7;
        
        const scaleW = maxW / W;
        const scaleH = maxH / H;
        const scale = Math.min(scaleW, scaleH); // Scale to fit
        
        const cw = W * scale;
        const ch = H * scale;
        
        canvas.width = cw;
        canvas.height = ch;
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, cw, ch);
        ctx.scale(scale, scale);
        
        // Draw placements
        sol.placements.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1 / scale;
            ctx.strokeRect(p.x, p.y, p.w, p.h);
            
            // Always show text in zoom mode if reasonable size
            if (p.w * scale > 30 && p.h * scale > 15) {
                ctx.fillStyle = '#000';
                // Fix font size: use physical pixels (16px) divided by scale
                // Previous Math.max(12, ...) caused huge text when zoomed in
                const fontSize = (p.w <= 10 || p.h <= 10) ? 8 : 16;
                ctx.font = `${fontSize/scale}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
            }
        });
        
        // Draw leftovers
        if(sol.leftovers) {
            sol.leftovers.forEach(l => {
                if (l.w > 0.5 && l.h > 0.5) {
                     ctx.strokeStyle = '#888';
                     ctx.setLineDash([5/scale, 5/scale]);
                     ctx.lineWidth = 2 / scale;
                     ctx.strokeRect(l.x, l.y, l.w, l.h);
                     
                     // Show dimensions for leftovers in zoom
                     if (l.w * scale > 40 && l.h * scale > 20) {
                        ctx.fillStyle = '#666';
                        ctx.font = `${12/scale}px sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${l.w}x${l.h}`, l.x + l.w/2, l.y + l.h/2);
                     }
                     ctx.setLineDash([]);
                }
            });
        }
    }

    function closeZoom() {
        document.getElementById('zoomModal').style.display = 'none';
    }

    function closeDownloadModal() {
        const modal = document.getElementById('downloadModal');
        const img = document.getElementById('downloadImg');
        // Clear src to save memory
        if (img) img.src = '';
        modal.style.display = 'none';
    }

    async function downloadSolution(idx) {
        // UI Feedback: Immediate response
        const btn = document.getElementById('zoomDownloadBtn');
        const originalText = btn ? btn.innerText : "ä¿å­˜å›¾ç‰‡";
        if (btn) {
            btn.innerText = "ç”Ÿæˆä¸­...";
            btn.disabled = true;
            btn.style.opacity = "0.7";
        }

        // Force UI update
        await new Promise(r => setTimeout(r, 50));

        try {
            const sol = currentRenderedSolutions[idx];
            if (!sol) throw new Error("æ–¹æ¡ˆæ•°æ®ä¸¢å¤±");
            
            const W = currentFabricW;
            const H = currentFabricH;
            
            // 1. Prepare Text Data (Simplified for mobile reliability)
            const lines = [];
            lines.push({ text: `æ–¹æ¡ˆ #${idx+1}`, type: 'title' });
            lines.push({ text: `${W}x${H}cm | åˆ©ç”¨ç‡:${(sol.utilization * 100).toFixed(1)}%`, type: 'subtitle' });
            
            // Stats (Limit items to prevent huge images)
            sol.counts.forEach((c, i) => {
                if(c > 0) lines.push({ text: `${specs[i].w}x${specs[i].h}: ${c}`, type: 'item', color: specs[i].color });
            });
            
            // Leftovers
            if (sol.leftovers && sol.leftovers.length > 0) {
                const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
                if (validLeftovers.length > 0) {
                     lines.push({ text: "å‰©ä½™å¸ƒæ–™:", type: 'header' });
                     const wasteGroups = {};
                     validLeftovers.forEach(l => {
                          const key = `${l.w}x${l.h}`;
                          wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                     });
                     for (let [size, count] of Object.entries(wasteGroups)) {
                          lines.push({ text: `${size}cm: x${count}`, type: 'item-waste' });
                     }
                }
            }

            // 2. Setup Canvas Dimensions
            // NUCLEAR OPTION: Mobile Max Dimension Limit = 800px
            // This ensures it works on even the most restricted WebViews
            let PIXELS_PER_CM = 10; 
            const isMobile = window.innerWidth <= 768 || ('ontouchstart' in window);
            
            if (isMobile) {
                const maxDimension = Math.max(W, H);
                // Force max 800px to guarantee memory safety and Base64 length safety
                if (maxDimension * PIXELS_PER_CM > 800) {
                    PIXELS_PER_CM = 800 / maxDimension; 
                }
            }
            const scale = PIXELS_PER_CM;
            
            // Layout constants
            const PADDING = 20;
            const LINE_HEIGHT = 28;
            let textSectionHeight = PADDING * 2 + lines.length * LINE_HEIGHT;
            
            const canvas = document.createElement('canvas');
            canvas.width = Math.floor(W * scale);
            canvas.height = Math.floor(H * scale + textSectionHeight);
            const ctx = canvas.getContext('2d');
            
            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 3. Draw Layout
            ctx.save();
            ctx.scale(scale, scale);
            sol.placements.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 1 / scale;
                ctx.strokeRect(p.x, p.y, p.w, p.h);
                // Simple text
                if (p.w > 5 && p.h > 5) {
                    ctx.fillStyle = '#000';
                    ctx.font = `${12/scale}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
                }
            });
            
            // Draw leftovers
            if(sol.leftovers) {
                sol.leftovers.forEach(l => {
                    if (l.w > 0.5 && l.h > 0.5) {
                         ctx.strokeStyle = '#888';
                         ctx.setLineDash([5/scale, 5/scale]);
                         ctx.lineWidth = 2 / scale;
                         ctx.strokeRect(l.x, l.y, l.w, l.h);
                         // Dimensions
                         if (l.w > 3 && l.h > 3) {
                             ctx.fillStyle = '#666';
                             ctx.font = `${12/scale}px Arial`;
                             ctx.textAlign = 'center';
                             ctx.textBaseline = 'middle';
                             ctx.fillText(`${l.w}x${l.h}`, l.x + l.w/2, l.y + l.h/2);
                         }
                         ctx.setLineDash([]);
                    }
                });
            }
            ctx.restore();
            
            // 4. Draw Info Text
            let currentY = H * scale + PADDING;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            lines.forEach(line => {
                ctx.font = line.type === 'title' ? "bold 20px Arial" : "16px Arial";
                ctx.fillStyle = '#333';
                if (line.color) {
                    ctx.fillStyle = line.color;
                    ctx.fillRect(PADDING, currentY + 4, 12, 12);
                    ctx.fillStyle = '#333';
                    ctx.fillText(line.text, PADDING + 18, currentY);
                } else {
                    ctx.fillText(line.text, PADDING, currentY);
                }
                currentY += LINE_HEIGHT;
            });
            
            // --- ROBUST AUTO DOWNLOAD STRATEGY ---
            
            // 0. HTML5+ Environment (HBuilderX / 5+App / uni-app)
            // This is the BEST way for APKs built with HBuilderX
            if (window.plus && window.plus.gallery) {
                try {
                    var bitmap = new plus.nativeObj.Bitmap("test");
                    bitmap.loadBase64Data(canvas.toDataURL('image/jpeg', 0.9), function() {
                        const fileName = "_doc/solution_" + (new Date()).getTime() + ".jpg";
                        bitmap.save(fileName, {overwrite: true}, function(i) {
                            plus.gallery.save(i.target, function() {
                                showToast("å·²æˆåŠŸä¿å­˜åˆ°æ‰‹æœºç›¸å†Œï¼");
                                bitmap.clear();
                            }, function(e) {
                                alert("ä¿å­˜åˆ°ç›¸å†Œå¤±è´¥: " + JSON.stringify(e));
                                bitmap.clear();
                            });
                        }, function(e) {
                            alert("ä¿å­˜æ–‡ä»¶å¤±è´¥: " + JSON.stringify(e));
                            bitmap.clear();
                        });
                    }, function(e) {
                        alert("å›¾ç‰‡å¤„ç†å¤±è´¥: " + JSON.stringify(e));
                    });
                    return; // Stop execution, let the native API handle it
                } catch(e) {
                    console.error("Plus API failed", e);
                }
            }

            // --- DIRECT DOWNLOAD STRATEGY (User Requested) ---
            // Bypass Share API and force direct download to local storage
            
            await new Promise((resolve, reject) => {
                canvas.toBlob(function(blob) {
                    try {
                        if (!blob) {
                            reject(new Error("å›¾ç‰‡ç”Ÿæˆå¤±è´¥"));
                            return;
                        }
                        
                        // Force "Stream" type to ensure Android WebViews treat it as a download
                        // instead of opening it in the browser/viewer.
                        const streamBlob = new Blob([blob], { type: "application/octet-stream" });
                        const url = URL.createObjectURL(streamBlob);
                        
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        link.download = `solution_${idx+1}.jpg`;
                        
                        document.body.appendChild(link);
                        link.click();
                        
                        // Cleanup after a delay to ensure click registers
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }, 2000);
                        
                        resolve();
                    } catch (e) {
                        reject(e);
                    }
                }, 'image/jpeg', 0.8);
            });

            // Fallback for APKs that block blob downloads: Show image for long-press
            // Only runs if the above click() didn't trigger a page navigation/download catch
            if (isMobile) {
                 setTimeout(() => {
                      const fallbackDiv = document.createElement('div');
                      fallbackDiv.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; font-size:12px; z-index:9999; pointer-events:none; opacity:0; transition:opacity 0.5s;';
                      fallbackDiv.innerText = "å¦‚æœæœªå¼€å§‹ä¸‹è½½ï¼Œè¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜";
                      document.body.appendChild(fallbackDiv);
                      
                      // Check if we should show fallback
                      // Since we can't detect if download started, we show a non-intrusive toast
                      // AND we open the image in a way that allows long-press if the download failed silently
                      
                      // Re-enable image interaction for long press backup
                      const zoomImg = document.querySelector('#zoomModal img');
                      if(zoomImg) {
                          zoomImg.src = canvas.toDataURL('image/jpeg', 0.8); // Replace preview with full res for saving
                          requestAnimationFrame(() => {
                               fallbackDiv.style.opacity = '1';
                               setTimeout(() => fallbackDiv.remove(), 4000);
                          });
                      }
                 }, 1000);
            }

        } catch (e) {
            alert("æ“ä½œå¤±è´¥: " + e.message + "\nå»ºè®®æˆªå›¾ä¿å­˜");
        } finally {
            if (btn) {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        }
    }

    // Guillotine Packing Algorithm
    function packItems(binW, binH, items, sortFn, splitVertical) {
        // Sort items using provided strategy or default
        let rects = items.map(i => ({...i}));
        if (sortFn) {
            rects.sort(sortFn);
        } else {
            rects.sort((a, b) => Math.max(b.w, b.h) - Math.max(a.w, a.h)); 
        }

        let root = { x: 0, y: 0, w: binW, h: binH, used: false };
        let placements = [];
        
        for (let r of rects) {
            // Try to find best fit for normal and rotated orientation
            // Strategy: Best Short Side Fit (BSSF) - minimizes the shorter leftover side
            let fit = findBestFit(root, r.w, r.h);
            let fitR = findBestFit(root, r.h, r.w);
            
            let bestNode = null;
            let rotated = false;
            
            if (fit.node && fitR.node) {
                if (fit.score <= fitR.score) {
                    bestNode = fit.node;
                } else {
                    bestNode = fitR.node;
                    rotated = true;
                }
            } else if (fit.node) {
                bestNode = fit.node;
            } else if (fitR.node) {
                bestNode = fitR.node;
                rotated = true;
            }
            
            if (bestNode) {
                let w = rotated ? r.h : r.w;
                let h = rotated ? r.w : r.h;
                splitNode(bestNode, w, h, splitVertical);
                placements.push({ x: bestNode.x, y: bestNode.y, w, h, color: r.color, id: r.id });
            } else {
                return null; 
            }
        }
        
        let leftovers = [];
        collectLeftovers(root, leftovers);
        return { placements, leftovers };
    }

    function findBestFit(root, w, h) {
        let bestNode = null;
        let bestScore = Infinity; // Lower is better (min short side remainder)

        function traverse(node) {
            if (node.used) {
                traverse(node.right);
                traverse(node.down);
            } else if (w <= node.w && h <= node.h) {
                // BSSF: Best Short Side Fit
                let remW = node.w - w;
                let remH = node.h - h;
                let score = Math.min(remW, remH);
                
                if (score < bestScore) {
                    bestScore = score;
                    bestNode = node;
                }
            }
        }
        traverse(root);
        return { node: bestNode, score: bestScore };
    }

    function splitNode(node, w, h, splitVertical) {
        node.used = true;
        if (splitVertical) {
            // Vertical Split: Cut strip of width w
            node.down = { x: node.x, y: node.y + h, w: w, h: node.h - h, used: false };
            node.right = { x: node.x + w, y: node.y, w: node.w - w, h: node.h, used: false };
        } else {
            // Horizontal Split (Default): Cut strip of height h
            node.down = { x: node.x, y: node.y + h, w: node.w, h: node.h - h, used: false };
            node.right = { x: node.x + w, y: node.y, w: node.w - w, h: h, used: false };
        }
    }
    
    function collectLeftovers(node, list) {
        if (!node) return;
        if (!node.used) {
            if (node.w > 0 && node.h > 0) list.push({x: node.x, y: node.y, w: node.w, h: node.h});
        } else {
            collectLeftovers(node.right, list);
            collectLeftovers(node.down, list);
        }
    }

    function generateStatsHtml(sol) {
        let statsHtml = '';
        sol.counts.forEach((c, i) => {
            if(c > 0) {
                statsHtml += `
                    <div class="sol-stat-row">
                        <span style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:${specs[i].color}; border-radius:2px;"></div>
                            ${specs[i].w}x${specs[i].h}cm
                        </span>
                        <b>x${c}</b>
                    </div>
                `;
            }
        });

        // Generate leftovers stats
        let wasteHtml = '';
        if (sol.leftovers && sol.leftovers.length > 0) {
            // Filter significant leftovers
            const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
            if (validLeftovers.length > 0) {
                // Group by size
                const wasteGroups = {};
                validLeftovers.forEach(l => {
                    const key = `${l.w}x${l.h}`;
                    wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                });
                
                wasteHtml = `<div style="margin-top:10px; font-size:12px; color:#999; border-top:1px dashed #eee; padding-top:5px;">
                    <div style="margin-bottom:2px;">å‰©ä½™å¸ƒæ–™:</div>`;
                
                for (let [size, count] of Object.entries(wasteGroups)) {
                    wasteHtml += `<div style="display:flex; justify-content:space-between;">
                        <span>${size}cm</span>
                        <span>x${count}</span>
                    </div>`;
                }
                wasteHtml += `</div>`;
            }
        }
        
        return `<div class="sol-info" style="margin-top:15px; width:100%; border-top:1px solid #eee; padding-top:10px;">
                    <div style="margin-bottom:10px; font-weight:bold; font-size:13px; color:#333;">æ•°é‡ç»Ÿè®¡</div>
                    ${statsHtml}
                    ${wasteHtml}
                </div>`;
    }

    function renderSolution(sol, idx, W, H) {
        const listEl = document.getElementById('solutionList');
        const card = document.createElement('div');
        card.className = 'solution-card';
        
        let statsHtml = '';
        sol.counts.forEach((c, i) => {
            if(c > 0) {
                statsHtml += `
                    <div class="sol-stat-row">
                        <span style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:${specs[i].color}; border-radius:2px;"></div>
                            ${specs[i].w}x${specs[i].h}cm
                        </span>
                        <b>x${c}</b>
                    </div>
                `;
            }
        });

        // Generate leftovers stats
        let wasteHtml = '';
        if (sol.leftovers && sol.leftovers.length > 0) {
            // Filter significant leftovers
            const validLeftovers = sol.leftovers.filter(l => l.w > 0.5 && l.h > 0.5);
            if (validLeftovers.length > 0) {
                // Group by size
                const wasteGroups = {};
                validLeftovers.forEach(l => {
                    const key = `${l.w}x${l.h}`;
                    wasteGroups[key] = (wasteGroups[key] || 0) + 1;
                });
                
                wasteHtml = `<div style="margin-top:10px; font-size:12px; color:#999; border-top:1px dashed #eee; padding-top:5px;">
                    <div style="margin-bottom:2px;">å‰©ä½™å¸ƒæ–™:</div>`;
                
                for (let [size, count] of Object.entries(wasteGroups)) {
                    wasteHtml += `<div style="display:flex; justify-content:space-between;">
                        <span>${size}cm</span>
                        <span>x${count}</span>
                    </div>`;
                }
                wasteHtml += `</div>`;
            }
        }

        const scale = Math.min(200 / W, 200 / H); 
        const cw = W * scale;
        const ch = H * scale;
        const canvasId = `cvs-${Date.now()}-${idx}`;
        
        card.innerHTML = `
            <div class="sol-header">
                <span style="font-weight:bold; color:#333; white-space:nowrap;">æ–¹æ¡ˆ #${idx}</span>
                <div style="display:flex; gap:5px; align-items:center;">
                    <span class="sol-badge">${(sol.utilization * 100).toFixed(1)}% åˆ©ç”¨ç‡</span>
                </div>
            </div>
            <div class="sol-body">
                <div class="sol-canvas-wrapper" onclick="openZoom(${idx-1})" style="cursor:pointer;">
                    <canvas id="${canvasId}" width="${cw}" height="${ch}"></canvas>
                </div>
                <div class="sol-info">
                    <div style="margin-bottom:10px; font-weight:bold; font-size:13px; color:#333;">æ•°é‡ç»Ÿè®¡</div>
                    ${statsHtml}
                    ${wasteHtml}
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                         <div style="font-size:12px; color:#999;">æ€»å°ºå¯¸: ${W}x${H} cm</div>
                    </div>
                </div>
            </div>
        `;
        listEl.appendChild(card);
        
        setTimeout(() => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            ctx.scale(scale, scale);
            
            sol.placements.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 1 / scale;
                ctx.strokeRect(p.x, p.y, p.w, p.h);
                
                if (p.w * scale > 20 && p.h * scale > 10) {
                    ctx.fillStyle = '#000';
                    ctx.font = `${10/scale}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${p.w}x${p.h}`, p.x + p.w/2, p.y + p.h/2);
                }
            });
            
            if(sol.leftovers) {
                sol.leftovers.forEach(l => {
                    if (l.w > 0.5 && l.h > 0.5) {
                         ctx.strokeStyle = '#888';
                         ctx.setLineDash([3/scale, 3/scale]);
                         ctx.lineWidth = 1 / scale;
                         ctx.strokeRect(l.x, l.y, l.w, l.h);
                         
                         // Show text if space allows (threshold relaxed)
                         ctx.setLineDash([]);
                    }
                });
            }
        }, 0);
    }
    function toggleMainMenu() {
        const menu = document.getElementById('mainMenuDropdown');
        const isVisible = menu.style.display === 'block';
        menu.style.display = isVisible ? 'none' : 'block';
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        // Handle dropdown menu close (legacy, removing)
        const menu = document.getElementById('mainMenuDropdown');
        if (menu && menu.style.display === 'block') menu.style.display = 'none';

        // Handle bottom sheet close
        const sheet = document.getElementById('moreMenuSheet');
        if (sheet && sheet.classList.contains('show') && e.target === sheet) {
            toggleMoreMenu();
        }
    });

    function navToDock(tab) {
        // Save state for refresh
        localStorage.setItem('mard_last_nav', JSON.stringify({ method: 'navToDock', arg: tab }));

        // Update Pull-to-Refresh behavior
        updatePullToRefresh(tab);

        // Reset all active states
        document.querySelectorAll('.dock-item').forEach(el => el.classList.remove('active'));
        
        // Set active state
        let index = 0;
        if(tab === 'scan') index = 1;
        if(tab === 'plan') index = 2;
        if(tab === 'stats') index = 3;
        if(tab === 'more') index = 4; 
        
        const items = document.querySelectorAll('.dock-item');
        if (items[index]) {
            items[index].classList.add('active');
        }

        // Ensure dock is visible when navigating via dock
        document.getElementById('footer-dock').style.display = 'flex';

        // Hide all main pages first
        document.getElementById('page-beads').style.display = 'none';
        document.getElementById('page-stats').style.display = 'none';
        document.getElementById('page-fabric').style.display = 'none';
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-scan').style.display = 'none';
        const pagePlan = document.getElementById('page-plan');
        if (pagePlan) pagePlan.style.display = 'none';
        const pagePlanDetail = document.getElementById('page-plan-detail');
        if (pagePlanDetail) pagePlanDetail.style.display = 'none';
        const pageMore = document.getElementById('page-more');
        if (pageMore) pageMore.style.display = 'none';
        const pageHistory = document.getElementById('page-history');
        if (pageHistory) pageHistory.style.display = 'none';

        if (tab === 'inventory') {
            document.getElementById('page-beads').style.display = 'block';
            const fab = document.getElementById('floatingBatchAddBtn');
            if(fab) fab.style.display = 'flex';
            const homeBtn = document.getElementById('floatingHomeBtn');
            if(homeBtn) homeBtn.style.display = 'flex';
        } else if (tab === 'scan') {
             // Re-use navTo for scan to ensure correct initialization if needed, 
             // but here we just show the div as navTo handles dock hiding which we don't want
             document.getElementById('page-scan').style.display = 'block';
             const fab = document.getElementById('floatingBatchAddBtn');
             if(fab) fab.style.display = 'none';
             const homeBtn = document.getElementById('floatingHomeBtn');
             if(homeBtn) homeBtn.style.display = 'none';
        } else if (tab === 'plan') {
             if (pagePlan) {
                 pagePlan.style.display = 'block';
                 renderPlans();
             }
             const fab = document.getElementById('floatingBatchAddBtn');
             if(fab) fab.style.display = 'none';
             const homeBtn = document.getElementById('floatingHomeBtn');
             if(homeBtn) homeBtn.style.display = 'none';
        } else if (tab === 'stats') {
             document.getElementById('page-stats').style.display = 'block';
             renderStats();
             const fab = document.getElementById('floatingBatchAddBtn');
             if(fab) fab.style.display = 'none';
             const homeBtn = document.getElementById('floatingHomeBtn');
             if(homeBtn) homeBtn.style.display = 'none';
        } else if (tab === 'more') {
             if (pageMore) pageMore.style.display = 'block';
             const fab = document.getElementById('floatingBatchAddBtn');
             if(fab) fab.style.display = 'none';
             const homeBtn = document.getElementById('floatingHomeBtn');
             if(homeBtn) homeBtn.style.display = 'none';
        }
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // --- æ‰«æåŠŸèƒ½ ---
    let cropper = null;
    let currentScanResults = new Map();
    let currentScanRawText = '';
    let currentScanSortType = 'code'; // 'code' | 'qty'
    let currentScanPrioritizeMissing = false;

    function toggleScanSort(type) {
        if (currentScanSortType === type) return;
        currentScanSortType = type;
        renderScanResults();
    }

    function toggleScanMissingPriority() {
        currentScanPrioritizeMissing = !currentScanPrioritizeMissing;
        renderScanResults();
    }

    function handleScanImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = document.getElementById('scanPreviewImg');
                img.src = e.target.result;
                
                // UI Switch to Crop Mode (Preview Only)
                document.getElementById('scanPreview').style.display = 'none';
                document.getElementById('cropContainer').style.display = 'block';
                document.getElementById('cropControls').style.display = 'flex';
                document.getElementById('scanResult').style.display = 'none';
                
                // DO NOT Initialize Cropper here. Just show the image.
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            };
            
            reader.readAsDataURL(file);
        }
    }

    let pendingScanBlob = null;
    let currentPreviewZoom = 1;

    // Triggered by "å¼€å§‹è£åˆ‡"
    function openCropEditor() {
        const sourceImg = document.getElementById('scanPreviewImg');
        const editImg = document.getElementById('cropEditImage');
        
        if (!sourceImg.src) return;
        
        editImg.src = sourceImg.src;
        // Use flex to ensure full screen layout works
        document.getElementById('cropEditModal').style.display = 'flex';
        
        // Destroy previous instance if any
        if (cropper) {
            cropper.destroy();
        }
        
        // Initialize Cropper in Full Screen Modal
        cropper = new Cropper(editImg, {
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.95,
            background: true, 
            responsive: true,
            rotatable: true,
            scalable: true
        });
    }

    function closeCropEditor() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        document.getElementById('cropEditModal').style.display = 'none';
    }

    // Triggered by "é¢„è§ˆ" in Edit Modal
    function showCropPreview() {
        if (!cropper) return;
        
        // 1. Get High Quality Crop
        const canvas = cropper.getCroppedCanvas({
            maxWidth: 4096,
            maxHeight: 4096,
            fillColor: '#fff'
        });
        
        // 2. Show Preview Modal
        const previewImg = document.getElementById('cropPreviewImage');
        previewImg.src = canvas.toDataURL();
        
        // Reset Zoom
        currentPreviewZoom = 1;
        previewImg.style.transform = `scale(${currentPreviewZoom})`;
        
        // Show Preview on top of Edit Modal
        document.getElementById('cropPreviewModal').style.display = 'flex';
        
        // Save blob for later confirmation
        canvas.toBlob((blob) => {
            pendingScanBlob = blob;
        }, 'image/png');
    }

    function closeCropPreview() {
        // Just hide Preview, revealing Edit Modal below
        document.getElementById('cropPreviewModal').style.display = 'none';
    }

    function zoomPreview(delta) {
        currentPreviewZoom += delta;
        if (currentPreviewZoom < 0.2) currentPreviewZoom = 0.2;
        if (currentPreviewZoom > 5) currentPreviewZoom = 5;
        document.getElementById('cropPreviewImage').style.transform = `scale(${currentPreviewZoom})`;
    }

    async function confirmScanFromPreview() {
        if (!pendingScanBlob) return;
        
        // Hide All Modals
        closeAllModals();
        
        // Clean up cropper
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        
        // Proceed with Scan
        await performScan(pendingScanBlob);
        
        // Clear pending
        pendingScanBlob = null;
    }

    function reCropImage() {
        // Just reset the zoom level for the next preview
        currentPreviewZoom = 1;
        const img = document.getElementById('cropPreviewImage');
        if(img) img.style.transform = `scale(${currentPreviewZoom})`;
        
        // Close preview modal if open
        closeAllModals();

        // The cropper on the main page is still active, so user can just adjust and click crop again.
    }

    function preprocessCanvas(sourceCanvas) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Scale up (2.5x) for clearer text
        const scale = 2.5;
        canvas.width = sourceCanvas.width * scale;
        canvas.height = sourceCanvas.height * scale;
        
        // Draw scaled image
        ctx.drawImage(sourceCanvas, 0, 0, canvas.width, canvas.height);
        
        // Grayscale & Binarization (Thresholding)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const threshold = 160; // Threshold value (0-255)
        
        for (let i = 0; i < data.length; i += 4) {
            // Luma (Grayscale)
            const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
            
            // Binarization: Black or White
            const val = avg < threshold ? 0 : 255;
            
            data[i] = val;     // R
            data[i + 1] = val; // G
            data[i + 2] = val; // B
            // Alpha (data[i+3]) remains unchanged
        }
        
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }

    async function performScan(file) {
        // UI Updates for Scan Start
        const blobUrl = URL.createObjectURL(file);
        document.getElementById('scanResultImage').src = blobUrl;
        
        // Set Original Full Image
        const originalImg = document.getElementById('scanPreviewImg');
        const fullImgEl = document.getElementById('scanResultFullImage');
        if (fullImgEl && originalImg) {
            fullImgEl.src = originalImg.src;
        }

        // Set Process Previews
        document.getElementById('scanProcessOriginal').src = originalImg.src;
        document.getElementById('scanProcessCropped').src = blobUrl;
        document.getElementById('cropContainer').style.display = 'none';
        document.getElementById('scanProcessPreviews').style.display = 'block';

        document.getElementById('scanLoading').style.display = 'flex';
        document.getElementById('cropControls').style.display = 'none'; // Lock controls
        document.getElementById('scanResult').style.display = 'none';
        // Hide crop container during loading to keep UI clean
        // document.getElementById('cropContainer').style.display = 'none'; // Already hidden above
        
        const statusEl = document.getElementById('scanStatusText');
        statusEl.innerText = "æ­£åœ¨è¿æ¥ Gemini AI è¿›è¡Œæ™ºèƒ½è¯†åˆ«...";

        try {
            // 1. Convert Blob to Base64
            const base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const result = reader.result;
                    // Remove "data:image/png;base64," prefix
                    const base64 = result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });

            // 2. Dynamic Model Discovery & Prioritization
            const API_KEY = ModelUsageManager.getApiKey(); 
            statusEl.innerText = "æ­£åœ¨è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨...";
            
            let candidateModels = [];
            // const defaultModel = 'gemini-2.0-flash'; // Unused


            // --- Model Usage Tracking Logic (User Request) ---
            // Using Global ModelUsageManager defined in main script

            // Define strict priority list as requested
            let priorityList = [
                'gemini-3-flash',
                'gemini-2.5-flash',
                'gemini-2.5-flash-lite'
            ];

            // Filter by usage limit
            candidateModels = [];
            for (const m of priorityList) {
                if (ModelUsageManager.canUse(m)) {
                    candidateModels.push(m);
                } else {
                    console.log(`Model ${m} reached daily limit (${ModelUsageManager.limit}). Skipping.`);
                }
            }
            
            if (candidateModels.length === 0) {
                 console.warn("All custom models exhausted. Using fallback (Lite).");
                 // Fallback to the most economical model if all limits are reached
                 candidateModels = ['gemini-2.5-flash-lite']; 
            }

            console.log("Candidate Models Sequence:", candidateModels);

            // 3. Loop through models (Failover Logic)
            let result = null;
            let lastError = null;
            let usedModel = '';
            
            const prompt = `
                Analyze this image of a bead inventory list.
                Identify all color codes (e.g., A1, B-2, 310, 823) and their corresponding quantities (numbers).
                The quantity is usually physically located below or next to the color code.
                Pay attention to the grid layout.
                
                Return a JSON object where keys are the color codes (string) and values are the quantities (integer).
                Example format: {"A1": 50, "B2": 30, "310": 100}
                
                IMPORTANT: Return ONLY the valid JSON string. Do not include markdown formatting like \`\`\`json.
            `;

            for (const modelName of candidateModels) {
                try {
                    statusEl.innerText = `æ­£åœ¨å°è¯•ä½¿ç”¨ ${modelName} ...`;
                    // Visual feedback on retry
                    if (lastError) {
                        statusEl.innerText += ` (è‡ªåŠ¨åˆ‡æ¢ä¸­)`;
                    }

                    console.log(`Attempting model: ${modelName}`);
                    
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inline_data: { mime_type: "image/png", data: base64Data } }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || `API Status ${response.status}`);
                    }

                    result = await response.json();
                    usedModel = modelName;
                    console.log(`Success with model: ${modelName}`);
                    ModelUsageManager.increment(modelName); // Track usage
                    break; // Success! Exit loop

                } catch (e) {
                    console.warn(`Model ${modelName} failed:`, e.message);
                    lastError = e;
                    // Continue to next model in loop
                }
            }

            if (!result) {
                throw lastError || new Error("æ‰€æœ‰å¯ç”¨æ¨¡å‹å‡å°è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Key é…é¢ã€‚");
            }
            
            // 4. Parse Response
            const candidate = result.candidates?.[0];
            if (!candidate) throw new Error("No response candidates from Gemini");

            const rawText = candidate.content.parts[0].text;
            console.log("Gemini Raw:", rawText);
            
            // Clean markdown if present (just in case)
            const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            
            let dataMap;
            try {
                dataMap = JSON.parse(jsonStr);
            } catch (e) {
                console.error("JSON Parse Error", e);
                throw new Error("Gemini è¿”å›äº†æ— æ³•è§£æçš„æ•°æ®æ ¼å¼");
            }
            
            // Convert to Map for existing render function
            const codeMap = new Map();
            Object.entries(dataMap).forEach(([key, value]) => {
                // Basic cleanup of keys (uppercase) and values (int)
                codeMap.set(key.toUpperCase(), parseInt(value));
            });

            // 5. Render Results
            document.getElementById('scanLoading').style.display = 'none';
            document.getElementById('scanResult').style.display = 'block';
            document.getElementById('scan-uploader').style.display = 'none'; // Hide uploader area
            
            // Store global state
            currentScanResults = codeMap;
            currentScanRawText = `[Used Model: ${usedModel}]\n` + rawText;

            renderScanResults();

        } catch (err) {
            console.error(err);
            alert('è¯†åˆ«å‡ºé”™: ' + (err.message || "æœªçŸ¥é”™è¯¯"));
            document.getElementById('scanLoading').style.display = 'none';
            document.getElementById('cropControls').style.display = 'flex'; // Restore controls
            document.getElementById('cropContainer').style.display = 'block'; // Restore crop container
            document.getElementById('scanProcessPreviews').style.display = 'none'; // Hide process previews
        }
    }

    function cancelScan() {
        // Just reload for now as simple cancellation
        resetScan();
    }

    // Removed old analyzeScanResult as Gemini handles logic now

    function renderScanResults() {
        // Ensure status bar is hidden
        document.getElementById('scanInlineStatus').style.display = 'none';

        const listContainer = document.getElementById('scanList');
        listContainer.innerHTML = '';
        
        const codeMap = currentScanResults;
        const rawText = currentScanRawText;

        // Update sort buttons state
        const btnCode = document.getElementById('btn-sort-code');
        const btnQty = document.getElementById('btn-sort-qty');
        const btnMissing = document.getElementById('btn-scan-missing');
        
        if(btnCode && btnQty && btnMissing) {
            const activeStyle = "font-size: 12px; padding: 2px 8px; border: 1px solid #1890ff; background: #e6f7ff; color: #1890ff; border-radius: 4px; font-weight: bold;";
            const inactiveStyle = "font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; color: #666; border-radius: 4px;";
            
            btnCode.style.cssText = currentScanSortType === 'code' ? activeStyle : inactiveStyle;
            btnQty.style.cssText = currentScanSortType === 'qty' ? activeStyle : inactiveStyle;
            btnMissing.style.cssText = currentScanPrioritizeMissing ? activeStyle : inactiveStyle;
        }

        // Update header count
        const countEl = document.getElementById('scanTotalCount');
        if (countEl) {
            let totalQty = 0;
            codeMap.forEach(qty => totalQty += qty);
            countEl.innerHTML = `<span style="background:#e6f7ff; color:#1890ff; padding:2px 8px; border-radius:10px; font-weight:bold;">${codeMap.size} è‰² / ${totalQty} ç²’</span>`;
        }

        // --- Debug Details Section ---
        const detailsId = 'scan-debug-details';
        let detailsBtn = document.getElementById('scan-debug-btn');
        let detailsEl = document.getElementById(detailsId);
        
        if (!detailsEl) {
             const btn = document.createElement('button');
             btn.id = 'scan-debug-btn';
             btn.className = 'm-btn m-btn-ghost';
             btn.style.marginTop = '10px';
             btn.style.fontSize = '12px';
             btn.innerText = 'ğŸ” æ˜¾ç¤º/éšè— è¯†åˆ«è¯¦æƒ… (Debug)';
             btn.onclick = () => {
                 const el = document.getElementById(detailsId);
                 el.style.display = el.style.display === 'none' ? 'block' : 'none';
             };
             
             detailsEl = document.createElement('div');
             detailsEl.id = detailsId;
             detailsEl.style.display = 'none';
             detailsEl.style.marginTop = '10px';
             detailsEl.style.padding = '10px';
             detailsEl.style.background = '#f5f5f5';
             detailsEl.style.border = '1px solid #ddd';
             detailsEl.style.borderRadius = '8px';
             detailsEl.style.fontSize = '11px';
             detailsEl.style.fontFamily = 'monospace';
             detailsEl.style.whiteSpace = 'pre-wrap';
             detailsEl.style.wordBreak = 'break-all';
             
             document.getElementById('scanResult').appendChild(btn);
             document.getElementById('scanResult').appendChild(detailsEl);
        }
        
        // Update debug info
        if (detailsEl) {
            detailsEl.innerText = 
                `=== Raw Text ===\n${rawText}\n\n=== Parsed Pairs ===\n${JSON.stringify(Array.from(codeMap.entries()), null, 2)}`;
        }


        // --- Main List Rendering ---
        if (codeMap.size === 0) {
            listContainer.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #fa8c16; background: #fffbe6; border-radius: 8px; border: 1px solid #ffe58f;">
                    æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„è‰²å·æ•°æ®ã€‚<br>è¯·å°è¯•è°ƒæ•´è£åˆ‡åŒºåŸŸï¼Œç¡®ä¿åªåŒ…å«ã€è‰²å·å’Œæ•°é‡ã€‘ã€‚
                </div>
            `;
            // Add "Add Manually" button even if empty
             const addBtn = document.createElement('button');
             addBtn.className = 'm-btn m-btn-ghost';
             addBtn.style.marginTop = '10px';
             addBtn.innerHTML = '+ æ‰‹åŠ¨æ·»åŠ è‰²å·';
             addBtn.onclick = addScanItem;
             listContainer.appendChild(addBtn);
            return;
        }

        let totalMissing = 0;
        let missingCodes = 0;
        const BEAD_WEIGHT_PER_100 = 1; 

        // Convert map to array for sorting
        let sortedEntries = Array.from(codeMap.entries());
        
        // 1. Primary Sort (Code or Qty)
        if (currentScanSortType === 'qty') {
            sortedEntries.sort((a, b) => b[1] - a[1]);
        } else {
            sortedEntries.sort((a, b) => a[0].localeCompare(b[0], undefined, {numeric: true}));
        }

        // 2. Priority Sort (Missing First)
        if (currentScanPrioritizeMissing) {
            sortedEntries.sort((a, b) => {
                const getShortage = (code, qty) => {
                    const item = data.find(d => d.id === code);
                    const stock = item ? (item.w || 0) : 0;
                    const requiredWeight = qty / 100 * BEAD_WEIGHT_PER_100;
                    return stock < requiredWeight ? 1 : 0; // 1 = missing, 0 = ok
                };
                
                const missingA = getShortage(a[0], a[1]);
                const missingB = getShortage(b[0], b[1]);
                
                return missingB - missingA; // Missing first (descending order of isMissing)
            });
        }

        sortedEntries.forEach(([code, qty]) => {
            const item = data.find(d => d.id === code);
            const stock = item ? (item.w || 0) : 0;
            const hex = item ? item.hex : '#f0f0f0';
            
            const isUnknown = !item;
            
            const requiredWeight = qty / 100 * BEAD_WEIGHT_PER_100;
            const isMissing = !isUnknown && stock < requiredWeight;
            const shortage = isMissing ? (requiredWeight - stock) : 0;
            
            if (isMissing) {
                totalMissing += shortage;
                missingCodes++;
            }

            const row = document.createElement('div');
            row.style.cssText = 'display:flex; align-items:center; padding:12px; border-bottom:1px solid #f0f0f0; background:white; border-radius:8px; margin-bottom:8px;';
            
            // Unknown Color Logic
            if (isUnknown) {
                 row.style.borderLeft = '4px solid #fa8c16';
                 row.style.background = '#fff7e6';
            }

            row.innerHTML = `
                <div class="swatch" onclick="openScanColorModal('${code}')" style="width:30px; height:30px; background:${hex}; border-radius:50%; border:1px solid #ddd; margin-right:12px; flex-shrink:0; cursor:pointer; position:relative;">
                    <div style="position:absolute; right:-2px; bottom:-2px; background:white; border-radius:50%; width:12px; height:12px; display:flex; align-items:center; justify-content:center; border:1px solid #ddd;">
                        <span style="font-size:8px; color:#666;">â–¼</span>
                    </div>
                </div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <b style="font-size:16px; color:#333;">
                            ${code} 
                            ${isUnknown ? '<span style="font-size:10px; background:#fa8c16; color:white; padding:2px 4px; border-radius:4px; margin-left:5px; vertical-align:middle;">ç³»ç»Ÿæ— æ­¤è‰²å·</span>' : ''}
                        </b>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span onclick="openScanQtyModal('${code}')" style="font-size:14px; color:#1890ff; background:#e6f7ff; padding:2px 8px; border-radius:4px; cursor:pointer; border:1px dashed #91d5ff;">
                                éœ€ ${qty}ç²’ âœ
                            </span>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:13px;">
                        ${isUnknown 
                            ? `<span style="color:#fa8c16;">è¯·ç¡®è®¤è‰²å·æ˜¯å¦æ­£ç¡®æˆ–ç‚¹å‡»å·¦ä¾§ä¿®æ”¹</span>` 
                            : `<span style="color:#999;">åº“å­˜: ${stock}g</span>
                               ${isMissing 
                                   ? `<span style="color:#ff4d4f; font-weight:bold;">ç¼º ${shortage.toFixed(1)}g</span>` 
                                   : '<span style="color:#52c41a; font-weight:bold;">å……è¶³</span>'}`
                        }
                    </div>
                </div>
                <div style="margin-left:10px;">
                    <button onclick="deleteScanItem('${code}')" style="background:none; border:none; color:#999; padding:5px; cursor:pointer; font-size:24px; line-height: 1;">Ã—</button>
                </div>
            `;
            listContainer.appendChild(row);
        });
        
        // Summary Card
        const summaryCard = document.createElement('div');
        if (missingCodes > 0) {
            summaryCard.innerHTML = `âš ï¸ å…±ç¼ºè´§ <b>${missingCodes}</b> ç§ (éœ€è¡¥ ${totalMissing.toFixed(1)}g)`;
            summaryCard.style.cssText = 'padding: 10px; background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 13px;';
        } else {
            summaryCard.innerHTML = `ğŸ‰ åº“å­˜å…¨éƒ¨å……è¶³ï¼`;
            summaryCard.style.cssText = 'padding: 10px; background: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 13px;';
        }
        listContainer.insertBefore(summaryCard, listContainer.firstChild);

        // Add "Add" Button
        const addBtn = document.createElement('button');
        addBtn.className = 'm-btn m-btn-ghost';
        addBtn.style.marginTop = '10px';
        addBtn.style.width = '100%';
        addBtn.innerHTML = '+ æ·»åŠ è‰²å·';
        addBtn.onclick = addScanItem;
        listContainer.appendChild(addBtn);
    }

    let currentScanEditCode = null;

    // --- Scan Qty Modify Modal Logic ---
    function openScanQtyModal(code) {
        currentScanEditCode = code;
        const currentQty = currentScanResults.get(code);
        
        document.getElementById('scanQtyCode').innerText = code;
        document.getElementById('scanQtyInput').value = currentQty;
        
        showModal('scanQtyModal');
    }

    function adjustScanQty(delta) {
        const input = document.getElementById('scanQtyInput');
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 0) val = 0;
        input.value = val;
    }

    function submitScanQty() {
        if (!currentScanEditCode) return;
        const input = document.getElementById('scanQtyInput');
        const val = parseInt(input.value);
        
        if (!isNaN(val) && val >= 0) {
            currentScanResults.set(currentScanEditCode, val);
            renderScanResults();
            closeAllModals();
            showToast(`å·²æ›´æ–°è‰²å· ${currentScanEditCode} æ•°é‡`);
        } else {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼");
        }
    }

    // --- Scan Color Select Modal Logic ---
    function openScanColorModal(code) {
        currentScanEditCode = code;
        document.getElementById('scanColorSearch').value = '';
        renderScanColorList('');
        showModal('scanColorModal');
        // Auto focus search
        setTimeout(() => document.getElementById('scanColorSearch').focus(), 100);
    }

    function filterScanColorList() {
        const filter = document.getElementById('scanColorSearch').value;
        renderScanColorList(filter);
    }

    function renderScanColorList(filter) {
        const container = document.getElementById('scanColorList');
        container.innerHTML = '';
        
        const filterText = filter.toUpperCase();
        
        // Use 'data' global variable which contains all beads
        const filtered = data.filter(d => d.id.toUpperCase().includes(filterText));
        
        // Limit results for performance if empty filter
        const displayList = (filterText === '' ? filtered.slice(0, 50) : filtered);
        
        if (displayList.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æ— åŒ¹é…è‰²å·</div>';
            return;
        }

        displayList.forEach(item => {
            const isCurrent = item.id === currentScanEditCode;
            const div = document.createElement('div');
            div.style.cssText = `display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; background:${isCurrent ? '#e6f7ff' : 'white'}; cursor:pointer; border-radius:8px; margin-bottom:5px;`;
            div.onclick = () => selectScanColor(item.id);
            
            div.innerHTML = `
                <div style="width:30px; height:30px; background:${item.hex}; border-radius:50%; border:1px solid #ddd; margin-right:15px;"></div>
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#333;">${item.id}</div>
                    <div style="font-size:12px; color:#999;">åº“å­˜: ${item.w || 0}g</div>
                </div>
                ${isCurrent ? '<span style="color:#1890ff; font-weight:bold;">å½“å‰</span>' : ''}
            `;
            container.appendChild(div);
        });
        
        if (filterText === '' && data.length > 50) {
            const more = document.createElement('div');
            more.style.cssText = 'text-align:center; padding:10px; color:#999; font-size:12px;';
            more.innerText = `æ˜¾ç¤ºå‰ 50 ä¸ªç»“æœ (å…± ${data.length} ä¸ª)ï¼Œè¯·è¾“å…¥æœç´¢è¯æŸ¥æ‰¾`;
            container.appendChild(more);
        }
    }

    function selectScanColor(newCode) {
        if (!currentScanEditCode || currentScanEditCode === newCode) {
            closeAllModals();
            return;
        }

        // Check if new code already exists in scan results
        const existingQty = currentScanResults.get(newCode);
        const currentQty = currentScanResults.get(currentScanEditCode);

        if (existingQty !== undefined) {
             // Merge qty? Or overwrite? User intent implies switching identity. 
             // Let's ask or just merge. Merging seems safer for "switching" if user made a mistake.
             // But usually switching means "I identified this wrong, it's actually X".
             // If X is already in the list, we should probably add the qty to X and remove the old entry.
             if(confirm(`åˆ—è¡¨é‡Œå·²ç»å­˜åœ¨è‰²å· ${newCode} (æ•°é‡: ${existingQty})ã€‚\næ˜¯å¦åˆå¹¶æ•°é‡ï¼Ÿ\n(å¦‚æœä¸åˆå¹¶ï¼Œå°†è¦†ç›–åŸæœ‰æ•°é‡)`)) {
                 currentScanResults.set(newCode, existingQty + currentQty);
             } else {
                 // Do nothing? or set to currentQty? 
                 // Let's assume merge is preferred, but if cancelled, maybe just replace value
                 currentScanResults.set(newCode, currentQty); 
             }
        } else {
            // New entry
            currentScanResults.set(newCode, currentQty);
        }
        
        // Remove old entry
        currentScanResults.delete(currentScanEditCode);
        
        renderScanResults();
        closeAllModals();
        showToast(`å·²åˆ‡æ¢ä¸ºè‰²å· ${newCode}`);
    }


    let currentScanDeleteCode = null;

    function deleteScanItem(code) {
        currentScanDeleteCode = code;
        document.getElementById('scanDeleteCode').innerText = code;
        showModal('scanDeleteConfirmModal');
    }

    function confirmDeleteScanItem() {
        if (currentScanDeleteCode) {
            currentScanResults.delete(currentScanDeleteCode);
            renderScanResults();
            closeAllModals();
            showToast(`å·²åˆ é™¤è‰²å· ${currentScanDeleteCode}`);
        }
    }

    function addScanItem() {
        document.getElementById('scanAddCodeInput').value = '';
        document.getElementById('scanAddQtyInput').value = '0';
        showModal('scanAddModal');
        setTimeout(() => document.getElementById('scanAddCodeInput').focus(), 100);
    }

    function adjustAddScanQty(delta) {
        const input = document.getElementById('scanAddQtyInput');
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 0) val = 0;
        input.value = val;
    }

    function submitAddScanItem() {
        const codeInput = document.getElementById('scanAddCodeInput');
        const qtyInput = document.getElementById('scanAddQtyInput');
        
        const code = codeInput.value.toUpperCase().trim();
        const qty = parseInt(qtyInput.value);

        if (!code) {
            showToast("è¯·è¾“å…¥è‰²å·ï¼");
            return;
        }

        if (isNaN(qty) || qty < 0) {
            showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡ï¼");
            return;
        }

        if (currentScanResults.has(code)) {
            showToast(`è‰²å· ${code} å·²å­˜åœ¨ï¼è¯·ç›´æ¥åœ¨åˆ—è¡¨ä¸­ä¿®æ”¹æ•°é‡ã€‚`);
            return;
        }

        currentScanResults.set(code, qty);
        renderScanResults();
        closeAllModals();
        showToast(`å·²æ·»åŠ è‰²å· ${code}`);
        
        // Scroll to bottom or new item? 
        // renderScanResults might sort, so we can't easily scroll to it without finding it.
    }

    function resetScan() {
        document.getElementById('scanInput').value = '';
        document.getElementById('scanPreviewImg').src = '';
        
        // Reset UI visibility
        document.getElementById('scan-uploader').style.display = 'block'; // Show uploader area
        document.getElementById('scanPreview').style.display = 'block';
        document.getElementById('cropContainer').style.display = 'none';
        document.getElementById('scanProcessPreviews').style.display = 'none';
        document.getElementById('cropControls').style.display = 'none';
        document.getElementById('scanResult').style.display = 'none';
        document.getElementById('scanLoading').style.display = 'none';
        
        // Clean up cropper
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
    }

    function toggleMoreMenu() {
        const sheet = document.getElementById('moreMenuSheet');
        if (sheet.classList.contains('show')) {
            sheet.classList.remove('show');
            setTimeout(() => { sheet.style.display = 'none'; }, 300);
        } else {
            sheet.style.display = 'block';
            // Trigger reflow
            sheet.offsetHeight; 
            sheet.classList.add('show');
        }
    }

    // --- æ‹¼è±†è®¡åˆ’åŠŸèƒ½ ---

    function createPlan() {
        if (!currentScanResults || currentScanResults.size === 0) {
            alert('å½“å‰æ²¡æœ‰è¯†åˆ«ç»“æœï¼Œæ— æ³•åˆ›å»ºè®¡åˆ’ã€‚è¯·å…ˆæ‰«æå›¾çº¸ã€‚');
            return;
        }

        const nameInput = document.getElementById('planNameInput');
        let planName = nameInput.value.trim();
        if (!planName) {
            const date = new Date();
            planName = `æœªå‘½åè®¡åˆ’ ${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
        }

        // Capture Thumbnail
        let thumbnail = null;
        try {
            const originalImg = document.getElementById('scanPreviewImg');
            if (originalImg && originalImg.src && originalImg.naturalWidth > 0) {
                 // Create thumbnail from ORIGINAL image
                 const canvas = document.createElement('canvas');
                 const ctx = canvas.getContext('2d');
                 const maxDim = 300; // Limit size to 300px
                 let w = originalImg.naturalWidth;
                 let h = originalImg.naturalHeight;
                 
                 if (w > h) {
                     if (w > maxDim) { h *= maxDim / w; w = maxDim; }
                 } else {
                     if (h > maxDim) { w *= maxDim / h; h = maxDim; }
                 }
                 
                 canvas.width = w;
                 canvas.height = h;
                 ctx.drawImage(originalImg, 0, 0, w, h);
                 thumbnail = canvas.toDataURL('image/jpeg', 0.6);
            } else if (typeof cropper !== 'undefined' && cropper) {
                // Fallback to cropper
                thumbnail = cropper.getCroppedCanvas({
                    width: 150, 
                    height: 150
                }).toDataURL('image/jpeg', 0.6);
            }
        } catch(e) {
            console.warn('Failed to create thumbnail', e);
        }

        const planItems = [];
        currentScanResults.forEach((qty, code) => {
            planItems.push({ code, qty });
        });

        // Get existing plans
        let plans = [];
        try {
            plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        } catch(e) {
            console.error('Error loading plans', e);
        }

        const newPlan = {
            id: 'plan_' + Date.now(),
            name: planName,
            createdAt: Date.now(),
            items: planItems,
            status: 'active', // active, completed
            thumbnail: thumbnail
        };

        plans.unshift(newPlan); // Add to top
        localStorage.setItem('bead_plans', JSON.stringify(plans));

        showToast(`è®¡åˆ’ "${planName}" åˆ›å»ºæˆåŠŸï¼`);
        
        // Optional: clear input
        nameInput.value = '';
        resetScan(); // Auto clear scan page
        navToDock('plan');
        setPlanFilter('active');
    }

    function deductInventory() {
        if (!currentScanResults || currentScanResults.size === 0) {
            alert('å½“å‰æ²¡æœ‰è¯†åˆ«ç»“æœï¼Œæ— æ³•æ‰£å‡åº“å­˜ã€‚');
            return;
        }

        // 1. Create Plan
        const date = new Date();
        // Check for user provided name
        const nameInput = document.getElementById('planNameInput');
        let userPlanName = nameInput && nameInput.value.trim() ? nameInput.value.trim() : '';
        
        const planName = userPlanName || `æ‰«ææ‰£å‡ ${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
        
        let planItems = [];
        currentScanResults.forEach((qty, code) => {
            planItems.push({ code, qty });
        });
        
        // Capture Thumbnail (reuse logic from createPlan, or simplify)
        let thumbnail = null;
        try {
            const originalImg = document.getElementById('scanPreviewImg');
            if (originalImg && originalImg.src && originalImg.naturalWidth > 0) {
                 const canvas = document.createElement('canvas');
                 const ctx = canvas.getContext('2d');
                 const maxDim = 300; 
                 let w = originalImg.naturalWidth;
                 let h = originalImg.naturalHeight;
                 if (w > h) { if (w > maxDim) { h *= maxDim / w; w = maxDim; } } 
                 else { if (h > maxDim) { w *= maxDim / h; h = maxDim; } }
                 canvas.width = w; canvas.height = h;
                 ctx.drawImage(originalImg, 0, 0, w, h);
                 thumbnail = canvas.toDataURL('image/jpeg', 0.6);
            } else if (typeof cropper !== 'undefined' && cropper) {
                thumbnail = cropper.getCroppedCanvas({ width: 300 }).toDataURL('image/jpeg', 0.6);
            }
        } catch(e) { console.error("Thumbnail error", e); }

        const newPlan = {
            id: 'plan_' + Date.now(),
            name: planName,
            createdAt: Date.now(),
            items: planItems,
            status: 'active', // Will be set to completed by deductPlanInventory
            thumbnail: thumbnail
        };

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        plans.unshift(newPlan);
        localStorage.setItem('bead_plans', JSON.stringify(plans));

        // 2. Execute Deduction (inline logic without confirm)
        
        const BEAD_WEIGHT_PER_100 = 1;
        let count = 0;
        
        newPlan.items.forEach(pItem => {
             const item = data.find(d => d.id === pItem.code);
             if(item) {
                 const weightToDeduct = parseFloat((pItem.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
                 item.w = parseFloat((item.w - weightToDeduct).toFixed(2));
                 
                 if (!item.logs) item.logs = [];
                 item.logs.push({
                    d: formatTime(new Date()),
                    type: 'use', 
                    val: weightToDeduct,
                    c: pItem.qty, 
                    desc: `è®¡åˆ’æ‰£å‡: ${newPlan.name}`,
                    drawingName: newPlan.name,
                    planId: newPlan.id
                 });
                 item.totalUsed = parseFloat(((item.totalUsed || 0) + weightToDeduct).toFixed(2));
                 count++;
             }
        });
        
        if (count > 0) {
            save();
            render(); 
        }
        
        // Mark as completed
        newPlan.status = 'completed';
        newPlan.completedAt = Date.now();
        localStorage.setItem('bead_plans', JSON.stringify(plans)); // Save updated status
        
        showToast(`å·²è‡ªåŠ¨åˆ›å»ºè®¡åˆ’å¹¶æ‰£å‡ ${count} ä¸ªè‰²å·åº“å­˜ã€‚`);
        resetScan(); // Auto clear scan page
        navToDock('plan');
        setPlanFilter('completed');
    }

    let currentPlanId = null;
    let isPlanSelectionMode = false;
    let selectedPlanIds = new Set();
    let expandedPlanIds = new Set();
    let expandedPlanColorIds = new Set();
    let longPressTimer = null;
    let currentPlanFilter = 'active';

    function setPlanFilter(status) {
        currentPlanFilter = status;
        
        const activeBtn = document.getElementById('filter-active');
        const completedBtn = document.getElementById('filter-completed');
        
        if(status === 'active') {
            activeBtn.style.background = 'white';
            activeBtn.style.color = '#4a90e2';
            activeBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
            completedBtn.style.background = 'transparent';
            completedBtn.style.color = '#999';
            completedBtn.style.boxShadow = 'none';
        } else {
            activeBtn.style.background = 'transparent';
            activeBtn.style.color = '#999';
            activeBtn.style.boxShadow = 'none';
            completedBtn.style.background = 'white';
            completedBtn.style.color = '#4a90e2';
            completedBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
        }
        
        renderPlans();
    }

    function renameCurrentPlan() {
        if (!currentPlanId) return;
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(currentPlanId, plans);
        if (!plan) return;

        openRenamePlanModal(plan.name);
    }

    function openRenamePlanModal(currentName) {
        const modal = document.getElementById('renamePlanModal');
        const input = document.getElementById('renamePlanInput');
        if (modal && input) {
            input.value = currentName;
            showModal('renamePlanModal');
            // Delay focus slightly to ensure modal is visible
            setTimeout(() => input.focus(), 100);
        }
    }

    function submitRenamePlan() {
        if (!currentPlanId) return;
        
        const input = document.getElementById('renamePlanInput');
        const newName = input.value.trim();
        
        if (newName) {
            let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
            const plan = findPlanById(currentPlanId, plans);
            
            if (plan) {
                plan.name = newName;
                localStorage.setItem('bead_plans', JSON.stringify(plans));
                
                // Update UI if we are viewing this plan
                const titleEl = document.getElementById('planDetailTitle');
                if (titleEl) titleEl.innerText = plan.name;
                
                renderPlans();
                showToast(`è®¡åˆ’é‡å‘½åä¸º "${newName}"`);
            }
        }
        closeAllModals();
    }

    function findPlanById(id, list) {
        if (!list) list = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        for (let p of list) {
            if (p.id === id) return p;
            if (p.subPlans) {
                const found = findPlanById(id, p.subPlans);
                if (found) return found;
            }
        }
        return null;
    }

    function aggregateActivePlanRequirements(plans) {
        const requirements = new Map();
        const BEAD_WEIGHT_PER_100 = 1; // 1g per 100 beads

        function processPlan(plan) {
            // If it's a folder, process its sub-plans
            if (plan.subPlans && plan.subPlans.length > 0) {
                // For collections, we check each sub-plan's status independently
                plan.subPlans.forEach(subPlan => {
                    // Only count ACTIVE sub-plans
                    if (subPlan.status === 'active') {
                        processPlan(subPlan);
                    }
                });
            } else if (plan.status === 'active' && plan.items) {
                // If it's a regular active plan, add its items
                plan.items.forEach(item => {
                    const current = requirements.get(item.code) || 0;
                    requirements.set(item.code, current + item.qty);
                });
            }
        }

        // Start processing top-level plans
        plans.forEach(plan => processPlan(plan));

        // Calculate shortages
        const shortages = [];
        requirements.forEach((qty, code) => {
            const bead = data.find(d => d.id === code);
            const currentStock = bead ? (bead.w || 0) : 0;
            // Check if monitoring is disabled (default is true/undefined, explicit false means disabled)
            const isMonitored = bead ? (bead.monitor !== false) : true;
            
            const neededWeight = (qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2);
            
            // Only report shortage if stock is insufficient AND monitoring is enabled
            if (currentStock < neededWeight && isMonitored) {
                shortages.push({
                    code,
                    neededQty: qty,
                    missingQty: Math.ceil((neededWeight - currentStock) * 100) / 100 
                });
                // Recalculate missing weight properly for display
                shortages[shortages.length - 1].missingQty = (neededWeight - currentStock).toFixed(2);
            }
        });

        return { requirements, shortages };
    }

    function renderPlans() {
        const container = document.getElementById('planList');
        if (!container) return;

        let plans = [];
        try {
            plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        } catch(e) {
            plans = [];
        }

        // Calculate counts
        // Helper to count real plans (leaves)
        const getRealCount = (list) => {
            let count = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    count += getRealCount(p.subPlans);
                } else {
                    count++;
                }
            });
            return count;
        };

        const activeList = plans.filter(p => (p.status || 'active') === 'active');
        const completedList = plans.filter(p => (p.status || 'active') === 'completed');

        const activeCount = getRealCount(activeList);
        const completedCount = getRealCount(completedList);
        
        // Update filter buttons text
        const activeBtn = document.getElementById('filter-active');
        const completedBtn = document.getElementById('filter-completed');
        if (activeBtn) activeBtn.innerText = `è®¡åˆ’ä¸­ (${activeCount})`;
        if (completedBtn) completedBtn.innerText = `å·²å®Œæˆ (${completedCount})`;

        // Filter plans based on status (top level only)
        const filtered = plans.filter(p => (p.status || 'active') === currentPlanFilter);

        if (filtered.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px;">
                    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“‹</div>
                    ${currentPlanFilter === 'active' ? 'æš‚æ— è¿›è¡Œä¸­çš„è®¡åˆ’' : 'æš‚æ— å·²å®Œæˆçš„è®¡åˆ’'}
                </div>
            `;
            return;
        }

        container.innerHTML = '';

        // Add Active Plan Summary (New Requirement)
        if (currentPlanFilter === 'active') {
             const summary = aggregateActivePlanRequirements(plans); // We pass all plans, function handles recursion and filtering
             if (summary && summary.requirements.size > 0) {
                 // Render Summary
                 const summaryCard = document.createElement('div');
                 summaryCard.style.cssText = 'background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid #bae7ff; box-shadow: 0 4px 12px rgba(24, 144, 255, 0.1);';
                 
                 let totalQty = 0;
                 summary.requirements.forEach(qty => totalQty += qty);
                 
                 let missingHtml = '';
                 if (summary.shortages.length > 0) {
                     summary.shortages.sort((a, b) => b.missingQty - a.missingQty);
                     const missingItems = summary.shortages.map(item => `
                         <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 6px; border: 1px solid #ffccc7; margin-bottom: 4px;">
                             <span style="font-weight: bold; color: #cf1322;">${item.code}</span>
                             <span style="font-size: 12px; color: #666;">ç¼º ${item.missingQty}g</span>
                         </div>
                     `).join('');
                     
                     missingHtml = `
                         <div style="margin-top: 12px; padding-top: 10px; border-top: 1px dashed #ffa39e;">
                             <div style="font-size: 13px; font-weight: bold; color: #cf1322; margin-bottom: 8px; display: flex; align-items: center;">
                                 <span style="margin-right: 4px;">âš ï¸</span> ç¼ºè´§é¢„è­¦ (${summary.shortages.length} è‰²)
                             </div>
                             <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 6px;">
                                 ${missingItems}
                             </div>
                         </div>
                     `;
                 } else {
                     missingHtml = `
                         <div style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed #bae7ff; color: #52c41a; font-size: 13px; font-weight: bold;">
                             âœ… åº“å­˜å……è¶³ï¼Œæ— ç¼ºè´§è‰²å·
                         </div>
                     `;
                 }
                 
                 summaryCard.innerHTML = `
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                         <div style="font-weight: bold; font-size: 16px; color: #0050b3;">ğŸ“Š è®¡åˆ’æ€»è§ˆ</div>
                         <div style="font-size: 12px; color: #69c0ff;">å…± ${summary.requirements.size} è‰² / ${totalQty} é¢—</div>
                     </div>
                     ${missingHtml}
                 `;
                 container.appendChild(summaryCard);
             }
        }
        renderPlanList(filtered, container);
    }

    function renderPlanList(list, container) {
        list.forEach(plan => {
            container.appendChild(createPlanCardElement(plan, false));
            
            // Render children if expanded
            if (plan.subPlans && plan.subPlans.length > 0 && expandedPlanIds.has(plan.id)) {
                const childContainer = document.createElement('div');
                childContainer.style.cssText = 'margin-left: 20px; padding-left: 10px; border-left: 2px solid #eee; margin-bottom: 15px;';
                
                renderPlanList(plan.subPlans, childContainer);
                container.appendChild(childContainer);
            }
        });
    }

    let currentSwipedPlanId = null;

    function createPlanCardElement(plan, isChild) {
        const items = plan.items || [];
        const date = new Date(plan.createdAt);
        const dateStr = `åˆ›å»º: ${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
        
        let completedDateStr = '';
        if (plan.status === 'completed' && plan.completedAt) {
            const cDate = new Date(plan.completedAt);
            completedDateStr = `å®Œæˆ: ${cDate.getFullYear()}/${cDate.getMonth()+1}/${cDate.getDate()}`;
        }
        
        const totalQty = items.reduce((sum, item) => sum + item.qty, 0);
        const totalCodes = items.length;
        const isFolder = plan.subPlans && plan.subPlans.length > 0;

        // Check parent for Move Out button
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const parent = findParent(plan.id, plans, null);
        const hasParent = !!parent;

        const card = document.createElement('div');
        card.className = 'plan-card';
        // Wrapper style: relative, overflow hidden for swipe
        card.style.cssText = 'background: transparent; margin-bottom: 12px; position: relative; overflow: hidden; height: auto; border-radius: 12px;';
        
        // --- Define Swipe Actions ---
        const actions = [];
        
        // 1. Withdraw (Only if completed)
        if (plan.status === 'completed') {
            actions.push({
                text: 'æ’¤å›',
                bg: '#ff9800',
                click: (e) => { e.stopPropagation(); revertPlanToActive(plan.id); resetSwipe(); }
            });
        }
        
        // 2. Move Out (Only if has parent)
        if (hasParent) {
            actions.push({
                text: 'ç§»å‡º',
                bg: '#fa8c16',
                click: (e) => { e.stopPropagation(); movePlanOut(plan.id); resetSwipe(); }
            });
        }
        
        // 3. Copy (Only if NOT completed)
        if (plan.status !== 'completed') {
            actions.push({
                text: 'å¤åˆ¶',
                bg: '#1890ff',
                click: (e) => { e.stopPropagation(); duplicatePlan(plan.id); resetSwipe(); }
            });
        }
        
        // 4. Delete (Only if NOT completed)
        if (plan.status !== 'completed') {
            actions.push({
                text: 'åˆ é™¤',
                bg: '#ff4d4f',
                click: (e) => { e.stopPropagation(); deletePlan(plan.id); resetSwipe(); }
            });
        }

        const actionBtnWidth = 64;
        const totalActionWidth = actions.length * actionBtnWidth;

        // Actions HTML
        let actionsHtml = actions.map(action => `
            <div class="swipe-action-btn" style="
                width: ${actionBtnWidth}px; 
                height: 100%; 
                background: ${action.bg}; 
                color: white; 
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                font-size: 13px;
                font-weight: bold;
                cursor: pointer;
            ">
                ${action.text}
            </div>
        `).join('');
        
        // Add Actions Container
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'plan-card-actions';
        actionsContainer.style.cssText = 'position: absolute; top: 0; right: 0; bottom: 0; display: flex; z-index: 1; border-radius: 0 12px 12px 0; overflow: hidden;';
        actionsContainer.innerHTML = actionsHtml;
        
        // Bind Action Clicks
        const actionBtns = actionsContainer.querySelectorAll('.swipe-action-btn');
        actionBtns.forEach((btn, index) => {
            btn.onclick = actions[index].click;
        });
        card.appendChild(actionsContainer);

        // --- Card Inner Content (Visible Part) ---
        const innerEl = document.createElement('div');
        innerEl.className = 'plan-card-inner';
        innerEl.style.cssText = 'background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; z-index: 2; transition: transform 0.2s ease-out; border: 1px solid #f0f0f0; width: 100%; box-sizing: border-box; display: flex; align-items: stretch;';
        
        // --- Selection Mode Logic ---
        if (isPlanSelectionMode && selectedPlanIds.has(plan.id)) {
            innerEl.classList.add('selected');
            innerEl.style.background = '#f0f7ff';
            innerEl.style.borderColor = '#4a90e2';
            innerEl.style.boxShadow = '0 0 0 2px #4a90e2';
        }
        
        // Icon Logic
        let iconHtml = '';
        if (plan.thumbnail) {
             iconHtml = `<img src="${plan.thumbnail}" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else if (isFolder) {
             iconHtml = `<div style="font-size: 20px;">ğŸ“‚</div>`;
        } else {
             iconHtml = `<div style="font-size: 20px;">ğŸ“…</div>`;
        }
        
        const iconContainerStyle = plan.thumbnail 
            ? "width: 40px; height: 40px; border-radius: 8px; overflow: hidden; border: 1px solid #eee; margin-right: 12px; flex-shrink: 0;"
            : "width: 40px; height: 40px; background: #f9f0ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;";

        const iconContainerHtml = `<div style="${iconContainerStyle}">${iconHtml}</div>`;

        // Color List Logic
        let itemsHtml = '';
        const sortedItems = [...items].sort((a, b) => b.qty - a.qty);
        const previewLimit = 7;
        const visibleItems = sortedItems.slice(0, previewLimit);
        const remainingCount = Math.max(0, sortedItems.length - previewLimit);

        visibleItems.forEach(item => {
            itemsHtml += `
                <div style="
                    background: #fff7e6; 
                    color: #d46b08;
                    border-radius: 4px; 
                    padding: 2px 6px;
                    font-size: 11px; 
                    font-weight: 500;
                    white-space: nowrap;
                ">
                    ${item.code}
                </div>
            `;
        });
        
        if (remainingCount > 0) {
            itemsHtml += `<div style="font-size: 11px; color: #999; padding: 2px 4px;">+${remainingCount}</div>`;
        }

        const checkboxHtml = ''; 

        // Action Button (Play/Complete)
        let actionBtnHtml = '';
        if (plan.status === 'active' && !isPlanSelectionMode) {
             actionBtnHtml = `
                <div class="action-play-btn" onclick="event.stopPropagation(); deductPlanInventory('${plan.id}')" style="
                    width: 28px; height: 28px; 
                    background: #52c41a; 
                    border-radius: 50%; 
                    display: flex; align-items: center; justify-content: center; 
                    color: white; 
                    cursor: pointer; 
                    box-shadow: 0 2px 6px rgba(82, 196, 26, 0.3);
                ">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </div>
             `;
        } else if (plan.status === 'completed' && !isPlanSelectionMode) {
             actionBtnHtml = `
                <div style="
                    width: 28px; height: 28px; 
                    background: #f6ffed; 
                    border-radius: 50%; 
                    display: flex; align-items: center; justify-content: center; 
                    color: #52c41a; 
                    border: 1px solid #b7eb8f;
                ">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </div>
             `;
        }

        // Folder Expand Logic
        let folderExpandHtml = '';
        if (isFolder) {
            const isExpanded = expandedPlanIds.has(plan.id);
            folderExpandHtml = `
                <div class="expand-btn-wrapper" onclick="event.stopPropagation(); toggleFolder('${plan.id}')" style="
                    padding: 4px;
                    margin-right: 12px;
                    flex-shrink: 0;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 28px;
                    height: 28px;
                ">
                    <div style="
                        transform: rotate(${isExpanded ? '90deg' : '0deg'});
                        transition: transform 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 20px;
                        height: 20px;
                        color: #ccc;
                    ">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </div>
                </div>
            `;
        }
        
        let folderTagHtml = '';
        if (isFolder) {
            folderTagHtml = `
                <div style="
                    background: #e6f7ff; 
                    color: #1890ff; 
                    font-size: 11px; 
                    padding: 2px 6px; 
                    border-radius: 4px; 
                    margin-right: 10px;
                    display: inline-block;
                    font-weight: 500;
                ">
                    ${plan.subPlans.length}ä¸ª
                </div>
            `;
        }

        const statsHtml = `
            <div style="display: flex; align-items: center; gap: 15px; font-size: 12px; color: #666;">
                ${folderTagHtml}
                <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="font-size: 14px; opacity: 0.7;">ğŸ¨</span> 
                    <span style="font-weight: 500;">${totalCodes} è‰²</span>
                </div>
                ${!isFolder ? `
                <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="font-size: 14px; opacity: 0.7;">ğŸ”¢</span> 
                    <span style="font-weight: 500;">${totalQty.toLocaleString()} é¢—</span>
                </div>` : ''}
            </div>
        `;

        const arrowHtml = `
            <div style="color: #ccc; margin-left: 4px;">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
        `;

        innerEl.innerHTML = `
            <div style="display: flex; align-items: stretch; width: 100%;">
                ${folderExpandHtml}
                ${checkboxHtml}
                
                <div style="flex: 1; overflow: hidden; padding-right: 8px;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        ${iconContainerHtml}
                        <div style="font-weight: bold; font-size: 16px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${plan.name}
                        </div>
                    </div>

                    <div style="margin-bottom: ${!isFolder && visibleItems.length > 0 ? '8px' : '0'};">
                        ${statsHtml}
                    </div>
                    
                    ${!isFolder && visibleItems.length > 0 ? `
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center; margin-top: 4px;">
                        ${itemsHtml}
                    </div>
                    ` : ''}
                </div>

                <div style="display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; padding-left: 10px;">
                    <div style="font-size: 11px; color: #999; white-space: nowrap; margin-bottom: 8px; text-align: right;">
                        ${completedDateStr ? `<div style="margin-bottom: 2px;">${completedDateStr}</div>` : ''}
                        <div>${dateStr}</div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 8px;">
                         ${actionBtnHtml}
                         ${arrowHtml}
                    </div>
                </div>
            </div>
        `;
        
        card.appendChild(innerEl);

        // --- Swipe Logic ---
        let startX = 0;
        let startY = 0;
        let currentX = 0;
        let isSwiping = false;
        let isOpened = false;
        let isMouseDown = false; // Add mouse support
        
        const resetSwipe = () => {
             innerEl.style.transform = `translateX(0)`;
             isOpened = false;
             if (currentSwipedPlanId === plan.id) currentSwipedPlanId = null;
        };

        // Long Press Logic Helpers
        let longPressTimer;
        const startHandler = (e) => {
            if(isOpened) return;
            longPressTimer = setTimeout(() => {
                enterPlanSelectionMode(plan.id);
            }, 800);
        };
        const endHandler = (e) => {
            // For move events, only cancel if moved significantly
            if (e.type === 'touchmove' || e.type === 'mousemove') {
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                if (Math.abs(cx - startX) < 5 && Math.abs(cy - startY) < 5) {
                    return; // Ignore small jitter
                }
            }
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        };
        
        if (!isPlanSelectionMode) {
            // 1. Touch Events (Mobile)
            innerEl.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                currentX = startX;
                isSwiping = false;
                
                // Close other opened card
                if (currentSwipedPlanId && currentSwipedPlanId !== plan.id) {
                     // Global reset via ID check in other components if implemented, 
                     // or just rely on user tapping the other one to close.
                }
                
                startHandler(e); // Start Long Press
            }, {passive: true});

            innerEl.addEventListener('touchmove', (e) => {
                currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                let deltaX = currentX - startX;
                const deltaY = currentY - startY;

                // Lock horizontal scroll if vertical movement is dominant
                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    endHandler(e); // Cancel long press if scrolling vertically
                    return;
                }
                
                // If already opened, start from offset
                if (isOpened) {
                    deltaX -= totalActionWidth;
                }
                
                // Limit swipe range
                if (deltaX > 0) deltaX = 0; 
                if (deltaX < -totalActionWidth - 30) deltaX = -totalActionWidth - 30;
                
                if (Math.abs(deltaX) > 5) isSwiping = true;
                
                innerEl.style.transform = `translateX(${deltaX}px)`;
                
                endHandler(e); // Cancel long press if swiping
            }, {passive: true});

            innerEl.addEventListener('touchend', (e) => {
                const deltaX = currentX - startX;
                const threshold = totalActionWidth / 3;
                
                if (isOpened) {
                    if (deltaX > threshold) { // Swipe Right to close
                         resetSwipe();
                    } else {
                         innerEl.style.transform = `translateX(-${totalActionWidth}px)`;
                    }
                } else {
                    if (deltaX < -threshold) { // Swipe Left to open
                         innerEl.style.transform = `translateX(-${totalActionWidth}px)`;
                         isOpened = true;
                         currentSwipedPlanId = plan.id;
                    } else {
                         resetSwipe();
                    }
                }
                
                endHandler(e); // Clear long press
            });
            
            // 2. Mouse Events (Desktop)
            innerEl.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                startY = e.clientY;
                currentX = startX;
                isMouseDown = true;
                isSwiping = false;
                
                startHandler(e); // Start Long Press (Desktop support)
            });
            
            innerEl.addEventListener('mousemove', (e) => {
                if (!isMouseDown) return;
                
                currentX = e.clientX;
                const currentY = e.clientY;
                let deltaX = currentX - startX;
                const deltaY = currentY - startY;

                // Lock horizontal
                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    endHandler(e);
                    return;
                }
                
                e.preventDefault(); // Prevent text selection on drag
                
                if (isOpened) {
                    deltaX -= totalActionWidth;
                }
                
                if (deltaX > 0) deltaX = 0; 
                if (deltaX < -totalActionWidth - 30) deltaX = -totalActionWidth - 30;
                
                if (Math.abs(deltaX) > 5) isSwiping = true;
                
                innerEl.style.transform = `translateX(${deltaX}px)`;
                
                endHandler(e);
            });
            
            innerEl.addEventListener('mouseup', (e) => {
                if (!isMouseDown) return;
                isMouseDown = false;
                
                const deltaX = currentX - startX;
                const threshold = totalActionWidth / 3;
                
                if (isOpened) {
                    if (deltaX > threshold) { 
                         resetSwipe();
                    } else {
                         innerEl.style.transform = `translateX(-${totalActionWidth}px)`;
                    }
                } else {
                    if (deltaX < -threshold) { 
                         innerEl.style.transform = `translateX(-${totalActionWidth}px)`;
                         isOpened = true;
                         currentSwipedPlanId = plan.id;
                    } else {
                         resetSwipe();
                    }
                }
                
                endHandler(e);
            });
            
            innerEl.addEventListener('mouseleave', (e) => {
                if (isMouseDown) {
                    isMouseDown = false;
                    resetSwipe();
                    endHandler(e);
                }
            });

            // Click Logic
            innerEl.onclick = (e) => {
                if (isSwiping) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                if (isOpened) {
                    resetSwipe();
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                if (e.target.closest('.expand-btn')) return;
                if (e.target.closest('.action-play-btn')) return;
                
                viewPlanDetail(plan.id);
            };
        } else {
             innerEl.onclick = () => togglePlanSelection(plan.id);
        }

        return card;
    }

    function toggleFolder(id) {
        if (expandedPlanIds.has(id)) {
            expandedPlanIds.delete(id);
        } else {
            expandedPlanIds.add(id);
        }
        renderPlans();
    }

    function togglePlanColor(id) {
        if (expandedPlanColorIds.has(id)) {
            expandedPlanColorIds.delete(id);
        } else {
            expandedPlanColorIds.add(id);
        }
        renderPlans();
    }

    function findParent(id, list, parent) {
        if (!list) return null;
        for (let p of list) {
            if (p.id === id) return parent;
            if (p.subPlans && p.subPlans.length > 0) {
                const found = findParent(id, p.subPlans, p);
                if (found) return found;
            }
        }
        return null;
    }

    function movePlanOut(id) {
        if (!id) return;
        currentMoveOutPlanId = id;
        showModal('moveOutConfirmModal');
    }

    function confirmMoveOutPlan() {
        if (!currentMoveOutPlanId) return;
        const id = currentMoveOutPlanId;
        closeAllModals();

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const parent = findParent(id, plans, null);
        
        if (!parent) {
            alert('æœªæ‰¾åˆ°çˆ¶æ–‡ä»¶å¤¹ï¼Œæ— æ³•ç§»å‡ºã€‚');
            return;
        }

        const idx = parent.subPlans.findIndex(p => p.id === id);
        if (idx === -1) return;
        
        const [planToMove] = parent.subPlans.splice(idx, 1);
        
        if (parent.subPlans.length === 0) {
            deletePlanRecursive(plans, parent.id);
        } else {
            recalculatePlanItems(parent);
        }
        
        plans.unshift(planToMove);
        localStorage.setItem('bead_plans', JSON.stringify(plans));
        
        showToast('è®¡åˆ’å·²ç§»å‡ºæ–‡ä»¶å¤¹');
        renderPlans();
        currentMoveOutPlanId = null;
    }

    let currentPlanDetailSort = 'qty';

    function togglePlanDetailSort() {
        currentPlanDetailSort = (currentPlanDetailSort === 'qty') ? 'code' : 'qty';
        renderPlanDetailList();
    }

    function renderPlanDetailList() {
        if (!currentPlanId) return;
        const plan = findPlanById(currentPlanId);
        if (!plan) return;

        // Update Sort Button Text
        const sortBtn = document.getElementById('planDetailSortBtn');
        if (sortBtn) {
            sortBtn.innerText = currentPlanDetailSort === 'qty' ? 'æŒ‰ç”¨é‡ â†“' : 'æŒ‰è‰²å· â†‘';
        }

        const listContainer = document.getElementById('planDetailList');
        listContainer.innerHTML = '';

        let sortedItems = [...plan.items];
        if (currentPlanDetailSort === 'qty') {
            sortedItems.sort((a, b) => b.qty - a.qty);
        } else {
            // Natural sort for codes
            sortedItems.sort((a, b) => a.code.localeCompare(b.code, undefined, {numeric: true, sensitivity: 'base'}));
        }

        sortedItems.forEach(item => {
             const bead = data.find(d => d.id === item.code);
             const hex = bead ? bead.hex : '#eee';
             const isUnknown = !bead;
             
             const row = document.createElement('div');
             row.style.cssText = 'background: white; padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);';
             
             if (isUnknown) {
                 row.style.borderLeft = '4px solid #fa8c16';
                 row.style.background = '#fff7e6';
             }

             row.innerHTML = `
                <div style="width: 36px; height: 36px; background: ${hex}; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1);"></div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; font-size: 16px; color: #333;">
                        ${item.code}
                        ${isUnknown ? '<span style="font-size:10px; background:#fa8c16; color:white; padding:2px 4px; border-radius:4px; margin-left:5px; vertical-align:middle;">ç³»ç»Ÿæ— æ­¤è‰²å·</span>' : ''}
                    </div>
                    ${isUnknown ? '<div style="font-size: 12px; color: #fa8c16; margin-top: 4px;">è¯·ç¡®è®¤è‰²å·æ˜¯å¦æ­£ç¡®</div>' : ''}
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: bold; font-size: 18px; color: #333;">${item.qty}</div>
                    <div style="font-size: 10px; color: #ccc;">ç²’</div>
                </div>
                <div onclick="deletePlanDetailItem('${item.code}')" style="margin-left: 10px; padding: 5px; color: #999; font-size: 20px; cursor: pointer;">Ã—</div>
             `;
             listContainer.appendChild(row);
        });
    }

    function deletePlanDetailItem(code) {
        if (!currentPlanId) return;
        
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        // Use the global/helper findPlanById. 
        // Note: findPlanById definition must support (id, list). 
        // Based on existing code 'deletePlan(id)', it does.
        const plan = findPlanById(currentPlanId, plans);
        
        if (!plan) return;
        
        showConfirmModal(
            "åˆ é™¤ç¡®è®¤",
            `ç¡®å®šè¦ä»è®¡åˆ’ä¸­åˆ é™¤è‰²å· ${code} å—ï¼Ÿ`,
            () => {
                const idx = plan.items.findIndex(i => i.code === code);
                if (idx !== -1) {
                    plan.items.splice(idx, 1);
                    
                    // If plan is part of a collection, we might need to update parent stats?
                    // The current implementation seems to calculate items on the fly for rendering,
                    // but for collections 'items' are usually aggregated?
                    // If this is a leaf plan, just saving is enough.
                    // If this is a collection, we shouldn't be editing items directly usually (items are computed).
                    // But if 'items' exists on it, we edit it.
                    
                    localStorage.setItem('bead_plans', JSON.stringify(plans));
                    
                    // Refresh View
                    renderPlanDetailList();
                    showToast('å·²åˆ é™¤è‰²å· ' + code);
                    
                    // Also update main list if visible
                    renderPlans();
                }
            }
        );
    }


    function viewPlanDetail(id) {
        const plan = findPlanById(id);
        if(!plan) return;

        currentPlanId = id;

        const titleEl = document.getElementById('planDetailTitle');
        titleEl.innerText = plan.name;
        
        // Check for parent and show Move Out button
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const parentPlan = findParent(id, plans, null);
        
        // Update Status Banner
        const statusBanner = document.getElementById('planDetailStatus');
        const actionButtons = document.getElementById('planDetailActions');
        
        // Clear previous buttons
        const revertBtnId = 'btn-revert-active';
        const existingRevertBtn = document.getElementById(revertBtnId);
        if(existingRevertBtn) existingRevertBtn.remove();
        
        const duplicateBtnId = 'btn-duplicate-plan';
        const existingDupBtn = document.getElementById(duplicateBtnId);
        if(existingDupBtn) existingDupBtn.remove();

        if (plan.status === 'completed') {
            let timeStr = '';
            if(plan.completedAt) {
                timeStr = `<div style="font-size:13px; margin-top:6px; opacity:0.8;">å®Œæˆäº: ${formatTime(new Date(plan.completedAt))}</div>`;
            }
            statusBanner.innerHTML = `<div style="font-weight:bold; font-size:16px;">âœ… å·²å®Œæˆ - åº“å­˜å·²æ‰£å‡</div>${timeStr}`;
            statusBanner.style.background = '#f6ffed';
            statusBanner.style.color = '#52c41a';
            if(actionButtons) actionButtons.style.display = 'none';
            

            
        } else {
            statusBanner.innerHTML = `<div style="font-weight:bold; font-size:16px;">ğŸ“… è®¡åˆ’ä¸­ - å°šæœªæ‰£å‡åº“å­˜</div>`;
            statusBanner.style.background = '#fffbe6';
            statusBanner.style.color = '#fa8c16';
            if(actionButtons) actionButtons.style.display = 'flex';
        }
        
        const totalQty = plan.items.reduce((sum, item) => sum + item.qty, 0);
        document.getElementById('planDetailColorCount').innerText = plan.items.length;
        document.getElementById('planDetailBeadCount').innerText = totalQty.toLocaleString();

        // Render List using the current sort mode (reset to default or keep?)
        // Let's reset to default 'qty' when opening a plan, or keep previous if we want.
        // User didn't specify, but resetting is safer for "default is by usage".
        currentPlanDetailSort = 'qty'; 
        renderPlanDetailList();

        document.getElementById('page-plan').style.display = 'none';
        document.getElementById('page-plan-detail').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function closePlanDetail() {
        document.getElementById('page-plan-detail').style.display = 'none';
        document.getElementById('page-plan').style.display = 'block';
        currentPlanId = null;
    }

    let stockCheckSortType = 'code';
    let stockCheckPrioritizeMissing = false;

    function toggleStockCheckSort(type) {
        if (stockCheckSortType === type) return;
        stockCheckSortType = type;
        renderStockCheckList();
    }

    function toggleStockCheckMissingPriority() {
        stockCheckPrioritizeMissing = !stockCheckPrioritizeMissing;
        renderStockCheckList();
    }

    function checkPlanStock() {
        if (!currentPlanId) return;
        const plan = findPlanById(currentPlanId);
        if(!plan) return;

        const sheet = document.getElementById('stockCheckSheet');
        const summary = document.getElementById('stockCheckSummary');
        
        // Calculate Summary First
        // Calculate Summary
        let missingCount = 0;
        let totalMissingWeight = 0;
        let totalMissingBeads = 0;
        const BEAD_WEIGHT_PER_100 = 1;

        plan.items.forEach(item => {
             const bead = data.find(d => d.id === item.code);
             const currentStock = bead ? (bead.w || 0) : 0;
             const neededWeight = parseFloat((item.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
             if (currentStock < neededWeight) {
                 missingCount++;
                 totalMissingWeight += (neededWeight - currentStock);
                 
                 // Estimate missing beads based on weight diff
                 // (needed - stock) * 100 / BEAD_WEIGHT_PER_100
                 const missingW = neededWeight - currentStock;
                 totalMissingBeads += Math.ceil(missingW * 100 / BEAD_WEIGHT_PER_100);
             }
        });

        // Updated Summary Style to match Reference Image
        if (missingCount > 0) {
            summary.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <div style="font-size: 16px; font-weight: bold; color: #333;">${plan.name || 'åº“å­˜ç¡®è®¤'}</div>
                    <div style="color: #ff4d4f; font-weight: bold; font-size: 14px;">âš ï¸ ç¼ºå°‘ ${missingCount} è‰²</div>
                </div>
                <div style="color: #fa8c16; font-size: 13px;">âŠ– å…±ç¼ºå°‘ ${totalMissingBeads.toLocaleString()} é¢—</div>
            `;
            summary.style.cssText = 'background: #fff; padding: 15px 5px 5px 5px; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px;';
        } else {
            summary.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 16px; font-weight: bold; color: #333;">${plan.name || 'åº“å­˜ç¡®è®¤'}</div>
                    <div style="color: #52c41a; font-weight: bold; font-size: 14px;">âœ” åº“å­˜å……è¶³</div>
                </div>
                <div style="color: #999; font-size: 13px; margin-top: 5px;">å¯ä»¥å¼€å§‹åˆ¶ä½œå•¦ï¼</div>
            `;
            summary.style.cssText = 'background: #fff; padding: 15px 5px 5px 5px; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px;';
        }

        renderStockCheckList();

        sheet.style.display = 'flex';
        document.getElementById('mask').style.display = 'block';
    }

    function renderStockCheckList() {
        if (!currentPlanId) return;
        const plan = findPlanById(currentPlanId);
        if(!plan) return;

        const list = document.getElementById('stockCheckList');
        list.innerHTML = '';
        const BEAD_WEIGHT_PER_100 = 1;

        // Update Button Styles
        const btnCode = document.getElementById('btn-check-code');
        const btnQty = document.getElementById('btn-check-qty');
        const btnMissing = document.getElementById('btn-check-missing');
        
        if(btnCode && btnQty && btnMissing) {
            const activeStyle = "font-size: 12px; padding: 2px 8px; border: 1px solid #1890ff; background: #e6f7ff; color: #1890ff; border-radius: 4px; font-weight: bold;";
            const inactiveStyle = "font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; background: #fff; color: #666; border-radius: 4px;";
            
            btnCode.style.cssText = stockCheckSortType === 'code' ? activeStyle : inactiveStyle;
            btnQty.style.cssText = stockCheckSortType === 'qty' ? activeStyle : inactiveStyle;
            btnMissing.style.cssText = stockCheckPrioritizeMissing ? activeStyle : inactiveStyle;
        }

        // Sorting
        let sortedItems = [...plan.items];
        
        // 1. Primary Sort
        if (stockCheckSortType === 'qty') {
            sortedItems.sort((a, b) => b.qty - a.qty);
        } else {
            sortedItems.sort((a, b) => a.code.localeCompare(b.code, undefined, {numeric: true}));
        }

        // 2. Priority Sort
        if (stockCheckPrioritizeMissing) {
            sortedItems.sort((a, b) => {
                 const getShortage = (item) => {
                     const bead = data.find(d => d.id === item.code);
                     const currentStock = bead ? (bead.w || 0) : 0;
                     const neededWeight = parseFloat((item.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
                     return currentStock < neededWeight ? 1 : 0;
                 };
                 return getShortage(b) - getShortage(a); // Missing first
            });
        }

        sortedItems.forEach(item => {
             const bead = data.find(d => d.id === item.code);
             const currentStock = bead ? (bead.w || 0) : 0;
             const neededWeight = parseFloat((item.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
             const isMissing = currentStock < neededWeight;
             
             const hex = bead ? bead.hex : '#eee';
             const row = document.createElement('div');
             row.style.cssText = 'display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 8px; border-radius: 8px;';
             
             // Calculate Bead Counts for Display
             // currentStock (g) -> beads?  (currentStock / BEAD_WEIGHT_PER_100 * 100)
             const currentBeads = Math.floor(currentStock / BEAD_WEIGHT_PER_100 * 100);
             const missingBeads = Math.ceil((neededWeight - currentStock) * 100 / BEAD_WEIGHT_PER_100);

             let rightContent = '';
             if (isMissing) {
                 rightContent = `
                    <div style="text-align: right;">
                        <div style="color: #ff4d4f; font-weight: bold; font-size: 16px;">-${missingBeads.toLocaleString()}</div>
                    </div>
                 `;
             } else {
                 // Optionally show remaining surplus or just a check? Reference image doesn't show "sufficient" rows clearly but implies checks.
                 // Let's show "Sufficient" or surplus count if we want, but image implies only negatives are highlighted.
                 // Let's show remaining count in green if positive? Or just nothing special.
                 // Reference image seems to list all, but highlights missing.
                 const surplusBeads = Math.floor((currentStock - neededWeight) * 100 / BEAD_WEIGHT_PER_100);
                 rightContent = `
                    <div style="text-align: right;">
                        <div style="color: #52c41a; font-weight: bold; font-size: 16px;">${surplusBeads > 0 ? surplusBeads : 'âœ”'}</div>
                    </div>
                 `;
             }

             row.innerHTML = `
                 <!-- Left: Color Block & Code -->
                 <div style="display: flex; align-items: center; width: 35%;">
                     <div style="width: 36px; height: 36px; background: ${hex}; border-radius: 6px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.1);"></div>
                     <div style="font-weight: bold; color: #333; font-size: 15px;">${item.code}</div>
                 </div>
                 
                 <!-- Middle: Need / Have -->
                 <div style="flex: 1; text-align: right; padding-right: 20px;">
                     <div style="font-size: 12px; color: #666;">éœ€è¦ <b>${item.qty.toLocaleString()}</b></div>
                     <div style="font-size: 11px; color: #999; margin-top: 2px;">ç°æœ‰ ${currentBeads.toLocaleString()}</div>
                 </div>
                 
                 <!-- Right: Missing Qty -->
                 <div style="width: 80px; text-align: right;">
                     ${rightContent}
                 </div>
             `;
             list.appendChild(row);
        });
    }

    function executePlanDeduction() {
        if (!currentPlanId) return;
        deductPlanInventory(currentPlanId);
    }

    function rollbackPlanInventory(plan) {
        if (!plan) return;
        
        if (plan.status === 'completed') {
            let restoredCount = 0;
            
            // Find logs associated with this plan
            data.forEach(item => {
                if (item.logs) {
                    // Find logs with matching planId OR matching description (backward compatibility)
                    const logsToRemove = [];
                    item.logs.forEach((log, idx) => {
                        let isMatch = false;
                        if (log.planId && log.planId === plan.id) {
                            isMatch = true;
                        } else if (!log.planId && log.desc && log.desc === `è®¡åˆ’æ‰£å‡: ${plan.name}`) {
                            isMatch = true;
                        }
                        
                        if (isMatch) {
                             logsToRemove.push({ log, idx });
                        }
                    });
                    
                    // Process rollback (reverse order of indices to avoid shifting issues)
                    logsToRemove.sort((a, b) => b.idx - a.idx).forEach(({log, idx}) => {
                        // Restore Stock
                        // "use" log means we subtracted weight, so add it back
                        const val = log.val || 0;
                        item.w = parseFloat((item.w + val).toFixed(2));
                        item.totalUsed = Math.max(0, parseFloat((item.totalUsed - val).toFixed(2)));
                        
                        // Remove log
                        item.logs.splice(idx, 1);
                        restoredCount++;
                    });
                }
            });
            
            if (restoredCount > 0) {
                save();
                render();
            }
        }

        // Recursively rollback sub-plans (for collections)
        if (plan.subPlans && plan.subPlans.length > 0) {
            plan.subPlans.forEach(sub => rollbackPlanInventory(sub));
        }
    }

    function revertPlanToActive(id) {
        currentRevertPlanId = id;
        showModal('revertConfirmModal');
    }

    function confirmRevertPlan() {
        if (!currentRevertPlanId) return;
        const id = currentRevertPlanId;
        closeAllModals();

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(id, plans);
        if (!plan) return;
        
        rollbackPlanInventory(plan);
        
        plan.status = 'active';
        delete plan.completedAt;
        
        // Check parent status (revert if needed)
        updateParentCollectionStatus(plans, plan.id);

        localStorage.setItem('bead_plans', JSON.stringify(plans));
        renderPlans();
        showToast('è®¡åˆ’å·²æ’¤é”€ä¸ºâ€œè®¡åˆ’ä¸­â€ï¼Œåº“å­˜å·²å›æ»šã€‚');
        currentRevertPlanId = null;
    }

    function duplicatePlan(id) {
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const original = findPlanById(id, plans);
        if (!original) return;
        
        // Find parent folder if exists
        const parent = findParent(id, plans, null);
        
        const newPlan = JSON.parse(JSON.stringify(original));
        newPlan.id = 'plan_' + Date.now();
        newPlan.name = original.name + ' (å‰¯æœ¬)';
        newPlan.createdAt = Date.now();
        newPlan.status = 'active';
        delete newPlan.completedAt;
        // delete newPlan.subPlans; // Keep subPlans structure if it's a folder
        
        // If it's a folder (has subPlans), we need to update IDs of subPlans too
        if (newPlan.subPlans) {
             const updateIds = (list) => {
                 list.forEach(p => {
                     p.id = 'plan_' + Math.random().toString(36).substr(2, 9);
                     p.createdAt = Date.now();
                     p.status = 'active';
                     delete p.completedAt;
                     if(p.subPlans) updateIds(p.subPlans);
                 });
             };
             updateIds(newPlan.subPlans);
        }

        if (parent) {
            // Insert into parent folder
            if (!parent.subPlans) parent.subPlans = [];
            parent.subPlans.unshift(newPlan);
            recalculatePlanItems(parent);
        } else {
            // Insert into root
            plans.unshift(newPlan);
        }
        
        localStorage.setItem('bead_plans', JSON.stringify(plans));
        
        showToast('è®¡åˆ’å·²å¤åˆ¶');
        renderPlans();
    }

    function hasCompletedStatusRecursive(plan) {
        if (!plan) return false;
        if (plan.status === 'completed') return true;
        if (plan.subPlans && plan.subPlans.length > 0) {
            return plan.subPlans.some(sub => hasCompletedStatusRecursive(sub));
        }
        return false;
    }

    function deletePlan(id) {
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(id, plans); 
        
        if (!plan) return;

        const hasCompleted = hasCompletedStatusRecursive(plan);
        const msg = 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¡åˆ’å—ï¼Ÿ' + (hasCompleted ? '<br><span style="color:#ff4d4f; font-weight:bold;">æ³¨æ„ï¼šåŒ…å«å·²å®Œæˆçš„è®¡åˆ’ï¼Œåˆ é™¤å°†è‡ªåŠ¨å›æ»šåº“å­˜ï¼</span>' : '');

        document.getElementById('deleteConfirmMsg').innerHTML = msg;
        currentDeletePlanId = id;
        showModal('deleteConfirmModal');
    }

    function confirmDeletePlan() {
        if (!currentDeletePlanId) return;
        const id = currentDeletePlanId;
        closeAllModals();

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(id, plans);
        
        if (!plan) return;

        const hasCompleted = hasCompletedStatusRecursive(plan);
        
        if (hasCompleted) {
             rollbackPlanInventory(plan);
        }

        const result = deletePlanRecursive(plans, id);

        if (result.deleted) {
            localStorage.setItem('bead_plans', JSON.stringify(plans));
            if (currentPlanId === id) closePlanDetail();
            renderPlans();
            showToast('è®¡åˆ’å·²åˆ é™¤');
        }
        currentDeletePlanId = null;
    }

    function deletePlanRecursive(list, id) {
        const idx = list.findIndex(p => p.id === id);
        if (idx !== -1) {
            list.splice(idx, 1);
            return { deleted: true, parentModified: false };
        }
        
        for (let p of list) {
            if (p.subPlans) {
                const res = deletePlanRecursive(p.subPlans, id);
                if (res.deleted) {
                    recalculatePlanItems(p);
                    return { deleted: true, parentModified: true };
                }
            }
        }
        return { deleted: false };
    }

    function recalculatePlanItems(plan) {
        const aggregatedItems = new Map();
        plan.subPlans.forEach(sub => {
            sub.items.forEach(item => {
                const currentQty = aggregatedItems.get(item.code) || 0;
                aggregatedItems.set(item.code, currentQty + item.qty);
            });
        });
        
        const newItems = [];
        aggregatedItems.forEach((qty, code) => {
            newItems.push({ code, qty });
        });
        plan.items = newItems;
    }

    function deductPlanInventory(id) {
        // Load plans so we can update status and save
        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        const plan = findPlanById(id, plans);
        if(!plan) return;

        // One-click deduction per user preference (no confirm)


        const BEAD_WEIGHT_PER_100 = 1;
        let count = 0;
        
        plan.items.forEach(pItem => {
             const item = data.find(d => d.id === pItem.code);
             if(item) {
                 const weightToDeduct = parseFloat((pItem.qty / 100 * BEAD_WEIGHT_PER_100).toFixed(2));
                 item.w = parseFloat((item.w - weightToDeduct).toFixed(2));
                 
                 if (!item.logs) item.logs = [];
                 item.logs.push({
                    d: formatTime(new Date()),
                    type: 'use', 
                    val: weightToDeduct,
                    c: pItem.qty, 
                    desc: `è®¡åˆ’æ‰£å‡: ${plan.name}`,
                    drawingName: plan.name,
                    planId: plan.id
                 });
                 item.totalUsed = parseFloat(((item.totalUsed || 0) + weightToDeduct).toFixed(2));
                 count++;
             }
        });
        
        let forceComplete = false;
        if (count === 0) {
            forceComplete = confirm('æœªåœ¨åº“å­˜ä¸­æ‰¾åˆ°è®¡åˆ’åŒ…å«çš„è‰²å·ï¼Œæœªæ‰£å‡ä»»ä½•åº“å­˜ã€‚\n\næ˜¯å¦ä»è¦å°†æ­¤è®¡åˆ’æ ‡è®°ä¸ºâ€œå·²å®Œæˆâ€ï¼Ÿ');
        }

        if(count > 0 || forceComplete) {
            if (count > 0) {
                save();
                render(); // Update inventory UI
            }
            
            // Mark as completed
            plan.status = 'completed';
            plan.completedAt = Date.now();
            
            // Check if parent collection is now fully completed
            updateParentCollectionStatus(plans, plan.id);

            localStorage.setItem('bead_plans', JSON.stringify(plans));
            
            showToast(count > 0 ? 'åº“å­˜æ‰£å‡æˆåŠŸï¼è®¡åˆ’å·²æ ‡è®°ä¸ºâ€œå·²å®Œæˆâ€ã€‚' : 'è®¡åˆ’å·²æ ‡è®°ä¸ºâ€œå·²å®Œæˆâ€ã€‚');
            renderPlans();
            
            // Refresh detail view if open
            if (currentPlanId === id) {
                viewPlanDetail(id);
            }
        }
    }

    function updateParentCollectionStatus(plans, childId) {
        // Find parent (Recursive search)
        function findParent(list, id) {
            for (let p of list) {
                if (p.subPlans) {
                    if (p.subPlans.some(sub => sub.id === id)) return p;
                    const found = findParent(p.subPlans, id);
                    if (found) return found;
                }
            }
            return null;
        }

        let parent = findParent(plans, childId);
        
        if (parent) {
            const allCompleted = parent.subPlans.every(sub => sub.status === 'completed');
            if (allCompleted) {
                // Only update if not already completed
                if (parent.status !== 'completed') {
                    parent.status = 'completed';
                    parent.completedAt = Date.now();
                }
            } else {
                // If we are reverting a child, we might need to revert parent
                if (parent.status === 'completed') {
                    parent.status = 'active';
                    delete parent.completedAt;
                }
            }
            
            // If parent itself has a parent, we might need to propagate up?
            // e.g. GrandParent -> Parent -> Child.
            // If Parent becomes completed, GrandParent might need to check.
            updateParentCollectionStatus(plans, parent.id);
        }
    }

    function enterPlanSelectionMode(initialId) {
        if (isPlanSelectionMode) return;
        isPlanSelectionMode = true;
        selectedPlanIds.clear();
        if (initialId) {
            selectedPlanIds.add(initialId);
        }
        
        const bar = document.getElementById('planSelectionBar');
        bar.style.display = 'flex';
        bar.style.animation = 'none';
        bar.offsetHeight; 
        bar.style.animation = 'slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
        
        updateSelectionUI();
        renderPlans();
        
        if (navigator.vibrate) navigator.vibrate(50);
    }

    function exitPlanSelectionMode() {
        isPlanSelectionMode = false;
        selectedPlanIds.clear();
        document.getElementById('planSelectionBar').style.display = 'none';
        renderPlans();
    }

    function togglePlanSelection(id) {
        if (selectedPlanIds.has(id)) {
            selectedPlanIds.delete(id);
        } else {
            selectedPlanIds.add(id);
        }
        updateSelectionUI();
        renderPlans();
    }

    function updateSelectionUI() {
        document.getElementById('selectedCount').innerText = selectedPlanIds.size;
    }

    function mergeSelectedPlans() {
        if (selectedPlanIds.size < 2) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸¤ä¸ªé¡¹ï¼ˆåŒ…æ‹¬ä¸€ä¸ªç›®æ ‡åˆé›†ï¼‰è¿›è¡Œæ“ä½œã€‚');
            return;
        }

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        
        // Find all selected plans (recursive search)
        let selectedPlans = [];
        selectedPlanIds.forEach(id => {
            const p = findPlanById(id, plans);
            if(p) selectedPlans.push(p);
        });
        
        if (selectedPlans.length === 0) return;

        // Identify Folders
        const isFolder = (p) => Array.isArray(p.subPlans) && p.subPlans.length > 0;
        const folders = selectedPlans.filter(isFolder);
        const regularPlans = selectedPlans.filter(p => !isFolder(p));

        // Case: Multiple Folders -> Error
        if (folders.length > 1) {
            alert('æ— æ³•åˆå¹¶å¤šä¸ªåˆé›†ï¼Œä¹Ÿæ— æ³•å°†åˆé›†æ”¾å…¥å¦ä¸€ä¸ªåˆé›†ã€‚è¯·åªé€‰æ‹©ä¸€ä¸ªç›®æ ‡åˆé›†ã€‚');
            return;
        }

        // Case: 1 Folder + Regular Plans -> Move Plans into Folder
        if (folders.length === 1) {
            const targetFolder = folders[0];
            if (regularPlans.length === 0) {
                alert('è¯·é€‰æ‹©è¦ç§»å…¥è¯¥åˆé›†çš„è®¡åˆ’ã€‚');
                return;
            }

            // Move regularPlans into targetFolder
            regularPlans.forEach(p => {
                deletePlanRecursive(plans, p.id);
            });

            // Add to target folder
            // Note: targetFolder reference is still valid and connected to 'plans' tree
            // unless it was somehow deleted (which shouldn't happen as we didn't select it for deletion)
            if (!targetFolder.subPlans) targetFolder.subPlans = [];
            targetFolder.subPlans.unshift(...regularPlans); // Add to top

            // Update folder stats
            if (typeof recalculatePlanItems === 'function') {
                recalculatePlanItems(targetFolder);
            } else {
                // Fallback if function not found (re-implement basic aggregation)
                const aggregatedItems = new Map();
                const collectItems = (list) => {
                    list.forEach(p => {
                        if (p.subPlans && p.subPlans.length > 0) collectItems(p.subPlans);
                        else p.items.forEach(i => {
                            aggregatedItems.set(i.code, (aggregatedItems.get(i.code)||0) + i.qty);
                        });
                    });
                };
                collectItems(targetFolder.subPlans);
                targetFolder.items = Array.from(aggregatedItems.entries()).map(([code, qty]) => ({code, qty}));
            }

            localStorage.setItem('bead_plans', JSON.stringify(plans));
            showToast(`å·²å°† ${regularPlans.length} ä¸ªè®¡åˆ’ç§»å…¥åˆé›†â€œ${targetFolder.name}â€ã€‚`);
            exitPlanSelectionMode();
            return;
        }

        // Case: All Regular Plans -> Create New Collection
        // Filter out descendants (prevent double inclusion)
        const containsPlan = (container, targetId) => {
            if (!container.subPlans) return false;
            for (let sp of container.subPlans) {
                if (sp.id === targetId) return true;
                if (containsPlan(sp, targetId)) return true;
            }
            return false;
        };

        const topLevelSelected = selectedPlans.filter(p => {
            // Check if p is inside any other selected plan
            return !selectedPlans.some(other => other !== p && containsPlan(other, p.id));
        });

        if (topLevelSelected.length < 2) {
             alert('è¯·è‡³å°‘é€‰æ‹©ä¸¤ä¸ªè®¡åˆ’è¿›è¡Œåˆå¹¶ã€‚');
             return;
        }

        // Create New Plan
        const aggregatedItems = new Map();
        topLevelSelected.forEach(plan => {
            plan.items.forEach(item => {
                const currentQty = aggregatedItems.get(item.code) || 0;
                aggregatedItems.set(item.code, currentQty + item.qty);
            });
        });

        const newItems = [];
        aggregatedItems.forEach((qty, code) => {
            newItems.push({ code, qty });
        });

        const defaultName = `åˆé›†: ${topLevelSelected[0].name} ç­‰${topLevelSelected.length}ä¸ªè®¡åˆ’`;
        pendingMergePlans = topLevelSelected;
        
        const nameInput = document.getElementById('collectionNameInput');
        nameInput.value = '';
        nameInput.placeholder = defaultName;
        showModal('createCollectionModal');
    }
    
    function confirmCreateCollection() {
        if (!pendingMergePlans) return;
        const topLevelSelected = pendingMergePlans;
        let newPlanName = document.getElementById('collectionNameInput').value;
        closeAllModals();

        let plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        
        // Create New Plan
        const aggregatedItems = new Map();
        topLevelSelected.forEach(plan => {
            plan.items.forEach(item => {
                const currentQty = aggregatedItems.get(item.code) || 0;
                aggregatedItems.set(item.code, currentQty + item.qty);
            });
        });

        const newItems = [];
        aggregatedItems.forEach((qty, code) => {
            newItems.push({ code, qty });
        });

        const defaultName = `åˆé›†: ${topLevelSelected[0].name} ç­‰${topLevelSelected.length}ä¸ªè®¡åˆ’`;
        newPlanName = newPlanName.trim() || defaultName;
        
        // Determine status based on selected plans
        const isAllCompleted = topLevelSelected.every(p => p.status === 'completed');

        const newPlan = {
            id: 'plan_group_' + Date.now(),
            name: newPlanName,
            createdAt: Date.now(),
            items: newItems,
            status: isAllCompleted ? 'completed' : 'active',
            completedAt: isAllCompleted ? Date.now() : undefined,
            subPlans: topLevelSelected,
            thumbnail: null
        };

        // Remove topLevelSelected from the tree
        topLevelSelected.forEach(p => {
             deletePlanRecursive(plans, p.id);
        });
        
        // Add new plan to root
        plans.unshift(newPlan);
        
        localStorage.setItem('bead_plans', JSON.stringify(plans));

        showToast('åˆå¹¶æˆåŠŸï¼å·²ç”Ÿæˆæ–°çš„åˆé›†è®¡åˆ’ã€‚');
        exitPlanSelectionMode();
        pendingMergePlans = null;
    }
    

    // --- Pull to Refresh Feature (Removed) ---


</script>
<!-- Floating Add Button -->
<div id="floatingHomeBtn" class="floating-home-btn" onclick="navTo('home')">
    <span>ğŸ </span>
</div>

<div id="floatingBatchAddBtn" class="floating-add-btn" onclick="openBatchAdd()">
    <span>+</span>
</div>

<!-- Batch Add Modal -->
<div id="batchAddModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:300; flex-direction:column;">
    <!-- Header -->
    <div style="padding:15px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0;">
        <button onclick="closeBatchAdd()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">å–æ¶ˆ</button>
        <div style="font-size:18px; font-weight:bold;">å¢åŠ åº“å­˜</div>
        <button onclick="toggleBatchSelectAll()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">å…¨é€‰</button>
    </div>
    
    <!-- Subtitle -->
    <div style="padding:10px 15px; background:#f9f9f9; color:#999; font-size:12px;">
        å¢åŠ åº“å­˜ï¼Œ1å•ä½ = 1000ç²’ = 10g
    </div>
    
    <!-- Series Tabs -->
    <div id="batchAddSeriesTabs" style="display:flex; overflow-x:auto; padding:10px 15px; gap:10px; border-bottom:1px solid #f0f0f0; -webkit-overflow-scrolling: touch;">
        <!-- Tabs injected by JS -->
    </div>
    
    <!-- List -->
    <div id="batchAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <!-- Items injected by JS -->
    </div>
    
    <!-- Footer -->
    <div style="padding:15px; border-top:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; background:white;">
        <div>
            <div style="font-size:12px; color:#999;">å·²é€‰æ‹© <span id="batchAddCount" style="color:#333; font-weight:bold;">0</span> è‰²</div>
            <div style="font-size:16px; font-weight:bold; color:#4a90e2;">å…± +<span id="batchAddTotal">0</span> ç²’</div>
        </div>
        <button onclick="confirmBatchAdd()" class="m-btn m-btn-primary" style="width:auto; padding:10px 25px; border-radius:20px; box-shadow:0 4px 10px rgba(74, 144, 226, 0.3);">ç¡®è®¤æ·»åŠ </button>
    </div>
</div>

<style>
.floating-add-btn {
    position: fixed; bottom: 100px; right: 20px;
    width: 36px; height: 36px;
    background: #4a90e2;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    display: none; align-items: center; justify-content: center;
    color: white; font-size: 24px; cursor: pointer;
    z-index: 180; transition: transform 0.2s;
}
.floating-add-btn:active { transform: scale(0.90); }
.floating-add-btn span { position: relative; top: -1px; }

.floating-home-btn {
    position: fixed; bottom: 100px; right: 70px;
    width: 36px; height: 36px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none; align-items: center; justify-content: center;
    color: #4a90e2; font-size: 20px; cursor: pointer;
    z-index: 180; transition: transform 0.2s; border: 1px solid #eee;
}
.floating-home-btn:active { transform: scale(0.90); }
.floating-home-btn span { position: relative; top: -1px; }

.batch-tab {
    padding: 6px 16px; border-radius: 20px; background: #f0f0f0; color: #666; font-size: 14px; flex-shrink: 0; cursor: pointer; transition: all 0.2s;
}
.batch-tab.active {
    background: #4a90e2; color: white; box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3);
}

.batch-item {
    display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; margin-bottom: 10px; border: 1px solid #f0f0f0; transition: all 0.2s;
}
.batch-item.selected {
    border-color: #91d5ff; background: #e6f7ff;
}

.batch-check {
    width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; margin-right: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.batch-item.selected .batch-check {
    background: #4a90e2; border-color: #4a90e2; color: white;
}
.batch-check::after {
    content: "âœ“"; font-size: 14px; display: none;
}
.batch-item.selected .batch-check::after {
    display: block;
}

.batch-stepper {
    display: flex; align-items: center; background: white; border-radius: 8px; border: 1px solid #eee; overflow: hidden;
}
.batch-step-btn {
    width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; color: #666; cursor: pointer;
}
.batch-step-btn.add {
    background: #4a90e2; color: white;
}
.batch-input {
    width: 44px; text-align: center; border: none; font-size: 14px; color: #333; outline: none; background: transparent;
}
</style>

<script>
let batchAddSelection = {}; // { id: qty }
let batchCurrentSeries = 'A';

function openBatchAdd() {
    batchAddSelection = {};
    document.getElementById('batchAddModal').style.display = 'flex';
    // Find all series
    const series = new Set();
    data.forEach(d => {
        const match = d.id.match(/^[A-Z]+/);
        if(match) series.add(match[0]);
    });
    const sortedSeries = Array.from(series).sort();
    if(sortedSeries.length > 0) batchCurrentSeries = sortedSeries[0];
    
    renderBatchAddTabs(sortedSeries);
    renderBatchAddList();
    updateBatchSummary();
}

function closeBatchAdd() {
    document.getElementById('batchAddModal').style.display = 'none';
}

function renderBatchAddTabs(allSeries) {
    const container = document.getElementById('batchAddSeriesTabs');
    container.innerHTML = '';
    allSeries.forEach(s => {
        const div = document.createElement('div');
        div.className = `batch-tab ${s === batchCurrentSeries ? 'active' : ''}`;
        div.innerText = s;
        div.onclick = () => {
            batchCurrentSeries = s;
            renderBatchAddTabs(allSeries);
            renderBatchAddList();
        };
        container.appendChild(div);
    });
}

function renderBatchAddList() {
    const container = document.getElementById('batchAddList');
    container.innerHTML = '';
    
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    
    items.forEach(item => {
        const isSelected = batchAddSelection[item.id] !== undefined;
        const qty = batchAddSelection[item.id] || 1;
        
        const div = document.createElement('div');
        div.className = `batch-item ${isSelected ? 'selected' : ''}`;
        div.onclick = (e) => {
            if(e.target.closest('.batch-stepper')) return;
            toggleBatchItem(item.id);
        };
        
        div.innerHTML = `
            <div class="batch-check"></div>
            <div style="width: 36px; height: 36px; background: ${item.hex}; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); margin-right: 15px;"></div>
            <div style="flex: 1; font-weight: bold; font-size: 16px;">${item.id}</div>
            
            ${isSelected ? `
            <div class="batch-stepper">
                <div class="batch-step-btn" onclick="updateBatchQty('${item.id}', -1)">-</div>
                <input type="number" class="batch-input" value="${qty}" step="0.1" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                <div class="batch-step-btn add" onclick="updateBatchQty('${item.id}', 1)">+</div>
            </div>
            <div style="font-size: 10px; color: #999; margin-left: 5px;">x1000</div>
            ` : ''}
        `;
        container.appendChild(div);
    });
}

function toggleBatchItem(id) {
    if (batchAddSelection[id]) {
        delete batchAddSelection[id];
    } else {
        batchAddSelection[id] = 1;
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQty(id, delta) {
    if (!batchAddSelection[id]) return;
    let newQty = parseFloat(batchAddSelection[id]) + delta;
    newQty = parseFloat(newQty.toFixed(1));
    if (newQty <= 0) {
        delete batchAddSelection[id];
    } else {
        batchAddSelection[id] = newQty;
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQtyInput(id, val) {
    let newQty = parseFloat(val);
    if (isNaN(newQty) || newQty <= 0) {
        delete batchAddSelection[id];
    } else {
        batchAddSelection[id] = parseFloat(newQty.toFixed(1));
    }
    renderBatchAddList();
    updateBatchSummary();
}

function toggleBatchSelectAll() {
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    const allSelected = items.every(item => batchAddSelection[item.id]);
    
    if (allSelected) {
        items.forEach(item => delete batchAddSelection[item.id]);
    } else {
        items.forEach(item => {
            if(!batchAddSelection[item.id]) batchAddSelection[item.id] = 1;
        });
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchSummary() {
    const count = Object.keys(batchAddSelection).length;
    let totalBeads = 0;
    Object.values(batchAddSelection).forEach(q => totalBeads += q * 1000);
    
    document.getElementById('batchAddCount').innerText = count;
    document.getElementById('batchAddTotal').innerText = (totalBeads >= 1000) ? (totalBeads/1000).toFixed(1) + 'K' : totalBeads;
}

function confirmBatchAdd() {
    const count = Object.keys(batchAddSelection).length;
    if (count === 0) return;
    
    // One-click add (no confirm)
    
    const now = new Date();
    const dateStr = formatTime(now);
    
    Object.entries(batchAddSelection).forEach(([id, qty]) => {
        const item = data.find(d => d.id === id);
        if(item) {
            // 1 unit = 1000 beads = 10g
            const weightToAdd = qty * 10; 
            
            item.w = parseFloat((item.w + weightToAdd).toFixed(2));
            item.totalAdded = parseFloat(((item.totalAdded || 0) + weightToAdd).toFixed(2));
            
            if(!item.logs) item.logs = [];
            item.logs.push({ d: dateStr, type: 'add', val: weightToAdd, note: 'æ‰¹é‡æ·»åŠ ' });
            if(item.logs.length > 20) item.logs.shift();
        }
    });
    
    save();
    render();
    closeBatchAdd();
    showToast("åº“å­˜æ·»åŠ æˆåŠŸï¼");
}
</script>
</body>
</html>