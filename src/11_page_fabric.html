<div id="page-fabric" style="display:none; min-height:100vh; background:#f0f2f5;">
    <!-- Fabric Tool Header -->
    <div style="background:white; padding:12px 16px; display:flex; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.05); position:sticky; top:0; z-index:100;">
        <button onclick="navTo('home')" class="btn-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <h2 style="margin:0; font-size:16px; flex:1;">烘焙布裁剪组合工具</h2>
    </div>

    <div class="fabric-container">
        <!-- Sidebar -->
        <div class="fabric-sidebar">
            <h3 style="margin-top:0; font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">1. 原布尺寸 (cm)</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div class="input-group-sm">
                    <label>长</label>
                    <input type="number" id="canvasW" value="100" onchange="saveFabricState()">
                </div>
                <div class="input-group-sm">
                    <label>宽</label>
                    <input type="number" id="canvasH" value="100" onchange="saveFabricState()">
                </div>
            </div>

            <h3 style="font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                2. 成品规格 (最多5种)
                <button onclick="addSpec()" style="font-size:12px; background:#e6f7ff; color:#1890ff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">+ 添加</button>
            </h3>
            <div style="font-size:12px; color:#999; margin-bottom:10px; line-height:1.4;">
                规格参考：一块52钉板规格为14*14cm, 一块78钉板规格为21*21cm, 一块104钉板规格为28*28cm
            </div>
            <div id="specList" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                <!-- Specs will be injected here -->
            </div>

            <h3 style="font-size:15px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">3. 排序偏好</h3>
            <select id="sortPref" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-bottom:20px; box-sizing:border-box;" onchange="saveFabricState()">
                <!-- Options will be dynamic -->
            </select>

            <button onclick="calculateLayout()" style="width:100%; padding:12px; background:linear-gradient(135deg, #eb2f96, #c41d7f); color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer; box-shadow:0 4px 10px rgba(235, 47, 150, 0.3); box-sizing:border-box;">
                开始计算（仅展示利用率≥ 90%的方案)
            </button>
            <div id="calcStatus" style="margin-top:10px; font-size:12px; color:#666; text-align:center;"></div>
        </div>

        <!-- Main Content -->
        <div class="fabric-main">
            <div id="solutionList" style="display:flex; flex-direction:column; gap:20px;">
                <div style="text-align:center; padding:40px; color:#999;">
                    <div style="font-size:40px; margin-bottom:10px;">✂️</div>
                    <div class="desktop-hint">点击左侧“开始计算”生成方案</div>
                    <div class="mobile-hint">点击上方“开始计算”生成方案</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .input-group-sm { flex:1; display:flex; flex-direction:column; gap:4px; min-width:0; }
    .input-group-sm label { font-size:12px; color:#666; }
    .input-group-sm input { padding:6px; border:1px solid #ddd; border-radius:4px; width:100%; box-sizing:border-box; }
    
    .fabric-sidebar, .fabric-main { min-width: 300px; box-sizing: border-box; }
    @media (max-width: 600px) {
        .fabric-sidebar, .fabric-main { min-width: 100% !important; border-radius: 0 !important; box-shadow: none !important; padding: 16px !important; }
        .fabric-container { padding: 0 !important; gap: 10px !important; }
        .fabric-main { padding: 16px !important; background: transparent; }
    }
    
    .spec-item { display:flex; gap:8px; align-items:center; background:#f9fafb; padding:8px; border-radius:6px; }
    .spec-color { width:16px; height:16px; border-radius:4px; }
    .btn-del { border:none; background:none; color:#ff4d4f; cursor:pointer; font-size:16px; padding:0 4px; }

    .solution-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .sol-header { padding:12px 16px; background:#fafafa; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
    .sol-badge { background:#f6ffed; color:#52c41a; border:1px solid #b7eb8f; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold; white-space: nowrap; }
    .sol-body { padding:16px; display:flex; flex-wrap:wrap; gap:20px; align-items:flex-start; }
    .sol-canvas-wrapper { border:1px solid #eee; display:inline-block; position:relative; }
    .sol-info { flex:1; min-width:150px; }
    .sol-stat-row { display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px; color:#555; border-bottom:1px dotted #eee; padding-bottom:2px; }

    /* 响应式提示文字 */
    .mobile-hint { display: none; }
    .desktop-hint { display: block; }

    /* Fabric Tool Layout */
    .fabric-container { max-width:1200px; margin:0 auto; padding:16px; display:flex; flex-wrap:wrap; gap:20px; }
    .fabric-sidebar { flex:1; min-width: 280px; background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); height:fit-content; }
    .fabric-main { flex:2; min-width: 280px; }

    @media (max-width: 768px) {
        .mobile-hint { display: block; }
        .desktop-hint { display: none; }
    }

    @media (max-width: 600px) {
        .fabric-container { padding: 6px; gap: 12px; }
        .fabric-sidebar { padding: 16px; }
    }
</style>


<!-- Zoom Modal -->
<div id="zoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:95%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeZoom()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="margin-bottom:10px; font-weight:bold; font-size:18px; color:#333;" id="zoomTitle">方案详情</div>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:10px;">
            <canvas id="zoomCanvas"></canvas>
        </div>
        <button id="zoomDownloadBtn" onclick="downloadSolution(currentZoomIdx)" style="margin-top:10px; padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">保存图片</button>
        <div id="zoomStats" style="margin-top:10px; width:100%; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:4px; box-sizing: border-box; background: #fafafa;"></div>
        <div style="margin-top:15px; display:flex; justify-content:center;">
             <button onclick="closeZoom()" style="padding:8px 20px; background:#f0f0f0; border:1px solid #ddd; border-radius:6px; cursor:pointer;">关闭</button>
        </div>
    </div>
</div>

<!-- Download Modal (Mobile) -->
<div id="downloadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:90%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeDownloadModal()" style="position:absolute; top:5px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:5px;">
            <img id="downloadImg" style="max-width:100%; height:auto;" />
        </div>
        <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
             <button id="downloadBtnMobile" style="padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;">保存图片</button>
             <button onclick="closeDownloadModal()" style="padding:8px 20px; background:#1890ff; color:white; border:none; border-radius:6px; cursor:pointer;">关闭</button>
        </div>
    </div>
</div>

<div id="planSelectionBar" class="selection-bar" style="display: none;">
    <div style="font-weight: bold; color: #333;">已选择 <span id="selectedCount">0</span> 个计划</div>
    <div style="display: flex; gap: 10px;">
        <button class="m-btn m-btn-ghost" onclick="exitPlanSelectionMode()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; white-space: nowrap;">取消</button>
        <button class="m-btn m-btn-primary" onclick="mergeSelectedPlans()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; background: #722ed1; border-color: #722ed1; white-space: nowrap;">合并计划</button>
    </div>
</div>

<!-- Floating Add Button -->
<div id="floatingHomeBtn" class="floating-home-btn" onclick="navTo('home')">
    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
</div>

<div id="floatingBatchAddBtn" class="floating-add-btn" onclick="openBatchOperation()">
    <span style="font-size: 14px; font-weight: bold;">+/-</span>
</div>

<!-- Batch Operation Modal -->
<div id="batchAddModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:300; flex-direction:column;">
    <!-- Header -->
    <div style="padding:15px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0;">
        <button onclick="closeBatchAdd()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">取消</button>
        
        <!-- Mode Switch -->
        <div style="display:flex; background:#f0f0f0; border-radius:20px; padding:2px;">
            <div id="batchModeAdd" onclick="setBatchMode('add')" style="padding:5px 15px; border-radius:18px; font-size:14px; cursor:pointer; background:white; color:#4a90e2; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition:all 0.2s;">入库</div>
            <div id="batchModeDeduct" onclick="setBatchMode('deduct')" style="padding:5px 15px; border-radius:18px; font-size:14px; cursor:pointer; color:#666; transition:all 0.2s;">出库</div>
        </div>
        
        <button onclick="toggleBatchSelectAll()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">全选</button>
    </div>
    
    <!-- Subtitle -->
    <div id="batchSubtitle" style="padding:10px 15px; background:#f9f9f9; color:#999; font-size:12px;">
        增加库存，1单位 = 1000粒 = 10g
    </div>
    
    <!-- Series Tabs -->
    <div id="batchAddSeriesTabs" style="display:flex; overflow-x:auto; padding:10px 15px; gap:10px; border-bottom:1px solid #f0f0f0; -webkit-overflow-scrolling: touch;">
        <!-- Tabs injected by JS -->
    </div>
    
    <!-- List -->
    <div id="batchAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <!-- Items injected by JS -->
    </div>
    
    <!-- Footer -->
    <div style="padding:15px; border-top:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; background:white;">
        <div>
            <div style="font-size:12px; color:#999;">已选择 <span id="batchAddCount" style="color:#333; font-weight:bold;">0</span> 色</div>
            <div style="font-size:16px; font-weight:bold; color:#4a90e2;" id="batchTotalDisplay">共 +<span id="batchAddTotal">0</span> 粒</div>
        </div>
        <button onclick="confirmBatchAdd()" id="batchConfirmBtn" class="m-btn m-btn-primary" style="width:auto; padding:10px 25px; border-radius:20px; box-shadow:0 4px 10px rgba(74, 144, 226, 0.3);">确认添加</button>
    </div>
</div>

<style>
.floating-add-btn {
    position: fixed; bottom: 100px; right: 20px;
    width: 36px; height: 36px;
    background: #4a90e2;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    display: none; align-items: center; justify-content: center;
    color: white; font-size: 24px; cursor: pointer;
    z-index: 180; transition: transform 0.2s;
}
.floating-add-btn:active { transform: scale(0.90); }
.floating-add-btn span { position: relative; top: -1px; }

.floating-home-btn {
    position: fixed; bottom: 100px; right: 70px;
    width: 36px; height: 36px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none; align-items: center; justify-content: center;
    color: #4a90e2; font-size: 20px; cursor: pointer;
    z-index: 180; transition: transform 0.2s; border: 1px solid #eee;
}
.floating-home-btn:active { transform: scale(0.90); }


.batch-tab {
    padding: 6px 16px; border-radius: 20px; background: #f0f0f0; color: #666; font-size: 14px; flex-shrink: 0; cursor: pointer; transition: all 0.2s;
}
.batch-tab.active {
    background: #4a90e2; color: white; box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3);
}

.batch-item {
    display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; margin-bottom: 10px; border: 1px solid #f0f0f0; transition: all 0.2s;
}
.batch-item.selected {
    border-color: #91d5ff; background: #e6f7ff;
}

.batch-check {
    width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; margin-right: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.batch-item.selected .batch-check {
    background: #4a90e2; border-color: #4a90e2; color: white;
}
.batch-check::after {
    content: "✓"; font-size: 14px; display: none;
}
.batch-item.selected .batch-check::after {
    display: block;
}

.batch-stepper {
    display: flex; align-items: center; background: white; border-radius: 8px; border: 1px solid #eee; overflow: hidden;
}
.batch-step-btn {
    width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; color: #666; cursor: pointer;
}
.batch-step-btn.add {
    background: #4a90e2; color: white;
}
.batch-input {
    width: 44px; text-align: center; border: none; font-size: 14px; color: #333; outline: none; background: transparent;
}
</style>

<script>
let batchAddSelection = {}; // { id: qty }
let batchCurrentSeries = 'A';
let batchMode = 'add'; // 'add' | 'deduct'

function openBatchOperation() {
    batchAddSelection = {};
    document.getElementById('batchAddModal').style.display = 'flex';
    
    // Default to Add mode
    setBatchMode('add');
    
    // Find all series
    const series = new Set();
    data.forEach(d => {
        const match = d.id.match(/^[A-Z]+/);
        if(match) series.add(match[0]);
    });
    const sortedSeries = Array.from(series).sort();
    if(sortedSeries.length > 0) batchCurrentSeries = sortedSeries[0];
    
    renderBatchAddTabs(sortedSeries);
    renderBatchAddList();
    updateBatchSummary();
}

function setBatchMode(mode) {
    batchMode = mode;
    batchAddSelection = {}; 
    
    const btnAdd = document.getElementById('batchModeAdd');
    const btnDeduct = document.getElementById('batchModeDeduct');
    const confirmBtn = document.getElementById('batchConfirmBtn');
    
    if(mode === 'add') {
        btnAdd.style.background = 'white';
        btnAdd.style.color = '#4a90e2';
        btnAdd.style.fontWeight = 'bold';
        btnAdd.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        btnDeduct.style.background = 'transparent';
        btnDeduct.style.color = '#666';
        btnDeduct.style.fontWeight = 'normal';
        btnDeduct.style.boxShadow = 'none';
        
        confirmBtn.innerText = '确认入库';
        confirmBtn.style.background = '#4a90e2';
    } else {
        btnDeduct.style.background = 'white';
        btnDeduct.style.color = '#e24a4a';
        btnDeduct.style.fontWeight = 'bold';
        btnDeduct.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        btnAdd.style.background = 'transparent';
        btnAdd.style.color = '#666';
        btnAdd.style.fontWeight = 'normal';
        btnAdd.style.boxShadow = 'none';
        
        confirmBtn.innerText = '确认出库';
        confirmBtn.style.background = '#e24a4a';
    }
    
    renderBatchAddList();
    updateBatchSummary();
}

function closeBatchAdd() {
    document.getElementById('batchAddModal').style.display = 'none';
}

function renderBatchAddTabs(allSeries) {
    const container = document.getElementById('batchAddSeriesTabs');
    container.innerHTML = '';
    allSeries.forEach(s => {
        const div = document.createElement('div');
        div.className = `batch-tab ${s === batchCurrentSeries ? 'active' : ''}`;
        div.innerText = s;
        div.onclick = () => {
            batchCurrentSeries = s;
            renderBatchAddTabs(allSeries);
            renderBatchAddList();
        };
        container.appendChild(div);
    });
}

function renderBatchAddList() {
    const container = document.getElementById('batchAddList');
    container.innerHTML = '';
    
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    
    items.forEach(item => {
        const isSelected = batchAddSelection[item.id] !== undefined;
        let qty = batchAddSelection[item.id];
        if (qty === undefined) {
             qty = (batchMode === 'add') ? 1 : ''; 
        }
        
        const div = document.createElement('div');
        div.className = `batch-item ${isSelected ? 'selected' : ''}`;
        div.onclick = (e) => {
            if(e.target.closest('.batch-stepper') || e.target.tagName === 'INPUT') return;
            toggleBatchItem(item.id);
        };
        
        let controlsHtml = '';
        if (isSelected) {
            if (batchMode === 'add') {
                controlsHtml = `
                <div class="batch-stepper">
                    <div class="batch-step-btn" onclick="updateBatchQty('${item.id}', -1)">-</div>
                    <input type="number" class="batch-input" value="${qty}" step="0.1" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                    <div class="batch-step-btn add" onclick="updateBatchQty('${item.id}', 1)">+</div>
                </div>
                <div style="font-size: 10px; color: #999; margin-left: 5px;">x1000</div>
                `;
            } else {
                 controlsHtml = `
                <div class="batch-stepper" style="border-color:#e24a4a; height: 30px; display: flex; align-items: center;">
                    <div style="padding-left: 8px; color: #e24a4a; font-weight: bold;">-</div>
                    <input type="number" class="batch-input" style="width:60px; text-align:center; height: 100%;" value="${qty}" placeholder="" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                </div>
                <div style="font-size: 10px; color: #999; margin-left: 5px;">粒</div>
                `;
            }
        }
        
        div.innerHTML = `
            <div class="batch-check"></div>
            <div style="width: 36px; height: 36px; background: ${item.hex}; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); margin-right: 15px;"></div>
            <div style="flex: 1; font-weight: bold; font-size: 16px;">${item.id}</div>
            ${controlsHtml}
        `;
        container.appendChild(div);
    });
}

function toggleBatchItem(id) {
    if (batchAddSelection[id] !== undefined) {
        delete batchAddSelection[id];
    } else {
        batchAddSelection[id] = (batchMode === 'add') ? 1 : '';
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQty(id, delta) {
    if (batchAddSelection[id] === undefined) return;
    
    if (batchMode === 'add') {
        let newQty = parseFloat(batchAddSelection[id]) + delta;
        newQty = parseFloat(newQty.toFixed(1));
        if (newQty <= 0) {
            delete batchAddSelection[id];
        } else {
            batchAddSelection[id] = newQty;
        }
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQtyInput(id, val) {
    if (batchMode === 'add') {
        let newQty = parseFloat(val);
        if (isNaN(newQty) || newQty <= 0) {
            delete batchAddSelection[id];
        } else {
            batchAddSelection[id] = parseFloat(newQty.toFixed(1));
        }
    } else {
        if (val === '') {
             batchAddSelection[id] = '';
        } else {
            let newQty = parseInt(val);
            if (isNaN(newQty) || newQty <= 0) {
                // Keep selection but maybe invalid? 
                // If user enters -5, we should probably reject or set to something valid.
                // For now, if invalid, delete selection? Or just don't update?
                // Deleting selection might be annoying if accidental.
                // Let's just set to valid or ignore.
                // If <= 0, delete.
                if (newQty <= 0) delete batchAddSelection[id];
                else batchAddSelection[id] = newQty;
            } else {
                batchAddSelection[id] = newQty;
            }
        }
    }
    updateBatchSummary();
}

function toggleBatchSelectAll() {
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    const allSelected = items.every(item => batchAddSelection[item.id] !== undefined);
    
    if (allSelected) {
        items.forEach(item => delete batchAddSelection[item.id]);
    } else {
        items.forEach(item => {
            if(batchAddSelection[item.id] === undefined) {
                 batchAddSelection[item.id] = (batchMode === 'add') ? 1 : '';
            }
        });
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchSummary() {
    const count = Object.keys(batchAddSelection).length;
    let total = 0;
    
    Object.values(batchAddSelection).forEach(q => {
        if(q === '' || q === undefined) return;
        if(batchMode === 'add') {
            total += q * 1000;
        } else {
            total += q;
        }
    });
    
    document.getElementById('batchAddCount').innerText = count;
    const totalDisplay = document.getElementById('batchTotalDisplay');
    const totalSpan = document.getElementById('batchAddTotal');
    
    if(batchMode === 'add') {
        totalDisplay.innerHTML = `共 +<span id="batchAddTotal">0</span> 粒`;
        document.getElementById('batchAddTotal').innerText = (total >= 1000) ? (total/1000).toFixed(1) + 'K' : total;
    } else {
        totalDisplay.innerHTML = `共 -<span id="batchAddTotal">0</span> 粒`;
        document.getElementById('batchAddTotal').innerText = total;
    }
}

function confirmBatchAdd() {
    const count = Object.keys(batchAddSelection).length;
    if (count === 0) return;
    
    const now = new Date();
    const dateStr = formatTime(now);
    
    if (batchMode === 'add') {
        Object.entries(batchAddSelection).forEach(([id, qty]) => {
            const item = data.find(d => d.id === id);
            if(item) {
                const weightToAdd = qty * 10; 
                item.w = parseFloat((item.w + weightToAdd).toFixed(2));
                item.totalAdded = parseFloat(((item.totalAdded || 0) + weightToAdd).toFixed(2));
                
                if(!item.logs) item.logs = [];
                item.logs.push({ d: dateStr, type: 'add', val: weightToAdd, note: '批量入库' });
                if(item.logs.length > 20) item.logs.shift();
            }
        });
        showToast("入库成功！");
    } else {
        // Deduct mode
        let warnings = [];
        let validDeductions = [];
        
        for (const [id, qty] of Object.entries(batchAddSelection)) {
            if (!qty) continue;
            const item = data.find(d => d.id === id);
            if (!item) continue;
            
            const currentBeads = Math.round(item.w * 100); 
            const deductBeads = qty;
            
            if (deductBeads > currentBeads) {
                warnings.push(`${id} (库存: ${currentBeads}, 扣除: ${deductBeads})`);
            }
            
            const weightToDeduct = parseFloat((deductBeads * 0.01).toFixed(2));
            validDeductions.push({ item, weightToDeduct, beads: deductBeads });
        }
        
        if (warnings.length > 0) {
            const msg = "以下色号扣除数量超过当前库存：\n" + warnings.join("\n") + "\n\n是否继续扣除？";
            if (!confirm(msg)) return;
        }
        
        validDeductions.forEach(({ item, weightToDeduct, beads }) => {
            item.w = parseFloat((item.w - weightToDeduct).toFixed(2));
            item.used = parseFloat(((item.used || 0) + weightToDeduct).toFixed(2));
             
            if(!item.logs) item.logs = [];
            item.logs.push({ d: dateStr, type: 'use', val: weightToDeduct, c: beads, note: '批量出库' });
            if(item.logs.length > 20) item.logs.shift();
        });
        showToast("出库成功！");
    }
    
    save();
    render();
    closeBatchAdd();
}
    // --- Pull to Refresh Logic ---
    let ptrStartY = 0;
    let ptrCurrentY = 0;
    let ptrDistance = 0;
    let isPtrActive = false;
    let isPtrLoading = false;
    const PTR_THRESHOLD = 80;
    
    // Main scrollable element is body/window
    window.addEventListener('touchstart', (e) => {
        // Only enable on specific pages
        const activePage = ['page-beads', 'page-stats', 'page-plan', 'page-fabric'].find(id => document.getElementById(id).style.display !== 'none');
        if (!activePage) return;
        
        if (window.scrollY === 0 && !isPtrLoading) {
            ptrStartY = e.touches[0].clientY;
            isPtrActive = true;
        }
    }, {passive: true});
    
    window.addEventListener('touchmove', (e) => {
        if (!isPtrActive || isPtrLoading) return;
        
        ptrCurrentY = e.touches[0].clientY;
        const diff = ptrCurrentY - ptrStartY;
        
        // Only track pull down
        if (diff > 0 && window.scrollY === 0) {
            // Resistance effect
            ptrDistance = Math.pow(diff, 0.8);
            
            // Limit max pull
            if (ptrDistance > 150) ptrDistance = 150;
            
            updatePtrVisuals(ptrDistance);
        } else {
            isPtrActive = false;
            resetPtr();
        }
    }, {passive: true});
    
    window.addEventListener('touchend', () => {
        if (!isPtrActive || isPtrLoading) return;
        
        if (ptrDistance > PTR_THRESHOLD) {
            startPtrLoading();
        } else {
            resetPtr();
        }
        isPtrActive = false;
    });
    
    function updatePtrVisuals(dist) {
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const text = document.getElementById('ptr-text');
        
        indicator.style.transform = `translateY(${dist}px)`;
        
        if (dist > PTR_THRESHOLD) {
            text.textContent = "释放刷新";
            icon.style.transform = "rotate(180deg)";
        } else {
            text.textContent = "下拉刷新";
            icon.style.transform = "rotate(0deg)";
        }
    }
    
    function startPtrLoading() {
        isPtrLoading = true;
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const spinner = document.getElementById('ptr-spinner');
        const text = document.getElementById('ptr-text');
        
        indicator.style.transform = `translateY(50px)`;
        icon.style.display = 'none';
        spinner.style.display = 'block';
        text.textContent = "加载中...";
        
        // Simulate refresh delay
        setTimeout(() => {
            window.location.reload();
        }, 800);
    }
    
    function resetPtr() {
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const spinner = document.getElementById('ptr-spinner');
        
        indicator.style.transform = `translateY(0)`;
        icon.style.display = 'inline';
        icon.style.transform = "rotate(0deg)";
        spinner.style.display = 'none';
        ptrDistance = 0;
    }

    // --- Plan Image Viewer Logic ---
    let imgScale = 1;
    let imgTranslateX = 0;
    let imgTranslateY = 0;
    let imgStartX = 0;
    let imgStartY = 0;
    let imgIsDragging = false;
    let imgInitialPinchDist = 0;
    let imgInitialScale = 1;

    function openPlanImageViewer() {
        const detailImg = document.getElementById('planDetailImage');
        const fullImg = document.getElementById('planFullImage');
        if (!detailImg.src) return;
        
        fullImg.src = detailImg.src;
        document.getElementById('planImageViewer').style.display = 'block';
        resetPlanImageZoom();
        
        // Disable page scroll
        document.body.style.overflow = 'hidden';
    }

    function closePlanImageViewer() {
        document.getElementById('planImageViewer').style.display = 'none';
        document.body.style.overflow = '';
    }

    function resetPlanImageZoom() {
        imgScale = 1;
        imgTranslateX = 0;
        imgTranslateY = 0;
        updateImageTransform();
    }

    function updateImageTransform() {
        const img = document.getElementById('planFullImage');
        img.style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${imgScale})`;
    }

    // Touch Event Handlers
    const viewer = document.getElementById('planImageViewer');
    
    viewer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            // Pinch
            imgIsDragging = false;
            imgInitialPinchDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            imgInitialScale = imgScale;
        } else if (e.touches.length === 1) {
            // Pan
            imgIsDragging = true;
            imgStartX = e.touches[0].clientX - imgTranslateX;
            imgStartY = e.touches[0].clientY - imgTranslateY;
        }
    });

    viewer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const currentDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            const ratio = currentDist / imgInitialPinchDist;
            let newScale = imgInitialScale * ratio;
            newScale = Math.min(Math.max(0.5, newScale), 5); // Limit 0.5x to 5x
            imgScale = newScale;
            updateImageTransform();
        } else if (e.touches.length === 1 && imgIsDragging) {
            e.preventDefault();
            imgTranslateX = e.touches[0].clientX - imgStartX;
            imgTranslateY = e.touches[0].clientY - imgStartY;
            updateImageTransform();
        }
    });

    viewer.addEventListener('touchend', () => {
        imgIsDragging = false;
    });

    // Mouse Events for Desktop Testing
    let isMouseDownViewer = false;
    viewer.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'IMG' || e.target.id === 'planImageWrapper') {
             isMouseDownViewer = true;
             imgStartX = e.clientX - imgTranslateX;
             imgStartY = e.clientY - imgTranslateY;
        }
    });

    viewer.addEventListener('mousemove', (e) => {
        if (!isMouseDownViewer) return;
        e.preventDefault();
        imgTranslateX = e.clientX - imgStartX;
        imgTranslateY = e.clientY - imgStartY;
        updateImageTransform();
    });

    viewer.addEventListener('mouseup', () => {
        isMouseDownViewer = false;
    });

    viewer.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = -Math.sign(e.deltaY) * 0.1;
        let newScale = imgScale + delta;
        newScale = Math.min(Math.max(0.5, newScale), 5);
        imgScale = newScale;
        updateImageTransform();
    }, {passive: false});

    function togglePlanOverviewContainer() {
        const el = document.getElementById('plan-overview-container');
        if (el) {
            if (el.style.display === 'none') {
                el.style.display = 'block';
                updatePlanOverviewStats();
            } else {
                el.style.display = 'none';
            }
        }
    }

    function updatePlanOverviewStats() {
        let plans = [];
        try {
            plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        } catch (e) {
            console.error('Error loading plans for stats:', e);
        }
        
        const getRealCount = (list) => {
            let count = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    count += getRealCount(p.subPlans);
                } else {
                    count++;
                }
            });
            return count;
        };

        const getRealTime = (list) => {
            let t = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    t += getRealTime(p.subPlans);
                } else {
                    if(p.status === 'completed') {
                        t += parseTimeSpentToHours(p.timeSpent);
                    }
                }
            });
            return t;
        };

        const activeList = plans.filter(p => (p.status || 'active') === 'active');
        const completedList = plans.filter(p => (p.status || 'active') === 'completed');

        const planPending = getRealCount(activeList);
        const planCompleted = getRealCount(completedList);
        const planTotal = planPending + planCompleted;
        const planTime = getRealTime(plans);

        const elPlanTotal = document.getElementById('stats-plan-total');
        if(elPlanTotal) elPlanTotal.textContent = planTotal;
        
        const elPlanCompleted = document.getElementById('stats-plan-completed');
        if(elPlanCompleted) elPlanCompleted.textContent = planCompleted;
        
        const elPlanPending = document.getElementById('stats-plan-pending');
        if(elPlanPending) elPlanPending.textContent = planPending;

        const elPlanTime = document.getElementById('stats-plan-time');
        if(elPlanTime) elPlanTime.textContent = planTime.toFixed(1);

        // Update UI state based on planChartConfig
        const setMetricActive = (id, active, color) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (active) {
                el.style.border = `2px solid ${color}`;
                el.style.background = '#f9f9f9';
            } else {
                el.style.border = '2px solid transparent';
                el.style.background = 'transparent';
            }
        };

        setMetricActive('metric-total', planChartConfig.total, '#4a90e2');
        setMetricActive('metric-completed', planChartConfig.completed, '#52c41a');
        setMetricActive('metric-pending', planChartConfig.pending, '#faad14');
        setMetricActive('metric-time', planChartConfig.time, '#722ed1');

        renderPlanChart(plans);
    }

</script>
    <!-- Image Viewer Modal -->
    <div id="planImageViewer" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; overflow: hidden; touch-action: none;">
         <div style="position: absolute; top: 20px; right: 20px; z-index: 2010; display: flex; gap: 15px;">
             <div onclick="resetPlanImageZoom()" style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; backdrop-filter: blur(4px);">
                 <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/></svg>
             </div>
             <div onclick="closePlanImageViewer()" style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; backdrop-filter: blur(4px);">
                 <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
             </div>
         </div>
         
         <div id="planImageWrapper" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
             <img id="planFullImage" src="" style="max-width: 100%; max-height: 100%; transition: transform 0.1s linear; transform-origin: center center;">
         </div>
         

    </div>

<!-- Moved editTimeModal to body root to ensure proper z-index and positioning -->
