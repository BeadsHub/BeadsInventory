<div id="page-fabric" style="display:none; min-height:100vh; background:#f5f7fa; padding-bottom: 40px;">
    <!-- Fabric Tool Header -->
    <div style="background:rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding:16px 20px; display:flex; align-items:center; box-shadow:0 4px 20px rgba(0,0,0,0.03); position:sticky; top:0; z-index:100; border-bottom: 1px solid rgba(0,0,0,0.05);">
        <button onclick="navTo('home')" class="btn-back" style="background: transparent; border: none; padding: 8px; border-radius: 50%; color: #333; cursor: pointer; transition: background 0.2s;">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <h2 class="page-title-sm" style="flex:1; margin: 0 0 0 10px; font-size: 18px; font-weight: 700; color: #1f2937; letter-spacing: -0.02em;">Ë£ÅÂâ™ÁªÑÂêàËÆ°ÁÆó</h2>
    </div>

    <div class="fabric-container">
        <!-- Sidebar (Input Panel) -->
        <div class="fabric-sidebar">
            <!-- 1. Canvas Size -->
            <div class="input-section">
                <div class="section-header">
                    <span class="section-icon">üìè</span>
                    <h3 class="section-title">ÂéüÂ∏ÉÂ∞∫ÂØ∏</h3>
                </div>
                <div class="input-row">
                    <div class="modern-input-group">
                        <label>ÈïøÂ∫¶ (cm)</label>
                        <input type="number" id="canvasW" value="100" onchange="saveFabricState()" placeholder="0">
                    </div>
                    <div class="modern-input-group">
                        <label>ÂÆΩÂ∫¶ (cm)</label>
                        <input type="number" id="canvasH" value="100" onchange="saveFabricState()" placeholder="0">
                    </div>
                </div>
            </div>

            <!-- 2. Specs -->
            <div class="input-section">
                <div class="section-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="section-icon">‚úÇÔ∏è</span>
                        <h3 class="section-title">ÊàêÂìÅËßÑÊ†º</h3>
                    </div>
                    <button onclick="addSpec()" class="btn-icon-add">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="3" fill="none"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Ê∑ªÂä†
                    </button>
                </div>
                
                <div class="specs-hint">
                    Â∏∏Áî®Ôºö52ÈíâÊùø(14x14), 78ÈíâÊùø(21x21), 104ÈíâÊùø(28x28)
                </div>
                
                <!-- Spec Table Header -->
                <div style="display: flex; padding: 0 10px 6px 10px; margin-top: 10px; font-size: 12px; color: #9ca3af; font-weight: 500; align-items: center;">
                    <div style="width: 20px; margin-right: 10px;">#</div>
                    <div style="flex: 1; text-align: center;">Èïø (cm)</div>
                    <div style="width: 15px;"></div>
                    <div style="flex: 1; text-align: center;">ÂÆΩ (cm)</div>
                    <div style="width: 50px; margin-left: 8px; text-align: center;">Ëá≥Â∞ë</div>
                    <div style="width: 20px;"></div>
                </div>

                <div id="specList" class="spec-list-container">
                    <!-- Specs injected here -->
                </div>
            </div>

            <!-- 3. Preferences -->
            <div class="input-section">
                <div class="section-header">
                    <span class="section-icon">‚öôÔ∏è</span>
                    <h3 class="section-title">ËÆ°ÁÆóÂÅèÂ•Ω</h3>
                </div>
                <div class="modern-select-wrapper">
                    <select id="sortPref" onchange="saveFabricState()">
                        <!-- Options injected -->
                    </select>
                    <div class="select-arrow">‚ñº</div>
                </div>
            </div>

            <!-- Action -->
            <button onclick="calculateLayout()" class="btn-calculate">
                <span class="btn-icon">üöÄ</span>
                ÂºÄÂßãËÆ°ÁÆóÊúÄ‰ºòÊñπÊ°à
            </button>
            
            <button onclick="exportAllSolutionsToPDF()" class="btn-export-pdf" style="margin-top: 12px; width: 100%; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 14px; font-weight: 600; color: #4b5563; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;">
                <span class="btn-icon">üìÑ</span>
                ÂØºÂá∫ÊâÄÊúâÊñπÊ°à (PDF)
            </button>

            <div id="calcStatus" class="calc-status-text"></div>
        </div>

        <!-- Main Content (Results) -->
        <div class="fabric-main">
            <div id="solutionList" class="solution-grid">
                <!-- Empty State -->
                <div class="empty-state-card">
                    <div class="empty-icon">üìê</div>
                    <h3>ÂáÜÂ§áÂ∞±Áª™</h3>
                    <p class="desktop-hint">ËØ∑Âú®Â∑¶‰æßÈÖçÁΩÆÂèÇÊï∞Âπ∂ÁÇπÂáªËÆ°ÁÆó</p>
                    <p class="mobile-hint">ËØ∑Âú®‰∏äÊñπÈÖçÁΩÆÂèÇÊï∞Âπ∂ÁÇπÂáªËÆ°ÁÆó</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modern Layout Variables */
    :root {
        --fabric-primary: #4a90e2;
        --fabric-bg: #f5f7fa;
        --fabric-card-bg: #ffffff;
        --fabric-border: #e5e7eb;
        --fabric-text: #1f2937;
        --fabric-text-light: #6b7280;
    }

    /* Container Layout */
    .fabric-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
        align-items: start;
    }

    /* Sidebar Styling */
    .fabric-sidebar {
        background: var(--fabric-card-bg);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
        position: sticky;
        top: 80px; /* Sticky sidebar */
        border: 1px solid rgba(255,255,255,0.5);
    }

    .input-section {
        margin-bottom: 24px;
        border-bottom: 1px dashed var(--fabric-border);
        padding-bottom: 20px;
    }
    .input-section:last-of-type {
        border-bottom: none;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--fabric-text);
        margin: 0;
    }
    
    .section-icon {
        font-size: 16px;
        margin-right: 8px;
        opacity: 0.8;
    }

    /* Input Groups */
    .input-row {
        display: flex;
        gap: 12px;
    }

    .modern-input-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .modern-input-group label {
        font-size: 12px;
        font-weight: 600;
        color: var(--fabric-text-light);
        margin-left: 2px;
    }

    .modern-input-group input {
        width: 100%;
        padding: 10px 12px;
        background: #f9fafb;
        border: 1px solid var(--fabric-border);
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        color: var(--fabric-text);
        transition: all 0.2s;
        box-sizing: border-box;
    }

    .modern-input-group input:focus {
        background: #fff;
        border-color: var(--fabric-primary);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
        outline: none;
    }

    /* Spec List */
    .specs-hint {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 12px;
        line-height: 1.4;
        background: #f3f4f6;
        padding: 8px 12px;
        border-radius: 8px;
    }

    .spec-list-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .spec-item {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid var(--fabric-border);
        padding: 10px;
        border-radius: 10px;
        transition: all 0.2s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }
    
    .spec-item:hover {
        border-color: #d1d5db;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }

    .spec-color {
        width: 12px;
        height: 12px;
        border-radius: 4px;
        margin-right: 10px;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
    }

    .btn-icon-add {
        background: #eff6ff;
        color: var(--fabric-primary);
        border: none;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
    }
    .btn-icon-add:hover {
        background: #dbeafe;
    }

    .btn-del {
        background: transparent;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        opacity: 0.6;
        transition: all 0.2s;
        margin-left: auto;
    }
    .btn-del:hover {
        opacity: 1;
        background: #fef2f2;
    }

    /* Select */
    .modern-select-wrapper {
        position: relative;
    }
    .modern-select-wrapper select {
        width: 100%;
        padding: 12px;
        appearance: none;
        background: #fff;
        border: 1px solid var(--fabric-border);
        border-radius: 10px;
        font-size: 14px;
        color: var(--fabric-text);
        cursor: pointer;
        box-sizing: border-box;
    }
    .select-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        color: var(--fabric-text-light);
        pointer-events: none;
    }

    /* Calculate Button */
    .btn-calculate {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #4f46e5, #7c3aed); /* Modern Indigo-Purple gradient */
        color: white;
        border: none;
        border-radius: 14px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        transition: transform 0.1s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-sizing: border-box;
    }
    .btn-calculate:active {
        transform: scale(0.98);
        box-shadow: 0 2px 6px rgba(79, 70, 229, 0.2);
    }
    .calc-status-text {
        margin-top: 12px;
        font-size: 12px;
        color: var(--fabric-text-light);
        text-align: center;
        min-height: 18px;
    }

    /* Main Area */
    .solution-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 20px;
    }

    .empty-state-card {
        grid-column: 1 / -1;
        background: white;
        border-radius: 20px;
        padding: 60px;
        text-align: center;
        color: var(--fabric-text-light);
        border: 2px dashed #e5e7eb;
    }
    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
        filter: grayscale(1);
    }

    /* Solution Card Styling */
    .solution-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0,0,0,0.03);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .solution-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
    }

    .sol-header {
        padding: 14px 18px;
        background: #fcfcfd;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .sol-title {
        font-weight: 700;
        font-size: 15px;
        color: #374151;
    }
    .sol-badge {
        background: #ecfdf5;
        color: #059669;
        border: 1px solid #d1fae5;
        padding: 2px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .sol-body {
        padding: 20px;
    }
    
    .sol-canvas-wrapper {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #eee;
    }

    /* Responsive */
    .mobile-hint { display: none; }
    .desktop-hint { display: block; }

    @media (max-width: 900px) {
        .fabric-container {
            grid-template-columns: 1fr; /* Stack on tablet/mobile */
            padding: 16px;
            gap: 16px;
        }
        .fabric-sidebar {
            position: static; /* Unstick on mobile */
            width: 100%;
            box-sizing: border-box;
        }
        .solution-grid {
            grid-template-columns: 1fr; /* Single column results on mobile */
        }
        .mobile-hint { display: block; }
        .desktop-hint { display: none; }
    }
</style>


<!-- Zoom Modal -->
<div id="zoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:95%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeZoom()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="margin-bottom:10px; font-weight:bold; font-size:18px; color:#333;" id="zoomTitle">ÊñπÊ°àËØ¶ÊÉÖ</div>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:10px;">
            <canvas id="zoomCanvas"></canvas>
        </div>
        <button id="zoomDownloadBtn" onclick="downloadSolution(currentZoomIdx)" style="margin-top:10px; padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">‰øùÂ≠òÂõæÁâá</button>
        <div id="zoomStats" style="margin-top:10px; width:100%; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:4px; box-sizing: border-box; background: #fafafa;"></div>
        <div style="margin-top:15px; display:flex; justify-content:center;">
             <button onclick="closeZoom()" style="padding:8px 20px; background:#f0f0f0; border:1px solid #ddd; border-radius:6px; cursor:pointer;">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- Download Modal (Mobile) -->
<div id="downloadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:90%; max-height:90%; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <button onclick="closeDownloadModal()" style="position:absolute; top:5px; right:10px; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        <div style="overflow:auto; flex:1; display:flex; justify-content:center; align-items:center; background:#f9f9f9; border-radius:8px; border:1px solid #eee; padding:5px;">
            <img id="downloadImg" style="max-width:100%; height:auto;" />
        </div>
        <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
             <button id="downloadBtnMobile" style="padding:8px 20px; background:#52c41a; color:white; border:none; border-radius:6px; font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;">‰øùÂ≠òÂõæÁâá</button>
             <button onclick="closeDownloadModal()" style="padding:8px 20px; background:#1890ff; color:white; border:none; border-radius:6px; cursor:pointer;">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<div id="planSelectionBar" class="selection-bar" style="display: none;">
    <div style="font-weight: bold; color: #333;">Â∑≤ÈÄâÊã© <span id="selectedCount">0</span> ‰∏™ËÆ°Âàí</div>
    <div style="display: flex; gap: 10px;">
        <button class="m-btn m-btn-ghost" onclick="exitPlanSelectionMode()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; white-space: nowrap;">ÂèñÊ∂à</button>
        <button class="m-btn m-btn-primary" onclick="mergeSelectedPlans()" style="padding: 8px 15px; font-size: 13px; border-radius: 20px; background: #722ed1; border-color: #722ed1; white-space: nowrap;">ÂêàÂπ∂ËÆ°Âàí</button>
    </div>
</div>

<!-- Floating Add Button -->
<div id="floatingHomeBtn" class="floating-home-btn" onclick="navTo('home')">
    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
</div>

<div id="floatingBatchAddBtn" class="floating-add-btn" onclick="openBatchOperation()">
    <span style="font-size: 14px; font-weight: bold;">+/-</span>
</div>

<!-- Batch Operation Modal -->
<div id="batchAddModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:300; flex-direction:column;">
    <!-- Header -->
    <div style="padding:15px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0;">
        <button onclick="closeBatchAdd()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">ÂèñÊ∂à</button>
        
        <!-- Mode Switch -->
        <div style="display:flex; background:#f0f0f0; border-radius:20px; padding:2px;">
            <div id="batchModeAdd" onclick="setBatchMode('add')" style="padding:5px 15px; border-radius:18px; font-size:14px; cursor:pointer; background:white; color:#4a90e2; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition:all 0.2s;">ÂÖ•Â∫ì</div>
            <div id="batchModeDeduct" onclick="setBatchMode('deduct')" style="padding:5px 15px; border-radius:18px; font-size:14px; cursor:pointer; color:#666; transition:all 0.2s;">Âá∫Â∫ì</div>
        </div>
        
        <button onclick="toggleBatchSelectAll()" style="background:none; border:none; color:#666; font-size:16px; padding:5px 10px; background:#f5f5f5; border-radius:20px;">ÂÖ®ÈÄâ</button>
    </div>
    
    <!-- Subtitle -->
    <div id="batchSubtitle" style="padding:10px 15px; background:#f9f9f9; color:#999; font-size:12px;">
        Â¢ûÂä†Â∫ìÂ≠òÔºå1Âçï‰Ωç = 1000Á≤í = 10g
    </div>
    
    <!-- Series Tabs -->
    <div id="batchAddSeriesTabs" style="display:flex; overflow-x:auto; padding:10px 15px; gap:10px; border-bottom:1px solid #f0f0f0; -webkit-overflow-scrolling: touch;">
        <!-- Tabs injected by JS -->
    </div>
    
    <!-- List -->
    <div id="batchAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <!-- Items injected by JS -->
    </div>
    
    <!-- Footer -->
    <div style="padding:15px; border-top:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; background:white;">
        <div>
            <div style="font-size:12px; color:#999;">Â∑≤ÈÄâÊã© <span id="batchAddCount" style="color:#333; font-weight:bold;">0</span> Ëâ≤</div>
            <div style="font-size:16px; font-weight:bold; color:#4a90e2;" id="batchTotalDisplay">ÂÖ± +<span id="batchAddTotal">0</span> Á≤í</div>
        </div>
        <button onclick="confirmBatchAdd()" id="batchConfirmBtn" class="m-btn m-btn-primary" style="width:auto; padding:10px 25px; border-radius:20px; box-shadow:0 4px 10px rgba(74, 144, 226, 0.3);">Á°ÆËÆ§Ê∑ªÂä†</button>
    </div>
</div>

<style>
.floating-add-btn {
    position: fixed; bottom: 100px; right: 20px;
    width: 36px; height: 36px;
    background: #4a90e2;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    display: none; align-items: center; justify-content: center;
    color: white; font-size: 24px; cursor: pointer;
    z-index: 180; transition: transform 0.2s;
}
.floating-add-btn:active { transform: scale(0.90); }
.floating-add-btn span { position: relative; top: -1px; }

.floating-home-btn {
    position: fixed; bottom: 100px; right: 70px;
    width: 36px; height: 36px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none; align-items: center; justify-content: center;
    color: #4a90e2; font-size: 20px; cursor: pointer;
    z-index: 180; transition: transform 0.2s; border: 1px solid #eee;
}
.floating-home-btn:active { transform: scale(0.90); }


.batch-tab {
    padding: 6px 16px; border-radius: 20px; background: #f0f0f0; color: #666; font-size: 14px; flex-shrink: 0; cursor: pointer; transition: all 0.2s;
}
.batch-tab.active {
    background: #4a90e2; color: white; box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3);
}

.batch-item {
    display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; margin-bottom: 10px; border: 1px solid #f0f0f0; transition: all 0.2s;
}
.batch-item.selected {
    border-color: #91d5ff; background: #e6f7ff;
}

.batch-check {
    width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; margin-right: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.batch-item.selected .batch-check {
    background: #4a90e2; border-color: #4a90e2; color: white;
}
.batch-check::after {
    content: "‚úì"; font-size: 14px; display: none;
}
.batch-item.selected .batch-check::after {
    display: block;
}

.batch-stepper {
    display: flex; align-items: center; background: white; border-radius: 8px; border: 1px solid #eee; overflow: hidden;
}
.batch-step-btn {
    width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; color: #666; cursor: pointer;
}
.batch-step-btn.add {
    background: #4a90e2; color: white;
}
.batch-input {
    width: 44px; text-align: center; border: none; font-size: 14px; color: #333; outline: none; background: transparent;
}
</style>

<script>
let batchAddSelection = {}; // { id: qty }
let batchCurrentSeries = 'A';
let batchMode = 'add'; // 'add' | 'deduct'

function openBatchOperation() {
    batchAddSelection = {};
    document.getElementById('batchAddModal').style.display = 'flex';
    
    // Default to Add mode
    setBatchMode('add');
    
    // Find all series
    const series = new Set();
    data.forEach(d => {
        const match = d.id.match(/^[A-Z]+/);
        if(match) series.add(match[0]);
    });
    const sortedSeries = Array.from(series).sort();
    if(sortedSeries.length > 0) batchCurrentSeries = sortedSeries[0];
    
    renderBatchAddTabs(sortedSeries);
    renderBatchAddList();
    updateBatchSummary();
}

function setBatchMode(mode) {
    batchMode = mode;
    batchAddSelection = {}; 
    
    const btnAdd = document.getElementById('batchModeAdd');
    const btnDeduct = document.getElementById('batchModeDeduct');
    const confirmBtn = document.getElementById('batchConfirmBtn');
    
    if(mode === 'add') {
        btnAdd.style.background = 'white';
        btnAdd.style.color = '#4a90e2';
        btnAdd.style.fontWeight = 'bold';
        btnAdd.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        btnDeduct.style.background = 'transparent';
        btnDeduct.style.color = '#666';
        btnDeduct.style.fontWeight = 'normal';
        btnDeduct.style.boxShadow = 'none';
        
        confirmBtn.innerText = 'Á°ÆËÆ§ÂÖ•Â∫ì';
        confirmBtn.style.background = '#4a90e2';
    } else {
        btnDeduct.style.background = 'white';
        btnDeduct.style.color = '#e24a4a';
        btnDeduct.style.fontWeight = 'bold';
        btnDeduct.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        
        btnAdd.style.background = 'transparent';
        btnAdd.style.color = '#666';
        btnAdd.style.fontWeight = 'normal';
        btnAdd.style.boxShadow = 'none';
        
        confirmBtn.innerText = 'Á°ÆËÆ§Âá∫Â∫ì';
        confirmBtn.style.background = '#e24a4a';
    }
    
    renderBatchAddList();
    updateBatchSummary();
}

function closeBatchAdd() {
    document.getElementById('batchAddModal').style.display = 'none';
}

function renderBatchAddTabs(allSeries) {
    const container = document.getElementById('batchAddSeriesTabs');
    container.innerHTML = '';
    allSeries.forEach(s => {
        const div = document.createElement('div');
        div.className = `batch-tab ${s === batchCurrentSeries ? 'active' : ''}`;
        div.innerText = s;
        div.onclick = () => {
            batchCurrentSeries = s;
            renderBatchAddTabs(allSeries);
            renderBatchAddList();
        };
        container.appendChild(div);
    });
}

function renderBatchAddList() {
    const container = document.getElementById('batchAddList');
    container.innerHTML = '';
    
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    
    items.forEach(item => {
        const isSelected = batchAddSelection[item.id] !== undefined;
        let qty = batchAddSelection[item.id];
        if (qty === undefined) {
             qty = (batchMode === 'add') ? 1 : ''; 
        }
        
        const div = document.createElement('div');
        div.className = `batch-item ${isSelected ? 'selected' : ''}`;
        div.onclick = (e) => {
            if(e.target.closest('.batch-stepper') || e.target.tagName === 'INPUT') return;
            toggleBatchItem(item.id);
        };
        
        let controlsHtml = '';
        if (isSelected) {
            if (batchMode === 'add') {
                controlsHtml = `
                <div class="batch-stepper">
                    <div class="batch-step-btn" onclick="updateBatchQty('${item.id}', -1)">-</div>
                    <input type="number" class="batch-input" value="${qty}" step="0.1" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                    <div class="batch-step-btn add" onclick="updateBatchQty('${item.id}', 1)">+</div>
                </div>
                <div style="font-size: 10px; color: #999; margin-left: 5px;">x1000</div>
                `;
            } else {
                 controlsHtml = `
                <div class="batch-stepper" style="border-color:#e24a4a; height: 30px; display: flex; align-items: center;">
                    <div style="padding-left: 8px; color: #e24a4a; font-weight: bold;">-</div>
                    <input type="number" class="batch-input" style="width:60px; text-align:center; height: 100%;" value="${qty}" placeholder="" onchange="updateBatchQtyInput('${item.id}', this.value)" onclick="event.stopPropagation()">
                </div>
                <div style="font-size: 10px; color: #999; margin-left: 5px;">Á≤í</div>
                `;
            }
        }
        
        div.innerHTML = `
            <div class="batch-check"></div>
            <div style="width: 36px; height: 36px; background: ${item.hex}; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); margin-right: 15px;"></div>
            <div style="flex: 1; font-weight: bold; font-size: 16px;">${item.id}</div>
            ${controlsHtml}
        `;
        container.appendChild(div);
    });
}

function toggleBatchItem(id) {
    if (batchAddSelection[id] !== undefined) {
        delete batchAddSelection[id];
    } else {
        batchAddSelection[id] = (batchMode === 'add') ? 1 : '';
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQty(id, delta) {
    if (batchAddSelection[id] === undefined) return;
    
    if (batchMode === 'add') {
        let newQty = parseFloat(batchAddSelection[id]) + delta;
        newQty = parseFloat(newQty.toFixed(1));
        if (newQty <= 0) {
            delete batchAddSelection[id];
        } else {
            batchAddSelection[id] = newQty;
        }
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchQtyInput(id, val) {
    if (batchMode === 'add') {
        let newQty = parseFloat(val);
        if (isNaN(newQty) || newQty <= 0) {
            delete batchAddSelection[id];
        } else {
            batchAddSelection[id] = parseFloat(newQty.toFixed(1));
        }
    } else {
        if (val === '') {
             batchAddSelection[id] = '';
        } else {
            let newQty = parseInt(val);
            if (isNaN(newQty) || newQty <= 0) {
                // Keep selection but maybe invalid? 
                // If user enters -5, we should probably reject or set to something valid.
                // For now, if invalid, delete selection? Or just don't update?
                // Deleting selection might be annoying if accidental.
                // Let's just set to valid or ignore.
                // If <= 0, delete.
                if (newQty <= 0) delete batchAddSelection[id];
                else batchAddSelection[id] = newQty;
            } else {
                batchAddSelection[id] = newQty;
            }
        }
    }
    updateBatchSummary();
}

function toggleBatchSelectAll() {
    const items = data.filter(d => d.id.startsWith(batchCurrentSeries));
    const allSelected = items.every(item => batchAddSelection[item.id] !== undefined);
    
    if (allSelected) {
        items.forEach(item => delete batchAddSelection[item.id]);
    } else {
        items.forEach(item => {
            if(batchAddSelection[item.id] === undefined) {
                 batchAddSelection[item.id] = (batchMode === 'add') ? 1 : '';
            }
        });
    }
    renderBatchAddList();
    updateBatchSummary();
}

function updateBatchSummary() {
    const count = Object.keys(batchAddSelection).length;
    let total = 0;
    
    Object.values(batchAddSelection).forEach(q => {
        if(q === '' || q === undefined) return;
        if(batchMode === 'add') {
            total += q * 1000;
        } else {
            total += q;
        }
    });
    
    document.getElementById('batchAddCount').innerText = count;
    const totalDisplay = document.getElementById('batchTotalDisplay');
    const totalSpan = document.getElementById('batchAddTotal');
    
    if(batchMode === 'add') {
        totalDisplay.innerHTML = `ÂÖ± +<span id="batchAddTotal">0</span> Á≤í`;
        document.getElementById('batchAddTotal').innerText = (total >= 1000) ? (total/1000).toFixed(1) + 'K' : total;
    } else {
        totalDisplay.innerHTML = `ÂÖ± -<span id="batchAddTotal">0</span> Á≤í`;
        document.getElementById('batchAddTotal').innerText = total;
    }
}

function confirmBatchAdd() {
    const count = Object.keys(batchAddSelection).length;
    if (count === 0) return;
    
    const now = new Date();
    const dateStr = formatTime(now);
    
    if (batchMode === 'add') {
        Object.entries(batchAddSelection).forEach(([id, qty]) => {
            const item = data.find(d => d.id === id);
            if(item) {
                const weightToAdd = qty * 10; 
                item.w = parseFloat((item.w + weightToAdd).toFixed(2));
                item.totalAdded = parseFloat(((item.totalAdded || 0) + weightToAdd).toFixed(2));
                
                if(!item.logs) item.logs = [];
                item.logs.push({ d: dateStr, type: 'add', val: weightToAdd, note: 'ÊâπÈáèÂÖ•Â∫ì' });
                if(item.logs.length > 20) item.logs.shift();
            }
        });
        showToast("ÂÖ•Â∫ìÊàêÂäüÔºÅ");
    } else {
        // Deduct mode
        let warnings = [];
        let validDeductions = [];
        
        for (const [id, qty] of Object.entries(batchAddSelection)) {
            if (!qty) continue;
            const item = data.find(d => d.id === id);
            if (!item) continue;
            
            const currentBeads = Math.round(item.w * 100); 
            const deductBeads = qty;
            
            if (deductBeads > currentBeads) {
                warnings.push(`${id} (Â∫ìÂ≠ò: ${currentBeads}, Êâ£Èô§: ${deductBeads})`);
            }
            
            const weightToDeduct = parseFloat((deductBeads * 0.01).toFixed(2));
            validDeductions.push({ item, weightToDeduct, beads: deductBeads });
        }
        
        if (warnings.length > 0) {
            const msg = "‰ª•‰∏ãËâ≤Âè∑Êâ£Èô§Êï∞ÈáèË∂ÖËøáÂΩìÂâçÂ∫ìÂ≠òÔºö\n" + warnings.join("\n") + "\n\nÊòØÂê¶ÁªßÁª≠Êâ£Èô§Ôºü";
            if (!confirm(msg)) return;
        }
        
        validDeductions.forEach(({ item, weightToDeduct, beads }) => {
            item.w = parseFloat((item.w - weightToDeduct).toFixed(2));
            item.used = parseFloat(((item.used || 0) + weightToDeduct).toFixed(2));
             
            if(!item.logs) item.logs = [];
            item.logs.push({ d: dateStr, type: 'use', val: weightToDeduct, c: beads, note: 'ÊâπÈáèÂá∫Â∫ì' });
            if(item.logs.length > 20) item.logs.shift();
        });
        showToast("Âá∫Â∫ìÊàêÂäüÔºÅ");
    }
    
    save();
    render();
    closeBatchAdd();
}
    // --- Pull to Refresh Logic ---
    let ptrStartY = 0;
    let ptrCurrentY = 0;
    let ptrDistance = 0;
    let isPtrActive = false;
    let isPtrLoading = false;
    const PTR_THRESHOLD = 80;
    
    // Main scrollable element is body/window
    window.addEventListener('touchstart', (e) => {
        // Only enable on specific pages
        const activePage = ['page-beads', 'page-stats', 'page-plan', 'page-fabric'].find(id => document.getElementById(id).style.display !== 'none');
        if (!activePage) return;
        
        if (window.scrollY === 0 && !isPtrLoading) {
            ptrStartY = e.touches[0].clientY;
            isPtrActive = true;
        }
    }, {passive: true});
    
    window.addEventListener('touchmove', (e) => {
        if (!isPtrActive || isPtrLoading) return;
        
        ptrCurrentY = e.touches[0].clientY;
        const diff = ptrCurrentY - ptrStartY;
        
        // Only track pull down
        if (diff > 0 && window.scrollY === 0) {
            // Resistance effect
            ptrDistance = Math.pow(diff, 0.8);
            
            // Limit max pull
            if (ptrDistance > 150) ptrDistance = 150;
            
            updatePtrVisuals(ptrDistance);
        } else {
            isPtrActive = false;
            resetPtr();
        }
    }, {passive: true});
    
    window.addEventListener('touchend', () => {
        if (!isPtrActive || isPtrLoading) return;
        
        if (ptrDistance > PTR_THRESHOLD) {
            startPtrLoading();
        } else {
            resetPtr();
        }
        isPtrActive = false;
    });
    
    function updatePtrVisuals(dist) {
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const text = document.getElementById('ptr-text');
        
        indicator.style.transform = `translateY(${dist}px)`;
        
        if (dist > PTR_THRESHOLD) {
            text.textContent = "ÈáäÊîæÂà∑Êñ∞";
            icon.style.transform = "rotate(180deg)";
        } else {
            text.textContent = "‰∏ãÊãâÂà∑Êñ∞";
            icon.style.transform = "rotate(0deg)";
        }
    }
    
    function startPtrLoading() {
        isPtrLoading = true;
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const spinner = document.getElementById('ptr-spinner');
        const text = document.getElementById('ptr-text');
        
        indicator.style.transform = `translateY(50px)`;
        icon.style.display = 'none';
        spinner.style.display = 'block';
        text.textContent = "Âä†ËΩΩ‰∏≠...";
        
        // Simulate refresh delay
        setTimeout(() => {
            window.location.reload();
        }, 800);
    }
    
    function resetPtr() {
        const indicator = document.getElementById('ptr-indicator');
        const icon = document.getElementById('ptr-icon');
        const spinner = document.getElementById('ptr-spinner');
        
        indicator.style.transform = `translateY(0)`;
        icon.style.display = 'inline';
        icon.style.transform = "rotate(0deg)";
        spinner.style.display = 'none';
        ptrDistance = 0;
    }

    // --- Plan Image Viewer Logic ---
    let imgScale = 1;
    let imgTranslateX = 0;
    let imgTranslateY = 0;
    let imgStartX = 0;
    let imgStartY = 0;
    let imgIsDragging = false;
    let imgInitialPinchDist = 0;
    let imgInitialScale = 1;

    function openPlanImageViewer() {
        const detailImg = document.getElementById('planDetailImage');
        const fullImg = document.getElementById('planFullImage');
        if (!detailImg.src) return;
        
        fullImg.src = detailImg.src;
        document.getElementById('planImageViewer').style.display = 'block';
        resetPlanImageZoom();
        
        // Disable page scroll
        document.body.style.overflow = 'hidden';
    }

    function closePlanImageViewer() {
        document.getElementById('planImageViewer').style.display = 'none';
        document.body.style.overflow = '';
    }

    function resetPlanImageZoom() {
        imgScale = 1;
        imgTranslateX = 0;
        imgTranslateY = 0;
        updateImageTransform();
    }

    function updateImageTransform() {
        const img = document.getElementById('planFullImage');
        img.style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${imgScale})`;
    }

    // Touch Event Handlers
    const viewer = document.getElementById('planImageViewer');
    
    viewer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            // Pinch
            imgIsDragging = false;
            imgInitialPinchDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            imgInitialScale = imgScale;
        } else if (e.touches.length === 1) {
            // Pan
            imgIsDragging = true;
            imgStartX = e.touches[0].clientX - imgTranslateX;
            imgStartY = e.touches[0].clientY - imgTranslateY;
        }
    });

    viewer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const currentDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            const ratio = currentDist / imgInitialPinchDist;
            let newScale = imgInitialScale * ratio;
            newScale = Math.min(Math.max(0.5, newScale), 5); // Limit 0.5x to 5x
            imgScale = newScale;
            updateImageTransform();
        } else if (e.touches.length === 1 && imgIsDragging) {
            e.preventDefault();
            imgTranslateX = e.touches[0].clientX - imgStartX;
            imgTranslateY = e.touches[0].clientY - imgStartY;
            updateImageTransform();
        }
    });

    viewer.addEventListener('touchend', () => {
        imgIsDragging = false;
    });

    // Mouse Events for Desktop Testing
    let isMouseDownViewer = false;
    viewer.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'IMG' || e.target.id === 'planImageWrapper') {
             isMouseDownViewer = true;
             imgStartX = e.clientX - imgTranslateX;
             imgStartY = e.clientY - imgTranslateY;
        }
    });

    viewer.addEventListener('mousemove', (e) => {
        if (!isMouseDownViewer) return;
        e.preventDefault();
        imgTranslateX = e.clientX - imgStartX;
        imgTranslateY = e.clientY - imgStartY;
        updateImageTransform();
    });

    viewer.addEventListener('mouseup', () => {
        isMouseDownViewer = false;
    });

    viewer.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = -Math.sign(e.deltaY) * 0.1;
        let newScale = imgScale + delta;
        newScale = Math.min(Math.max(0.5, newScale), 5);
        imgScale = newScale;
        updateImageTransform();
    }, {passive: false});

    function togglePlanOverviewContainer() {
        const el = document.getElementById('plan-overview-container');
        if (el) {
            if (el.style.display === 'none') {
                el.style.display = 'block';
                updatePlanOverviewStats();
            } else {
                el.style.display = 'none';
            }
        }
    }

    function updatePlanOverviewStats() {
        let plans = [];
        try {
            plans = JSON.parse(localStorage.getItem('bead_plans') || '[]');
        } catch (e) {
            console.error('Error loading plans for stats:', e);
        }
        
        const getRealCount = (list) => {
            let count = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    count += getRealCount(p.subPlans);
                } else {
                    count++;
                }
            });
            return count;
        };

        const getRealTime = (list) => {
            let t = 0;
            list.forEach(p => {
                if (p.subPlans && p.subPlans.length > 0) {
                    t += getRealTime(p.subPlans);
                } else {
                    if(p.status === 'completed') {
                        t += parseTimeSpentToHours(p.timeSpent);
                    }
                }
            });
            return t;
        };

        const activeList = plans.filter(p => (p.status || 'active') === 'active');
        const completedList = plans.filter(p => (p.status || 'active') === 'completed');

        const planPending = getRealCount(activeList);
        const planCompleted = getRealCount(completedList);
        const planTotal = planPending + planCompleted;
        const planTime = getRealTime(plans);

        const elPlanTotal = document.getElementById('stats-plan-total');
        if(elPlanTotal) elPlanTotal.textContent = planTotal;
        
        const elPlanCompleted = document.getElementById('stats-plan-completed');
        if(elPlanCompleted) elPlanCompleted.textContent = planCompleted;
        
        const elPlanPending = document.getElementById('stats-plan-pending');
        if(elPlanPending) elPlanPending.textContent = planPending;

        const elPlanTime = document.getElementById('stats-plan-time');
        if(elPlanTime) elPlanTime.textContent = planTime.toFixed(1);

        // Update UI state based on planChartConfig
        const setMetricActive = (id, active, color) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (active) {
                el.style.border = `2px solid ${color}`;
                el.style.background = '#f9f9f9';
            } else {
                el.style.border = '2px solid transparent';
                el.style.background = 'transparent';
            }
        };

        setMetricActive('metric-total', planChartConfig.total, '#4a90e2');
        setMetricActive('metric-completed', planChartConfig.completed, '#52c41a');
        setMetricActive('metric-pending', planChartConfig.pending, '#faad14');
        setMetricActive('metric-time', planChartConfig.time, '#722ed1');

        renderPlanChart(plans);
    }

</script>
    <!-- Image Viewer Modal -->
    <div id="planImageViewer" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; overflow: hidden; touch-action: none;">
         <div style="position: absolute; top: 20px; right: 20px; z-index: 2010; display: flex; gap: 15px;">
             <div onclick="closePlanImageViewer()" style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; backdrop-filter: blur(4px);">
                 <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
             </div>
         </div>
         
         <div id="planImageWrapper" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
             <img id="planFullImage" src="" style="max-width: 100%; max-height: 100%; transition: transform 0.1s linear; transform-origin: center center;">
         </div>
         

    </div>

<!-- Moved editTimeModal to body root to ensure proper z-index and positioning -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
